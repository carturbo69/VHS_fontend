@using VHS_frontend.Areas.Customer.Models.ChatDTOs
@using Microsoft.AspNetCore.Html
@using System.Runtime.InteropServices
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration

@model ChatPageVm

@{
    ViewData["Title"] = "Chat";
    var me = Model.CurrentAccount?.AccountId ?? Guid.Empty;

    var selected = Model.SelectedConversation;
    var hasSelection = selected != null;

    MessageAccountDto? otherInSelected = null;
    if (hasSelection)
    {
        otherInSelected = (selected!.ParticipantA?.AccountId == me ? selected.ParticipantB : selected.ParticipantA);
    }

    var fallbackImg = Url.Content("~/images/vhs_logo.png");

    // Helper function để xử lý ImageUrl trong tin nhắn (giống ServiceShop/Index.cshtml)
    // Backend đã tự động thêm domain prefix, nên chỉ cần dùng trực tiếp
    string GetMessageImageUrl(MessageDto message)
    {
        // Giống như ServiceShop: dùng trực tiếp ImageUrl, backend đã xử lý domain rồi
        if (string.IsNullOrWhiteSpace(message.ImageUrl)) return fallbackImg;
        return message.ImageUrl.Trim();
    }

    // ===== Map hỗ trợ hiển thị trích dẫn tin gốc (reply) =====
    Func<MessageDto, string> SnippetOf = (MessageDto m) =>
    {
        if (m == null) return "(Không có nội dung)";
        // DECODE trước khi cắt
        var bodyDecoded = string.IsNullOrWhiteSpace(m.Body) ? "" : System.Net.WebUtility.HtmlDecode(m.Body);
        if (!string.IsNullOrWhiteSpace(bodyDecoded))
            return bodyDecoded.Length > 140 ? bodyDecoded.Substring(0, 140) + "…" : bodyDecoded;
        if (!string.IsNullOrWhiteSpace(m.ImageUrl)) return "[Ảnh]";
        return "(Không có nội dung)";
    };
    var msgMap = hasSelection && selected?.Messages != null
        ? selected.Messages.ToDictionary(x => x.MessageId)
        : new Dictionary<Guid, MessageDto>();

    var backendBase = Configuration["Apis:Backend"] ?? "";
}


@functions {

    private static TimeZoneInfo GetVnTz()
    {
        try
        {
            // Windows vs Linux/macOS
            var tzId = RuntimeInformation.IsOSPlatform(OSPlatform.Windows)
                ? "SE Asia Standard Time"
                : "Asia/Ho_Chi_Minh";
            return TimeZoneInfo.FindSystemTimeZoneById(tzId);
        }
        catch
        {
            // fallback +07:00 nếu máy chủ không có TZ
            return TimeZoneInfo.CreateCustomTimeZone("VN_Fallback", TimeSpan.FromHours(7), "VN", "VN");
        }
    }

    private static string HHmmVN(DateTime utc)
    {
        var fixedUtc = utc.Kind == DateTimeKind.Utc ? utc : DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        var vn = TimeZoneInfo.ConvertTimeFromUtc(fixedUtc, GetVnTz());
        return vn.ToString("HH:mm");
    }

    // Overload nếu model dùng DateTimeOffset
    private static string HHmmVN(DateTimeOffset dto) => HHmmVN(dto.UtcDateTime);

    // Hàm format thời gian thông minh cho chat (đồng bộ giữa message list và conversation list)
    private static string FormatChatTime(DateTime utc)
    {
        var fixedUtc = utc.Kind == DateTimeKind.Utc ? utc : DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        var vn = TimeZoneInfo.ConvertTimeFromUtc(fixedUtc, GetVnTz());
        var now = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, GetVnTz());
        
        // Cùng ngày: chỉ hiển thị giờ
        if (vn.Date == now.Date)
        {
            return vn.ToString("HH:mm");
        }
        
        // Hôm qua
        if (vn.Date == now.Date.AddDays(-1))
        {
            return "Hôm qua " + vn.ToString("HH:mm");
        }
        
        // Trong 7 ngày gần đây: hiển thị thứ và giờ
        if ((now.Date - vn.Date).TotalDays <= 7)
        {
            var dayOfWeek = vn.DayOfWeek switch
            {
                DayOfWeek.Monday => "Thứ 2",
                DayOfWeek.Tuesday => "Thứ 3",
                DayOfWeek.Wednesday => "Thứ 4",
                DayOfWeek.Thursday => "Thứ 5",
                DayOfWeek.Friday => "Thứ 6",
                DayOfWeek.Saturday => "Thứ 7",
                DayOfWeek.Sunday => "CN",
                _ => ""
            };
            return dayOfWeek + " " + vn.ToString("HH:mm");
        }
        
        // Trong cùng năm: hiển thị ngày/tháng và giờ
        if (vn.Year == now.Year)
        {
            return vn.ToString("dd/MM HH:mm");
        }
        
        // Khác năm: hiển thị đầy đủ
        return vn.ToString("dd/MM/yyyy HH:mm");
    }

    // Overload cho DateTimeOffset
    private static string FormatChatTime(DateTimeOffset dto) => FormatChatTime(dto.UtcDateTime);
    
    // Overload cho DateTime? (nullable)
    private static string FormatChatTime(DateTime? utc)
    {
        if (!utc.HasValue) return "";
        return FormatChatTime(utc.Value);
    }

    // Helper hiển thị trạng thái
    public static Microsoft.AspNetCore.Html.IHtmlContent RenderStatus(MessageStatus status)
    {
        string icon = status switch
        {
            MessageStatus.Pending => "<i class=\"bi bi-clock-history\"></i>",
            MessageStatus.Sent => "<i class=\"bi bi-check\"></i>",
            MessageStatus.Delivered => "<i class=\"bi bi-check2-all\"></i>",
            MessageStatus.Seen => "<i class=\"bi bi-check2-all\"></i>",
            _ => ""
        };
        string text = status switch
        {
            MessageStatus.Pending => "Đang gửi",
            MessageStatus.Sent => "Đã gửi",
            MessageStatus.Delivered => "Đã nhận",
            MessageStatus.Seen => "Đã xem",
            _ => ""
        };
        return new Microsoft.AspNetCore.Html.HtmlString(
            $"<span class=\"msg-status d-inline-flex align-items-center gap-1\" data-status=\"{status}\">{icon}<span class=\"d-none d-md-inline\">{text}</span></span>"
        );
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/chat-customer.css" asp-append-version="true" />
    <style>
        /* Ẩn footer chính của trang khi ở trang chat customer */
        /* Chỉ ẩn footer ở cấp body, không ảnh hưởng modal/dropdown footer */
        body > footer,
        body > .footer,
        body footer:not(.modal-footer):not(.dropdown-footer):not(.replying-pill):not(.kb-card-footer):not(.address-modal-footer):not(.upsert-form-footer):not(.rv-modal-footer):not([class*="modal"]):not([class*="dropdown"]):not([class*="card"]):not([class*="form"]) {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            opacity: 0 !important;
            overflow: hidden !important;
        }
    </style>
}

<!-- Wrapper để isolate chat khỏi header -->
<div class="chat-page-wrapper">
    <div class="container-fluid chat-wrapper">
        <div class="row h-100 g-0">
            <!-- Sidebar -->
            <aside class="col-12 col-md-4 col-lg-3 border-end chat-col d-flex flex-column">
                <div class="p-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text"
                               id="searchConversation"
                               class="form-control"
                               placeholder="Tìm theo tên hoặc nội dung…"
                               autocomplete="off" />
                    </div>
                    <div class="d-flex align-items-center mt-2 small text-muted">
                        <span class="fw-semibold">Tất cả cuộc trò chuyện</span>
                        <span class="ms-auto">
                            <span id="conversationCount">(@Model.Conversations.Count)</span>
                        </span>
                    </div>
                </div>

                <div class="pt-2 px-3">
                    <form method="post" action='@Url.Action("StartWithAdmin", "ChatCustomer", new { area = "Customer" })'>
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-success w-100 d-inline-flex align-items-center gap-2">
                            <i class="bi bi-headset"></i> Chat với Admin
                        </button>
                    </form>
                </div>


                <div class="chat-scroll px-2" id="conversationList">
                    @foreach (var c in Model.Conversations
                                        .OrderByDescending(x => x.IsPinned)
                                        .ThenByDescending(x => x.LastMessageAt))
                    {
                        var isActive = c.ConversationId == Model.SelectedConversationId;

                        string? avatarUrlToUse = null;
                        if (!string.IsNullOrWhiteSpace(c.AvatarUrl))
                        {
                            avatarUrlToUse = c.AvatarUrl;
                        }
                        else if (isActive && hasSelection && otherInSelected != null && !string.IsNullOrWhiteSpace(otherInSelected.AvatarUrl))
                        {
                            avatarUrlToUse = otherInSelected.AvatarUrl;
                        }

                        <a class="d-flex align-items-start gap-2 p-2 rounded conv-item @(isActive ? "bg-light" : "")"
                           href="@Url.Action("Index", "ChatCustomer", new { area = "Customer", id = c.ConversationId })"
                           data-search-title="@(c.Title?.ToLower() ?? "")"
                           data-search-snippet="@(c.LastMessageSnippet?.ToLower() ?? "")"
                           data-conversation-id="@c.ConversationId"
                           data-avatar-url="@(avatarUrlToUse ?? "")"
                           data-conversation-url="@Url.Action("Index", "ChatCustomer", new { area = "Customer", id = c.ConversationId })">
                            <img class="avatar"
                                 src="@(avatarUrlToUse ?? fallbackImg)"
                                 alt=""
                                 loading="lazy"
                                 decoding="async"
                                 referrerpolicy="no-referrer"
                                 onerror="this.onerror=null;this.src='@fallbackImg';" />

                            <div class="flex-grow-1">
                                <div class="d-flex">
                                    <div class="fw-semibold text-ellipsis-1">@c.Title</div>
                                    <div class="ms-auto small text-muted conv-time">
                                        @(c.LastMessageAt.HasValue ? FormatChatTime(c.LastMessageAt.Value) : "")
                                    </div>
                                </div>
                                <div class="small text-muted text-ellipsis-1 conv-snippet">@c.LastMessageSnippet</div>
                            </div>

                            @if (c.UnreadCount > 0)
                            {
                                <span class="badge rounded-pill bg-danger ms-2 conv-unread">@c.UnreadCount</span>
                            }
                        </a>
                    }
                </div>

            </aside>



            <!-- Khung chat -->
            @if (!hasSelection)
            {
                <!-- Chưa chọn hội thoại: panel phải trắng, không header, không nội dung, không ô soạn -->
                <main class="col-12 col-md-8 col-lg-9 chat-col d-flex flex-column" style="background:#fff;"></main>
            }
            else
            {
                <!-- Đã chọn hội thoại: hiển thị đầy đủ -->
                <main class="col-12 col-md-8 col-lg-9 chat-col d-flex flex-column"
                      data-selected-conv="@Model.SelectedConversationId">
                    <!-- Header -->
                    <div class="border-bottom p-3 d-flex align-items-center position-relative">
                        <img class="avatar me-2"
                             src="@(otherInSelected?.AvatarUrl ?? fallbackImg)"
                             alt=""
                             loading="lazy"
                             decoding="async"
                             referrerpolicy="no-referrer"
                             onerror="this.onerror=null;this.src='@fallbackImg';" />

                        <div class="me-3">
                            <div class="fw-semibold">
                                @(otherInSelected?.AccountName ?? selected!.Title ?? "Đối tác")
                            </div>
                        </div>

                        <!-- Nút 3 chấm ở góc phải -->
                        <div class="ms-auto dropdown" id="chatOptionsDropdown">
                            <button type="button"
                                    id="chatOptionsBtn"
                                    class="btn btn-link p-0 text-muted"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    title="Tùy chọn"
                                    style="cursor: pointer; z-index: 1000;">
                                <i class="bi bi-three-dots fs-4"></i>
                            </button>

                            <div class="dropdown-menu dropdown-menu-end shadow-sm p-0"
                                 id="chatOptionsMenu"
                                 style="min-width:220px; z-index: 1001;"
                                 aria-labelledby="chatOptionsBtn">
                                <form method="post"
                                      id="deleteConversationForm"
                                      action='@Url.Action("DeleteConversation", "ChatCustomer", new { area = "Customer", id = Model.SelectedConversationId, hide = true })'
                                      onsubmit="return confirm('Bạn có chắc muốn xóa cuộc trò chuyện này?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit"
                                            id="deleteConversationBtn"
                                            class="dropdown-item text-danger"
                                            style="cursor: pointer; pointer-events: auto;">
                                        <i class="bi bi-trash me-2"></i>Xóa cuộc trò chuyện
                                    </button>
                                </form>
                            </div>
                        </div>

                    </div>


                    <!-- Danh sách tin nhắn -->
                    <div id="msgList" class="msg-list">
                        @if (selected?.Messages?.Count > 0)
                        {
                            foreach (var m in selected.Messages.OrderBy(x => x.CreatedAt))
                            {
                                var isMe = m.SenderAccountId == me;
                                var createdIso = DateTime.SpecifyKind(m.CreatedAt, DateTimeKind.Utc).ToString("o");

                                var senderName = isMe ? "Bạn" : (otherInSelected?.AccountName ?? "Đối tác");
                                var snippetThis = SnippetOf(m);

                                <div class="d-flex @(isMe ? "justify-content-end" : "justify-content-start")">
                                    <div class="bubble @(isMe ? "me" : "other")"
                                         data-message-id="@m.MessageId"
                                         data-created-at="@createdIso"
                                         data-is-mine="@(isMe ? "true" : "false")"
                                         data-status="@m.Status"
                                         data-sender-name="@senderName"
                                         data-snippet="@snippetThis">

                                        @* Nếu là reply, hiển thị tham chiếu tin gốc *@
                                        @if (m.ReplyToMessageId != null && msgMap.TryGetValue(m.ReplyToMessageId.Value, out var parent))
                                        {
                                            var parentName = parent.SenderAccountId == me ? "Bạn" : (otherInSelected?.AccountName ?? "Người kia");
                                            <div class="reply-ref small text-muted border-start ps-2 mb-2">
                                                <div class="fw-semibold">@parentName</div>
                                                <div class="text-truncate" style="max-width: 420px;">@SnippetOf(parent)</div>
                                            </div>
                                        }

                                        @* Nội dung *@
                                        @{
                                            var decodedBody = string.IsNullOrWhiteSpace(m.Body) ? "" : System.Net.WebUtility.HtmlDecode(m.Body);
                                        }
                                        @if (!string.IsNullOrWhiteSpace(decodedBody))
                                        {
                                            <div>@decodedBody</div>
                                        }


                                        @if (!string.IsNullOrWhiteSpace(m.ImageUrl))
                                        {
                                            <img src="@m.ImageUrl"
                                                 class="mt-2 rounded"
                                                 style="max-width:220px;"
                                                 loading="lazy"
                                                 decoding="async"
                                                 referrerpolicy="no-referrer"
                                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                                        }

                                        <div class="msg-meta text-end small mt-1 d-flex align-items-center justify-content-end gap-2">
                                            <button type="button"
                                                    class="btn btn-link btn-sm p-0 text-decoration-none text-muted reply-btn"
                                                    title="Trả lời"
                                                    data-message-id="@m.MessageId"
                                                    data-sender-name="@senderName"
                                                    data-snippet="@snippetThis"
                                                    onclick="window.handleReplyClickDirect(this); return false;"
                                                    style="cursor: pointer !important; pointer-events: auto !important; z-index: 10 !important; position: relative !important;">
                                                <i class="bi bi-reply"></i> <span class="d-none d-md-inline">Reply</span>
                                            </button>
                                            <span class="text-muted">@FormatChatTime(m.CreatedAt)</span>

                                            @if (isMe)
                                            {
                                                @RenderStatus(m.Status)
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            @* Không có tin nhắn: hiển thị gợi ý nhanh *@
                            <div class="empty-state d-flex flex-column align-items-center justify-content-center p-4 text-center text-muted">
                                <i class="bi bi-chat-left-text fs-1 mb-2"></i>
                                <div class="mb-3">Chưa có tin nhắn nào. Bạn muốn bắt đầu với một câu hỏi?</div>

                                <div class="d-flex flex-wrap gap-2 justify-content-center">
                                    <!-- Lưu ý: data-text là nội dung sẽ gửi -->
                                    <button type="button" class="btn btn-outline-primary btn-sm quick-reply" data-text="Chào bạn, mình cần tư vấn dịch vụ.">Cần tư vấn dịch vụ</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm quick-reply" data-text="Bạn có thể báo giá giúp mình không?">Xin báo giá</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm quick-reply" data-text="Mình muốn đặt lịch sớm nhất có thể.">Đặt lịch sớm nhất</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm quick-reply" data-text="Cho mình hỏi thời gian làm việc và khu vực phục vụ?">Giờ làm & khu vực</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm quick-reply" data-text="Có khuyến mãi nào hiện tại không?">Hỏi khuyến mãi</button>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Ô soạn tin -->
                    <div class="msg-input p-3">
                        <form method="post"
                              action='@Url.Action("Send", "ChatCustomer", new { area = "Customer" })'
                              class="w-100"
                              enctype="multipart/form-data">

                            @Html.AntiForgeryToken()
                            <input type="hidden" name="conversationId" value="@Model.SelectedConversationId" />
                            <!-- ===== Hidden + pill hiển thị đang trả lời ===== -->
                            <input type="hidden" name="replyToMessageId" id="replyToMessageId" value="" />
                            <div id="replyPreview" class="replying-pill d-none p-2 mb-2 small d-flex align-items-start gap-2">
                                <i class="bi bi-reply mt-1"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" id="replyingToName"></div>
                                    <div class="text-muted text-truncate" id="replyingSnippet" style="max-width: 520px;"></div>
                                </div>
                                <button type="button" id="cancelReplyBtn" class="btn btn-sm btn-outline-secondary" onclick="window.cancelReply(); return false;" style="cursor: pointer !important; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 18px; font-weight: bold;">×</button>
                            </div>

                            <div id="attachPreview" class="d-none mt-2 mb-2">
                                <div class="image-preview-container position-relative d-inline-block">
                                    <img id="attachThumb"
                                         src=""
                                         alt="Xem trước"
                                         style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 2px solid #e2e8f0; display: block; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"
                                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    <button type="button" id="removeAttachBtn" class="btn-close-image position-absolute" style="top: -8px; right: -8px; width: 28px; height: 28px; border-radius: 50%; background: #ffffff; border: 2px solid #dc3545; color: #dc3545; font-size: 18px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: all 0.2s ease; z-index: 10;">
                                        ×
                                    </button>
                                </div>
                            </div>

                            <div class="d-flex gap-2 align-items-center">
                                <input type="text"
                                       name="body"
                                       id="messageBodyInput"
                                       class="form-control"
                                       placeholder="Nhập tin nhắn…"
                                       autocomplete="off" />

                                <input type="file"
                                       id="fileInput"
                                       name="image"
                                       class="d-none"
                                       accept="image/*" />

                                <button type="button"
                                        id="pickFileBtn"
                                        class="btn btn-outline-secondary"
                                        title="Đính kèm ảnh">
                                    <i class="bi bi-paperclip"></i>
                                </button>

                                <button type="submit"
                                        id="sendMessageBtn"
                                        class="btn btn-primary"
                                        title="Gửi tin nhắn"
                                        disabled>
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </main>
            }
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>


@section Scripts {
    @* Hệ thống quản lý avatar trong conversation list (sử dụng sessionStorage) *@
    <script>
        (function() {
            try {
                var fallbackImg = '@fallbackImg';
                var STORAGE_KEY = 'chat_avatars_customer';

                // Khởi tạo storage nếu chưa có
                function initStorage() {
                    if (!sessionStorage.getItem(STORAGE_KEY)) {
                        sessionStorage.setItem(STORAGE_KEY, JSON.stringify({}));
                    }
                }

                // Lấy avatar từ storage
                function getAvatarFromStorage(convId) {
                    try {
                        var storage = JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '{}');
                        return storage[convId] || null;
                    } catch (e) {
                        return null;
                    }
                }

                // Lưu avatar vào storage
                function saveAvatarToStorage(convId, avatarUrl) {
                    try {
                        initStorage();
                        var storage = JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '{}');
                        if (avatarUrl && avatarUrl.trim()) {
                            storage[convId] = avatarUrl;
                            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
                            return true;
                        }
                    } catch (e) {
                        console.warn('Failed to save avatar to storage:', e);
                    }
                    return false;
                }

                // Cập nhật avatar trong conversation item
                function updateAvatarInListItem(convItem, avatarUrl) {
                    if (!convItem || !avatarUrl) return;

                    var avatarImg = convItem.querySelector('.avatar');
                    if (!avatarImg) return;

                    var currentSrc = avatarImg.getAttribute('src') || '';
                    var isFallback = !currentSrc || currentSrc === fallbackImg || currentSrc.indexOf('VeSinh.jpg') > -1;

                    // Cập nhật nếu đang hiển thị fallback hoặc URL khác
                    if (isFallback || (currentSrc && currentSrc !== avatarUrl && !currentSrc.includes(avatarUrl.split('?')[0]))) {
                        var separator = avatarUrl.indexOf('?') > -1 ? '&' : '?';
                        avatarImg.src = avatarUrl + separator + 't=' + new Date().getTime();
                        // Cập nhật data-avatar-url attribute
                        convItem.setAttribute('data-avatar-url', avatarUrl);
                    }
                }

                // Áp dụng avatar từ storage cho tất cả conversations
                function applyStoredAvatars() {
                    var convItems = document.querySelectorAll('.conv-item[data-conversation-id]');
                    convItems.forEach(function(convItem) {
                        var convId = convItem.getAttribute('data-conversation-id');
                        if (convId) {
                            var storedAvatar = getAvatarFromStorage(convId);
                            if (storedAvatar) {
                                updateAvatarInListItem(convItem, storedAvatar);
                            }
                        }
                    });
                }

                // Khởi tạo
                initStorage();

                // Áp dụng avatar từ storage ngay khi trang load
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', applyStoredAvatars);
                } else {
                    applyStoredAvatars();
                }

                // Lưu hàm vào window để sử dụng từ các script khác
                window.chatAvatarManager = {
                    save: saveAvatarToStorage,
                    get: getAvatarFromStorage,
                    update: updateAvatarInListItem,
                    applyAll: applyStoredAvatars
                };
            } catch (e) {
                console.warn('Failed to initialize avatar manager:', e);
            }
        })();
    </script>

    @* Lưu avatar từ selected conversation vào storage *@
    @if (hasSelection && otherInSelected != null && Model.SelectedConversationId.HasValue && !string.IsNullOrWhiteSpace(otherInSelected.AvatarUrl))
    {
        <script>
            (function() {
                try {
                    var selectedConvId = '@Model.SelectedConversationId.Value';
                    var correctAvatarUrl = '@(Html.Raw(otherInSelected.AvatarUrl?.Replace("'", "\\'").Replace("\"", "&quot;") ?? ""))';

                    if (selectedConvId && correctAvatarUrl && window.chatAvatarManager) {
                        // Lưu vào storage
                        window.chatAvatarManager.save(selectedConvId, correctAvatarUrl);

                        // Cập nhật ngay trong list
                        var selectedConvItem = document.querySelector('.conv-item[data-conversation-id="' + selectedConvId + '"]');
                        if (selectedConvItem) {
                            window.chatAvatarManager.update(selectedConvItem, correctAvatarUrl);
                        }

                        // Áp dụng lại cho tất cả conversations (để đảm bảo)
                        setTimeout(function() {
                            window.chatAvatarManager.applyAll();
                        }, 100);
                    }
                } catch (e) {
                    console.warn('Failed to save avatar from selected conversation:', e);
                }
            })();
        </script>
    }

    <script>
        (function() {
            var isLoading = false;

            // Lắng nghe khi có conversation được click
            document.addEventListener('click', function(e) {
                var convItem = e.target.closest('.conv-item[data-conversation-id]');
                if (!convItem) return;

                // Ngăn navigation mặc định
                e.preventDefault();
                e.stopPropagation();

                if (isLoading) {
                    console.log('[Chat] Already loading, ignoring click');
                    return;
                }

                var convId = convItem.getAttribute('data-conversation-id');
                var convUrl = convItem.getAttribute('data-conversation-url') || convItem.getAttribute('href');
                var avatarUrl = convItem.getAttribute('data-avatar-url');

                if (!convId || !convUrl) {
                    console.warn('[Chat] Missing conversation ID or URL');
                    return;
                }

                // Lưu avatar vào storage nếu có
                if (window.chatAvatarManager && avatarUrl && avatarUrl.trim()) {
                    window.chatAvatarManager.save(convId, avatarUrl);
                }

                // Cập nhật active state trong sidebar
                document.querySelectorAll('.conv-item').forEach(function(item) {
                    item.classList.remove('bg-light', 'active');
                });
                convItem.classList.add('bg-light');

                // Ẩn unread badge nếu có
                var unreadBadge = convItem.querySelector('.badge, .unread-badge');
                if (unreadBadge) {
                    unreadBadge.style.display = 'none';
                    unreadBadge.remove();
                }

                // Load conversation qua AJAX
                isLoading = true;
                // Chỉ chọn main của khung chat
                var chatMain = document.querySelector('main.chat-col');

                // Hiển thị loading state
                if (chatMain) {
                    chatMain.innerHTML =
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; padding: 2rem;">' +
                            '<div style="text-align: center;">' +
                                '<div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">' +
                                    '<span class="visually-hidden">Loading...</span>' +
                                '</div>' +
                                '<div style="margin-top: 1rem;">Đang tải cuộc trò chuyện...</div>' +
                            '</div>' +
                        '</div>';
                }

                // Fetch conversation mới
                fetch(convUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'text/html'
                    },
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.text();
                })
                .then(function(html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');

                    // Lấy main chat từ response
                    var newChatMain = doc.querySelector('main.chat-col');
                    var currentMain = document.querySelector('main.chat-col');

                    if (newChatMain && currentMain) {
                        // Thay main cũ bằng main mới
                        currentMain.outerHTML = newChatMain.outerHTML;

                        // Update URL (không reload)
                        if (window.history && window.history.pushState) {
                            window.history.pushState({ conversationId: convId }, '', convUrl);
                        }

                               // Re-init form gửi chat (nút gửi + nút file)
        if (window.initChatForm) {
            window.initChatForm();
        }

        // Re-init realtime gắn với DOM (không tạo connection mới)
        if (window.__initChatRealtimePage) {
            window.__initChatRealtimePage();
        }

        window.scrollTo(0, 0);

                    } else {
                        console.error('[Chat] Could not find chat container in response');
                        window.location.href = convUrl;
                    }
                })
                .catch(function(error) {
                    console.error('[Chat] Error loading conversation:', error);
                    window.location.href = convUrl;
                })
                .finally(function() {
                    isLoading = false;
                });
            }, true);
        })();
    </script>


    @* Ẩn footer chính của trang khi ở trang chat *@
    <script>
        (function() {
            // Ẩn footer chính (chỉ footer ở cấp body, không ảnh hưởng modal/dropdown)
            function hideMainFooter() {
                // Chỉ tìm footer là con trực tiếp của body hoặc có class chính là footer
                var mainFooters = document.querySelectorAll('body > footer, body > .footer');

                // Nếu không tìm thấy, tìm các footer không nằm trong modal/dropdown
                if (mainFooters.length === 0) {
                    var allFooters = document.querySelectorAll('footer, .footer');
                    allFooters.forEach(function(footer) {
                        // Bỏ qua nếu footer nằm trong modal, dropdown, hoặc các container đặc biệt
                        var parent = footer.parentElement;
                        var isInModal = false;
                        var isInDropdown = false;
                        var isInSpecialContainer = false;

                        while (parent && parent !== document.body) {
                            if (parent.classList.contains('modal') ||
                                parent.classList.contains('dropdown') ||
                                parent.classList.contains('dropdown-menu') ||
                                parent.classList.contains('card') ||
                                parent.classList.contains('form') ||
                                parent.classList.contains('kb-card') ||
                                parent.classList.contains('address-modal') ||
                                parent.classList.contains('upsert-form') ||
                                parent.classList.contains('rv-modal')) {
                                isInModal = true;
                                isInDropdown = true;
                                isInSpecialContainer = true;
                                break;
                            }
                            parent = parent.parentElement;
                        }

                        // Chỉ ẩn footer chính, không ẩn footer trong modal/dropdown
                        if (!isInModal && !isInDropdown && !isInSpecialContainer) {
                            footer.style.display = 'none';
                            footer.style.visibility = 'hidden';
                            footer.style.height = '0';
                            footer.style.margin = '0';
                            footer.style.padding = '0';
                            footer.style.opacity = '0';
                            footer.style.overflow = 'hidden';
                        }
                    });
                } else {
                    // Ẩn footer chính
                    mainFooters.forEach(function(footer) {
                        footer.style.display = 'none';
                        footer.style.visibility = 'hidden';
                        footer.style.height = '0';
                        footer.style.margin = '0';
                        footer.style.padding = '0';
                        footer.style.opacity = '0';
                        footer.style.overflow = 'hidden';
                    });
                }
            }

            // Chạy ngay lập tức
            hideMainFooter();

            // Chạy khi DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideMainFooter);
            } else {
                hideMainFooter();
            }

            // Chạy sau khi window load
            window.addEventListener('load', hideMainFooter);
        })();
    </script>

    @* Chỉ auto-scroll khi đã chọn hội thoại *@
    @if (hasSelection)
    {
        <script>
            (function () {
              var el = document.getElementById('msgList');
              if (el) el.scrollTop = el.scrollHeight;
            })();
        </script>
    }

    @* Search functionality *@
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing search functionality...');

            const searchInput = document.getElementById('searchConversation');
            const conversationList = document.getElementById('conversationList');
            const conversationCount = document.getElementById('conversationCount');

            if (!searchInput) {
                console.error('Search input not found!');
                return;
            }
            if (!conversationList) {
                console.error('Conversation list not found!');
                return;
            }
            if (!conversationCount) {
                console.error('Conversation count not found!');
                return;
            }

            console.log('All search elements found:', {
                input: searchInput,
                list: conversationList,
                count: conversationCount
            });

            function getAllConversations() {
                return Array.from(conversationList.querySelectorAll('.conv-item'));
            }

            // Debounce để tránh filter quá nhiều lần
            let searchTimeout;

            function filterConversations() {
                const actualSearchInput = document.getElementById('searchConversation');
                if (!actualSearchInput) return;

                const searchTerm = (actualSearchInput.value || '').toLowerCase().trim();
                const allConversations = getAllConversations();

                console.log('Filtering with term:', searchTerm, 'Total conversations:', allConversations.length);

                if (!searchTerm) {
                    // Hiển thị tất cả
                    allConversations.forEach(item => {
                        item.style.display = '';
                        item.style.visibility = '';
                        item.hidden = false;
                    });
                    conversationCount.textContent = '(@Model.Conversations.Count)';
                    return;
                }

                let visibleCount = 0;

                // Ẩn tất cả trước
                allConversations.forEach(item => {
                    item.style.display = 'none';
                    item.style.visibility = 'hidden';
                    item.hidden = true;
                });

                // Chỉ hiển thị những cái khớp
                allConversations.forEach(item => {
                    let title = item.getAttribute('data-search-title') || '';
                    let snippet = item.getAttribute('data-search-snippet') || '';

                    // Fallback: nếu không có data attribute, lấy từ text content
                    if (!title && !snippet) {
                        const titleEl = item.querySelector('.fw-semibold');
                        const snippetEl = item.querySelector('.small.text-muted.text-ellipsis-1');
                        title = titleEl ? (titleEl.textContent || '').toLowerCase().trim() : '';
                        snippet = snippetEl ? (snippetEl.textContent || '').toLowerCase().trim() : '';
                    }

                    // Tìm kiếm trong cả title và snippet
                    const searchText = (title + ' ' + snippet).toLowerCase().trim();
                    const matches = searchText.includes(searchTerm) ||
                                   title.includes(searchTerm) ||
                                   snippet.includes(searchTerm);

                    if (matches && searchTerm.length > 0) {
                        // Hiển thị item này
                        item.style.display = '';
                        item.style.visibility = '';
                        item.hidden = false;
                        visibleCount++;
                    }
                });

                conversationCount.textContent = '(' + visibleCount + ')';
                console.log('Filtered to:', visibleCount, 'conversations');
            }

            const actualSearchInput = searchInput;

            actualSearchInput.addEventListener('input', function (e) {
                console.log('Input event triggered:', e.target.value);
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    filterConversations();
                }, 150);
            });

            actualSearchInput.addEventListener('keyup', function (e) {
                if (e.key === 'Enter' || e.key === 'Escape') {
                    if (e.key === 'Escape' && actualSearchInput.value) {
                        actualSearchInput.value = '';
                        filterConversations();
                    }
                }
            });

            // Clear search khi click vào icon
            const iconElement = actualSearchInput.parentElement.querySelector('.input-group-text');
            if (iconElement) {
                iconElement.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Icon clicked');
                    if (actualSearchInput.value) {
                        actualSearchInput.value = '';
                        filterConversations();
                        actualSearchInput.focus();
                    }
                });
            } else {
                console.warn('Icon element not found');
            }

            // Test search on load
            console.log('Search initialized successfully!', {
                input: actualSearchInput,
                list: conversationList,
                count: conversationCount,
                conversations: getAllConversations().length
            });
        });
    </script>

    @* Initialize dropdown functionality *@
    <script>
        (function() {
            // Đảm bảo dropdown hoạt động sau khi Bootstrap load
            function initDropdown() {
                const dropdownBtn = document.getElementById('chatOptionsBtn');
                const dropdownMenu = document.getElementById('chatOptionsMenu');
                const deleteBtn = document.getElementById('deleteConversationBtn');

                if (!dropdownBtn || !dropdownMenu) {
                    console.log('Dropdown elements not found');
                    return;
                }

                console.log('Initializing dropdown...');

                // Đảm bảo button có thể click
                dropdownBtn.style.pointerEvents = 'auto';
                dropdownBtn.style.cursor = 'pointer';

                // Đảm bảo menu có thể hiển thị
                dropdownMenu.style.pointerEvents = 'auto';

                // Xử lý click cho delete button
                // Không cần xử lý gì ở đây vì form đã có onsubmit với confirm
                // Button type="submit" sẽ tự động trigger form submit

                // Toggle dropdown manually nếu Bootstrap chưa load
                dropdownBtn.addEventListener('click', function(e) {
                    console.log('Dropdown button clicked');
                    e.stopPropagation();

                    // Nếu Bootstrap đã load, để Bootstrap xử lý
                    if (window.bootstrap && window.bootstrap.Dropdown) {
                        return;
                    }

                    // Fallback: toggle manually
                    const isShowing = dropdownMenu.classList.contains('show');
                    if (isShowing) {
                        dropdownMenu.classList.remove('show');
                    } else {
                        dropdownMenu.classList.add('show');
                    }
                });

                // Đóng dropdown khi click bên ngoài
                document.addEventListener('click', function(e) {
                    if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        dropdownMenu.classList.remove('show');
                    }
                });
            }

            // Chờ Bootstrap load hoặc DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initDropdown, 100);
                });
            } else {
                setTimeout(initDropdown, 100);
            }
        })();
    </script>

    <script>
        (function () {
          document.addEventListener('click', function (e) {
            const btn = e.target.closest('.quick-reply');
            if (!btn) return;

            const main = document.querySelector('main.chat-col[data-selected-conv]');
            if (!main) return;

            const form = main.querySelector('form[action*="ChatCustomer/Send"]');
            const input = form?.querySelector('input[name="body"]');
            if (!form || !input) return;

            input.value = btn.dataset.text || btn.textContent || '';
            form.submit();
          }, { passive: true });
        })();
    </script>



    <script>
        // Hàm khởi tạo form chat (gửi text + gửi ảnh)
        window.initChatForm = function () {
          // Luôn lấy main hiện tại sau khi đổi conversation
          var main = document.querySelector('main.chat-col[data-selected-conv]');
          if (!main) return;

          var pickBtn     = main.querySelector('#pickFileBtn');
          var fileInput   = main.querySelector('#fileInput');
          var previewWrap = main.querySelector('#attachPreview');
          var imgEl       = main.querySelector('#attachThumb');
          var removeBtn   = main.querySelector('#removeAttachBtn');
          var objectUrl   = null;

          // Form và inputs
          var form      = main.querySelector('form[action*="ChatCustomer/Send"]');
          var bodyInput = main.querySelector('#messageBodyInput') || form?.querySelector('input[name="body"]');
          var sendBtn   = main.querySelector('#sendMessageBtn')   || form?.querySelector('button[type="submit"]');

          if (!pickBtn || !fileInput || !form || !sendBtn) return;

          // Kiểm tra có nội dung để gửi (text hoặc ảnh)
          function hasPayload() {
            var hasText  = !!(bodyInput && bodyInput.value && bodyInput.value.trim().length > 0);
            var hasImage = !!(fileInput && fileInput.files && fileInput.files.length > 0);
            return hasText || hasImage;
          }

          // Cập nhật trạng thái nút gửi
          function refreshSendState() {
            if (sendBtn) {
              sendBtn.disabled = !hasPayload();
            }
          }

          // Clear handler cũ nếu có (phòng khi init lại nhiều lần)
          pickBtn.onclick   = null;
          fileInput.onchange = null;
          if (removeBtn) removeBtn.onclick = null;
          form.onsubmit     = null;

          // Chọn file
          pickBtn.addEventListener('click', function () { fileInput.click(); });

          // Thay đổi file
          fileInput.addEventListener('change', function () {
            if (objectUrl) {
              URL.revokeObjectURL(objectUrl);
              objectUrl = null;
            }

            if (fileInput.files && fileInput.files.length > 0) {
              var f = fileInput.files[0];

              if (!f.type || !f.type.startsWith('image/')) {
                alert('Vui lòng chọn file ảnh.');
                fileInput.value = '';
                previewWrap.classList.add('d-none');
                refreshSendState();
                return;
              }

              // Kiểm tra kích thước file (tối đa 5MB)
              if (f.size > 5 * 1024 * 1024) {
                alert('Kích thước file không được vượt quá 5MB.');
                fileInput.value = '';
                previewWrap.classList.add('d-none');
                refreshSendState();
                return;
              }

              objectUrl = URL.createObjectURL(f);
              imgEl.src = objectUrl;
              previewWrap.classList.remove('d-none');
            } else {
              previewWrap.classList.add('d-none');
            }

            refreshSendState();
          });

          // Xóa ảnh
          removeBtn?.addEventListener('click', function () {
            if (objectUrl) {
              URL.revokeObjectURL(objectUrl);
              objectUrl = null;
            }
            fileInput.value = '';
            imgEl.src = '';
            previewWrap.classList.add('d-none');
            refreshSendState();
          });

          // Validate form trước khi submit
          form.addEventListener('submit', function(e) {
            console.log('[Chat] Form submit triggered');

            if (!hasPayload()) {
              e.preventDefault();
              e.stopPropagation();
              alert('Vui lòng nhập nội dung hoặc đính kèm ảnh trước khi gửi.');
              if (bodyInput) bodyInput.focus();
              return false;
            }

            if (fileInput && fileInput.files && fileInput.files.length > 0) {
              var file = fileInput.files[0];

              if (!file.type || !file.type.startsWith('image/')) {
                e.preventDefault();
                e.stopPropagation();
                alert('Vui lòng chọn file ảnh hợp lệ.');
                return false;
              }

              if (file.size > 5 * 1024 * 1024) {
                e.preventDefault();
                e.stopPropagation();
                alert('Kích thước file không được vượt quá 5MB.');
                return false;
              }
            }

            // Disable button để tránh spam
            var originalBtnText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.style.pointerEvents = 'none';
            sendBtn.style.opacity = '0.6';
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...';

            // Re-enable sau 10 giây nếu có lỗi (timeout)
            var timeoutId = setTimeout(function() {
              console.warn('[Chat] Submit timeout - re-enabling button');
              sendBtn.disabled = false;
              sendBtn.style.pointerEvents = 'auto';
              sendBtn.style.opacity = '1';
              sendBtn.innerHTML = originalBtnText;
            }, 10000);

            window.addEventListener('beforeunload', function() {
              clearTimeout(timeoutId);
            });
          });

          // Cập nhật trạng thái khi nhập text
          if (bodyInput) {
            bodyInput.addEventListener('input', refreshSendState);
            bodyInput.addEventListener('keyup', function(e) {
              if (e.key === 'Enter' && !e.shiftKey && hasPayload()) {
                // Cho phép submit bình thường
              }
            });
          }

          // Khởi tạo trạng thái ban đầu
          refreshSendState();
        };

        // Init lần đầu khi trang load
        document.addEventListener('DOMContentLoaded', function () {
          window.initChatForm();
        });
    </script>


    @* ====== Reply System - Định nghĩa sớm để có thể dùng trong HTML ====== *@
    <script>
        // Định nghĩa GLOBAL function ngay từ đầu để có thể dùng trong inline onclick
        window.handleReplyClickDirect = function(btn) {
          console.log('[Reply] ===== handleReplyClickDirect called =====', btn);

          if (!btn) {
            console.error('[Reply] No button provided');
            return false;
          }

          // Lấy elements
          var replyHidden = document.getElementById('replyToMessageId');
          var replyPreview = document.getElementById('replyPreview');
          var replyingToName = document.getElementById('replyingToName');
          var replyingSnippet = document.getElementById('replyingSnippet');

          if (!replyHidden || !replyPreview) {
            console.error('[Reply] Elements not ready, initializing...');
            // Thử khởi tạo lại
            if (window.__initReplyUi) {
              window.__initReplyUi();
            }
            setTimeout(function() {
              window.handleReplyClickDirect(btn);
            }, 100);
            return false;
          }

          // Lấy data từ button hoặc bubble
          var id = btn.getAttribute('data-message-id') || '';
          var name = btn.getAttribute('data-sender-name') || '—';
          var snippet = btn.getAttribute('data-snippet') || '';

          // Nếu không có trên button, tìm từ bubble
          if (!id) {
            var bubble = btn.closest('.bubble');
            if (bubble) {
              id = bubble.getAttribute('data-message-id') || '';
              name = bubble.getAttribute('data-sender-name') || '—';
              snippet = bubble.getAttribute('data-snippet') || '';
            }
          }

          console.log('[Reply] Data found:', {id, name, snippet});

          if (id && id.trim() !== '') {
            // Hiển thị reply preview
            replyHidden.value = id;
            if (replyingToName) replyingToName.textContent = name || '—';
            if (replyingSnippet) replyingSnippet.textContent = snippet || '';

            replyPreview.classList.remove('d-none');
            replyPreview.style.display = 'flex';
            replyPreview.style.visibility = 'visible';
            replyPreview.style.opacity = '1';
            replyPreview.style.height = 'auto';
            replyPreview.style.padding = '10px 14px';
            replyPreview.style.marginBottom = '10px';

            var form = document.querySelector('form[action*="ChatCustomer/Send"]');
            var bodyInput = form?.querySelector('input[name="body"]');
            if (bodyInput) bodyInput.focus();

            console.log('[Reply] ✓ Preview shown successfully');
          } else {
            console.error('[Reply] No valid message ID found');
          }

          return false;
        };

        // Hàm hủy reply - GLOBAL để có thể gọi từ inline onclick
        window.cancelReply = function() {
          console.log('[Reply] ===== cancelReply called =====');

          var replyHidden = document.getElementById('replyToMessageId');
          var replyPreview = document.getElementById('replyPreview');
          var replyingToName = document.getElementById('replyingToName');
          var replyingSnippet = document.getElementById('replyingSnippet');

          if (replyHidden) replyHidden.value = '';
          if (replyingToName) replyingToName.textContent = '';
          if (replyingSnippet) replyingSnippet.textContent = '';

          if (replyPreview) {
            replyPreview.classList.add('d-none');
            replyPreview.style.display = 'none';
            replyPreview.style.visibility = 'hidden';
            replyPreview.style.opacity = '0';
            replyPreview.style.height = '0';
            replyPreview.style.padding = '0';
            replyPreview.style.margin = '0';
          }

          console.log('[Reply] ✓ Reply cancelled successfully');
          return false;
        };

        console.log('[Reply] handleReplyClickDirect and cancelReply functions defined');
    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        // ===== Helpers chung cho Chat Customer (giống style Provider) =====

        // Hàm format thời gian thông minh cho chat (đồng bộ với C# FormatChatTime)
        function __customerFormatChatTime(dateStr) {
            if (!dateStr) return '';

            const sourceDate = __customerParseIso(dateStr);
            if (!sourceDate) return '';

            const TZ = 'Asia/Ho_Chi_Minh';

            const formatDateKey = (date) => {
                const formatted = new Intl.DateTimeFormat('en-CA', {
                    timeZone: TZ,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).format(date); // yyyy-mm-dd
                const [year, month, day] = formatted.split('-').map(Number);
                return {
                    key: formatted,
                    year,
                    month,
                    day,
                    utcMidnightMs: Date.UTC(year, month - 1, day)
                };
            };

            const msgDateInfo = formatDateKey(sourceDate);
            const todayDate = new Date();
            const todayInfo = formatDateKey(todayDate);
            const yesterdayInfo = formatDateKey(new Date(todayDate.getTime() - 86400000));

            const timeFormatter = new Intl.DateTimeFormat('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: TZ
            });
            const hhmm = timeFormatter.format(sourceDate);

            // Cùng ngày: chỉ hiển thị giờ
            if (msgDateInfo.key === todayInfo.key) {
                return hhmm;
            }

            // Hôm qua
            if (msgDateInfo.key === yesterdayInfo.key) {
                return 'Hôm qua ' + hhmm;
            }

            // Khoảng cách ngày theo múi giờ VN
            const diffDays = Math.round((todayInfo.utcMidnightMs - msgDateInfo.utcMidnightMs) / 86400000);
            if (diffDays > 0 && diffDays <= 7) {
                const weekdayKey = new Intl.DateTimeFormat('en-US', {
                    weekday: 'short',
                    timeZone: TZ
                }).format(sourceDate);
                const dayMap = {
                    Sun: 'CN',
                    Mon: 'Thứ 2',
                    Tue: 'Thứ 3',
                    Wed: 'Thứ 4',
                    Thu: 'Thứ 5',
                    Fri: 'Thứ 6',
                    Sat: 'Thứ 7'
                };
                const dayLabel = dayMap[weekdayKey] || weekdayKey;
                return dayLabel + ' ' + hhmm;
            }

            // Trong cùng năm: hiển thị ngày/tháng + giờ
            if (msgDateInfo.year === todayInfo.year) {
                const dateFormatterWithinYear = new Intl.DateTimeFormat('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    timeZone: TZ
                });
                return dateFormatterWithinYear.format(sourceDate) + ' ' + hhmm;
            }

            // Khác năm: hiển thị đầy đủ
            const fullFormatter = new Intl.DateTimeFormat('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: TZ
            });
            return fullFormatter.format(sourceDate) + ' ' + hhmm;
        }

        // Lấy convId đang mở (lowercase để so sánh)
        function __customerChatGetCurrentConvId() {
            const main = document.querySelector('main.chat-col[data-selected-conv]');
            if (!main) return '';
            const attr = main.getAttribute('data-selected-conv') || '';
            return attr.toLowerCase();
        }

        // Lấy convId raw (dùng gọi API)
        function __customerChatGetCurrentConvIdRaw() {
            const main = document.querySelector('main.chat-col[data-selected-conv]');
            if (!main) return '';
            return main.getAttribute('data-selected-conv') || '';
        }

        // Gọi MarkRead cho hội thoại hiện tại (Customer)
        function __customerChatMarkReadCurrent() {
            const convId = __customerChatGetCurrentConvIdRaw();
            if (!convId) return;

            const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenEl ? tokenEl.value : '';

            // DÙNG Url.Action để chắc route đúng
            const url = '@Url.Action("MarkRead", "ChatCustomer", new { area = "Customer" })'
                      + '?conversationId=' + encodeURIComponent(convId);

            fetch(url, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token },
                credentials: 'same-origin'
            })
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json().catch(() => ({}));
            })
            .then(d => console.log('[customer-chat] ✅ MarkRead OK', d))
            .catch(err => console.error('[customer-chat] ❌ MarkRead lỗi', err));
        }

              // Parse ISO an toàn: nếu không có timezone thì ép về UTC (thêm 'Z')
        function __customerParseIso(s) {
            if (!s) return null;

            s = String(s).trim();
            if (!s) return null;

            // Có phần time hay không
            const hasTime = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s);
            // Có timezone (Z hoặc +07:00 / -05:00) hay chưa
            const hasZone = /Z$|[+\-]\d{2}:?\d{2}$/.test(s);

            // Nếu có time mà không có timezone -> coi là UTC
            if (hasTime && !hasZone) {
                s = s + 'Z';
            }

            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }


        // Render status icon + text
        function __customerStatusHtml(status) {
            let icon = '', text = '';
            switch (status) {
                case 'Pending':   icon = '<i class="bi bi-clock-history"></i>'; text = 'Đang gửi'; break;
                case 'Sent':      icon = '<i class="bi bi-check"></i>';         text = 'Đã gửi';   break;
                case 'Delivered': icon = '<i class="bi bi-check2-all"></i>';    text = 'Đã nhận';  break;
                case 'Seen':      icon = '<i class="bi bi-check2-all"></i>';    text = 'Đã xem';   break;
            }
            return '<span class="msg-status d-inline-flex align-items-center gap-1" data-status="' + status + '">' +
                    icon + '<span class="d-none d-md-inline">' + text + '</span></span>';
        }

        function __customerSetBubbleStatus(bubble, status) {
            if (!bubble) return;
            bubble.setAttribute('data-status', status);
            const meta = bubble.querySelector('.msg-meta');
            if (!meta) return;

            let statusEl = meta.querySelector('.msg-status');
            if (!statusEl) {
                // chỉ render cho tin của mình
                if (bubble.dataset.isMine === 'true') {
                    meta.insertAdjacentHTML('beforeend', __customerStatusHtml(status));
                }
            } else {
                statusEl.outerHTML = __customerStatusHtml(status);
            }
        }

        // Đánh dấu tất cả tin của mình <= lastReadAt là Delivered
               function __customerApplyReadUpTo(lastReadAtIso) {
            const lastReadAt = __customerParseIso(lastReadAtIso);
            console.log('[customer-chat] __customerApplyReadUpTo', { lastReadAtIso, lastReadAt });
            if (!lastReadAt) return;

            document.querySelectorAll('.bubble[data-is-mine="true"]').forEach(b => {
                const rawCreated = b.getAttribute('data-created-at');
                const created = __customerParseIso(rawCreated);
                console.log('  - bubble', b.dataset.messageId, { rawCreated, created });
                if (created && created <= lastReadAt) {
                    __customerSetBubbleStatus(b, 'Delivered');
                }
            });
        }


        // Gắn reply-ref nếu có
        function __customerAttachReplyRefIfAny(bubbleEl, msg) {
            if (!msg || !msg.replyToMessageId) return;

            const refId = String(msg.replyToMessageId);
            const parent = document.querySelector('.bubble[data-message-id="' + refId + '"]');

            const name = parent?.getAttribute('data-sender-name') || (msg.replyToSenderName || '—');
            const sn   = parent?.getAttribute('data-snippet')      || (msg.replyToSnippet || '(Không có nội dung)');

            const wrap = document.createElement('div');
            wrap.className = 'reply-ref small text-muted border-start ps-2 mb-2';

            const nameEl = document.createElement('div');
            nameEl.className = 'fw-semibold';
            nameEl.textContent = name;

            const snEl = document.createElement('div');
            snEl.className = 'text-truncate';
            snEl.style.maxWidth = '420px';
            snEl.textContent = sn;

            wrap.appendChild(nameEl);
            wrap.appendChild(snEl);
            bubbleEl.insertAdjacentElement('afterbegin', wrap);
        }

                // Cập nhật trạng thái 1 message cụ thể theo payload từ server
        function __customerHandleStatusChanged(payload) {
            console.log('[customer-chat] message status changed', payload);
            if (!payload) return;

            const currentConvId = __customerChatGetCurrentConvId();
            if (!currentConvId) return;

            const payloadConvId = String(
                payload.conversationId ?? payload.ConversationId ?? ''
            ).toLowerCase();

            // Nếu event không thuộc hội thoại đang mở thì bỏ qua
            if (!payloadConvId || payloadConvId !== currentConvId) {
                return;
            }

            const msgId = String(payload.messageId ?? payload.MessageId ?? '');
            const status = payload.status ?? payload.Status;
            if (!msgId || !status) return;

            // Chỉ update bubble của mình
            const bubble = document.querySelector(
                '.bubble[data-message-id="' + msgId + '"][data-is-mine="true"]'
            );
            if (!bubble) return;

            __customerSetBubbleStatus(bubble, status);
        }


               // ===== Khởi tạo realtime cho trang Chat Customer (giống provider) =====
        window.__initChatRealtimePage = function () {
            console.log('[customer-chat] 🚀 __initChatRealtimePage được gọi');

            // Id của mình
            const me = '@(Model.CurrentAccount?.AccountId.ToString() ?? Guid.Empty.ToString())'.toLowerCase();
            const GUID_EMPTY = '00000000-0000-0000-0000-000000000000';

            if (!me || me === GUID_EMPTY) {
                console.warn('[customer-chat] me là GUID rỗng, bỏ qua SignalR init');
                return;
            }

            let connection = window.__chatConnection;
            if (!connection) {
                console.log('[customer-chat] ⏳ Chưa có window.__chatConnection, sẽ thử lại sau');
                if (!window.__customerChatRetryCount) window.__customerChatRetryCount = 0;
                if (window.__customerChatRetryCount < 50) {
                    window.__customerChatRetryCount++;
                    setTimeout(window.__initChatRealtimePage, 300);
                } else {
                    console.error('[customer-chat] ❌ Không tìm thấy window.__chatConnection sau 50 lần thử');
                }
                return;
            }

            console.log('[customer-chat] ✅ Dùng lại window.__chatConnection, state =', connection.state);

            // ⭐ GẮN onAny Ở ĐÂY – SAU KHI ĐÃ CHẮC CHẮN CÓ connection
            if (typeof connection.onAny === 'function' && !connection.__customerLogAllEventsAttached) {
                connection.__customerLogAllEventsAttached = true;
                connection.onAny((eventName, ...args) => {
                    console.log('[customer-chat] 🔔 onAny event =', eventName, 'payload =', args);
                });
            }

            // Vừa vào / vừa load conv -> MarkRead ngay (giống provider)
            const main = document.querySelector('main.chat-col[data-selected-conv]');
            if (main && !main.__customerHandlersAttachedOnThisMain) {
                main.__customerHandlersAttachedOnThisMain = true;
                __customerChatMarkReadCurrent();
            }

            // Nếu đã gắn handler rồi thì không gắn lại (tránh double event)
            if (connection.__customerHandlersAttached) {
                console.log('[customer-chat] Handlers đã gắn trước đó, bỏ qua.');
                return;
            }

            connection.__customerHandlersAttached = true;

            // 1) Người kia đọc đến đâu → cập nhật "Đã nhận"
            connection.on('conversation:readUpTo', payload => {
                console.log('[customer-chat] conversation:readUpTo', payload);
                if (!payload) return;

                const currentConvId = __customerChatGetCurrentConvId();
                if (!currentConvId) return;

                const payloadConvId = String(
                    payload.conversationId ?? payload.ConversationId ?? ''
                ).toLowerCase();

                if (!payloadConvId || payloadConvId !== currentConvId) {
                    console.log('[customer-chat] readUpTo không thuộc conv đang mở -> bỏ qua');
                    return;
                }

                const lastReadAt = payload.lastReadAt ?? payload.LastReadAt ?? null;
                __customerApplyReadUpTo(lastReadAt);
            });

            // 2) Tin nhắn mới
            connection.on('message:created', msg => {
                console.log('[customer-chat] message:created', msg);
                if (!msg) return;

                const currentConvId = __customerChatGetCurrentConvId();
                if (!currentConvId) return;

                const msgConvId = String(
                    msg.conversationId ?? msg.ConversationId ?? ''
                ).toLowerCase();

                if (!msgConvId || msgConvId !== currentConvId) {
                    // Thuộc hội thoại khác → chỉ sidebar xử lý
                    return;
                }

                const msgList = document.getElementById('msgList');
                if (!msgList) return;

                const senderId = String(msg.senderAccountId ?? msg.SenderAccountId ?? '').toLowerCase();
                const isMine   = senderId === me;

                const messageId = msg.messageId ?? msg.MessageId;
                const createdAt = msg.createdAt ?? msg.CreatedAt;
                const body      = msg.body ?? msg.Body;
                const imageUrl  = msg.imageUrl ?? msg.ImageUrl;
                const status    = msg.status ?? msg.Status ?? 'Sent';

                const replyToId = msg.replyToMessageId ?? msg.ReplyToMessageId;

                const wrap = document.createElement('div');
                wrap.className = 'd-flex ' + (isMine ? 'justify-content-end' : 'justify-content-start');

                const bubble = document.createElement('div');
                bubble.className = 'bubble ' + (isMine ? 'me' : 'other');
                bubble.setAttribute('data-message-id', messageId);
                bubble.setAttribute('data-created-at', createdAt);
                bubble.setAttribute('data-is-mine', isMine ? 'true' : 'false');
                bubble.setAttribute('data-status', status);

                const senderName = isMine ? 'Bạn' : (msg.senderName ?? msg.SenderName ?? 'Đối tác');
                const snippetThis = body ? body : (imageUrl ? '[Ảnh]' : '(Không có nội dung)');

                bubble.setAttribute('data-sender-name', senderName);
                bubble.setAttribute('data-snippet', snippetThis);

                __customerAttachReplyRefIfAny(bubble, {
                    replyToMessageId: replyToId,
                    replyToSenderName: msg.replyToSenderName ?? msg.ReplyToSenderName,
                    replyToSnippet: msg.replyToSnippet ?? msg.ReplyToSnippet
                });

                if (body) {
                    const bodyEl = document.createElement('div');
                    bodyEl.textContent = body;
                    bubble.appendChild(bodyEl);
                }

                if (imageUrl) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.className = 'mt-2 rounded';
                    img.style.maxWidth = '220px';
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    img.referrerPolicy = 'no-referrer';
                    img.onerror = function () {
                        this.onerror = null;
                        this.src = '@fallbackImg';
                    };
                    bubble.appendChild(img);
                }

                const meta = document.createElement('div');
                meta.className = 'msg-meta text-end small mt-1 d-flex align-items-center justify-content-end gap-2';

                // Format thời gian đồng bộ với C# FormatChatTime
                const formattedTime = __customerFormatChatTime(createdAt);

                meta.innerHTML =
                    '<button type="button" class="btn btn-link btn-sm p-0 text-decoration-none text-muted reply-btn"'
                        + ' title="Trả lời"'
                        + ' data-message-id="' + messageId + '"'
                        + ' data-sender-name="' + (senderName || '—') + '"'
                        + ' data-snippet="' + (snippetThis || '') + '"'
                        + ' onclick="window.handleReplyClickDirect(this); return false;"'
                        + ' style="cursor: pointer !important; pointer-events: auto !important;'
                        + ' z-index: 10 !important; position: relative !important;">'
                        + '<i class="bi bi-reply"></i> <span class="d-none d-md-inline">Reply</span>'
                    + '</button>'
                    + '<span class="text-muted">' + formattedTime + '</span>'
                    + (isMine ? __customerStatusHtml(status) : '');

                bubble.appendChild(meta);
                wrap.appendChild(bubble);
                msgList.appendChild(wrap);
                msgList.scrollTop = msgList.scrollHeight;

                if (!isMine) {
                    __customerChatMarkReadCurrent();
                }
            });

            // 2.5) Trạng thái tin nhắn thay đổi (Pending → Sent → Delivered → Seen)
            connection.on('message:statusChanged', __customerHandleStatusChanged);
            connection.on('message:updated', __customerHandleStatusChanged);
            connection.on('message:status', __customerHandleStatusChanged);

            // 3) Update sidebar
            connection.on('conversationList:update', item => {
                console.log('[customer-chat] conversationList:update', item);
                if (!item) return;

                const list = document.getElementById('conversationList');
                if (!list) return;

                const convId = String(item.conversationId ?? item.ConversationId ?? '');
                if (!convId) return;

                const row = list.querySelector('.conv-item[data-conversation-id="' + convId + '"]');
                if (!row) return;

                const titleEl = row.querySelector('.fw-semibold');
                if (titleEl) titleEl.textContent = item.title ?? item.Title ?? '';

                const snEl = row.querySelector('.conv-snippet');
                if (snEl) snEl.textContent = item.lastMessageSnippet ?? item.LastMessageSnippet ?? '';

                const timeEl = row.querySelector('.conv-time');
                const lastAt = item.lastMessageAt ?? item.LastMessageAt;
                if (timeEl && lastAt) {
                    // Format thời gian đồng bộ với C# FormatChatTime
                    timeEl.textContent = __customerFormatChatTime(lastAt);
                }

                let badge = row.querySelector('.conv-unread');
                const currentConvId = __customerChatGetCurrentConvId();
                let unread = item.unreadCount ?? item.UnreadCount ?? 0;

                if (currentConvId && convId.toLowerCase() === currentConvId) {
                    unread = 0;
                }

                if (!badge && unread > 0) {
                    badge = document.createElement('span');
                    badge.className = 'badge rounded-pill bg-danger ms-2 conv-unread';
                    row.appendChild(badge);
                }

                if (badge) {
                    if (unread > 0) {
                        badge.textContent = unread;
                        badge.style.display = '';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                list.prepend(row);
            });

            // 4) Tổng unread
            connection.on('totalUnread:update', payload => {
                console.log('[customer-chat] totalUnread:update', payload);
                const badge = document.getElementById('chatUnreadBadge');
                if (!badge) return;

                const total = (payload && typeof payload.total === 'number')
                    ? payload.total
                    : (typeof payload === 'number' ? payload : 0);

                badge.style.display = 'inline-block';
                badge.textContent = total.toString();
            });

            // Re-markRead sau reconnect
            if (!connection.__customerReconnectedHooked && connection.onreconnected) {
                connection.__customerReconnectedHooked = true;
                connection.onreconnected(() => {
                    console.log('[customer-chat] 🔁 onreconnected -> MarkRead lại hội thoại đang mở');
                    __customerChatMarkReadCurrent();
                });
            }
        };


        // Gọi init sau khi DOM sẵn sàng (giữ nguyên cách gọi cũ của bạn)
        (function () {
            function start() {
                window.__initChatRealtimePage();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', start);
            } else {
                start();
            }
        })();
    </script>





    <script>
        // Gọi init sau khi DOM và SignalR JS đã load (kể cả khi DOMContentLoaded đã bắn rồi)
        (function () {
            function startChatRealtime() {
                if (window.signalR && window.signalR.HubConnectionBuilder && window.__initChatRealtime) {
                    console.log('[chat] Starting realtime chat from Chat view...');
                    window.__initChatRealtime();
                } else {
                    console.error('[chat] SignalR client script or __initChatRealtime not ready!');
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startChatRealtime);
            } else {
                startChatRealtime();
            }
        })();
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
}
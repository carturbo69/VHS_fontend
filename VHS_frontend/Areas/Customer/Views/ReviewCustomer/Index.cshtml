@model IEnumerable<VHS_frontend.Areas.Customer.Models.ReviewDTOs.ReviewListItemDto>
@using System.Linq
@using System.Text.Json
@using System.Collections.Generic
@using System.Text.Encodings.Web

@{
    ViewData["Title"] = "Đánh giá dịch vụ của tôi";
    var fallbackImg = Url.Content("~/images/vhs_logo.png");
    var fallbackAvatar = Url.Content("~/images/vhs_logo.png");

    // Dùng để auto-open modal và prefill lại dữ liệu khi form Edit invalid
    var openId = (ViewBag.OpenModalId ?? TempData["OpenModalId"])?.ToString();
    var openDto = ViewBag.OpenModalDto;

    // options để serialize JSON không bị escape quá mức (giữ URL gọn)
    var jsonOptions = new JsonSerializerOptions { Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping };
}

<link rel="stylesheet" href="~/css/review-customer.css" asp-append-version="true" />

<div class="rv-container">
    <div class="rv-header">
        <h1 class="rv-title">Đánh giá dịch vụ của tôi</h1>
        @if (Model?.Any() == true)
        {
            <p class="rv-subtitle">@Model.Count() đánh giá</p>
        }
    </div>


    @if (Model?.Any() == true)
    {
        foreach (var r in Model)
        {
            var rawImgs = r?.ReviewImageUrls ?? new List<string>();
            var imgs = rawImgs.Select(u => string.IsNullOrWhiteSpace(u) ? fallbackImg : u).ToList();
            var count = imgs.Count;
            var toShow = imgs.Take(5).ToList();
            var extra = count > 5 ? count - 5 : 0;

            var fullName = string.IsNullOrWhiteSpace(r?.FullName) ? "Người dùng" : r!.FullName;
            var avatar = !string.IsNullOrWhiteSpace(r?.UserAvatarUrl) ? r!.UserAvatarUrl : fallbackAvatar;
            var serviceThumb = !string.IsNullOrWhiteSpace(r?.ServiceThumbnailUrl) ? r!.ServiceThumbnailUrl : fallbackImg;

            var likeCount = r?.LikeCount ?? 0;
            var rating = Math.Clamp((int)(r?.Rating ?? 0), 0, 5);
            var hasReply = !string.IsNullOrWhiteSpace(r?.Reply);

            var canEdit = r?.CanEdit ?? (string.IsNullOrWhiteSpace(r?.Reply)); // fallback nếu API cũ
            var canDelete = r?.CanDelete ?? (string.IsNullOrWhiteSpace(r?.Reply)); // fallback nếu API cũ
            var editCount = r?.EditCount ?? 0;

            <div class="rv-item">
                <!-- Service Info Header -->
                <div class="rv-service-header">
                    <img class="rv-service-thumb" src="@serviceThumb" onerror="this.src='@fallbackImg'" alt="Ảnh dịch vụ" />
                    <div class="rv-service-info">
                        <h3 class="rv-service-title">@r?.ServiceTitle</h3>
                        <div class="rv-service-meta">
                            <span class="rv-service-date">@r?.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </div>
                </div>

                <!-- Review Card -->
                <article class="rv-card" aria-label="Đánh giá của @fullName">
                    <header class="rv-user">
                        <img class="rv-avatar" src="@avatar" onerror="this.src='@fallbackAvatar'" alt="Ảnh đại diện của @fullName" />
                        <div class="rv-user-info">
                            <div class="rv-username">@fullName</div>
                            <div class="rv-rating-row" aria-label="@rating trên 5 sao">
                                <span class="rv-stars" aria-hidden="true">
                                    @(new string('★', rating))@(new string('☆', 5 - rating))
                                </span>
                                <span class="rv-rating-text">@($"{rating:0}.0") sao</span>
                            </div>
                            <div class="rv-meta">
                                @if (likeCount > 0)
                                {
                                    <span class="rv-likes"><svg class="rv-icon" width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg> @likeCount lượt thích</span>
                                }
                            </div>
                        </div>
                    </header>

                    @if (!string.IsNullOrWhiteSpace(r?.Comment))
                    {
                        <div class="rv-comment-wrapper">
                            <p class="rv-comment">@r!.Comment</p>
                        </div>
                    }

                    @if (toShow.Any())
                    {
                        <div class="rv-gallery" data-gallery='@Html.Raw(JsonSerializer.Serialize(imgs, jsonOptions))'>
                            @for (int i = 0; i < toShow.Count; i++)
                            {
                                var url = toShow[i];
                                var isLast = (i == toShow.Count - 1);
                                <button type="button"
                                        class="rv-g-thumb"
                                        data-index="@i"
                                        aria-label="Xem ảnh @(i + 1)"
                                        onclick="rvOpenFromThumb(this)">
                                    <img src="@url" onerror="this.src='@fallbackImg'" alt="Ảnh @(i + 1) của đánh giá" />
                                    @if (isLast && extra > 0)
                                    {
                                        <div class="rv-g-more" aria-label="Còn @extra ảnh">+@extra</div>
                                    }
                                </button>
                            }
                        </div>
                    }

                    @if (hasReply)
                    {
                        <section class="rv-reply" aria-label="Phản hồi từ Người bán">
                            <div class="rv-reply-header">
                                <svg class="rv-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/></svg>
                                <span class="rv-reply-label">Phản hồi từ Người bán</span>
                            </div>
                            <div class="rv-reply-body">@r!.Reply</div>
                        </section>
                    }

                    <!-- Actions -->
                    <div class="rv-actions">
                        @{
                            var _hasReply = !string.IsNullOrWhiteSpace(r?.Reply);
                            var reviewPayload = new
                            {
                                ReviewId = r.ReviewId,
                                ServiceTitle = r.ServiceTitle,
                                ServiceThumbnailUrl = serviceThumb,
                                Rating = r.Rating,
                                Comment = r.Comment ?? "",
                                ReviewImageUrls = r.ReviewImageUrls ?? new List<string>(),
                                CreatedAt = r.CreatedAt?.ToString("o"),
                                Reply = r.Reply
                            };
                        }

                        <button type="button"
                                class="rv-btn edit-btn"
                                data-rv-modal="editReviewModal"
                                data-review-id="@r!.ReviewId"
                                data-review='@Html.Raw(JsonSerializer.Serialize(reviewPayload, jsonOptions))'
                                @(canEdit ? null : "disabled aria-disabled=\"true\"")
                                title="@(canEdit ? "Sửa đánh giá" : "Đã có phản hồi hoặc đã sửa 1 lần")"
                                aria-label="@(canEdit ? "Sửa đánh giá" : "Đã có phản hồi hoặc đã sửa 1 lần")">
                            <svg class="rv-icon" width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg> <span class="rv-btn-text">Sửa</span>
                        </button>
                        <form asp-area="Customer"
                              asp-controller="ReviewCustomer"
                              asp-action="Delete"
                              asp-route-reviewId="@r!.ReviewId"
                              method="post"
                              class="rv-inline-form">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="rv-btn delete"
                                    @(canDelete ? null : "disabled aria-disabled=\"true\"")
                                    title="@(canDelete ? "Xoá đánh giá" : "Đánh giá đã có phản hồi, không thể xoá")"
                                    aria-label="@(canDelete ? "Xoá đánh giá" : "Đánh giá đã có phản hồi, không thể xoá")"
                                    onclick="return confirm('Xóa đánh giá này?');">
                                <svg class="rv-icon" width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg> <span class="rv-btn-text">Xóa</span>
                            </button>
                        </form>
                    </div>
                </article>
            </div>
        }
    }
    else
    {
        <div class="rv-empty" role="status">
            <div class="rv-empty-icon">📝</div>
            <p class="rv-empty-text">Chưa có đánh giá nào. Hãy mua sản phẩm và chia sẻ trải nghiệm của bạn!</p>
        </div>
    }
</div>

<!-- Shared Modal Sửa Đánh Giá -->
<div class="rv-modal-overlay" id="editReviewModal" aria-hidden="true">
    <div class="rv-modal-dialog rv-modal-lg">
        <div class="rv-modal-content">
            <div class="rv-modal-header">
                <h5 class="rv-modal-title">Sửa đánh giá</h5>
                <button type="button" class="rv-btn-close" onclick="rvCloseEditModal()" aria-label="Đóng">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
                </button>
            </div>

            <form asp-area="Customer" asp-controller="ReviewCustomer" asp-action="Edit" method="post" enctype="multipart/form-data" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="ReviewId" value="" />

                <div class="rv-modal-body">
                    <div class="rv-edit-head">
                        <img class="service-thumb" src="@fallbackImg" onerror="this.src='@fallbackImg'" alt="Ảnh dịch vụ" />
                        <div>
                            <div class="rv-service-title-text service-title"></div>
                            <div class="rv-service-created-text service-created"></div>
                        </div>
                    </div>

                    <div class="rv-form-group">
                        <label class="rv-form-label">Điểm đánh giá (1–5)</label>
                        <input id="rv-edit-rating" type="hidden" name="Rating" value="1" required />
                        <div class="rv-stars-input" role="radiogroup" aria-label="Chọn số sao (1 đến 5)">
                            <button type="button" class="rv-star" role="radio" aria-checked="false" data-val="1" aria-label="1 sao">★</button>
                            <button type="button" class="rv-star" role="radio" aria-checked="false" data-val="2" aria-label="2 sao">★</button>
                            <button type="button" class="rv-star" role="radio" aria-checked="false" data-val="3" aria-label="3 sao">★</button>
                            <button type="button" class="rv-star" role="radio" aria-checked="false" data-val="4" aria-label="4 sao">★</button>
                            <button type="button" class="rv-star" role="radio" aria-checked="false" data-val="5" aria-label="5 sao">★</button>
                        </div>
                        <div class="rv-form-text">Nhấn vào sao hoặc dùng phím mũi tên để chọn.</div>
                    </div>

                    <div class="rv-form-group">
                        <label class="rv-form-label" for="rv-edit-comment">Nội dung</label>
                        <textarea id="rv-edit-comment" class="rv-form-control" name="Comment" maxlength="2000" rows="4" placeholder="Chia sẻ trải nghiệm của bạn" style="resize: vertical; min-height: 100px;"></textarea>
                    </div>

                    <div class="rv-form-group">
                        <label class="rv-form-label">Ảnh đính kèm (tối đa 5)</label>
                        <div id="imageSlots" class="rv-slot-grid"></div>
                        <div class="rv-form-text">Nhấn dấu <strong>×</strong> để xoá ảnh; nhấn <strong>+ Thêm ảnh</strong> để chọn ảnh mới.</div>
                    </div>

                    <div asp-validation-summary="All" class="rv-text-danger"></div>
                </div>

                <div class="rv-modal-footer">
                    <button type="button" class="rv-btn rv-btn-secondary" onclick="rvCloseEditModal()">Hủy</button>
                    <button type="submit" class="rv-btn rv-btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Viewer ảnh -->
<div id="rvModal" class="rv-modal" role="dialog" aria-modal="true" aria-label="Xem ảnh đánh giá" hidden>
    <div class="rv-modal-content-wrapper">
        <div class="rv-image-container">
            <button class="rv-close" type="button" aria-label="Đóng" onclick="rvClose()">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
            </button>
            <img id="rvModalImg" src="/placeholder.svg" alt="Ảnh đánh giá phóng to" />
        </div>
        <button class="rv-prev" type="button" onclick="rvPrev()" aria-label="Ảnh trước">
            <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
        </button>
        <button class="rv-next" type="button" onclick="rvNext()" aria-label="Ảnh tiếp theo">
            <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        </button>
    </div>
</div>


@section Scripts {
    <script>
        function paintStars(modalEl, value){
          const stars = modalEl.querySelectorAll('.rv-stars-input .rv-star');
          const val = Math.max(1, Math.min(5, parseInt(value || '1', 10)));
          stars.forEach((b, idx) => {
            const on = idx < val;
            b.classList.toggle('is-on', on);
            b.setAttribute('aria-checked', (idx === val - 1) ? 'true' : 'false');
            b.tabIndex = (idx === val - 1) ? 0 : -1;
          });
        }

        function initStarInput(modalEl){
          const hidden = modalEl.querySelector('#rv-edit-rating');
          const group  = modalEl.querySelector('.rv-stars-input');
          if(!hidden || !group) return;

          const old = group.querySelectorAll('.rv-star');
          old.forEach(s=>{
            const clone = s.cloneNode(true);
            s.replaceWith(clone);
          });

          const stars = group.querySelectorAll('.rv-star');

          stars.forEach(btn => {
            btn.addEventListener('click', () => {
              hidden.value = btn.dataset.val;
              paintStars(modalEl, hidden.value);
            });

            btn.addEventListener('mouseenter', () => paintStars(modalEl, btn.dataset.val));
            btn.addEventListener('mouseleave', () => paintStars(modalEl, hidden.value));

            btn.addEventListener('keydown', (e) => {
              if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
                e.preventDefault();
                hidden.value = Math.min(5, parseInt(hidden.value || '1', 10) + 1);
                paintStars(modalEl, hidden.value);
                const target = group.querySelector(`.rv-star[data-val="${hidden.value}"]`);
                target && target.focus();
              } else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
                e.preventDefault();
                hidden.value = Math.max(1, parseInt(hidden.value || '1', 10) - 1);
                paintStars(modalEl, hidden.value);
                const target = group.querySelector(`.rv-star[data-val="${hidden.value}"]`);
                target && target.focus();
              } else if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                paintStars(modalEl, hidden.value);
              }
            });
          });

          paintStars(modalEl, hidden.value);
        }

        function buildImageSlots(modalEl, data){
          const container = modalEl.querySelector('#imageSlots');
          if(!container) return;

          container.innerHTML = '';
          const existing = Array.isArray(data?.ReviewImageUrls) ? data.ReviewImageUrls.filter(Boolean) : [];
          const current = existing.slice(0, 5);

          const createExistingSlot = (url) => {
            const slot = document.createElement('div');
            slot.className = 'rv-slot';

            const hiddenExist = document.createElement('input');
            hiddenExist.type = 'hidden';
            hiddenExist.name = 'ExistingImages'; // chỉ để client logic, backend không dùng
            hiddenExist.value = url;

            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Ảnh hiện có';
            img.onerror = () => { img.src = '@fallbackImg'; };

            const x = document.createElement('button');
            x.type = 'button';
            x.className = 'rv-xbtn';
            x.setAttribute('aria-label', 'Xoá ảnh này');
            x.textContent = '×';

            x.addEventListener('click', () => {
              const rm = document.createElement('input');
              rm.type = 'hidden';
              rm.name = 'RemoveImages';   // backend bind vào List<string> RemoveImages
              rm.value = url;
              modalEl.querySelector('form').appendChild(rm);
              slot.remove();
              fillAddSlots(container, modalEl);
            });

            slot.appendChild(hiddenExist);
            slot.appendChild(img);
            slot.appendChild(x);
            return slot;
          };

          const createAddSlotForHelper = (modalEl) => {
            const slot = document.createElement('div');
            slot.className = 'rv-slot rv-slot-add';
            const input = document.createElement('input');
            input.type = 'file';
            input.name = 'NewImages'; // backend bind List<IFormFile> NewImages
            input.accept = 'image/*';
            input.style.display = 'none';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'rv-addbtn';
            btn.innerHTML = '<span class="plus">＋</span><span>Thêm ảnh</span>';
            btn.addEventListener('click', () => input.click());
            input.addEventListener('change', () => {
              if (!input.files || !input.files[0]) return;
              const file = input.files[0];
              const reader = new FileReader();
              reader.onload = e => {
                slot.classList.remove('rv-slot-add');
                slot.innerHTML = '';
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Ảnh mới';
                const x = document.createElement('button');
                x.type = 'button';
                x.className = 'rv-xbtn';
                x.setAttribute('aria-label', 'Bỏ ảnh này');
                x.textContent = '×';
                x.addEventListener('click', () => {
                  slot.remove();
                  fillAddSlots(container, modalEl);
                });
                slot.appendChild(input);
                slot.appendChild(img);
                slot.appendChild(x);
                fillAddSlots(container, modalEl);
              };
              reader.readAsDataURL(file);
            });
            slot.appendChild(input);
            slot.appendChild(btn);
            return slot;
          };

          current.forEach(url => container.appendChild(createExistingSlot(url)));
          fillAddSlots(container, modalEl);

          if (window.__serverOpenDto && Array.isArray(window.__serverOpenDto.RemoveImages)) {
            const toRemove = new Set(window.__serverOpenDto.RemoveImages);
            container.querySelectorAll('input[name="ExistingImages"]').forEach(h => {
              if (toRemove.has(h.value)) {
                h.parentElement.querySelector('.rv-xbtn')?.click();
              }
            });
          }

          function fillAddSlots(container, modalEl){
            const max = 5;
            const currentCount = container.querySelectorAll('.rv-slot').length;
            for (let i = currentCount; i < max; i++){
              container.appendChild(createAddSlotForHelper(modalEl));
            }
          }
        }

        function populateEditModalWithData(data) {
          if (!data) return;
          const modalEl = document.getElementById('editReviewModal');
          if (!modalEl) return;

          const reviewIdInput   = modalEl.querySelector('input[name="ReviewId"]');
          const ratingInput     = modalEl.querySelector('input[name="Rating"]');
          const commentTextarea = modalEl.querySelector('textarea[name="Comment"]');
          const serviceTitleEl  = modalEl.querySelector('.service-title');
          const serviceThumbEl  = modalEl.querySelector('.service-thumb');
          const serviceCreatedEl= modalEl.querySelector('.service-created');

          if (reviewIdInput)   reviewIdInput.value = data.ReviewId ?? '';
          if (ratingInput)     ratingInput.value = (data.Rating != null) ? data.Rating : 1;
          if (commentTextarea) commentTextarea.value = data.Comment ?? '';
          if (serviceTitleEl)  serviceTitleEl.textContent = data.ServiceTitle ?? '';
          if (serviceThumbEl)  serviceThumbEl.src = data.ServiceThumbnailUrl || '@fallbackImg';
          if (serviceCreatedEl) {
            serviceCreatedEl.textContent = data.CreatedAt
              ? ('Đã đánh giá lúc ' + (new Date(data.CreatedAt)).toLocaleString('vi-VN'))
              : '';
          }

          initStarInput(modalEl);
          paintStars(modalEl, ratingInput?.value || 1);

          buildImageSlots(modalEl, data);
        }

        function hasVendorReply(data){
          return !!(data && data.Reply && String(data.Reply).trim().length > 0);
        }

        document.addEventListener('DOMContentLoaded', function () {
          const modalEl = document.getElementById('editReviewModal');

          // Modal event handlers - không dùng Bootstrap
          document.querySelectorAll('[data-rv-modal="editReviewModal"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
              if (this.disabled || this.getAttribute('aria-disabled') === 'true') return;
              
              let data = null;
              if (this.dataset?.review) {
                try { data = JSON.parse(this.dataset.review); } catch { data = null; }
              }
              if (window.__serverOpenDto) { data = Object.assign({}, data || {}, window.__serverOpenDto); }

              if (hasVendorReply(data)) {
                return;
              }

              populateEditModalWithData(data);
              rvOpenEditModal();
            });
          });

          // giá trị do server bơm vào khi cần auto open modal sau lỗi
          const openId = '@(openId ?? "")';
          window.__serverOpenDto = @Html.Raw(openDto == null ? "null" : JsonSerializer.Serialize(openDto, openDto.GetType(), jsonOptions));

          if (openId) {
            const triggerBtn = document.querySelector('[data-review-id="'+ openId +'"]');
            let data = null;
            if (triggerBtn?.dataset?.review) {
              try { data = JSON.parse(triggerBtn.dataset.review); } catch { data = null; }
            }
            if (window.__serverOpenDto) data = Object.assign({}, data || {}, window.__serverOpenDto);

            if (!hasVendorReply(data)) {
              populateEditModalWithData(data);
              rvOpenEditModal();
            }
          }
        });

        let rvCurrent = 0, rvList = [];
        const rvModal = () => document.getElementById('rvModal');
        const rvImg   = () => document.getElementById('rvModalImg');

        function rvOpenFromThumb(btn) {
          const wrap = btn.closest('.rv-gallery');
          if (!wrap) return;
          try { rvList = JSON.parse(wrap.getAttribute('data-gallery')) || []; } catch { rvList = []; }
          const idx = parseInt(btn.getAttribute('data-index') || '0', 10);
          rvOpen(idx);
        }
        function rvOpen(index) {
          if (!Array.isArray(rvList) || rvList.length === 0) return;
          rvCurrent = Math.max(0, Math.min(index, rvList.length - 1));
          rvImg().src = rvList[rvCurrent] || '/placeholder.svg';
          rvModal().hidden = false;
          document.body.classList.add('rv-no-scroll');
          document.addEventListener('keydown', onKey);
          
          // Ẩn/hiện nút điều hướng dựa trên số lượng ảnh
          const prevBtn = document.querySelector('.rv-prev');
          const nextBtn = document.querySelector('.rv-next');
          if (rvList.length <= 1) {
            if (prevBtn) prevBtn.classList.add('hidden');
            if (nextBtn) nextBtn.classList.add('hidden');
          } else {
            if (prevBtn) prevBtn.classList.remove('hidden');
            if (nextBtn) nextBtn.classList.remove('hidden');
          }
        }
        
        // Đóng modal khi click vào overlay (ngoài ảnh)
        const modalEl = document.getElementById('rvModal');
        if (modalEl) {
          modalEl.addEventListener('click', function(e) {
            // Đóng nếu click vào modal overlay hoặc wrapper (nhưng không phải vào ảnh hoặc buttons)
            const clickedEl = e.target;
            const isImage = clickedEl.id === 'rvModalImg' || clickedEl.tagName === 'IMG';
            const isButton = clickedEl.classList.contains('rv-close') || 
                           clickedEl.classList.contains('rv-prev') || 
                           clickedEl.classList.contains('rv-next') ||
                           clickedEl.closest('.rv-close') ||
                           clickedEl.closest('.rv-prev') ||
                           clickedEl.closest('.rv-next');
            
            if (!isImage && !isButton) {
              rvClose();
            }
          });
        }
        function rvClose() {
          rvModal().hidden = true;
          document.body.classList.remove('rv-no-scroll');
          document.removeEventListener('keydown', onKey);
        }
        function rvPrev() { rvOpen((rvCurrent - 1 + rvList.length) % rvList.length); }
        function rvNext() { rvOpen((rvCurrent + 1) % rvList.length); }
        function onKey(e){
          if (rvModal().hidden) return;
          if (e.key === 'Escape') rvClose();
          else if (e.key === 'ArrowLeft') rvPrev();
          else if (e.key === 'ArrowRight') rvNext();
        }
        // Edit Modal Functions
        function rvOpenEditModal() {
          const modal = document.getElementById('editReviewModal');
          if (modal) {
            modal.setAttribute('aria-hidden', 'false');
            modal.classList.add('rv-modal-active');
            document.body.classList.add('rv-no-scroll');
          }
        }

        function rvCloseEditModal() {
          const modal = document.getElementById('editReviewModal');
          if (modal) {
            modal.setAttribute('aria-hidden', 'true');
            modal.classList.remove('rv-modal-active');
            document.body.classList.remove('rv-no-scroll');
          }
        }

        // Close modal khi click vào overlay
        document.addEventListener('click', function(e) {
          const modal = document.getElementById('editReviewModal');
          if (modal && e.target === modal) {
            rvCloseEditModal();
          }
        });

        // Close modal với ESC key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const modal = document.getElementById('editReviewModal');
            if (modal && modal.classList.contains('rv-modal-active')) {
              rvCloseEditModal();
            }
          }
        });

        window.rvOpenFromThumb = rvOpenFromThumb;
        window.rvClose = rvClose;
        window.rvPrev  = rvPrev;
        window.rvNext  = rvNext;
        window.rvOpenEditModal = rvOpenEditModal;
        window.rvCloseEditModal = rvCloseEditModal;
    </script>
}

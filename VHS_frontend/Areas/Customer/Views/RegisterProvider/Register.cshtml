@{
    ViewData["Title"] = "Đăng ký Provider";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = (IEnumerable<dynamic>)ViewBag.Categories;

    // ✅ Helper: Check status Rejected (cả tiếng Anh & Việt)
    bool IsRejectedStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return false;
        var s = status.ToLower();
        return s == "rejected" || s == "đã từ chối" || s == "bị từ chối";
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/register-provider.css" asp-append-version="true" />
}

<main class="rp">
    <div class="rp__container">
        <header class="rp__header">
            <h1>Đăng ký nhà cung cấp</h1>
            <p>Điền thông tin để bắt đầu hợp tác cùng chúng tôi</p>
        </header>

        @if (ViewBag.ExistingStatus is string existingStatus && IsRejectedStatus(existingStatus))
        {
            <div class="alert alert-danger" role="alert" style="max-width:1120px;margin:0 auto 16px; background-color: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="color: #ef4444; flex-shrink: 0;">
                        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div>
                        <strong style="color: #991b1b; font-size: 16px; display: block; margin-bottom: 4px;">Hồ sơ đã bị từ chối</strong>
                        <p style="color: #7f1d1d; margin: 0; font-size: 14px;">
                            Hồ sơ của bạn đã bị từ chối bởi admin. Vui lòng gửi lại toàn bộ thông tin với ảnh đại diện và giấy phép kinh doanh mới.
                        </p>
                    </div>
                </div>
            </div>
        }

        @* Banner lỗi tổng đã được loại bỏ trong flow mới (AJAX JSON), giữ lại khung để có thể tái dùng nếu cần) *@

        <form id="providerForm" method="post"
              asp-area="Customer" asp-controller="RegisterProvider" asp-action="RegisterFallback"
              enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" id="IsResubmit" value="@(IsRejectedStatus(ViewBag.ExistingStatus as string) ? "true" : "false")" />

            @* @if (ViewBag.ExistingProviderId != null) *@
            @* { *@
            @*     <input type="hidden" name="ProviderId" value="@ViewBag.ExistingProviderId" /> *@
            @* } *@

            <!-- THÔNG TIN -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-person"></i></span>
                    <div>
                        <h2>1. Thông tin nhà cung cấp</h2>
                        <p>Vui lòng cung cấp thông tin chi tiết về dịch vụ của bạn</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Avatar -->
                    <div class="field">
                        <label for="ProfileImage">Ảnh đại diện <span class="req">*</span></label>
                        <button type="button" id="avatarPlaceholder" class="avatar-tile" aria-label="Chọn ảnh từ tệp">
                            <div class="tile-icon">📷</div>
                            <div class="tile-text">Chọn từ tệp</div>
                        </button>

                        <div id="avatarPreviewWrap" class="avatar-wrap d-none">
                            <div class="avatar-img-wrap">
                                <img id="imgPreview" class="avatar-img" alt="Ảnh đại diện" src="~/images/placeholder-avatar.png" />
                                <button type="button" id="avatarOverlay" class="avatar-overlay" title="Xóa ảnh"><span class="overlay-x">×</span></button>
                            </div>

                            <div class="file-row">
                                <input type="file" id="ProfileImage" name="ProfileImage" accept="image/*" class="file-input" />
                                <div class="file-actions">
                                    <span id="fileName" class="file-name">Chưa chọn tệp</span>
                                    <label for="ProfileImage" class="btn ghost">Chọn tệp khác</label>
                                </div>
                            </div>
                        </div>
                        <div class="field-error text-danger small d-none mt-1" id="avatarError">Vui lòng chọn ảnh đại diện.</div>
                    </div>

                    <div class="field">
                        <label for="ProviderName">Tên nhà cung cấp <span class="req">*</span></label>
                        <input id="ProviderName" name="ProviderName" class="input" maxlength="100"
                               placeholder="VD: Dịch vụ vệ sinh chuyên nghiệp Minh Anh" required />
                        <div class="field-error text-danger small d-none mt-1" id="nameError">Vui lòng nhập tên Provider.</div>
                    </div>

                    <div class="field">
                        <label for="PhoneNumber">Số điện thoại</label>
                        <input id="PhoneNumber" name="PhoneNumber" class="input" inputmode="tel" maxlength="20"
                               placeholder="0912 345 678" />
                        <div class="field-error text-danger small d-none mt-1" id="phoneError"></div>
                    </div>

                    <div class="field">
                        <label for="Description">Mô tả dịch vụ <span class="req">*</span></label>
                        <p class="field-hint" style="margin-bottom: 8px; color: #64748b; font-size: 14px;">
                            Vui lòng mô tả chi tiết về dịch vụ của bạn, bao gồm:
                        </p>
                        <ul style="margin: 0 0 12px 20px; padding: 0; color: #64748b; font-size: 14px; line-height: 1.8;">
                            <li><strong>Kinh nghiệm:</strong> Số năm kinh nghiệm, lĩnh vực chuyên môn</li>
                            <li><strong>Phạm vi phục vụ:</strong> Khu vực địa lý, loại công trình (nhà ở, văn phòng, căn hộ...)</li>
                            <li><strong>Điểm mạnh:</strong> Ưu điểm nổi bật, cam kết chất lượng, thiết bị hiện đại...</li>
                            <li><strong>Quy trình làm việc:</strong> Các bước thực hiện dịch vụ (nếu có)</li>
                        </ul>
                        <textarea id="Description" name="Description" class="input autosize" rows="5"
                                  placeholder="Ví dụ: Chúng tôi có hơn 5 năm kinh nghiệm trong lĩnh vực vệ sinh chuyên nghiệp. Sử dụng hóa chất an toàn, thiết bị hiện đại. Cam kết chất lượng 100%, có bảo hành sau dịch vụ. Quy trình: Khảo sát → Báo giá → Thực hiện → Nghiệm thu → Bảo hành." required></textarea>
                        <div class="field-error text-danger small d-none mt-1" id="descError">Vui lòng nhập mô tả dịch vụ.</div>
                    </div>
                </div>
            </section>

            <!-- CHỨNG CHỈ & DANH MỤC -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-file-earmark-text"></i></span>
                    <div>
                        <h2>2. Giấy phép kinh doanh &amp; Danh mục</h2>
                        <p>Chọn danh mục dịch vụ và tải lên giấy phép kinh doanh</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Danh mục dịch vụ -->
                    <div class="field">
                        <label>Danh mục dịch vụ <span class="req">*</span></label>
                        <p class="field-hint">Chọn một hoặc nhiều danh mục dịch vụ của bạn</p>

                        <div class="category-grid">
                            @foreach (var c in categories)
                            {
                                <div class="category-card" data-category-id="@c.Id">
                                    <input type="checkbox"
                                           name="SelectedCategories"
                                           id="cat_@c.Id"
                                           value="@c.Id"
                                           class="category-checkbox"
                                           data-category-name="@c.Name" />
                                    <label for="cat_@c.Id" class="category-label">
                                        <div class="category-icon">
                                            @{
                                                var iconClass = "bi-tools"; // default
                                                var categoryName = c.Name.ToLower();
                                                if (categoryName.Contains("điện")) iconClass = "bi-lightning-charge";
                                                else if (categoryName.Contains("nước")) iconClass = "bi-droplet";
                                                else if (categoryName.Contains("điều hòa") || categoryName.Contains("lạnh")) iconClass = "bi-snow";
                                                else if (categoryName.Contains("sơn")) iconClass = "bi-paint-bucket";
                                                else if (categoryName.Contains("vệ sinh")) iconClass = "bi-brush";
                                                else if (categoryName.Contains("sửa chữa")) iconClass = "bi-wrench";
                                                else if (categoryName.Contains("nội trợ")) iconClass = "bi-house-heart";
                                                else if (categoryName.Contains("sự kiện")) iconClass = "bi-calendar-event";
                                            }
                                            <i class="bi @iconClass"></i>
                                        </div>
                                        <span class="category-name">@c.Name</span>
                                        <i class="bi bi-check-circle category-check-icon"></i>
                                    </label>

                                    <!-- Tags cho category này (sẽ load từ API) -->
                                    <div class="category-tags" data-category="@c.Id">
                                        <p class="tags-label">Chọn các dịch vụ cụ thể:</p>
                                        <div class="tags-grid" data-tags-container="@c.Id">
                                            <div class="tags-loading">
                                                <i class="bi bi-arrow-clockwise spin"></i> Đang tải...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="field-error text-danger small d-none" id="categoryError">Vui lòng chọn ít nhất 1 danh mục dịch vụ.</div>
                    </div>

                    <!-- Giấy phép kinh doanh -->
                    <div class="field">
                        <label for="BusinessLicenses">Hình ảnh giấy phép kinh doanh <span class="req">*</span> (có thể chọn nhiều)</label>
                        <input id="BusinessLicenses"
                               type="file"
                               name="BusinessLicenses"
                               class="file-input"
                               accept="image/*"
                               multiple
                               required />
                        <div class="file-actions">
                            <span class="file-name" id="licenseFileName">Chưa chọn tệp</span>
                            <label for="BusinessLicenses" class="btn ghost">Chọn ảnh</label>
                        </div>
                        <div class="img-grid" id="licensePreviews" aria-live="polite"></div>
                        <div class="field-error text-danger small d-none" id="licenseError">Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh.</div>
                    </div>
                </div>
            </section>

            <!-- ĐIỀU KHOẢN & BẢO HIỂM -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-shield-check"></i></span>
                    <div>
                        <h2>3. Điều khoản &amp; Bảo hiểm</h2>
                        <p>Vui lòng đọc và đồng ý với các điều khoản dịch vụ và chính sách bảo hiểm của chúng tôi.</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Hidden inputs for backend compatibility -->
                    <input type="hidden" id="TI_Title" name="TermsInsurance.Title" value="Điều khoản & Bảo hiểm áp dụng cho Provider" />
                    <textarea type="hidden" id="TI_Description" name="TermsInsurance.Description" style="display: none;">
=== CHÍNH SÁCH VÀ ĐIỀU KHOẢN CHUNG ===

1. Giới thiệu
Chào mừng bạn đến với VHS Platform. Khi đăng ký trở thành Provider, bạn đồng ý tuân thủ các điều khoản và điều kiện được nêu dưới đây.

2. Quyền và Nghĩa vụ của Provider
- Cung cấp dịch vụ đúng thời gian, chất lượng đã cam kết với khách hàng
- Đảm bảo tuân thủ các quy định an toàn lao động và vệ sinh môi trường
- Sử dụng thiết bị, dụng cụ đạt tiêu chuẩn chất lượng
- Giữ bí mật thông tin cá nhân của khách hàng
- Không được từ chối dịch vụ một cách vô lý hoặc phân biệt đối xử

3. Hoa hồng và Thanh toán
- Thanh toán được xử lý vào mỗi thứ 6 hàng tuần
- Provider cần cung cấp thông tin tài khoản ngân hàng chính xác để nhận thanh toán

4. Chính sách Hủy và Hoàn tiền
- Sau 30 phút, hệ thống sẽ tự động hủy nếu nhà cung cấp chưa xác nhận và khách hàng chưa thanh toán
- Nếu khách hàng không thanh toán, đơn hàng sẽ tự động bị hủy
- Khách hàng được hoàn tiền 100% nếu báo cáo được xác nhận là đúng

5. Chấm dứt Tài khoản
VHS Platform có quyền tạm ngưng hoặc chấm dứt tài khoản Provider nếu vi phạm điều khoản, nhận nhiều đánh giá xấu, hoặc có hành vi gian lận.

6. Thay đổi Điều khoản
VHS Platform có quyền thay đổi điều khoản này. Các thay đổi sẽ được thông báo trước ít nhất 7 ngày.

=== CHÍNH SÁCH BẢO HIỂM ===

1. Bảo hiểm Trách nhiệm
Provider phải có bảo hiểm trách nhiệm dân sự để bảo vệ khách hàng và chính mình trong trường hợp xảy ra sự cố:
- Thiệt hại về tài sản của khách hàng trong quá trình thực hiện dịch vụ
- Thương tích hoặc tai nạn xảy ra với khách hàng do lỗi của Provider
- Chi phí pháp lý liên quan đến các khiếu nại từ khách hàng

2. Mức Bảo hiểm Tối thiểu
Provider cần duy trì bảo hiểm trách nhiệm với mức tối thiểu:
- Thiệt hại tài sản: Tối thiểu 50.000.000 VNĐ/sự cố
- Thương tích cá nhân: Tối thiểu 100.000.000 VNĐ/sự cố
- Chi phí pháp lý: Tối thiểu 20.000.000 VNĐ/vụ việc

3. Chứng nhận Bảo hiểm
- Provider phải cung cấp bản sao hợp đồng bảo hiểm còn hiệu lực
- Bảo hiểm phải được gia hạn trước khi hết hạn
- VHS Platform có quyền yêu cầu xem bảo hiểm bất kỳ lúc nào

4. Trách nhiệm khi Không có Bảo hiểm
- Nếu không duy trì bảo hiểm, Provider chịu hoàn toàn trách nhiệm về mọi thiệt hại
- VHS Platform có quyền tạm ngưng tài khoản cho đến khi Provider cung cấp bảo hiểm hợp lệ

5. Xử lý Khiếu nại
Khi có sự cố:
- Báo cáo ngay cho VHS Platform và công ty bảo hiểm trong vòng 24 giờ
- Cung cấp đầy đủ thông tin và chứng cứ liên quan
- Hợp tác với quá trình điều tra và giải quyết

Tôi xác nhận đã đọc, hiểu rõ và đồng ý với toàn bộ nội dung Chính sách và Điều khoản chung cũng như Chính sách Bảo hiểm của VHS Platform.
Ngày đồng ý: {{AGREEMENT_DATE}}
                            </textarea>

                    <!-- Điều khoản dịch vụ - Collapsible -->
                    <div class="terms-collapsible">
                        <div class="terms-collapsible-header" data-toggle="collapse" data-target="#termsContent">
                            <div class="terms-collapsible-title">
                                <i class="bi bi-file-text" style="color: #0ea5e9; font-size: 24px; margin-right: 12px;"></i>
                                <div>
                                    <h3 style="margin: 0; color: #0ea5e9; font-size: 18px; font-weight: 600;">Chính sách và Điều khoản chung</h3>
                                    <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">Quy định về quyền và nghĩa vụ khi cung cấp dịch vụ</p>
                                </div>
                            </div>
                            <i class="bi bi-chevron-down terms-collapsible-icon"></i>
                        </div>
                        <div class="terms-collapsible-content" id="termsContent">
                            <h6 style="color: #0ea5e9; margin-top: 0; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                1. Giới thiệu
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7;">Chào mừng bạn đến với <strong>VHS Platform</strong> - nền tảng kết nối dịch vụ tại nhà hàng đầu. Khi đăng ký trở thành nhà cung cấp dịch vụ (Provider), bạn đồng ý tuân thủ các điều khoản và điều kiện được quy định trong tài liệu này. Việc đăng ký và sử dụng dịch vụ của chúng tôi đồng nghĩa với việc bạn đã đọc, hiểu và chấp nhận toàn bộ nội dung.</p>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                2. Quyền và Nghĩa vụ của Provider
                            </h6>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li><strong>Cung cấp dịch vụ chất lượng:</strong> Provider cam kết cung cấp dịch vụ đúng với mô tả, đảm bảo chất lượng và hoàn thành đúng thời gian đã cam kết với khách hàng.</li>
                                <li><strong>Trách nhiệm về thiết bị và nhân viên:</strong> Provider chịu trách nhiệm hoàn toàn về chất lượng dịch vụ, thiết bị, dụng cụ và nhân viên thực hiện dịch vụ. Đảm bảo tất cả đều đạt tiêu chuẩn an toàn và chất lượng.</li>
                                <li><strong>Giấy phép và chứng chỉ:</strong> Provider phải có đầy đủ giấy phép kinh doanh hợp lệ, chứng chỉ hành nghề và các giấy tờ pháp lý cần thiết theo quy định của pháp luật.</li>
                                <li><strong>Bảo mật thông tin:</strong> Provider cam kết bảo mật tuyệt đối thông tin khách hàng, không tiết lộ, chia sẻ hoặc sử dụng thông tin cho bất kỳ mục đích nào khác ngoài việc cung cấp dịch vụ.</li>
                                <li><strong>Giao tiếp chuyên nghiệp:</strong> Provider phải giao tiếp với khách hàng một cách lịch sự, chuyên nghiệp và tôn trọng. Không được có hành vi phân biệt đối xử hoặc từ chối dịch vụ một cách vô lý.</li>
                            </ul>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                3. Chính sách Hủy và Hoàn tiền
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;"><strong>Quy định hủy dịch vụ:</strong></p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li>Sau 30 phút, hệ thống sẽ tự động hủy nếu nhà cung cấp chưa xác nhận và khách hàng chưa thanh toán</li>
                                <li>Nếu khách hàng không thanh toán, đơn hàng sẽ tự động bị hủy</li>
                                <li>Khách hàng được hoàn tiền 100% nếu báo cáo được xác nhận là đúng</li>
                            </ul>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                4. Phí dịch vụ và Thanh toán
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;"><strong>Cơ chế hoa hồng:</strong></p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li>Thanh toán được xử lý <strong>hàng tuần vào mỗi thứ 6</strong> cho tất cả các đơn hàng đã hoàn thành trong tuần trước đó.</li>
                                <li>Provider cần cung cấp thông tin tài khoản ngân hàng chính xác để nhận thanh toán. Mọi thay đổi thông tin tài khoản cần được thông báo trước ít nhất 3 ngày làm việc.</li>
                                <li>Phí giao dịch ngân hàng (nếu có) sẽ được trừ vào số tiền thanh toán.</li>
                            </ul>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                5. Chấm dứt Hợp tác
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;">VHS Platform có quyền tạm ngưng hoặc chấm dứt tài khoản Provider trong các trường hợp sau:</p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li>Vi phạm nghiêm trọng các điều khoản và quy định của platform.</li>
                                <li>Nhận nhiều đánh giá xấu (dưới 3 sao) hoặc khiếu nại từ khách hàng trong thời gian ngắn.</li>
                                <li>Có hành vi gian lận, lừa đảo hoặc cung cấp thông tin sai lệch.</li>
                                <li>Không duy trì giấy phép kinh doanh hoặc bảo hiểm hợp lệ.</li>
                                <li>Không phản hồi hoặc giải quyết khiếu nại của khách hàng một cách tích cực.</li>
                            </ul>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                6. Thay đổi Điều khoản
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7;">VHS Platform có quyền cập nhật, sửa đổi hoặc bổ sung các điều khoản này khi cần thiết. Tất cả các thay đổi sẽ được thông báo trước <strong>ít nhất 7 ngày</strong> thông qua email, thông báo trên platform hoặc các kênh liên lạc chính thức. Việc tiếp tục sử dụng dịch vụ sau khi thay đổi có hiệu lực được xem như bạn đã đồng ý với các điều khoản mới.</p>
                        </div>
                    </div>

                    <!-- Chính sách bảo hiểm - Collapsible -->
                    <div class="terms-collapsible" style="margin-top: 20px;">
                        <div class="terms-collapsible-header" data-toggle="collapse" data-target="#insuranceContent">
                            <div class="terms-collapsible-title">
                                <i class="bi bi-shield-check" style="color: #0ea5e9; font-size: 24px; margin-right: 12px;"></i>
                                <div>
                                    <h3 style="margin: 0; color: #0ea5e9; font-size: 18px; font-weight: 600;">Chính sách Bảo hiểm và Đảm bảo Chất lượng</h3>
                                    <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">Quy định về bảo hiểm trách nhiệm và cam kết chất lượng dịch vụ</p>
                                </div>
                            </div>
                            <i class="bi bi-chevron-down terms-collapsible-icon"></i>
                        </div>
                        <div class="terms-collapsible-content" id="insuranceContent">
                            <h6 style="color: #0ea5e9; margin-top: 0; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                1. Bảo hiểm Trách nhiệm Dân sự
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;"><strong>Tại sao cần bảo hiểm:</strong></p>
                            <p style="margin-left: 12px; line-height: 1.7;">Provider <strong>bắt buộc</strong> phải có bảo hiểm trách nhiệm dân sự hợp lệ để bảo vệ quyền lợi của khách hàng và chính Provider trong trường hợp xảy ra sự cố không mong muốn. Bảo hiểm này giúp:</p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li>Bảo vệ khách hàng khỏi thiệt hại về tài sản trong quá trình thực hiện dịch vụ (ví dụ: làm hỏng đồ đạc, thiết bị của khách hàng).</li>
                                <li>Bảo vệ khách hàng khỏi thương tích hoặc tai nạn xảy ra do lỗi của Provider hoặc nhân viên trong quá trình cung cấp dịch vụ.</li>
                                <li>Chi trả chi phí pháp lý và các khoản bồi thường liên quan đến các khiếu nại từ khách hàng.</li>
                                <li>Tăng độ tin cậy và uy tín của Provider trong mắt khách hàng.</li>
                            </ul>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                2. Mức Bảo hiểm Tối thiểu Bắt buộc
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;">Để đảm bảo quyền lợi tối đa cho khách hàng, Provider cần duy trì bảo hiểm trách nhiệm với các mức tối thiểu sau:</p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li><strong>Thiệt hại tài sản:</strong> Tối thiểu <strong>50.000.000 VNĐ</strong> cho mỗi sự cố.</li>
                                <li><strong>Thương tích cá nhân:</strong> Tối thiểu <strong>100.000.000 VNĐ</strong> cho mỗi sự cố.</li>
                                <li><strong>Chi phí pháp lý:</strong> Tối thiểu <strong>20.000.000 VNĐ</strong> cho mỗi vụ việc.</li>
                                <li><strong>Tổng mức bảo hiểm:</strong> Khuyến nghị tối thiểu <strong>200.000.000 VNĐ</strong> cho mỗi năm.</li>
                            </ul>
                            <p style="margin-left: 12px; line-height: 1.7; margin-top: 12px; padding: 12px; background: rgba(14, 165, 233, 0.08); border-left: 3px solid #0ea5e9; border-radius: 4px;">
                                <strong>Lưu ý:</strong> Provider có thể mua bảo hiểm với mức cao hơn để được bảo vệ tốt hơn. VHS Platform có thể yêu cầu xem giấy tờ bảo hiểm bất kỳ lúc nào.
                            </p>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                3. Quy trình Xử lý Khiếu nại và Bồi thường
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;"><strong>Khi có sự cố xảy ra:</strong></p>
                            <ol style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li><strong>Báo cáo ngay:</strong> Provider và khách hàng phải báo cáo sự cố cho VHS Platform và công ty bảo hiểm <strong>trong vòng 24 giờ</strong> kể từ khi xảy ra sự cố.</li>
                                <li><strong>Cung cấp bằng chứng:</strong> Khách hàng cần gửi yêu cầu bồi thường kèm đầy đủ bằng chứng (ảnh chụp, video, biên bản, giấy tờ liên quan) trong vòng <strong>7 ngày</strong> kể từ khi xảy ra sự cố.</li>
                                <li><strong>Điều tra và xác minh:</strong> VHS Platform sẽ phối hợp với công ty bảo hiểm để điều tra, xác minh và đánh giá mức độ thiệt hại.</li>
                                <li><strong>Phối hợp giải quyết:</strong> Provider phải phối hợp tích cực, cung cấp đầy đủ thông tin và tham gia giải quyết một cách minh bạch.</li>
                                <li><strong>Quyết định bồi thường:</strong> Quyết định bồi thường sẽ được đưa ra trong vòng <strong>14 ngày làm việc</strong> kể từ khi nhận đủ hồ sơ và bằng chứng.</li>
                                <li><strong>Chi trả:</strong> Công ty bảo hiểm sẽ chi trả bồi thường theo quy định của hợp đồng bảo hiểm.</li>
                            </ol>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                4. Đảm bảo Chất lượng và An toàn Dịch vụ
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;">Để giảm thiểu rủi ro và đảm bảo chất lượng dịch vụ, Provider cam kết:</p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li><strong>Thiết bị và vật tư:</strong> Sử dụng thiết bị, dụng cụ và vật tư đạt tiêu chuẩn chất lượng, an toàn và có nguồn gốc rõ ràng.</li>
                                <li><strong>Nhân viên chuyên nghiệp:</strong> Nhân viên thực hiện dịch vụ phải được đào tạo bài bản, có kỹ năng chuyên môn và chứng chỉ cần thiết (nếu có).</li>
                                <li><strong>An toàn lao động:</strong> Tuân thủ nghiêm ngặt các quy trình an toàn lao động, sử dụng thiết bị bảo hộ đầy đủ và đúng cách.</li>
                                <li><strong>Phòng ngừa rủi ro:</strong> Có kế hoạch và biện pháp phòng ngừa rủi ro cụ thể trong quá trình cung cấp dịch vụ, đặc biệt là các dịch vụ có tính chất nguy hiểm.</li>
                                <li><strong>Bảo trì và kiểm tra:</strong> Thường xuyên bảo trì, kiểm tra và thay thế thiết bị, dụng cụ để đảm bảo an toàn và hiệu quả.</li>
                            </ul>

                            <h6 style="color: #0ea5e9; margin-top: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 4px; height: 20px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 2px; display: inline-block;"></span>
                                5. Miễn trừ Trách nhiệm
                            </h6>
                            <p style="margin-left: 12px; line-height: 1.7; margin-bottom: 8px;">VHS Platform <strong>không chịu trách nhiệm</strong> về các thiệt hại trong các trường hợp sau:</p>
                            <ul style="margin-left: 12px; line-height: 1.8; padding-left: 20px;">
                                <li><strong>Lỗi từ phía khách hàng:</strong> Thiệt hại do khách hàng cung cấp thông tin sai lệch, không tuân thủ hướng dẫn an toàn, hoặc can thiệp vào quá trình thực hiện dịch vụ.</li>
                                <li><strong>Bất khả kháng:</strong> Sự cố do thiên tai (lũ lụt, bão, động đất), hỏa hoạn, dịch bệnh, chiến tranh hoặc các sự kiện bất khả kháng khác ngoài tầm kiểm soát.</li>
                                <li><strong>Tranh chấp ngoài platform:</strong> Các tranh chấp phát sinh từ giao dịch trực tiếp giữa Provider và khách hàng ngoài nền tảng VHS.</li>
                                <li><strong>Thiệt hại gián tiếp:</strong> Các khoản lợi nhuận bị mất, thiệt hại về danh tiếng hoặc các thiệt hại gián tiếp khác không liên quan trực tiếp đến dịch vụ được cung cấp.</li>
                            </ul>
                            <p style="margin-left: 12px; line-height: 1.7; margin-top: 12px; padding: 12px; background: rgba(14, 165, 233, 0.08); border-left: 3px solid #0ea5e9; border-radius: 4px;">
                                <strong>Ghi chú:</strong> Trong mọi trường hợp, VHS Platform sẽ cố gắng hỗ trợ tối đa để giải quyết tranh chấp một cách công bằng và minh bạch.
                            </p>
                        </div>
                    </div>

                    <!-- Checkbox đồng ý -->
                    <div class="field" style="margin-top: 24px;">
                        <div style="display: flex; align-items: flex-start; gap: 14px; background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--rp-shadow-sm);" id="termsCheckboxWrapper">
                            <input type="checkbox" id="agreeTerms" style="width: 22px; height: 22px; margin-top: 2px; cursor: pointer; accent-color: #0ea5e9;" required />
                            <label for="agreeTerms" style="margin: 0; cursor: pointer; font-size: 15px; line-height: 1.6; color: var(--foreground); font-weight: 500;">
                                Tôi đã đọc, hiểu rõ và đồng ý với Chính sách và Điều khoản chung, Chính sách bảo hiểm của VHS Platform. <span style="color: #ef4444; font-weight: bold;">*</span>
                            </label>
                        </div>
                        <div id="termsError" class="text-danger small d-none" style="margin-top: 8px; padding-left: 32px;">
                            Bạn phải đồng ý với điều khoản và chính sách để tiếp tục đăng ký.
                        </div>
                    </div>
                </div>
            </section>

            <div class="actions center">
                <a href="javascript:history.back()" class="btn ghost">Hủy</a>
                <button type="button" class="btn primary" id="btnSubmit">Đăng ký nhà cung cấp</button>
            </div>
        </form>
    </div>
</main>

@section Scripts {
    <script>
        (function () {
          // ===== Avatar =====
          const fileInput   = document.getElementById("ProfileImage");
          const placeholder = document.getElementById("avatarPlaceholder");
          const previewWrap = document.getElementById("avatarPreviewWrap");
          const img         = document.getElementById("imgPreview");
          const fileNameEl  = document.getElementById("fileName");
          const overlayBtn  = document.getElementById("avatarOverlay");
          const isResubmit  = document.getElementById("IsResubmit")?.value === "true";

          placeholder?.addEventListener("click", () => fileInput?.click());
          fileInput?.addEventListener("change", e => {
            const f = e.target.files?.[0]; if (!f) return;
            // validate avatar client-side
            if (!f.type.startsWith("image/")) {
              alert("Ảnh đại diện không hợp lệ.");
              fileInput.value = "";
              return;
            }
            img.src = URL.createObjectURL(f);
            if (fileNameEl) fileNameEl.textContent = f.name;
            placeholder.classList.add("d-none");
            previewWrap.classList.remove("d-none");
            // Remove error state
            placeholder?.classList.remove('is-invalid');
            const avatarError = document.getElementById('avatarError');
            if (avatarError) avatarError.classList.add('d-none');
          });
          overlayBtn?.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
            previewWrap.classList.add("d-none");
            placeholder.classList.remove("d-none");
            if (fileNameEl) fileNameEl.textContent = "Chưa chọn tệp";
          });

          // ===== Autosize =====
          function wireAutosize(scope){
            scope.querySelectorAll("textarea.autosize, .cert textarea.input").forEach(t=>{
              const resize = ()=>{ t.style.height="auto"; t.style.height=t.scrollHeight+"px"; };
              t.removeEventListener("input", resize);
              t.addEventListener("input", resize);
              resize();
            });
          }
          wireAutosize(document);

          // ===== DANH MỤC & TAGS =====
          const btnSubmit = document.getElementById("btnSubmit");
          const nameEl    = document.getElementById("ProviderName");
          const phoneEl   = document.getElementById("PhoneNumber");
          const descEl    = document.getElementById("Description");
          const agreeTermsEl = document.getElementById("agreeTerms");
          const termsErrorEl = document.getElementById("termsError");
          const termsWrapperEl = document.getElementById("termsCheckboxWrapper");

          // Backend URL
          const BACKEND_URL = '@(ViewBag.BackendUrl ?? "")';
          console.log('🌐 Backend URL:', BACKEND_URL);

          // Cache tags data
          const tagsCache = new Map();

          // Check phone number duplicate
          let phoneCheckTimeout = null;
          let isPhoneChecking = false;

          async function checkPhoneDuplicate(phone) {
            if (!phone || phone.length !== 10 || !phone.startsWith('0')) {
              return false; // Invalid format, skip check
            }

            if (isPhoneChecking) return false;
            isPhoneChecking = true;

            try {
              const url = `${BACKEND_URL}/api/provider/check-phone?phoneNumber=${encodeURIComponent(phone)}`;
              const response = await fetch(url);

              if (response.ok) {
                const result = await response.json();
                return result.exists || false;
              }
              return false;
            } catch (error) {
              console.error('Error checking phone:', error);
              return false;
            } finally {
              isPhoneChecking = false;
            }
          }

          // Phone number validation with duplicate check
          phoneEl?.addEventListener('input', function() {
            const phone = this.value.trim();

            // Clear previous timeout
            if (phoneCheckTimeout) {
              clearTimeout(phoneCheckTimeout);
            }

              // Remove error state
              this.classList.remove('is-invalid');
              const errorMsg = this.parentElement.querySelector('.phone-error');
              if (errorMsg) errorMsg.remove();
              const phoneErrorEl = document.getElementById('phoneError');
              if (phoneErrorEl) phoneErrorEl.classList.add('d-none');

              // Validate format
              if (phone.length > 0) {
                const phoneRegex = /^0[0-9]{9}$/;
                if (!phoneRegex.test(phone)) {
                  this.classList.add('is-invalid');
                  if (phoneErrorEl) {
                    phoneErrorEl.textContent = 'Số điện thoại phải bắt đầu bằng 0 và có đúng 10 chữ số.';
                    phoneErrorEl.classList.remove('d-none');
                  }
                  return;
                }

                // Check duplicate after 500ms debounce
                phoneCheckTimeout = setTimeout(async () => {
                  const exists = await checkPhoneDuplicate(phone);
                  if (exists) {
                    this.classList.add('is-invalid');
                    if (phoneErrorEl) {
                      phoneErrorEl.textContent = 'Số điện thoại này đã được sử dụng. Vui lòng nhập số khác.';
                      phoneErrorEl.classList.remove('d-none');
                    }
                  } else {
                    if (phoneErrorEl) phoneErrorEl.classList.add('d-none');
                  }
                }, 500);
              } else {
                if (phoneErrorEl) phoneErrorEl.classList.add('d-none');
              }
          });

          // Load tags từ API cho một category
          async function loadTagsForCategory(categoryId) {
            console.log('🔍 Loading tags for category:', categoryId);

            // Kiểm tra cache
            if (tagsCache.has(categoryId)) {
              console.log('✅ Found in cache:', tagsCache.get(categoryId));
              return tagsCache.get(categoryId);
            }

            try {
              const url = `${BACKEND_URL}/api/tag?categoryId=${categoryId}&includeDeleted=false`;
              console.log('📡 Fetching:', url);

              const response = await fetch(url);
              console.log('📥 Response status:', response.status);

              if (!response.ok) {
                console.error('❌ Failed to load tags:', response.status);
                const errorText = await response.text();
                console.error('Error details:', errorText);
                return [];
              }

              const tags = await response.json();
              console.log('✅ Loaded tags:', tags);

              tagsCache.set(categoryId, tags);
              return tags;
            } catch (error) {
              console.error('❌ Error loading tags:', error);
              return [];
            }
          }

          // Render tags vào container
          function renderTags(categoryId, tags) {
            console.log('🎨 Rendering tags for category:', categoryId, 'Tags count:', tags.length);

            const container = document.querySelector(`[data-tags-container="${categoryId}"]`);
            if (!container) {
              console.error('❌ Container not found for category:', categoryId);
                  return;
                }

            console.log('📦 Container found:', container);

            if (tags.length === 0) {
              console.log('⚠️ No tags available for this category');
              container.innerHTML = '<p class="text-muted small" style="margin: 0;">Chưa có dịch vụ cụ thể cho danh mục này.</p>';
              return;
            }

            container.innerHTML = '';
            tags.forEach(tag => {
              console.log('➕ Adding tag:', tag.name, 'ID:', tag.tagId);
              const label = document.createElement('label');
              label.className = 'tag-checkbox';
              label.innerHTML = `
                <input type="checkbox" name="SelectedTags" value="${tag.tagId}" data-category-id="${categoryId}" />
                <span class="tag-text">${tag.name}</span>
              `;
              container.appendChild(label);

              // Add event listener để xóa lỗi khi chọn tag
              const tagCheckbox = label.querySelector('input[type="checkbox"]');
              tagCheckbox.addEventListener('change', function() {
                const catId = this.dataset.categoryId;
                const categoryCard = document.querySelector(`[data-category-id="${catId}"]`);
                const tagsChecked = document.querySelectorAll(`[data-category="${catId}"] input[name="SelectedTags"]:checked`);
                const tagError = categoryCard?.querySelector('.tag-error');

                // Ẩn lỗi nếu đã chọn ít nhất 1 tag
                if (tagsChecked.length > 0 && tagError) {
                  tagError.style.display = 'none';
                }
              });
            });

            console.log('✅ Rendered', tags.length, 'tags');
          }

          // Handle category selection and show/hide tags (CHECKBOX - chọn nhiều)
          document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            console.log('✅ Category checkbox found:', checkbox.id, checkbox.value);

            checkbox.addEventListener('change', async function() {
              console.log('🔄 Category checkbox changed:', this.id, 'Checked:', this.checked);

              const categoryId = this.value;
              const tagsSection = document.querySelector(`.category-tags[data-category="${categoryId}"]`);

              console.log('📍 Tags section:', tagsSection);

              if (this.checked) {
                // Show tags for selected category
                if (tagsSection) {
                  console.log('👁️ Showing tags section');
                  tagsSection.style.display = 'block';

                  // Load tags nếu chưa có
                  const container = tagsSection.querySelector(`[data-tags-container="${categoryId}"]`);
                  console.log('📦 Tags container:', container);

                  const hasLoading = container?.querySelector('.tags-loading');
                  console.log('⏳ Has loading indicator:', !!hasLoading);

                  // Load tags (cho dù đã load hay chưa để refresh)
                  if (container) {
                    console.log('🚀 Loading tags...');
                    const tags = await loadTagsForCategory(categoryId);
                    renderTags(categoryId, tags);
                  }
                }
              } else {
                // Hide tags và uncheck tất cả tags của category này
                if (tagsSection) {
                  console.log('🙈 Hiding tags section');
                  tagsSection.style.display = 'none';
                  tagsSection.querySelectorAll('input[name="SelectedTags"]').forEach(tag => {
                    tag.checked = false;
                  });
                }
              }
            });
          });

          // Business License file upload
          const licenseInput = document.getElementById('BusinessLicenses');
          const licenseFileName = document.getElementById('licenseFileName');
          const licensePreviews = document.getElementById('licensePreviews');

          const licenseFiles = [];

          // Sync files to input element
          function syncLicenseFiles() {
            if (!licenseInput) return;

            const dt = new DataTransfer();
            licenseFiles.forEach(f => dt.items.add(f));
            licenseInput.files = dt.files;
          }

          licenseInput?.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files || []);

            newFiles.forEach(f => {
              if (!f.type.startsWith('image/')) {
                alert(`Tệp ${f.name} không phải là ảnh.`);
                return;
              }

              const signature = `${f.name}|${f.size}|${f.lastModified}`;
              const exists = licenseFiles.some(existing =>
                `${existing.name}|${existing.size}|${existing.lastModified}` === signature
              );

              if (!exists) {
                licenseFiles.push(f);
              }
            });

            // Sync và update preview
            syncLicenseFiles();
            renderLicensePreviews();

            // Update file name display
            if (licenseFileName) {
              licenseFileName.textContent = licenseFiles.length > 0
                ? `${licenseFiles.length} tệp đã chọn`
                : 'Chưa chọn tệp';
            }

            // Reset input value để cho phép chọn lại cùng file
            e.target.value = '';
          });

          function renderLicensePreviews() {
            if (!licensePreviews) return;

            licensePreviews.innerHTML = '';
            licenseFiles.forEach((f, idx) => {
              const url = URL.createObjectURL(f);
              const fig = document.createElement('figure');
              fig.className = 'thumb';
              fig.dataset.imageUrl = url;
              fig.dataset.imageName = f.name;
              fig.innerHTML = `
                <img src="${url}" alt="${f.name}">
                <button type="button" class="thumb-del" data-index="${idx}" aria-label="Xóa">×</button>
              `;
              licensePreviews.appendChild(fig);
            });

            // Add click event for image zoom
            document.querySelectorAll('#licensePreviews .thumb').forEach(thumb => {
              thumb.addEventListener('click', (e) => {
                // Don't zoom if clicking delete button
                if (e.target.closest('.thumb-del')) return;
                openImageModal(thumb.dataset.imageUrl, thumb.dataset.imageName);
              });
            });
          }

          // Function to open image modal
          function openImageModal(imageUrl, imageName) {
            // Remove existing modal if any
            const existingModal = document.querySelector('.image-modal-overlay');
            if (existingModal) existingModal.remove();

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'image-modal-overlay';
            modal.innerHTML = `
              <div class="image-modal-content">
                <button class="image-modal-close" aria-label="Đóng">×</button>
                <img src="${imageUrl}" alt="${imageName}">
              </div>
            `;

            document.body.appendChild(modal);

            // Show modal with animation
            setTimeout(() => modal.classList.add('active'), 10);

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Close button
            modal.querySelector('.image-modal-close').addEventListener('click', () => closeImageModal(modal));

            // Click overlay to close
            modal.addEventListener('click', (e) => {
              if (e.target === modal) closeImageModal(modal);
            });

            // Escape key to close
            const escHandler = (e) => {
              if (e.key === 'Escape') {
                closeImageModal(modal);
                document.removeEventListener('keydown', escHandler);
              }
            };
            document.addEventListener('keydown', escHandler);
          }

          // Function to close image modal
          function closeImageModal(modal) {
            modal.classList.remove('active');
            setTimeout(() => {
              modal.remove();
              document.body.style.overflow = '';
            }, 300);
          }

          // Remove license image
          licensePreviews?.addEventListener('click', (e) => {
            const btn = e.target.closest('.thumb-del');
            if (!btn) return;

            e.stopPropagation(); // Prevent triggering zoom

            const idx = Number(btn.dataset.index);
            if (idx >= 0 && idx < licenseFiles.length) {
              licenseFiles.splice(idx, 1);
              syncLicenseFiles();
              renderLicensePreviews();

              if (licenseFileName) {
                licenseFileName.textContent = licenseFiles.length > 0
                  ? `${licenseFiles.length} tệp đã chọn`
                  : 'Chưa chọn tệp';
              }
            }
          });

          // Function to show toast notification
          function showToast(message, type = 'error') {
            // Remove existing toast if any
            const existingToast = document.querySelector('.rp-toast');
            if (existingToast) {
              existingToast.classList.remove('show');
              setTimeout(() => existingToast.remove(), 300);
            }

            // Escape HTML để tránh XSS
            function escapeHtml(text) {
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
            }
            
            // Escape HTML và giữ nguyên newline (sẽ được xử lý bởi white-space: pre-line)
            const safeMessage = escapeHtml(String(message || ''));

            const toast = document.createElement('div');
            toast.className = `rp-toast rp-toast-${type}`;
            toast.innerHTML = `
              <div class="rp-toast-content">
                <i class="bi ${type === 'error' ? 'bi-exclamation-circle' : 'bi-check-circle'}"></i>
                <span style="white-space: pre-line; word-wrap: break-word;">${safeMessage}</span>
                <button type="button" class="rp-toast-close" aria-label="Đóng">&times;</button>
              </div>
            `;
            document.body.appendChild(toast);

            // Close button handler
            const closeBtn = toast.querySelector('.rp-toast-close');
            closeBtn.addEventListener('click', () => {
              toast.classList.remove('show');
              setTimeout(() => toast.remove(), 300);
            });

            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto remove after 8 seconds (tăng thời gian để đọc message dài)
            const autoRemove = setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => toast.remove(), 300);
            }, 8000);

            // Clear timeout on hover
            toast.addEventListener('mouseenter', () => clearTimeout(autoRemove));
          }

          // ===== Auto hide errors on input =====
          nameEl?.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const nameError = document.getElementById('nameError');
            if (nameError) nameError.classList.add('d-none');
          });

          descEl?.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const descError = document.getElementById('descError');
            if (descError) descError.classList.add('d-none');
          });

          // ===== init =====
          // Hide all tag sections initially
          document.querySelectorAll('.category-tags').forEach(tags => {
            tags.style.display = 'none';
          });

          // Submit AJAX JSON — loại bỏ redirect/banner
          const form = document.getElementById("providerForm");
          
          // QUAN TRỌNG: Prevent default form submission ngay từ đầu
          let isSubmitting = false; // Flag để prevent double submit
          
          // Function xử lý submit
          async function handleSubmit(ev) {
            // Ngăn submit mặc định nếu có event
            if (ev) {
              ev.preventDefault();
              ev.stopPropagation();
            }
            
            // Prevent double submit
            if (isSubmitting) {
              console.warn('⚠️ Form đang được submit, bỏ qua request này');
              return;
            }
            
            // comprehensive validation for resubmit (Rejected)
            const errors = [];

            const providerName = nameEl?.value?.trim() || "";
            const phoneTrim    = phoneEl?.value?.trim() || "";
            const descVal      = descEl?.value || "";

            // basic field validation - BẮT BUỘC TẤT CẢ
            const nameError = document.getElementById('nameError');
            if (providerName.length === 0) {
              errors.push({ msg: "Vui lòng nhập tên Provider.", el: nameEl });
              nameEl?.classList.add('is-invalid');
              nameError?.classList.remove('d-none');
            } else {
              nameEl?.classList.remove('is-invalid');
              nameError?.classList.add('d-none');
            }

            // BẮT BUỘC ảnh đại diện (cho cả lần đầu và resubmit)
            const avatarError = document.getElementById('avatarError');
            if (!fileInput?.files || fileInput.files.length === 0) {
              errors.push({ msg: "Vui lòng chọn ảnh đại diện.", el: fileInput });
              placeholder?.classList.add('is-invalid');
              avatarError?.classList.remove('d-none');
            } else {
              placeholder?.classList.remove('is-invalid');
              avatarError?.classList.add('d-none');
            }

            // Validate phone number format (nếu có nhập)
            const phoneErrorEl = document.getElementById('phoneError');
            if (phoneTrim.length > 0) {
              // Phải bắt đầu bằng 0 và đúng 10 số
              const phoneRegex = /^0[0-9]{9}$/;
              if (!phoneRegex.test(phoneTrim)) {
                errors.push({ msg: "Số điện thoại phải bắt đầu bằng 0 và có đúng 10 chữ số.", el: phoneEl });
                phoneEl?.classList.add('is-invalid');
                if (phoneErrorEl) {
                  phoneErrorEl.textContent = "Số điện thoại phải bắt đầu bằng 0 và có đúng 10 chữ số.";
                  phoneErrorEl.classList.remove('d-none');
                }
              } else {
                // Check duplicate
                const phoneError = phoneEl?.parentElement.querySelector('.phone-error');
                if (phoneError && phoneError.textContent.includes('đã được sử dụng')) {
                  errors.push({ msg: "Số điện thoại này đã được sử dụng. Vui lòng nhập số khác.", el: phoneEl });
                  if (phoneErrorEl) {
                    phoneErrorEl.textContent = "Số điện thoại này đã được sử dụng. Vui lòng nhập số khác.";
                    phoneErrorEl.classList.remove('d-none');
                  }
                } else {
                  // Double check duplicate on submit
                  const exists = await checkPhoneDuplicate(phoneTrim);
                  if (exists) {
                    errors.push({ msg: "Số điện thoại này đã được sử dụng. Vui lòng nhập số khác.", el: phoneEl });
                    phoneEl?.classList.add('is-invalid');
                    if (phoneErrorEl) {
                      phoneErrorEl.textContent = "Số điện thoại này đã được sử dụng. Vui lòng nhập số khác.";
                      phoneErrorEl.classList.remove('d-none');
                    }
                  } else {
                    phoneEl?.classList.remove('is-invalid');
                    phoneErrorEl?.classList.add('d-none');
                  }
                }
              }
            } else {
              phoneErrorEl?.classList.add('d-none');
            }

            // BẮT BUỘC mô tả Provider
            const descError = document.getElementById('descError');
            if (descVal.trim().length === 0) {
              errors.push({ msg: "Vui lòng nhập mô tả dịch vụ.", el: descEl });
              descEl?.classList.add('is-invalid');
              descError?.classList.remove('d-none');
            } else {
              descEl?.classList.remove('is-invalid');
              descError?.classList.add('d-none');
            }

            // BẮT BUỘC đồng ý điều khoản và bảo hiểm
            if (!agreeTermsEl?.checked) {
              errors.push({ msg: "Bạn phải đồng ý với Điều khoản dịch vụ.", el: agreeTermsEl });
              termsWrapperEl?.classList.add('error');
              termsWrapperEl?.classList.remove('checked');
              termsErrorEl?.classList.remove('d-none');
            } else {
              termsWrapperEl?.classList.remove('error');
              termsWrapperEl?.classList.add('checked');
              termsErrorEl?.classList.add('d-none');
            }

            // BẮT BUỘC chọn ít nhất 1 danh mục
            const selectedCategories = document.querySelectorAll('.category-checkbox:checked');
            const categoryError = document.getElementById('categoryError');
            if (selectedCategories.length === 0) {
              errors.push({ msg: "Vui lòng chọn ít nhất 1 danh mục dịch vụ.", el: null });
              categoryError?.classList.remove('d-none');
            } else {
              categoryError?.classList.add('d-none');
            }

            // BẮT BUỘC: Mỗi category đã chọn phải có ít nhất 1 tag
            selectedCategories.forEach(catCheckbox => {
              const categoryId = catCheckbox.value;
              const categoryName = catCheckbox.dataset.categoryName || 'danh mục này';
              const tagsChecked = document.querySelectorAll(`[data-category="${categoryId}"] input[name="SelectedTags"]:checked`);

              // Tìm hoặc tạo error element cho category này
              const categoryCard = catCheckbox.closest('.category-card');
              let tagError = categoryCard?.querySelector('.tag-error');

              if (tagsChecked.length === 0) {
                errors.push({ msg: `Vui lòng chọn ít nhất 1 dịch vụ cụ thể cho "${categoryName}".`, el: null });

                // Hiển thị lỗi trong category card
                if (!tagError && categoryCard) {
                  tagError = document.createElement('div');
                  tagError.className = 'tag-error text-danger small mt-2';
                  tagError.style.marginLeft = '20px';
                  tagError.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Vui lòng chọn ít nhất 1 dịch vụ cụ thể.';
                  categoryCard.querySelector('.category-tags')?.appendChild(tagError);
                }
                if (tagError) tagError.style.display = 'block';
              } else {
                // Xóa lỗi nếu đã chọn tags
                if (tagError) tagError.style.display = 'none';
              }
            });

              // BẮT BUỘC tải lên ít nhất 1 hình giấy phép
            const licenseError = document.getElementById('licenseError');
            syncLicenseFiles(); // Sync trước khi validate

            if (licenseFiles.length === 0) {
              errors.push({ msg: "Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh.", el: licenseInput });
              licenseError?.classList.remove('d-none');
              licenseInput?.classList.add('is-invalid');
              } else {
              licenseError?.classList.add('d-none');
              licenseInput?.classList.remove('is-invalid');
              }

            // file constraints and total size <= 50MB
            const MAX_TOTAL = 50 * 1024 * 1024;
            let totalBytes = 0;
            const allFiles = [];

            // Add profile image
            if (fileInput?.files?.[0]) allFiles.push(fileInput.files[0]);

            // Add business license images
            licenseFiles.forEach(f => allFiles.push(f));

            console.log('=== SUBMIT DEBUG ===');
            console.log('Profile image:', fileInput?.files?.length || 0);
            if (fileInput?.files?.[0]) {
              console.log(`  - Profile image: ${fileInput.files[0].name} (${(fileInput.files[0].size / 1024 / 1024).toFixed(2)} MB)`);
            }
            console.log('Business licenses:', licenseFiles.length);
            licenseFiles.forEach((f, idx) => {
              console.log(`  - License[${idx}]: ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)`);
            });
            console.log('Selected categories:', selectedCategories.length);
            selectedCategories.forEach((cat, idx) => {
              const catId = cat.value;
              const catName = cat.dataset.categoryName || '';
              const tagsCount = document.querySelectorAll(`[data-category="${catId}"] input[name="SelectedTags"]:checked`).length;
              console.log(`  - Category[${idx}]: ${catName} (${tagsCount} tags)`);
            });
            console.log('Total files to submit:', allFiles.length);

            allFiles.forEach((f, idx) => {
              if (!f.type.startsWith('image/')) {
                errors.push({ msg: `Tệp "${f.name}" không hợp lệ (không phải ảnh).`, el: null });
              }
              totalBytes += f.size;
              console.log(`  File[${idx}]: ${f.name} - ${(f.size / 1024 / 1024).toFixed(2)} MB - ${f.type}`);
            });
            
            const totalMB = (totalBytes / 1024 / 1024).toFixed(2);
            console.log(`Total size: ${totalMB} MB (max: ${(MAX_TOTAL / 1024 / 1024).toFixed(2)} MB)`);
            
            if (totalBytes > MAX_TOTAL) {
              errors.push({ msg: `Tổng dung lượng tệp (${totalMB} MB) vượt quá giới hạn 50MB.`, el: null });
            }

            if (errors.length > 0) {
              // Scroll đến trường có lỗi đầu tiên và focus
              const firstError = errors[0];
              
              // Hiển thị lỗi đầu tiên bằng toast
              if (firstError.msg) {
                showToast(firstError.msg, 'error');
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }
              
              if (firstError.el) {
                // Special handling for terms checkbox
                if (firstError.el === agreeTermsEl) {
                  scrollToTermsError();
                } else {
                  setTimeout(() => {
                    firstError.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (typeof firstError.el.focus === 'function') {
                      firstError.el.focus();
                    }
                  }, 500);
                }
              }

              return;
            }

            // Đánh dấu đang submit
            isSubmitting = true;
            
            // trim values before submit
            if (nameEl) nameEl.value = providerName;
            if (phoneEl) phoneEl.value = phoneTrim;

            // QUAN TRỌNG: Sync files vào input trước khi submit
            syncLicenseFiles();
            console.log(`Final sync - License files:`, licenseInput?.files?.length || 0);
            
            // Validate lại một lần nữa sau khi sync
            if (licenseFiles.length === 0) {
              console.error('❌ Validation failed: No license files after sync');
              showToast('Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh.', 'error');
              isSubmitting = false;
              return;
            }
            
            // Validate categories và tags
            const finalSelectedCategories = document.querySelectorAll('.category-checkbox:checked');
            if (finalSelectedCategories.length === 0) {
              console.error('❌ Validation failed: No categories selected');
              showToast('Vui lòng chọn ít nhất 1 danh mục dịch vụ.', 'error');
              isSubmitting = false;
              return;
            }
            
            // Validate tags cho mỗi category
            let hasTagsError = false;
            finalSelectedCategories.forEach(catCheckbox => {
              const categoryId = catCheckbox.value;
              const tagsChecked = document.querySelectorAll(`[data-category="${categoryId}"] input[name="SelectedTags"]:checked`);
              if (tagsChecked.length === 0) {
                hasTagsError = true;
                const categoryName = catCheckbox.dataset.categoryName || 'danh mục này';
                console.error(`❌ Validation failed: No tags selected for category: ${categoryName}`);
              }
            });
            
            if (hasTagsError) {
              showToast('Vui lòng chọn ít nhất 1 dịch vụ cụ thể cho mỗi danh mục đã chọn.', 'error');
              isSubmitting = false;
              return;
            }

            btnSubmit.disabled = true;
            const oldText = btnSubmit.textContent;
            btnSubmit.textContent = "Đang gửi...";
            
            console.log('🚀 Starting AJAX submit...');
            console.log(`📊 Final validation: ${finalSelectedCategories.length} categories, ${licenseFiles.length} license files`);

            try {
              // Map từ SelectedCategories + SelectedTags sang Certificates[] structure cho backend
              const fd = new FormData();

              // ✅ CRITICAL: Add AntiForgery Token!
              const antiForgeryToken = form.querySelector('input[name="__RequestVerificationToken"]');
              if (antiForgeryToken) {
                fd.append('__RequestVerificationToken', antiForgeryToken.value);
                console.log('✅ AntiForgery token added');
              } else {
                console.warn('⚠️ No AntiForgery token found!');
              }

              // Add basic fields
              fd.append('ProviderName', providerName);
              if (phoneTrim) fd.append('PhoneNumber', phoneTrim);
              fd.append('Description', descVal);

              // ✅ Terms & Insurance với timestamp đồng ý (giờ Việt Nam UTC+7)
              const now = new Date();
              // Sử dụng Intl.DateTimeFormat với timeZone để đảm bảo đúng giờ Việt Nam
              const agreementDate = new Intl.DateTimeFormat('vi-VN', {
                timeZone: 'Asia/Ho_Chi_Minh',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
              }).format(now);

              fd.append('TermsInsurance.Title', form.querySelector('#TI_Title')?.value || '');
              const termsDescription = (form.querySelector('#TI_Description')?.value || '').replace('{{AGREEMENT_DATE}}', agreementDate);
              fd.append('TermsInsurance.Description', termsDescription);

              // Add profile image
              if (fileInput?.files?.[0]) {
                fd.append('ProfileImage', fileInput.files[0]);
              }

              // Map categories sang Certificates structure
              console.log('📋 Mapping categories to certificates...');
              
              // Lấy lại selected categories (có thể đã thay đổi)
              const currentSelectedCategories = document.querySelectorAll('.category-checkbox:checked');
              console.log('Selected categories count:', currentSelectedCategories.length);
              
              if (currentSelectedCategories.length === 0) {
                throw new Error('Không có danh mục nào được chọn. Vui lòng chọn ít nhất 1 danh mục dịch vụ.');
              }
              
              currentSelectedCategories.forEach((catCheckbox, index) => {
                const categoryId = catCheckbox.value;
                const categoryName = catCheckbox.dataset.categoryName || '';

                // Get selected tags for this category (lấy cả name)
                const tagsForCategory = Array.from(
                  document.querySelectorAll(`[data-category="${categoryId}"] input[name="SelectedTags"]:checked`)
                ).map(tagCheckbox => {
                  // Lấy text từ label parent
                  const label = tagCheckbox.closest('label');
                  const tagText = label?.querySelector('.tag-text')?.textContent || '';
                  return {
                    id: tagCheckbox.value,
                    name: tagText.trim()
                  };
                });

                console.log(`  Certificate[${index}]: CategoryId=${categoryId}, Tags=${tagsForCategory.length}`);

                // Create Certificate entry
                fd.append(`Certificates[${index}].CategoryId`, categoryId);

                // *** QUAN TRỌNG: Gửi TagIds cho từng certificate ***
                tagsForCategory.forEach(tag => {
                  fd.append(`Certificates[${index}].TagIds`, tag.id);
                  console.log(`    - TagId: ${tag.id} (${tag.name})`);
                });

                // ✅ KHÔNG GỬI Description - field này không dùng nữa
                // Chỉ dùng CategoryId và TagIds
              });

              // ✅ Add business license files cho TẤT CẢ certificates (dùng chung)
              // Đảm bảo mỗi certificate đều có đầy đủ business licenses
              const finalCertCount = currentSelectedCategories.length;
              console.log(`📎 Adding business license files (${licenseFiles.length} files) to ${finalCertCount} certificates...`);
              
              if (licenseFiles.length === 0) {
                throw new Error('Không có file giấy phép kinh doanh. Vui lòng tải lên ít nhất 1 hình giấy phép.');
              }
              
              currentSelectedCategories.forEach((catCheckbox, certIndex) => {
                licenseFiles.forEach((file, fileIndex) => {
                  fd.append(`Certificates[${certIndex}].BusinessLicenses`, file);
                  console.log(`    Certificate[${certIndex}].BusinessLicenses[${fileIndex}]: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                });
              });
              
              console.log(`✅ Total certificates to send: ${finalCertCount}`);
              console.log(`✅ Total business license files: ${licenseFiles.length * finalCertCount} (${licenseFiles.length} files × ${finalCertCount} certificates)`);
              
              // Final validation: Đảm bảo có ít nhất 1 certificate với ít nhất 1 tag và 1 file
              let validCertCount = 0;
              currentSelectedCategories.forEach((catCheckbox, index) => {
                const categoryId = catCheckbox.value;
                const tagsForCategory = document.querySelectorAll(`[data-category="${categoryId}"] input[name="SelectedTags"]:checked`);
                if (tagsForCategory.length > 0 && licenseFiles.length > 0) {
                  validCertCount++;
                }
              });
              
              if (validCertCount === 0) {
                throw new Error('Không có certificate hợp lệ. Mỗi danh mục phải có ít nhất 1 dịch vụ và ít nhất 1 file giấy phép.');
              }
              
              console.log(`✅ Valid certificates: ${validCertCount}/${finalCertCount}`);

              // GỬI ĐẾN MVC CONTROLLER - Controller sẽ gọi service
              console.log('📤 Sending request to:', form.action);
              
              // Log FormData size estimate và chi tiết
              console.log('=== FORMDATA DETAILS ===');
              let formDataSize = 0;
              let fileCount = 0;
              let entryCount = 0;
              
              for (const [key, value] of fd.entries()) {
                entryCount++;
                if (value instanceof File) {
                  fileCount++;
                  formDataSize += value.size;
                  console.log(`  [${entryCount}] ${key}: File(${value.name}, ${(value.size / 1024 / 1024).toFixed(2)} MB)`);
                } else {
                  formDataSize += String(value).length;
                  const valueStr = String(value);
                  if (valueStr.length < 100) {
                    console.log(`  [${entryCount}] ${key}: ${valueStr}`);
                  } else {
                    console.log(`  [${entryCount}] ${key}: ${valueStr.substring(0, 100)}... (${valueStr.length} chars)`);
                  }
                }
              }
              
              console.log(`📊 FormData Summary: ${entryCount} entries, ${fileCount} files, ${(formDataSize / 1024 / 1024).toFixed(2)} MB total`);
              
              let res;
              try {
                // Thêm timeout để tránh chờ quá lâu (120 seconds cho file upload)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 seconds
                
                res = await fetch(form.action, {
                  method: 'POST',
                  headers: { 'X-Requested-With': 'XMLHttpRequest' },
                  body: fd,
                  signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('📥 Response received - Status:', res.status, res.statusText);
              } catch (fetchError) {
                console.error('❌ Fetch error:', fetchError);
                if (fetchError.name === 'AbortError') {
                  throw new Error('Yêu cầu quá thời gian chờ (120 giây). Có thể do file quá lớn hoặc kết nối chậm. Vui lòng thử lại với file nhỏ hơn.');
                }
                throw new Error(`Lỗi kết nối: ${fetchError.message}. Vui lòng kiểm tra kết nối mạng và thử lại.`);
              }

              // Kiểm tra Content-Type trước khi đọc response
              const contentType = res.headers.get('content-type') || '';
              console.log('📋 Response Content-Type:', contentType);
              
              // Đọc response text trước để debug
              let responseText;
              try {
                responseText = await res.text();
                console.log('📄 Response text length:', responseText.length);
                console.log('📄 Response text (first 500 chars):', responseText.substring(0, 500));
              } catch (textError) {
                console.error('❌ Error reading response text:', textError);
                throw new Error('Không thể đọc phản hồi từ server. Vui lòng thử lại.');
              }

              // Kiểm tra nếu response là HTML (có thể là error page)
              if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                console.error('❌ Server returned HTML instead of JSON - possible error page');
                throw new Error('Server trả về trang lỗi. Có thể do lỗi nghiêm trọng trên server. Vui lòng thử lại sau.');
              }

              if (res.status === 200) {
                let ok;
                try {
                  ok = JSON.parse(responseText);
                  console.log('✅ Parsed response:', ok);
                } catch (parseError) {
                  console.error('❌ JSON parse error:', parseError);
                  console.error('❌ Response text:', responseText);
                  throw new Error('Lỗi xử lý phản hồi từ server. Vui lòng thử lại.');
                }
                
                if (!ok || ok.ok !== true) {
                  const errorMsg = ok?.message || ok?.Message || 'Đăng ký thất bại.';
                  console.error('❌ Registration failed:', errorMsg);
                  showToast(errorMsg, 'error');
                  // Scroll to top để người dùng thấy toast
                  window.scrollTo({ top: 0, behavior: 'smooth' });
                  // KHÔNG reload trang - chỉ hiển thị lỗi
                  return;
                } else if (ok.refresh) {
                  localStorage.removeItem('myProvider');
                  window.location.reload();
                  return;
                } else {
                  const successUrl = `${form.getAttribute('data-success') || '/Customer/RegisterProvider/Success'}?id=${encodeURIComponent(ok.providerId)}&stat=${encodeURIComponent(ok.status)}`;
                  console.log('✅ Registration successful, redirecting to:', successUrl);
                  window.location.href = successUrl;
                  return;
                }
              }

              // Xử lý lỗi từ server (status !== 200)
              console.error('❌ Server returned error status:', res.status);
              let err;
              try {
                err = JSON.parse(responseText);
                console.error('❌ Parsed error response:', err);
              } catch (parseError) {
                console.error('❌ Failed to parse error response as JSON:', parseError);
                console.error('❌ Raw response:', responseText);
                // Nếu không parse được JSON, tạo error object từ response text
                err = { 
                  Message: responseText || `Lỗi server (${res.status}): ${res.statusText}`,
                  Detail: 'Không thể đọc phản hồi từ server'
                };
              }

              const msg = err?.Message || err?.message || `Lỗi đăng ký (${res.status})`;
              const detail = err?.Detail || err?.detail || err?.raw || '';

              // Log chi tiết để debug
              console.error('=== REGISTRATION ERROR ===');
              console.error('Status:', res.status);
              console.error('Status Text:', res.statusText);
              console.error('Message:', msg);
              console.error('Detail:', detail);
              console.error('Full error object:', err);
              console.error('Full response text:', responseText);

              // Hiển thị lỗi bằng toast
              // Nếu có detail và detail khác với message, hiển thị cả hai
              let displayMessage = msg;
              if (detail && detail !== msg && detail.length > 0) {
                displayMessage = `${msg}\n\nChi tiết: ${detail}`;
              }
              
              // Xử lý đặc biệt cho TaskCanceledException (database timeout)
              if (msg.includes('TaskCanceledException') || msg.includes('task was canceled') || 
                  msg.includes('canceled') || detail.includes('TaskCanceledException')) {
                displayMessage = 'Kết nối đến database bị timeout.\n\nNguyên nhân có thể:\n- Database server đang quá tải\n- Kết nối mạng không ổn định\n- File upload quá lớn\n\nVui lòng:\n1. Thử lại với file nhỏ hơn\n2. Đợi vài phút rồi thử lại\n3. Liên hệ admin nếu vấn đề tiếp tục';
              }
              
              showToast(displayMessage, 'error');
              
              // Scroll to top để người dùng thấy toast
              window.scrollTo({ top: 0, behavior: 'smooth' });
              
              // QUAN TRỌNG: KHÔNG reload trang - chỉ hiển thị lỗi và để người dùng sửa
              console.log('⚠️ Error displayed to user - page will NOT reload');

              // map Errors[].Field để highlight các field có lỗi
              if (Array.isArray(err?.Errors) || Array.isArray(err?.errors)) {
                const list = err.Errors || err.errors;
                console.log('📋 Field errors:', list);
                const m = (field) => {
                  if (!field) return null;
                  const fieldUpper = field.toUpperCase();
                  if (fieldUpper === 'PROVIDERNAME') return nameEl;
                  if (fieldUpper === 'PHONENUMBER') return phoneEl;
                  if (fieldUpper === 'DESCRIPTION') return descEl;
                  if (fieldUpper === 'PROFILEIMAGE') return fileInput;
                  if (fieldUpper === 'SELECTEDCATEGORIES' || fieldUpper === 'CATEGORYID') return document.querySelector('.category-checkbox:checked');
                  if (fieldUpper === 'BUSINESSLICENSES') return licenseInput;
                  if (fieldUpper === 'SELECTEDTAGS') return document.querySelector('input[name="SelectedTags"]:checked');
                  return null;
                };
                const first = list.find(e => !!(e.Field || e.field));
                const el = first ? m(first.Field || first.field) : null;
                if (el) {
                  if (el.classList) el.classList.add('is-invalid');
                  if (el.scrollIntoView) {
                    setTimeout(() => {
                      el.scrollIntoView({behavior:'smooth',block:'center'});
                      if (el.focus && typeof el.focus === 'function') el.focus();
                    }, 500);
                  }
                }
              }
            } catch (ex) {
              // Xử lý các lỗi khác (network, timeout, parse, v.v.)
              console.error('❌ Exception during registration:', ex);
              console.error('❌ Error name:', ex.name);
              console.error('❌ Error message:', ex.message);
              console.error('❌ Error stack:', ex.stack);
              
              let userMessage = 'Không thể gửi đăng ký. Vui lòng thử lại.';
              
              if (ex.message) {
                userMessage = ex.message;
              } else if (ex.name === 'TypeError' && ex.message.includes('fetch')) {
                userMessage = 'Lỗi kết nối mạng. Vui lòng kiểm tra kết nối internet và thử lại.';
              } else if (ex.name === 'AbortError') {
                userMessage = 'Yêu cầu quá thời gian chờ (120 giây). Có thể do:\n- File quá lớn\n- Kết nối mạng chậm\n- Server đang xử lý\n\nVui lòng thử lại với file nhỏ hơn hoặc kiểm tra kết nối mạng.';
              } else if (ex.name === 'TimeoutError' || ex.message?.includes('timeout') || ex.message?.includes('canceled')) {
                userMessage = 'Yêu cầu quá thời gian chờ. Có thể do file quá lớn hoặc kết nối chậm. Vui lòng thử lại với file nhỏ hơn.';
              } else if (ex.message?.includes('TaskCanceledException') || ex.message?.includes('task was canceled')) {
                userMessage = 'Kết nối đến database bị timeout. Vui lòng:\n1. Kiểm tra kết nối mạng\n2. Thử lại với file nhỏ hơn\n3. Đợi vài phút rồi thử lại\n4. Liên hệ admin nếu vấn đề tiếp tục';
              } else if (ex.message?.includes('HTML') || ex.message?.includes('error page')) {
                userMessage = 'Server trả về trang lỗi. Có thể do:\n- Database timeout\n- Server quá tải\n- Lỗi hệ thống\n\nVui lòng thử lại sau vài phút hoặc liên hệ admin.';
              }
              
              console.error('❌ Showing error to user:', userMessage);
              showToast(userMessage, 'error');
              
              // Scroll to top để người dùng thấy toast
              window.scrollTo({ top: 0, behavior: 'smooth' });
              
              // QUAN TRỌNG: KHÔNG reload trang - chỉ hiển thị lỗi
              console.log('⚠️ Exception handled - page will NOT reload');
            } finally {
              // Reset submitting flag
              isSubmitting = false;
              btnSubmit.disabled = false;
              btnSubmit.textContent = oldText || 'Đăng ký nhà cung cấp';
              console.log('✅ Submit button re-enabled, isSubmitting = false');
            }
          }
          
          // Attach event listener cho form submit (nếu có)
          form?.addEventListener("submit", handleSubmit);
          
          // Attach event listener cho button click
          btnSubmit?.addEventListener("click", (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            handleSubmit(ev);
          });

          // ===== COLLAPSIBLE TERMS & INSURANCE HANDLERS =====

          // Handle collapsible sections
          document.querySelectorAll('.terms-collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
              const targetId = this.getAttribute('data-target');
              const content = document.querySelector(targetId);
              const icon = this.querySelector('.terms-collapsible-icon');

              if (content) {
                const isOpen = content.classList.contains('open');

                if (isOpen) {
                  // Đóng
                  content.classList.remove('open');
                  icon?.classList.remove('rotate');
                } else {
                  // Mở
                  content.classList.add('open');
                  icon?.classList.add('rotate');
                }
              }
            });
          });

          // Handle checkbox change with animation
          agreeTermsEl?.addEventListener('change', () => {
            if (agreeTermsEl.checked) {
              termsWrapperEl?.classList.add('checked');
              termsWrapperEl?.classList.remove('error');
              termsErrorEl?.classList.add('d-none');
            } else {
              termsWrapperEl?.classList.remove('checked');
            }
          });

          // Handle clicking on wrapper
          termsWrapperEl?.addEventListener('click', (e) => {
            // Only toggle checkbox if not clicking on the checkbox itself
            if (e.target !== agreeTermsEl) {
              agreeTermsEl.checked = !agreeTermsEl.checked;
              agreeTermsEl.dispatchEvent(new Event('change'));
            }
          });

          // Add smooth scroll to terms section if there's an error
          function scrollToTermsError() {
            if (termsWrapperEl) {
              termsWrapperEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              termsWrapperEl.classList.add('error');
              setTimeout(() => {
                termsWrapperEl.classList.remove('error');
              }, 2000);
            }
          }

          // ===== Map API error (TempData banner) to fields =====
          // Bỏ map banner vì dùng flow JSON (AJAX)
          const apiErrEl = null;
          if (apiErrEl) {
            const msg = apiErrEl.textContent || "";
            function mark(el){ if(!el) return; el.classList.add('is-invalid'); try{ el.focus(); }catch{} }
            function scrollToEl(el){ if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); }
            if (msg.includes('Vui lòng nhập tên Provider')) { mark(nameEl); scrollToEl(nameEl); }
            else if (msg.includes('Vui lòng chọn danh mục')) {
              const cat = document.querySelector('.category-radio:checked');
              scrollToEl(cat || document.querySelector('.category-grid'));
            }
            else if (msg.includes('Vui lòng chọn ảnh đại diện')) { scrollToEl(placeholder || fileInput); }
            else if (msg.includes('Vui lòng tải lên ít nhất 1 hình giấy phép')) {
              mark(licenseInput); scrollToEl(licenseInput);
            }
            else if (msg.includes('Ảnh đại diện không hợp lệ')) { mark(fileInput); scrollToEl(fileInput); }
          }

          // Map BE Errors[] with Field to exact inputs (from TempData if fallback used)
          const apiErrorsJson = '@(TempData["ApiErrorsJson"] ?? "")';
          if (apiErrorsJson) {
            try {
              const errs = JSON.parse(apiErrorsJson);
              const fieldToEl = (field) => {
                if (!field) return null;
                const fieldUpper = field.toUpperCase();
                if (fieldUpper === 'PROVIDERNAME') return nameEl;
                if (fieldUpper === 'PHONENUMBER') return phoneEl;
                if (fieldUpper === 'DESCRIPTION') return descEl;
                if (fieldUpper === 'PROFILEIMAGE') return fileInput;
                if (fieldUpper === 'SELECTEDCATEGORIES' || fieldUpper === 'CATEGORYID') return document.querySelector('.category-checkbox:checked');
                if (fieldUpper === 'BUSINESSLICENSES') return licenseInput;
                if (fieldUpper === 'SELECTEDTAGS') return document.querySelector('input[name="SelectedTags"]:checked');
                return null;
              };
              let firstEl = null;
              errs.forEach(e => {
                const el = fieldToEl(e.Field);
                if (el && el.classList) el.classList.add('is-invalid');
                if (!firstEl && el) firstEl = el;
              });
              if (firstEl && firstEl.scrollIntoView) firstEl.scrollIntoView({behavior:'smooth',block:'center'});
              if (firstEl && firstEl.focus) firstEl.focus();
            } catch {}
          }
        })();
    </script>
}

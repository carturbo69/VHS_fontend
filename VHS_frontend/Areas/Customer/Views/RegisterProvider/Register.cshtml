@{
    ViewData["Title"] = "Đăng ký Provider";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = (IEnumerable<dynamic>)ViewBag.Categories;
    
    // ✅ Helper: Check status Rejected (cả tiếng Anh & Việt)
    bool IsRejectedStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return false;
        var s = status.ToLower();
        return s == "rejected" || s == "đã từ chối" || s == "bị từ chối";
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/register-provider.css" asp-append-version="true" />
}

<main class="rp">
    <div class="rp__container">
        <header class="rp__header">
            <h1>Đăng ký nhà cung cấp</h1>
            <p>Điền thông tin để bắt đầu hợp tác cùng chúng tôi</p>
        </header>

        @if (ViewBag.ExistingStatus is string existingStatus && IsRejectedStatus(existingStatus))
        {
            <div class="alert alert-danger" role="alert" style="max-width:1120px;margin:0 auto 16px; background-color: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="color: #ef4444; flex-shrink: 0;">
                        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div>
                        <strong style="color: #991b1b; font-size: 16px; display: block; margin-bottom: 4px;">Hồ sơ đã bị từ chối</strong>
                        <p style="color: #7f1d1d; margin: 0; font-size: 14px;">
                            Hồ sơ của bạn đã bị từ chối bởi admin. Vui lòng gửi lại toàn bộ thông tin với ảnh đại diện và giấy phép kinh doanh mới.
                        </p>
                    </div>
                </div>
            </div>
        }

        @* Banner lỗi tổng đã được loại bỏ trong flow mới (AJAX JSON), giữ lại khung để có thể tái dùng nếu cần) *@

        <form id="providerForm" method="post"
              asp-area="Customer" asp-controller="RegisterProvider" asp-action="RegisterFallback"
              enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" id="IsResubmit" value="@(IsRejectedStatus(ViewBag.ExistingStatus as string) ? "true" : "false")" />

            @* @if (ViewBag.ExistingProviderId != null) *@
            @* { *@
            @*     <input type="hidden" name="ProviderId" value="@ViewBag.ExistingProviderId" /> *@
            @* } *@

            <!-- THÔNG TIN -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-person"></i></span>
                    <div>
                        <h2>Thông tin nhà cung cấp</h2>
                        <p>Vui lòng cung cấp thông tin chi tiết về dịch vụ của bạn</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Avatar -->
                    <div class="field">
                        <label for="ProfileImage">Ảnh đại diện <span class="req">*</span></label>
                        <button type="button" id="avatarPlaceholder" class="avatar-tile" aria-label="Chọn ảnh từ tệp">
                            <div class="tile-icon">📷</div>
                            <div class="tile-text">Chọn từ tệp</div>
                        </button>

                        <div id="avatarPreviewWrap" class="avatar-wrap d-none">
                            <div class="avatar-img-wrap">
                                <img id="imgPreview" class="avatar-img" alt="Ảnh đại diện" src="~/images/placeholder-avatar.png" />
                                <button type="button" id="avatarOverlay" class="avatar-overlay" title="Xóa ảnh"><span class="overlay-x">×</span></button>
                            </div>

                            <div class="file-row">
                                <input type="file" id="ProfileImage" name="ProfileImage" accept="image/*" class="file-input" />
                                <div class="file-actions">
                                    <span id="fileName" class="file-name">Chưa chọn tệp</span>
                                    <label for="ProfileImage" class="btn ghost">Chọn tệp khác</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="ProviderName">Tên nhà cung cấp <span class="req">*</span></label>
                        <input id="ProviderName" name="ProviderName" class="input" maxlength="100"
                               placeholder="VD: Dịch vụ vệ sinh chuyên nghiệp Minh Anh" required />
                    </div>

                    <div class="field">
                        <label for="PhoneNumber">Số điện thoại</label>
                        <input id="PhoneNumber" name="PhoneNumber" class="input" inputmode="tel" maxlength="20"
                               placeholder="0912 345 678" />
                    </div>

                    <div class="field">
                        <label for="Description">Mô tả dịch vụ <span class="req">*</span></label>
                        <textarea id="Description" name="Description" class="input autosize" rows="3"
                                  placeholder="Kinh nghiệm, phạm vi phục vụ, điểm mạnh..." required></textarea>
                    </div>
                </div>
            </section>

            <!-- CHỨNG CHỈ & DANH MỤC -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-file-earmark-text"></i></span>
                    <div>
                        <h2>Chứng chỉ &amp; Danh mục</h2>
                        <p>Chọn danh mục dịch vụ và tải lên giấy phép kinh doanh</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Danh mục dịch vụ -->
                        <div class="field">
                            <label>Danh mục dịch vụ <span class="req">*</span></label>
                        <p class="field-hint">Chọn một hoặc nhiều danh mục dịch vụ của bạn</p>
                        
                        <div class="category-grid">
                                @foreach (var c in categories)
                                {
                                <div class="category-card" data-category-id="@c.Id">
                                    <input type="checkbox" 
                                           name="SelectedCategories" 
                                           id="cat_@c.Id" 
                                           value="@c.Id" 
                                           class="category-checkbox" 
                                           data-category-name="@c.Name" />
                                    <label for="cat_@c.Id" class="category-label">
                                        <div class="category-icon">
                                            @{
                                                var iconClass = "bi-tools"; // default
                                                var categoryName = c.Name.ToLower();
                                                if (categoryName.Contains("điện")) iconClass = "bi-lightning-charge";
                                                else if (categoryName.Contains("nước")) iconClass = "bi-droplet";
                                                else if (categoryName.Contains("điều hòa") || categoryName.Contains("lạnh")) iconClass = "bi-snow";
                                                else if (categoryName.Contains("sơn")) iconClass = "bi-paint-bucket";
                                                else if (categoryName.Contains("vệ sinh")) iconClass = "bi-brush";
                                                else if (categoryName.Contains("sửa chữa")) iconClass = "bi-wrench";
                                                else if (categoryName.Contains("nội trợ")) iconClass = "bi-house-heart";
                                                else if (categoryName.Contains("sự kiện")) iconClass = "bi-calendar-event";
                                            }
                                            <i class="bi @iconClass"></i>
                        </div>
                                        <span class="category-name">@c.Name</span>
                                        <i class="bi bi-check-circle category-check-icon"></i>
                                    </label>
                                    
                                    <!-- Tags cho category này (sẽ load từ API) -->
                                    <div class="category-tags" data-category="@c.Id">
                                        <p class="tags-label">Chọn các dịch vụ cụ thể:</p>
                                        <div class="tags-grid" data-tags-container="@c.Id">
                                            <div class="tags-loading">
                                                <i class="bi bi-arrow-clockwise spin"></i> Đang tải...
                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="field-error text-danger small d-none" id="categoryError">Vui lòng chọn ít nhất 1 danh mục dịch vụ.</div>
                        </div>

                    <!-- Giấy phép kinh doanh -->
                        <div class="field">
                        <label for="BusinessLicenses">Hình ảnh giấy phép kinh doanh <span class="req">*</span> (có thể chọn nhiều)</label>
                        <input id="BusinessLicenses" 
                               type="file" 
                               name="BusinessLicenses" 
                               class="file-input" 
                               accept="image/*" 
                               multiple 
                               required />
                        <div class="file-actions">
                            <span class="file-name" id="licenseFileName">Chưa chọn tệp</span>
                            <label for="BusinessLicenses" class="btn ghost">Chọn ảnh</label>
                        </div>
                        <div class="img-grid" id="licensePreviews" aria-live="polite"></div>
                        <div class="field-error text-danger small d-none" id="licenseError">Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh.</div>
                    </div>
                </div>
            </section>

            <!-- ĐIỀU KHOẢN & BẢO HIỂM -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-shield-check"></i></span>
                    <div>
                        <h2>Điều khoản &amp; Bảo hiểm</h2>
                        <p>Vui lòng đọc và đồng ý với các điều khoản dịch vụ và chính sách bảo hiểm của chúng tôi.</p>
                    </div>
                </div>

                <div class="card__body">
                            <!-- Hidden inputs for backend compatibility -->
                            <input type="hidden" id="TI_Title" name="TermsInsurance.Title" value="Điều khoản & Bảo hiểm áp dụng cho Provider" />
                            <textarea type="hidden" id="TI_Description" name="TermsInsurance.Description" style="display: none;">
=== CHÍNH SÁCH VÀ ĐIỀU KHOẢN CHUNG ===

1. Giới thiệu
Chào mừng bạn đến với VHS Platform. Khi đăng ký trở thành Provider, bạn đồng ý tuân thủ các điều khoản và điều kiện được nêu dưới đây.

2. Quyền và Nghĩa vụ của Provider
- Cung cấp dịch vụ đúng thời gian, chất lượng đã cam kết với khách hàng
- Đảm bảo tuân thủ các quy định an toàn lao động và vệ sinh môi trường
- Sử dụng thiết bị, dụng cụ đạt tiêu chuẩn chất lượng
- Giữ bí mật thông tin cá nhân của khách hàng
- Không được từ chối dịch vụ một cách vô lý hoặc phân biệt đối xử

3. Hoa hồng và Thanh toán
- VHS Platform thu phí hoa hồng 15% trên mỗi giao dịch thành công
- Thanh toán được xử lý vào mỗi thứ 6 hàng tuần
- Provider cần cung cấp thông tin tài khoản ngân hàng chính xác để nhận thanh toán

4. Chính sách Hủy và Hoàn tiền
- Provider có thể hủy dịch vụ tối đa 24 giờ trước khi thực hiện mà không bị phạt
- Hủy trong vòng 24 giờ hoặc không thực hiện dịch vụ sẽ bị phạt 50% giá trị dịch vụ
- Khách hàng được hoàn tiền 100% nếu Provider hủy hoặc không thực hiện dịch vụ

5. Chấm dứt Tài khoản
VHS Platform có quyền tạm ngưng hoặc chấm dứt tài khoản Provider nếu vi phạm điều khoản, nhận nhiều đánh giá xấu, hoặc có hành vi gian lận.

6. Thay đổi Điều khoản
VHS Platform có quyền thay đổi điều khoản này. Các thay đổi sẽ được thông báo trước ít nhất 7 ngày.

=== CHÍNH SÁCH BẢO HIỂM ===

1. Bảo hiểm Trách nhiệm
Provider phải có bảo hiểm trách nhiệm dân sự để bảo vệ khách hàng và chính mình trong trường hợp xảy ra sự cố:
- Thiệt hại về tài sản của khách hàng trong quá trình thực hiện dịch vụ
- Thương tích hoặc tai nạn xảy ra với khách hàng do lỗi của Provider
- Chi phí pháp lý liên quan đến các khiếu nại từ khách hàng

2. Mức Bảo hiểm Tối thiểu
Provider cần duy trì bảo hiểm trách nhiệm với mức tối thiểu:
- Thiệt hại tài sản: Tối thiểu 50.000.000 VNĐ/sự cố
- Thương tích cá nhân: Tối thiểu 100.000.000 VNĐ/sự cố
- Chi phí pháp lý: Tối thiểu 20.000.000 VNĐ/vụ việc

3. Chứng nhận Bảo hiểm
- Provider phải cung cấp bản sao hợp đồng bảo hiểm còn hiệu lực
- Bảo hiểm phải được gia hạn trước khi hết hạn
- VHS Platform có quyền yêu cầu xem bảo hiểm bất kỳ lúc nào

4. Trách nhiệm khi Không có Bảo hiểm
- Nếu không duy trì bảo hiểm, Provider chịu hoàn toàn trách nhiệm về mọi thiệt hại
- VHS Platform có quyền tạm ngưng tài khoản cho đến khi Provider cung cấp bảo hiểm hợp lệ

5. Xử lý Khiếu nại
Khi có sự cố:
- Báo cáo ngay cho VHS Platform và công ty bảo hiểm trong vòng 24 giờ
- Cung cấp đầy đủ thông tin và chứng cứ liên quan
- Hợp tác với quá trình điều tra và giải quyết

Tôi xác nhận đã đọc, hiểu rõ và đồng ý với toàn bộ nội dung Chính sách và Điều khoản chung cũng như Chính sách Bảo hiểm của VHS Platform.
Ngày đồng ý: {{AGREEMENT_DATE}}
                            </textarea>
                            
                    <!-- Điều khoản dịch vụ - Collapsible -->
                    <div class="terms-collapsible">
                        <div class="terms-collapsible-header" data-toggle="collapse" data-target="#termsContent">
                            <div class="terms-collapsible-title">
                                <i class="bi bi-file-text" style="color: #0ea5e9; font-size: 24px; margin-right: 12px;"></i>
                                <div>
                                    <h3 style="margin: 0; color: #0ea5e9; font-size: 18px; font-weight: 600;">Chính sách và Điều khoản chung</h3>
                                    <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">Quy định về quyền và nghĩa vụ khi cung cấp dịch vụ</p>
                            </div>
                                </div>
                            <i class="bi bi-chevron-down terms-collapsible-icon"></i>
                                </div>
                        <div class="terms-collapsible-content" id="termsContent">
                            <h6 style="color: #0ea5e9; margin-top: 0;">1. Giới thiệu</h6>
                            <p>Chào mừng bạn đến với VHS Platform. Khi đăng ký trở thành Provider, bạn đồng ý tuân thủ các điều khoản và điều kiện được nêu dưới đây.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">2. Quyền và Nghĩa vụ của Provider</h6>
                            <ul>
                                <li>Provider cam kết cung cấp dịch vụ chất lượng, đúng mô tả và đúng thời gian đã cam kết.</li>
                                <li>Provider chịu trách nhiệm về chất lượng dịch vụ, thiết bị và nhân viên thực hiện dịch vụ.</li>
                                <li>Provider phải có đầy đủ giấy phép kinh doanh hợp lệ và chứng chỉ cần thiết.</li>
                                <li>Provider cam kết bảo mật thông tin khách hàng và không sử dụng cho mục đích khác.</li>
                            </ul>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">3. Chính sách Hủy và Hoàn tiền</h6>
                            <p>Provider phải tuân thủ chính sách hủy và hoàn tiền của platform. Trong trường hợp hủy dịch vụ từ phía Provider mà không có lý do chính đáng, Provider sẽ chịu phạt theo quy định.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">4. Phí dịch vụ và Thanh toán</h6>
                            <p>VHS Platform thu phí hoa hồng 10-15% trên mỗi đơn hàng hoàn thành. Thanh toán sẽ được thực hiện định kỳ hàng tuần/tháng theo thỏa thuận.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">5. Chấm dứt Hợp tác</h6>
                            <p>VHS Platform có quyền tạm ngưng hoặc chấm dứt tài khoản Provider nếu vi phạm điều khoản, nhận nhiều đánh giá xấu, hoặc có hành vi gian lận.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">6. Thay đổi Điều khoản</h6>
                            <p>VHS Platform có quyền thay đổi điều khoản này. Các thay đổi sẽ được thông báo trước ít nhất 7 ngày.</p>
                        </div>
                        </div>

                    <!-- Chính sách bảo hiểm - Collapsible -->
                    <div class="terms-collapsible" style="margin-top: 20px;">
                        <div class="terms-collapsible-header" data-toggle="collapse" data-target="#insuranceContent">
                            <div class="terms-collapsible-title">
                                <i class="bi bi-shield-check" style="color: #10b981; font-size: 24px; margin-right: 12px;"></i>
                                <div>
                                    <h3 style="margin: 0; color: #10b981; font-size: 18px; font-weight: 600;">Chính sách bảo mật thông tin</h3>
                                    <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">Quy định về bảo hiểm trách nhiệm và đảm bảo chất lượng dịch vụ</p>
                    </div>
                </div>
                            <i class="bi bi-chevron-down terms-collapsible-icon"></i>
            </div>
                        <div class="terms-collapsible-content" id="insuranceContent">
                            <h6 style="color: #10b981; margin-top: 0;">1. Bảo hiểm Trách nhiệm</h6>
                            <p>Provider phải có bảo hiểm trách nhiệm dân sự để bảo vệ khách hàng và chính mình trong trường hợp xảy ra sự cố:</p>
                            <ul>
                                <li>Thiệt hại về tài sản của khách hàng trong quá trình thực hiện dịch vụ</li>
                                <li>Thương tích hoặc tai nạn xảy ra với khách hàng do lỗi của Provider</li>
                                <li>Thiệt hại gián tiếp phát sinh từ dịch vụ không đạt chất lượng</li>
                            </ul>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">2. Mức Bảo hiểm Tối thiểu</h6>
                            <p>Provider cần duy trì bảo hiểm trách nhiệm với mức tối thiểu:</p>
                            <ul>
                                <li>Thiệt hại tài sản: Tối thiểu 50.000.000 VNĐ/sự cố</li>
                                <li>Thương tích cá nhân: Tối thiểu 100.000.000 VNĐ/sự cố</li>
                                <li>Thiệt hại gián tiếp: Tối thiểu 20.000.000 VNĐ/sự cố</li>
                            </ul>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">3. Quy trình Bồi thường</h6>
                            <p>Trong trường hợp khách hàng yêu cầu bồi thường:</p>
                            <ol>
                                <li>Khách hàng gửi yêu cầu kèm bằng chứng trong vòng 7 ngày kể từ khi xảy ra sự cố</li>
                                <li>VHS Platform sẽ xem xét và làm trung gian giải quyết</li>
                                <li>Provider phải phối hợp cung cấp thông tin và tham gia giải quyết</li>
                                <li>Quyết định bồi thường sẽ được đưa ra trong vòng 14 ngày làm việc</li>
                            </ol>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">4. Đảm bảo Chất lượng</h6>
                            <p>Provider cam kết:</p>
                            <ul>
                                <li>Sử dụng thiết bị và vật tư đạt chuẩn an toàn</li>
                                <li>Nhân viên được đào tạo và có chứng chỉ cần thiết</li>
                                <li>Tuân thủ quy trình an toàn lao động</li>
                                <li>Có biện pháp phòng ngừa rủi ro trong quá trình cung cấp dịch vụ</li>
                            </ul>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">5. Miễn trừ Trách nhiệm</h6>
                            <p>VHS Platform không chịu trách nhiệm về:</p>
                            <ul>
                                <li>Thiệt hại do lỗi từ phía khách hàng (cung cấp thông tin sai, không tuân thủ hướng dẫn)</li>
                                <li>Sự cố do thiên tai, hỏa hoạn hoặc bất khả kháng</li>
                                <li>Tranh chấp trực tiếp giữa Provider và khách hàng ngoài platform</li>
                            </ul>
                        </div>
                        </div>
                    
                    <!-- Checkbox đồng ý -->
                    <div class="field" style="margin-top: 24px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; background: #fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;" id="termsCheckboxWrapper">
                            <input type="checkbox" id="agreeTerms" style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;" required />
                            <label for="agreeTerms" style="margin: 0; cursor: pointer; font-size: 15px; line-height: 1.5; color: #1e293b;">
                                Tôi đã đọc, hiểu rõ và đồng ý với Chính sách và Điều khoản chung, Chính sách bảo mật thông tin của VHS Platform. <span style="color: #ef4444; font-weight: bold;">*</span>
                            </label>
                    </div>
                        <div id="termsError" class="text-danger small d-none" style="margin-top: 8px; padding-left: 32px;">
                            Bạn phải đồng ý với điều khoản và chính sách để tiếp tục đăng ký.
                </div>
            </div>
                </div>
            </section>

            <div class="actions center">
                <a href="javascript:history.back()" class="btn ghost">Hủy</a>
                <button type="submit" class="btn primary" id="btnSubmit" disabled>Đăng ký Provider</button>
            </div>
        </form>
    </div>
</main>

@section Scripts {
    <script>
        (function () {
          // ===== Avatar =====
          const fileInput   = document.getElementById("ProfileImage");
          const placeholder = document.getElementById("avatarPlaceholder");
          const previewWrap = document.getElementById("avatarPreviewWrap");
          const img         = document.getElementById("imgPreview");
          const fileNameEl  = document.getElementById("fileName");
          const overlayBtn  = document.getElementById("avatarOverlay");
          const isResubmit  = document.getElementById("IsResubmit")?.value === "true";

          placeholder?.addEventListener("click", () => fileInput?.click());
          fileInput?.addEventListener("change", e => {
            const f = e.target.files?.[0]; if (!f) return;
            // validate avatar client-side
            if (!f.type.startsWith("image/")) {
              alert("Ảnh đại diện không hợp lệ.");
              fileInput.value = "";
              return;
            }
            img.src = URL.createObjectURL(f);
            if (fileNameEl) fileNameEl.textContent = f.name;
            placeholder.classList.add("d-none");
            previewWrap.classList.remove("d-none");
          });
          overlayBtn?.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
            previewWrap.classList.add("d-none");
            placeholder.classList.remove("d-none");
            if (fileNameEl) fileNameEl.textContent = "Chưa chọn tệp";
          });

          // ===== Autosize =====
          function wireAutosize(scope){
            scope.querySelectorAll("textarea.autosize, .cert textarea.input").forEach(t=>{
              const resize = ()=>{ t.style.height="auto"; t.style.height=t.scrollHeight+"px"; };
              t.removeEventListener("input", resize);
              t.addEventListener("input", resize);
              resize();
            });
          }
          wireAutosize(document);

          // ===== DANH MỤC & TAGS =====
          const btnSubmit = document.getElementById("btnSubmit");
          const nameEl    = document.getElementById("ProviderName");
          const phoneEl   = document.getElementById("PhoneNumber");
          const descEl    = document.getElementById("Description");
          const agreeTermsEl = document.getElementById("agreeTerms");
          const termsErrorEl = document.getElementById("termsError");
          const termsWrapperEl = document.getElementById("termsCheckboxWrapper");

          // Backend URL
          const BACKEND_URL = '@(ViewBag.BackendUrl ?? "")';
          console.log('🌐 Backend URL:', BACKEND_URL);
          
          // Cache tags data
          const tagsCache = new Map();
          
          // Load tags từ API cho một category
          async function loadTagsForCategory(categoryId) {
            console.log('🔍 Loading tags for category:', categoryId);
            
            // Kiểm tra cache
            if (tagsCache.has(categoryId)) {
              console.log('✅ Found in cache:', tagsCache.get(categoryId));
              return tagsCache.get(categoryId);
            }
            
            try {
              const url = `${BACKEND_URL}/api/tag?categoryId=${categoryId}&includeDeleted=false`;
              console.log('📡 Fetching:', url);
              
              const response = await fetch(url);
              console.log('📥 Response status:', response.status);
              
              if (!response.ok) {
                console.error('❌ Failed to load tags:', response.status);
                const errorText = await response.text();
                console.error('Error details:', errorText);
                return [];
              }
              
              const tags = await response.json();
              console.log('✅ Loaded tags:', tags);
              
              tagsCache.set(categoryId, tags);
              return tags;
            } catch (error) {
              console.error('❌ Error loading tags:', error);
              return [];
            }
          }
          
          // Render tags vào container
          function renderTags(categoryId, tags) {
            console.log('🎨 Rendering tags for category:', categoryId, 'Tags count:', tags.length);
            
            const container = document.querySelector(`[data-tags-container="${categoryId}"]`);
            if (!container) {
              console.error('❌ Container not found for category:', categoryId);
                  return;
                }
            
            console.log('📦 Container found:', container);
            
            if (tags.length === 0) {
              console.log('⚠️ No tags available for this category');
              container.innerHTML = '<p class="text-muted small" style="margin: 0;">Chưa có dịch vụ cụ thể cho danh mục này.</p>';
              return;
            }
            
            container.innerHTML = '';
            tags.forEach(tag => {
              console.log('➕ Adding tag:', tag.name, 'ID:', tag.tagId);
              const label = document.createElement('label');
              label.className = 'tag-checkbox';
              label.innerHTML = `
                <input type="checkbox" name="SelectedTags" value="${tag.tagId}" data-category-id="${categoryId}" />
                <span class="tag-text">${tag.name}</span>
              `;
              container.appendChild(label);
              
              // Add event listener để xóa lỗi khi chọn tag
              const tagCheckbox = label.querySelector('input[type="checkbox"]');
              tagCheckbox.addEventListener('change', function() {
                const catId = this.dataset.categoryId;
                const categoryCard = document.querySelector(`[data-category-id="${catId}"]`);
                const tagsChecked = document.querySelectorAll(`[data-category="${catId}"] input[name="SelectedTags"]:checked`);
                const tagError = categoryCard?.querySelector('.tag-error');
                
                // Ẩn lỗi nếu đã chọn ít nhất 1 tag
                if (tagsChecked.length > 0 && tagError) {
                  tagError.style.display = 'none';
                }
                
              enableSubmit();
              });
            });
            
            console.log('✅ Rendered', tags.length, 'tags');
          }
          
          // Handle category selection and show/hide tags (CHECKBOX - chọn nhiều)
          document.querySelectorAll('.category-checkbox').forEach(checkbox => {
            console.log('✅ Category checkbox found:', checkbox.id, checkbox.value);
            
            checkbox.addEventListener('change', async function() {
              console.log('🔄 Category checkbox changed:', this.id, 'Checked:', this.checked);
              
              const categoryId = this.value;
              const tagsSection = document.querySelector(`.category-tags[data-category="${categoryId}"]`);
              
              console.log('📍 Tags section:', tagsSection);
              
              if (this.checked) {
                // Show tags for selected category
                if (tagsSection) {
                  console.log('👁️ Showing tags section');
                  tagsSection.style.display = 'block';
                  
                  // Load tags nếu chưa có
                  const container = tagsSection.querySelector(`[data-tags-container="${categoryId}"]`);
                  console.log('📦 Tags container:', container);
                  
                  const hasLoading = container?.querySelector('.tags-loading');
                  console.log('⏳ Has loading indicator:', !!hasLoading);
                  
                  // Load tags (cho dù đã load hay chưa để refresh)
                  if (container) {
                    console.log('🚀 Loading tags...');
                    const tags = await loadTagsForCategory(categoryId);
                    renderTags(categoryId, tags);
                  }
                }
              } else {
                // Hide tags và uncheck tất cả tags của category này
                if (tagsSection) {
                  console.log('🙈 Hiding tags section');
                  tagsSection.style.display = 'none';
                  tagsSection.querySelectorAll('input[name="SelectedTags"]').forEach(tag => {
                    tag.checked = false;
                  });
                }
              }
              
            enableSubmit();
            });
          });
          
          // Business License file upload
          const licenseInput = document.getElementById('BusinessLicenses');
          const licenseFileName = document.getElementById('licenseFileName');
          const licensePreviews = document.getElementById('licensePreviews');
          
          const licenseFiles = [];
          
          // Sync files to input element
          function syncLicenseFiles() {
            if (!licenseInput) return;
            
            const dt = new DataTransfer();
            licenseFiles.forEach(f => dt.items.add(f));
            licenseInput.files = dt.files;
          }
          
          licenseInput?.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files || []);
            
            newFiles.forEach(f => {
              if (!f.type.startsWith('image/')) {
                alert(`Tệp ${f.name} không phải là ảnh.`);
                return;
              }
              
              const signature = `${f.name}|${f.size}|${f.lastModified}`;
              const exists = licenseFiles.some(existing => 
                `${existing.name}|${existing.size}|${existing.lastModified}` === signature
              );
              
              if (!exists) {
                licenseFiles.push(f);
              }
            });
            
            // Sync và update preview
            syncLicenseFiles();
            renderLicensePreviews();
            
            // Update file name display
            if (licenseFileName) {
              licenseFileName.textContent = licenseFiles.length > 0 
                ? `${licenseFiles.length} tệp đã chọn` 
                : 'Chưa chọn tệp';
            }
            
            // Reset input value để cho phép chọn lại cùng file
            e.target.value = '';
          });
          
          function renderLicensePreviews() {
            if (!licensePreviews) return;
            
            licensePreviews.innerHTML = '';
            licenseFiles.forEach((f, idx) => {
              const url = URL.createObjectURL(f);
              const fig = document.createElement('figure');
              fig.className = 'thumb';
              fig.dataset.imageUrl = url;
              fig.dataset.imageName = f.name;
              fig.innerHTML = `
                <img src="${url}" alt="${f.name}">
                <button type="button" class="thumb-del" data-index="${idx}" aria-label="Xóa">×</button>
              `;
              licensePreviews.appendChild(fig);
            });
            
            // Add click event for image zoom
            document.querySelectorAll('#licensePreviews .thumb').forEach(thumb => {
              thumb.addEventListener('click', (e) => {
                // Don't zoom if clicking delete button
                if (e.target.closest('.thumb-del')) return;
                openImageModal(thumb.dataset.imageUrl, thumb.dataset.imageName);
              });
            });
          }
          
          // Function to open image modal
          function openImageModal(imageUrl, imageName) {
            // Remove existing modal if any
            const existingModal = document.querySelector('.image-modal-overlay');
            if (existingModal) existingModal.remove();
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'image-modal-overlay';
            modal.innerHTML = `
              <div class="image-modal-content">
                <button class="image-modal-close" aria-label="Đóng">×</button>
                <img src="${imageUrl}" alt="${imageName}">
              </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal with animation
            setTimeout(() => modal.classList.add('active'), 10);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Close button
            modal.querySelector('.image-modal-close').addEventListener('click', () => closeImageModal(modal));
            
            // Click overlay to close
            modal.addEventListener('click', (e) => {
              if (e.target === modal) closeImageModal(modal);
            });
            
            // Escape key to close
            const escHandler = (e) => {
              if (e.key === 'Escape') {
                closeImageModal(modal);
                document.removeEventListener('keydown', escHandler);
              }
            };
            document.addEventListener('keydown', escHandler);
          }
          
          // Function to close image modal
          function closeImageModal(modal) {
            modal.classList.remove('active');
            setTimeout(() => {
              modal.remove();
              document.body.style.overflow = '';
            }, 300);
          }
          
          // Remove license image
          licensePreviews?.addEventListener('click', (e) => {
            const btn = e.target.closest('.thumb-del');
            if (!btn) return;
            
            e.stopPropagation(); // Prevent triggering zoom
            
            const idx = Number(btn.dataset.index);
            if (idx >= 0 && idx < licenseFiles.length) {
              licenseFiles.splice(idx, 1);
              syncLicenseFiles();
              renderLicensePreviews();
              
              if (licenseFileName) {
                licenseFileName.textContent = licenseFiles.length > 0 
                  ? `${licenseFiles.length} tệp đã chọn` 
                  : 'Chưa chọn tệp';
              }
            }
          });

          // Enable submit (Tên + Category)
          function enableSubmit(){
            const okName = (nameEl?.value.trim().length || 0) > 0;
            const okCat = document.querySelector('.category-checkbox:checked') !== null;
            btnSubmit.disabled = !(okName && okCat);
          }
          nameEl?.addEventListener("input", enableSubmit);

          // ===== init =====
          // Hide all tag sections initially
          document.querySelectorAll('.category-tags').forEach(tags => {
            tags.style.display = 'none';
          });
          
          enableSubmit();

          // Submit AJAX JSON — loại bỏ redirect/banner
          const form = document.getElementById("providerForm");
          form?.addEventListener("submit", async (ev) => {
            // comprehensive validation for resubmit (Rejected)
            const errors = [];

            const providerName = nameEl?.value?.trim() || "";
            const phoneTrim    = phoneEl?.value?.trim() || "";
            const descVal      = descEl?.value || "";

            // basic field validation - BẮT BUỘC TẤT CẢ
            if (providerName.length === 0) {
              errors.push({ msg: "Vui lòng nhập tên Provider.", el: nameEl });
              nameEl?.classList.add('is-invalid');
            } else {
              nameEl?.classList.remove('is-invalid');
            }

            // BẮT BUỘC ảnh đại diện (cho cả lần đầu và resubmit)
            if (!fileInput?.files || fileInput.files.length === 0) {
              errors.push({ msg: "Vui lòng chọn ảnh đại diện.", el: fileInput });
              placeholder?.classList.add('is-invalid');
            } else {
              placeholder?.classList.remove('is-invalid');
            }

            // Validate phone number format (nếu có nhập)
            if (phoneTrim.length > 0) {
              const phoneRegex = /^[0-9]{10,11}$/;
              if (!phoneRegex.test(phoneTrim)) {
                errors.push({ msg: "Số điện thoại phải có 10-11 chữ số.", el: phoneEl });
                phoneEl?.classList.add('is-invalid');
              } else {
                phoneEl?.classList.remove('is-invalid');
              }
            }

            // BẮT BUỘC mô tả Provider
            if (descVal.trim().length === 0) {
              errors.push({ msg: "Vui lòng nhập mô tả dịch vụ.", el: descEl });
              descEl?.classList.add('is-invalid');
            } else {
              descEl?.classList.remove('is-invalid');
            }

            // BẮT BUỘC đồng ý điều khoản và bảo hiểm
            if (!agreeTermsEl?.checked) {
              errors.push({ msg: "Bạn phải đồng ý với Điều khoản dịch vụ.", el: agreeTermsEl });
              termsWrapperEl?.classList.add('error');
              termsWrapperEl?.classList.remove('checked');
              termsErrorEl?.classList.remove('d-none');
            } else {
              termsWrapperEl?.classList.remove('error');
              termsWrapperEl?.classList.add('checked');
              termsErrorEl?.classList.add('d-none');
            }

            // BẮT BUỘC chọn ít nhất 1 danh mục
            const selectedCategories = document.querySelectorAll('.category-checkbox:checked');
            const categoryError = document.getElementById('categoryError');
            if (selectedCategories.length === 0) {
              errors.push({ msg: "Vui lòng chọn ít nhất 1 danh mục dịch vụ.", el: null });
              categoryError?.classList.remove('d-none');
            } else {
              categoryError?.classList.add('d-none');
            }
            
            // BẮT BUỘC: Mỗi category đã chọn phải có ít nhất 1 tag
            selectedCategories.forEach(catCheckbox => {
              const categoryId = catCheckbox.value;
              const categoryName = catCheckbox.dataset.categoryName || 'danh mục này';
              const tagsChecked = document.querySelectorAll(`[data-category="${categoryId}"] input[name="SelectedTags"]:checked`);
              
              // Tìm hoặc tạo error element cho category này
              const categoryCard = catCheckbox.closest('.category-card');
              let tagError = categoryCard?.querySelector('.tag-error');
              
              if (tagsChecked.length === 0) {
                errors.push({ msg: `Vui lòng chọn ít nhất 1 dịch vụ cụ thể cho "${categoryName}".`, el: null });
                
                // Hiển thị lỗi trong category card
                if (!tagError && categoryCard) {
                  tagError = document.createElement('div');
                  tagError.className = 'tag-error text-danger small mt-2';
                  tagError.style.marginLeft = '20px';
                  tagError.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Vui lòng chọn ít nhất 1 dịch vụ cụ thể.';
                  categoryCard.querySelector('.category-tags')?.appendChild(tagError);
                }
                if (tagError) tagError.style.display = 'block';
              } else {
                // Xóa lỗi nếu đã chọn tags
                if (tagError) tagError.style.display = 'none';
              }
            });
              
              // BẮT BUỘC tải lên ít nhất 1 hình giấy phép
            const licenseError = document.getElementById('licenseError');
            syncLicenseFiles(); // Sync trước khi validate
            
            if (licenseFiles.length === 0) {
              errors.push({ msg: "Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh.", el: licenseInput });
              licenseError?.classList.remove('d-none');
              licenseInput?.classList.add('is-invalid');
              } else {
              licenseError?.classList.add('d-none');
              licenseInput?.classList.remove('is-invalid');
              }

            // file constraints and total size <= 50MB
            const MAX_TOTAL = 50 * 1024 * 1024;
            let totalBytes = 0;
            const allFiles = [];
            
            // Add profile image
            if (fileInput?.files?.[0]) allFiles.push(fileInput.files[0]);
            
            // Add business license images
            licenseFiles.forEach(f => allFiles.push(f));
            
            console.log('=== SUBMIT DEBUG ===');
            console.log('Profile image:', fileInput?.files?.length || 0);
            console.log('Business licenses:', licenseFiles.length);
            console.log('Total files to submit:', allFiles.length);
            
            allFiles.forEach(f => {
              if (!f.type.startsWith('image/')) errors.push({ msg: 'Tệp không hợp lệ (không phải ảnh).', el: null });
              totalBytes += f.size;
            });
            if (totalBytes > MAX_TOTAL) {
              errors.push({ msg: 'Tổng dung lượng tệp vượt quá 50MB.', el: null });
            }

            if (errors.length > 0) {
              ev.preventDefault();
              
              // Scroll đến trường có lỗi đầu tiên và focus
              const first = errors[0];
              if (first.el) {
                // Special handling for terms checkbox
                if (first.el === agreeTermsEl) {
                  scrollToTermsError();
                } else {
                  first.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  setTimeout(() => {
                    if (typeof first.el.focus === 'function') {
                      first.el.focus();
                    }
                  }, 500);
                }
              }
              
              return;
            }

            // trim values before submit
            if (nameEl) nameEl.value = providerName;
            if (phoneEl) phoneEl.value = phoneTrim;

            // QUAN TRỌNG: Sync files vào input trước khi submit
            syncLicenseFiles();
            console.log(`Final sync - License files:`, licenseInput?.files?.length || 0);

            ev.preventDefault();
            btnSubmit.disabled = true;
            const oldText = btnSubmit.textContent;
            btnSubmit.textContent = "Đang gửi...";

            try {
              // Map từ SelectedCategories + SelectedTags sang Certificates[] structure cho backend
              const fd = new FormData();
              
              // ✅ CRITICAL: Add AntiForgery Token!
              const antiForgeryToken = form.querySelector('input[name="__RequestVerificationToken"]');
              if (antiForgeryToken) {
                fd.append('__RequestVerificationToken', antiForgeryToken.value);
                console.log('✅ AntiForgery token added');
              } else {
                console.warn('⚠️ No AntiForgery token found!');
              }
              
              // Add basic fields
              fd.append('ProviderName', providerName);
              if (phoneTrim) fd.append('PhoneNumber', phoneTrim);
              fd.append('Description', descVal);
              
              // ✅ Terms & Insurance với timestamp đồng ý
              const now = new Date();
              const vietnamTime = new Date(now.getTime() + (7 * 60 * 60 * 1000)); // UTC+7
              const agreementDate = vietnamTime.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
              });
              
              fd.append('TermsInsurance.Title', form.querySelector('#TI_Title')?.value || '');
              const termsDescription = (form.querySelector('#TI_Description')?.value || '').replace('{{AGREEMENT_DATE}}', agreementDate);
              fd.append('TermsInsurance.Description', termsDescription);
              
              // Add profile image
              if (fileInput?.files?.[0]) {
                fd.append('ProfileImage', fileInput.files[0]);
              }
              
              // Map categories sang Certificates structure
              selectedCategories.forEach((catCheckbox, index) => {
                const categoryId = catCheckbox.value;
                const categoryName = catCheckbox.dataset.categoryName || '';
                
                // Get selected tags for this category (lấy cả name)
                const tagsForCategory = Array.from(
                  document.querySelectorAll(`[data-category="${categoryId}"] input[name="SelectedTags"]:checked`)
                ).map(tagCheckbox => {
                  // Lấy text từ label parent
                  const label = tagCheckbox.closest('label');
                  const tagText = label?.querySelector('.tag-text')?.textContent || '';
                  return {
                    id: tagCheckbox.value,
                    name: tagText.trim()
                  };
                });
                
                // Create Certificate entry
                fd.append(`Certificates[${index}].CategoryId`, categoryId);
                
                // *** QUAN TRỌNG: Gửi TagIds cho từng certificate ***
                tagsForCategory.forEach(tag => {
                  fd.append(`Certificates[${index}].TagIds`, tag.id);
                });
                
                // ✅ KHÔNG GỬI Description - field này không dùng nữa
                // Chỉ dùng CategoryId và TagIds
              });
              
              // Add business license files (chia đều cho các certificates)
              licenseFiles.forEach((file, fileIndex) => {
                const certIndex = fileIndex % selectedCategories.length; // Distribute files across certificates
                fd.append(`Certificates[${certIndex}].BusinessLicenses`, file);
              });
              
              // Debug: log FormData contents
              console.log('=== FORMDATA DEBUG ===');
              for (let [key, value] of fd.entries()) {
                if (value instanceof File) {
                  console.log(`${key}: File(${value.name}, ${value.size} bytes)`);
                } else {
                  console.log(`${key}: ${value}`);
                }
              }
              
              // GỬI ĐẾN MVC CONTROLLER - Controller sẽ gọi service
              const res = await fetch(form.action, { 
                method: 'POST', 
                headers: { 'X-Requested-With': 'XMLHttpRequest' }, 
                body: fd 
              });

              if (res.status === 200) {
                const ok = await res.json(); // { ok: true, providerId, status, refresh } OR { ok:false,... }
                if (!ok || ok.ok !== true) {
                  alert(ok?.message || 'Đăng ký thất bại.');
                } else if (ok.refresh) {
                  localStorage.removeItem('myProvider');
                  window.location.reload();
                } else {
                  window.location.href = `${form.getAttribute('data-success') || '/Customer/RegisterProvider/Success'}?id=${encodeURIComponent(ok.providerId)}&stat=${encodeURIComponent(ok.status)}`;
                }
                return;
              }

              // lỗi 409 hoặc 400
              let err; try { err = await res.json(); } catch { err = { Message: 'Đăng ký thất bại.' }; }
              const msg = err?.Message || err?.message || 'Đăng ký thất bại.';
              const detail = err?.Detail || err?.detail;
              const errorType = err?.Type || '';
              
              // Log chi tiết để debug
              console.error('=== REGISTRATION ERROR ===');
              console.error('Status:', res.status);
              console.error('Message:', msg);
              console.error('Detail:', detail);
              console.error('Type:', errorType);
              console.error('Full error:', err);
              
              // Hiển thị lỗi trong validation summary
              const validationSummary = document.querySelector('.validation-summary-errors ul') || 
                                       document.querySelector('.alert.alert-danger');
              if (validationSummary && validationSummary.tagName === 'UL') {
                validationSummary.innerHTML = `<li>${msg}${detail ? ` - ${detail}` : ''}</li>`;
                validationSummary.closest('.validation-summary-errors')?.classList.remove('d-none');
                validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
              } else {
                // Fallback: show alert if no validation summary
                alert(detail ? `${msg}\n\nChi tiết: ${detail}` : msg);
              }

              // map Errors[].Field
              if (Array.isArray(err?.Errors) || Array.isArray(err?.errors)) {
                const list = err.Errors || err.errors;
                const m = (field) => {
                  if (!field) return null;
                  const fieldUpper = field.toUpperCase();
                  if (fieldUpper === 'PROVIDERNAME') return nameEl;
                  if (fieldUpper === 'PHONENUMBER') return phoneEl;
                  if (fieldUpper === 'DESCRIPTION') return descEl;
                  if (fieldUpper === 'PROFILEIMAGE') return fileInput;
                  if (fieldUpper === 'SELECTEDCATEGORIES' || fieldUpper === 'CATEGORYID') return document.querySelector('.category-checkbox:checked');
                  if (fieldUpper === 'BUSINESSLICENSES') return licenseInput;
                  if (fieldUpper === 'SELECTEDTAGS') return document.querySelector('input[name="SelectedTags"]:checked');
                  return null;
                };
                const first = list.find(e => !!(e.Field || e.field));
                const el = first ? m(first.Field || first.field) : null;
                if (el && el.classList) el.classList.add('is-invalid');
                if (el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth',block:'center'});
                if (el && el.focus) el.focus();
              }
            } catch (ex) {
              alert('Không thể gửi đăng ký. Vui lòng thử lại.');
            } finally {
              btnSubmit.disabled = false;
              btnSubmit.textContent = oldText || 'Đăng ký Provider';
            }
          });

          // ===== COLLAPSIBLE TERMS & INSURANCE HANDLERS =====
          
          // Handle collapsible sections
          document.querySelectorAll('.terms-collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
              const targetId = this.getAttribute('data-target');
              const content = document.querySelector(targetId);
              const icon = this.querySelector('.terms-collapsible-icon');
              
              if (content) {
                const isOpen = content.classList.contains('open');
                
                if (isOpen) {
                  // Đóng
                  content.classList.remove('open');
                  icon?.classList.remove('rotate');
                } else {
                  // Mở
                  content.classList.add('open');
                  icon?.classList.add('rotate');
                }
              }
            });
          });

          // Handle checkbox change with animation
          agreeTermsEl?.addEventListener('change', () => {
            if (agreeTermsEl.checked) {
              termsWrapperEl?.classList.add('checked');
              termsWrapperEl?.classList.remove('error');
              termsErrorEl?.classList.add('d-none');
            } else {
              termsWrapperEl?.classList.remove('checked');
            }
          });

          // Handle clicking on wrapper
          termsWrapperEl?.addEventListener('click', (e) => {
            // Only toggle checkbox if not clicking on the checkbox itself
            if (e.target !== agreeTermsEl) {
              agreeTermsEl.checked = !agreeTermsEl.checked;
              agreeTermsEl.dispatchEvent(new Event('change'));
            }
          });

          // Add smooth scroll to terms section if there's an error
          function scrollToTermsError() {
            if (termsWrapperEl) {
              termsWrapperEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              termsWrapperEl.classList.add('error');
              setTimeout(() => {
                termsWrapperEl.classList.remove('error');
              }, 2000);
            }
          }

          // ===== Map API error (TempData banner) to fields =====
          // Bỏ map banner vì dùng flow JSON (AJAX)
          const apiErrEl = null;
          if (apiErrEl) {
            const msg = apiErrEl.textContent || "";
            function mark(el){ if(!el) return; el.classList.add('is-invalid'); try{ el.focus(); }catch{} }
            function scrollToEl(el){ if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); }
            if (msg.includes('Vui lòng nhập tên Provider')) { mark(nameEl); scrollToEl(nameEl); }
            else if (msg.includes('Vui lòng chọn danh mục')) {
              const cat = document.querySelector('.category-radio:checked');
              scrollToEl(cat || document.querySelector('.category-grid'));
            }
            else if (msg.includes('Vui lòng chọn ảnh đại diện')) { scrollToEl(placeholder || fileInput); }
            else if (msg.includes('Vui lòng tải lên ít nhất 1 hình giấy phép')) {
              mark(licenseInput); scrollToEl(licenseInput);
            }
            else if (msg.includes('Ảnh đại diện không hợp lệ')) { mark(fileInput); scrollToEl(fileInput); }
          }

          // Map BE Errors[] with Field to exact inputs (from TempData if fallback used)
          const apiErrorsJson = '@(TempData["ApiErrorsJson"] ?? "")';
          if (apiErrorsJson) {
            try {
              const errs = JSON.parse(apiErrorsJson);
              const fieldToEl = (field) => {
                if (!field) return null;
                const fieldUpper = field.toUpperCase();
                if (fieldUpper === 'PROVIDERNAME') return nameEl;
                if (fieldUpper === 'PHONENUMBER') return phoneEl;
                if (fieldUpper === 'DESCRIPTION') return descEl;
                if (fieldUpper === 'PROFILEIMAGE') return fileInput;
                if (fieldUpper === 'SELECTEDCATEGORIES' || fieldUpper === 'CATEGORYID') return document.querySelector('.category-checkbox:checked');
                if (fieldUpper === 'BUSINESSLICENSES') return licenseInput;
                if (fieldUpper === 'SELECTEDTAGS') return document.querySelector('input[name="SelectedTags"]:checked');
                return null;
              };
              let firstEl = null;
              errs.forEach(e => {
                const el = fieldToEl(e.Field);
                if (el && el.classList) el.classList.add('is-invalid');
                if (!firstEl && el) firstEl = el;
              });
              if (firstEl && firstEl.scrollIntoView) firstEl.scrollIntoView({behavior:'smooth',block:'center'});
              if (firstEl && firstEl.focus) firstEl.focus();
            } catch {}
          }
        })();
    </script>
}

@{
    ViewData["Title"] = "Đăng ký Provider";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = (IEnumerable<dynamic>)ViewBag.Categories;
}

@section Styles {
    <link rel="stylesheet" href="~/css/register-provider.css" asp-append-version="true" />
    @* <style> *@
    @*     /* preview */ *@
    @*     .img-grid.bl-previews { *@
    @*         display: flex; *@
    @*         flex-wrap: wrap; *@
    @*         gap: 12px; *@
    @*         margin-top: 10px *@
    @*     } *@

    @*     .img-grid .thumb { *@
    @*         position: relative; *@
    @*         width: 108px; *@
    @*         height: 108px; *@
    @*         border-radius: 10px; *@
    @*         overflow: hidden; *@
    @*         background: #f3f5f9 *@
    @*     } *@

    @*         .img-grid .thumb img { *@
    @*             width: 100%; *@
    @*             height: 100%; *@
    @*             object-fit: cover; *@
    @*             display: block *@
    @*         } *@

    @*         .img-grid .thumb .thumb-del { *@
    @*             position: absolute; *@
    @*             top: 6px; *@
    @*             right: 6px; *@
    @*             width: 22px; *@
    @*             height: 22px; *@
    @*             border-radius: 50%; *@
    @*             border: 0; *@
    @*             background: #0f172a; *@
    @*             color: #fff; *@
    @*             opacity: .85; *@
    @*             cursor: pointer; *@
    @*             line-height: 22px; *@
    @*             text-align: center *@
    @*         } *@

    @*             .img-grid .thumb .thumb-del:hover { *@
    @*                 opacity: 1 *@
    @*             } *@

    @*     .avatar-tile { *@
    @*         width: 192px; *@
    @*         height: 144px; *@
    @*         border: 1px dashed var(--border,#e5e7eb); *@
    @*         border-radius: 12px; *@
    @*         display: flex; *@
    @*         flex-direction: column; *@
    @*         align-items: center; *@
    @*         justify-content: center; *@
    @*         background: #f8fafc; *@
    @*         color: #334155 *@
    @*     } *@

    @*     .avatar-wrap .avatar-img-wrap { *@
    @*         width: 192px; *@
    @*         aspect-ratio: 4/3; *@
    @*         border: 1px solid var(--border,#e5e7eb); *@
    @*         border-radius: 12px; *@
    @*         overflow: hidden; *@
    @*         position: relative; *@
    @*         background: #f8fafc *@
    @*     } *@

    @*     .avatar-wrap .avatar-img { *@
    @*         width: 100%; *@
    @*         height: 100%; *@
    @*         object-fit: cover; *@
    @*         display: block *@
    @*     } *@

    @*     .avatar-overlay { *@
    @*         position: absolute; *@
    @*         right: 6px; *@
    @*         top: 6px; *@
    @*         background: #0f172a; *@
    @*         color: #fff; *@
    @*         border: 0; *@
    @*         border-radius: 50%; *@
    @*         width: 24px; *@
    @*         height: 24px; *@
    @*         line-height: 24px; *@
    @*         text-align: center; *@
    @*         opacity: .9 *@
    @*     } *@

    @*         .avatar-overlay:hover { *@
    @*             opacity: 1 *@
    @*         } *@

    @*     .btn.dashed { *@
    @*         border: 1px dashed var(--border,#e5e7eb) *@
    @*     } *@

    @*     .file-row { *@
    @*         margin-top: 10px; *@
    @*         display: flex; *@
    @*         align-items: center; *@
    @*         gap: 12px *@
    @*     } *@

    @*     .file-input { *@
    @*         display: none *@
    @*     } *@

    @*     .file-actions .btn.ghost { *@
    @*         border: 1px solid var(--border,#e5e7eb) *@
    @*     } *@

    @*     .cert { *@
    @*         background: #f8fafc; *@
    @*         border: 1px solid #eef2f7; *@
    @*         border-radius: 12px; *@
    @*         padding: 14px 14px 16px; *@
    @*         margin-bottom: 14px *@
    @*     } *@

    @*     .cert__head { *@
    @*         display: flex; *@
    @*         align-items: center; *@
    @*         gap: 10px; *@
    @*         margin-bottom: 10px *@
    @*     } *@

    @*     .pill { *@
    @*         display: inline-flex; *@
    @*         align-items: center; *@
    @*         justify-content: center; *@
    @*         width: 28px; *@
    @*         height: 28px; *@
    @*         border-radius: 999px; *@
    @*         background: #0ea5e9; *@
    @*         color: #fff; *@
    @*         font-weight: 700 *@
    @*     } *@

    @*     .iconbtn.close { *@
    @*         background: none; *@
    @*         border: 0; *@
    @*         font-size: 22px; *@
    @*         line-height: 1; *@
    @*         color: #ef4444; *@
    @*         margin-left: auto *@
    @*     } *@

    @*     .muted { *@
    @*         color: #667085 *@
    @*     } *@
    @* </style> *@
}

<main class="rp">
    <div class="rp__container">
        <header class="rp__header">
            <h1>Đăng ký Provider</h1>
            <p>Điền thông tin để bắt đầu hợp tác cùng chúng tôi</p>
        </header>

        @if (ViewBag.ExistingStatus is string st && st.Equals("Rejected", StringComparison.OrdinalIgnoreCase))
        {
            <div class="alert alert-warning" role="alert" style="max-width:1120px;margin:0 auto 16px;">
                <strong>Hồ sơ của bạn đã bị từ chối.</strong> Vui lòng gửi lại toàn bộ thông tin và tải lên ảnh đại diện cùng giấy phép kinh doanh mới.
            </div>
        }

        @* Banner lỗi tổng đã được loại bỏ trong flow mới (AJAX JSON), giữ lại khung để có thể tái dùng nếu cần) *@

        <form id="providerForm" method="post"
              asp-area="Customer" asp-controller="RegisterProvider" asp-action="RegisterFallback"
              enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" id="IsResubmit" value="@(string.Equals(ViewBag.ExistingStatus as string, "Rejected", StringComparison.OrdinalIgnoreCase) ? "true" : "false")" />

            @* @if (ViewBag.ExistingProviderId != null) *@
            @* { *@
            @*     <input type="hidden" name="ProviderId" value="@ViewBag.ExistingProviderId" /> *@
            @* } *@

            <!-- THÔNG TIN -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-person"></i></span>
                    <div>
                        <h2>Thông tin Provider</h2>
                        <p>Vui lòng cung cấp thông tin chi tiết về dịch vụ của bạn</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Avatar -->
                    <div class="field">
                        <label for="ProfileImage">Ảnh đại diện</label>
                        <button type="button" id="avatarPlaceholder" class="avatar-tile" aria-label="Chọn ảnh từ tệp">
                            <div class="tile-icon">📷</div>
                            <div class="tile-text">Chọn từ tệp</div>
                        </button>

                        <div id="avatarPreviewWrap" class="avatar-wrap d-none">
                            <div class="avatar-img-wrap">
                                <img id="imgPreview" class="avatar-img" alt="Ảnh đại diện" src="~/images/placeholder-avatar.png" />
                                <button type="button" id="avatarOverlay" class="avatar-overlay" title="Xóa ảnh"><span class="overlay-x">×</span></button>
                            </div>

                            <div class="file-row">
                                <input type="file" id="ProfileImage" name="ProfileImage" accept="image/*" class="file-input" />
                                <div class="file-actions">
                                    <span id="fileName" class="file-name">Chưa chọn tệp</span>
                                    <label for="ProfileImage" class="btn ghost">Chọn tệp khác</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="ProviderName">Tên Provider <span class="req">*</span></label>
                        <input id="ProviderName" name="ProviderName" class="input" maxlength="100"
                               placeholder="VD: Sửa chữa điện Minh Anh" required />
                    </div>

                    <div class="field">
                        <label for="PhoneNumber">Số điện thoại</label>
                        <input id="PhoneNumber" name="PhoneNumber" class="input" inputmode="tel" maxlength="20"
                               placeholder="0912 345 678" />
                    </div>

                    <div class="field">
                        <label for="Description">Mô tả dịch vụ</label>
                        <textarea id="Description" name="Description" class="input autosize" rows="3"
                                  placeholder="Kinh nghiệm, phạm vi phục vụ, điểm mạnh..."></textarea>
                    </div>
                </div>
            </section>

            <!-- CHỨNG CHỈ -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-file-earmark-text"></i></span>
                    <div>
                        <h2>Chứng chỉ &amp; Danh mục</h2>
                        <p>Thêm tối đa 2 chứng chỉ, mỗi chứng chỉ tương ứng với 1 danh mục dịch vụ</p>
                    </div>
                </div>

                <div class="card__body" id="certList">
                    <!-- item 0 -->
                    <div class="cert" data-index="0">
                        <div class="cert__head">
                            <span class="pill">1</span>
                            <strong>Chứng chỉ 1</strong>
                            <button type="button" class="iconbtn close btn-remove-cert d-none" aria-label="Xóa">×</button>
                        </div>

                        <div class="field">
                            <label>Danh mục dịch vụ <span class="req">*</span></label>
                            <select class="input" name="Certificates[0].CategoryId" required>
                                <option value="">Chọn danh mục</option>
                                @foreach (var c in categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                                <div class="field-error text-danger small d-none">Vui lòng chọn danh mục cho chứng chỉ 1.</div>
                        </div>

                        <div class="field">
                            <label for="BL_0">Hình ảnh giấy phép kinh doanh (có thể chọn nhiều)</label>
                            <input id="BL_0" type="file" name="Certificates[0].BusinessLicenses" class="file-input bl-input"
                                   accept="image/*" multiple />
                            <div class="file-actions">
                                <span class="file-name bl-name">Chưa chọn tệp</span>
                                <label for="BL_0" class="btn ghost">Chọn ảnh</label>
                            </div>
                            <div class="img-grid bl-previews" aria-live="polite"></div>
                            <div class="field-error text-danger small d-none">Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh mới.</div>
                        </div>

                        <div class="field">
                            <label>Mô tả dịch vụ kinh doanh</label>
                            <textarea class="input autosize" rows="3" name="Certificates[0].Description"
                                      placeholder="Mô tả ngắn, năm cấp, đơn vị cấp..."></textarea>
                            <div class="field-error text-danger small d-none">Vui lòng nhập mô tả cho chứng chỉ 1.</div>
                        </div>
                    </div>

                    <button type="button" id="btnAddCert" class="btn dashed full">+ Thêm chứng chỉ</button>
                </div>
            </section>

            <!-- ĐIỀU KHOẢN & BẢO HIỂM -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-shield-check"></i></span>
                    <div>
                        <h2>Điều khoản &amp; Bảo hiểm</h2>
                        <p>Khung này gộp cả điều khoản và bảo hiểm. Provider tự điền theo mẫu Title/Description.</p>
                    </div>
                </div>

                <div class="card__body">
                    <div class="boxed">
                        <div class="boxed__head">
                            <h3>Nội dung (Title / Description)</h3>
                            <p class="muted">Chỉ còn 2 trường phẳng theo schema DB.</p>
                        </div>
                        <div class="boxed__body">
                            <div class="field">
                                <label for="TI_Title">Title <span class="req">*</span></label>
                                <input id="TI_Title" name="TermsInsurance.Title" class="input" maxlength="255"
                                       placeholder="VD: Điều khoản & Bảo hiểm áp dụng" required />
                            </div>
                            <div class="field">
                                <label for="TI_Description">Description</label>
                                <textarea id="TI_Description" name="TermsInsurance.Description" class="input autosize" rows="5"
                                          placeholder="Mô tả chi tiết về điều khoản hợp tác và bảo hiểm..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="actions center">
                <a href="javascript:history.back()" class="btn ghost">Hủy</a>
                <button type="submit" class="btn primary" id="btnSubmit" disabled>Đăng ký Provider</button>
            </div>
        </form>
    </div>
</main>

@section Scripts {
    <script>
        (function () {
          // ===== Avatar =====
          const fileInput   = document.getElementById("ProfileImage");
          const placeholder = document.getElementById("avatarPlaceholder");
          const previewWrap = document.getElementById("avatarPreviewWrap");
          const img         = document.getElementById("imgPreview");
          const fileNameEl  = document.getElementById("fileName");
          const overlayBtn  = document.getElementById("avatarOverlay");
          const isResubmit  = document.getElementById("IsResubmit")?.value === "true";

          placeholder?.addEventListener("click", () => fileInput?.click());
          fileInput?.addEventListener("change", e => {
            const f = e.target.files?.[0]; if (!f) return;
            // validate avatar client-side
            if (!f.type.startsWith("image/")) {
              alert("Ảnh đại diện không hợp lệ.");
              fileInput.value = "";
              return;
            }
            img.src = URL.createObjectURL(f);
            if (fileNameEl) fileNameEl.textContent = f.name;
            placeholder.classList.add("d-none");
            previewWrap.classList.remove("d-none");
          });
          overlayBtn?.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
            previewWrap.classList.add("d-none");
            placeholder.classList.remove("d-none");
            if (fileNameEl) fileNameEl.textContent = "Chưa chọn tệp";
          });

          // ===== Autosize =====
          function wireAutosize(scope){
            scope.querySelectorAll("textarea.autosize, .cert textarea.input").forEach(t=>{
              const resize = ()=>{ t.style.height="auto"; t.style.height=t.scrollHeight+"px"; };
              t.removeEventListener("input", resize);
              t.addEventListener("input", resize);
              resize();
            });
          }
          wireAutosize(document);

          // ===== Chứng chỉ =====
          const list      = document.getElementById("certList");
          const btnAdd    = document.getElementById("btnAddCert");
          const btnSubmit = document.getElementById("btnSubmit");
          const nameEl    = document.getElementById("ProviderName");
          const phoneEl   = document.getElementById("PhoneNumber");
          const descEl    = document.getElementById("Description");
          const tiTitleEl = document.getElementById("TI_Title");
          const tiDescEl  = document.getElementById("TI_Description");

          // === CORE: mỗi input file có "kho" riêng bằng WeakMap ===
          const fileStore = new WeakMap();       // input[type=file] -> File[]
          function ensureStore(input){ if(!fileStore.has(input)) fileStore.set(input, []); return fileStore.get(input); }

          // Render preview CHỈ trong khung chứa input
          function renderFor(input){
            const cert  = input.closest(".cert");
            const grid  = cert.querySelector(".bl-previews");
            const name  = cert.querySelector(".bl-name");
            const files = ensureStore(input);
            grid.innerHTML = "";
            files.forEach((f, i) => {
              const url = URL.createObjectURL(f);
              const fig = document.createElement("figure");
              fig.className = "thumb";
              fig.innerHTML = `<img src="${url}" alt="${f.name}"><button type="button" class="thumb-del" data-index="${i}" aria-label="Xóa">×</button>`;
              grid.appendChild(fig);
            });
            if (name) name.textContent = files.length ? `${files.length} tệp đã chọn` : "Chưa chọn tệp";
          }

          // Đồng bộ files vào chính input để submit đúng
          function syncInputFiles(input){
            const files = ensureStore(input);
            const dt = new DataTransfer();
            files.forEach(f => dt.items.add(f));
            input.files = dt.files;
          }

          // Lắng nghe CHANGE trên từng input file (không dùng listener cũ bị clone)
          function bindFileInput(input){
            input.addEventListener("change", e => {
              const cur = ensureStore(input);
              const sig = new Set(cur.map(f => `${f.name}|${f.size}|${f.lastModified}`));
              Array.from(input.files || []).forEach(f=>{
                // validate type
                if (!f.type.startsWith("image/")) return;
                const k = `${f.name}|${f.size}|${f.lastModified}`;
                if(!sig.has(k)){ cur.push(f); sig.add(k); }
              });
              fileStore.set(input, cur);
              syncInputFiles(input);
              renderFor(input);
              input.value = ""; // cho phép chọn lại cùng tệp
            });
          }

          // Xóa ảnh ở đúng khung
          list.addEventListener("click", (e) => {
            const btn = e.target.closest(".thumb-del");
            if (!btn) return;
            const cert  = btn.closest(".cert");
            const input = cert.querySelector(".bl-input");
            const cur   = ensureStore(input);
            const idx   = Number(btn.dataset.index);
            if (idx>=0 && idx<cur.length) cur.splice(idx,1);
            fileStore.set(input, cur);
            syncInputFiles(input);
            renderFor(input);
          });

          // Khóa trùng danh mục giữa 2 chứng chỉ
          function syncCategorySelects(){
            const selects = Array.from(list.querySelectorAll('.cert select[name$=".CategoryId"]'));
            const chosen  = new Map();
            selects.forEach(s => { if (s.value) chosen.set(s.value, (chosen.get(s.value)||0)+1); });
            selects.forEach(s => {
              const myVal = s.value;
              s.querySelectorAll("option").forEach(opt=>{
                if (!opt.value) return;
                const used = chosen.get(opt.value)||0;
                opt.disabled = (opt.value !== myVal && used > 0);
              });
            });
          }
          list.addEventListener("change", (e)=>{
            if (e.target.matches('.cert select[name$=".CategoryId"]')) {
              syncCategorySelects(); enableSubmit();
            }
          });

          // Thêm chứng chỉ (tối đa 2)
          btnAdd?.addEventListener("click", () => {
            const items = list.querySelectorAll(".cert");
            if (items.length >= 2) return;

            const tmpl  = items[items.length - 1];
            const clone = tmpl.cloneNode(true);

            // reset giá trị
            clone.querySelectorAll("input, textarea, select").forEach(el=>{
              if (el.type === "file") el.value = ""; else el.value = "";
            });
            const blName = clone.querySelector(".bl-name");
            const blGrid = clone.querySelector(".bl-previews");
            if (blName) blName.textContent = "Chưa chọn tệp";
            if (blGrid) blGrid.innerHTML = "";

            list.insertBefore(clone, btnAdd);

            renumberCerts();         // đánh lại name/id cho .NET bind
            wireAutosize(clone);
            syncCertUI();
            enableSubmit();

            // bind input file của khung mới
            const newInput = clone.querySelector(".bl-input");
            ensureStore(newInput);   // kho rỗng riêng
            bindFileInput(newInput); // gắn change cho khung mới
          });

          // Xóa khung chứng chỉ
          list.addEventListener("click", (e)=>{
            const btn = e.target.closest(".btn-remove-cert,.iconbtn.close");
            if (!btn) return;
            const items = list.querySelectorAll(".cert");
            if (items.length <= 1) return;
            const cert = btn.closest(".cert");
            const input = cert.querySelector(".bl-input");
            fileStore.delete(input);             // xóa kho của khung này
            cert.remove();
            renumberCerts();
            syncCertUI();
            enableSubmit();
          });

          // Đánh lại index (name/id/for) — KHÔNG động vào fileStore nên ảnh không “nhảy”
                  function renumberCerts(){
          list.querySelectorAll(".cert").forEach((blk, i) => {
            blk.dataset.index = i;
            blk.querySelector(".pill").textContent = i + 1;
            const title = blk.querySelector(".cert__head strong");
            if (title) title.textContent = `Chứng chỉ ${i + 1}`;

            // 1) Cập nhật name để .NET bind đúng
            blk.querySelectorAll("[name]").forEach(el=>{
              el.name = el.name.replace(/Certificates\[\d+\]/g, `Certificates[${i}]`);
            });

            // 2) Cập nhật ID của input file
            const input = blk.querySelector(".bl-input");
            if (input) input.id = `BL_${i}`;

            // 3) Cập nhật TẤT CẢ label trỏ tới input file (cả nhãn tiêu đề và nút "Chọn ảnh")
            blk.querySelectorAll('label[for^="BL_"]').forEach(lab=>{
              lab.setAttribute("for", `BL_${i}`);
            });

            // 4) Đồng bộ lại files vào input + render đúng khung
            if (input) {
              syncInputFiles(input);
              renderFor(input);
            }
          });

          syncCategorySelects();
        }


          function syncCertUI(){
            const items = list.querySelectorAll(".cert");
            list.querySelectorAll(".btn-remove-cert").forEach(b => b.classList.toggle("d-none", items.length <= 1));
            const atMax = items.length >= 2;
            btnAdd.disabled = atMax;
            btnAdd.textContent = atMax ? "— Đã tối đa 2 chứng chỉ —" : "+ Thêm chứng chỉ";
            btnAdd.classList.toggle("disabled", atMax);
          }

          // Enable submit (Tên + Category CC1)
          function enableSubmit(){
            const firstCat = list.querySelector('select[name="Certificates[0].CategoryId"]');
            const okName   = (nameEl?.value.trim().length || 0) > 0;
            const okCat    = !firstCat || !!firstCat.value;
            btnSubmit.disabled = !(okName && okCat);
          }
          nameEl?.addEventListener("input", enableSubmit);

          // ===== init =====
          // bind khung 1
          const firstInput = document.querySelector('.cert .bl-input');
          ensureStore(firstInput);
          bindFileInput(firstInput);

          renumberCerts();
          syncCertUI();
          enableSubmit();

          // Submit AJAX JSON — loại bỏ redirect/banner
          const form = document.getElementById("providerForm");
          form?.addEventListener("submit", async (ev) => {
            // comprehensive validation for resubmit (Rejected)
            const errors = [];

            const providerName = nameEl?.value?.trim() || "";
            const phoneTrim    = phoneEl?.value?.trim() || "";
            const descVal      = descEl?.value || "";
            const tiTitle      = tiTitleEl?.value?.trim() || "";
            const tiDesc       = tiDescEl?.value?.trim() || "";

            // basic field validation
            if (providerName.length === 0) errors.push({ msg: "Vui lòng nhập tên Provider.", el: nameEl });
            if (isResubmit && (!fileInput?.files || fileInput.files.length === 0)) {
              errors.push({ msg: "Vui lòng chọn ảnh đại diện mới.", el: fileInput });
            }
            if (tiTitle.length === 0) errors.push({ msg: "Vui lòng nhập Title cho Điều khoản & Bảo hiểm.", el: tiTitleEl });
            if (tiDesc.length === 0) errors.push({ msg: "Vui lòng nhập Description cho Điều khoản & Bảo hiểm.", el: tiDescEl });

            // certificates validation: at least 1
            const certBlocks = Array.from(list.querySelectorAll('.cert'));
            if (certBlocks.length === 0) {
              errors.push({ msg: "Vui lòng thêm ít nhất 1 chứng chỉ.", el: btnAdd });
            }
            certBlocks.forEach((blk, idx) => {
              const catSel = blk.querySelector('select[name$=".CategoryId"]');
              const descTa = blk.querySelector('textarea[name$=".Description"]');
              const input  = blk.querySelector('.bl-input');
              const files  = ensureStore(input);
              const errCat = blk.querySelector('.field-error');
              // per-field UI
              if (catSel && !catSel.value) {
                errors.push({ msg: `Vui lòng chọn danh mục cho chứng chỉ ${idx+1}.`, el: catSel });
                errCat?.classList.remove('d-none');
              } else {
                errCat?.classList.add('d-none');
              }
              if ((descTa?.value?.trim()?.length || 0) === 0) {
                const e = blk.querySelectorAll('.field-error')[2] || blk.querySelector('.field-error');
                e?.classList.remove('d-none');
                errors.push({ msg: `Vui lòng nhập mô tả cho chứng chỉ ${idx+1}.`, el: descTa });
              } else {
                const e = blk.querySelectorAll('.field-error')[2] || blk.querySelector('.field-error');
                e?.classList.add('d-none');
              }
              const blErr = blk.querySelectorAll('.field-error')[1];
              if (!files || files.length === 0) {
                blErr?.classList.remove('d-none');
                errors.push({ msg: `Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh mới.`, el: input });
              } else {
                blErr?.classList.add('d-none');
              }
            });

            // file constraints and total size <= 50MB
            const MAX_TOTAL = 50 * 1024 * 1024;
            let totalBytes = 0;
            const allFiles = [];
            if (fileInput?.files?.[0]) allFiles.push(fileInput.files[0]);
            certBlocks.forEach(blk => {
              const input = blk.querySelector('.bl-input');
              const files = ensureStore(input) || [];
              files.forEach(f => allFiles.push(f));
            });
            allFiles.forEach(f => {
              if (!f.type.startsWith('image/')) errors.push({ msg: 'Tệp không hợp lệ (không phải ảnh).', el: null });
              totalBytes += f.size;
            });
            if (totalBytes > MAX_TOTAL) {
              errors.push({ msg: 'Tổng dung lượng tệp vượt quá 50MB.', el: null });
            }

            if (errors.length > 0) {
              ev.preventDefault();
              const first = errors[0];
              if (first.el && typeof first.el.focus === 'function') first.el.focus();
              alert(errors[0].msg);
              return;
            }

            // trim values before submit
            if (nameEl) nameEl.value = providerName;
            if (phoneEl) phoneEl.value = phoneTrim;

            ev.preventDefault();
            btnSubmit.disabled = true;
            const oldText = btnSubmit.textContent;
            btnSubmit.textContent = "Đang gửi...";

            try {
              const fd = new FormData(form);
              // gửi giữ nguyên keys theo yêu cầu; không set Content-Type
              const res = await fetch(form.action, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: fd });

              if (res.status === 200) {
                const ok = await res.json(); // { ok: true, providerId, status, refresh } OR { ok:false,... }
                if (!ok || ok.ok !== true) {
                  alert(ok?.message || 'Đăng ký thất bại.');
                } else if (ok.refresh) {
                  localStorage.removeItem('myProvider');
                  window.location.reload();
                } else {
                  window.location.href = `${form.getAttribute('data-success') || '/Customer/RegisterProvider/Success'}?id=${encodeURIComponent(ok.providerId)}&stat=${encodeURIComponent(ok.status)}`;
                }
                return;
              }

              // lỗi 409 hoặc 400
              let err; try { err = await res.json(); } catch { err = { Message: 'Đăng ký thất bại.' }; }
              const msg = err?.Message || err?.message || 'Đăng ký thất bại.';
              const detail = err?.Detail || err?.detail;
              alert(detail ? `${msg}\n\nChi tiết: ${detail}` : msg);

              // map Errors[].Field
              if (Array.isArray(err?.Errors) || Array.isArray(err?.errors)) {
                const list = err.Errors || err.errors;
                const m = (field) => {
                  if (!field) return null;
                  if (field === 'PROVIDERNAME') return nameEl;
                  if (field === 'PHONENUMBER') return phoneEl;
                  if (field === 'DESCRIPTION') return descEl;
                  if (field === 'PROFILEIMAGE') return fileInput;
                  if (field === 'TERMSINSURANCE.TITLE') return tiTitleEl;
                  if (field === 'TERMSINSURANCE.DESCRIPTION') return tiDescEl;
                  const mm = field.match(/^CERTIFICATES\[(\d+)\]\.(CATEGORYID|DESCRIPTION|BUSINESSLICENSES)$/i);
                  if (mm) {
                    const idx = Number(mm[1]);
                    const part = mm[2].toUpperCase();
                    const cert = document.querySelector(`.cert[data-index="${idx}"]`);
                    if (!cert) return null;
                    if (part === 'CATEGORYID') return cert.querySelector('select[name$=".CategoryId"]');
                    if (part === 'DESCRIPTION') return cert.querySelector('textarea[name$=".Description"]');
                    if (part === 'BUSINESSLICENSES') return cert.querySelector('.bl-input');
                  }
                  return null;
                };
                const first = list.find(e => !!(e.Field || e.field));
                const el = first ? m(first.Field || first.field) : null;
                if (el && el.classList) el.classList.add('is-invalid');
                if (el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth',block:'center'});
                if (el && el.focus) el.focus();
              }
            } catch (ex) {
              alert('Không thể gửi đăng ký. Vui lòng thử lại.');
            } finally {
              btnSubmit.disabled = false;
              btnSubmit.textContent = oldText || 'Đăng ký Provider';
            }
          });

          // ===== Map API error (TempData banner) to fields =====
          // Bỏ map banner vì dùng flow JSON
          const apiErrEl = null;
          if (apiErrEl) {
            const msg = apiErrEl.textContent || "";
            function mark(el){ if(!el) return; el.classList.add('is-invalid'); try{ el.focus(); }catch{} }
            function scrollToEl(el){ if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); }
            if (msg.includes('Vui lòng nhập tên Provider')) { mark(nameEl); scrollToEl(nameEl); }
            else if (msg.includes('Vui lòng nhập Title cho Điều khoản')) { mark(tiTitleEl); scrollToEl(tiTitleEl); }
            else if (msg.includes('Vui lòng chọn danh mục cho chứng chỉ 1')) {
              const firstCat = list.querySelector('select[name="Certificates[0].CategoryId"]');
              mark(firstCat); scrollToEl(firstCat);
            }
            else if (msg.includes('Vui lòng chọn ảnh đại diện mới')) { scrollToEl(placeholder || fileInput); }
            else if (msg.includes('Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh')) {
              const firstBl = list.querySelector('.cert .bl-input');
              mark(firstBl); scrollToEl(firstBl);
            }
            else if (msg.includes('Ảnh đại diện không hợp lệ')) { mark(fileInput); scrollToEl(fileInput); }
          }

          // Map BE Errors[] with Field to exact inputs
          const apiErrorsJson = '@(TempData["ApiErrorsJson"] ?? "")';
          if (apiErrorsJson) {
            try {
              const errs = JSON.parse(apiErrorsJson);
              const fieldToEl = (field) => {
                if (!field) return null;
                if (field === 'PROVIDERNAME') return nameEl;
                if (field === 'PHONENUMBER') return phoneEl;
                if (field === 'DESCRIPTION') return descEl;
                if (field === 'PROFILEIMAGE') return fileInput;
                if (field === 'TERMSINSURANCE.TITLE') return tiTitleEl;
                if (field === 'TERMSINSURANCE.DESCRIPTION') return tiDescEl;
                const m = field.match(/^CERTIFICATES\[(\d+)\]\.(CATEGORYID|DESCRIPTION|BUSINESSLICENSES)$/i);
                if (m) {
                  const idx = Number(m[1]);
                  const part = m[2].toUpperCase();
                  const cert = document.querySelector(`.cert[data-index="${idx}"]`);
                  if (!cert) return null;
                  if (part === 'CATEGORYID') return cert.querySelector('select[name$=".CategoryId"]');
                  if (part === 'DESCRIPTION') return cert.querySelector('textarea[name$=".Description"]');
                  if (part === 'BUSINESSLICENSES') return cert.querySelector('.bl-input');
                }
                return null;
              };
              let firstEl = null;
              errs.forEach(e => {
                const el = fieldToEl(e.Field);
                if (el && el.classList) el.classList.add('is-invalid');
                if (!firstEl && el) firstEl = el;
              });
              if (firstEl && firstEl.scrollIntoView) firstEl.scrollIntoView({behavior:'smooth',block:'center'});
              if (firstEl && firstEl.focus) firstEl.focus();
            } catch {}
          }
        })();
    </script>
}

@{
    ViewData["Title"] = "Đăng ký Provider";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // ViewBag.Categories = new[] { new { Id="1", Name="Sửa chữa điện" }, ... }  // dữ liệu ảo nếu cần
    var categories = (IEnumerable<dynamic>)ViewBag.Categories;
}

@section Styles {
    <link rel="stylesheet" href="~/css/register-provider.css" asp-append-version="true" />
}

<main class="rp">
    <div class="rp__container">
        <header class="rp__header">
            <h1>Đăng ký Provider</h1>
            <p>Điền thông tin để bắt đầu hợp tác cùng chúng tôi</p>
        </header>

        <form id="providerForm" method="post"
              asp-area="Customer" asp-controller="RegisterProvider" asp-action="RegisterFallback"
              enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()

            <!-- =========== THÔNG TIN =========== -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-person"></i></span>
                    <div>
                        <h2>Thông tin Provider</h2>
                        <p>Vui lòng cung cấp thông tin chi tiết về dịch vụ của bạn</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Avatar -->
                    <div class="field">
                        <label for="ProfileImage">Ảnh đại diện</label>

                        <!-- Placeholder khi chưa chọn -->
                        <button type="button" id="avatarPlaceholder" class="avatar-tile" aria-label="Chọn ảnh từ tệp">
                            <div class="tile-icon">📷</div>
                            <div class="tile-text">Chọn từ tệp</div>
                        </button>

                        <!-- Preview khi đã chọn -->
                        <div id="avatarPreviewWrap" class="avatar-wrap d-none">
                            <div class="avatar-img-wrap">
                                <!-- size ảnh do CSS kiểm soát để overlay không tràn -->
                                <img id="imgPreview" class="avatar-img" alt="Ảnh đại diện" src="~/images/placeholder-avatar.png" />
                                <button type="button" id="avatarOverlay" class="avatar-overlay" title="Xóa ảnh">
                                    <span class="overlay-x">×</span>
                                </button>
                            </div>

                            <div class="file-row">
                                <input type="file" id="ProfileImage" name="ProfileImage" accept="image/*" class="file-input" />
                                <div class="file-actions">
                                    <span id="fileName" class="file-name">Chưa chọn tệp</span>
                                    <label for="ProfileImage" class="btn ghost">Chọn tệp khác</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="ProviderName">Tên Provider <span class="req">*</span></label>
                        <input id="ProviderName" name="ProviderName" class="input" maxlength="100"
                               placeholder="VD: Sửa chữa điện Minh Anh" required />
                    </div>

                    <div class="field">
                        <label for="PhoneNumber">Số điện thoại</label>
                        <input id="PhoneNumber" name="PhoneNumber" class="input" inputmode="tel" maxlength="20"
                               placeholder="0912 345 678" />
                    </div>

                    <div class="field">
                        <label for="Description">Mô tả dịch vụ</label>
                        <textarea id="Description" name="Description" class="input autosize" rows="3"
                                  placeholder="Kinh nghiệm, phạm vi phục vụ, điểm mạnh..."></textarea>
                    </div>
                </div>
            </section>

            <!-- =========== CHỨNG CHỈ =========== -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-file-earmark-text"></i></span>
                    <div>
                        <h2>Chứng chỉ &amp; Danh mục</h2>
                        <p>Thêm tối đa 2 chứng chỉ, mỗi chứng chỉ tương ứng với 1 danh mục dịch vụ</p>
                    </div>
                </div>

                <div class="card__body" id="certList">
                    <!-- item 0 -->
                    <div class="cert" data-index="0">
                        <div class="cert__head">
                            <span class="pill">1</span>
                            <strong>Chứng chỉ 1</strong>
                            <button type="button" class="iconbtn close btn-remove-cert d-none" aria-label="Xóa">×</button>
                        </div>

                        <div class="field">
                            <label>Danh mục dịch vụ <span class="req">*</span></label>
                            <select class="input" name="Certificates[0].CategoryId" required>
                                <option value="">Chọn danh mục</option>
                                @foreach (var c in categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                        </div>

                        <div class="field">
                            <label>URL chứng chỉ</label>
                            <input type="url" class="input" name="Certificates[0].Url" placeholder="https://example.com/certificate.pdf" />
                        </div>

                        <div class="field">
                            <label>Mô tả chứng chỉ</label>
                            <textarea class="input autosize" rows="3" name="Certificates[0].Description"
                                      placeholder="Mô tả ngắn, năm cấp, đơn vị cấp..."></textarea>
                        </div>
                    </div>

                    <button type="button" id="btnAddCert" class="btn dashed full">+ Thêm chứng chỉ</button>
                </div>
            </section>

            <!-- =========== Actions (ở giữa) =========== -->
            <div class="actions center">
                <a href="javascript:history.back()" class="btn ghost">Hủy</a>
                <button type="submit" class="btn primary" id="btnSubmit" disabled>Đăng ký Provider</button>
            </div>
        </form>
    </div>
</main>

@section Scripts {
    <script>
        (function () {
          // ===== DOM
          const fileInput   = document.getElementById("ProfileImage");
          const placeholder = document.getElementById("avatarPlaceholder");
          const previewWrap = document.getElementById("avatarPreviewWrap");
          const img         = document.getElementById("imgPreview");
          const fileNameEl  = document.getElementById("fileName");
          const overlayBtn  = document.getElementById("avatarOverlay");

          const btnAdd   = document.getElementById("btnAddCert");
          const list     = document.getElementById("certList");
          const btnSubmit= document.getElementById("btnSubmit");
          const nameEl   = document.getElementById("ProviderName");

          // ===== Autosize textarea (mô tả dịch vụ & mô tả chứng chỉ)
          function wireAutosize(scope){
            scope.querySelectorAll("textarea.autosize, .cert textarea.input").forEach(t=>{
              const resize = ()=>{ t.style.height="auto"; t.style.height=t.scrollHeight+"px"; };
              t.removeEventListener("input", resize);
              t.addEventListener("input", resize);
              resize();
            });
          }
          wireAutosize(document);

          // ===== Avatar
          placeholder?.addEventListener("click", () => fileInput?.click());
          fileInput?.addEventListener("change", e => {
            const f = e.target.files?.[0]; if (!f) return;
            img.src = URL.createObjectURL(f);
            if (fileNameEl) fileNameEl.textContent = f.name;
            placeholder.classList.add("d-none");
            previewWrap.classList.remove("d-none");
          });
          // overlay X – xoá ảnh (overlay nằm gọn trong khung)
          overlayBtn?.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
            previewWrap.classList.add("d-none");
            placeholder.classList.remove("d-none");
            if (fileNameEl) fileNameEl.textContent = "Chưa chọn tệp";
          });

          // ===== Certificates (max 2, giống nhau hoàn toàn)
          function syncCertUI() {
            const items = list.querySelectorAll(".cert");
            list.querySelectorAll(".btn-remove-cert").forEach(b => b.classList.toggle("d-none", items.length <= 1));
            const atMax = items.length >= 2;
            btnAdd.disabled = atMax;
            btnAdd.textContent = atMax ? "— Đã tối đa 2 chứng chỉ —" : "+ Thêm chứng chỉ";
            btnAdd.classList.toggle("disabled", atMax);
          }

          btnAdd?.addEventListener("click", () => {
            const items = list.querySelectorAll(".cert");
            if (items.length >= 2) return;

            const tmpl  = items[items.length - 1];
            const clone = tmpl.cloneNode(true);

            // reset value & đảm bảo nhập được
            clone.querySelectorAll("input, textarea, select").forEach(el=>{
              el.value = ""; el.removeAttribute("disabled"); el.readOnly = false;
            });

            // chèn & re-index
            list.insertBefore(clone, btnAdd);
            list.querySelectorAll(".cert").forEach((blk, i) => {
              blk.dataset.index = i;
              blk.querySelector(".pill").textContent = i + 1;
              const title = blk.querySelector(".cert__head strong");
              if (title) title.textContent = `Chứng chỉ ${i + 1}`;
              blk.querySelectorAll("[name]").forEach(el=>{
                el.name = el.name.replace(/Certificates\[\d+\]/, `Certificates[${i}]`);
              });
            });

            wireAutosize(clone); // autosize cho textareas mới
            syncCertUI();
          });

          list.addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-remove-cert,.iconbtn.close");
            if (!btn) return;
            const items = list.querySelectorAll(".cert");
            if (items.length <= 1) return;
            btn.closest(".cert").remove();
            list.querySelectorAll(".cert").forEach((blk, i) => {
              blk.dataset.index = i;
              blk.querySelector(".pill").textContent = i + 1;
              const title = blk.querySelector(".cert__head strong");
              if (title) title.textContent = `Chứng chỉ ${i + 1}`;
              blk.querySelectorAll("[name]").forEach(el=>{
                el.name = el.name.replace(/Certificates\[\d+\]/, `Certificates[${i}]`);
              });
            });
            syncCertUI();
          });

          // ===== Submit enable
          function enableSubmit(){
            const firstCat = list.querySelector('select[name="Certificates[0].CategoryId"]');
            btnSubmit.disabled = !(nameEl.value.trim() && (!firstCat || firstCat.value));
          }
          nameEl.addEventListener("input", enableSubmit);
          list.addEventListener("change", e => { if (e.target.matches('select[name^="Certificates"]')) enableSubmit(); });

          syncCertUI(); enableSubmit();

          // ===== Fake submit
          document.getElementById("providerForm")?.addEventListener("submit", async (e) => {
            e.preventDefault();
            btnSubmit.disabled = true; btnSubmit.textContent = "Đang xử lý...";
            await new Promise(r => setTimeout(r, 800));
            alert("Đăng ký (giả lập) thành công!");
            btnSubmit.textContent = "Đăng ký Provider"; enableSubmit();
          });
        })();
    </script>
}

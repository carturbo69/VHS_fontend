@{
    ViewData["Title"] = "Đăng ký Provider";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = (IEnumerable<dynamic>)ViewBag.Categories;
}

@section Styles {
    <link rel="stylesheet" href="~/css/register-provider.css" asp-append-version="true" />
}

<main class="rp">
    <div class="rp__container">
        <header class="rp__header">
            <h1>Đăng ký Provider</h1>
            <p>Điền thông tin để bắt đầu hợp tác cùng chúng tôi</p>
        </header>

        @if (ViewBag.ExistingStatus is string st && st.Equals("Rejected", StringComparison.OrdinalIgnoreCase))
        {
            <div class="alert alert-warning" role="alert" style="max-width:1120px;margin:0 auto 16px;">
                <strong>Hồ sơ của bạn đã bị từ chối.</strong> Vui lòng gửi lại toàn bộ thông tin và tải lên ảnh đại diện cùng giấy phép kinh doanh mới.
            </div>
        }

        @* Banner lỗi tổng đã được loại bỏ trong flow mới (AJAX JSON), giữ lại khung để có thể tái dùng nếu cần) *@

        <form id="providerForm" method="post"
              asp-area="Customer" asp-controller="RegisterProvider" asp-action="RegisterFallback"
              enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" id="IsResubmit" value="@(string.Equals(ViewBag.ExistingStatus as string, "Rejected", StringComparison.OrdinalIgnoreCase) ? "true" : "false")" />

            @* @if (ViewBag.ExistingProviderId != null) *@
            @* { *@
            @*     <input type="hidden" name="ProviderId" value="@ViewBag.ExistingProviderId" /> *@
            @* } *@

            <!-- THÔNG TIN -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-person"></i></span>
                    <div>
                        <h2>Thông tin Provider</h2>
                        <p>Vui lòng cung cấp thông tin chi tiết về dịch vụ của bạn</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Avatar -->
                    <div class="field">
                        <label for="ProfileImage">Ảnh đại diện <span class="req">*</span></label>
                        <button type="button" id="avatarPlaceholder" class="avatar-tile" aria-label="Chọn ảnh từ tệp">
                            <div class="tile-icon">📷</div>
                            <div class="tile-text">Chọn từ tệp</div>
                        </button>

                        <div id="avatarPreviewWrap" class="avatar-wrap d-none">
                            <div class="avatar-img-wrap">
                                <img id="imgPreview" class="avatar-img" alt="Ảnh đại diện" src="~/images/placeholder-avatar.png" />
                                <button type="button" id="avatarOverlay" class="avatar-overlay" title="Xóa ảnh"><span class="overlay-x">×</span></button>
                            </div>

                            <div class="file-row">
                                <input type="file" id="ProfileImage" name="ProfileImage" accept="image/*" class="file-input" />
                                <div class="file-actions">
                                    <span id="fileName" class="file-name">Chưa chọn tệp</span>
                                    <label for="ProfileImage" class="btn ghost">Chọn tệp khác</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="ProviderName">Tên Provider <span class="req">*</span></label>
                        <input id="ProviderName" name="ProviderName" class="input" maxlength="100"
                               placeholder="VD: Sửa chữa điện Minh Anh" required />
                    </div>

                    <div class="field">
                        <label for="PhoneNumber">Số điện thoại</label>
                        <input id="PhoneNumber" name="PhoneNumber" class="input" inputmode="tel" maxlength="20"
                               placeholder="0912 345 678" />
                    </div>

                    <div class="field">
                        <label for="Description">Mô tả dịch vụ <span class="req">*</span></label>
                        <textarea id="Description" name="Description" class="input autosize" rows="3"
                                  placeholder="Kinh nghiệm, phạm vi phục vụ, điểm mạnh..." required></textarea>
                    </div>
                </div>
            </section>

            <!-- CHỨNG CHỈ -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-file-earmark-text"></i></span>
                    <div>
                        <h2>Chứng chỉ &amp; Danh mục</h2>
                        <p>Thêm tối đa 2 chứng chỉ, mỗi chứng chỉ tương ứng với 1 danh mục dịch vụ</p>
                    </div>
                </div>

                <div class="card__body" id="certList">
                    <!-- item 0 -->
                    <div class="cert" data-index="0">
                        <div class="cert__head">
                            <span class="pill">1</span>
                            <strong>Chứng chỉ 1</strong>
                            <button type="button" class="iconbtn close btn-remove-cert d-none" aria-label="Xóa">×</button>
                        </div>

                        <div class="field">
                            <label>Danh mục dịch vụ <span class="req">*</span></label>
                            <select class="input" name="Certificates[0].CategoryId" required>
                                <option value="">Chọn danh mục</option>
                                @foreach (var c in categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                                <div class="field-error text-danger small d-none">Vui lòng chọn danh mục cho chứng chỉ 1.</div>
                        </div>

                        <div class="field">
                            <label for="BL_0">Hình ảnh giấy phép kinh doanh <span class="req">*</span> (có thể chọn nhiều)</label>
                            <input id="BL_0" type="file" name="Certificates[0].BusinessLicenses" class="file-input bl-input"
                                   accept="image/*" multiple required />
                            <div class="file-actions">
                                <span class="file-name bl-name">Chưa chọn tệp</span>
                                <label for="BL_0" class="btn ghost">Chọn ảnh</label>
                            </div>
                            <div class="img-grid bl-previews" aria-live="polite"></div>
                            <div class="field-error text-danger small d-none">Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh.</div>
                        </div>

                        <div class="field">
                            <label>Mô tả dịch vụ kinh doanh <span class="req">*</span></label>
                            <textarea class="input autosize" rows="3" name="Certificates[0].Description"
                                      placeholder="Mô tả ngắn, năm cấp, đơn vị cấp..." required></textarea>
                            <div class="field-error text-danger small d-none">Vui lòng nhập mô tả cho chứng chỉ 1.</div>
                        </div>
                    </div>

                    <button type="button" id="btnAddCert" class="btn dashed full">+ Thêm chứng chỉ</button>
                </div>
            </section>

            <!-- ĐIỀU KHOẢN & BẢO HIỂM -->
            <section class="card">
                <div class="card__head">
                    <span class="ico"><i class="bi bi-shield-check"></i></span>
                    <div>
                        <h2>Điều khoản &amp; Bảo hiểm</h2>
                        <p>Vui lòng đọc và đồng ý với các điều khoản dịch vụ và chính sách bảo hiểm của chúng tôi.</p>
                    </div>
                </div>

                <div class="card__body">
                    <!-- Hidden inputs for backend compatibility -->
                    <input type="hidden" id="TI_Title" name="TermsInsurance.Title" value="Điều khoản & Bảo hiểm áp dụng cho Provider" />
                    <input type="hidden" id="TI_Description" name="TermsInsurance.Description" value="Provider đã đọc và đồng ý với các điều khoản dịch vụ và chính sách bảo hiểm của VHS Platform." />
                    
                    <!-- Điều khoản dịch vụ - Collapsible -->
                    <div class="terms-collapsible">
                        <div class="terms-collapsible-header" data-toggle="collapse" data-target="#termsContent">
                            <div class="terms-collapsible-title">
                                <i class="bi bi-file-text" style="color: #0ea5e9; font-size: 24px; margin-right: 12px;"></i>
                                <div>
                                    <h3 style="margin: 0; color: #0ea5e9; font-size: 18px; font-weight: 600;">Chính sách và Điều khoản chung</h3>
                                    <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">Quy định về quyền và nghĩa vụ khi cung cấp dịch vụ</p>
                                </div>
                            </div>
                            <i class="bi bi-chevron-down terms-collapsible-icon"></i>
                        </div>
                        <div class="terms-collapsible-content" id="termsContent">
                            <h6 style="color: #0ea5e9; margin-top: 0;">1. Giới thiệu</h6>
                            <p>Chào mừng bạn đến với VHS Platform. Khi đăng ký trở thành Provider, bạn đồng ý tuân thủ các điều khoản và điều kiện được nêu dưới đây.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">2. Quyền và Nghĩa vụ của Provider</h6>
                            <ul>
                                <li>Provider cam kết cung cấp dịch vụ chất lượng, đúng mô tả và đúng thời gian đã cam kết.</li>
                                <li>Provider chịu trách nhiệm về chất lượng dịch vụ, thiết bị và nhân viên thực hiện dịch vụ.</li>
                                <li>Provider phải có đầy đủ giấy phép kinh doanh hợp lệ và chứng chỉ cần thiết.</li>
                                <li>Provider cam kết bảo mật thông tin khách hàng và không sử dụng cho mục đích khác.</li>
                            </ul>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">3. Chính sách Hủy và Hoàn tiền</h6>
                            <p>Provider phải tuân thủ chính sách hủy và hoàn tiền của platform. Trong trường hợp hủy dịch vụ từ phía Provider mà không có lý do chính đáng, Provider sẽ chịu phạt theo quy định.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">4. Phí dịch vụ và Thanh toán</h6>
                            <p>VHS Platform thu phí hoa hồng 10-15% trên mỗi đơn hàng hoàn thành. Thanh toán sẽ được thực hiện định kỳ hàng tuần/tháng theo thỏa thuận.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">5. Chấm dứt Hợp tác</h6>
                            <p>VHS Platform có quyền tạm ngưng hoặc chấm dứt tài khoản Provider nếu vi phạm điều khoản, nhận nhiều đánh giá xấu, hoặc có hành vi gian lận.</p>
                            
                            <h6 style="color: #0ea5e9; margin-top: 20px;">6. Thay đổi Điều khoản</h6>
                            <p>VHS Platform có quyền thay đổi điều khoản này. Các thay đổi sẽ được thông báo trước ít nhất 7 ngày.</p>
                        </div>
                    </div>

                    <!-- Chính sách bảo hiểm - Collapsible -->
                    <div class="terms-collapsible" style="margin-top: 20px;">
                        <div class="terms-collapsible-header" data-toggle="collapse" data-target="#insuranceContent">
                            <div class="terms-collapsible-title">
                                <i class="bi bi-shield-check" style="color: #10b981; font-size: 24px; margin-right: 12px;"></i>
                                <div>
                                    <h3 style="margin: 0; color: #10b981; font-size: 18px; font-weight: 600;">Chính sách bảo mật thông tin</h3>
                                    <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">Quy định về bảo hiểm trách nhiệm và đảm bảo chất lượng dịch vụ</p>
                                </div>
                            </div>
                            <i class="bi bi-chevron-down terms-collapsible-icon"></i>
                        </div>
                        <div class="terms-collapsible-content" id="insuranceContent">
                            <h6 style="color: #10b981; margin-top: 0;">1. Bảo hiểm Trách nhiệm</h6>
                            <p>Provider phải có bảo hiểm trách nhiệm dân sự để bảo vệ khách hàng và chính mình trong trường hợp xảy ra sự cố:</p>
                            <ul>
                                <li>Thiệt hại về tài sản của khách hàng trong quá trình thực hiện dịch vụ</li>
                                <li>Thương tích hoặc tai nạn xảy ra với khách hàng do lỗi của Provider</li>
                                <li>Thiệt hại gián tiếp phát sinh từ dịch vụ không đạt chất lượng</li>
                            </ul>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">2. Mức Bảo hiểm Tối thiểu</h6>
                            <p>Provider cần duy trì bảo hiểm trách nhiệm với mức tối thiểu:</p>
                            <ul>
                                <li>Thiệt hại tài sản: Tối thiểu 50.000.000 VNĐ/sự cố</li>
                                <li>Thương tích cá nhân: Tối thiểu 100.000.000 VNĐ/sự cố</li>
                                <li>Thiệt hại gián tiếp: Tối thiểu 20.000.000 VNĐ/sự cố</li>
                            </ul>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">3. Quy trình Bồi thường</h6>
                            <p>Trong trường hợp khách hàng yêu cầu bồi thường:</p>
                            <ol>
                                <li>Khách hàng gửi yêu cầu kèm bằng chứng trong vòng 7 ngày kể từ khi xảy ra sự cố</li>
                                <li>VHS Platform sẽ xem xét và làm trung gian giải quyết</li>
                                <li>Provider phải phối hợp cung cấp thông tin và tham gia giải quyết</li>
                                <li>Quyết định bồi thường sẽ được đưa ra trong vòng 14 ngày làm việc</li>
                            </ol>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">4. Đảm bảo Chất lượng</h6>
                            <p>Provider cam kết:</p>
                            <ul>
                                <li>Sử dụng thiết bị và vật tư đạt chuẩn an toàn</li>
                                <li>Nhân viên được đào tạo và có chứng chỉ cần thiết</li>
                                <li>Tuân thủ quy trình an toàn lao động</li>
                                <li>Có biện pháp phòng ngừa rủi ro trong quá trình cung cấp dịch vụ</li>
                            </ul>
                            
                            <h6 style="color: #10b981; margin-top: 20px;">5. Miễn trừ Trách nhiệm</h6>
                            <p>VHS Platform không chịu trách nhiệm về:</p>
                            <ul>
                                <li>Thiệt hại do lỗi từ phía khách hàng (cung cấp thông tin sai, không tuân thủ hướng dẫn)</li>
                                <li>Sự cố do thiên tai, hỏa hoạn hoặc bất khả kháng</li>
                                <li>Tranh chấp trực tiếp giữa Provider và khách hàng ngoài platform</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Checkbox đồng ý -->
                    <div class="field" style="margin-top: 24px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; background: #fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;" id="termsCheckboxWrapper">
                            <input type="checkbox" id="agreeTerms" style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;" required />
                            <label for="agreeTerms" style="margin: 0; cursor: pointer; font-size: 15px; line-height: 1.5; color: #1e293b;">
                                Tôi đã đọc, hiểu rõ và đồng ý với Chính sách và Điều khoản chung và Chính sách bảo mật thông tin của VHS Platform. <span style="color: #ef4444; font-weight: bold;">*</span>
                            </label>
                        </div>
                        <div id="termsError" class="text-danger small d-none" style="margin-top: 8px; padding-left: 32px;">
                            Bạn phải đồng ý với điều khoản và chính sách để tiếp tục đăng ký.
                        </div>
                    </div>
                </div>
            </section>

            <div class="actions center">
                <a href="javascript:history.back()" class="btn ghost">Hủy</a>
                <button type="submit" class="btn primary" id="btnSubmit" disabled>Đăng ký Provider</button>
            </div>
        </form>
    </div>
</main>

@section Scripts {
    <script>
        (function () {
          // ===== Avatar =====
          const fileInput   = document.getElementById("ProfileImage");
          const placeholder = document.getElementById("avatarPlaceholder");
          const previewWrap = document.getElementById("avatarPreviewWrap");
          const img         = document.getElementById("imgPreview");
          const fileNameEl  = document.getElementById("fileName");
          const overlayBtn  = document.getElementById("avatarOverlay");
          const isResubmit  = document.getElementById("IsResubmit")?.value === "true";

          placeholder?.addEventListener("click", () => fileInput?.click());
          fileInput?.addEventListener("change", e => {
            const f = e.target.files?.[0]; if (!f) return;
            // validate avatar client-side
            if (!f.type.startsWith("image/")) {
              alert("Ảnh đại diện không hợp lệ.");
              fileInput.value = "";
              return;
            }
            img.src = URL.createObjectURL(f);
            if (fileNameEl) fileNameEl.textContent = f.name;
            placeholder.classList.add("d-none");
            previewWrap.classList.remove("d-none");
          });
          overlayBtn?.addEventListener("click", () => {
            if (fileInput) fileInput.value = "";
            previewWrap.classList.add("d-none");
            placeholder.classList.remove("d-none");
            if (fileNameEl) fileNameEl.textContent = "Chưa chọn tệp";
          });

          // ===== Autosize =====
          function wireAutosize(scope){
            scope.querySelectorAll("textarea.autosize, .cert textarea.input").forEach(t=>{
              const resize = ()=>{ t.style.height="auto"; t.style.height=t.scrollHeight+"px"; };
              t.removeEventListener("input", resize);
              t.addEventListener("input", resize);
              resize();
            });
          }
          wireAutosize(document);

          // ===== Chứng chỉ =====
          const list      = document.getElementById("certList");
          const btnAdd    = document.getElementById("btnAddCert");
          const btnSubmit = document.getElementById("btnSubmit");
          const nameEl    = document.getElementById("ProviderName");
          const phoneEl   = document.getElementById("PhoneNumber");
          const descEl    = document.getElementById("Description");
          const agreeTermsEl = document.getElementById("agreeTerms");
          const termsErrorEl = document.getElementById("termsError");
          const termsWrapperEl = document.getElementById("termsCheckboxWrapper");

          // === CORE: mỗi input file có "kho" riêng bằng WeakMap ===
          // QUAN TRỌNG: fileStore gắn với từng input element cụ thể, không bị mất khi renumber
          const fileStore = new WeakMap();       // input[type=file] -> File[]
          function ensureStore(input){ if(!fileStore.has(input)) fileStore.set(input, []); return fileStore.get(input); }

          // Render preview CHỈ trong khung chứa input
          function renderFor(input){
            const cert  = input.closest(".cert");
            const grid  = cert.querySelector(".bl-previews");
            const name  = cert.querySelector(".bl-name");
            const files = ensureStore(input);
            
            // Debug: log để kiểm tra
            console.log(`Render for input ${input.id}:`, files.length, 'files');
            
            grid.innerHTML = "";
            files.forEach((f, i) => {
              const url = URL.createObjectURL(f);
              const fig = document.createElement("figure");
              fig.className = "thumb";
              fig.innerHTML = `<img src="${url}" alt="${f.name}"><button type="button" class="thumb-del" data-index="${i}" aria-label="Xóa">×</button>`;
              grid.appendChild(fig);
            });
            if (name) name.textContent = files.length ? `${files.length} tệp đã chọn` : "Chưa chọn tệp";
          }

          // Đồng bộ files vào chính input để submit đúng
          function syncInputFiles(input){
            const files = ensureStore(input);
            console.log(`Syncing ${files.length} files to input ${input.id}`);
            
            const dt = new DataTransfer();
            files.forEach(f => {
              dt.items.add(f);
              console.log(`Added file to DataTransfer: ${f.name}`);
            });
            input.files = dt.files;
            
            console.log(`After sync - input.files.length: ${input.files.length}`);
          }

          // Lắng nghe CHANGE trên từng input file (không dùng listener cũ bị clone)
          function bindFileInput(input){
            // Xóa listener cũ nếu có để tránh duplicate
            if (input._changeHandler) {
              input.removeEventListener("change", input._changeHandler);
            }
            
            // Tạo handler mới
            input._changeHandler = (e) => {
              console.log(`File change detected for input ${input.id}`);
              const cur = ensureStore(input);
              const sig = new Set(cur.map(f => `${f.name}|${f.size}|${f.lastModified}`));
              Array.from(input.files || []).forEach(f=>{
                // validate type
                if (!f.type.startsWith("image/")) {
                  console.log(`Invalid file type: ${f.type}`);
                  return;
                }
                const k = `${f.name}|${f.size}|${f.lastModified}`;
                if(!sig.has(k)){ 
                  cur.push(f); 
                  sig.add(k);
                  console.log(`Added file: ${f.name}`);
                }
              });
              fileStore.set(input, cur);
              syncInputFiles(input);
              renderFor(input);
              input.value = ""; // cho phép chọn lại cùng tệp
            };
            
            input.addEventListener("change", input._changeHandler);
          }

          // Xóa ảnh ở đúng khung
          list.addEventListener("click", (e) => {
            const btn = e.target.closest(".thumb-del");
            if (!btn) return;
            const cert  = btn.closest(".cert");
            const input = cert.querySelector(".bl-input");
            const cur   = ensureStore(input);
            const idx   = Number(btn.dataset.index);
            if (idx>=0 && idx<cur.length) cur.splice(idx,1);
            fileStore.set(input, cur);
            syncInputFiles(input);
            renderFor(input);
          });

          // Khóa trùng danh mục giữa 2 chứng chỉ
          function syncCategorySelects(){
            const selects = Array.from(list.querySelectorAll('.cert select[name$=".CategoryId"]'));
            const chosen  = new Map();
            selects.forEach(s => { if (s.value) chosen.set(s.value, (chosen.get(s.value)||0)+1); });
            selects.forEach(s => {
              const myVal = s.value;
              s.querySelectorAll("option").forEach(opt=>{
                if (!opt.value) return;
                const used = chosen.get(opt.value)||0;
                opt.disabled = (opt.value !== myVal && used > 0);
              });
            });
          }
          list.addEventListener("change", (e)=>{
            if (e.target.matches('.cert select[name$=".CategoryId"]')) {
              syncCategorySelects(); 
              enableSubmit();
              
              // Đảm bảo ảnh vẫn hiển thị sau khi thay đổi category
              const cert = e.target.closest(".cert");
              const input = cert.querySelector(".bl-input");
              if (input) {
                renderFor(input);
              }
            }
          });

          // Thêm chứng chỉ (tối đa 2)
          btnAdd?.addEventListener("click", () => {
            const items = list.querySelectorAll(".cert");
            if (items.length >= 2) return;

            const tmpl  = items[items.length - 1];
            const clone = tmpl.cloneNode(true);

            // reset giá trị - CHỈ reset form fields, KHÔNG động vào fileStore
            clone.querySelectorAll("input, textarea, select").forEach(el=>{
              if (el.type === "file") {
                el.value = ""; // reset input value
                // KHÔNG xóa fileStore - để giữ ảnh đã chọn
              } else {
                el.value = "";
              }
            });
            
            // Reset UI elements cho certificate mới
            const blName = clone.querySelector(".bl-name");
            const blGrid = clone.querySelector(".bl-previews");
            if (blName) blName.textContent = "Chưa chọn tệp";
            if (blGrid) blGrid.innerHTML = "";

            list.insertBefore(clone, btnAdd);

            renumberCerts();         // đánh lại name/id cho .NET bind
            wireAutosize(clone);
            syncCertUI();
            enableSubmit();

            // bind input file của khung mới - tạo kho mới riêng
            const newInput = clone.querySelector(".bl-input");
            ensureStore(newInput);   // kho rỗng riêng cho certificate mới
            bindFileInput(newInput); // gắn change cho khung mới
            
            // QUAN TRỌNG: Bind lại TẤT CẢ input files sau khi renumber
            // Vì renumber có thể làm mất event listeners
            list.querySelectorAll(".cert .bl-input").forEach(input => {
              bindFileInput(input); // Bind lại tất cả để đảm bảo hoạt động
            });
            
            // Force render lại tất cả certificates để đảm bảo ảnh hiển thị đúng
            list.querySelectorAll(".cert").forEach(cert => {
              const input = cert.querySelector(".bl-input");
              if (input) {
                renderFor(input);
              }
            });
          });

          // Xóa khung chứng chỉ
          list.addEventListener("click", (e)=>{
            const btn = e.target.closest(".btn-remove-cert,.iconbtn.close");
            if (!btn) return;
            const items = list.querySelectorAll(".cert");
            if (items.length <= 1) return;
            const cert = btn.closest(".cert");
            const input = cert.querySelector(".bl-input");
            // Xóa kho của khung bị xóa để giải phóng memory
            fileStore.delete(input);             
            cert.remove();
            renumberCerts();
            syncCertUI();
            enableSubmit();
          });

          // Đánh lại index (name/id/for) — KHÔNG động vào fileStore nên ảnh không "nhảy"
          function renumberCerts(){
            list.querySelectorAll(".cert").forEach((blk, i) => {
              blk.dataset.index = i;
              blk.querySelector(".pill").textContent = i + 1;
              const title = blk.querySelector(".cert__head strong");
              if (title) title.textContent = `Chứng chỉ ${i + 1}`;

              // 1) Cập nhật name để .NET bind đúng
              blk.querySelectorAll("[name]").forEach(el=>{
                el.name = el.name.replace(/Certificates\[\d+\]/g, `Certificates[${i}]`);
              });

              // 2) Cập nhật ID của input file
              const input = blk.querySelector(".bl-input");
              if (input) input.id = `BL_${i}`;

              // 3) Cập nhật TẤT CẢ label trỏ tới input file (cả nhãn tiêu đề và nút "Chọn ảnh")
              blk.querySelectorAll('label[for^="BL_"]').forEach(lab=>{
                lab.setAttribute("for", `BL_${i}`);
              });

              // 4) Đồng bộ lại files vào input + render đúng khung
              // QUAN TRỌNG: Chỉ render lại UI, KHÔNG làm mất fileStore
              if (input) {
                // Đảm bảo fileStore vẫn tồn tại trước khi sync
                const files = ensureStore(input);
                syncInputFiles(input);
                renderFor(input);
                
                // Bind lại event listener cho input này
                bindFileInput(input);
              }
            });

            syncCategorySelects();
          }


          function syncCertUI(){
            const items = list.querySelectorAll(".cert");
            list.querySelectorAll(".btn-remove-cert").forEach(b => b.classList.toggle("d-none", items.length <= 1));
            const atMax = items.length >= 2;
            btnAdd.disabled = atMax;
            btnAdd.textContent = atMax ? "— Đã tối đa 2 chứng chỉ —" : "+ Thêm chứng chỉ";
            btnAdd.classList.toggle("disabled", atMax);
          }

          // Enable submit (Tên + Category CC1)
          function enableSubmit(){
            const firstCat = list.querySelector('select[name="Certificates[0].CategoryId"]');
            const okName   = (nameEl?.value.trim().length || 0) > 0;
            const okCat    = !firstCat || !!firstCat.value;
            btnSubmit.disabled = !(okName && okCat);
          }
          nameEl?.addEventListener("input", enableSubmit);

          // ===== init =====
          // bind TẤT CẢ input files từ đầu
          list.querySelectorAll(".cert .bl-input").forEach(input => {
            ensureStore(input);
            bindFileInput(input);
          });

          renumberCerts();
          syncCertUI();
          enableSubmit();
          
          // Force render tất cả certificates khi trang load
          list.querySelectorAll(".cert").forEach(cert => {
            const input = cert.querySelector(".bl-input");
            if (input) {
              renderFor(input);
            }
          });

          // Submit AJAX JSON — loại bỏ redirect/banner
          const form = document.getElementById("providerForm");
          form?.addEventListener("submit", async (ev) => {
            // comprehensive validation for resubmit (Rejected)
            const errors = [];

            const providerName = nameEl?.value?.trim() || "";
            const phoneTrim    = phoneEl?.value?.trim() || "";
            const descVal      = descEl?.value || "";

            // basic field validation - BẮT BUỘC TẤT CẢ
            if (providerName.length === 0) {
              errors.push({ msg: "Vui lòng nhập tên Provider.", el: nameEl });
              nameEl?.classList.add('is-invalid');
            } else {
              nameEl?.classList.remove('is-invalid');
            }

            // BẮT BUỘC ảnh đại diện (cho cả lần đầu và resubmit)
            if (!fileInput?.files || fileInput.files.length === 0) {
              errors.push({ msg: "Vui lòng chọn ảnh đại diện.", el: fileInput });
              placeholder?.classList.add('is-invalid');
            } else {
              placeholder?.classList.remove('is-invalid');
            }

            // Validate phone number format (nếu có nhập)
            if (phoneTrim.length > 0) {
              const phoneRegex = /^[0-9]{10,11}$/;
              if (!phoneRegex.test(phoneTrim)) {
                errors.push({ msg: "Số điện thoại phải có 10-11 chữ số.", el: phoneEl });
                phoneEl?.classList.add('is-invalid');
              } else {
                phoneEl?.classList.remove('is-invalid');
              }
            }

            // BẮT BUỘC mô tả Provider
            if (descVal.trim().length === 0) {
              errors.push({ msg: "Vui lòng nhập mô tả dịch vụ.", el: descEl });
              descEl?.classList.add('is-invalid');
            } else {
              descEl?.classList.remove('is-invalid');
            }

            // BẮT BUỘC đồng ý điều khoản và bảo hiểm
            if (!agreeTermsEl?.checked) {
              errors.push({ msg: "Bạn phải đồng ý với Điều khoản dịch vụ và Chính sách bảo hiểm để tiếp tục đăng ký.", el: agreeTermsEl });
              termsWrapperEl?.classList.add('error');
              termsWrapperEl?.classList.remove('checked');
              termsErrorEl?.classList.remove('d-none');
            } else {
              termsWrapperEl?.classList.remove('error');
              termsWrapperEl?.classList.add('checked');
              termsErrorEl?.classList.add('d-none');
            }

            // certificates validation: at least 1
            const certBlocks = Array.from(list.querySelectorAll('.cert'));
            if (certBlocks.length === 0) {
              errors.push({ msg: "Vui lòng thêm ít nhất 1 chứng chỉ.", el: btnAdd });
            }
            certBlocks.forEach((blk, idx) => {
              const catSel = blk.querySelector('select[name$=".CategoryId"]');
              const descTa = blk.querySelector('textarea[name$=".Description"]');
              const input  = blk.querySelector('.bl-input');
              const files  = ensureStore(input);
              
              const errCat = blk.querySelector('.field-error');
              const errDesc = blk.querySelectorAll('.field-error')[2] || blk.querySelectorAll('.field-error')[1];
              const blErr = blk.querySelectorAll('.field-error')[1] || blk.querySelector('.field-error:nth-of-type(2)');
              
              // BẮT BUỘC chọn danh mục
              if (catSel && !catSel.value) {
                errors.push({ msg: `Vui lòng chọn danh mục cho chứng chỉ ${idx+1}.`, el: catSel });
                catSel.classList.add('is-invalid');
                errCat?.classList.remove('d-none');
              } else {
                catSel?.classList.remove('is-invalid');
                errCat?.classList.add('d-none');
              }
              
              // BẮT BUỘC nhập mô tả
              if ((descTa?.value?.trim()?.length || 0) === 0) {
                errors.push({ msg: `Vui lòng nhập mô tả cho chứng chỉ ${idx+1}.`, el: descTa });
                descTa?.classList.add('is-invalid');
                errDesc?.classList.remove('d-none');
              } else {
                descTa?.classList.remove('is-invalid');
                errDesc?.classList.add('d-none');
              }
              
              // BẮT BUỘC tải lên ít nhất 1 hình giấy phép
              if (!files || files.length === 0) {
                errors.push({ msg: `Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh cho chứng chỉ ${idx+1}.`, el: input });
                blErr?.classList.remove('d-none');
              } else {
                blErr?.classList.add('d-none');
              }
            });

            // file constraints and total size <= 50MB
            const MAX_TOTAL = 50 * 1024 * 1024;
            let totalBytes = 0;
            const allFiles = [];
            if (fileInput?.files?.[0]) allFiles.push(fileInput.files[0]);
            
            // Debug: log tất cả files trước khi submit
            console.log('=== SUBMIT DEBUG ===');
            certBlocks.forEach((blk, idx) => {
              const input = blk.querySelector('.bl-input');
              const files = ensureStore(input) || [];
              console.log(`Certificate ${idx + 1}:`, files.length, 'files in store');
              console.log(`Certificate ${idx + 1} input.files:`, input.files.length);
              
              // Đảm bảo sync files vào input trước khi submit
              syncInputFiles(input);
              console.log(`After sync - Certificate ${idx + 1} input.files:`, input.files.length);
              
              files.forEach(f => allFiles.push(f));
            });
            console.log('Total files to submit:', allFiles.length);
            
            allFiles.forEach(f => {
              if (!f.type.startsWith('image/')) errors.push({ msg: 'Tệp không hợp lệ (không phải ảnh).', el: null });
              totalBytes += f.size;
            });
            if (totalBytes > MAX_TOTAL) {
              errors.push({ msg: 'Tổng dung lượng tệp vượt quá 50MB.', el: null });
            }

            if (errors.length > 0) {
              ev.preventDefault();
              
              // Hiển thị tất cả lỗi (tối đa 5 lỗi đầu tiên)
              const errorMessages = errors.slice(0, 5).map(e => `• ${e.msg}`).join('\n');
              const moreErrors = errors.length > 5 ? `\n\n... và ${errors.length - 5} lỗi khác.` : '';
              alert(`Vui lòng kiểm tra lại thông tin:\n\n${errorMessages}${moreErrors}`);
              
              // Scroll đến trường có lỗi đầu tiên và focus
              const first = errors[0];
              if (first.el) {
                // Special handling for terms checkbox
                if (first.el === agreeTermsEl) {
                  scrollToTermsError();
                } else {
                  first.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  setTimeout(() => {
                    if (typeof first.el.focus === 'function') {
                      first.el.focus();
                    }
                  }, 500);
                }
              }
              
              return;
            }

            // trim values before submit
            if (nameEl) nameEl.value = providerName;
            if (phoneEl) phoneEl.value = phoneTrim;

            // QUAN TRỌNG: Sync tất cả files vào input trước khi submit
            certBlocks.forEach(blk => {
              const input = blk.querySelector('.bl-input');
              if (input) {
                syncInputFiles(input);
                console.log(`Final sync - Certificate input.files:`, input.files.length);
              }
            });

            ev.preventDefault();
            btnSubmit.disabled = true;
            const oldText = btnSubmit.textContent;
            btnSubmit.textContent = "Đang gửi...";

            try {
              const fd = new FormData(form);
              
              // Debug: log FormData contents
              console.log('=== FORMDATA DEBUG ===');
              for (let [key, value] of fd.entries()) {
                if (value instanceof File) {
                  console.log(`${key}: File(${value.name}, ${value.size} bytes)`);
                } else {
                  console.log(`${key}: ${value}`);
                }
              }
              
              // gửi giữ nguyên keys theo yêu cầu; không set Content-Type
              const res = await fetch(form.action, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: fd });

              if (res.status === 200) {
                const ok = await res.json(); // { ok: true, providerId, status, refresh } OR { ok:false,... }
                if (!ok || ok.ok !== true) {
                  alert(ok?.message || 'Đăng ký thất bại.');
                } else if (ok.refresh) {
                  localStorage.removeItem('myProvider');
                  window.location.reload();
                } else {
                  window.location.href = `${form.getAttribute('data-success') || '/Customer/RegisterProvider/Success'}?id=${encodeURIComponent(ok.providerId)}&stat=${encodeURIComponent(ok.status)}`;
                }
                return;
              }

              // lỗi 409 hoặc 400
              let err; try { err = await res.json(); } catch { err = { Message: 'Đăng ký thất bại.' }; }
              const msg = err?.Message || err?.message || 'Đăng ký thất bại.';
              const detail = err?.Detail || err?.detail;
              alert(detail ? `${msg}\n\nChi tiết: ${detail}` : msg);

              // map Errors[].Field
              if (Array.isArray(err?.Errors) || Array.isArray(err?.errors)) {
                const list = err.Errors || err.errors;
                const m = (field) => {
                  if (!field) return null;
                  if (field === 'PROVIDERNAME') return nameEl;
                  if (field === 'PHONENUMBER') return phoneEl;
                  if (field === 'DESCRIPTION') return descEl;
                  if (field === 'PROFILEIMAGE') return fileInput;
                  const mm = field.match(/^CERTIFICATES\[(\d+)\]\.(CATEGORYID|DESCRIPTION|BUSINESSLICENSES)$/i);
                  if (mm) {
                    const idx = Number(mm[1]);
                    const part = mm[2].toUpperCase();
                    const cert = document.querySelector(`.cert[data-index="${idx}"]`);
                    if (!cert) return null;
                    if (part === 'CATEGORYID') return cert.querySelector('select[name$=".CategoryId"]');
                    if (part === 'DESCRIPTION') return cert.querySelector('textarea[name$=".Description"]');
                    if (part === 'BUSINESSLICENSES') return cert.querySelector('.bl-input');
                  }
                  return null;
                };
                const first = list.find(e => !!(e.Field || e.field));
                const el = first ? m(first.Field || first.field) : null;
                if (el && el.classList) el.classList.add('is-invalid');
                if (el && el.scrollIntoView) el.scrollIntoView({behavior:'smooth',block:'center'});
                if (el && el.focus) el.focus();
              }
            } catch (ex) {
              alert('Không thể gửi đăng ký. Vui lòng thử lại.');
            } finally {
              btnSubmit.disabled = false;
              btnSubmit.textContent = oldText || 'Đăng ký Provider';
            }
          });

          // ===== COLLAPSIBLE TERMS & INSURANCE HANDLERS =====
          
          // Handle collapsible sections
          document.querySelectorAll('.terms-collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
              const targetId = this.getAttribute('data-target');
              const content = document.querySelector(targetId);
              const icon = this.querySelector('.terms-collapsible-icon');
              
              if (content) {
                const isOpen = content.classList.contains('open');
                
                if (isOpen) {
                  // Đóng
                  content.classList.remove('open');
                  icon?.classList.remove('rotate');
                } else {
                  // Mở
                  content.classList.add('open');
                  icon?.classList.add('rotate');
                }
              }
            });
          });

          // Handle checkbox change with animation
          agreeTermsEl?.addEventListener('change', () => {
            if (agreeTermsEl.checked) {
              termsWrapperEl?.classList.add('checked');
              termsWrapperEl?.classList.remove('error');
              termsErrorEl?.classList.add('d-none');
            } else {
              termsWrapperEl?.classList.remove('checked');
            }
          });

          // Handle clicking on wrapper
          termsWrapperEl?.addEventListener('click', (e) => {
            // Only toggle checkbox if not clicking on the checkbox itself
            if (e.target !== agreeTermsEl) {
              agreeTermsEl.checked = !agreeTermsEl.checked;
              agreeTermsEl.dispatchEvent(new Event('change'));
            }
          });

          // Add smooth scroll to terms section if there's an error
          function scrollToTermsError() {
            if (termsWrapperEl) {
              termsWrapperEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              termsWrapperEl.classList.add('error');
              setTimeout(() => {
                termsWrapperEl.classList.remove('error');
              }, 2000);
            }
          }

          // ===== Map API error (TempData banner) to fields =====
          // Bỏ map banner vì dùng flow JSON
          const apiErrEl = null;
          if (apiErrEl) {
            const msg = apiErrEl.textContent || "";
            function mark(el){ if(!el) return; el.classList.add('is-invalid'); try{ el.focus(); }catch{} }
            function scrollToEl(el){ if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); }
            if (msg.includes('Vui lòng nhập tên Provider')) { mark(nameEl); scrollToEl(nameEl); }
            else if (msg.includes('Vui lòng chọn danh mục cho chứng chỉ 1')) {
              const firstCat = list.querySelector('select[name="Certificates[0].CategoryId"]');
              mark(firstCat); scrollToEl(firstCat);
            }
            else if (msg.includes('Vui lòng chọn ảnh đại diện mới')) { scrollToEl(placeholder || fileInput); }
            else if (msg.includes('Vui lòng tải lên ít nhất 1 hình giấy phép kinh doanh')) {
              const firstBl = list.querySelector('.cert .bl-input');
              mark(firstBl); scrollToEl(firstBl);
            }
            else if (msg.includes('Ảnh đại diện không hợp lệ')) { mark(fileInput); scrollToEl(fileInput); }
          }

          // Map BE Errors[] with Field to exact inputs
          const apiErrorsJson = '@(TempData["ApiErrorsJson"] ?? "")';
          if (apiErrorsJson) {
            try {
              const errs = JSON.parse(apiErrorsJson);
              const fieldToEl = (field) => {
                if (!field) return null;
                if (field === 'PROVIDERNAME') return nameEl;
                if (field === 'PHONENUMBER') return phoneEl;
                if (field === 'DESCRIPTION') return descEl;
                if (field === 'PROFILEIMAGE') return fileInput;
                const m = field.match(/^CERTIFICATES\[(\d+)\]\.(CATEGORYID|DESCRIPTION|BUSINESSLICENSES)$/i);
                if (m) {
                  const idx = Number(m[1]);
                  const part = m[2].toUpperCase();
                  const cert = document.querySelector(`.cert[data-index="${idx}"]`);
                  if (!cert) return null;
                  if (part === 'CATEGORYID') return cert.querySelector('select[name$=".CategoryId"]');
                  if (part === 'DESCRIPTION') return cert.querySelector('textarea[name$=".Description"]');
                  if (part === 'BUSINESSLICENSES') return cert.querySelector('.bl-input');
                }
                return null;
              };
              let firstEl = null;
              errs.forEach(e => {
                const el = fieldToEl(e.Field);
                if (el && el.classList) el.classList.add('is-invalid');
                if (!firstEl && el) firstEl = el;
              });
              if (firstEl && firstEl.scrollIntoView) firstEl.scrollIntoView({behavior:'smooth',block:'center'});
              if (firstEl && firstEl.focus) firstEl.focus();
            } catch {}
          }
        })();
    </script>
}

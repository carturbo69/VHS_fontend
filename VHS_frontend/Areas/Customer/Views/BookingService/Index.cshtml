
@using VHS_frontend.Areas.Customer.Models.BookingServiceDTOs
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@model BookingViewModel
@{
    ViewData["Title"] = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string Money(decimal v) => string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:n0}₫", v);

    // CHỈNH: đặt sẵn id cho form chính để các input ở chỗ khác có thể "gửi chung"
    var placeOrderFormId = "placeOrderForm";
}

<!-- Google Maps API - Thêm libraries=marker để dùng AdvancedMarkerElement -->
@{
    var googleMapsApiKey = Configuration["GoogleMaps:ApiKey"] ?? "";
}
@if (!string.IsNullOrEmpty(googleMapsApiKey))
{
    <script src="https://maps.googleapis.com/maps/api/js?key=@googleMapsApiKey&libraries=places,marker&language=vi&region=VN"></script>
}

@if (Model.Address.Latitude.HasValue && Model.Address.Longitude.HasValue)
{
    <script>
        let map;
        let marker;
        
        async function initMap() {
            if (typeof google === 'undefined' || !google.maps) {
                console.error('Google Maps API chưa được load');
                return;
            }
            
            const lat = @Model.Address.Latitude.Value;
            const lng = @Model.Address.Longitude.Value;
            
            // Khởi tạo Google Maps
            map = new google.maps.Map(document.getElementById('addressMap'), {
                center: { lat: lat, lng: lng },
                zoom: 15,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
            });
            
            // Sử dụng AdvancedMarkerElement (thay vì Marker deprecated)
            try {
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                
                marker = new AdvancedMarkerElement({
                    map: map,
                    position: { lat: lat, lng: lng },
                    title: '@Html.Raw(Model.Address.ToDisplayString())'
                });
                
                // Thêm info window
                const infoWindow = new google.maps.InfoWindow({
                    content: '<div style="padding: 8px;"><strong>@Html.Raw(Model.Address.ToDisplayString())</strong></div>'
                });
                infoWindow.open(map, marker);
            } catch (error) {
                console.error('Error loading AdvancedMarkerElement, falling back to Marker:', error);
                // Fallback to old Marker if AdvancedMarkerElement fails
                marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: '@Html.Raw(Model.Address.ToDisplayString())',
                    draggable: false
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: '<div style="padding: 8px;"><strong>@Html.Raw(Model.Address.ToDisplayString())</strong></div>'
                });
                infoWindow.open(map, marker);
            }
        }
        
        // Khởi tạo bản đồ khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('addressMap')) {
                // Đợi Google Maps load xong
                if (typeof google !== 'undefined' && google.maps) {
                    initMap();
                } else {
                    // Retry sau 1 giây nếu chưa load
                    setTimeout(initMap, 1000);
                }
            }
        });
    </script>
}

@functions {
    string AddonSummary(IEnumerable<BookItemOption> opts)
    {
        if (opts == null) return "Chưa chọn";
        var list = opts.ToList();
        if (!list.Any()) return "Chưa chọn";
        return $"{list.Count} tuỳ chọn";
    }

    string AddonFullTitle(IEnumerable<BookItemOption> opts)
        => (opts != null && opts.Any())
            ? string.Join(", ", opts.Select(o => o.Name))
            : "Chưa chọn";
}

<link rel="stylesheet" href="~/css/booking-service.css" asp-append-version="true" />

<section class="checkout-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title-wrapper">
            <h1 class="page-title">Thanh Toán Dịch Vụ</h1>
            <p class="page-subtitle">Xác nhận thông tin và hoàn tất đặt dịch vụ của bạn</p>
        </div>
    </div>

    <!-- Toast notification cho error/success messages -->
    @if (TempData["ToastSuccess"] != null || TempData["ToastError"] != null)
    {
        <div class="custom-alert @(TempData["ToastSuccess"] != null ? "alert-success" : "alert-danger")" role="alert" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease-out;">
            <i class="bi @(TempData["ToastSuccess"] != null ? "bi-check-circle-fill" : "bi-exclamation-circle-fill")"></i>
            <div class="alert-content" style="flex: 1;">
                @(TempData["ToastSuccess"] ?? TempData["ToastError"])
            </div>
            <button type="button" class="alert-close" onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: inherit; opacity: 0.7;">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <style>
            .alert-success {
                background-color: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
            }
            .alert-danger {
                background-color: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
            }
            @@keyframes slideIn {
                from {
                    transform: translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        </style>
    }

    <!-- Địa chỉ nhận hàng -->
    <div class="address-card">
        <div class="addr-title">
            <span>📍 Địa Chỉ Nhận Hàng</span>
            <button type="button" class="btn" onclick="openAddressModal()">Thay đổi</button>
        </div>
        <div class="addr-body">
            <div id="currentRecipientInfo">
                <strong>
                    @(!string.IsNullOrEmpty(Model.Address.RecipientName) ? Model.Address.RecipientName : Model.RecipientFullName)
                </strong> 
                (@(!string.IsNullOrEmpty(Model.Address.RecipientPhone) ? Model.Address.RecipientPhone : Model.RecipientPhone))
            </div>
            <!-- ✅ thêm id để JS cập nhật khi chọn trong modal -->
            <div id="currentAddressText">@Model.Address.ToDisplayString()</div>
        </div>
        
        <!-- Bản đồ hiển thị vị trí -->
        @if (Model.Address.Latitude.HasValue && Model.Address.Longitude.HasValue)
        {
            <div id="addressMap" style="width: 100%; height: 250px; margin-top: 1rem; border-radius: 8px; overflow: hidden;"></div>
        }
    </div>

    <div class="grid">
        <div>
            @{
                // CHỈNH: tạo biến đếm index cho mảng Items[i]
                var i = 0;
            }
            @foreach (var shop in Model.Items.GroupBy(it => it.Provider))
            {
                <div class="shop-block">
                    <div class="shop-head">@shop.Key</div>

                    @foreach (var it in shop)
                    {
                        var key = it.CartItemId;
                        var options = it.Options ?? new List<BookItemOption>();

                        <div class="item-row">
                            <!-- Cột 1: Ảnh -->
                            <img class="thumb" src="@it.Image" alt="@it.ServiceName" />

                            <!-- Cột 2: Tên dịch vụ + Đơn giá -->
                            <div>
                                <div><strong>@it.ServiceName</strong></div>
                                <div class="service-price-info">
                                    <span class="price-label">Đơn giá:</span>
                                    <span class="price-value">@Money(it.UnitPrice)</span>
                                </div>
                            </div>

                            <!-- Cột 3: Tuỳ chọn hiển thị sẵn -->
                            <div class="cell-addons">
                                <div class="opt-section">
                                    @if (options.Any())
                                    {
                                        foreach (var a in options)
                                        {
                                            <div class="opt-row">
                                                <div class="opt-name">
                                                    <div>@a.Name</div>
                                                    @if (!string.IsNullOrWhiteSpace(a.Unit))
                                                    {
                                                        <div class="muted text-sm">@a.Unit</div>
                                                    }
                                                </div>

                                                <div class="opt-controls">
                                                    <span class="opt-price">+ @Money(a.Price)</span>
                                                    <form asp-area="Customer"
                                                          asp-controller="Cart"
                                                          asp-action="RemoveAddon"
                                                          method="post"
                                                          onsubmit="lockBtn(this)">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="cartItemId" value="@key" />
                                                        <input type="hidden" name="optionId" value="@a.OptionId" />
                                                        <button class="opt-remove" type="submit">Bỏ</button>
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="opt-empty muted">Chưa chọn tuỳ chọn</div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- ✅ CHÈN MỚI: gửi đúng danh sách OptionIds đang hiển thị cho item này -->
                        @for (var j = 0; j < options.Count; j++)
                        {
                            <input type="hidden"
                                   form="@placeOrderFormId"
                                   name="Items[@i].OptionIds[@j]"
                                   value="@options[j].OptionId" />
                        }


                        <!-- Các hidden khác giữ nguyên -->
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].CartItemId" value="@it.CartItemId" />
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].ServiceId" value="@it.ServiceId" />
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].ProviderId" value="@it.ProviderId" />

                        <!-- Giờ đặt -->
                        <div class="booking-time">
                            <label for="booking-time-@i" class="booking-label">
                                Chọn giờ thực hiện dịch vụ
                                <span class="hint">(dự kiến bắt đầu sau 30–45 phút kể từ thời điểm đặt)</span>
                            </label>
                            <input type="datetime-local"
                                   id="booking-time-@i"
                                   form="@placeOrderFormId"
                                   name="Items[@i].BookingTime"
                                   value="@it.BookingTime.ToString("yyyy-MM-ddTHH:mm")"
                                   class="booking-input"
                                   data-provider-id="@it.ProviderId"
                                   onchange="validateBookingTime(this, @i)" />
                            <div id="booking-time-error-@i" class="booking-time-error" style="display: none; color: #d00; margin-top: 5px; font-size: 0.9em;"></div>
                        </div>

                        i++;

                        <!-- nhớ tăng i sau mỗi item -->
                    }


                    @* ====== Ô tích + link mở điều khoản theo Provider ====== *@
                    @{
                        var firstItem = shop.FirstOrDefault();
                        var providerId = firstItem?.ProviderId ?? Guid.Empty;
                    }
                    <div class="tos-accept">
                        <input type="checkbox"
                               class="tos-check"
                               data-provider-id="@providerId"
                               onchange="syncTosHidden(this)" />
                        <div>
                            Tôi đã đọc và đồng ý
                            <a href="#"
                               class="tos-link"
                               data-provider-id="@providerId"
                               onclick="openTosModal('@providerId'); return false;">
                                Điều khoản dịch vụ
                            </a>
                            của nhà cung cấp này.
                        </div>

                        <!-- Hidden để post về server: TosAccepted[providerId] -->
                        <input type="hidden"
                               name="TosAccepted[@providerId]"
                               value="false"
                               form="@placeOrderFormId" />
                    </div>
                </div>
            }

            <!-- Voucher -->
            <div class="shop-block">
                <div class="voucher-row">
                    <div class="left">
                        <span class="voucher-badge">🏷️ Voucher</span>
                        <span class="muted" id="voucherHint">Chọn/nhập mã để áp dụng</span>
                    </div>
                    <button class="btn-ghost opt-btn" type="button" id="btnOpenVoucher" aria-expanded="false" aria-controls="opt_voucher">
                        Chọn voucher
                    </button>
                </div>

                <!-- gắn vào form chính -->
                @* <input type="hidden" form="@placeOrderFormId" name="VoucherCode" id="voucherCode" value="@Model.VoucherCode" /> *@
                <!-- ✅ chỉ gửi VoucherId -->
                <input type="hidden" form="@placeOrderFormId" name="VoucherId" id="voucherId" value="@Model.VoucherId" />
                <!-- 👇 thêm 2 input ẩn để client biết % và max từ server -->
                <input type="hidden" id="voucherPercent" value="@Model.VoucherPercent" />
                <input type="hidden" id="voucherMaxAmount" value="@Model.VoucherMaxAmount" />
            </div>

            <!-- Panel voucher (PORTAL) -->
            <div id="opt_voucher" class="opt-panel" hidden aria-label="Danh sách voucher" role="dialog" aria-modal="true">
                <div class="opt-card">
                    <div class="opt-head">
                        <h3>Voucher của bạn</h3>
                        <button class="btn-ghost" type="button" id="btnCloseVoucher" aria-label="Đóng">Đóng</button>
                    </div>

                    <div class="opt-body">
                        @* <div class="voucher-toolbar">
                            <input id="voucherInput" class="input" placeholder="Nhập mã voucher..." />
                            <button id="btnApplyTyped" class="btn" type="button">Áp dụng</button>
                        </div> *@

                        <div id="voucherList" class="voucher-list"></div>
                        <div class="tiny muted">* Chỉ voucher còn hiệu lực và còn lượt dùng mới có thể áp dụng.</div>
                    </div>
                </div>
            </div>

            <!-- Phương thức thanh toán -->
            <div class="shop-block">
                <div class="shop-head">Phương thức thanh toán</div>
                <div style="padding:12px 16px">
                    <div class="pm-list">
                        <!-- VNPay -->
                        <label class="pm @(Model.SelectedPaymentCode?.ToUpperInvariant() == "VNPAY" ? "active" : "")">
                            <input type="radio"
                                   form="@placeOrderFormId"
                                   name="SelectedPaymentCode"
                                   value="VNPAY"
                                   @(Model.SelectedPaymentCode?.ToUpperInvariant() == "VNPAY" ? "checked" : "")
                                   class="pm-radio"
                                   style="display:none" />
                            VNPay (QR/ATM/Thẻ)
                        </label>

                        <!-- MoMo -->
                        <label class="pm @(Model.SelectedPaymentCode?.ToUpperInvariant() == "MOMO" ? "active" : "")">
                            <input type="radio"
                                   form="@placeOrderFormId"
                                   name="SelectedPaymentCode"
                                   value="MOMO"
                                   @(Model.SelectedPaymentCode?.ToUpperInvariant() == "MOMO" ? "checked" : "")
                                   class="pm-radio"
                                   style="display:none" />
                            MoMo (Ví điện tử)
                        </label>

                        <!-- (tuỳ chọn) COD hoặc Bank Transfer nếu bạn vẫn muốn giữ -->
                        @* 
      <label class="pm @(Model.SelectedPaymentCode?.ToUpperInvariant()=="COD" ? "active" : "")">
        <input type="radio"
               form="@placeOrderFormId"
               name="SelectedPaymentCode"
               value="COD"
               @(Model.SelectedPaymentCode?.ToUpperInvariant()=="COD" ? "checked" : "")
               class="pm-radio"
               style="display:none" />
        Thanh toán khi nhận hàng
      </label>
      *@
                    </div>
                </div>
            </div>

        </div>

        <!-- Tóm tắt -->
        <div>
            <div class="summary-box">
                <div class="summary-header">
                    <h3>Tóm tắt đơn hàng</h3>
                </div>
                
                <form id="@placeOrderFormId" asp-area="Customer" asp-controller="BookingService" asp-action="PlaceOrder" method="post">
                    @Html.AntiForgeryToken()

                    <!-- ✅ Chuỗi địa chỉ sẽ ghi vào Booking.Address -->
                    <input type="hidden" name="AddressText" id="AddressText" value="@Model.Address.ToDisplayString()" />

                    <div class="row">
                        <span class="muted">Tổng tiền hàng</span>
                        <strong data-subtotal data-raw="@Model.Subtotal">@Money(Model.Subtotal)</strong>
                    </div>

                    @* Nếu có phí vận chuyển, bỏ comment block dưới và JS sẽ tự đọc qua data-shipping *@
                    @* <div class="row">
                        <span class="muted">Phí vận chuyển</span>
                        <strong data-shipping data-raw="@Model.ShippingFee">@Money(Model.ShippingFee)</strong>
                    </div> *@

                    <div class="row">
                        <span class="muted">Tổng cộng Voucher giảm giá</span>
                        <strong data-discount data-raw="@Model.VoucherDiscount">-@Money(Model.VoucherDiscount)</strong>
                    </div>

                    <hr />
                    <div class="row" style="font-size:20px">
                        <span>Tổng thanh toán</span>
                        <strong style="color:#ee4d2d" data-total data-raw="@Model.Total">@Money(Model.Total)</strong>
                    </div>

                    <div id="voucherBreakdown" class="muted tiny" style="margin-top:6px" hidden>
                        <div id="voucherAppliedInfo"></div>
                    </div>

                    <div class="summary-actions">
                        <button class="btn-cancel" type="button" onclick="cancelCheckout()">Hủy</button>
                        <button class="btn-place" type="submit">Đặt dịch vụ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Modal chọn địa chỉ -->
<div class="modal" id="addressModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Chọn địa chỉ nhận hàng</h3>
            <button class="btn" type="button" onclick="closeAddressModal()">✕</button>
        </div>

        <!-- ✅ KHÔNG submit nữa, chỉ để chọn và xác nhận -->
        <div style="margin-top:8px">
            <div class="addr-list">
                @if (Model.Addresses?.Any() == true)
                {
                    foreach (var addr in Model.Addresses)
                    {
                        var isChecked = addr.AddressId == Model.Address.AddressId ? "checked" : "";
                        <div class="addr-item"
                             data-id="@addr.AddressId"
                             data-province="@addr.ProvinceName"
                             data-district="@addr.DistrictName"
                             data-ward="@addr.WardName"
                             data-street="@addr.StreetAddress"
                             data-recipientname="@(addr.RecipientName ?? "")"
                             data-recipientphone="@(addr.RecipientPhone ?? "")"
                             data-latitude="@(addr.Latitude?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")"
                             data-longitude="@(addr.Longitude?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")">
                            <input type="radio" name="addressChoice" value="@addr.AddressId" @isChecked style="margin-top:3px" />
                            <div style="flex:1">
                                <div>
                                    <strong>@(!string.IsNullOrEmpty(addr.RecipientName) ? addr.RecipientName : Model.RecipientFullName)</strong> 
                                    (@(!string.IsNullOrEmpty(addr.RecipientPhone) ? addr.RecipientPhone : Model.RecipientPhone))
                                </div>
                                <div class="muted">@addr.ToDisplayString()</div>
                            </div>

                            <div style="display:flex;flex-direction:column;gap:4px">
                                <button type="button" class="btn small" onclick="openEditAddressForm(this)">📝</button>
                                <button type="submit"
                                        class="btn small"
                                        style="color:#d00"
                                        form="del-@addr.AddressId"
                                        onclick="return confirm('Xóa địa chỉ này?')">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div style="padding:16px" class="muted">Bạn chưa có địa chỉ nào.</div>
                }
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
                <button type="button" class="btn" onclick="closeAddressModal()">Hủy</button>
                <div style="display:flex;gap:8px">
                    <button type="button" class="btn" onclick="openCreateAddressForm()">➕ Thêm địa chỉ</button>
                    <!-- ✅ xác nhận chọn địa chỉ, cập nhật AddressText + UI -->
                    <button type="button" class="btn primary" onclick="applySelectedAddress()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
</div>

@foreach (var addr in Model.Addresses ?? new List<UserAddressDto>())
{
    <form id="del-@addr.AddressId" asp-area="Customer" asp-controller="Address" asp-action="Delete" asp-route-id="@addr.AddressId" method="post">
        @Html.AntiForgeryToken()
    </form>
}

<!-- Modal Upsert địa chỉ -->
<div class="modal" id="addressUpsertModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 id="upsertTitle" style="margin:0">Thêm địa chỉ</h3>
            <button class="btn" type="button" onclick="closeUpsertModal()">✕</button>
        </div>

        <form id="addressUpsertForm" asp-area="Customer" asp-controller="Address" asp-action="Upsert" method="post" style="margin-top:12px">
            @Html.AntiForgeryToken()
            <input type="hidden" name="AddressId" id="AddressId" />
            <!-- Hidden fields để lưu tọa độ -->
            <input type="hidden" id="Latitude" name="Latitude" />
            <input type="hidden" id="Longitude" name="Longitude" />

            <!-- Bản đồ để chọn vị trí -->
            <div class="form-row">
                <label>📍 Chọn vị trí trên bản đồ (nhấn vào bản đồ)</label>
                <div id="addressMapPicker" style="width: 100%; height: 300px; border-radius: 8px; border: 2px solid #e0e0e0; cursor: pointer;"></div>
                <small style="color: #666; margin-top: 4px;">Nhấn vào bản đồ để chọn vị trí chính xác</small>
            </div>

            <div class="form-row">
                <label for="streetAddress">Địa chỉ</label>
                <input type="text" id="streetAddress" name="streetAddress" required placeholder="Nhập địa chỉ hoặc chọn trên bản đồ" />
                <button type="button" id="btnGeocode" class="btn btn-sm" style="margin-top: 4px;" title="Lấy địa chỉ từ tọa độ đã chọn">
                    🔍 Lấy địa chỉ từ vị trí đã chọn
                </button>
            </div>

            <div class="form-grid-2">
                <div class="form-row">
                    <label for="wardName">Phường/Xã</label>
                    <input type="text" id="wardName" name="wardName" required />
                </div>
                <div class="form-row">
                    <label for="districtName">Quận/Huyện</label>
                    <input type="text" id="districtName" name="districtName" placeholder="Quận/Huyện (tùy chọn)" />
                </div>
            </div>
            <div class="form-row">
                <label for="provinceName">Tỉnh/Thành</label>
                <input type="text" id="provinceName" name="provinceName" required />
            </div>

            <div class="form-grid-2">
                <div class="form-row">
                    <label for="recipientName">Tên người đặt</label>
                    <input type="text" id="recipientName" name="recipientName" placeholder="Nhập tên người đặt" />
                </div>
                <div class="form-row">
                    <label for="recipientPhone">Số điện thoại người đặt</label>
                    <input type="tel" id="recipientPhone" name="recipientPhone" placeholder="Nhập số điện thoại" />
                </div>
            </div>

            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
                <button type="button" class="btn" onclick="closeUpsertModal()">Hủy</button>
                <button type="submit" class="btn primary" id="btnSaveAddress">Lưu</button>
            </div>
        </form>
        <script>
        // Validate form trước khi submit
        (function() {
          const form = document.getElementById('addressUpsertForm');
          if (!form) return;
          
          form.addEventListener('submit', function(e) {
            console.log('=== Form submit triggered ===');
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            
            const street = document.getElementById('streetAddress')?.value.trim() || '';
            const ward = document.getElementById('wardName')?.value.trim() || '';
            const province = document.getElementById('provinceName')?.value.trim() || '';
            const lat = document.getElementById('Latitude')?.value.trim() || '';
            const lng = document.getElementById('Longitude')?.value.trim() || '';
            const district = document.getElementById('districtName')?.value.trim() || '';
            const recipientName = document.getElementById('recipientName')?.value.trim() || '';
            const recipientPhone = document.getElementById('recipientPhone')?.value.trim() || '';
            
            console.log('Form values:', { street, ward, province, lat, lng, district, recipientName, recipientPhone });
            
            if (!street || !ward || !province) {
              e.preventDefault();
              e.stopPropagation();
              alert('Vui lòng điền đầy đủ thông tin địa chỉ (Địa chỉ, Phường/Xã, Tỉnh/Thành)');
              return false;
            }
            
            if (!lat || !lng) {
              console.warn('Missing coordinates, but allowing submission');
              // Không chặn nếu thiếu tọa độ, chỉ cảnh báo
            }
            
            // Nếu mọi thứ OK, form sẽ submit bình thường
            console.log('Form validation passed, submitting...');
            console.log('Form action URL:', form.action);
            return true;
          });
          
          // Không cần xử lý gì, để form submit tự nhiên
          const btnSave = document.getElementById('btnSaveAddress');
          if (btnSave) {
            console.log('Save button found');
          } else {
            console.error('Save button NOT found!');
          }
          
          // Debug: Log khi form loaded
          console.log('Address form initialized');
          console.log('Form element:', form);
          console.log('Save button:', btnSave);
        })();
        </script>
    </div>
</div>

<style>
/* Form grid styles */
.form-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-row {
    display: flex;
    flex-direction: column;
}

.form-row label {
    margin-bottom: 0.25rem;
    font-weight: 500;
    color: #333;
}

.form-row input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

@@media (max-width: 768px) {
    .form-grid-2 {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Modal Điều khoản dịch vụ -->
<div class="modal" id="tosModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Điều khoản dịch vụ</h3>
            <button class="btn" type="button" onclick="closeTosModal()">✕</button>
        </div>
        <div id="tosModalBody" style="margin-top:12px; max-height:65vh; overflow:auto">
            <!-- Nội dung nạp qua AJAX -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
                  function cancelCheckout() {
            window.location.href = '/Customer/Cart/Index';
        }

                /* ========= Chọn phương thức thanh toán: chỉ đổi UI, KHÔNG auto submit ========= */
        (function bindPaymentPickUIOnly(){
          // Toggle .active khi đổi radio
          document.querySelectorAll('input.pm-radio[name="SelectedPaymentCode"]').forEach(r => {
            r.addEventListener('change', (e) => {
              document.querySelectorAll('.pm').forEach(l => l.classList.remove('active'));
              e.target.closest('.pm')?.classList.add('active');
            });
          });

          // Click vào label (radio ẩn) vẫn cập nhật .active
          document.querySelectorAll('.pm').forEach(lab => {
            lab.addEventListener('click', () => {
              setTimeout(() => {
                const checked = document.querySelector('input.pm-radio[name="SelectedPaymentCode"]:checked');
                document.querySelectorAll('.pm').forEach(l => l.classList.remove('active'));
                checked?.closest('.pm')?.classList.add('active');
              }, 0);
            });
          });

          // Khởi tạo trạng thái .active đúng theo model khi load
          document.addEventListener('DOMContentLoaded', () => {
            const checked = document.querySelector('input.pm-radio[name="SelectedPaymentCode"]:checked');
            if (checked) checked.closest('.pm')?.classList.add('active');
          });
        })();

        /* ========= Validate trước khi submit: phải có Payment + TOS + Địa chỉ ========= */
        (function validateBeforeSubmit(){
          const form = document.getElementById('@placeOrderFormId');
          if(!form) return;

          function allTosAccepted(){
            const allChecks = Array.from(document.querySelectorAll('.tos-check'));
            return allChecks.length === 0 || allChecks.every(x => x.checked);
          }
          function hasAddress(){
            const v = (document.getElementById('AddressText')?.value || '').trim();
            return v.length > 0;
          }

          form.addEventListener('submit', function(e){
            const chosen = document.querySelector('input.pm-radio[name="SelectedPaymentCode"]:checked');
            if(!chosen){
              e.preventDefault();
              alert('Vui lòng chọn phương thức thanh toán.');
              return;
            }
            if(!allTosAccepted()){
              e.preventDefault();
              alert('Vui lòng đồng ý điều khoản của tất cả nhà cung cấp.');
              return;
            }
            if(!hasAddress()){
              e.preventDefault();
              alert('Vui lòng chọn địa chỉ nhận hàng.');
              return;
            }
            // Cho submit bình thường -> Controller PlaceOrder -> switch-case redirect
          });
        })();

        /* ========= Modal chọn địa chỉ ========= */
        function openAddressModal(){ document.getElementById('addressModal').classList.add('open'); }
        function closeAddressModal(){ document.getElementById('addressModal').classList.remove('open'); }

        /* ✅ Áp địa chỉ đang chọn trong modal vào hidden + UI */
        function applySelectedAddress(){
          const checked = document.querySelector('.addr-item input[type="radio"][name="addressChoice"]:checked');
          if(!checked){ closeAddressModal(); return; }
          const row = checked.closest('.addr-item');
          const parts = [row.dataset.street, row.dataset.ward, row.dataset.district, row.dataset.province]
                        .filter(s => s && s.trim() !== '');
          const text = parts.join(', ');
          
          // Cập nhật địa chỉ
          const hidden = document.getElementById('AddressText');
          const view = document.getElementById('currentAddressText');
          if(hidden) hidden.value = text;
          if(view) view.textContent = text;
          
          // Cập nhật tên và số điện thoại người đặt
          const recipientInfo = document.getElementById('currentRecipientInfo');
          if(recipientInfo) {
            const recipientName = row.dataset.recipientname || '';
            const recipientPhone = row.dataset.recipientphone || '';
            
            // Lấy giá trị mặc định từ data attributes của modal hoặc từ Model (nếu có)
            const defaultName = '@(Model.RecipientFullName ?? "")';
            const defaultPhone = '@(Model.RecipientPhone ?? "")';
            
            // Nếu có thông tin từ địa chỉ, dùng nó; nếu không, dùng giá trị mặc định
            const name = recipientName || defaultName;
            const phone = recipientPhone || defaultPhone;
            recipientInfo.innerHTML = `<strong>${name}</strong> (${phone})`;
          }
          
          closeAddressModal();
        }

        /* ========= Modal Upsert Address ========= */
        let addressPickerMap, addressPickerMarker; // Google Maps objects
        
        function openCreateAddressForm(){
          document.getElementById('upsertTitle').innerText = 'Thêm địa chỉ';
          document.getElementById('AddressId').value = '';
          document.getElementById('streetAddress').value = '';
          document.getElementById('wardName').value = '';
          document.getElementById('provinceName').value = '';
          document.getElementById('districtName').value = '';
          document.getElementById('recipientName').value = '';
          document.getElementById('recipientPhone').value = '';
          document.getElementById('Latitude').value = '';
          document.getElementById('Longitude').value = '';
          
          // Khởi tạo bản đồ cho modal
          setTimeout(() => {
            initAddressPickerMap();
          }, 300);
          
          document.getElementById('addressUpsertModal').classList.add('open');
        }
        
        async function initAddressPickerMap() {
          // Kiểm tra Google Maps đã load chưa
          if (typeof google === 'undefined' || !google.maps) {
            console.error('Google Maps API chưa được load. Vui lòng kiểm tra API key và billing.');
            alert('Google Maps chưa sẵn sàng. Vui lòng kiểm tra:\n1. Maps JavaScript API đã được enable\n2. Billing account đã được link\n3. API key đúng trong appsettings.json');
            return;
          }
          
          // Khởi tạo bản đồ Google Maps
          if (!addressPickerMap) {
            // Mặc định: Cần Thơ
            const defaultLat = parseFloat(document.getElementById('Latitude').value) || 10.0452;
            const defaultLng = parseFloat(document.getElementById('Longitude').value) || 105.7469;
            
            try {
              // Khởi tạo Google Maps
              addressPickerMap = new google.maps.Map(document.getElementById('addressMapPicker'), {
                center: { lat: defaultLat, lng: defaultLng },
                zoom: 13,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
              });
              
              // Sử dụng AdvancedMarkerElement (thay vì Marker deprecated)
              try {
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                
                addressPickerMarker = new AdvancedMarkerElement({
                  map: addressPickerMap,
                  position: { lat: defaultLat, lng: defaultLng },
                  title: 'Kéo để chọn vị trí',
                  gmpDraggable: true
                });
                
                // Cập nhật tọa độ khi kéo marker
                addressPickerMarker.addListener('dragend', function(e) {
                  const pos = addressPickerMarker.position;
                  document.getElementById('Latitude').value = pos.lat;
                  document.getElementById('Longitude').value = pos.lng;
                });
              } catch (markerError) {
                console.error('Error loading AdvancedMarkerElement, falling back to Marker:', markerError);
                // Fallback to old Marker if AdvancedMarkerElement fails
                addressPickerMarker = new google.maps.Marker({
                  position: { lat: defaultLat, lng: defaultLng },
                  map: addressPickerMap,
                  draggable: true,
                  title: 'Kéo để chọn vị trí'
                });
                
                // Cập nhật tọa độ khi kéo marker
                google.maps.event.addListener(addressPickerMarker, 'dragend', function(e) {
                  const pos = addressPickerMarker.getPosition();
                  document.getElementById('Latitude').value = pos.lat();
                  document.getElementById('Longitude').value = pos.lng();
                });
              }
              
              // Nhấn vào bản đồ để di chuyển marker
              addressPickerMap.addListener('click', function(e) {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();
                
                document.getElementById('Latitude').value = lat;
                document.getElementById('Longitude').value = lng;
                
                // Di chuyển marker đến vị trí mới
                if (addressPickerMarker.position) {
                  // AdvancedMarkerElement
                  addressPickerMarker.position = { lat: lat, lng: lng };
                } else if (addressPickerMarker.setPosition) {
                  // Old Marker
                  addressPickerMarker.setPosition({ lat: lat, lng: lng });
                }
              });
            } catch (error) {
              console.error('Error initializing Google Maps:', error);
              alert('Không thể khởi tạo bản đồ. Lỗi: ' + error.message + '\n\nVui lòng kiểm tra:\n1. Maps JavaScript API đã được enable\n2. Billing account đã được link\n\nHướng dẫn link billing:\nhttps://console.cloud.google.com/billing?project=vhs-maps');
              return;
            }
          } else {
            // Cập nhật vị trí nếu map đã được khởi tạo
            const lat = parseFloat(document.getElementById('Latitude').value) || 10.0452;
            const lng = parseFloat(document.getElementById('Longitude').value) || 105.7469;
            addressPickerMap.setCenter({ lat: lat, lng: lng });
            addressPickerMap.setZoom(13);
            if (addressPickerMarker) {
              if (addressPickerMarker.position) {
                // AdvancedMarkerElement
                addressPickerMarker.position = { lat: lat, lng: lng };
              } else if (addressPickerMarker.setPosition) {
                // Old Marker
                addressPickerMarker.setPosition({ lat: lat, lng: lng });
              }
            }
          }
        }
        
        // Nút "Lấy địa chỉ từ vị trí đã chọn" - Reverse Geocoding
        document.addEventListener('click', function(e) {
          if (e.target && e.target.id === 'btnGeocode') {
            const lat = document.getElementById('Latitude').value;
            const lng = document.getElementById('Longitude').value;
            
            if (!lat || !lng) {
              alert('Vui lòng chọn vị trí trên bản đồ trước');
              return;
            }
            
            // Hiển thị loading
            const btn = e.target;
            btn.disabled = true;
            btn.textContent = 'Đang tải...';
            
            // Gọi Google Geocoding API để lấy địa chỉ từ tọa độ
            const apiKey = '@googleMapsApiKey';
            if (!apiKey) {
              alert('Google Maps API key chưa được cấu hình trong appsettings.json');
              btn.disabled = false;
              btn.textContent = '🔍 Lấy địa chỉ từ vị trí đã chọn';
              return;
            }
            
            fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=vi&key=${apiKey}`)
              .then(response => response.json())
              .then(data => {
                console.log('Google Geocoding API Response:', data);
                
                // Kiểm tra lỗi từ API
                if (data.status === 'REQUEST_DENIED' || data.status === 'OVER_QUERY_LIMIT' || data.status === 'INVALID_REQUEST') {
                  alert(`Lỗi Google Maps API: ${data.error_message || data.status}\n\nVui lòng kiểm tra:\n1. Maps JavaScript API đã được enable\n2. Geocoding API đã được enable\n3. Billing account đã được link\n4. API key đúng trong appsettings.json`);
                  btn.disabled = false;
                  btn.textContent = '🔍 Lấy địa chỉ từ vị trí đã chọn';
                  return;
                }
                
                if (data && data.status === 'OK' && data.results && data.results.length > 0) {
                  const result = data.results[0];
                  console.log('=== Google Geocoding Response ===');
                  console.log(data);
                  console.log('=== First Result ===');
                  console.log(result);
                  
                  // Parse address components từ Google Geocoding API
                  const addressComponents = result.address_components || [];
                  let streetNumber = '';
                  let route = '';
                  let ward = '';
                  let district = '';
                  let province = '';
                  
                  // Parse từng component
                  addressComponents.forEach(component => {
                    const types = component.types || [];
                    const longName = component.long_name || '';
                    
                    if (types.includes('street_number')) {
                      streetNumber = longName;
                    } else if (types.includes('route')) {
                      route = longName;
                    } else if (types.includes('sublocality') || types.includes('sublocality_level_1') || 
                               types.includes('administrative_area_level_3')) {
                      // Phường/Xã
                      if (longName.includes('Phường') || longName.includes('Xã')) {
                        ward = longName.replace(/^(Phường|Xã)\s*/, '');
                      } else {
                        ward = longName;
                      }
                    } else if (types.includes('administrative_area_level_2')) {
                      // Quận/Huyện
                      if (longName.includes('Quận') || longName.includes('Huyện')) {
                        district = longName.replace(/^(Quận|Huyện)\s*/, '');
                      } else {
                        district = longName;
                      }
                    } else if (types.includes('administrative_area_level_1')) {
                      // Tỉnh/Thành phố
                      if (longName.includes('Tỉnh') || longName.includes('Thành phố')) {
                        province = longName.replace(/^(Tỉnh|Thành phố)\s*/, '');
                      } else {
                        province = longName;
                      }
                    }
                  });
                  
                  // Tạo street address từ street_number và route
                  const streetAddress = (streetNumber + ' ' + route).trim() || route || result.formatted_address.split(',')[0];
                  document.getElementById('streetAddress').value = streetAddress;
                  
                  document.getElementById('wardName').value = ward;
                  document.getElementById('districtName').value = district;
                  document.getElementById('provinceName').value = province;
                  
                  console.log('Final mapped:', { streetAddress, ward, district, province });
                  
                  btn.disabled = false;
                  btn.textContent = '🔍 Lấy địa chỉ từ vị trí đã chọn';
                  
                  // Kiểm tra và hiển thị thông báo
                  if (!ward && !district && !province) {
                    alert('Không thể tự động điền đầy đủ. Vui lòng kiểm tra console (F12) để xem dữ liệu từ API.');
                  } else {
                    let successMsg = 'Đã lấy địa chỉ thành công!';
                    if (!district) {
                      successMsg += '\nLưu ý: Không tìm thấy Quận/Huyện, bạn có thể nhập thủ công.';
                    }
                    alert(successMsg);
                  }
                } else if (data.status === 'ZERO_RESULTS') {
                  alert('Không tìm thấy địa chỉ tại vị trí này. Vui lòng thử lại hoặc chọn vị trí khác.');
                  btn.disabled = false;
                  btn.textContent = '🔍 Lấy địa chỉ từ vị trí đã chọn';
                } else {
                  alert(`Không thể lấy địa chỉ. Lỗi: ${data.status}${data.error_message ? ' - ' + data.error_message : ''}`);
                  btn.disabled = false;
                  btn.textContent = '🔍 Lấy địa chỉ từ vị trí đã chọn';
                }
              })
              .catch(error => {
                console.error('Geocoding error:', error);
                alert('Không thể lấy địa chỉ từ vị trí đã chọn');
                btn.disabled = false;
                btn.textContent = '🔍 Lấy địa chỉ từ vị trí đã chọn';
              });
          }
        });
        function openEditAddressForm(btn){
          const row = btn.closest('.addr-item');
          console.log('=== openEditAddressForm called ===');
          console.log('Row dataset:', row.dataset);
          
          document.getElementById('upsertTitle').innerText = 'Sửa địa chỉ';
          document.getElementById('AddressId').value = row.dataset.id || '';
          document.getElementById('streetAddress').value = row.dataset.street || '';
          document.getElementById('wardName').value = row.dataset.ward || '';
          document.getElementById('districtName').value = row.dataset.district || '';
          document.getElementById('provinceName').value = row.dataset.province || '';
          
          // Set tên và số điện thoại
          const recipientName = row.dataset.recipientname || '';
          const recipientPhone = row.dataset.recipientphone || '';
          document.getElementById('recipientName').value = recipientName;
          document.getElementById('recipientPhone').value = recipientPhone;
          
          console.log('Set values - RecipientName:', recipientName, 'RecipientPhone:', recipientPhone);
          console.log('Form fields after setting:', {
            recipientName: document.getElementById('recipientName').value,
            recipientPhone: document.getElementById('recipientPhone').value
          });
          
          // Set tọa độ nếu có
          const lat = row.dataset.latitude || '';
          const lng = row.dataset.longitude || '';
          document.getElementById('Latitude').value = lat;
          document.getElementById('Longitude').value = lng;
          
          // Mở modal và khởi tạo bản đồ với tọa độ (nếu có)
          document.getElementById('addressUpsertModal').classList.add('open');
          
          // Khởi tạo bản đồ với tọa độ đã có
          setTimeout(() => {
            if (lat && lng) {
              initAddressPickerMap();
              // Set marker tại vị trí đã có
              if (addressPickerMap && addressPickerMarker) {
                addressPickerMap.setView([parseFloat(lat), parseFloat(lng)], 15);
                addressPickerMarker.setLatLng([parseFloat(lat), parseFloat(lng)]);
              }
            } else {
              initAddressPickerMap();
            }
          }, 300);
        }
        function closeUpsertModal(){ document.getElementById('addressUpsertModal').classList.remove('open'); }

        /* ========= Lock submit button nhỏ ========= */
        function lockBtn(form){
          const btn = form.querySelector('button[type="submit"]');
          if(btn){ btn.disabled = true; btn.classList.add('is-loading'); }
          return true;
        }

        /* ========= Toggle panel GENERIC ========= */
        (function(){
          function closeAll(exceptId){
            document.querySelectorAll('.opt-panel').forEach(p=>{
              if(!exceptId || p.id !== exceptId){
                p.hidden = true;
                const b = document.querySelector('.opt-btn[aria-controls="'+p.id+'"]');
                if(b) b.setAttribute('aria-expanded','false');
              }
            });
          }
          document.addEventListener('click', function(e){
            const btn = e.target.closest('.opt-btn');
            const isVoucherBtn = btn && btn.id === 'btnOpenVoucher';

            if(btn && !isVoucherBtn){
              const id = btn.getAttribute('aria-controls');
              const el = document.getElementById(id);
              const expanded = btn.getAttribute('aria-expanded') === 'true';
              if(expanded){ el.hidden = true; btn.setAttribute('aria-expanded','false'); }
              else { closeAll(id); el.hidden = false; btn.setAttribute('aria-expanded','true'); }
              return;
            }

            const panel = e.target.closest('.opt-panel');
            if(!panel && !isVoucherBtn) closeAll();
          });
        })();

        /* ========= Voucher MODULE + TẠM TÍNH CLIENT ========= */
               (function(){
          const panel   = document.getElementById('opt_voucher');
          const btnOpen = document.getElementById('btnOpenVoucher');
          const btnClose= document.getElementById('btnCloseVoucher');
          const listEl  = document.getElementById('voucherList');
          const voucherIdInput = document.getElementById('voucherId');
          const voucherHint = document.getElementById('voucherHint');

          let VOUCHERS = null;
          let CURRENT_VOUCHER = null;

          const VND = n => (new Intl.NumberFormat('vi-VN')).format(Math.max(0, Math.round(n))) + '₫';
          const pick = (o, ...keys) => { for (const k of keys) if (o && k in o && o[k] != null) return o[k]; };

          function normalizeVoucher(o){
            if(!o) return null;
            return {
              VoucherId: pick(o,'VoucherId','voucherId','Id','id') ?? null,
              Code: pick(o,'Code','code') ?? '',
              Description: pick(o,'Description','description') ?? '',
              DiscountPercent: Number(pick(o,'DiscountPercent','discountPercent') || 0),
              DiscountMaxAmount: Number(pick(o,'DiscountMaxAmount','discountMaxAmount') || 0),
              StartDate: pick(o,'StartDate','startDate') ?? null,
              EndDate: pick(o,'EndDate','endDate') ?? null,
              IsActive: !!pick(o,'IsActive','isActive'),
              UsageLimit: pick(o,'UsageLimit','usageLimit'),
              UsedCount: Number(pick(o,'UsedCount','usedCount') || 0),
              RemainingUses: pick(o,'RemainingUses','remainingUses'),
              IsUnlimited: !!pick(o,'IsUnlimited','isUnlimited'),
              IsExpired: !!pick(o,'IsExpired','isExpired'),
              IsUpcoming: !!pick(o,'IsUpcoming','isUpcoming'),
              CanUseNow: !!pick(o,'CanUseNow','canUseNow'),
            };
          }
          function inDateRange(v) {
            const now = new Date();
            const s = v.StartDate ? new Date(v.StartDate) : null;
            const e = v.EndDate ? new Date(v.EndDate) : null;
            const okStart = !s || now >= s;
            const okEnd   = !e || now <= e;
            return okStart && okEnd;
          }
          function canUse(v) {
            const active = !!v.IsActive;
            const unlimited = !!v.IsUnlimited;
            const remaining = Number(v.RemainingUses ?? ((v.UsageLimit ?? null) && isFinite(v.UsageLimit) ? (v.UsageLimit - (v.UsedCount||0)) : NaN));
            const usesOk = unlimited || (isFinite(remaining) ? remaining > 0 : true);
            const daterangeOk = inDateRange(v) && !v.IsExpired && !v.IsUpcoming;
            return (active && usesOk && daterangeOk) || v.CanUseNow;
          }

          function updateVoucherUI() {
            const id = (voucherIdInput.value || '').trim();
            if (id) {
              const code = CURRENT_VOUCHER?.Code || 'Voucher đã chọn';
              voucherHint.textContent = `Đã áp dụng: ${code}`;
              btnOpen.textContent = 'Đổi voucher';
            } else {
              voucherHint.textContent = 'Chọn voucher để áp dụng';
              btnOpen.textContent = 'Chọn voucher';
            }
            ensureBreakdown();
          }

          function ensureBreakdown(){
            const bd = document.getElementById('voucherBreakdown');
            const info = document.getElementById('voucherAppliedInfo');
            if(CURRENT_VOUCHER && voucherIdInput.value){
              const pct  = CURRENT_VOUCHER.DiscountPercent || 0;
              const maxA = CURRENT_VOUCHER.DiscountMaxAmount;
              const end  = CURRENT_VOUCHER.EndDate;
              const code = CURRENT_VOUCHER.Code;
              info.textContent =
                (code ? `Áp dụng mã ${code} • ` : '') +
                `Giảm ${pct}%` +
                (maxA ? ` (tối đa ${VND(Number(maxA))})` : '') +
                (end  ? ` • HSD: ${new Date(end).toLocaleDateString('vi-VN')}` : '');
              bd.hidden = false;
            } else {
              info.textContent = '';
              bd.hidden = true;
            }
          }

          async function fetchVouchers(){
            try{
              const res = await fetch('@Url.Action("GetCartVouchers", "BookingService", new { area = "Customer" })', { credentials: 'same-origin' });
              if(!res.ok) throw new Error('Fetch vouchers failed');
              const data = await res.json();
              return Array.isArray(data) ? data : (data?.data ?? []);
            }catch(e){
              console.error(e);
              return [];
            }
          }

          async function openPanel(){
            btnOpen.setAttribute('aria-expanded','true');
            panel.hidden = false;
            panel.classList.add('open');
            if(VOUCHERS === null){
              VOUCHERS = await fetchVouchers();
              renderList(VOUCHERS);
            }
          }
          function closePanel(){
            btnOpen.setAttribute('aria-expanded','false');
            panel.classList.remove('open');
            panel.hidden = true;
          }

          function renderList(vouchers){
            listEl.innerHTML = '';
            const arr = (vouchers||[]).map(normalizeVoucher);
            if(arr.length === 0){
              listEl.innerHTML = `<div class="muted">Bạn chưa có voucher nào phù hợp.</div>`;
              return;
            }
            arr.forEach(v => {
              const usable = canUse(v);
              const end = v.EndDate ? new Date(v.EndDate).toLocaleDateString('vi-VN') : null;
              const remain = v.RemainingUses ?? ((v.UsageLimit ?? null) && isFinite(v.UsageLimit) ? (v.UsageLimit - (v.UsedCount||0)) : null);

              const item = document.createElement('div');
              item.className = 'voucher-item';
              item.innerHTML = `
                <div class="left">
                  <div class="title">
                    ${v.Code || '(Không có mã)'}
                    <span class="badge ${usable?'ok':(v.IsExpired?'danger':'warn')}">
                      ${usable ? 'Dùng được' : (v.IsExpired ? 'Hết hạn' : 'Chưa đến hạn/đã hết lượt')}
                    </span>
                  </div>
                  <div class="desc">${v.Description || 'Không có mô tả'}</div>
                  <div class="meta">
                    Giảm ${v.DiscountPercent}%${v.DiscountMaxAmount?` • Tối đa ${VND(v.DiscountMaxAmount)}`:''}
                    ${end?` • HSD: ${end}`:''}
                    ${remain!=null?` • Còn lượt: ${remain}`:''}
                  </div>
                </div>
                <div class="right">
                  <button class="apply"${usable?'':' disabled'}>Áp dụng</button>
                </div>
              `;
              item.querySelector('.apply')?.addEventListener('click', () => applyVoucher(v));
              listEl.appendChild(item);
            });
          }

          function getSummaryEls(){
            return {
              subtotalEl: document.querySelector('[data-subtotal]') || null,
              shippingEl: document.querySelector('[data-shipping]') || null,
              discountEl: document.querySelector('[data-discount]') || null,
              totalEl:    document.querySelector('[data-total]') || null
            };
          }
          function parseMoneyFromEl(el){
            if(!el) return 0;
            const raw = el.dataset?.raw;
            if(raw != null && raw !== '') return Number(raw)||0;
            const t = el.textContent || '';
            const m = t.replace(/[^\d\-]/g,'');
            return Number(m)||0;
          }
          function setMoney(el, amount, {prefix=''}={}){
            if(!el) return;
            const v = Math.max(0, Math.round(Number(amount||0)));
            el.dataset.raw = String(v);
            el.textContent = prefix + VND(v);
          }
          function computeDiscountLocal({subtotal, shipping}, voucher){
            if(!voucher || !canUse(voucher)) return 0;
            const base = subtotal + (parseMoneyFromEl(document.querySelector('[data-shipping]'))||0);
            const pct  = Number(voucher.DiscountPercent || 0) / 100;
            let discount = Math.round(base * pct);
            if (voucher.DiscountMaxAmount != null && isFinite(voucher.DiscountMaxAmount)) {
              discount = Math.min(discount, Number(voucher.DiscountMaxAmount));
            }
            return Math.max(0, discount);
          }
          function refreshTotalsLocal(){
            if (!CURRENT_VOUCHER) return;
            const {subtotalEl, shippingEl, discountEl, totalEl} = getSummaryEls();
            if(!subtotalEl || !discountEl || !totalEl) return;

            const subtotal = parseMoneyFromEl(subtotalEl);
            const shipping = parseMoneyFromEl(shippingEl);
            const discount = computeDiscountLocal({subtotal, shipping}, CURRENT_VOUCHER);
            const total    = Math.max(0, subtotal + shipping - discount);

            setMoney(discountEl, discount, {prefix:'-'});
            setMoney(totalEl, total);

            ensureBreakdown();
          }

          function applyVoucher(v){
            CURRENT_VOUCHER = normalizeVoucher(v);
            voucherIdInput.value = CURRENT_VOUCHER?.VoucherId || '';
            updateVoucherUI();
            closePanel();
            refreshTotalsLocal();
          }
          function removeVoucher(){
            CURRENT_VOUCHER = null;
            voucherIdInput.value = '';
            updateVoucherUI();
            refreshTotalsLocal();
          }
          window.removeVoucher = removeVoucher;

          btnOpen?.addEventListener('click', (e) => { e.stopPropagation(); openPanel(); });
          btnClose?.addEventListener('click', closePanel);
          panel?.addEventListener('click', (e)=>{ if(e.target === panel) closePanel(); });

          // Khởi tạo từ server (nếu đã có VoucherId trong model)
          (async function initFromServer(){
            const firstId = (voucherIdInput?.value || '').trim();
            const percent   = Number('@Model.VoucherPercent'.toString().replace(',', '.'));
            const maxAmount = Number('@Model.VoucherMaxAmount'.toString().replace(',', '.'));
            
            if(firstId){
              // ✅ Fetch đầy đủ thông tin voucher từ server để có Code
              try {
                const vouchers = await fetchVouchers();
                const found = vouchers.find(v => {
                  const vid = pick(v, 'VoucherId', 'voucherId', 'Id', 'id');
                  return vid && vid.toString().toLowerCase() === firstId.toLowerCase();
                });
                
                if (found) {
                  CURRENT_VOUCHER = normalizeVoucher(found);
                } else {
                  // Fallback nếu không tìm thấy trong danh sách
                  CURRENT_VOUCHER = { 
                    VoucherId: firstId, 
                    DiscountPercent: percent||0, 
                    DiscountMaxAmount: maxAmount||0,
                    Code: '' // để updateVoucherUI không bị lỗi
                  };
                }
              } catch (e) {
                console.error('Failed to load voucher details:', e);
                // Fallback
                CURRENT_VOUCHER = { 
                  VoucherId: firstId, 
                  DiscountPercent: percent||0, 
                  DiscountMaxAmount: maxAmount||0,
                  Code: ''
                };
              }
            }

            updateVoucherUI();
            if (CURRENT_VOUCHER) refreshTotalsLocal();
          })();

        })();

        /* ========= TOS ========= */
        async function openTosModal(providerId){
          const body = document.getElementById('tosModalBody');
          body.innerHTML = '<div class="muted">Đang tải điều khoản...</div>';
          try{
            const url = '@Url.Action("GetTermsByProvider", "BookingService", new { area = "Customer" })' + '?providerId=' + providerId;
            const res = await fetch(url, { method: 'GET', headers: { 'X-Requested-With':'XMLHttpRequest' } });
            if(res.ok){
              const html = await res.text();
              body.innerHTML = html;
            } else {
              body.innerHTML = '<div style="color:#c00">Không tải được điều khoản từ máy chủ.</div>';
            }
          }catch(err){
            body.innerHTML = '<div style="color:#c00">Không tải được điều khoản. Vui lòng thử lại.</div>';
          }
          document.getElementById('tosModal').classList.add('open');
        }
        function closeTosModal(){
          document.getElementById('tosModal').classList.remove('open');
          document.getElementById('tosModalBody').innerHTML = '';
        }
        function syncTosHidden(chk){
          const providerId = chk.getAttribute('data-provider-id');
          const hidden = document.querySelector(`input[type="hidden"][name="TosAccepted[${providerId}]"]`);
          if(hidden) hidden.value = chk.checked ? 'true' : 'false';
          updatePlaceOrderButtonState();
        }
        function updatePlaceOrderButtonState(){
          const submitBtn = document.querySelector('#@placeOrderFormId button[type="submit"]');
          if(!submitBtn) return;
          const allChecks = Array.from(document.querySelectorAll('.tos-check'));
          const allOk = allChecks.every(x => x.checked);
          submitBtn.disabled = !allOk;
        }
        document.addEventListener('DOMContentLoaded', updatePlaceOrderButtonState);

        /* ========= Validate Booking Time với Provider Schedule ========= */
        const API_BASE_URL = 'http://localhost:5154/api';
        const bookingTimeValidations = new Map(); // Track validation state for each input

        async function validateBookingTime(input, index) {
            const providerId = input.dataset.providerId;
            const dateTimeValue = input.value;
            
            if (!dateTimeValue || !providerId) {
                hideBookingTimeError(index);
                return true;
            }

            // Parse datetime-local value
            // datetime-local format: "yyyy-MM-ddTHH:mm" (24-hour format, no timezone)
            // Example: "2025-11-06T12:30" means 12:30 PM (noon)
            // Example: "2025-11-06T00:30" means 12:30 AM (midnight + 30 min)
            
            // Parse directly from string format "yyyy-MM-ddTHH:mm" to avoid timezone issues
            let date, time;
            if (dateTimeValue.includes('T')) {
                const [datePart, timePart] = dateTimeValue.split('T');
                date = datePart; // Already in yyyy-MM-dd format
                time = timePart; // Already in HH:mm format (24-hour)
            } else {
                // Fallback: parse using Date object
                const dateTime = new Date(dateTimeValue);
                const year = dateTime.getFullYear();
                const month = String(dateTime.getMonth() + 1).padStart(2, '0');
                const day = String(dateTime.getDate()).padStart(2, '0');
                date = `${year}-${month}-${day}`;
                
                const hours = String(dateTime.getHours()).padStart(2, '0');
                const minutes = String(dateTime.getMinutes()).padStart(2, '0');
                time = `${hours}:${minutes}`;
            }
            
            console.log('Validating booking time:', { 
                dateTimeValue, 
                date, 
                time, 
                providerId,
                parsedHours: time.split(':')[0],
                parsedMinutes: time.split(':')[1]
            });

            const errorDiv = document.getElementById(`booking-time-error-${index}`);
            if (!errorDiv) return true;

            // Show loading state
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Đang kiểm tra...';
            errorDiv.style.color = '#666';

            try {
                const url = `${API_BASE_URL}/ProviderAvailability/${providerId}?date=${date}&time=${time}`;
                console.log('Calling API:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    // HTTP error (4xx, 5xx)
                    let errorMessage = `Lỗi kết nối (${response.status})`;
                    try {
                        const errorData = await response.json();
                        if (errorData.Message || errorData.message) {
                            errorMessage = errorData.Message || errorData.message;
                        } else if (errorData.Detail || errorData.detail) {
                            errorMessage = errorData.Detail || errorData.detail;
                        }
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage = errorText;
                        }
                    }
                    console.error('API Error:', response.status, errorMessage);
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = '#d00';
                    errorDiv.textContent = errorMessage;
                    input.classList.add('booking-input-error');
                    bookingTimeValidations.set(index, false);
                    return false;
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                console.log('API Response keys:', Object.keys(result));
                console.log('result.Success:', result.Success);
                console.log('result.success:', result.success);
                console.log('result.Data:', result.Data);
                console.log('result.data:', result.data);

                // Handle both Success and success (case-insensitive)
                const isSuccess = result.Success === true || result.success === true;
                const data = result.Data || result.data;
                
                if (isSuccess && data) {
                    const availability = data;
                    console.log('Availability data:', availability);
                    console.log('Availability keys:', Object.keys(availability));
                    console.log('IsAvailable:', availability.IsAvailable, 'isAvailable:', availability.isAvailable);
                    console.log('UnavailableReason:', availability.UnavailableReason, 'unavailableReason:', availability.unavailableReason);
                    
                    // Handle both PascalCase and camelCase property names
                    const isAvailable = availability.IsAvailable !== undefined ? availability.IsAvailable : availability.isAvailable;
                    const unavailableReason = availability.UnavailableReason || availability.unavailableReason;
                    
                    console.log('Final isAvailable:', isAvailable, 'unavailableReason:', unavailableReason);
                    
                    if (isAvailable === true) {
                        hideBookingTimeError(index);
                        bookingTimeValidations.set(index, true);
                        return true;
                    } else {
                        // Show error with reason
                        errorDiv.style.display = 'block';
                        errorDiv.style.color = '#d00';
                        errorDiv.textContent = unavailableReason || 'Không thể đặt dịch vụ vào thời gian này';
                        input.classList.add('booking-input-error');
                        bookingTimeValidations.set(index, false);
                        return false;
                    }
                } else {
                    // API returned but Success = false or no Data
                    console.warn('API returned false or no data:', result);
                    console.warn('isSuccess:', isSuccess, 'data:', data);
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = '#d00';
                    const errorMsg = result.Message || result.message || result.Detail || result.detail || 'Không thể kiểm tra tính khả dụng';
                    errorDiv.textContent = errorMsg;
                    input.classList.add('booking-input-error');
                    bookingTimeValidations.set(index, false);
                    return false;
                }
            } catch (error) {
                console.error('Error checking availability:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                errorDiv.style.display = 'block';
                errorDiv.style.color = '#d00';
                errorDiv.textContent = `Lỗi khi kiểm tra tính khả dụng: ${error.message || 'Vui lòng thử lại'}`;
                input.classList.add('booking-input-error');
                bookingTimeValidations.set(index, false);
                return false;
            }
        }

        function hideBookingTimeError(index) {
            const errorDiv = document.getElementById(`booking-time-error-${index}`);
            const input = document.getElementById(`booking-time-${index}`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            if (input) {
                input.classList.remove('booking-input-error');
            }
            bookingTimeValidations.set(index, true);
        }

        // Validate all booking times before submit
        async function validateAllBookingTimes() {
            const inputs = document.querySelectorAll('input[type="datetime-local"].booking-input');
            const promises = [];
            
            for (let i = 0; i < inputs.length; i++) {
                const input = inputs[i];
                const index = parseInt(input.id.replace('booking-time-', ''));
                if (!isNaN(index) && input.value) {
                    promises.push(validateBookingTime(input, index));
                }
            }
            
            const results = await Promise.all(promises);
            return results.every(r => r === true);
        }

        // Override form submit to validate booking times
        document.addEventListener('DOMContentLoaded', function() {
            const placeOrderForm = document.getElementById('@placeOrderFormId');
            if (placeOrderForm) {
                placeOrderForm.addEventListener('submit', async function(e) {
                    // Wait for all validations to complete
                    const validationPromises = [];
                    const inputs = document.querySelectorAll('input[type="datetime-local"].booking-input');
                    
                    for (let i = 0; i < inputs.length; i++) {
                        const input = inputs[i];
                        const index = parseInt(input.id.replace('booking-time-', ''));
                        if (!isNaN(index) && input.value) {
                            validationPromises.push(validateBookingTime(input, index));
                        }
                    }
                    
                    const results = await Promise.all(validationPromises);
                    const allValid = results.every(r => r === true);
                    
                    if (!allValid) {
                        e.preventDefault();
                        alert('Vui lòng kiểm tra lại thời gian đặt dịch vụ. Có một số thời gian không khả dụng.');
                        return false;
                    }
                });
            }
        });
    </script>
}


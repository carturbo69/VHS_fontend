
@using VHS_frontend.Areas.Customer.Models.BookingServiceDTOs
@model BookingViewModel
@{
    ViewData["Title"] = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string Money(decimal v) => string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:n0}₫", v);

    // CHỈNH: đặt sẵn id cho form chính để các input ở chỗ khác có thể "gửi chung"
    var placeOrderFormId = "placeOrderForm";
}

<!-- Leaflet Maps (OpenStreetMap) - FREE, không cần API Key -->
@if (Model.Address.Latitude.HasValue && Model.Address.Longitude.HasValue)
{
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        
        function initMap() {
            const lat = @Model.Address.Latitude.Value;
            const lng = @Model.Address.Longitude.Value;
            
            // Khởi tạo bản đồ
            map = L.map('addressMap').setView([lat, lng], 15);
            
            // Thêm layer tile từ OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Thêm marker
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup('@Html.Raw(Model.Address.ToDisplayString())', {
                autoPan: true,
                autoPanPadding: [20, 20],
                maxWidth: 250,
                className: 'address-popup'
            }).openPopup();
        }
        
        // Khởi tạo bản đồ khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('addressMap')) {
                initMap();
            }
        });
    </script>
}

<!-- Leaflet CSS & JS cho modal bản đồ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

@functions {
    string AddonSummary(IEnumerable<BookItemOption> opts)
    {
        if (opts == null) return "Chưa chọn";
        var list = opts.ToList();
        if (!list.Any()) return "Chưa chọn";
        return $"{list.Count} tuỳ chọn";
    }

    string AddonFullTitle(IEnumerable<BookItemOption> opts)
        => (opts != null && opts.Any())
            ? string.Join(", ", opts.Select(o => o.Name))
            : "Chưa chọn";
}

<link rel="stylesheet" href="~/css/booking-service.css" asp-append-version="true" />

<section class="checkout-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title-wrapper">
            <h1 class="page-title">Thanh Toán Dịch Vụ</h1>
            <p class="page-subtitle">Xác nhận thông tin và hoàn tất đặt dịch vụ của bạn</p>
        </div>
    </div>

    <!-- Toast notification đã được bỏ - chỉ hiển thị validation errors inline -->

    <!-- Địa chỉ nhận hàng -->
    @{
        // Kiểm tra địa chỉ hợp lệ: có AddressId hoặc có đầy đủ thông tin địa chỉ
        var addressDisplay = Model.Address?.ToDisplayString() ?? "";
        var hasAddressId = Model.Address?.AddressId != null && Model.Address.AddressId != Guid.Empty;
        var hasValidAddressParts = !string.IsNullOrWhiteSpace(Model.Address?.StreetAddress) &&
                                   !string.IsNullOrWhiteSpace(Model.Address?.ProvinceName) &&
                                   !string.IsNullOrWhiteSpace(Model.Address?.DistrictName);
        // Loại trừ các giá trị không hợp lệ như "0", "...", hoặc chỉ có dấu phẩy
        var isValidDisplay = !string.IsNullOrWhiteSpace(addressDisplay) && 
                            addressDisplay.Trim() != "0" && 
                            addressDisplay.Trim() != "..." &&
                            addressDisplay.Trim().Length > 5; // Địa chỉ hợp lệ phải có ít nhất 5 ký tự
        var hasAddress = hasAddressId || (hasValidAddressParts && isValidDisplay);
    }
    <div class="address-card" id="addressCardSection">
        <div class="addr-title">
            <span>📍 Địa Chỉ Đặt Dịch Vụ</span>
            <button type="button" class="btn" onclick="openAddressModal()">@(hasAddress ? "Thay đổi" : "Chọn địa chỉ")</button>
        </div>
        <div class="addr-body">
            @if (hasAddress)
            {
            <div id="currentRecipientInfo">
                <strong>
                    @(!string.IsNullOrEmpty(Model.Address.RecipientName) ? Model.Address.RecipientName : Model.RecipientFullName)
                </strong> 
                (@(!string.IsNullOrEmpty(Model.Address.RecipientPhone) ? Model.Address.RecipientPhone : Model.RecipientPhone))
            </div>
            <!-- ✅ thêm id để JS cập nhật khi chọn trong modal -->
            <div id="currentAddressText">@Model.Address.ToDisplayString()</div>
        
        <!-- Bản đồ hiển thị vị trí -->
        @if (Model.Address.Latitude.HasValue && Model.Address.Longitude.HasValue)
        {
            <div id="addressMap" style="width: 100%; height: 250px; margin-top: 1rem; border-radius: 8px; overflow: hidden;"></div>
        }
            }
            else
            {
                <div id="currentRecipientInfo" style="display: none;"></div>
                <div id="currentAddressText" class="address-empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-geo-alt"></i>
                    </div>
                    <p class="empty-state-title">Bạn chưa chọn địa chỉ đặt dịch vụ</p>
                    <p class="empty-state-desc">Vui lòng chọn địa chỉ để tiếp tục đặt dịch vụ</p>
                </div>
            }
        </div>
        <div id="addressError" class="validation-error" style="display: none;"></div>
    </div>

    <div class="grid">
        <div>
            @{
                // CHỈNH: tạo biến đếm index cho mảng Items[i]
                var i = 0;
            }
            @foreach (var shop in Model.Items.GroupBy(it => it.Provider))
            {
                <div class="shop-block">
                    <div class="shop-head">@shop.Key</div>

                    @foreach (var it in shop)
                    {
                        var key = it.CartItemId;
                        var options = it.Options ?? new List<BookItemOption>();

                        <div class="item-row">
                            <!-- Cột 1: Ảnh -->
                            <img class="thumb" src="@it.Image" alt="@it.ServiceName" />

                            <!-- Cột 2: Tên dịch vụ + Đơn giá -->
                            <div>
                                <div><strong>@it.ServiceName</strong></div>
                                <div class="service-price-info">
                                    <span class="price-label">Đơn giá:</span>
                                    <span class="price-value">@Money(it.UnitPrice)</span>
                                </div>
                            </div>

                            <!-- Cột 3: Tuỳ chọn hiển thị sẵn -->
                            <div class="cell-addons">
                                <div class="opt-section">
                                    @if (options.Any())
                                    {
                                        foreach (var a in options)
                                        {
                                            <div class="opt-row">
                                                <div class="opt-name">
                                                    <div>@a.Name</div>
                                                    @if (!string.IsNullOrWhiteSpace(a.Unit))
                                                    {
                                                        <div class="muted text-sm">@a.Unit</div>
                                                    }
                                                </div>

                                                <div class="opt-controls">
                                                    <span class="opt-price">+ @Money(a.Price)</span>
                                                    <form asp-area="Customer"
                                                          asp-controller="Cart"
                                                          asp-action="RemoveAddon"
                                                          method="post"
                                                          onsubmit="lockBtn(this)">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="cartItemId" value="@key" />
                                                        <input type="hidden" name="optionId" value="@a.OptionId" />
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="opt-empty muted">Chưa chọn tuỳ chọn</div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- ✅ CHÈN MỚI: gửi đúng danh sách OptionIds đang hiển thị cho item này -->
                        @for (var j = 0; j < options.Count; j++)
                        {
                            <input type="hidden"
                                   form="@placeOrderFormId"
                                   name="Items[@i].OptionIds[@j]"
                                   value="@options[j].OptionId" />
                        }


                        <!-- Các hidden khác giữ nguyên -->
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].CartItemId" value="@it.CartItemId" />
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].ServiceId" value="@it.ServiceId" />
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].ProviderId" value="@it.ProviderId" />
                        <input type="hidden" form="@placeOrderFormId" name="Items[@i].ServiceName" value="@it.ServiceName" />

                        <!-- Giờ đặt -->
                        <div class="booking-time">
                            <label for="booking-time-@i" class="booking-label">
                                Chọn giờ thực hiện dịch vụ
                                <span class="hint">(dự kiến bắt đầu sau 30–45 phút kể từ thời điểm đặt)</span>
                            </label>
                            <input type="datetime-local"
                                   id="booking-time-@i"
                                   form="@placeOrderFormId"
                                   name="Items[@i].BookingTime"
                                   value="@it.BookingTime.ToString("yyyy-MM-ddTHH:mm")"
                                   class="booking-input"
                                   data-provider-id="@it.ProviderId"
                                   onchange="validateBookingTime(this, @i)" />
                            <div id="booking-time-error-@i" class="booking-time-error" style="display: none;"></div>
                        </div>

                        i++;

                        <!-- nhớ tăng i sau mỗi item -->
                    }


                    @* ====== Ô tích + link mở điều khoản theo Provider ====== *@
                    @{
                        var firstItem = shop.FirstOrDefault();
                        var providerId = firstItem?.ProviderId ?? Guid.Empty;
                    }
                    <div class="tos-accept">
                        <input type="checkbox"
                               class="tos-check"
                               data-provider-id="@providerId"
                               onchange="syncTosHidden(this)" />
                        <div>
                            Tôi đã đọc và đồng ý
                            <a href="#"
                               class="tos-link"
                               data-provider-id="@providerId"
                               onclick="openTosModal('@providerId'); return false;">
                                Điều khoản dịch vụ
                            </a>
                            của nhà cung cấp này.
                        </div>

                        <!-- Hidden để post về server: TosAccepted[providerId] -->
                        <input type="hidden"
                               name="TosAccepted[@providerId]"
                               value="false"
                               form="@placeOrderFormId" />
                    </div>
                    <div class="tos-error validation-error" data-provider-id="@providerId" style="display: none;"></div>
                </div>
            }

            <!-- Voucher -->
            <div class="shop-block">
                <div class="voucher-row">
                    <div class="left">
                        <span class="voucher-badge">🏷️ Voucher</span>
                        <span class="muted" id="voucherHint">Chọn/nhập mã để áp dụng</span>
                    </div>
                    <button class="btn-ghost opt-btn" type="button" id="btnOpenVoucher" aria-expanded="false" aria-controls="opt_voucher">
                        Chọn voucher
                    </button>
                </div>

                <!-- gắn vào form chính -->
                @* <input type="hidden" form="@placeOrderFormId" name="VoucherCode" id="voucherCode" value="@Model.VoucherCode" /> *@
                <!-- ✅ chỉ gửi VoucherId -->
                <input type="hidden" form="@placeOrderFormId" name="VoucherId" id="voucherId" value="@Model.VoucherId" />
                <!-- 👇 thêm 2 input ẩn để client biết % và max từ server -->
                <input type="hidden" id="voucherPercent" value="@Model.VoucherPercent" />
                <input type="hidden" id="voucherMaxAmount" value="@Model.VoucherMaxAmount" />
            </div>

            <!-- Panel voucher (PORTAL) - Ẩn đi, dùng modal thay thế -->
            <div id="opt_voucher" class="opt-panel" hidden aria-label="Danh sách voucher" role="dialog" aria-modal="true" style="display:none;">
                <div class="opt-card">
                    <div class="opt-head">
                        <h3>Voucher của bạn</h3>
                        <button class="btn-ghost" type="button" id="btnCloseVoucher" aria-label="Đóng">Đóng</button>
                    </div>

                    <div class="opt-body">
                        <div id="voucherList" class="voucher-list"></div>
                        <div class="tiny muted">* Chỉ voucher còn hiệu lực và còn lượt dùng mới có thể áp dụng.</div>
                    </div>
                </div>
            </div>

            <!-- Phương thức thanh toán -->
            <div class="shop-block" id="paymentSection">
                <div class="shop-head">Phương thức thanh toán</div>
                <div style="padding:12px 16px">
                    <div class="pm-list">
                        <!-- VNPay -->
                        <label class="pm @(Model.SelectedPaymentCode?.ToUpperInvariant() == "VNPAY" ? "active" : "")">
                            <input type="radio"
                                   form="@placeOrderFormId"
                                   name="SelectedPaymentCode"
                                   value="VNPAY"
                                   @(Model.SelectedPaymentCode?.ToUpperInvariant() == "VNPAY" ? "checked" : "")
                                   class="pm-radio"
                                   style="display:none" />
                            VNPay (QR/ATM/Thẻ)
                        </label>

                        <!-- MoMo -->
                        <label class="pm @(Model.SelectedPaymentCode?.ToUpperInvariant() == "MOMO" ? "active" : "")">
                            <input type="radio"
                                   form="@placeOrderFormId"
                                   name="SelectedPaymentCode"
                                   value="MOMO"
                                   @(Model.SelectedPaymentCode?.ToUpperInvariant() == "MOMO" ? "checked" : "")
                                   class="pm-radio"
                                   style="display:none" />
                            MoMo (Ví điện tử)
                        </label>

                        <!-- (tuỳ chọn) COD hoặc Bank Transfer nếu bạn vẫn muốn giữ -->
                        @* 
      <label class="pm @(Model.SelectedPaymentCode?.ToUpperInvariant()=="COD" ? "active" : "")">
        <input type="radio"
               form="@placeOrderFormId"
               name="SelectedPaymentCode"
               value="COD"
               @(Model.SelectedPaymentCode?.ToUpperInvariant()=="COD" ? "checked" : "")
               class="pm-radio"
               style="display:none" />
        Thanh toán khi nhận hàng
      </label>
      *@
                    </div>
                </div>
                <div id="paymentError" class="validation-error" style="display: none;"></div>
            </div>

        </div>

        <!-- Tóm tắt -->
        <div>
            <div class="summary-box">
                <div class="summary-header">
                    <h3>Tóm tắt đơn hàng</h3>
                </div>
                
                <form id="@placeOrderFormId" asp-area="Customer" asp-controller="BookingService" asp-action="PlaceOrder" method="post">
                    @Html.AntiForgeryToken()

                    <!-- ✅ Chuỗi địa chỉ sẽ ghi vào Booking.Address -->
                    <input type="hidden" name="AddressText" id="AddressText" value="@Model.Address.ToDisplayString()" />

                    <div class="row">
                        <span class="muted">Tổng tiền hàng</span>
                        <strong data-subtotal data-raw="@Model.Subtotal">@Money(Model.Subtotal)</strong>
                    </div>

                    @* Nếu có phí vận chuyển, bỏ comment block dưới và JS sẽ tự đọc qua data-shipping *@
                    @* <div class="row">
                        <span class="muted">Phí vận chuyển</span>
                        <strong data-shipping data-raw="@Model.ShippingFee">@Money(Model.ShippingFee)</strong>
                    </div> *@

                    <div class="row">
                        <span class="muted">Tổng cộng Voucher giảm giá</span>
                        <strong data-discount data-raw="@Model.VoucherDiscount">-@Money(Model.VoucherDiscount)</strong>
                    </div>

                    <hr />
                    <div id="voucherBreakdown" class="muted tiny" style="margin-bottom: var(--s-4);" hidden>
                        <div id="voucherAppliedInfo"></div>
                    </div>

                    <div class="row" style="font-size:20px">
                        <span>Tổng thanh toán</span>
                        <strong style="color:#ee4d2d" data-total data-raw="@Model.Total">@Money(Model.Total)</strong>
                    </div>

                    <div class="summary-actions">
                        <button class="btn-cancel" type="button" onclick="cancelCheckout()">Hủy</button>
                        <button class="btn-place" type="submit">Đặt dịch vụ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Modal chọn địa chỉ -->
<div class="modal" id="addressModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Chọn địa chỉ đặt dịch vụ</h3>
            <button class="btn" type="button" onclick="closeAddressModal()">✕</button>
        </div>

        <!-- ✅ KHÔNG submit nữa, chỉ để chọn và xác nhận -->
        <div style="margin-top:8px">
            <!-- Vùng hiển thị thông báo trong modal -->
            <div id="addressModalAlert" style="display: none; margin-bottom: 12px;"></div>
            
            <div class="addr-list" id="addressListContainer">
                @if (Model.Addresses?.Any() == true)
                {
                    foreach (var addr in Model.Addresses)
                    {
                        var isChecked = addr.AddressId == Model.Address.AddressId ? "checked" : "";
                        <div class="addr-item"
                             data-id="@addr.AddressId"
                             data-province="@addr.ProvinceName"
                             data-district="@addr.DistrictName"
                             data-ward="@addr.WardName"
                             data-street="@addr.StreetAddress"
                             data-recipientname="@(addr.RecipientName ?? "")"
                             data-recipientphone="@(addr.RecipientPhone ?? "")"
                             data-latitude="@(addr.Latitude?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")"
                             data-longitude="@(addr.Longitude?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")">
                            <input type="radio" name="addressChoice" value="@addr.AddressId" @isChecked style="margin-top:3px" />
                            <div style="flex:1">
                                <div>
                                    <strong>@(!string.IsNullOrEmpty(addr.RecipientName) ? addr.RecipientName : Model.RecipientFullName)</strong> 
                                    (@(!string.IsNullOrEmpty(addr.RecipientPhone) ? addr.RecipientPhone : Model.RecipientPhone))
                                </div>
                                <div class="muted">@addr.ToDisplayString()</div>
                            </div>

                            <div style="display:flex;flex-direction:column;gap:4px">
                                <button type="button" class="btn small" onclick="openEditAddressForm(this)">📝</button>
                                <button type="button"
                                        class="btn small"
                                        style="color:#d00"
                                        onclick="deleteAddress('@addr.AddressId', this)">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div style="padding:16px" class="muted">Bạn chưa có địa chỉ nào.</div>
                }
            </div>

            <div class="address-modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeAddressModal()">Hủy</button>
                <div class="footer-actions">
                    <button type="button" class="btn btn-secondary" onclick="openCreateAddressForm()">
                        <span class="btn-icon">➕</span>
                        <span>Thêm địa chỉ</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="applySelectedAddress()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
</div>

@foreach (var addr in Model.Addresses ?? new List<UserAddressDto>())
{
    <form id="del-@addr.AddressId" asp-area="Customer" asp-controller="Address" asp-action="Delete" asp-route-id="@addr.AddressId" method="post">
        @Html.AntiForgeryToken()
    </form>
}

<!-- Modal Upsert địa chỉ -->
<div class="modal" id="addressUpsertModal">
    <div class="modal-card upsert-modal-card">
        <div class="upsert-modal-header">
            <h3 id="upsertTitle">Thêm địa chỉ</h3>
            <button class="btn-upsert-close" type="button" onclick="closeUpsertModal()" aria-label="Đóng">✕</button>
        </div>

        <form id="addressUpsertForm" asp-area="Customer" asp-controller="Address" asp-action="Upsert" method="post" class="upsert-form">
            @Html.AntiForgeryToken()
            <input type="hidden" name="AddressId" id="AddressId" />
            <!-- Hidden fields để lưu tọa độ -->
            <input type="hidden" id="Latitude" name="Latitude" />
            <input type="hidden" id="Longitude" name="Longitude" />

            <!-- Bản đồ để chọn vị trí -->
            <div class="form-row">
                <label class="form-label">📍 Chọn vị trí trên bản đồ (nhấn vào bản đồ)</label>
                <div id="addressMapPicker" class="map-picker"></div>
                <small class="form-hint">Nhấn vào bản đồ để chọn vị trí chính xác</small>
            </div>

            <div class="form-row">
                <div class="form-label-row">
                    <label for="streetAddress" class="form-label">Địa chỉ</label>
                    <button type="button" id="btnGeocode" class="btn-geocode" title="Lấy địa chỉ từ tọa độ đã chọn">
                        <span class="btn-icon">🔍</span>
                        <span>Lấy địa chỉ từ vị trí đã chọn</span>
                </button>
                </div>
                <input type="text" id="streetAddress" name="streetAddress" required placeholder="Nhập địa chỉ hoặc chọn trên bản đồ" class="form-input" />
            </div>

            <div class="form-grid-2">
                <div class="form-row">
                    <label for="wardName" class="form-label">Phường/Xã</label>
                    <input type="text" id="wardName" name="wardName" required class="form-input" placeholder="Nhập phường/xã" />
                </div>
                <div class="form-row">
                    <label for="provinceName" class="form-label">Tỉnh/Thành</label>
                    <input type="text" id="provinceName" name="provinceName" required class="form-input" placeholder="Nhập tỉnh/thành" />
                </div>
            </div>
            <!-- Hidden field để gửi districtName (optional) -->
            <input type="hidden" id="districtName" name="districtName" />

            <div class="form-grid-2">
                <div class="form-row">
                    <label for="recipientName" class="form-label">Tên người đặt</label>
                    <input type="text" id="recipientName" name="recipientName" placeholder="Nhập tên người đặt" class="form-input" />
                </div>
                <div class="form-row">
                    <label for="recipientPhone" class="form-label">Số điện thoại người đặt</label>
                    <input type="tel" id="recipientPhone" name="recipientPhone" placeholder="Nhập số điện thoại (VD: 0901234567)" class="form-input" />
                    <small class="phone-error-message" id="recipientPhoneError" style="display: none; color: var(--danger); margin-top: 4px; font-size: 0.875rem;"></small>
                </div>
            </div>

            <div id="upsertFormError" class="validation-error" style="display: none; margin-top: 12px;"></div>

            <div class="upsert-form-footer">
                <button type="button" class="btn-upsert-cancel" onclick="closeUpsertModal()">Hủy</button>
                <button type="submit" class="btn-upsert-save" id="btnSaveAddress">Lưu</button>
            </div>
        </form>
        <script>
        // Hàm validate số điện thoại Việt Nam
        function validateVietnamesePhone(phone) {
          if (!phone) return true; // Cho phép để trống (optional field)
          
          // Loại bỏ khoảng trắng, dấu gạch ngang, dấu ngoặc
          const cleaned = phone.replace(/[\s\-\(\)]/g, '');
          
          // Kiểm tra chỉ chứa số
          if (!/^\d+$/.test(cleaned)) {
            return false;
          }
          
          // Số điện thoại Việt Nam:
          // - 10 số: bắt đầu bằng 0 (VD: 0901234567, 0912345678)
          // - 11 số: bắt đầu bằng 84 (VD: 84901234567)
          // - Các đầu số hợp lệ: 03, 05, 07, 08, 09 (sau số 0)
          
          if (cleaned.length === 10 && cleaned.startsWith('0')) {
            // Kiểm tra đầu số hợp lệ (03, 05, 07, 08, 09)
            const validPrefixes = ['03', '05', '07', '08', '09'];
            const prefix = cleaned.substring(0, 2);
            return validPrefixes.includes(prefix);
          } else if (cleaned.length === 11 && cleaned.startsWith('84')) {
            // Kiểm tra đầu số hợp lệ sau khi bỏ 84 (03, 05, 07, 08, 09)
            const validPrefixes = ['03', '05', '07', '08', '09'];
            const prefix = cleaned.substring(2, 4);
            return validPrefixes.includes(prefix);
          }
          
          return false;
        }
        
        // Validate và submit form bằng AJAX
        (function() {
          const form = document.getElementById('addressUpsertForm');
          if (!form) return;
          
          // Real-time validation cho số điện thoại
          const phoneInput = document.getElementById('recipientPhone');
          const phoneError = document.getElementById('recipientPhoneError');
          
          if (phoneInput && phoneError) {
            // Validate khi blur (rời khỏi input)
            phoneInput.addEventListener('blur', function() {
              const phone = this.value.trim();
              if (phone && !validateVietnamesePhone(phone)) {
                this.classList.add('input-error');
                phoneError.textContent = '⚠️ Số điện thoại không hợp lệ. Vui lòng nhập số điện thoại 10 số (bắt đầu bằng 0) hoặc 11 số (bắt đầu bằng 84)';
                phoneError.style.display = 'block';
              } else {
                this.classList.remove('input-error');
                phoneError.style.display = 'none';
              }
            });
            
            // Xóa lỗi khi bắt đầu nhập lại
            phoneInput.addEventListener('input', function() {
              if (this.classList.contains('input-error')) {
                const phone = this.value.trim();
                if (!phone || validateVietnamesePhone(phone)) {
                  this.classList.remove('input-error');
                  phoneError.style.display = 'none';
                }
              }
            });
          }
          
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const street = document.getElementById('streetAddress')?.value.trim() || '';
            const ward = document.getElementById('wardName')?.value.trim() || '';
            const province = document.getElementById('provinceName')?.value.trim() || '';
            const lat = document.getElementById('Latitude')?.value.trim() || '';
            const lng = document.getElementById('Longitude')?.value.trim() || '';
            const district = document.getElementById('districtName')?.value.trim() || '';
            const recipientName = document.getElementById('recipientName')?.value.trim() || '';
            const recipientPhone = document.getElementById('recipientPhone')?.value.trim() || '';
            const addressId = document.getElementById('AddressId')?.value.trim() || '';
            
            if (!street || !ward || !province) {
              const errorEl = document.getElementById('upsertFormError');
              if (errorEl) {
                errorEl.textContent = '⚠️ Vui lòng điền đầy đủ thông tin địa chỉ (Địa chỉ, Phường/Xã, Tỉnh/Thành)';
                errorEl.style.display = 'block';
                errorEl.style.visibility = 'visible';
                errorEl.style.opacity = '1';
                // Scroll đến thông báo lỗi
                setTimeout(() => {
                  errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                // Tự động ẩn sau 3 giây
                setTimeout(() => {
                  errorEl.style.display = 'none';
                  errorEl.style.visibility = 'hidden';
                  errorEl.style.opacity = '0';
                }, 3000);
              }
              return false;
            }
            
            // Validate số điện thoại nếu có nhập
            if (recipientPhone && !validateVietnamesePhone(recipientPhone)) {
              const phoneInput = document.getElementById('recipientPhone');
              const phoneError = document.getElementById('recipientPhoneError');
              if (phoneInput && phoneError) {
                phoneInput.classList.add('input-error');
                phoneError.textContent = '⚠️ Số điện thoại không hợp lệ. Vui lòng nhập số điện thoại 10 số (bắt đầu bằng 0) hoặc 11 số (bắt đầu bằng 84)';
                phoneError.style.display = 'block';
                phoneInput.focus();
                phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              return false;
            }
            
            // Kiểm tra trùng lặp địa chỉ (chỉ khi tạo mới, không phải edit)
            if (!addressId || addressId === '') {
              // Lấy tất cả địa chỉ hiện có từ DOM
              const existingAddresses = document.querySelectorAll('.addr-item');
              const normalizedPhone = recipientPhone ? recipientPhone.replace(/[\s\-\(\)]/g, '') : '';
              const normalizedName = recipientName ? recipientName.trim().toLowerCase() : '';
              const normalizedAddress = [street, ward, district, province]
                .filter(s => s && s.trim() !== '')
                .map(s => s.trim().toLowerCase())
                .join(', ');
              
              for (const addrItem of existingAddresses) {
                const existingId = addrItem.getAttribute('data-id');
                // Bỏ qua địa chỉ đang edit (nếu có)
                if (existingId === addressId) continue;
                
                const existingName = (addrItem.getAttribute('data-recipientname') || '').trim().toLowerCase();
                const existingPhone = (addrItem.getAttribute('data-recipientphone') || '').replace(/[\s\-\(\)]/g, '');
                const existingStreet = (addrItem.getAttribute('data-street') || '').trim().toLowerCase();
                const existingWard = (addrItem.getAttribute('data-ward') || '').trim().toLowerCase();
                const existingDistrict = (addrItem.getAttribute('data-district') || '').trim().toLowerCase();
                const existingProvince = (addrItem.getAttribute('data-province') || '').trim().toLowerCase();
                
                const existingAddress = [existingStreet, existingWard, existingDistrict, existingProvince]
                  .filter(s => s && s !== '')
                  .join(', ');
                
                // So sánh: tên, địa chỉ, số điện thoại
                // Chỉ so sánh nếu cả hai đều có giá trị
                const nameMatch = normalizedName && existingName && 
                                  normalizedName === existingName;
                const addressMatch = normalizedAddress === existingAddress;
                const phoneMatch = normalizedPhone && existingPhone && 
                                  normalizedPhone === existingPhone;
                
                // Đếm số lượng trùng khớp
                let matchCount = 0;
                if (nameMatch) matchCount++;
                if (addressMatch) matchCount++;
                if (phoneMatch) matchCount++;
                
                // Nếu trùng cả 3 thì không cho tạo
                // Nếu chỉ có 2 trường được điền và trùng cả 2 thì cũng không cho tạo
                const totalFields = (normalizedName ? 1 : 0) + 1 + (normalizedPhone ? 1 : 0); // name + address + phone
                if (matchCount === totalFields && totalFields >= 2) {
                  const errorEl = document.getElementById('upsertFormError');
                  if (errorEl) {
                    errorEl.textContent = '⚠️ Địa chỉ này đã tồn tại! Vui lòng kiểm tra lại tên, địa chỉ và số điện thoại.';
                    errorEl.style.display = 'block';
                    errorEl.style.visibility = 'visible';
                    errorEl.style.opacity = '1';
                    // Scroll đến thông báo lỗi
                    setTimeout(() => {
                      errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                    // Tự động ẩn sau 5 giây
                    setTimeout(() => {
                      errorEl.style.display = 'none';
                      errorEl.style.visibility = 'hidden';
                      errorEl.style.opacity = '0';
                    }, 3000);
                  }
                  // Re-enable button
                  const btnSave = document.getElementById('btnSaveAddress');
                  if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.textContent = 'Lưu';
                  }
                  return false;
                }
              }
            }
            
            // Disable button và hiển thị loading
            const btnSave = document.getElementById('btnSaveAddress');
            const originalText = btnSave.textContent;
            btnSave.disabled = true;
            btnSave.textContent = 'Đang lưu...';
            
            try {
              // Tạo FormData
              const formData = new FormData(form);
              
              // Gửi AJAX request
              const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
              });
              
              if (response.ok) {
                // Parse response (có thể là JSON hoặc redirect)
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                  result = await response.json();
          } else {
                  // Nếu là redirect hoặc HTML, thử parse response text
                  const text = await response.text();
                  // Kiểm tra xem có TempData success message không
                  if (text.includes('ToastSuccess') || response.url) {
                    result = { success: true };
                  } else {
                    throw new Error('Không thể xử lý phản hồi từ server');
                  }
                }
                
                // Reset lỗi trước khi đóng modal
                const phoneInput = document.getElementById('recipientPhone');
                const phoneError = document.getElementById('recipientPhoneError');
                if (phoneInput) {
                  phoneInput.classList.remove('input-error');
                }
                if (phoneError) {
                  phoneError.style.display = 'none';
                  phoneError.textContent = '';
                }
                
                // Đóng modal
                closeUpsertModal();
                
                // Cập nhật address card ngay lập tức
                const addressParts = [street, ward, district, province].filter(s => s && s.trim() !== '');
                const addressText = addressParts.join(', ');
                
                // Cập nhật hidden input
                const hidden = document.getElementById('AddressText');
                if (hidden) hidden.value = addressText;
                
                // Cập nhật UI
                const view = document.getElementById('currentAddressText');
                const isEmptyState = view && view.classList.contains('address-empty-state');
                
                if (isEmptyState) {
                  // Thay thế empty state
                  const addrBody = view.parentElement;
                  view.remove();
                  
                  // Tạo lại structure
                  const recipientInfo = document.getElementById('currentRecipientInfo');
                  if (recipientInfo) {
                    const name = recipientName || '@(Model.RecipientFullName ?? "")';
                    const phone = recipientPhone || '@(Model.RecipientPhone ?? "")';
                    recipientInfo.innerHTML = `<strong>${name}</strong> (${phone})`;
                    recipientInfo.style.display = 'block';
                  }
                  
                  const newAddressText = document.createElement('div');
                  newAddressText.id = 'currentAddressText';
                  newAddressText.textContent = addressText;
                  if (addrBody) {
                    addrBody.appendChild(newAddressText);
                  }
                } else {
                  // Chỉ cập nhật text
                  if (view) view.textContent = addressText;
                  
                  const recipientInfo = document.getElementById('currentRecipientInfo');
                  if (recipientInfo) {
                    const name = recipientName || '@(Model.RecipientFullName ?? "")';
                    const phone = recipientPhone || '@(Model.RecipientPhone ?? "")';
                    recipientInfo.innerHTML = `<strong>${name}</strong> (${phone})`;
                    recipientInfo.style.display = 'block';
                  }
                }
                
                // Cập nhật map nếu có tọa độ
                if (lat && lng && typeof L !== 'undefined') {
                  let mapContainer = document.getElementById('addressMap');
                  if (!mapContainer) {
                    const addrBody = document.querySelector('.addr-body');
                    if (addrBody) {
                      mapContainer = document.createElement('div');
                      mapContainer.id = 'addressMap';
                      mapContainer.style.cssText = 'width: 100%; height: 250px; margin-top: 1rem; border-radius: 8px; overflow: hidden;';
                      addrBody.appendChild(mapContainer);
                    }
                  }
                  if (mapContainer && typeof L !== 'undefined' && L.map) {
                    setTimeout(() => {
                      if (window.existingMap) {
                        window.existingMap.remove();
                      }
                      window.existingMap = L.map('addressMap').setView([parseFloat(lat), parseFloat(lng)], 15);
                      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                      }).addTo(window.existingMap);
                      const marker = L.marker([parseFloat(lat), parseFloat(lng)]).addTo(window.existingMap);
                      marker.bindPopup(addressText, {
                          autoPan: true,
                          autoPanPadding: [20, 20],
                          maxWidth: 250,
                          className: 'address-popup'
                      }).openPopup();
                    }, 100);
                  }
                }
                
                // Cập nhật nút
                const btn = document.querySelector('.address-card .addr-title .btn');
                if (btn) btn.textContent = 'Thay đổi';
                
                // Hiển thị thông báo thành công trong modal địa chỉ (nếu đang mở)
                if (document.getElementById('addressModal').classList.contains('open')) {
                  showAddressModalAlert('Địa chỉ đã được thêm thành công!', 'success');
                  // Reload danh sách địa chỉ trong modal
                  reloadAddressList();
                } else {
                  showToast('Địa chỉ đã được thêm thành công!', 'success');
                }
                
              } else {
                // Error handling
                const errorText = await response.text();
                const errorEl = document.getElementById('upsertFormError');
                if (errorEl) {
                  errorEl.textContent = '⚠️ Không thể lưu địa chỉ. Vui lòng thử lại.';
                  errorEl.style.display = 'block';
                  errorEl.style.visibility = 'visible';
                  errorEl.style.opacity = '1';
                  setTimeout(() => {
                    errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  }, 100);
                  setTimeout(() => {
                    errorEl.style.display = 'none';
                    errorEl.style.visibility = 'hidden';
                    errorEl.style.opacity = '0';
                  }, 3000);
                }
              }
              
            } catch (error) {
              console.error('Lỗi khi lưu địa chỉ:', error);
              const errorEl = document.getElementById('upsertFormError');
              if (errorEl) {
                errorEl.textContent = '⚠️ Có lỗi xảy ra khi lưu địa chỉ. Vui lòng thử lại.';
                errorEl.style.display = 'block';
                errorEl.style.visibility = 'visible';
                errorEl.style.opacity = '1';
                setTimeout(() => {
                  errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                setTimeout(() => {
                  errorEl.style.display = 'none';
                  errorEl.style.visibility = 'hidden';
                  errorEl.style.opacity = '0';
                }, 3000);
              }
            } finally {
              btnSave.disabled = false;
              btnSave.textContent = originalText;
            }
            
            return false;
          });
        })();
        
        // Auto-hide thông báo từ TempData đã được bỏ
        
        // Hàm hiển thị toast notification
        function showToast(message, type) {
          const toast = document.createElement('div');
          toast.className = `custom-alert alert-${type === 'success' ? 'success' : 'danger'}`;
          toast.setAttribute('role', 'alert');
          toast.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'}"></i>
            <div class="alert-content">${message}</div>
            <button type="button" class="alert-close" onclick="const el = this.parentElement; el.style.transition = 'none'; el.remove();" aria-label="Đóng thông báo">
              <i class="bi bi-x"></i>
            </button>
          `;
          document.body.appendChild(toast);
          
          // Auto remove sau 2.5 giây
          setTimeout(() => {
            if (toast.parentElement) {
              toast.style.transition = 'none'; // Bỏ transition để resize ngay lập tức
              toast.remove();
            }
          }, 2500);
        }
        </script>
    </div>
</div>


<!-- Modal Điều khoản dịch vụ -->
<div class="modal" id="tosModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Điều khoản dịch vụ</h3>
            <button class="btn" type="button" onclick="closeTosModal()">✕</button>
        </div>
        <div id="tosModalBody" style="margin-top:12px; max-height:65vh; overflow:auto">
            <!-- Nội dung nạp qua AJAX -->
        </div>
    </div>
</div>

<!-- Modal Voucher -->
<div class="modal" id="voucherModal">
    <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">🏷️ Voucher của bạn</h3>
            <button class="btn" type="button" onclick="closeVoucherModal()">✕</button>
        </div>
        <div id="voucherModalBody">
            <div id="voucherModalList" class="voucher-list"></div>
            <div class="tiny muted" style="margin-top: var(--s-4);">* Chỉ voucher còn hiệu lực và còn lượt dùng mới có thể áp dụng.</div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                  function cancelCheckout() {
            window.location.href = '/Customer/Cart/Index';
        }

                /* ========= Chọn phương thức thanh toán: chỉ đổi UI, KHÔNG auto submit ========= */
        (function bindPaymentPickUIOnly(){
          // Toggle .active khi đổi radio
          document.querySelectorAll('input.pm-radio[name="SelectedPaymentCode"]').forEach(r => {
            r.addEventListener('change', (e) => {
              document.querySelectorAll('.pm').forEach(l => l.classList.remove('active'));
              e.target.closest('.pm')?.classList.add('active');
            });
          });

          // Click vào label (radio ẩn) vẫn cập nhật .active
          document.querySelectorAll('.pm').forEach(lab => {
            lab.addEventListener('click', () => {
              setTimeout(() => {
                const checked = document.querySelector('input.pm-radio[name="SelectedPaymentCode"]:checked');
                document.querySelectorAll('.pm').forEach(l => l.classList.remove('active'));
                checked?.closest('.pm')?.classList.add('active');
              }, 0);
            });
          });

          // Khởi tạo trạng thái .active đúng theo model khi load
          document.addEventListener('DOMContentLoaded', () => {
            const checked = document.querySelector('input.pm-radio[name="SelectedPaymentCode"]:checked');
            if (checked) checked.closest('.pm')?.classList.add('active');
          });
        })();

        /* ========= Validate trước khi submit: phải có Payment + TOS + Địa chỉ ========= */
        // Đã được thay thế bằng validation mới ở dòng 2107 với thông báo inline
        // Phần này đã được loại bỏ để tránh duplicate validation và alert popup

        /* ========= Modal chọn địa chỉ ========= */
        function openAddressModal(){ 
          document.getElementById('addressModal').classList.add('open');
          // Ẩn thông báo khi mở modal
          const alert = document.getElementById('addressModalAlert');
          if (alert) {
            alert.style.display = 'none';
            alert.innerHTML = '';
          }
        }
        function closeAddressModal(){ 
          document.getElementById('addressModal').classList.remove('open');
          // Ẩn thông báo khi đóng modal
          const alert = document.getElementById('addressModalAlert');
          if (alert) {
            alert.style.display = 'none';
            alert.innerHTML = '';
          }
        }
        
        /* ========= Xóa địa chỉ bằng AJAX ========= */
        async function deleteAddress(addressId, button) {
          // Disable button
          button.disabled = true;
          const originalText = button.innerHTML;
          button.innerHTML = '⏳';
          
          // Lấy form và token
          const form = document.getElementById('del-' + addressId);
          if (!form) {
            showAddressModalAlert('⚠️ Không tìm thấy form xóa địa chỉ', 'danger');
            button.disabled = false;
            button.innerHTML = originalText;
              return;
            }
          
          const formData = new FormData(form);
          
          try {
            const response = await fetch(form.action, {
              method: 'POST',
              body: formData,
              credentials: 'same-origin'
            });
            
            if (response.ok) {
              // Hiển thị thông báo thành công trong modal
              showAddressModalAlert('Địa chỉ đã được xóa thành công!', 'success');
              
              // Xóa phần tử khỏi DOM
              const addrItem = button.closest('.addr-item');
              if (addrItem) {
                addrItem.style.transition = 'opacity 0.3s';
                addrItem.style.opacity = '0';
                setTimeout(() => {
                  addrItem.remove();
                  
                  // Kiểm tra xem còn địa chỉ nào không
                  const addrList = document.getElementById('addressListContainer');
                  const remainingItems = addrList.querySelectorAll('.addr-item');
                  if (remainingItems.length === 0) {
                    addrList.innerHTML = '<div style="padding:16px" class="muted">Bạn chưa có địa chỉ nào.</div>';
                  }
                }, 300);
              }
              
              // Kiểm tra xem địa chỉ đang được chọn có bị xóa không
              const currentAddressId = '@(Model.Address?.AddressId.ToString() ?? "")';
              if (currentAddressId === addressId) {
                // Reset address card về empty state
                setTimeout(() => {
                  resetAddressCard();
                }, 500);
              }
              
              // Reload danh sách địa chỉ trong modal
              reloadAddressList();
              
            } else {
              // Hiển thị thông báo lỗi trong modal
              const errorText = await response.text();
              showAddressModalAlert('Không thể xóa địa chỉ. Vui lòng thử lại.', 'danger');
              button.disabled = false;
              button.innerHTML = originalText;
            }
            
          } catch (error) {
            console.error('Lỗi khi xóa địa chỉ:', error);
            showAddressModalAlert('Có lỗi xảy ra khi xóa địa chỉ. Vui lòng thử lại.', 'danger');
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
        
        /* ========= Hiển thị thông báo trong modal địa chỉ ========= */
        function showAddressModalAlert(message, type) {
          const alertDiv = document.getElementById('addressModalAlert');
          if (!alertDiv) return;
          
          alertDiv.className = `custom-alert alert-${type === 'success' ? 'success' : 'danger'}`;
          alertDiv.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill'}"></i>
            <div class="alert-content">${message}</div>
            <button type="button" class="alert-close" onclick="const el = this.parentElement; el.style.transition = 'none'; el.style.display = 'none'; el.innerHTML = '';" aria-label="Đóng thông báo">
              <i class="bi bi-x"></i>
            </button>
          `;
          alertDiv.style.display = 'flex';
          
          // Auto hide sau 2.5 giây - ẩn ngay lập tức không có transition
          setTimeout(() => {
            if (alertDiv.style.display !== 'none') {
              alertDiv.style.transition = 'none'; // Bỏ transition để resize ngay lập tức
              alertDiv.style.display = 'none';
              alertDiv.innerHTML = '';
            }
          }, 2500);
        }
        
        /* ========= Reload danh sách địa chỉ trong modal ========= */
        async function reloadAddressList() {
          try {
            // Fetch lại trang để lấy danh sách địa chỉ mới
            const response = await fetch(window.location.href, {
              method: 'GET',
              credentials: 'same-origin'
            });
            
            if (response.ok) {
              const html = await response.text();
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              
              // Lấy danh sách địa chỉ mới từ response
              const newAddrList = doc.querySelector('.addr-list');
              const newForms = doc.querySelectorAll('form[id^="del-"]');
              
              if (newAddrList) {
                const container = document.getElementById('addressListContainer');
                if (container) {
                  container.innerHTML = newAddrList.innerHTML;
                }
              }
              
              // Cập nhật các form xóa
              const oldForms = document.querySelectorAll('form[id^="del-"]');
              oldForms.forEach(form => form.remove());
              
              newForms.forEach(form => {
                document.body.appendChild(form);
              });
            }
          } catch (error) {
            console.error('Lỗi khi reload danh sách địa chỉ:', error);
          }
        }
        
        /* ========= Reset address card về empty state ========= */
        function resetAddressCard() {
          const view = document.getElementById('currentAddressText');
          const recipientInfo = document.getElementById('currentRecipientInfo');
          const hidden = document.getElementById('AddressText');
          const mapContainer = document.getElementById('addressMap');
          
          // Reset hidden input
          if (hidden) hidden.value = '';
          
          // Thay thế nội dung bằng empty state
          if (view) {
            const addrBody = view.parentElement;
            view.remove();
            
            const emptyState = document.createElement('div');
            emptyState.id = 'currentAddressText';
            emptyState.className = 'address-empty-state';
            emptyState.innerHTML = `
              <div class="empty-state-icon">
                <i class="bi bi-geo-alt"></i>
              </div>
              <p class="empty-state-title">Bạn chưa chọn địa chỉ nhận hàng</p>
              <p class="empty-state-desc">Vui lòng chọn địa chỉ để tiếp tục đặt dịch vụ</p>
            `;
            if (addrBody) {
              addrBody.appendChild(emptyState);
            }
          }
          
          // Ẩn recipient info
          if (recipientInfo) {
            recipientInfo.style.display = 'none';
            recipientInfo.innerHTML = '';
          }
          
          // Xóa map
          if (mapContainer) {
            if (window.existingMap) {
              window.existingMap.remove();
              window.existingMap = null;
            }
            mapContainer.remove();
          }
          
          // Cập nhật nút
          const btn = document.querySelector('.address-card .addr-title .btn');
          if (btn) btn.textContent = 'Chọn địa chỉ';
        }

        /* ✅ Áp địa chỉ đang chọn trong modal vào hidden + UI */
        function applySelectedAddress(){
          const checked = document.querySelector('.addr-item input[type="radio"][name="addressChoice"]:checked');
          if(!checked){ closeAddressModal(); return; }
          const row = checked.closest('.addr-item');
          const parts = [row.dataset.street, row.dataset.ward, row.dataset.district, row.dataset.province]
                        .filter(s => s && s.trim() !== '');
          const text = parts.join(', ');
          
          // Cập nhật địa chỉ
          const hidden = document.getElementById('AddressText');
          const view = document.getElementById('currentAddressText');
          if(hidden) hidden.value = text;
          
          // Kiểm tra xem đang ở empty state hay không
          const isEmptyState = view && view.classList.contains('address-empty-state');
          
          if(view) {
            if(isEmptyState) {
              // Thay thế empty state bằng nội dung địa chỉ đơn giản
              const addrBody = view.parentElement; // .addr-body
              view.remove(); // Xóa empty state
              
              // Tạo lại structure đúng
              const recipientInfo = document.getElementById('currentRecipientInfo');
              if(recipientInfo) {
                recipientInfo.style.display = 'block';
              }
              
              // Tạo div address text mới
              const newAddressText = document.createElement('div');
              newAddressText.id = 'currentAddressText';
              newAddressText.textContent = text;
              if(addrBody) {
                addrBody.appendChild(newAddressText);
              }
            } else {
              // Chỉ cập nhật text nếu đã có structure
              view.textContent = text;
            }
          }
          
          // Cập nhật tên và số điện thoại người đặt
          const recipientInfo = document.getElementById('currentRecipientInfo');
          if(recipientInfo) {
            const recipientName = row.dataset.recipientname || '';
            const recipientPhone = row.dataset.recipientphone || '';
            
            // Lấy giá trị mặc định từ data attributes của modal hoặc từ Model (nếu có)
            const defaultName = '@(Model.RecipientFullName ?? "")';
            const defaultPhone = '@(Model.RecipientPhone ?? "")';
            
            // Nếu có thông tin từ địa chỉ, dùng nó; nếu không, dùng giá trị mặc định
            const name = recipientName || defaultName;
            const phone = recipientPhone || defaultPhone;
            recipientInfo.innerHTML = `<strong>${name}</strong> (${phone})`;
            recipientInfo.style.display = 'block';
          }
          
          // Cập nhật map nếu có tọa độ
          const lat = row.dataset.latitude || '';
          const lng = row.dataset.longitude || '';
          if(lat && lng) {
            // Kiểm tra map container
            let mapContainer = document.getElementById('addressMap');
            if(!mapContainer) {
              // Tạo map container nếu chưa có
              const addrBody = document.querySelector('.addr-body');
              if(addrBody) {
                mapContainer = document.createElement('div');
                mapContainer.id = 'addressMap';
                mapContainer.style.cssText = 'width: 100%; height: 250px; margin-top: 1rem; border-radius: 8px; overflow: hidden;';
                addrBody.appendChild(mapContainer);
              }
            }
            // Khởi tạo map với tọa độ mới
            if(mapContainer && typeof L !== 'undefined') {
              setTimeout(() => {
                if(typeof L !== 'undefined' && L.map) {
                  // Destroy old map if exists
                  if(window.existingMap) {
                    window.existingMap.remove();
                  }
                  // Create new map
                  window.existingMap = L.map('addressMap').setView([parseFloat(lat), parseFloat(lng)], 15);
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                  }).addTo(window.existingMap);
                  const marker = L.marker([parseFloat(lat), parseFloat(lng)]).addTo(window.existingMap);
                  marker.bindPopup(text, {
                      autoPan: true,
                      autoPanPadding: [20, 20],
                      maxWidth: 250,
                      className: 'address-popup'
                  }).openPopup();
                }
              }, 100);
            }
          }
          
          // Cập nhật nút "Thay đổi"
          const btn = document.querySelector('.address-card .addr-title .btn');
          if(btn) btn.textContent = 'Thay đổi';
          
          closeAddressModal();
        }

        /* ========= Modal Upsert Address ========= */
        let addressPickerMap, addressPickerMarker;
        
        function openCreateAddressForm(){
          document.getElementById('upsertTitle').innerText = 'Thêm địa chỉ';
          document.getElementById('AddressId').value = '';
          document.getElementById('streetAddress').value = '';
          document.getElementById('wardName').value = '';
          document.getElementById('provinceName').value = '';
          document.getElementById('districtName').value = '';
          document.getElementById('recipientName').value = '';
          document.getElementById('recipientPhone').value = '';
          document.getElementById('Latitude').value = '';
          document.getElementById('Longitude').value = '';
          
          // Reset thông báo lỗi
          const formError = document.getElementById('upsertFormError');
          if (formError) {
            formError.style.display = 'none';
            formError.style.visibility = 'hidden';
            formError.style.opacity = '0';
            formError.textContent = '';
          }
          
          // Reset lỗi số điện thoại
          const phoneInput = document.getElementById('recipientPhone');
          const phoneError = document.getElementById('recipientPhoneError');
          if (phoneInput) {
            phoneInput.classList.remove('input-error');
          }
          if (phoneError) {
            phoneError.style.display = 'none';
            phoneError.textContent = '';
          }
          
          // Khởi tạo bản đồ cho modal
          setTimeout(() => {
            initAddressPickerMap();
          }, 300);
          
          document.getElementById('addressUpsertModal').classList.add('open');
        }
        
        function initAddressPickerMap() {
          // Khởi tạo bản đồ Leaflet
          if (!addressPickerMap) {
            // Mặc định: Cần Thơ
            const defaultLat = 10.0452;
            const defaultLng = 105.7469;
            
            addressPickerMap = L.map('addressMapPicker').setView([defaultLat, defaultLng], 13);
            
            // Thêm OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors'
            }).addTo(addressPickerMap);
            
            // Thêm marker có thể di chuyển
            addressPickerMarker = L.marker([defaultLat, defaultLng], {
              draggable: true
            }).addTo(addressPickerMap);
            
            // Cập nhật tọa độ khi kéo marker
            addressPickerMarker.on('dragend', function(e) {
              const pos = addressPickerMarker.getLatLng();
              document.getElementById('Latitude').value = pos.lat;
              document.getElementById('Longitude').value = pos.lng;
            });
            
            // Nhấn vào bản đồ để thêm marker
            addressPickerMap.on('click', function(e) {
              const lat = e.latlng.lat;
              const lng = e.latlng.lng;
              
              document.getElementById('Latitude').value = lat;
              document.getElementById('Longitude').value = lng;
              
              // Di chuyển marker đến vị trí mới
              addressPickerMarker.setLatLng([lat, lng]);
            });
          }
          
          // Thiết lập tọa độ ban đầu
          const lat = document.getElementById('Latitude').value || 10.0452;
          const lng = document.getElementById('Longitude').value || 105.7469;
          addressPickerMap.setView([lat, lng], 13);
          addressPickerMarker.setLatLng([lat, lng]);
        }
        
        // Nút "Lấy địa chỉ từ vị trí đã chọn" - Reverse Geocoding
        // Sử dụng event delegation tốt hơn và immediate feedback
        const btnGeocode = document.getElementById('btnGeocode');
        if (btnGeocode) {
          btnGeocode.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Kiểm tra nếu đang loading thì không làm gì
            if (this.disabled || this.classList.contains('loading')) {
              return;
            }
            
            const lat = document.getElementById('Latitude')?.value;
            const lng = document.getElementById('Longitude')?.value;
            
            if (!lat || !lng) {
              const errorEl = document.getElementById('upsertFormError');
              if (errorEl) {
                errorEl.textContent = '⚠️ Vui lòng chọn vị trí trên bản đồ trước';
                errorEl.style.display = 'block';
                errorEl.style.visibility = 'visible';
                errorEl.style.opacity = '1';
                setTimeout(() => {
                  errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                setTimeout(() => {
                  errorEl.style.display = 'none';
                  errorEl.style.visibility = 'hidden';
                  errorEl.style.opacity = '0';
                }, 3000);
              }
              return;
            }
            
            // Immediate feedback - disable và loading state ngay lập tức
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.classList.add('loading');
            btn.style.pointerEvents = 'none';
            btn.innerHTML = '<span class="btn-icon">⏳</span><span>Đang tải...</span>';
            
            // Gọi API Nominatim để lấy địa chỉ từ tọa độ
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=vi`)
              .then(response => response.json())
              .then(data => {
                if (data && data.address) {
                  // Debug: In ra toàn bộ response để xem cấu trúc
                  console.log('=== Nominatim Full Response ===');
                  console.log(data);
                  console.log('=== Address Object ===');
                  console.log(data.address);
                  
                  // streetAddress - Đường/Phố
                  const street = data.address.road || 
                                 data.address.house_number || 
                                 data.address.pedestrian || '';
                  document.getElementById('streetAddress').value = street;
                  
                  // Parse cho Việt Nam: Kiểm tra từng field trong response
                  let ward = '', district = '', province = '';
                  
                  // Hàm helper để check và extract theo prefix
                  function extractByPrefix(value, wardPrefix, districtPrefix) {
                    if (!value) return '';
                    const v = value.trim();
                    if (v.startsWith('Phường ') || v.startsWith('Xã ')) {
                      return v.replace(/^(Phường|Xã)\s*/, '');
                    } else if (v.startsWith('Quận ') || v.startsWith('Huyện ')) {
                      return v.replace(/^(Quận|Huyện)\s*/, '');
                    }
                    return '';
                  }
                  
                  // Tìm Phường/Xã - search trong ALL fields
                  const allFields = [
                    data.address.suburb,
                    data.address.village,
                    data.address.city_district,
                    data.address.county,
                    data.address.quarter,
                    data.address.neighbourhood,
                    data.address.municipality
                  ];
                  
                  for (const fieldValue of allFields) {
                    if (fieldValue && (fieldValue.includes('Phường ') || fieldValue.includes('Xã '))) {
                      ward = fieldValue.replace(/^(Phường|Xã)\s*/, '');
                      break; // Tìm thấy rồi thì dừng
                    }
                  }
                  
                  // Tìm Quận/Huyện - search trong các field còn lại
                  const districtFields = [
                    data.address.city_district,
                    data.address.county,
                    data.address.municipality
                  ];
                  
                  for (const fieldValue of districtFields) {
                    if (fieldValue && (fieldValue.includes('Quận ') || fieldValue.includes('Huyện '))) {
                      district = fieldValue.replace(/^(Quận|Huyện)\s*/, '');
                      break;
                    }
                  }
                  
                  // Tìm Tỉnh/Thành
                  const potentialProvince = data.address.state || 
                                          data.address.city || 
                                          data.address.province || '';
                  
                  if (potentialProvince) {
                    province = potentialProvince.replace(/^(Tỉnh|Thành phố)\s*/, '');
                  }
                  
                  document.getElementById('wardName').value = ward;
                  document.getElementById('districtName').value = district;
                  document.getElementById('provinceName').value = province;
                  
                  console.log('Final mapped:', { street, ward, district, province });
                  
                  // Reset button state
                  btn.disabled = false;
                  btn.classList.remove('loading');
                  btn.style.pointerEvents = '';
                  btn.innerHTML = originalText;
                  
                  if (!ward && !district && !province) {
                    const errorEl = document.getElementById('upsertFormError');
                    if (errorEl) {
                      errorEl.textContent = '⚠️ Không thể tự động điền. Vui lòng nhập thủ công.';
                      errorEl.style.display = 'block';
                      errorEl.style.visibility = 'visible';
                      errorEl.style.opacity = '1';
                      setTimeout(() => {
                        errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      }, 100);
                      setTimeout(() => {
                        errorEl.style.display = 'none';
                        errorEl.style.visibility = 'hidden';
                        errorEl.style.opacity = '0';
                      }, 3000);
                    }
                  }
                } else {
                  const errorEl = document.getElementById('upsertFormError');
                  if (errorEl) {
                    errorEl.textContent = '⚠️ Không tìm thấy địa chỉ tại vị trí này. Vui lòng thử lại.';
                    errorEl.style.display = 'block';
                    errorEl.style.visibility = 'visible';
                    errorEl.style.opacity = '1';
                    setTimeout(() => {
                      errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                    setTimeout(() => {
                      errorEl.style.display = 'none';
                      errorEl.style.visibility = 'hidden';
                      errorEl.style.opacity = '0';
                    }, 3000);
                  }
                  // Reset button state
                  btn.disabled = false;
                  btn.classList.remove('loading');
                  btn.style.pointerEvents = '';
                  btn.innerHTML = originalText;
                }
              })
              .catch(error => {
                console.error('Geocoding error:', error);
                const errorEl = document.getElementById('upsertFormError');
                if (errorEl) {
                  errorEl.textContent = '⚠️ Không thể lấy địa chỉ từ vị trí đã chọn';
                  errorEl.style.display = 'block';
                  errorEl.style.visibility = 'visible';
                  errorEl.style.opacity = '1';
                  setTimeout(() => {
                    errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  }, 100);
                  setTimeout(() => {
                    errorEl.style.display = 'none';
                    errorEl.style.visibility = 'hidden';
                    errorEl.style.opacity = '0';
                  }, 3000);
                }
                // Reset button state
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.style.pointerEvents = '';
                btn.innerHTML = originalText;
              });
          });
        }
        function openEditAddressForm(btn){
          const row = btn.closest('.addr-item');
          console.log('=== openEditAddressForm called ===');
          console.log('Row dataset:', row.dataset);
          
          document.getElementById('upsertTitle').innerText = 'Sửa địa chỉ';
          document.getElementById('AddressId').value = row.dataset.id || '';
          document.getElementById('streetAddress').value = row.dataset.street || '';
          document.getElementById('wardName').value = row.dataset.ward || '';
          document.getElementById('districtName').value = row.dataset.district || '';
          document.getElementById('provinceName').value = row.dataset.province || '';
          
          // Set tên và số điện thoại
          const recipientName = row.dataset.recipientname || '';
          const recipientPhone = row.dataset.recipientphone || '';
          document.getElementById('recipientName').value = recipientName;
          document.getElementById('recipientPhone').value = recipientPhone;
          
          console.log('Set values - RecipientName:', recipientName, 'RecipientPhone:', recipientPhone);
          console.log('Form fields after setting:', {
            recipientName: document.getElementById('recipientName').value,
            recipientPhone: document.getElementById('recipientPhone').value
          });
          
          // Set tọa độ nếu có
          const lat = row.dataset.latitude || '';
          const lng = row.dataset.longitude || '';
          document.getElementById('Latitude').value = lat;
          document.getElementById('Longitude').value = lng;
          
          // Reset thông báo lỗi
          const formError = document.getElementById('upsertFormError');
          if (formError) {
            formError.style.display = 'none';
            formError.style.visibility = 'hidden';
            formError.style.opacity = '0';
            formError.textContent = '';
          }
          
          // Reset lỗi số điện thoại
          const phoneInput = document.getElementById('recipientPhone');
          const phoneError = document.getElementById('recipientPhoneError');
          if (phoneInput) {
            phoneInput.classList.remove('input-error');
          }
          if (phoneError) {
            phoneError.style.display = 'none';
            phoneError.textContent = '';
          }
          
          // Mở modal và khởi tạo bản đồ với tọa độ (nếu có)
          document.getElementById('addressUpsertModal').classList.add('open');
          
          // Khởi tạo bản đồ với tọa độ đã có
          setTimeout(() => {
            if (lat && lng) {
              initAddressPickerMap();
              // Set marker tại vị trí đã có
              if (addressPickerMap && addressPickerMarker) {
                addressPickerMap.setView([parseFloat(lat), parseFloat(lng)], 15);
                addressPickerMarker.setLatLng([parseFloat(lat), parseFloat(lng)]);
              }
            } else {
              initAddressPickerMap();
            }
          }, 300);
        }
            function closeUpsertModal(){ 
              const modal = document.getElementById('addressUpsertModal');
              if (modal) modal.classList.remove('open');
              
              // Reset lỗi số điện thoại
              const phoneInput = document.getElementById('recipientPhone');
              const phoneError = document.getElementById('recipientPhoneError');
              if (phoneInput) {
                phoneInput.classList.remove('input-error');
              }
              if (phoneError) {
                phoneError.style.display = 'none';
                phoneError.textContent = '';
              }
              
              // Reset lỗi form
              const formError = document.getElementById('upsertFormError');
              if (formError) {
                formError.style.display = 'none';
                formError.style.visibility = 'hidden';
                formError.style.opacity = '0';
                formError.textContent = '';
              }
            }

        /* ========= Lock submit button nhỏ ========= */
        function lockBtn(form){
          const btn = form.querySelector('button[type="submit"]');
          if(btn){ btn.disabled = true; btn.classList.add('is-loading'); }
          return true;
        }

        /* ========= Toggle panel GENERIC ========= */
        (function(){
          function closeAll(exceptId){
            document.querySelectorAll('.opt-panel').forEach(p=>{
              if(!exceptId || p.id !== exceptId){
                p.hidden = true;
                const b = document.querySelector('.opt-btn[aria-controls="'+p.id+'"]');
                if(b) b.setAttribute('aria-expanded','false');
              }
            });
          }
          document.addEventListener('click', function(e){
            const btn = e.target.closest('.opt-btn');
            const isVoucherBtn = btn && btn.id === 'btnOpenVoucher';

            if(btn && !isVoucherBtn){
              const id = btn.getAttribute('aria-controls');
              const el = document.getElementById(id);
              const expanded = btn.getAttribute('aria-expanded') === 'true';
              if(expanded){ el.hidden = true; btn.setAttribute('aria-expanded','false'); }
              else { closeAll(id); el.hidden = false; btn.setAttribute('aria-expanded','true'); }
              return;
            }

            const panel = e.target.closest('.opt-panel');
            if(!panel && !isVoucherBtn) closeAll();
          });
        })();

        /* ========= Voucher MODULE + TẠM TÍNH CLIENT ========= */
               (function(){
          const panel   = document.getElementById('opt_voucher');
          const btnOpen = document.getElementById('btnOpenVoucher');
          const btnClose= document.getElementById('btnCloseVoucher');
          // Sử dụng voucherModalList trong modal thay vì voucherList trong panel cũ
          const listEl  = document.getElementById('voucherModalList') || document.getElementById('voucherList');
          const voucherIdInput = document.getElementById('voucherId');
          const voucherHint = document.getElementById('voucherHint');

          let VOUCHERS = null;
          let CURRENT_VOUCHER = null;

          const VND = n => (new Intl.NumberFormat('vi-VN')).format(Math.max(0, Math.round(n))) + '₫';
          const pick = (o, ...keys) => { for (const k of keys) if (o && k in o && o[k] != null) return o[k]; };

          function normalizeVoucher(o){
            if(!o) return null;
            return {
              VoucherId: pick(o,'VoucherId','voucherId','Id','id') ?? null,
              Code: pick(o,'Code','code') ?? '',
              Description: pick(o,'Description','description') ?? '',
              DiscountPercent: Number(pick(o,'DiscountPercent','discountPercent') || 0),
              DiscountMaxAmount: Number(pick(o,'DiscountMaxAmount','discountMaxAmount') || 0),
              StartDate: pick(o,'StartDate','startDate') ?? null,
              EndDate: pick(o,'EndDate','endDate') ?? null,
              IsActive: !!pick(o,'IsActive','isActive'),
              UsageLimit: pick(o,'UsageLimit','usageLimit'),
              UsedCount: Number(pick(o,'UsedCount','usedCount') || 0),
              RemainingUses: pick(o,'RemainingUses','remainingUses'),
              IsUnlimited: !!pick(o,'IsUnlimited','isUnlimited'),
              IsExpired: !!pick(o,'IsExpired','isExpired'),
              IsUpcoming: !!pick(o,'IsUpcoming','isUpcoming'),
              CanUseNow: !!pick(o,'CanUseNow','canUseNow'),
            };
          }
          function inDateRange(v) {
            const now = new Date();
            const s = v.StartDate ? new Date(v.StartDate) : null;
            const e = v.EndDate ? new Date(v.EndDate) : null;
            const okStart = !s || now >= s;
            const okEnd   = !e || now <= e;
            return okStart && okEnd;
          }
          function canUse(v) {
            const active = !!v.IsActive;
            const unlimited = !!v.IsUnlimited;
            const remaining = Number(v.RemainingUses ?? ((v.UsageLimit ?? null) && isFinite(v.UsageLimit) ? (v.UsageLimit - (v.UsedCount||0)) : NaN));
            const usesOk = unlimited || (isFinite(remaining) ? remaining > 0 : true);
            const daterangeOk = inDateRange(v) && !v.IsExpired && !v.IsUpcoming;
            return (active && usesOk && daterangeOk) || v.CanUseNow;
          }

          function updateVoucherUI() {
            const id = (voucherIdInput.value || '').trim();
            if (id) {
              const code = CURRENT_VOUCHER?.Code || 'Voucher đã chọn';
              voucherHint.textContent = `Đã áp dụng: ${code}`;
              btnOpen.textContent = 'Đổi voucher';
            } else {
              voucherHint.textContent = 'Chọn voucher để áp dụng';
              btnOpen.textContent = 'Chọn voucher';
            }
            ensureBreakdown();
          }

          function ensureBreakdown(){
            const bd = document.getElementById('voucherBreakdown');
            const info = document.getElementById('voucherAppliedInfo');
            if(CURRENT_VOUCHER && voucherIdInput.value){
              const pct  = CURRENT_VOUCHER.DiscountPercent || 0;
              const maxA = CURRENT_VOUCHER.DiscountMaxAmount;
              const end  = CURRENT_VOUCHER.EndDate;
              const code = CURRENT_VOUCHER.Code;
              info.textContent =
                (code ? `Áp dụng mã ${code} • ` : '') +
                `Giảm ${pct}%` +
                (maxA ? ` (tối đa ${VND(Number(maxA))})` : '') +
                (end  ? ` • HSD: ${new Date(end).toLocaleDateString('vi-VN')}` : '');
              bd.hidden = false;
            } else {
              info.textContent = '';
              bd.hidden = true;
            }
          }

          async function fetchVouchers(){
            try{
              const res = await fetch('@Url.Action("GetCartVouchers", "BookingService", new { area = "Customer" })', { credentials: 'same-origin' });
              if(!res.ok) throw new Error('Không thể tải danh sách voucher');
              const data = await res.json();
              return Array.isArray(data) ? data : (data?.data ?? []);
            }catch(e){
              console.error(e);
              return [];
            }
          }

          async function openPanel(){
            // Mở modal thay vì panel
            const modal = document.getElementById('voucherModal');
            if (modal) {
              modal.classList.add('open');
              // Đảm bảo render vào modal list
              const modalListEl = document.getElementById('voucherModalList');
              if (modalListEl) {
                // Tạm thời override listEl để render vào modal
                const originalListEl = listEl;
                // Sử dụng modalListEl thay vì listEl
                if(VOUCHERS === null){
                  VOUCHERS = await fetchVouchers();
                }
                // Render trực tiếp vào modalListEl
                renderListToElement(VOUCHERS, modalListEl);
              } else {
                // Fallback: sử dụng listEl cũ
            if(VOUCHERS === null){
              VOUCHERS = await fetchVouchers();
              renderList(VOUCHERS);
            }
              }
            }
            btnOpen.setAttribute('aria-expanded','true');
          }
          
          // Hàm helper để render vào element cụ thể
          function renderListToElement(vouchers, targetEl){
            if (!targetEl) return;
            targetEl.innerHTML = '';
            const arr = (vouchers||[]).map(normalizeVoucher);
            if(arr.length === 0){
              targetEl.innerHTML = `<div class="muted">Bạn chưa có voucher nào phù hợp.</div>`;
              return;
            }
            arr.forEach(v => {
              const usable = canUse(v);
              const end = v.EndDate ? new Date(v.EndDate).toLocaleDateString('vi-VN') : null;
              const remain = v.RemainingUses ?? ((v.UsageLimit ?? null) && isFinite(v.UsageLimit) ? (v.UsageLimit - (v.UsedCount||0)) : null);

              const item = document.createElement('div');
              item.className = 'voucher-item';
              item.innerHTML = `
                <div class="left">
                  <div class="title">
                    ${v.Code || '(Không có mã)'}
                    <span class="badge ${usable?'ok':(v.IsExpired?'danger':'warn')}">
                      ${usable ? 'Dùng được' : (v.IsExpired ? 'Hết hạn' : 'Chưa đến hạn / đã hết lượt')}
                    </span>
                  </div>
                  <div class="desc">${v.Description || 'Không có mô tả'}</div>
                  <div class="meta">
                    Giảm ${v.DiscountPercent}%${v.DiscountMaxAmount?` • Tối đa ${VND(v.DiscountMaxAmount)}`:''}
                    ${end?` • HSD: ${end}`:''}
                    ${remain!=null?` • Còn lượt: ${remain}`:''}
                  </div>
                </div>
                <div class="right">
                  <button class="apply"${usable?'':' disabled'}>Áp dụng</button>
                </div>
              `;
              item.querySelector('.apply')?.addEventListener('click', () => applyVoucher(v));
              targetEl.appendChild(item);
            });
          }
          function closePanel(){
            // Đóng modal
            const modal = document.getElementById('voucherModal');
            if (modal) {
              modal.classList.remove('open');
            }
            btnOpen.setAttribute('aria-expanded','false');
          }
          
          // Hàm đóng modal voucher (gọi từ nút X) - đưa ra global scope
          window.closeVoucherModal = function(){
            closePanel();
          };

          function renderList(vouchers){
            listEl.innerHTML = '';
            const arr = (vouchers||[]).map(normalizeVoucher);
            if(arr.length === 0){
              listEl.innerHTML = `<div class="muted">Bạn chưa có voucher nào phù hợp.</div>`;
              return;
            }
            arr.forEach(v => {
              const usable = canUse(v);
              const end = v.EndDate ? new Date(v.EndDate).toLocaleDateString('vi-VN') : null;
              const remain = v.RemainingUses ?? ((v.UsageLimit ?? null) && isFinite(v.UsageLimit) ? (v.UsageLimit - (v.UsedCount||0)) : null);

              const item = document.createElement('div');
              item.className = 'voucher-item';
              item.innerHTML = `
                <div class="left">
                  <div class="title">
                    ${v.Code || '(Không có mã)'}
                    <span class="badge ${usable?'ok':(v.IsExpired?'danger':'warn')}">
                      ${usable ? 'Dùng được' : (v.IsExpired ? 'Hết hạn' : 'Chưa đến hạn/đã hết lượt')}
                    </span>
                  </div>
                  <div class="desc">${v.Description || 'Không có mô tả'}</div>
                  <div class="meta">
                    Giảm ${v.DiscountPercent}%${v.DiscountMaxAmount?` • Tối đa ${VND(v.DiscountMaxAmount)}`:''}
                    ${end?` • HSD: ${end}`:''}
                    ${remain!=null?` • Còn lượt: ${remain}`:''}
                  </div>
                </div>
                <div class="right">
                  <button class="apply"${usable?'':' disabled'}>Áp dụng</button>
                </div>
              `;
              item.querySelector('.apply')?.addEventListener('click', () => applyVoucher(v));
              listEl.appendChild(item);
            });
          }

          function getSummaryEls(){
            return {
              subtotalEl: document.querySelector('[data-subtotal]') || null,
              shippingEl: document.querySelector('[data-shipping]') || null,
              discountEl: document.querySelector('[data-discount]') || null,
              totalEl:    document.querySelector('[data-total]') || null
            };
          }
          function parseMoneyFromEl(el){
            if(!el) return 0;
            const raw = el.dataset?.raw;
            if(raw != null && raw !== '') return Number(raw)||0;
            const t = el.textContent || '';
            const m = t.replace(/[^\d\-]/g,'');
            return Number(m)||0;
          }
          function setMoney(el, amount, {prefix=''}={}){
            if(!el) return;
            const v = Math.max(0, Math.round(Number(amount||0)));
            el.dataset.raw = String(v);
            el.textContent = prefix + VND(v);
          }
          function computeDiscountLocal({subtotal, shipping}, voucher){
            if(!voucher || !canUse(voucher)) return 0;
            const base = subtotal + (parseMoneyFromEl(document.querySelector('[data-shipping]'))||0);
            const pct  = Number(voucher.DiscountPercent || 0) / 100;
            let discount = Math.round(base * pct);
            if (voucher.DiscountMaxAmount != null && isFinite(voucher.DiscountMaxAmount)) {
              discount = Math.min(discount, Number(voucher.DiscountMaxAmount));
            }
            return Math.max(0, discount);
          }
          function refreshTotalsLocal(){
            if (!CURRENT_VOUCHER) return;
            const {subtotalEl, shippingEl, discountEl, totalEl} = getSummaryEls();
            if(!subtotalEl || !discountEl || !totalEl) return;

            const subtotal = parseMoneyFromEl(subtotalEl);
            const shipping = parseMoneyFromEl(shippingEl);
            const discount = computeDiscountLocal({subtotal, shipping}, CURRENT_VOUCHER);
            const total    = Math.max(0, subtotal + shipping - discount);

            setMoney(discountEl, discount, {prefix:'-'});
            setMoney(totalEl, total);

            ensureBreakdown();
          }

          function applyVoucher(v){
            CURRENT_VOUCHER = normalizeVoucher(v);
            voucherIdInput.value = CURRENT_VOUCHER?.VoucherId || '';
            updateVoucherUI();
            closePanel();
            refreshTotalsLocal();
          }
          function removeVoucher(){
            CURRENT_VOUCHER = null;
            voucherIdInput.value = '';
            updateVoucherUI();
            refreshTotalsLocal();
          }
          window.removeVoucher = removeVoucher;

          btnOpen?.addEventListener('click', (e) => { e.stopPropagation(); openPanel(); });
          btnClose?.addEventListener('click', closePanel);
          panel?.addEventListener('click', (e)=>{ if(e.target === panel) closePanel(); });

          // Khởi tạo từ server (nếu đã có VoucherId trong model)
          (async function initFromServer(){
            const firstId = (voucherIdInput?.value || '').trim();
            const percent   = Number('@Model.VoucherPercent'.toString().replace(',', '.'));
            const maxAmount = Number('@Model.VoucherMaxAmount'.toString().replace(',', '.'));
            
            if(firstId){
              // ✅ Fetch đầy đủ thông tin voucher từ server để có Code
              try {
                const vouchers = await fetchVouchers();
                const found = vouchers.find(v => {
                  const vid = pick(v, 'VoucherId', 'voucherId', 'Id', 'id');
                  return vid && vid.toString().toLowerCase() === firstId.toLowerCase();
                });
                
                if (found) {
                  CURRENT_VOUCHER = normalizeVoucher(found);
                } else {
                  // Fallback nếu không tìm thấy trong danh sách
                  CURRENT_VOUCHER = { 
                    VoucherId: firstId, 
                    DiscountPercent: percent||0, 
                    DiscountMaxAmount: maxAmount||0,
                    Code: '' // để updateVoucherUI không bị lỗi
                  };
                }
              } catch (e) {
                console.error('Không thể tải chi tiết voucher:', e);
                // Fallback
                CURRENT_VOUCHER = { 
                  VoucherId: firstId, 
                  DiscountPercent: percent||0, 
                  DiscountMaxAmount: maxAmount||0,
                  Code: ''
                };
              }
            }

            updateVoucherUI();
            if (CURRENT_VOUCHER) refreshTotalsLocal();
          })();

        })();

        /* ========= TOS ========= */
        async function openTosModal(providerId){
          const body = document.getElementById('tosModalBody');
          body.innerHTML = '<div class="muted">Đang tải điều khoản...</div>';
          try{
            const url = '@Url.Action("GetTermsByProvider", "BookingService", new { area = "Customer" })' + '?providerId=' + providerId;
            const res = await fetch(url, { method: 'GET', headers: { 'X-Requested-With':'XMLHttpRequest' } });
            if(res.ok){
              const html = await res.text();
              body.innerHTML = html;
            } else {
              body.innerHTML = '<div style="color:#c00">Không tải được điều khoản từ máy chủ.</div>';
            }
          }catch(err){
            body.innerHTML = '<div style="color:#c00">Không tải được điều khoản. Vui lòng thử lại.</div>';
          }
          document.getElementById('tosModal').classList.add('open');
        }
        function closeTosModal(){
          document.getElementById('tosModal').classList.remove('open');
          document.getElementById('tosModalBody').innerHTML = '';
        }
        function syncTosHidden(chk){
          const providerId = chk.getAttribute('data-provider-id');
          const hidden = document.querySelector(`input[type="hidden"][name="TosAccepted[${providerId}]"]`);
          if(hidden) hidden.value = chk.checked ? 'true' : 'false';
          updatePlaceOrderButtonState();
        }
        function updatePlaceOrderButtonState(){
          // Bỏ disabled state - không làm mờ nút nữa
          // Validation sẽ được thực hiện khi submit
        }
        document.addEventListener('DOMContentLoaded', updatePlaceOrderButtonState);

        /* ========= Validate Booking Time với Provider Schedule ========= */
        const API_BASE_URL = 'http://localhost:5154/api';
        const bookingTimeValidations = new Map(); // Track validation state for each input

        async function validateBookingTime(input, index) {
            const providerId = input.dataset.providerId;
            const dateTimeValue = input.value;
            
            if (!dateTimeValue || !providerId) {
                hideBookingTimeError(index);
                return true;
            }

            // Parse datetime-local value
            // datetime-local format: "yyyy-MM-ddTHH:mm" (24-hour format, no timezone)
            // Example: "2025-11-06T12:30" means 12:30 PM (noon)
            // Example: "2025-11-06T00:30" means 12:30 AM (midnight + 30 min)
            
            // Parse directly from string format "yyyy-MM-ddTHH:mm" to avoid timezone issues
            let date, time;
            if (dateTimeValue.includes('T')) {
                const [datePart, timePart] = dateTimeValue.split('T');
                date = datePart; // Already in yyyy-MM-dd format
                time = timePart; // Already in HH:mm format (24-hour)
            } else {
                // Fallback: parse using Date object
                const dateTime = new Date(dateTimeValue);
                const year = dateTime.getFullYear();
                const month = String(dateTime.getMonth() + 1).padStart(2, '0');
                const day = String(dateTime.getDate()).padStart(2, '0');
                date = `${year}-${month}-${day}`;
                
                const hours = String(dateTime.getHours()).padStart(2, '0');
                const minutes = String(dateTime.getMinutes()).padStart(2, '0');
                time = `${hours}:${minutes}`;
            }
            
            console.log('Validating booking time:', { 
                dateTimeValue, 
                date, 
                time, 
                providerId,
                parsedHours: time.split(':')[0],
                parsedMinutes: time.split(':')[1]
            });

            const errorDiv = document.getElementById(`booking-time-error-${index}`);
            if (!errorDiv) return true;

            // Show loading state
            errorDiv.style.display = 'block';
            errorDiv.textContent = '⏳ Đang kiểm tra tính khả dụng...';
            errorDiv.style.borderLeftColor = '#0ea5e9';
            errorDiv.style.background = 'linear-gradient(135deg, color-mix(in oklab, #0ea5e9 12%, transparent), color-mix(in oklab, #0ea5e9 8%, transparent))';
            errorDiv.style.color = '#0284c7';

            try {
                const url = `${API_BASE_URL}/ProviderAvailability/${providerId}?date=${date}&time=${time}`;
                console.log('Calling API:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    // HTTP error (4xx, 5xx)
                    let errorMessage = `Lỗi kết nối (${response.status})`;
                    try {
                        const errorData = await response.json();
                        if (errorData.Message || errorData.message) {
                            errorMessage = errorData.Message || errorData.message;
                        } else if (errorData.Detail || errorData.detail) {
                            errorMessage = errorData.Detail || errorData.detail;
                        }
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage = errorText;
                        }
                    }
                    console.error('API Error:', response.status, errorMessage);
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = `❌ ${errorMessage}`;
                    // Reset loading styles and apply error styles
                    errorDiv.style.borderLeftColor = '';
                    errorDiv.style.background = '';
                    errorDiv.style.color = '';
                    input.classList.add('booking-input-error');
                    bookingTimeValidations.set(index, false);
                    return false;
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                console.log('API Response keys:', Object.keys(result));
                console.log('result.Success:', result.Success);
                console.log('result.success:', result.success);
                console.log('result.Data:', result.Data);
                console.log('result.data:', result.data);

                // Handle both Success and success (case-insensitive)
                const isSuccess = result.Success === true || result.success === true;
                const data = result.Data || result.data;
                
                if (isSuccess && data) {
                    const availability = data;
                    console.log('Availability data:', availability);
                    console.log('Availability keys:', Object.keys(availability));
                    console.log('IsAvailable:', availability.IsAvailable, 'isAvailable:', availability.isAvailable);
                    console.log('UnavailableReason:', availability.UnavailableReason, 'unavailableReason:', availability.unavailableReason);
                    
                    // Handle both PascalCase and camelCase property names
                    const isAvailable = availability.IsAvailable !== undefined ? availability.IsAvailable : availability.isAvailable;
                    const unavailableReason = availability.UnavailableReason || availability.unavailableReason;
                    
                    console.log('Final isAvailable:', isAvailable, 'unavailableReason:', unavailableReason);
                    
                    if (isAvailable === true) {
                        hideBookingTimeError(index);
                        bookingTimeValidations.set(index, true);
                        return true;
                    } else {
                        // Show error with reason
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = unavailableReason || 'Không thể đặt dịch vụ vào thời gian này';
                        input.classList.add('booking-input-error');
                        bookingTimeValidations.set(index, false);
                        return false;
                    }
                } else {
                    // API returned but Success = false or no Data
                    console.warn('API returned false or no data:', result);
                    console.warn('isSuccess:', isSuccess, 'data:', data);
                    errorDiv.style.display = 'block';
                    const errorMsg = result.Message || result.message || result.Detail || result.detail || 'Không thể kiểm tra tính khả dụng';
                    errorDiv.textContent = errorMsg;
                    input.classList.add('booking-input-error');
                    bookingTimeValidations.set(index, false);
                    return false;
                }
            } catch (error) {
                console.error('Error checking availability:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Lỗi khi kiểm tra tính khả dụng: ${error.message || 'Vui lòng thử lại'}`;
                input.classList.add('booking-input-error');
                bookingTimeValidations.set(index, false);
                return false;
            }
        }

        function hideBookingTimeError(index) {
            const errorDiv = document.getElementById(`booking-time-error-${index}`);
            const input = document.getElementById(`booking-time-${index}`);
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            if (input) {
                input.classList.remove('booking-input-error');
            }
            bookingTimeValidations.set(index, true);
        }

        // Validate all booking times before submit
        async function validateAllBookingTimes() {
            const inputs = document.querySelectorAll('input[type="datetime-local"].booking-input');
            const promises = [];
            
            for (let i = 0; i < inputs.length; i++) {
                const input = inputs[i];
                const index = parseInt(input.id.replace('booking-time-', ''));
                if (!isNaN(index) && input.value) {
                    promises.push(validateBookingTime(input, index));
                }
            }
            
            const results = await Promise.all(promises);
            return results.every(r => r === true);
        }

        // Override form submit to validate booking times
        document.addEventListener('DOMContentLoaded', function() {
            const placeOrderForm = document.getElementById('@placeOrderFormId');
            if (placeOrderForm) {
                placeOrderForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Hàm hiển thị thông báo lỗi
                    function showValidationError(elementId, message) {
                        const errorEl = document.getElementById(elementId);
                        if (errorEl) {
                            errorEl.textContent = '⚠️ ' + message;
                            errorEl.style.display = 'block';
                            // Tự động ẩn sau 5 giây
                            setTimeout(() => {
                                errorEl.style.display = 'none';
                            }, 3000);
                        }
                    }
                    
                    // Hàm ẩn tất cả thông báo lỗi
                    function hideAllValidationErrors() {
                        document.querySelectorAll('.validation-error').forEach(el => {
                            el.style.display = 'none';
                        });
                    }
                    
                    // Hàm highlight section
                    function highlightSection(section, duration = 3000) {
                        if (section) {
                            section.style.border = '2px solid #ef4444';
                            section.style.boxShadow = '0 0 0 4px color-mix(in oklab, #ef4444 20%, transparent)';
                            setTimeout(() => {
                                section.style.border = '';
                                section.style.boxShadow = '';
                            }, duration);
                        }
                    }
                    
                    // Ẩn tất cả lỗi cũ trước khi validate
                    hideAllValidationErrors();
                    
                    // Mảng lưu tất cả các lỗi
                    const errors = [];
                    let firstErrorElement = null;
                    
                    // 1. Kiểm tra địa chỉ
                    const addressCard = document.getElementById('addressCardSection');
                    const currentAddressText = document.getElementById('currentAddressText');
                    const addressText = document.getElementById('AddressText')?.value?.trim() || '';
                    const hasAddressDisplay = currentAddressText && !currentAddressText.classList.contains('address-empty-state');
                    const hasAddressValue = addressText && addressText.length > 5 && addressText !== '0' && addressText !== '...';
                    
                    if (!hasAddressDisplay || !hasAddressValue) {
                        errors.push({
                            type: 'address',
                            element: addressCard,
                            errorId: 'addressError',
                            message: 'Vui lòng chọn địa chỉ đặt dịch vụ để tiếp tục.'
                        });
                        if (!firstErrorElement) firstErrorElement = addressCard;
                    }
                    
                    // 2. Kiểm tra phương thức thanh toán
                    const selectedPayment = document.querySelector('input.pm-radio[name="SelectedPaymentCode"]:checked');
                    if (!selectedPayment) {
                        errors.push({
                            type: 'payment',
                            element: document.getElementById('paymentSection'),
                            errorId: 'paymentError',
                            message: 'Vui lòng chọn phương thức thanh toán.'
                        });
                        if (!firstErrorElement) firstErrorElement = document.getElementById('paymentSection');
                    }
                    
                    // 3. Kiểm tra điều khoản dịch vụ
                    const allTosChecks = Array.from(document.querySelectorAll('.tos-check'));
                    const uncheckedTos = allTosChecks.filter(x => !x.checked);
                    if (uncheckedTos.length > 0) {
                        uncheckedTos.forEach(unchecked => {
                            const providerId = unchecked.getAttribute('data-provider-id');
                            errors.push({
                                type: 'tos',
                                element: unchecked.closest('.shop-block'),
                                errorId: `tos-error-${providerId}`,
                                message: 'Vui lòng đồng ý điều khoản dịch vụ của nhà cung cấp này.',
                                providerId: providerId
                            });
                            if (!firstErrorElement) firstErrorElement = unchecked.closest('.shop-block');
                        });
                    }
                    
                    // 4. Kiểm tra thời gian đặt dịch vụ
                    const inputs = document.querySelectorAll('input[type="datetime-local"].booking-input');
                    const validationPromises = [];
                    const inputIndexMap = new Map(); // Map để track index của input trong results
                    
                    for (let i = 0; i < inputs.length; i++) {
                        const input = inputs[i];
                        const index = parseInt(input.id.replace('booking-time-', ''));
                        
                        // Kiểm tra nếu chưa chọn thời gian
                        if (!input.value) {
                            errors.push({
                                type: 'bookingTime',
                                element: input.closest('.booking-time') || input,
                                errorId: `booking-time-error-${index}`,
                                message: 'Vui lòng chọn thời gian thực hiện dịch vụ.'
                            });
                            if (!firstErrorElement) firstErrorElement = input.closest('.booking-time') || input;
                        } else if (!isNaN(index)) {
                            // Validate thời gian đã chọn
                            const promiseIndex = validationPromises.length;
                            inputIndexMap.set(promiseIndex, { input, index });
                            validationPromises.push(validateBookingTime(input, index));
                        }
                    }
                    
                    // Chờ tất cả validation hoàn thành
                    const results = await Promise.all(validationPromises);
                    
                    // Kiểm tra kết quả validation
                    results.forEach((result, promiseIndex) => {
                        if (result !== true) {
                            const { input, index } = inputIndexMap.get(promiseIndex);
                            const errorDiv = document.getElementById(`booking-time-error-${index}`);
                            // Kiểm tra xem error đã được hiển thị chưa (từ validateBookingTime)
                            if (errorDiv && errorDiv.style.display !== 'none') {
                                errors.push({
                                    type: 'bookingTime',
                                    element: input.closest('.booking-time') || input,
                                    errorId: `booking-time-error-${index}`,
                                    message: errorDiv.textContent || 'Thời gian đặt dịch vụ không hợp lệ.'
                                });
                                if (!firstErrorElement) firstErrorElement = input.closest('.booking-time') || input;
                            }
                        }
                    });
                    
                    // Hiển thị tất cả các lỗi cùng lúc
                    if (errors.length > 0) {
                        errors.forEach(error => {
                            if (error.type === 'tos') {
                                // TOS error sử dụng class selector
                                const tosError = document.querySelector(`.tos-error[data-provider-id="${error.providerId}"]`);
                                if (tosError) {
                                    tosError.textContent = '⚠️ ' + error.message;
                                    tosError.style.display = 'block';
                                    setTimeout(() => {
                                        tosError.style.display = 'none';
                                    }, 3000);
                                }
                            } else if (error.type === 'bookingTime') {
                                // Booking time error - hiển thị trong error div
                                const errorDiv = document.getElementById(error.errorId);
                                if (errorDiv) {
                                    errorDiv.textContent = '⚠️ ' + error.message;
                                    errorDiv.style.display = 'block';
                                    setTimeout(() => {
                                        errorDiv.style.display = 'none';
                                    }, 3000);
                                }
                            } else {
                                // Các lỗi khác sử dụng ID
                                showValidationError(error.errorId, error.message);
                            }
                            
                            // Highlight section
                            if (error.element) {
                                highlightSection(error.element);
                            }
                        });
                        
                        // Scroll đến lỗi đầu tiên
                        if (firstErrorElement) {
                            firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Focus vào input nếu có
                            const input = firstErrorElement.querySelector('input, select, textarea');
                            if (input) {
                                setTimeout(() => input.focus(), 300);
                            }
                        }
                        
                        return false;
                    }
                    
                    // Tất cả validation đều pass - submit form
                    placeOrderForm.submit();
                });
            }
        });
    </script>
}

@model VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO
@{
    ViewData["Title"] = "Chi tiết đơn dịch vụ";

    // Chỉ 4 trạng thái chính + Cancelled (để hiện banner), KHÔNG có "All"
    var statusViMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["Pending"] = "Chờ xác nhận",
        ["Confirmed"] = "Xác Nhận",
        ["InProgress"] = "Bắt Đầu Làm Việc",
        ["Completed"] = "Hoàn thành",
        ["Cancelled"] = "Đã hủy"
    };

    // Ưu tiên NormalizedStatus; nếu trống mặc định "Pending"
    var statusCode = string.IsNullOrWhiteSpace(Model?.NormalizedStatus) ? "Pending" : Model.NormalizedStatus;
    var statusVi = statusViMap.TryGetValue(statusCode, out var vi) ? vi : statusCode;

    var rawStatus = (Model?.Status ?? "").Trim();

    // DB có thể lưu "ServiceCompleted" hoặc "Service Completed"
    var IsServiceCompleted =
        rawStatus.Equals("ServiceCompleted", StringComparison.OrdinalIgnoreCase)
     || rawStatus.Equals("Service Completed", StringComparison.OrdinalIgnoreCase);

    // Sử dụng IsPendingStatus property để check cả tiếng Anh và tiếng Việt
    var IsPending = Model?.IsPendingStatus ?? statusCode.Equals("Pending", StringComparison.OrdinalIgnoreCase);
    var IsConfirmed = statusCode.Equals("Confirmed", StringComparison.OrdinalIgnoreCase);
    var IsWorking = statusCode.Equals("InProgress", StringComparison.OrdinalIgnoreCase);
    var IsCompleted = statusCode.Equals("Completed", StringComparison.OrdinalIgnoreCase)
                  || IsServiceCompleted; // <-- thêm điều kiện này
    var IsCancelled = statusCode.Equals("Cancelled", StringComparison.OrdinalIgnoreCase);

    var IsReviewed = Model?.HasReview == true;

    // ✅ Chỉ đơn Hoàn thành thật sự (không phải ServiceCompleted) mới được phép đánh giá
    var canReview = IsCompleted && !IsServiceCompleted;

    // Steps chỉ áp dụng cho 4 trạng thái chính
    var IsFourStates = IsPending || IsConfirmed || IsWorking || IsCompleted;

    Func<decimal, string> currency = v => v.ToString("N0") + "đ";
    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    // Helper để lấy ảnh đầu tiên từ ServiceImages (có thể là JSON array hoặc comma-separated string)
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            // Thử parse JSON array trước
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        // Nếu không phải JSON, thử split bằng dấu phẩy
        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        
        // Nếu không có dấu phẩy, trả về nguyên chuỗi
        return images;
    }

    // Helper để lấy ảnh service (backend đã thêm domain prefix)
    string GetServiceImage(string? serviceImages)
    {
        if (string.IsNullOrWhiteSpace(serviceImages))
            return fallbackImg;
        
        var img = FirstImageOrDefault(serviceImages);
        return !string.IsNullOrWhiteSpace(img) ? img : fallbackImg;
    }

    // Helper để lấy logo provider (backend đã thêm domain prefix, giống ServiceShop/Index.cshtml)
    string GetProviderLogo(string? providerImages)
    {
        if (!string.IsNullOrWhiteSpace(providerImages))
        {
            var logo = FirstImageOrDefault(providerImages);
            if (!string.IsNullOrWhiteSpace(logo)) return logo;
        }
        
        // Fallback về shop-badge.svg nếu không có providerImages
        return "/images/shop-badge.svg";
    }

    string StatusHeadline(string code) => (code ?? "").Trim() switch
    {
        // ✅ Nếu rawStatus là ServiceCompleted → câu riêng
        _ when rawStatus.Equals("ServiceCompleted", StringComparison.OrdinalIgnoreCase)
            => "Đang chờ bạn xác nhận hoàn thành",

        "Pending" => "Đang chờ xác nhận",
        "Confirmed" => "Đã xác nhận",
        "InProgress" => "Đang thực hiện",
        "Completed" => "Đã hoàn thành",
        "Cancelled" => "Đơn đã hủy",
        _ => "—"
    };

    var grandTotal = Model?.Total ?? 0m;
    var paid = Model?.PaidAmount ?? 0m;
    var due = Math.Max(0, grandTotal - paid);

    Func<string, DateTimeOffset?> timeOf = code => Model?.Timeline?
        .Where(e => string.Equals(e.Code, code, StringComparison.OrdinalIgnoreCase))
        .OrderByDescending(e => e.Time)
        .Select(e => (DateTimeOffset?)e.Time)
        .FirstOrDefault();

    Func<DateTimeOffset?, string> fmt = t => t.HasValue ? t.Value.ToString("HH:mm dd-MM") : "—";

    // Thứ tự cho 4 trạng thái
    var order = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
    {
        ["Pending"] = 0,
        ["Confirmed"] = 1,
        ["InProgress"] = 2,
        ["Completed"] = 3
    };
    var currentIndex = order.TryGetValue(statusCode, out var idx) ? idx : -1;

    // ✅ Nếu là ServiceCompleted thì ép currentIndex về bước Completed
    if (IsServiceCompleted)
    {
        currentIndex = order["Completed"];
    }

    Func<string, string> StepClass = key =>
    {
        if (!order.TryGetValue(key, out var k)) return "";
        if (currentIndex < 0) return "";   // ví dụ Cancelled thì không active/done step
        if (k < currentIndex) return "done";
        if (k == currentIndex) return "active";
        return "";
    };

    DateTimeOffset? bookingTime = timeOf("Check Out");

    bookingTime ??= timeOf("InProgress");
    
    // Xác định trạng thái thanh toán dựa trên PaymentStatus hoặc PaidAmount (dùng cho steps)
    var paymentStatus = Model?.PaymentStatus;
    var stepPaymentStatusText = "Chưa thanh toán";
    
    if (!string.IsNullOrWhiteSpace(paymentStatus))
    {
        var statusUpper = paymentStatus.Trim().ToUpperInvariant();
        if (statusUpper == "ĐÃ THANH TOÁN" || 
            statusUpper == "PAID" || 
            statusUpper == "SUCCESS" || 
            statusUpper == "COMPLETED")
        {
            stepPaymentStatusText = $"Đã thanh toán: {currency(grandTotal)}";
        }
        else if (statusUpper == "REFUNDED")
        {
            stepPaymentStatusText = "Đã hoàn tiền";
        }
        else if (statusUpper == "PENDING")
        {
            stepPaymentStatusText = "Chờ thanh toán";
        }
    }
    else if (paid > 0 && due == 0)
    {
        stepPaymentStatusText = $"Đã thanh toán: {currency(grandTotal)}";
    }
    else if (paid > 0 && due > 0)
    {
        stepPaymentStatusText = $"Đã thanh toán: {currency(paid)} (còn lại {currency(due)})";
    }
    else
    {
        stepPaymentStatusText = $"Chưa thanh toán: {currency(grandTotal)}";
    }
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/history-booking-detail.css" asp-append-version="true" />

<div class="container my-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap header-compact">
        <div>
        <h2 class="page-detail-title mb-0">Chi tiết đơn hàng</h2>
            <div class="fw-semibold mb-2">MÃ ĐƠN HÀNG: @(string.IsNullOrWhiteSpace(Model?.BookingCode) ? "—" : Model.BookingCode)</div>
            
            <!-- Breadcrumb Navigation -->
            <nav aria-label="breadcrumb" class="mt-2">
                <ol class="breadcrumb mb-0" style="background: transparent; padding: 0;">
                    <li class="breadcrumb-item">
                        <a asp-area="Customer" asp-controller="BookingService" asp-action="ListHistoryBooking" style="color: var(--accent); text-decoration: none;">Lịch sử đặt hàng</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page" style="color: var(--muted-foreground);">Chi tiết đơn hàng</li>
                </ol>
            </nav>
            
            @if (IsCancelled)
            {
                <div class="small text-muted mt-2">Đơn đã bị hủy. Vui lòng xem lý do hủy ở bên dưới nếu có.</div>
            }
        </div>

        <!-- Nút hành động -->
        <div class="d-flex gap-2">
            @if (IsCompleted)
            {
                var hasReport = ViewBag.HasReport == true;
                var reportId = ViewBag.ReportId as Guid?;
                var isServiceCompleted = IsServiceCompleted; // dùng flag phía trên

                @* ✅ Nếu là ServiceCompleted: hiện nút "Xác nhận hoàn thành" *@
                @if (isServiceCompleted)
                {
                    <form asp-area="Customer"
                          asp-controller="BookingService"
                          asp-action="ConfirmServiceCompleted"
                          method="post"
                          class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="BookingId" value="@Model.BookingId" />
                        <button type="submit" class="btn btn-success">
                            Xác nhận hoàn thành
                        </button>
                    </form>
                }

                <form asp-area="Customer" asp-controller="BookingService" asp-action="ReorderBooking" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                    <input type="hidden" name="serviceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />
                    @if (Model?.Options?.Any() == true)
                    {
                        @foreach (var opt in Model.Options)
                        {
                            <input type="hidden" name="optionIds" value="@opt.OptionId" />
                        }
                    }
                    <button type="submit" class="btn btn-danger">Đặt lại</button>
                </form>
                
                if (hasReport && reportId.HasValue)
                {
                    <a asp-area="Customer" asp-controller="BookingService" asp-action="ReportDetail" asp-route-reportId="@reportId.Value" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-text"></i> Xem chi tiết báo cáo
                    </a>
                }
                else
                {
                    <a asp-area="Customer" asp-controller="BookingService" asp-action="ReportService" asp-route-bookingId="@Model.BookingId" class="btn btn-outline-secondary">
                        <i class="bi bi-exclamation-triangle"></i> Báo cáo
                    </a>
                }

                if (canReview)
                {
                    if (!IsReviewed)
                    {
                        <button class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#reviewModal-@Model.BookingId">
                            Đánh giá
                        </button>
                    }
                    else
                    {
                        <span class="btn btn-outline-success disabled">Đã đánh giá</span>
                    }
                }
            }

            else if (IsPending)
            {
                <button type="button"
                        class="btn btn-outline-secondary"
                        onclick="window.location.href='@Url.Action("WithProvider", "ChatCustomer", new { area = "Customer", providerId = Model.ProviderId })'">
                    <i class="bi bi-chat-dots me-1"></i> Liên hệ Shop
                </button>

                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal-@Model.BookingId">Hủy đơn</button>
            }
            else if (IsWorking || IsConfirmed)
            {
                @* Kiểm tra nếu booking đã được xác nhận nhưng chưa thanh toán, hiển thị nút thanh toán *@
                @* Ẩn nút nếu đã thanh toán thành công *@
                var isPaid = Model.PaidAmount > 0 || 
                             (!string.IsNullOrWhiteSpace(Model.PaymentStatus) && 
                              (Model.PaymentStatus.ToUpperInvariant() == "ĐÃ THANH TOÁN" || 
                               Model.PaymentStatus.ToUpperInvariant() == "PAID" || 
                               Model.PaymentStatus.ToUpperInvariant() == "SUCCESS" || 
                               Model.PaymentStatus.ToUpperInvariant() == "COMPLETED" ||
                               Model.PaymentStatus.ToUpperInvariant() == "00" || // VNPay success code
                               Model.PaymentStatus.Contains("thành công", StringComparison.OrdinalIgnoreCase) ||
                               Model.PaymentStatus.Contains("success", StringComparison.OrdinalIgnoreCase)));
                
                @* Chỉ hiển thị nút thanh toán nếu booking đã được xác nhận và CHƯA thanh toán *@
                if (IsConfirmed && !isPaid)
                {
                    <form asp-area="Customer" 
                          asp-controller="BookingService" 
                          asp-action="PayAfterConfirmation" 
                          method="post" 
                          style="display: inline;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="bookingIds" value="@Model.BookingId" />
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-credit-card me-1"></i> Thanh toán ngay
                        </button>
                    </form>
                }
                
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#staffInfoModal">
                    <i class="bi bi-person-vcard me-1"></i> Liên hệ nhân viên
                </button>
            }
            else if (IsCancelled)
            {
                <form asp-area="Customer" asp-controller="BookingService" asp-action="ReorderBooking" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                    <input type="hidden" name="serviceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />
                    @if (Model?.Options?.Any() == true)
                    {
                        @foreach (var opt in Model.Options)
                        {
                            <input type="hidden" name="optionIds" value="@opt.OptionId" />
                        }
                    }
                    <button type="submit" class="btn btn-danger">Mua Lại</button>
                </form>
            }
        </div>
    </div>

    @* Modal: Thông tin nhân viên *@
    @{
        var modalStaffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? "—" : Model!.StaffName!;
        var modalStaffImg = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;
        var modalStaffPhone = !string.IsNullOrWhiteSpace(Model?.StaffPhone) ? Model!.StaffPhone! : (string.IsNullOrWhiteSpace(ViewBag.StaffPhone as string) ? "—" : (string)ViewBag.StaffPhone);
        var modalStaffAddress = !string.IsNullOrWhiteSpace(Model?.StaffAddress) ? Model!.StaffAddress! : (string.IsNullOrWhiteSpace(ViewBag.StaffAddress as string) ? "—" : (string)ViewBag.StaffAddress);
    }
    <div class="modal fade" id="staffInfoModal" tabindex="-1" aria-labelledby="staffInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 560px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="staffInfoModalLabel" class="modal-title" style="font-size: 1.125rem; font-weight: 700;">Thông tin nhân viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-3 align-items-start">
                        <img src="@modalStaffImg"
                             alt="Ảnh nhân viên"
                             width="140" height="140"
                             style="object-fit:cover;border-radius:50%;border:1px solid #eee; cursor: zoom-in;"
                             loading="lazy"
                             decoding="async"
                             onerror="this.onerror=null;this.src='@fallbackImg';"
                             class="zoomable"
                             data-full="@modalStaffImg" />
                        <div class="flex-grow-1">
                            <div class="fw-semibold mb-1" style="font-size: 1.05rem;">@modalStaffName</div>
                            <div class="text-muted mb-2" style="font-size: .95rem;">
                                <i class="bi bi-geo-alt"></i>
                                <span class="ms-1">@modalStaffAddress</span>
                            </div>
                            <div class="text-muted" style="font-size: .95rem;">
                                <i class="bi bi-telephone"></i>
                                <a href="tel:@modalStaffPhone" class="ms-1 text-decoration-none">@modalStaffPhone</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Steps: chỉ hiện cho 4 trạng thái chính -->
    @if (IsFourStates)
    {
        <div class="progress-steps">
            <div class="step @StepClass("Pending")">
                <div class="icon"><i class="bi bi-receipt"></i></div>
                <div class="label">Chờ xác nhận</div>
                <div class="meta">
                    <span><span class="label">Trạng thái:</span> @stepPaymentStatusText</span>
                </div>
            </div>

            @{
                var stepStaffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                var stepStaffImg = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;
                var stepStaffPhone = ViewBag.StaffPhone as string;
                var stepStaffAddress = ViewBag.StaffAddress as string;
            }

            <div class="step @StepClass("Confirmed")">
                <div class="icon"><i class="bi bi-check2-circle"></i></div>
                <div class="label">Xác Nhận</div>

                <div class="meta">
                    @if (!string.IsNullOrWhiteSpace(stepStaffName))
                    {
                        <span class="d-inline-flex align-items-center gap-2 flex-wrap">
                            <span><span class="label">Nhân viên:</span> @stepStaffName</span>
                            <img src="@stepStaffImg"
                                 alt="Ảnh @stepStaffName"
                                 width="20" height="20"
                                 style="object-fit:cover;border-radius:50%;border:1px solid #eee"
                                 loading="lazy"
                                 decoding="async"
                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                            
                        </span>
                    }
                    else
                    {
                        <span><span class="label">Nhân viên:</span> Chưa phân công</span>
                    }
                </div>
            </div>


            <div class="step @StepClass("InProgress")">
                <div class="icon"><i class="bi bi-hammer"></i></div>
                <div class="label">Bắt Đầu Làm Việc</div>
                <div class="meta">
                    <span><span class="label">Thời Gian:</span> @fmt(timeOf("Check In"))</span>
                </div>
            </div>

            <div class="step @StepClass("Completed")">
                <div class="icon"><i class="bi bi-star"></i></div>
                <div class="label">Hoàn thành</div>
                <div class="meta">
                    <span><span class="label">Thời Gian:</span> @fmt(timeOf("Check Out"))</span>
                </div>
            </div>
        </div>
    }

    <!-- Address + Timeline -->
    <div class="row g-3 section-spacing">
        <div class="col-lg-6">
            <div class="card-block p-3 h-100">
                <div class="h6">Địa Chỉ Đặt Dịch Vụ</div>
                <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(Model?.RecipientFullName) ? Model.RecipientFullName : "—")</div>
                <div>@(!string.IsNullOrWhiteSpace(Model?.RecipientPhone) ? Model.RecipientPhone : "—")</div>
                <div>@(!string.IsNullOrWhiteSpace(Model?.AddressLine) ? Model.AddressLine : "—")</div>
                <hr />
                @if (!string.IsNullOrWhiteSpace(Model?.ShippingTrackingCode))
                {
                    <div class="small text-muted">Mã theo dõi: @Model.ShippingTrackingCode</div>
                }
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-block p-3 h-100">
                <div class="h6">Tiến trình dịch vụ</div>
                <div class="timeline">
                    @foreach (var e in (Model?.Timeline ?? new List<VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO.TrackingEventDTO>()).OrderBy(t => t.Time))
                    {
                        var code = (e.Code ?? "").Trim().ToUpperInvariant();

                        // Cho CONFIRMED, INPROGRESS, COMPLETED, CHECK IN, CHECK OUT đều hiện ảnh + staff
                        var onlyShowProofFor = code == "CONFIRMED"
                        || code == "INPROGRESS"
                        || code == "COMPLETED"
                        || code == "CHECK IN"
                        || code == "CHECK OUT";

                        var showStaffFor = code == "CONFIRMED"
                        || code == "INPROGRESS"
                        || code == "COMPLETED"
                        || code == "CHECK IN"
                        || code == "CHECK OUT";


                        var staffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                        var staffImage = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;

                        <div class="tl-item">
                            <div class="fw-semibold">@e.Title</div>
                            <div class="text-muted small">@(e.Time.ToString("dd-MM-yyyy HH:mm"))</div>

                            @if (code == "CREATED" && (Model?.PaidAmount ?? 0m) > 0)
                            {
                                <div class="small text-success">Đã thanh toán: <b>@currency(Model!.PaidAmount)</b></div>
                            }

                            @if (showStaffFor && !string.IsNullOrWhiteSpace(staffName))
                            {
                                <div class="staff">
                                    <img src="@staffImage"
                                         alt="Ảnh @staffName"
                                         class="zoomable"
                                         loading="lazy"
                                         decoding="async"
                                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    <div class="meta">
                                        <div class="fw-semibold">@staffName</div>
                                        <div class="role">Nhân viên phụ trách</div>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(e.Description))
                            {
                                <div class="small">@e.Description</div>
                            }

                            @if (onlyShowProofFor && (e.Proofs?.Any() == true))
                            {
                                <div class="proofs mt-2">
                                    @foreach (var p in e.Proofs)
                                    {
                                        if ((p.MediaType ?? "image").ToLower() == "image")
                                        {
                                            var src = !string.IsNullOrWhiteSpace(p.Url) ? p.Url : fallbackImg;
                                            <img src="@src"
                                                 alt="@p.Caption"
                                                 class="zoomable"
                                                 loading="lazy"
                                                 decoding="async"
                                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                                        }
                                        else
                                        {
                                            <a class="btn btn-sm btn-outline-secondary" href="@p.Url" target="_blank" rel="noopener">
                                                <i class="bi bi-play-circle"></i> Xem video
                                            </a>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>

    <!-- Service block -->
    <div class="card-block p-3 section-spacing">
        <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
            <div class="d-flex align-items-center gap-2">
                <img src="@GetProviderLogo(Model?.ProviderImages)" width="24" height="24" alt="@Model?.ProviderName" class="shop-logo" style="object-fit:cover;border-radius:4px;" onerror="this.src='/images/VeSinh.jpg';" />
                <div class="fw-semibold">
                    @(!string.IsNullOrWhiteSpace(Model?.ProviderName) ? Model.ProviderName : "—")
                </div>
                <span class="ms-2 badge text-bg-light">
                    Nhân viên: @(string.IsNullOrWhiteSpace(Model?.StaffName) ? "—" : Model!.StaffName)
                </span>
            </div>

            <div class="d-flex align-items-center gap-2 shop-actions">
                <a class="btn btn-ghost btn-sm"
                   asp-area="Customer"
                   asp-controller="ChatCustomer"
                   asp-action="WithProvider"
                   asp-route-providerId="@Model.ProviderId">
                    <i class="bi bi-chat-dots me-1"></i> Chat
                </a>
                <a class="btn btn-primary btn-sm"
                   asp-area=""
                   asp-controller="ServiceShop"
                   asp-action="Index"
                   asp-route-providerId="@Model.ProviderId">
                    <i class="bi bi-shop me-1"></i> Xem shop
                </a>
            </div>
        </div>

        <div class="d-flex gap-3">
            @{
                var basePrice = Model?.Service?.UnitPrice ?? 0m;
                var optionPrice = 0m; // Options no longer have Price
                var total = basePrice + optionPrice;
            }
            <img src="@GetServiceImage(Model?.ServiceImages)"
                 alt="Ảnh dịch vụ"
                 class="zoomable"
                 loading="lazy" decoding="async"
                 onerror="this.onerror=null;this.src='@fallbackImg';"
                 style="width:96px;height:96px;object-fit:cover;border:1px solid #eee;border-radius:6px" />

            <div class="flex-grow-1">
                <div class="fw-semibold">@Model?.Service?.Title</div>
                <!-- <div class="text-muted">x@(Model?.Service?.Quantity ?? 0)</div> -->
                @if (Model?.Options?.Any() == true)
                {
                    @* Hiển thị danh sách options phẳng (không có nhóm) cho Customer *@
                    @* Tách options thành 2 nhóm: non-textarea trước, textarea sau *@
                    var nonTextareaOptions = Model.Options.Where(opt => 
                        !(opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text")).ToList();
                    var textareaOptions = Model.Options.Where(opt => 
                        opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text").ToList();
                    
                    <div class="opt-section mt-1">
                        @* Hiển thị non-textarea options trước *@
                        @foreach (var op in nonTextareaOptions)
                        {
                            <div class="opt-row">
                                <div class="opt-name" style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; margin-bottom: 8px;">
                                        <span>✓</span>
                                        <span>@op.OptionName</span>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(op.Value))
                                    {
                                        <div style="margin-top: 8px;">
                                            <span class="text-muted" style="margin-left: 4px;">@op.Value</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        
                        @* Hiển thị textarea options sau cùng *@
                        @foreach (var op in textareaOptions)
                        {
                            var isTextarea = op.Type?.ToLower() == "textarea" || op.Type?.ToLower() == "text";
                            <div class="opt-row">
                                <div class="opt-name" style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; margin-bottom: 8px;">
                                        <span>✓</span>
                                        <span>@op.OptionName</span>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(op.Value))
                                    {
                                        <div style="margin-top: 8px;">
                                                       
                                            @if (isTextarea)
                                            {
                                                <div class="option-value-text" style="white-space: pre-wrap; word-wrap: break-word; margin-top: 4px; font-size: 0.9em; line-height: 1.5;">@op.Value</div>
                                            }
                                            else
                                            {
                                                <span class="text-muted" style="margin-left: 4px;">@op.Value</span>
                                            }
                                        </div>
                                    }
                                    else if (isTextarea)
                                    {
                                        <div style="margin-top: 8px; color: #6c757d; font-size: 0.875em;">
                                            <i class="bi bi-info-circle" style="margin-right: 4px;"></i>Chưa có
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="service-price-box">
                <div class="price-item">
                    <span class="price-label">Giá dịch vụ</span>
                    <span class="price-value">@basePrice.ToString("N0")đ</span>
                </div>
                @if (optionPrice > 0)
                {
                    <div class="price-item">
                        <span class="price-label">+ Gói tùy chọn</span>
                        <span class="price-value">@optionPrice.ToString("N0")đ</span>
                    </div>
                }
                <div class="price-divider"></div>
                <div class="price-total">
                    <span class="price-total-value">@total.ToString("N0")đ</span>
                </div>
            </div>
        </div>

        <!-- Giờ thực hiện (readonly) -->
        <div class="booking-time readonly mb-2">
            <div class="booking-label">Giờ thực hiện dịch vụ</div>
            <div class="booking-chip">
                <i class="bi bi-clock"></i>
                @(bookingTime.HasValue? bookingTime.Value.ToString("HH:mm dd-MM-yyyy") : "—")
            </div>
        </div>

        @{
            var providerId = Model?.ProviderId ?? Guid.Empty;
        }
        <div class="tos-view d-flex align-items-center gap-2 mt-3">
            <i class="bi bi-file-text"></i>
            <span>Điều khoản dịch vụ của nhà cung cấp này.</span>
            <a href="#"
               class="tos-link"
               data-provider-id="@providerId"
               onclick="openTosModal('@providerId'); return false;">
                Xem điều khoản
            </a>
        </div>
        <small class="text-muted d-block mt-1">
            (Thông tin hiển thị để tham khảo. Bạn đã đồng ý điều khoản khi đặt đơn.)
        </small>
    </div>

    <!-- Prices -->
    <div class="card-block p-3 section-spacing">
        <div class="price-row"><span>Tổng tiền hàng</span><span>@currency(Model?.Subtotal ?? 0m)</span></div>
        <div class="price-row"><span>Mã giảm giá</span><span>-@currency(Model?.VoucherDiscount ?? 0m)</span></div>
        <div class="price-row">
            <span class="fw-semibold">Thành tiền</span>
            <span class="price-strong fs-4">@currency(grandTotal)</span>
        </div>
        <div class="price-row">
            <span>Phương thức thanh toán</span>
            <span>
                @{
                    var paymentMethodText = "—";
                    if (!string.IsNullOrWhiteSpace(Model?.PaymentMethod))
                    {
                        paymentMethodText = Model.PaymentMethod switch
                        {
                            "CreditCard" => "Thẻ tín dụng",
                            "BankTransfer" => "Chuyển khoản ngân hàng",
                            "Cash" => "Tiền mặt",
                            "VnPay" => "VnPay",
                            "MoMo" => "Ví MoMo",
                            "ZaloPay" => "Ví ZaloPay",
                            "Wallet" => "Ví điện tử",
                            "E-Wallet" => "Ví điện tử",
                            "Refund" => "Hoàn tiền",
                            _ => Model.PaymentMethod
                        };
                    }
                }
                @paymentMethodText
            </span>
        </div>

        @{
            // Xác định trạng thái thanh toán dựa trên PaymentStatus hoặc PaidAmount
            var paymentStatusDetail = Model?.PaymentStatus;
            var paymentStatusText = "Chưa thanh toán";
            var paymentStatusClass = "text-warning";
            var paymentStatusIcon = "bi-clock-history";
            
            if (!string.IsNullOrWhiteSpace(paymentStatusDetail))
            {
                var statusUpper = paymentStatusDetail.Trim().ToUpperInvariant();
                if (statusUpper == "ĐÃ THANH TOÁN" || 
                    statusUpper == "PAID" || 
                    statusUpper == "SUCCESS" || 
                    statusUpper == "COMPLETED")
                {
                    paymentStatusText = "Đã thanh toán";
                    paymentStatusClass = "text-success";
                    paymentStatusIcon = "bi-check-circle-fill";
                }
                else if (statusUpper == "REFUNDED")
                {
                    paymentStatusText = "Đã hoàn tiền";
                    paymentStatusClass = "text-info";
                    paymentStatusIcon = "bi-arrow-counterclockwise";
                }
                else if (statusUpper == "PENDING")
                {
                    paymentStatusText = "Chờ thanh toán";
                    paymentStatusClass = "text-warning";
                    paymentStatusIcon = "bi-hourglass-split";
                }
            }
            else if (paid > 0 && due == 0)
            {
                paymentStatusText = "Đã thanh toán đủ";
                paymentStatusClass = "text-success";
                paymentStatusIcon = "bi-check2-circle";
            }
            else if (paid > 0 && due > 0)
            {
                paymentStatusText = $"Đã thanh toán: {currency(paid)}. Vui lòng thanh toán còn lại {currency(due)} khi hoàn thành công việc.";
                paymentStatusClass = "text-warning";
                paymentStatusIcon = "bi-exclamation-triangle";
            }
        }
        
        <div class="d-flex justify-content-end mt-3">
            <div class="payment-status-info @paymentStatusClass">
                <i class="bi @paymentStatusIcon"></i>
                <span>@paymentStatusText</span>
            </div>
        </div>
    </div>
</div>

<!-- ===== Modals ===== -->
<div class="modal fade" id="tosModal" tabindex="-1" aria-labelledby="tosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="tosModalLabel" class="modal-title">Điều khoản dịch vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body" id="tosModalBody">
                <div class="muted">Đang tải điều khoản...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@if (IsCompleted && !IsReviewed)
{
    <!-- Modal Đánh Giá -->
    <div class="modal fade" id="reviewModal-@Model.BookingId" tabindex="-1" aria-labelledby="reviewModalLabel-@Model.BookingId" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg review-modal">
            <div class="modal-content">
                <form asp-area="Customer"
                      asp-controller="ReviewCustomer"
                      asp-action="Create"
                      method="post"
                      enctype="multipart/form-data"
                      novalidate
                      onsubmit="
            const inp = this.querySelector('input[name=ImageFiles]');
            console.log('[VIEW] files before submit =', inp?.files?.length || 0);
          ">
                    @Html.AntiForgeryToken()

                    <div class="modal-header border-bottom">
                        <h5 class="modal-title d-flex align-items-center gap-2">
                            <i class="bi bi-star-fill text-warning"></i>
                            Đánh Giá Dịch Vụ
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>

                    <div class="modal-body p-4">
                        @* Backend tự động xử lý thời gian Việt Nam khi lưu review (DateTimeHelper.GetVietnamTime()) *@
                        <input type="hidden" name="BookingId" value="@Model.BookingId" />
                        <input type="hidden" name="ServiceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />
                        <input type="hidden" name="Rating" id="rating-@Model.BookingId" value="0" min="1" />

                        <!-- Thông tin dịch vụ -->
                        <div class="service-info-card mb-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="service-image-wrapper">
                                    <img src="@GetServiceImage(Model?.ServiceImages)" alt="@Model?.Service?.Title" class="service-image" />
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-2">@Model?.Service?.Title</h6>
                                    <div class="text-muted d-flex align-items-center gap-2">
                                        <i class="bi bi-shop text-primary"></i>
                                        <span class="small">@Model?.ProviderName</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Đánh giá sao -->
                        <div class="rating-section mb-4">
                            <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3">
                                <i class="bi bi-star-fill text-warning"></i>
                                <span>Chất lượng dịch vụ</span>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="rating-container">
                                <div class="rating d-flex gap-3 justify-content-center" data-target="rating-@Model.BookingId">
                                @for (int i = 1; i <= 5; i++)
                                {
                                        <i class="bi bi-star rating-star" data-value="@i"></i>
                                    }
                                </div>
                                <div class="rating-text text-center mt-2 text-muted small" id="ratingError-@Model.BookingId" style="display: none;">
                                    <i class="bi bi-exclamation-circle text-danger"></i> <span class="text-danger">Vui lòng chọn số sao đánh giá</span>
                                </div>
                                <div class="rating-text text-center mt-2 text-muted small" id="ratingHint-@Model.BookingId">
                                    <i class="bi bi-info-circle"></i> Vui lòng chọn số sao đánh giá
                                </div>
                            </div>
                        </div>

                        <!-- Nội dung đánh giá -->
                        <div class="comment-section mb-4">
                            <label class="form-label fw-bold d-flex align-items-center gap-2 mb-2">
                                <i class="bi bi-chat-left-text-fill text-primary"></i>
                                <span>Nội dung đánh giá</span>
                            </label>
                            <textarea name="Comment" class="form-control form-control-lg" rows="5" placeholder="Chia sẻ trải nghiệm của bạn về dịch vụ này..."></textarea>
                            <div class="invalid-feedback d-none" id="commentError-@Model.BookingId">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                <span></span>
                            </div>
                            <div class="form-text mt-2 d-flex align-items-start gap-2">
                                <i class="bi bi-lightbulb-fill text-warning mt-1"></i>
                                <span>Đánh giá chi tiết sẽ giúp người khác hiểu rõ hơn về dịch vụ</span>
                            </div>
                        </div>

                        <!-- Hình ảnh -->
                        <div class="image-section">
                            <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3">
                                <i class="bi bi-images text-primary"></i>
                                <span>Hình ảnh</span>
                                <span class="badge bg-secondary">Tối đa 5</span>
                            </label>
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPicker('file-@Model.BookingId')">
                                    <i class="bi bi-camera-fill me-1"></i> Thêm hình ảnh
                                </button>
                            </div>
                            <input id="file-@Model.BookingId"
                                   name="ImageFiles"
                                   type="file"
                                   class="d-none"
                                   accept="image/*"
                                   multiple
                                   onchange="uploaderAddFiles('uploader-@Model.BookingId', this.files, 5)" />

                            <div id="uploader-@Model.BookingId" class="uploader" data-input="file-@Model.BookingId" data-max="5"></div>
                            <div class="form-text mt-2 d-flex align-items-start gap-2">
                                <i class="bi bi-image-fill text-info mt-1"></i>
                                <span>Bạn có thể thêm tối đa 5 hình ảnh để minh họa cho đánh giá</span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer border-top justify-content-center gap-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Hủy
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-send me-1"></i> Gửi đánh giá
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Rating
            document.querySelectorAll('.rating').forEach(group => {
                const stars = group.querySelectorAll('i');
                const target = document.getElementById(group.dataset.target);
                const bookingId = target.id.replace('rating-', '');
                const ratingError = document.getElementById(`ratingError-${bookingId}`);
                const ratingHint = document.getElementById(`ratingHint-${bookingId}`);
                
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const val = star.dataset.value;
                        target.value = val;
                        stars.forEach(s => { s.classList.remove('bi-star-fill'); s.classList.add('bi-star'); });
                        for (let i = 0; i < val; i++) {
                            stars[i].classList.remove('bi-star');
                            stars[i].classList.add('bi-star-fill');
                        }
                        // Ẩn error khi chọn rating
                        if (ratingError) ratingError.style.display = 'none';
                        if (ratingHint) ratingHint.style.display = 'block';
                    });
                });
            });
            
            // Validation cho form đánh giá
            document.querySelectorAll('form[action*="ReviewCustomer/Create"]').forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Ngăn submit mặc định
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                    let hasError = false;
                    
                    // Validate rating
                    const ratingInput = form.querySelector('input[name="Rating"]');
                    const ratingValue = parseInt(ratingInput?.value || '0', 10);
                    const ratingError = document.getElementById(`ratingError-${bookingId}`);
                    const ratingHint = document.getElementById(`ratingHint-${bookingId}`);
                    
                    if (!ratingValue || ratingValue < 1 || ratingValue > 5) {
                        hasError = true;
                        if (ratingError) ratingError.style.display = 'block';
                        if (ratingHint) ratingHint.style.display = 'none';
                    } else {
                        if (ratingError) ratingError.style.display = 'none';
                        if (ratingHint) ratingHint.style.display = 'block';
                    }
                    
                    // Validate comment
                    const comment = form.querySelector('textarea[name="Comment"]')?.value?.trim();
                    const commentError = document.getElementById(`commentError-${bookingId}`);
                    const commentTextarea = form.querySelector('textarea[name="Comment"]');
                    
                    if (!comment || comment.length < 10) {
                        hasError = true;
                        if (commentTextarea) {
                            commentTextarea.classList.add('is-invalid');
                        }
                        if (commentError) {
                            commentError.querySelector('span').textContent = comment ? 'Nội dung đánh giá phải có ít nhất 10 ký tự.' : 'Vui lòng nhập nội dung đánh giá.';
                            commentError.classList.remove('d-none');
                        }
                    } else {
                        if (commentTextarea) {
                            commentTextarea.classList.remove('is-invalid');
                        }
                        if (commentError) {
                            commentError.classList.add('d-none');
                        }
                    }
                    
                    // Nếu có lỗi, scroll đến phần đầu tiên có lỗi
                    if (hasError) {
                        const firstError = form.querySelector('.is-invalid') || ratingError;
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            if (firstError.tagName === 'TEXTAREA') {
                                firstError.focus();
                            }
                        }
                        return false;
                    }
                    
                    // Nếu không có lỗi, submit form
                    form.submit();
                });
                
                // Clear error khi user nhập comment
                const commentTextarea = form.querySelector('textarea[name="Comment"]');
                if (commentTextarea) {
                    commentTextarea.addEventListener('input', function() {
                        if (this.classList.contains('is-invalid')) {
                            this.classList.remove('is-invalid');
                            const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                            const commentError = document.getElementById(`commentError-${bookingId}`);
                            if (commentError) {
                                commentError.classList.add('d-none');
                            }
                        }
                    });
                }
            });

            // Lightbox ảnh
            const imgModalEl = document.getElementById('imgPreviewModal');
            const imgEl = imgModalEl.querySelector('.modal-img');
            const bsImgModal = new bootstrap.Modal(imgModalEl);
            document.body.addEventListener('click', function (e) {
                const t = e.target;
                if (t && t.tagName === 'IMG' && t.classList.contains('zoomable')) {
                    const src = t.getAttribute('data-full') || t.getAttribute('src') || t.dataset.src;
                    const alt = t.getAttribute('alt') || '';
                    if (src) { imgEl.src = src; imgEl.alt = alt; bsImgModal.show(); }
                }
            });
            imgModalEl.addEventListener('hidden.bs.modal', function () { imgEl.src = ''; imgEl.alt = ''; });
            // Close when clicking outside content or on body area
            imgModalEl.addEventListener('click', function (e) {
              const content = imgModalEl.querySelector('.modal-content');
              if (!content) return;
              if (!content.contains(e.target)) {
                const inst = bootstrap.Modal.getInstance(imgModalEl) || new bootstrap.Modal(imgModalEl);
                inst.hide();
              }
            });
            // Also allow closing when clicking image area (zoom out)
            imgModalEl.querySelector('.modal-body')?.addEventListener('click', function(){
              const inst = bootstrap.Modal.getInstance(imgModalEl) || new bootstrap.Modal(imgModalEl);
              inst.hide();
            });

            // Validation cho form hủy đơn - hiển thị lỗi dưới từng field
            document.querySelectorAll('form[action*="CancelBooking"]').forEach(form => {
                // Clear errors khi modal được mở
                const modalId = form.closest('.modal')?.id;
                if (modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.addEventListener('show.bs.modal', function() {
                            // Clear tất cả errors khi mở modal
                            form.querySelectorAll('.is-invalid').forEach(field => {
                                field.classList.remove('is-invalid');
                            });
                            form.querySelectorAll('.invalid-feedback').forEach(errorDiv => {
                                errorDiv.classList.add('d-none');
                            });
                        });
                    }
                }
                
                // Lưu timeout IDs để có thể clear (scope ngoài submit handler)
                const errorTimeouts = {};
                
                form.addEventListener('submit', function(e) {
                    // Ngăn submit mặc định ngay từ đầu
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                    let hasError = false;
                    
                    // Helper function để hiển thị/ẩn lỗi
                    function showError(fieldName, errorId, message) {
                        const field = form.querySelector(`[name="${fieldName}"]`);
                        const errorDiv = document.getElementById(`${errorId}-${bookingId}`);
                        
                        if (field && errorDiv) {
                            // Clear timeout cũ nếu có
                            if (errorTimeouts[errorId]) {
                                clearTimeout(errorTimeouts[errorId]);
                                delete errorTimeouts[errorId];
                            }
                            
                            if (message) {
                                field.classList.add('is-invalid');
                                errorDiv.querySelector('span').textContent = message;
                                errorDiv.classList.remove('d-none');
                                hasError = true;
                                
                                // Tự động ẩn sau 5 giây
                                errorTimeouts[errorId] = setTimeout(() => {
                                    field.classList.remove('is-invalid');
                                    errorDiv.classList.add('d-none');
                                    delete errorTimeouts[errorId];
                                }, 5000);
                            } else {
                                field.classList.remove('is-invalid');
                                errorDiv.classList.add('d-none');
                                // Clear timeout nếu đang có
                                if (errorTimeouts[errorId]) {
                                    clearTimeout(errorTimeouts[errorId]);
                                    delete errorTimeouts[errorId];
                                }
                            }
                        }
                    }
                    
                    // Validate từng field
                    const reason = form.querySelector('textarea[name="Reason"]')?.value?.trim();
                    
                    // Clear all errors first
                    showError('Reason', 'reasonError', '');
                    
                    // Validate và hiển thị lỗi
                    if (!reason) {
                        showError('Reason', 'reasonError', 'Vui lòng nhập lý do hủy đơn hàng.');
                    }
                    
                    // Nếu có lỗi, ngăn submit và scroll đến field đầu tiên có lỗi
                    if (hasError) {
                        const firstError = form.querySelector('.is-invalid');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstError.focus();
                        }
                        return false;
                    }
                    
                    // Nếu không có lỗi, submit form thủ công
                    form.submit();
                });
                
                // Clear error khi user nhập
                form.querySelectorAll('input, textarea').forEach(field => {
                    field.addEventListener('input', function() {
                        if (this.classList.contains('is-invalid')) {
                            this.classList.remove('is-invalid');
                            const fieldName = this.getAttribute('name');
                            let errorId = '';
                            if (fieldName === 'Reason') errorId = 'reasonError';
                            
                            if (errorId) {
                                const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                                const errorDiv = document.getElementById(`${errorId}-${bookingId}`);
                                if (errorDiv) {
                                    errorDiv.classList.add('d-none');
                                }
                                // Clear timeout nếu có
                                if (errorTimeouts[errorId]) {
                                    clearTimeout(errorTimeouts[errorId]);
                                    delete errorTimeouts[errorId];
                                }
                            }
                        }
                    });
                });
            });

        });

          // ===== Uploader ảnh (bản chắc chắn) =====
        const uploaderState = new Map();

        function getDT(wrapperId) {
          if (!uploaderState.has(wrapperId)) uploaderState.set(wrapperId, new DataTransfer());
          return uploaderState.get(wrapperId);
        }

        function openPicker(inputId) {
          const inp = document.getElementById(inputId);
          if (inp) inp.click(); // hidden bằng CSS vẫn ok
        }

        // gọi từ input[type=file].onchange
        function uploaderAddFiles(wrapperId, files, max) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;                  // id của input thật
          const realInput = document.getElementById(inputId);  // input sẽ submit cùng form
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const remain = Math.max(0, max - dt.files.length);
          Array.from(files).slice(0, remain).forEach(f => dt.items.add(f));

          // Luôn đồng bộ về input thật
          realInput.files = dt.files;

          renderUploader(wrapperId);
        }

        function uploaderRemove(wrapperId, idx) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;
          const realInput = document.getElementById(inputId);
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const next = new DataTransfer();
          Array.from(dt.files).forEach((f, i) => { if (i !== idx) next.items.add(f); });
          uploaderState.set(wrapperId, next);

          realInput.files = next.files;
          renderUploader(wrapperId);
        }

        function renderUploader(wrapperId) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const max = parseInt(wrap.dataset.max || '5', 10);
          const inputId = wrap.dataset.input;
          const dt = getDT(wrapperId);

          wrap.innerHTML = '';

          Array.from(dt.files).forEach((f, i) => {
            const box = document.createElement('div');
            box.className = 'thumb';
            const img = document.createElement('img');
            img.className = 'zoomable';
            const fr = new FileReader();
            fr.onload = e => img.src = e.target.result;
            fr.readAsDataURL(f);

            const rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'remove';
            rm.innerText = '×';
            rm.onclick = () => uploaderRemove(wrapperId, i);

            box.appendChild(img);
            box.appendChild(rm);
            wrap.appendChild(box);
          });

          const rest = max - dt.files.length;
          if (rest > 0) {
            const add = document.createElement('div');
            add.className = 'slot slot-add';
            add.onclick = () => openPicker(inputId);

            const icon = document.createElement('i');
            icon.className = 'bi bi-camera';
            const counter = document.createElement('span');
            counter.className = 'counter';
            counter.textContent = `${dt.files.length}/${max}`;

            add.appendChild(icon);
            add.appendChild(counter);
            wrap.appendChild(add);

            for (let i = 1; i < rest; i++) {
              const empty = document.createElement('div');
              empty.className = 'slot';
              wrap.appendChild(empty);
            }
          }
        }

        // init preview
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.uploader').forEach(w => renderUploader(w.id));
        });

        // Log trước khi submit để tự kiểm chứng
        document.addEventListener('submit', function (e) {
          const form = e.target.closest('form');
          if (!form) return;
          const inp = form.querySelector('input[name=ImageFiles]');
          if (inp) console.log('[VIEW] files before submit =', inp.files?.length || 0);
        }, true);

        /* ========= TOS Modal ========= */
        async function openTosModal(providerId) {
            const body = document.getElementById('tosModalBody');
            const modalEl = document.getElementById('tosModal');
            if (!body || !modalEl) return;

            body.innerHTML = '<div class="muted">Đang tải điều khoản...</div>';
            
            try {
                const url = '@Url.Action("GetTermsByProvider", "BookingService", new { area = "Customer" })' + '?providerId=' + providerId;
                const res = await fetch(url, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (res.ok) {
                    const html = await res.text();
                    body.innerHTML = html;
                } else {
                    body.innerHTML = '<div style="color:#c00">Không tải được điều khoản từ máy chủ.</div>';
                }
            } catch (err) {
                body.innerHTML = '<div style="color:#c00">Không tải được điều khoản. Vui lòng thử lại.</div>';
            }

            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
        }

        function closeTosModal() {
            const modalEl = document.getElementById('tosModal');
            if (modalEl) {
                const bsModal = bootstrap.Modal.getInstance(modalEl);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }
    </script>
}

<!-- Modal xem ảnh fullscreen -->
<div class="modal fade" id="imgPreviewModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 1200px;">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
            <div class="modal-body p-0 d-flex justify-content-center align-items-center" style="cursor: zoom-out;">
                <div class="position-relative d-inline-block">
                    <img class="modal-img" src="" alt="" style="max-width: 98vw; max-height: 92vh; border-radius: 10px; background: #fff; object-fit: contain;" />
                    <button type="button" class="btn btn-light position-absolute" data-bs-dismiss="modal" aria-label="Đóng" style="top: 6px; right: 6px; padding: 2px 6px; line-height: 1; border-radius: 6px;">
                        <i class="bi bi-x-lg" style="font-size: .8rem;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Hủy Đơn (chỉ hiển thị khi đơn ở trạng thái Pending) -->
@if (IsPending)
{
    <div class="modal fade" id="cancelModal-@Model.BookingId" tabindex="-1" aria-labelledby="cancelModalLabel-@Model.BookingId" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg cancel-order-modal">
            <div class="modal-content">
                <form asp-area="Customer" asp-controller="BookingService" asp-action="CancelBooking" method="post" novalidate data-booking-id="@Model.BookingId">
                    @Html.AntiForgeryToken()
                    <div class="modal-header border-bottom">
                        <h5 class="modal-title d-flex align-items-center gap-2" id="cancelModalLabel-@Model.BookingId">
                            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                            Hủy đơn hàng
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>

                    <div class="modal-body p-4">
                        <input type="hidden" name="BookingId" value="@Model.BookingId" />
                        
                        <!-- Thông báo -->
                        <div class="alert alert-warning d-flex align-items-start gap-3 mb-4 cancel-warning-alert" role="alert">
                            <i class="bi bi-exclamation-triangle-fill fs-4 mt-1"></i>
                            <div>
                                <strong class="d-block mb-1">Lưu ý quan trọng</strong>
                                <span>Việc hủy đơn sẽ không thể hoàn tác. Nếu bạn đã thanh toán và muốn yêu cầu hoàn tiền, vui lòng sử dụng chức năng "Báo cáo" với loại "Yêu cầu hoàn tiền".</span>
                            </div>
                        </div>

                        <!-- Lý do hủy -->
                        <div class="cancel-reason-section mb-4">
                            <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3">
                                <i class="bi bi-chat-left-text-fill text-danger"></i>
                                <span>Lý do hủy</span>
                                <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control form-control-lg" name="Reason" rows="5" placeholder="Vui lòng mô tả ngắn gọn lý do hủy đơn hàng của bạn..."></textarea>
                            <div class="invalid-feedback d-none" id="reasonError-@Model.BookingId">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                <span></span>
                            </div>
                            <div class="form-text mt-2 d-flex align-items-start gap-2">
                                <i class="bi bi-lightbulb-fill text-warning mt-1"></i>
                                <span>Ví dụ: Đặt nhầm dịch vụ, thay đổi thời gian, tìm được nhà cung cấp khác...</span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer border-top justify-content-center gap-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Đóng
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-check-circle me-1"></i> Xác nhận hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

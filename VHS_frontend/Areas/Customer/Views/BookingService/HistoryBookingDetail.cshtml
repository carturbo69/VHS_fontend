@model VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO
@{
    ViewData["Title"] = "Chi tiết đơn dịch vụ";

    // Chỉ 4 trạng thái chính + Cancelled (để hiện banner), KHÔNG có "All"
    var statusViMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["Pending"] = "Chờ xác nhận",
        ["Confirmed"] = "Xác Nhận",
        ["InProgress"] = "Bắt Đầu Làm Việc",
        ["Completed"] = "Hoàn thành",
        ["Cancelled"] = "Đã hủy"
    };

    // Ưu tiên NormalizedStatus; nếu trống mặc định "Pending"
    var statusCode = string.IsNullOrWhiteSpace(Model?.NormalizedStatus) ? "Pending" : Model.NormalizedStatus;
    var statusVi = statusViMap.TryGetValue(statusCode, out var vi) ? vi : statusCode;

    var IsPending = statusCode.Equals("Pending", StringComparison.OrdinalIgnoreCase);
    var IsConfirmed = statusCode.Equals("Confirmed", StringComparison.OrdinalIgnoreCase);
    var IsWorking = statusCode.Equals("InProgress", StringComparison.OrdinalIgnoreCase);
    var IsCompleted = statusCode.Equals("Completed", StringComparison.OrdinalIgnoreCase);
    var IsCancelled = statusCode.Equals("Cancelled", StringComparison.OrdinalIgnoreCase);

    var IsReviewed = Model?.HasReview == true; // NEW


    // Steps chỉ áp dụng cho 4 trạng thái chính
    var IsFourStates = IsPending || IsConfirmed || IsWorking || IsCompleted;

    Func<decimal, string> currency = v => v.ToString("N0") + "đ";
    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    string StatusHeadline(string code) => (code ?? "").Trim() switch
    {
        "Pending" => "Đang chờ xác nhận",
        "Confirmed" => "Đã xác nhận",
        "InProgress" => "Đang thực hiện",
        "Completed" => "Đã hoàn thành",
        "Cancelled" => "Đơn đã hủy",
        _ => "—"
    };

    var grandTotal = Model?.Total ?? 0m;
    var paid = Model?.PaidAmount ?? 0m;
    var due = Math.Max(0, grandTotal - paid);

    Func<string, DateTimeOffset?> timeOf = code => Model?.Timeline?
        .Where(e => string.Equals(e.Code, code, StringComparison.OrdinalIgnoreCase))
        .OrderByDescending(e => e.Time)
        .Select(e => (DateTimeOffset?)e.Time)
        .FirstOrDefault();

    Func<DateTimeOffset?, string> fmt = t => t.HasValue ? t.Value.ToString("HH:mm dd-MM") : "—";

    // Thứ tự cho 4 trạng thái
    var order = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
    {
        ["Pending"] = 0,
        ["Confirmed"] = 1,
        ["InProgress"] = 2,
        ["Completed"] = 3
    };
    var currentIndex = order.TryGetValue(statusCode, out var idx) ? idx : -1;

    Func<string, string> StepClass = key =>
    {
        if (!order.TryGetValue(key, out var k)) return "";
        if (currentIndex < 0) return "";   // ví dụ Cancelled thì không active/done step
        if (k < currentIndex) return "done";
        if (k == currentIndex) return "active";
        return "";
    };

    DateTimeOffset? bookingTime = ViewBag.BookingTime as DateTimeOffset?;
    bookingTime ??= timeOf("InProgress");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/history-booking-detail.css" asp-append-version="true" />

<div class="container my-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <div class="fw-semibold">MÃ ĐƠN HÀNG: @(string.IsNullOrWhiteSpace(Model?.BookingCode) ? "—" : Model.BookingCode)</div>
            <div class="text-danger fw-bold">@StatusHeadline(statusCode)</div>
            @if (IsCancelled)
            {
                <div class="small text-muted">Đơn đã bị hủy. Vui lòng xem lý do hủy ở bên dưới nếu có.</div>
            }
        </div>

        <!-- Nút hành động -->
        <div class="d-flex gap-2">
            @if (IsCompleted)
            {
                <button class="btn btn-danger">Mua Lại</button>
                <a asp-area="Customer" asp-controller="BookingService" asp-action="ReportService" asp-route-bookingId="@Model.BookingId" class="btn btn-outline-secondary">
                    Báo cáo / Hoàn tiền
                </a>

                @if (!IsReviewed)  // chỉ hiện khi CHƯA review
                {
                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reviewModal-@Model.BookingId">
                        Đánh giá
                    </button>
                }
                else
                {
                    <span class="btn btn-outline-success disabled">Đã đánh giá</span>
                }
            }

            else if (IsPending)
            {
                <button class="btn btn-outline-secondary">Liên hệ Shop</button>
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal-@Model.BookingId">Hủy đơn</button>
            }
            else if (IsWorking || IsConfirmed)
            {
                <button class="btn btn-primary">Xem vận đơn</button>
                <button class="btn btn-outline-secondary">Liên hệ Shipper</button>
            }
            else if (IsCancelled)
            {
                <button class="btn btn-outline-secondary">Lý do hủy</button>
                <button class="btn btn-danger">Mua Lại</button>
            }
        </div>
    </div>

    <!-- Steps: chỉ hiện cho 4 trạng thái chính -->
    @if (IsFourStates)
    {
        <div class="progress-steps">
            <div class="step @StepClass("Pending")">
                <div class="icon"><i class="bi bi-receipt"></i></div>
                <div class="label">Chờ xác nhận</div>
                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("Pending"))</span>
                    <span><span class="label">Đã thanh toán:</span> @((Model?.PaidAmount ?? 0m).ToString("N0")) đ</span>
                </div>
            </div>

            @{
                var stepStaffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                var stepStaffImg = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;
            }

            <div class="step @StepClass("Confirmed")">
                <div class="icon"><i class="bi bi-check2-circle"></i></div>
                <div class="label">Xác Nhận</div>

                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("CONFIRMED"))</span>

                    @if (!string.IsNullOrWhiteSpace(stepStaffName))
                    {
                        <span class="d-inline-flex align-items-center gap-2">
                            <img src="@stepStaffImg"
                                 alt="Ảnh @stepStaffName"
                                 width="20" height="20"
                                 style="object-fit:cover;border-radius:50%;border:1px solid #eee"
                                 loading="lazy"
                                 decoding="async"
                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                            <span><span class="label">Nhân viên:</span> @stepStaffName</span>
                        </span>
                    }
                    else
                    {
                        <span><span class="label">Nhân viên:</span> Chưa phân công</span>
                    }
                </div>
            </div>


            <div class="step @StepClass("InProgress")">
                <div class="icon"><i class="bi bi-hammer"></i></div>
                <div class="label">Bắt Đầu Làm Việc</div>
                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("InProgress"))</span>
                </div>
            </div>

            <div class="step @StepClass("Completed")">
                <div class="icon"><i class="bi bi-star"></i></div>
                <div class="label">Hoàn thành</div>
                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("COMPLETED"))</span>
                </div>
            </div>
        </div>
    }

    <!-- Address + Timeline -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card-block p-3 h-100">
                <div class="h6">Địa Chỉ Đặt Dịch Vụ</div>
                <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(Model?.RecipientFullName) ? Model.RecipientFullName : "—")</div>
                <div>@(!string.IsNullOrWhiteSpace(Model?.RecipientPhone) ? Model.RecipientPhone : "—")</div>
                <div>@(!string.IsNullOrWhiteSpace(Model?.AddressLine) ? Model.AddressLine : "—")</div>
                <hr />
                @if (!string.IsNullOrWhiteSpace(Model?.ShippingTrackingCode))
                {
                    <div class="small text-muted">Mã theo dõi: @Model.ShippingTrackingCode</div>
                }
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-block p-3 h-100">
                <div class="h6">Tiến trình dịch vụ</div>
                <div class="timeline">
                    @foreach (var e in (Model?.Timeline ?? new List<VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO.TrackingEventDTO>()).OrderBy(t => t.Time))
                    {
                        var code = (e.Code ?? "").Trim().ToUpperInvariant();
                        var onlyShowProofFor = code == "CONFIRMED" || code == "INPROGRESS" || code == "COMPLETED";
                        var showStaffFor = code == "CONFIRMED" || code == "INPROGRESS" || code == "COMPLETED";

                        var staffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                        var staffImage = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;

                        <div class="tl-item">
                            <div class="fw-semibold">@e.Title</div>
                            <div class="text-muted small">@(e.Time.ToString("dd-MM-yyyy HH:mm"))</div>

                            @if (code == "CREATED" && (Model?.PaidAmount ?? 0m) > 0)
                            {
                                <div class="small text-success">Đã thanh toán: <b>@currency(Model!.PaidAmount)</b></div>
                            }

                            @if (showStaffFor && !string.IsNullOrWhiteSpace(staffName))
                            {
                                <div class="staff">
                                    <img src="@staffImage"
                                         alt="Ảnh @staffName"
                                         class="zoomable"
                                         loading="lazy"
                                         decoding="async"
                                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    <div class="meta">
                                        <div class="fw-semibold">@staffName</div>
                                        <div class="role">Nhân viên phụ trách</div>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(e.Description))
                            {
                                <div class="small">@e.Description</div>
                            }

                            @if (onlyShowProofFor && (e.Proofs?.Any() == true))
                            {
                                <div class="proofs mt-2">
                                    @foreach (var p in e.Proofs)
                                    {
                                        if ((p.MediaType ?? "image").ToLower() == "image")
                                        {
                                            var src = !string.IsNullOrWhiteSpace(p.Url) ? p.Url : fallbackImg;
                                            <img src="@src"
                                                 alt="@p.Caption"
                                                 class="zoomable"
                                                 loading="lazy"
                                                 decoding="async"
                                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                                        }
                                        else
                                        {
                                            <a class="btn btn-sm btn-outline-secondary" href="@p.Url" target="_blank" rel="noopener">
                                                <i class="bi bi-play-circle"></i> Video
                                            </a>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>

    <!-- Service block -->

    <div class="card-block p-3 mt-3">
        <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
            <div class="d-flex align-items-center gap-2">
                <img src="/images/shop-badge.svg" width="24" height="24" alt="shop"
                     loading="lazy" decoding="async"
                     onerror="this.onerror=null;this.src='@fallbackImg';" />
                <div class="fw-semibold">
                    @(!string.IsNullOrWhiteSpace(Model?.ProviderName) ? Model.ProviderName : "—")
                </div>
                <span class="ms-2 badge text-bg-light">
                    Nhân viên: @(string.IsNullOrWhiteSpace(Model?.StaffName) ? "—" : Model!.StaffName)
                </span>
            </div>

            <div class="d-flex align-items-center gap-2 shop-actions">
                <a class="btn btn-ghost btn-sm"
                   asp-area="Customer"
                   asp-controller="Chat"
                   asp-action="WithProvider"
                   asp-route-providerId="@Model.ProviderId">
                    <i class="bi bi-chat-dots me-1"></i> Chat
                </a>
                <a class="btn btn-primary btn-sm"
                   asp-area="Customer"
                   asp-controller="Shop"
                   asp-action="Detail"
                   asp-route-id="@Model.ProviderId">
                    <i class="bi bi-shop me-1"></i> Xem shop
                </a>
            </div>
        </div>

        <div class="d-flex gap-3">
            @{
                var serviceImg = !string.IsNullOrWhiteSpace(Model?.Service?.Image) ? Model.Service.Image : fallbackImg;
                var basePrice = Model?.Service?.UnitPrice ?? 0m;
                var optionPrice = Model?.Options?.Sum(o => o.Price) ?? 0m;
                var total = basePrice + optionPrice;
            }
            <img src="@serviceImg"
                 alt="Ảnh dịch vụ"
                 class="zoomable"
                 loading="lazy" decoding="async"
                 onerror="this.onerror=null;this.src='@fallbackImg';"
                 style="width:96px;height:96px;object-fit:cover;border:1px solid #eee;border-radius:6px" />

            <div class="flex-grow-1">
                <div class="fw-semibold">@Model?.Service?.Title</div>
                <div class="text-muted">x@(Model?.Service?.Quantity ?? 0)</div>
                @if (Model?.Options?.Any() == true)
                {
                    <div class="mt-1">
                        @foreach (var op in Model!.Options)
                        {
                            <span class="option-badge" title="@op.Description">
                                @op.OptionName • @op.Price.ToString("N0") @op.UnitType
                            </span>
                        }
                    </div>
                }
            </div>

            <div class="text-end">
                <div class="text-muted small">Giá dịch vụ</div>
                <div class="fw-semibold">@basePrice.ToString("N0")đ</div>
                @if (optionPrice > 0)
                {
                    <div class="text-muted small mt-1">+ Gói tùy chọn</div>
                    <div class="fw-semibold">@optionPrice.ToString("N0")đ</div>
                }
                <hr class="my-1" />
                <div class="fs-5 fw-bold">@total.ToString("N0")đ</div>
            </div>
        </div>

        <!-- Giờ thực hiện (readonly) -->
        <div class="booking-time readonly mb-2">
            <div class="booking-label">Giờ thực hiện dịch vụ</div>
            <div class="booking-chip">
                <i class="bi bi-clock"></i>
                @(bookingTime.HasValue? bookingTime.Value.ToString("HH:mm dd-MM-yyyy") : "—")
            </div>
        </div>

        @{
            var providerId = Model?.ProviderId ?? Guid.Empty;
        }
        <div class="tos-view d-flex align-items-center gap-2 mt-3">
            <i class="bi bi-file-text"></i>
            <span>Điều khoản dịch vụ của nhà cung cấp này.</span>
            <a href="#"
               class="tos-link"
               data-provider-id="@providerId"
               onclick="openTosModal('@providerId'); return false;">
                Xem điều khoản
            </a>
        </div>
        <small class="text-muted d-block mt-1">
            (Thông tin hiển thị để tham khảo. Bạn đã đồng ý điều khoản khi đặt đơn.)
        </small>
    </div>

    <!-- Prices -->
    <div class="card-block p-3 mt-3">
        <div class="price-row"><span>Tổng tiền hàng</span><span>@currency(Model?.Subtotal ?? 0m)</span></div>
        <div class="price-row"><span>Voucher</span><span>-@currency(Model?.VoucherDiscount ?? 0m)</span></div>
        <div class="price-row"><span>Phương thức thanh toán</span><span>@(string.IsNullOrWhiteSpace(Model?.PaymentMethod) ? "—" : Model.PaymentMethod)</span></div>
        <div class="price-row">
            <span class="fw-semibold">Thành tiền</span>
            <span class="price-strong fs-4">@currency(grandTotal)</span>
        </div>

        @if (due > 0)
        {
            <div class="mt-2 small text-warning">
                Đã thanh toán: <b>@currency(paid)</b>. Vui lòng thanh toán còn lại <b>@currency(due)</b> khi hoàn thành công việc.
            </div>
        }
        else
        {
            <div class="mt-2 small text-success">
                <i class="bi bi-check2-circle"></i> Đã thanh toán đủ.
            </div>
        }
    </div>
</div>

<!-- ===== Modals ===== -->
<div class="modal fade" id="tosModal" tabindex="-1" aria-labelledby="tosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="tosModalLabel" class="modal-title">Điều khoản dịch vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body" id="tosModalBody">
                <div class="muted">Đang tải điều khoản...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@if (IsCompleted && !IsReviewed)
{
<div class="modal fade" id="reviewModal-@Model.BookingId" tabindex="-1" aria-labelledby="reviewModalLabel-@Model.BookingId" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <!-- POST đúng area/controller/action + antiforgery + enctype -->
            <form asp-area="Customer"
                  asp-controller="ReviewCustomer"
                  asp-action="Create"
                  method="post"
                  enctype="multipart/form-data"
                  onsubmit="
              const inp = this.querySelector('input[name=ImageFiles]');
              console.log('[VIEW] files before submit =', inp?.files?.length || 0);
            ">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Đánh Giá Dịch Vụ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- KHỚP tên DTO -->
                    <input type="hidden" name="BookingId" value="@Model.BookingId" />
                    <input type="hidden" name="ServiceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />

                    <div class="d-flex align-items-center gap-3 mb-3">
                        @{
                            var detailServiceImg = !string.IsNullOrWhiteSpace(Model?.Service?.Image) ? Model.Service.Image : fallbackImg;
                        }
                        <img src="@(detailServiceImg)" width="60" height="60"
                             style="object-fit:cover;border-radius:4px;border:1px solid #eee"
                             class="zoomable"
                             onerror="this.onerror=null;this.src='@fallbackImg';" />
                        <div>
                            <div class="fw-bold">@Model?.Service?.Title</div>
                            <small class="text-muted">@Model?.ProviderName</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Chất lượng dịch vụ:</label>
                        <div class="rating" data-target="rating-@Model.BookingId">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="bi bi-star fs-3 text-warning" data-value="@i"></i>
                            }
                        </div>
                        <input type="hidden" name="Rating" id="rating-@Model.BookingId" value="0" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nội dung đánh giá:</label>
                        <textarea name="Comment" class="form-control" rows="3" placeholder="Hãy chia sẻ trải nghiệm của bạn..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Hình ảnh (tối đa 5 ảnh):</label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn-upload-like" onclick="openPicker('file-@Model.BookingId')">
                                <i class="bi bi-camera"></i> Thêm Hình ảnh
                            </button>
                        </div>

                        <!-- KHỚP tên DTO: ImageFiles -->
                        <input id="file-@Model.BookingId"
                               name="ImageFiles"
                               type="file"
                               class="d-none"
                               accept="image/*"
                               multiple
                               onchange="uploaderAddFiles('uploader-@Model.BookingId', this.files, 5)" />

                        <div id="uploader-@Model.BookingId"
                             class="uploader"
                             data-input="file-@Model.BookingId"
                             data-max="5"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Gửi đánh giá</button>
                </div>
            </form>
        </div>
    </div>
</div>
}

<div class="modal fade" id="cancelModal-@Model.BookingId" tabindex="-1" aria-labelledby="cancelModalLabel-@Model.BookingId" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-area="Customer" asp-controller="BookingService" asp-action="CancelBooking" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel-@Model.BookingId">Hủy đơn hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="BookingId" value="@Model.BookingId" />
                    <div class="mb-3">
                        <label class="form-label fw-bold">Lý do hủy <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="Reason" rows="3" required placeholder="Vui lòng mô tả ngắn gọn lý do hủy..."></textarea>
                        <div class="form-text">Ví dụ: Đặt nhầm dịch vụ, thay đổi thời gian, tìm được nhà cung cấp khác...</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên ngân hàng <span class="text-danger">*</span></label>
                        <input class="form-control" name="BankName" required placeholder="VD: Vietcombank" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tên chủ tài khoản <span class="text-danger">*</span></label>
                        <input class="form-control" name="AccountHolderName" required placeholder="VD: NGUYEN VAN A" />
                    </div>

                    <div class="mb-1">
                        <label class="form-label fw-bold">Số tài khoản <span class="text-danger">*</span></label>
                        <input class="form-control" name="BankAccountNumber" required inputmode="numeric" pattern="[0-9]{6,20}" placeholder="Chỉ nhập số, 6–20 ký tự" />
                    </div>
                    <small class="text-muted">Thông tin ngân hàng được dùng để hoàn tiền (nếu áp dụng).</small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger">Xác nhận hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Rating
            document.querySelectorAll('.rating').forEach(group => {
                const stars = group.querySelectorAll('i');
                const target = document.getElementById(group.dataset.target);
                if (!target) return;
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const val = parseInt(star.dataset.value, 10);
                        target.value = val;
                        stars.forEach(s => { s.classList.remove('bi-star-fill'); s.classList.add('bi-star'); });
                        for (let i = 0; i < val; i++) {
                            stars[i].classList.remove('bi-star');
                            stars[i].classList.add('bi-star-fill');
                        }
                    });
                });
            });

            // Lightbox ảnh
            const imgModalEl = document.getElementById('imgPreviewModal');
            const imgEl = imgModalEl.querySelector('.modal-img');
            const bsImgModal = new bootstrap.Modal(imgModalEl);
            document.body.addEventListener('click', function (e) {
                const t = e.target;
                if (t && t.tagName === 'IMG' && t.classList.contains('zoomable')) {
                    const src = t.getAttribute('data-full') || t.getAttribute('src') || t.dataset.src;
                    const alt = t.getAttribute('alt') || '';
                    if (src) { imgEl.src = src; imgEl.alt = alt; bsImgModal.show(); }
                }
            });
            imgModalEl.addEventListener('hidden.bs.modal', function () { imgEl.src = ''; imgEl.alt = ''; });
        });

          // ===== Uploader ảnh (bản chắc chắn) =====
        const uploaderState = new Map();

        function getDT(wrapperId) {
          if (!uploaderState.has(wrapperId)) uploaderState.set(wrapperId, new DataTransfer());
          return uploaderState.get(wrapperId);
        }

        function openPicker(inputId) {
          const inp = document.getElementById(inputId);
          if (inp) inp.click(); // hidden bằng CSS vẫn ok
        }

        // gọi từ input[type=file].onchange
        function uploaderAddFiles(wrapperId, files, max) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;                  // id của input thật
          const realInput = document.getElementById(inputId);  // input sẽ submit cùng form
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const remain = Math.max(0, max - dt.files.length);
          Array.from(files).slice(0, remain).forEach(f => dt.items.add(f));

          // Luôn đồng bộ về input thật
          realInput.files = dt.files;

          renderUploader(wrapperId);
        }

        function uploaderRemove(wrapperId, idx) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;
          const realInput = document.getElementById(inputId);
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const next = new DataTransfer();
          Array.from(dt.files).forEach((f, i) => { if (i !== idx) next.items.add(f); });
          uploaderState.set(wrapperId, next);

          realInput.files = next.files;
          renderUploader(wrapperId);
        }

        function renderUploader(wrapperId) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const max = parseInt(wrap.dataset.max || '5', 10);
          const inputId = wrap.dataset.input;
          const dt = getDT(wrapperId);

          wrap.innerHTML = '';

          Array.from(dt.files).forEach((f, i) => {
            const box = document.createElement('div');
            box.className = 'thumb';
            const img = document.createElement('img');
            img.className = 'zoomable';
            const fr = new FileReader();
            fr.onload = e => img.src = e.target.result;
            fr.readAsDataURL(f);

            const rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'remove';
            rm.innerText = '×';
            rm.onclick = () => uploaderRemove(wrapperId, i);

            box.appendChild(img);
            box.appendChild(rm);
            wrap.appendChild(box);
          });

          const rest = max - dt.files.length;
          if (rest > 0) {
            const add = document.createElement('div');
            add.className = 'slot slot-add';
            add.onclick = () => openPicker(inputId);

            const icon = document.createElement('i');
            icon.className = 'bi bi-camera';
            const counter = document.createElement('span');
            counter.className = 'counter';
            counter.textContent = `${dt.files.length}/${max}`;

            add.appendChild(icon);
            add.appendChild(counter);
            wrap.appendChild(add);

            for (let i = 1; i < rest; i++) {
              const empty = document.createElement('div');
              empty.className = 'slot';
              wrap.appendChild(empty);
            }
          }
        }

        // init preview
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.uploader').forEach(w => renderUploader(w.id));
        });

        // Log trước khi submit để tự kiểm chứng
        document.addEventListener('submit', function (e) {
          const form = e.target.closest('form');
          if (!form) return;
          const inp = form.querySelector('input[name=ImageFiles]');
          if (inp) console.log('[VIEW] files before submit =', inp.files?.length || 0);
        }, true);
    </script>
}

<!-- Modal xem ảnh fullscreen -->
<div class="modal fade" id="imgPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
        <div class="modal-content bg-black">
            <div class="modal-body p-0">
                <img class="modal-img" src="" alt="">
            </div>
            <div class="position-absolute top-0 end-0 p-2">
                <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal" aria-label="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </div>
</div>

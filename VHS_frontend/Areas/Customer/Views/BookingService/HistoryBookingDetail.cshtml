@model VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO
@{
    ViewData["Title"] = "Chi tiết đơn dịch vụ";

    // Chỉ 4 trạng thái chính + Cancelled (để hiện banner), KHÔNG có "All"
    var statusViMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["Pending"] = "Chờ xác nhận",
        ["Confirmed"] = "Xác Nhận",
        ["InProgress"] = "Bắt Đầu Làm Việc",
        ["Completed"] = "Hoàn thành",
        ["Cancelled"] = "Đã hủy"
    };

    // Ưu tiên NormalizedStatus; nếu trống mặc định "Pending"
    var statusCode = string.IsNullOrWhiteSpace(Model?.NormalizedStatus) ? "Pending" : Model.NormalizedStatus;
    var statusVi = statusViMap.TryGetValue(statusCode, out var vi) ? vi : statusCode;

    // Sử dụng IsPendingStatus property để check cả tiếng Anh và tiếng Việt
    var IsPending = Model?.IsPendingStatus ?? statusCode.Equals("Pending", StringComparison.OrdinalIgnoreCase);
    var IsConfirmed = statusCode.Equals("Confirmed", StringComparison.OrdinalIgnoreCase);
    var IsWorking = statusCode.Equals("InProgress", StringComparison.OrdinalIgnoreCase);
    var IsCompleted = statusCode.Equals("Completed", StringComparison.OrdinalIgnoreCase);
    var IsCancelled = statusCode.Equals("Cancelled", StringComparison.OrdinalIgnoreCase);

    var IsReviewed = Model?.HasReview == true; // NEW


    // Steps chỉ áp dụng cho 4 trạng thái chính
    var IsFourStates = IsPending || IsConfirmed || IsWorking || IsCompleted;

    Func<decimal, string> currency = v => v.ToString("N0") + "đ";
    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    // Helper để lấy ảnh đầu tiên từ ServiceImages (có thể là JSON array hoặc comma-separated string)
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            // Thử parse JSON array trước
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        // Nếu không phải JSON, thử split bằng dấu phẩy
        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        
        // Nếu không có dấu phẩy, trả về nguyên chuỗi
        return images;
    }

    // Helper để lấy ảnh service (backend đã thêm domain prefix)
    string GetServiceImage(string? serviceImages)
    {
        if (string.IsNullOrWhiteSpace(serviceImages))
            return fallbackImg;
        
        var img = FirstImageOrDefault(serviceImages);
        return !string.IsNullOrWhiteSpace(img) ? img : fallbackImg;
    }

    // Helper để lấy logo provider (backend đã thêm domain prefix, giống ServiceShop/Index.cshtml)
    string GetProviderLogo(string? providerImages)
    {
        if (!string.IsNullOrWhiteSpace(providerImages))
        {
            var logo = FirstImageOrDefault(providerImages);
            if (!string.IsNullOrWhiteSpace(logo)) return logo;
        }
        
        // Fallback về shop-badge.svg nếu không có providerImages
        return "/images/shop-badge.svg";
    }

    string StatusHeadline(string code) => (code ?? "").Trim() switch
    {
        "Pending" => "Đang chờ xác nhận",
        "Confirmed" => "Đã xác nhận",
        "InProgress" => "Đang thực hiện",
        "Completed" => "Đã hoàn thành",
        "Cancelled" => "Đơn đã hủy",
        _ => "—"
    };

    var grandTotal = Model?.Total ?? 0m;
    var paid = Model?.PaidAmount ?? 0m;
    var due = Math.Max(0, grandTotal - paid);

    Func<string, DateTimeOffset?> timeOf = code => Model?.Timeline?
        .Where(e => string.Equals(e.Code, code, StringComparison.OrdinalIgnoreCase))
        .OrderByDescending(e => e.Time)
        .Select(e => (DateTimeOffset?)e.Time)
        .FirstOrDefault();

    Func<DateTimeOffset?, string> fmt = t => t.HasValue ? t.Value.ToString("HH:mm dd-MM") : "—";

    // Thứ tự cho 4 trạng thái
    var order = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
    {
        ["Pending"] = 0,
        ["Confirmed"] = 1,
        ["InProgress"] = 2,
        ["Completed"] = 3
    };
    var currentIndex = order.TryGetValue(statusCode, out var idx) ? idx : -1;

    Func<string, string> StepClass = key =>
    {
        if (!order.TryGetValue(key, out var k)) return "";
        if (currentIndex < 0) return "";   // ví dụ Cancelled thì không active/done step
        if (k < currentIndex) return "done";
        if (k == currentIndex) return "active";
        return "";
    };

    DateTimeOffset? bookingTime = ViewBag.BookingTime as DateTimeOffset?;
    bookingTime ??= timeOf("InProgress");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/history-booking-detail.css" asp-append-version="true" />

<div class="container my-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center flex-wrap header-compact">
        <div>
        <h2 class="page-detail-title mb-0">Chi tiết đơn hàng</h2>
            <div class="fw-semibold mb-2">MÃ ĐƠN HÀNG: @(string.IsNullOrWhiteSpace(Model?.BookingCode) ? "—" : Model.BookingCode)</div>
            
            <!-- Breadcrumb Navigation -->
            <nav aria-label="breadcrumb" class="mt-2">
                <ol class="breadcrumb mb-0" style="background: transparent; padding: 0;">
                    <li class="breadcrumb-item">
                        <a asp-area="Customer" asp-controller="BookingService" asp-action="ListHistoryBooking" style="color: var(--accent); text-decoration: none;">Lịch sử đặt hàng</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page" style="color: var(--muted-foreground);">Chi tiết đơn hàng</li>
                </ol>
            </nav>
            
            @if (IsCancelled)
            {
                <div class="small text-muted mt-2">Đơn đã bị hủy. Vui lòng xem lý do hủy ở bên dưới nếu có.</div>
            }
        </div>

        <!-- Nút hành động -->
        <div class="d-flex gap-2">
            @if (IsCompleted)
            {
                var hasReport = ViewBag.HasReport == true;
                var reportId = ViewBag.ReportId as Guid?;

                <form asp-area="Customer" asp-controller="BookingService" asp-action="ReorderBooking" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                    <input type="hidden" name="serviceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />
                    @if (Model?.Options?.Any() == true)
                    {
                        @foreach (var opt in Model.Options)
                        {
                            <input type="hidden" name="optionIds" value="@opt.OptionId" />
                        }
                    }
                    <button type="submit" class="btn btn-danger">Mua Lại</button>
                </form>
                
                if (hasReport && reportId.HasValue)
                {
                    <a asp-area="Customer" asp-controller="BookingService" asp-action="ReportDetail" asp-route-reportId="@reportId.Value" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-text"></i> Xem chi tiết báo cáo
                    </a>
                }
                else
                {
                    <a asp-area="Customer" asp-controller="BookingService" asp-action="ReportService" asp-route-bookingId="@Model.BookingId" class="btn btn-outline-secondary">
                        <i class="bi bi-exclamation-triangle"></i> Báo cáo
                    </a>
                }

                if (!IsReviewed)  // chỉ hiện khi CHƯA review
                {
                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reviewModal-@Model.BookingId">
                        Đánh giá
                    </button>
                }
                else
                {
                    <span class="btn btn-outline-success disabled">Đã đánh giá</span>
                }
            }

            else if (IsPending)
            {
                <button type="button"
                        class="btn btn-outline-secondary"
                        onclick="window.location.href='@Url.Action("WithProvider", "ChatCustomer", new { area = "Customer", providerId = Model.ProviderId })'">
                    <i class="bi bi-chat-dots me-1"></i> Liên hệ Shop
                </button>

                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal-@Model.BookingId">Hủy đơn</button>
            }
            else if (IsWorking || IsConfirmed)
            {
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#staffInfoModal">
                    <i class="bi bi-person-vcard me-1"></i> Liên hệ nhân viên
                </button>
            }
            else if (IsCancelled)
            {
                <form asp-area="Customer" asp-controller="BookingService" asp-action="ReorderBooking" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                    <input type="hidden" name="serviceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />
                    @if (Model?.Options?.Any() == true)
                    {
                        @foreach (var opt in Model.Options)
                        {
                            <input type="hidden" name="optionIds" value="@opt.OptionId" />
                        }
                    }
                    <button type="submit" class="btn btn-danger">Mua Lại</button>
                </form>
            }
        </div>
    </div>

    @* Modal: Thông tin nhân viên *@
    @{
        var modalStaffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? "—" : Model!.StaffName!;
        var modalStaffImg = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;
        var modalStaffPhone = !string.IsNullOrWhiteSpace(Model?.StaffPhone) ? Model!.StaffPhone! : (string.IsNullOrWhiteSpace(ViewBag.StaffPhone as string) ? "—" : (string)ViewBag.StaffPhone);
        var modalStaffAddress = !string.IsNullOrWhiteSpace(Model?.StaffAddress) ? Model!.StaffAddress! : (string.IsNullOrWhiteSpace(ViewBag.StaffAddress as string) ? "—" : (string)ViewBag.StaffAddress);
    }
    <div class="modal fade" id="staffInfoModal" tabindex="-1" aria-labelledby="staffInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 560px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="staffInfoModalLabel" class="modal-title" style="font-size: 1.125rem; font-weight: 700;">Thông tin nhân viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-3 align-items-start">
                        <img src="@modalStaffImg"
                             alt="Ảnh nhân viên"
                             width="140" height="140"
                             style="object-fit:cover;border-radius:50%;border:1px solid #eee; cursor: zoom-in;"
                             loading="lazy"
                             decoding="async"
                             onerror="this.onerror=null;this.src='@fallbackImg';"
                             class="zoomable"
                             data-full="@modalStaffImg" />
                        <div class="flex-grow-1">
                            <div class="fw-semibold mb-1" style="font-size: 1.05rem;">@modalStaffName</div>
                            <div class="text-muted mb-2" style="font-size: .95rem;">
                                <i class="bi bi-geo-alt"></i>
                                <span class="ms-1">@modalStaffAddress</span>
                            </div>
                            <div class="text-muted" style="font-size: .95rem;">
                                <i class="bi bi-telephone"></i>
                                <a href="tel:@modalStaffPhone" class="ms-1 text-decoration-none">@modalStaffPhone</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Steps: chỉ hiện cho 4 trạng thái chính -->
    @if (IsFourStates)
    {
        <div class="progress-steps">
            <div class="step @StepClass("Pending")">
                <div class="icon"><i class="bi bi-receipt"></i></div>
                <div class="label">Chờ xác nhận</div>
                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("Pending"))</span>
                    <span><span class="label">Đã thanh toán:</span> @((Model?.PaidAmount ?? 0m).ToString("N0")) đ</span>
                </div>
            </div>

            @{
                var stepStaffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                var stepStaffImg = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;
                var stepStaffPhone = ViewBag.StaffPhone as string;
                var stepStaffAddress = ViewBag.StaffAddress as string;
            }

            <div class="step @StepClass("Confirmed")">
                <div class="icon"><i class="bi bi-check2-circle"></i></div>
                <div class="label">Xác Nhận</div>

                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("CONFIRMED"))</span>

                    @if (!string.IsNullOrWhiteSpace(stepStaffName))
                    {
                        <span class="d-inline-flex align-items-center gap-2 flex-wrap">
                            <span><span class="label">Nhân viên:</span> @stepStaffName</span>
                            <img src="@stepStaffImg"
                                 alt="Ảnh @stepStaffName"
                                 width="20" height="20"
                                 style="object-fit:cover;border-radius:50%;border:1px solid #eee"
                                 loading="lazy"
                                 decoding="async"
                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                            
                        </span>
                    }
                    else
                    {
                        <span><span class="label">Nhân viên:</span> Chưa phân công</span>
                    }
                </div>
            </div>


            <div class="step @StepClass("InProgress")">
                <div class="icon"><i class="bi bi-hammer"></i></div>
                <div class="label">Bắt Đầu Làm Việc</div>
                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("InProgress"))</span>
                </div>
            </div>

            <div class="step @StepClass("Completed")">
                <div class="icon"><i class="bi bi-star"></i></div>
                <div class="label">Hoàn thành</div>
                <div class="meta">
                    <span><span class="label">Cập nhật:</span> @fmt(timeOf("COMPLETED"))</span>
                </div>
            </div>
        </div>
    }

    <!-- Address + Timeline -->
    <div class="row g-3 section-spacing">
        <div class="col-lg-6">
            <div class="card-block p-3 h-100">
                <div class="h6">Địa Chỉ Đặt Dịch Vụ</div>
                <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(Model?.RecipientFullName) ? Model.RecipientFullName : "—")</div>
                <div>@(!string.IsNullOrWhiteSpace(Model?.RecipientPhone) ? Model.RecipientPhone : "—")</div>
                <div>@(!string.IsNullOrWhiteSpace(Model?.AddressLine) ? Model.AddressLine : "—")</div>
                <hr />
                @if (!string.IsNullOrWhiteSpace(Model?.ShippingTrackingCode))
                {
                    <div class="small text-muted">Mã theo dõi: @Model.ShippingTrackingCode</div>
                }
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-block p-3 h-100">
                <div class="h6">Tiến trình dịch vụ</div>
                <div class="timeline">
                    @foreach (var e in (Model?.Timeline ?? new List<VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO.TrackingEventDTO>()).OrderBy(t => t.Time))
                    {
                        var code = (e.Code ?? "").Trim().ToUpperInvariant();
                        var onlyShowProofFor = code == "CONFIRMED" || code == "INPROGRESS" || code == "COMPLETED";
                        var showStaffFor = code == "CONFIRMED" || code == "INPROGRESS" || code == "COMPLETED";

                        var staffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                        var staffImage = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;

                        <div class="tl-item">
                            <div class="fw-semibold">@e.Title</div>
                            <div class="text-muted small">@(e.Time.ToString("dd-MM-yyyy HH:mm"))</div>

                            @if (code == "CREATED" && (Model?.PaidAmount ?? 0m) > 0)
                            {
                                <div class="small text-success">Đã thanh toán: <b>@currency(Model!.PaidAmount)</b></div>
                            }

                            @if (showStaffFor && !string.IsNullOrWhiteSpace(staffName))
                            {
                                <div class="staff">
                                    <img src="@staffImage"
                                         alt="Ảnh @staffName"
                                         class="zoomable"
                                         loading="lazy"
                                         decoding="async"
                                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    <div class="meta">
                                        <div class="fw-semibold">@staffName</div>
                                        <div class="role">Nhân viên phụ trách</div>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(e.Description))
                            {
                                <div class="small">@e.Description</div>
                            }

                            @if (onlyShowProofFor && (e.Proofs?.Any() == true))
                            {
                                <div class="proofs mt-2">
                                    @foreach (var p in e.Proofs)
                                    {
                                        if ((p.MediaType ?? "image").ToLower() == "image")
                                        {
                                            var src = !string.IsNullOrWhiteSpace(p.Url) ? p.Url : fallbackImg;
                                            <img src="@src"
                                                 alt="@p.Caption"
                                                 class="zoomable"
                                                 loading="lazy"
                                                 decoding="async"
                                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                                        }
                                        else
                                        {
                                            <a class="btn btn-sm btn-outline-secondary" href="@p.Url" target="_blank" rel="noopener">
                                                <i class="bi bi-play-circle"></i> Video
                                            </a>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>

    <!-- Service block -->
    <div class="card-block p-3 section-spacing">
        <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
            <div class="d-flex align-items-center gap-2">
                <img src="@GetProviderLogo(Model?.ProviderImages)" width="24" height="24" alt="@Model?.ProviderName" class="shop-logo" style="object-fit:cover;border-radius:4px;" onerror="this.src='/images/VeSinh.jpg';" />
                <div class="fw-semibold">
                    @(!string.IsNullOrWhiteSpace(Model?.ProviderName) ? Model.ProviderName : "—")
                </div>
                <span class="ms-2 badge text-bg-light">
                    Nhân viên: @(string.IsNullOrWhiteSpace(Model?.StaffName) ? "—" : Model!.StaffName)
                </span>
            </div>

            <div class="d-flex align-items-center gap-2 shop-actions">
                <a class="btn btn-ghost btn-sm"
                   asp-area="Customer"
                   asp-controller="ChatCustomer"
                   asp-action="WithProvider"
                   asp-route-providerId="@Model.ProviderId">
                    <i class="bi bi-chat-dots me-1"></i> Chat
                </a>
                <a class="btn btn-primary btn-sm"
                   asp-area=""
                   asp-controller="ServiceShop"
                   asp-action="Index"
                   asp-route-providerId="@Model.ProviderId">
                    <i class="bi bi-shop me-1"></i> Xem shop
                </a>
            </div>
        </div>

        <div class="d-flex gap-3">
            @{
                var basePrice = Model?.Service?.UnitPrice ?? 0m;
                var optionPrice = Model?.Options?.Sum(o => o.Price) ?? 0m;
                var total = basePrice + optionPrice;
            }
            <img src="@GetServiceImage(Model?.ServiceImages)"
                 alt="Ảnh dịch vụ"
                 class="zoomable"
                 loading="lazy" decoding="async"
                 onerror="this.onerror=null;this.src='@fallbackImg';"
                 style="width:96px;height:96px;object-fit:cover;border:1px solid #eee;border-radius:6px" />

            <div class="flex-grow-1">
                <div class="fw-semibold">@Model?.Service?.Title</div>
                <!-- <div class="text-muted">x@(Model?.Service?.Quantity ?? 0)</div> -->
                @if (Model?.Options?.Any() == true)
                {
                    <div class="mt-1">
                        @foreach (var op in Model!.Options)
                        {
                            <span class="option-badge" title="@op.Description">
                                @op.OptionName - @op.Price.ToString("N0") @op.UnitType
                            </span>
                        }
                    </div>
                }
            </div>

            <div class="service-price-box">
                <div class="price-item">
                    <span class="price-label">Giá dịch vụ</span>
                    <span class="price-value">@basePrice.ToString("N0")đ</span>
                </div>
                @if (optionPrice > 0)
                {
                    <div class="price-item">
                        <span class="price-label">+ Gói tùy chọn</span>
                        <span class="price-value">@optionPrice.ToString("N0")đ</span>
                    </div>
                }
                <div class="price-divider"></div>
                <div class="price-total">
                    <span class="price-total-value">@total.ToString("N0")đ</span>
                </div>
            </div>
        </div>

        <!-- Giờ thực hiện (readonly) -->
        <div class="booking-time readonly mb-2">
            <div class="booking-label">Giờ thực hiện dịch vụ</div>
            <div class="booking-chip">
                <i class="bi bi-clock"></i>
                @(bookingTime.HasValue? bookingTime.Value.ToString("HH:mm dd-MM-yyyy") : "—")
            </div>
        </div>

        @{
            var providerId = Model?.ProviderId ?? Guid.Empty;
        }
        <div class="tos-view d-flex align-items-center gap-2 mt-3">
            <i class="bi bi-file-text"></i>
            <span>Điều khoản dịch vụ của nhà cung cấp này.</span>
            <a href="#"
               class="tos-link"
               data-provider-id="@providerId"
               onclick="openTosModal('@providerId'); return false;">
                Xem điều khoản
            </a>
        </div>
        <small class="text-muted d-block mt-1">
            (Thông tin hiển thị để tham khảo. Bạn đã đồng ý điều khoản khi đặt đơn.)
        </small>
    </div>

    <!-- Prices -->
    <div class="card-block p-3 section-spacing">
        <div class="price-row"><span>Tổng tiền hàng</span><span>@currency(Model?.Subtotal ?? 0m)</span></div>
        <div class="price-row"><span>Voucher</span><span>-@currency(Model?.VoucherDiscount ?? 0m)</span></div>
        <div class="price-row">
            <span class="fw-semibold">Thành tiền</span>
            <span class="price-strong fs-4">@currency(grandTotal)</span>
        </div>
        <div class="price-row"><span>Phương thức thanh toán</span><span>@(string.IsNullOrWhiteSpace(Model?.PaymentMethod) ? "—" : Model.PaymentMethod)</span></div>

        @{
            // Xác định trạng thái thanh toán dựa trên PaymentStatus hoặc PaidAmount
            var paymentStatus = Model?.PaymentStatus;
            var paymentStatusText = "Chưa thanh toán";
            var paymentStatusClass = "text-warning";
            var paymentStatusIcon = "bi-clock-history";
            
            if (!string.IsNullOrWhiteSpace(paymentStatus))
            {
                var statusUpper = paymentStatus.Trim().ToUpperInvariant();
                if (statusUpper == "ĐÃ THANH TOÁN" || 
                    statusUpper == "PAID" || 
                    statusUpper == "SUCCESS" || 
                    statusUpper == "COMPLETED")
                {
                    paymentStatusText = "Đã thanh toán";
                    paymentStatusClass = "text-success";
                    paymentStatusIcon = "bi-check-circle-fill";
                }
                else if (statusUpper == "REFUNDED")
                {
                    paymentStatusText = "Đã hoàn tiền";
                    paymentStatusClass = "text-info";
                    paymentStatusIcon = "bi-arrow-counterclockwise";
                }
                else if (statusUpper == "PENDING")
                {
                    paymentStatusText = "Chờ thanh toán";
                    paymentStatusClass = "text-warning";
                    paymentStatusIcon = "bi-hourglass-split";
                }
            }
            else if (paid > 0 && due == 0)
            {
                paymentStatusText = "Đã thanh toán đủ";
                paymentStatusClass = "text-success";
                paymentStatusIcon = "bi-check2-circle";
            }
            else if (paid > 0 && due > 0)
            {
                paymentStatusText = $"Đã thanh toán: {currency(paid)}. Vui lòng thanh toán còn lại {currency(due)} khi hoàn thành công việc.";
                paymentStatusClass = "text-warning";
                paymentStatusIcon = "bi-exclamation-triangle";
            }
        }
        
        <div class="d-flex justify-content-end mt-3">
            <div class="payment-status-info @paymentStatusClass">
                <i class="bi @paymentStatusIcon"></i>
                <span>@paymentStatusText</span>
            </div>
        </div>
    </div>
</div>

<!-- ===== Modals ===== -->
<div class="modal fade" id="tosModal" tabindex="-1" aria-labelledby="tosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="tosModalLabel" class="modal-title">Điều khoản dịch vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body" id="tosModalBody">
                <div class="muted">Đang tải điều khoản...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@if (IsCompleted && !IsReviewed)
{
<div class="modal fade" id="reviewModal-@Model.BookingId" tabindex="-1" aria-labelledby="reviewModalLabel-@Model.BookingId" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <!-- POST đúng area/controller/action + antiforgery + enctype -->
            <form asp-area="Customer"
                  asp-controller="ReviewCustomer"
                  asp-action="Create"
                  method="post"
                  enctype="multipart/form-data"
                  onsubmit="
              const inp = this.querySelector('input[name=ImageFiles]');
              console.log('[VIEW] files before submit =', inp?.files?.length || 0);
            ">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Đánh Giá Dịch Vụ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- KHỚP tên DTO -->
                    <input type="hidden" name="BookingId" value="@Model.BookingId" />
                    <input type="hidden" name="ServiceId" value="@(Model?.Service?.ServiceId ?? Guid.Empty)" />

                    <div class="d-flex align-items-center gap-3 mb-3">
                        <img src="@GetServiceImage(Model?.ServiceImages)" width="60" height="60"
                             style="object-fit:cover;border-radius:4px;border:1px solid #eee"
                             class="zoomable"
                             onerror="this.onerror=null;this.src='@fallbackImg';" />
                        <div>
                            <div class="fw-bold">@Model?.Service?.Title</div>
                            <small class="text-muted">@Model?.ProviderName</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Chất lượng dịch vụ:</label>
                        <div class="rating" data-target="rating-@Model.BookingId">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="bi bi-star fs-3 text-warning" data-value="@i"></i>
                            }
                        </div>
                        <input type="hidden" name="Rating" id="rating-@Model.BookingId" value="0" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nội dung đánh giá:</label>
                        <textarea name="Comment" class="form-control" rows="3" placeholder="Hãy chia sẻ trải nghiệm của bạn..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Hình ảnh (tối đa 5 ảnh):</label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn-upload-like" onclick="openPicker('file-@Model.BookingId')">
                                <i class="bi bi-camera"></i> Thêm Hình ảnh
                            </button>
                        </div>

                        <!-- KHỚP tên DTO: ImageFiles -->
                        <input id="file-@Model.BookingId"
                               name="ImageFiles"
                               type="file"
                               class="d-none"
                               accept="image/*"
                               multiple
                               onchange="uploaderAddFiles('uploader-@Model.BookingId', this.files, 5)" />

                        <div id="uploader-@Model.BookingId"
                             class="uploader"
                             data-input="file-@Model.BookingId"
                             data-max="5"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Gửi đánh giá</button>
                </div>
            </form>
        </div>
    </div>
</div>
}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Rating
            document.querySelectorAll('.rating').forEach(group => {
                const stars = group.querySelectorAll('i');
                const target = document.getElementById(group.dataset.target);
                if (!target) return;
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const val = parseInt(star.dataset.value, 10);
                        target.value = val;
                        stars.forEach(s => { s.classList.remove('bi-star-fill'); s.classList.add('bi-star'); });
                        for (let i = 0; i < val; i++) {
                            stars[i].classList.remove('bi-star');
                            stars[i].classList.add('bi-star-fill');
                        }
                    });
                });
            });

            // Lightbox ảnh
            const imgModalEl = document.getElementById('imgPreviewModal');
            const imgEl = imgModalEl.querySelector('.modal-img');
            const bsImgModal = new bootstrap.Modal(imgModalEl);
            document.body.addEventListener('click', function (e) {
                const t = e.target;
                if (t && t.tagName === 'IMG' && t.classList.contains('zoomable')) {
                    const src = t.getAttribute('data-full') || t.getAttribute('src') || t.dataset.src;
                    const alt = t.getAttribute('alt') || '';
                    if (src) { imgEl.src = src; imgEl.alt = alt; bsImgModal.show(); }
                }
            });
            imgModalEl.addEventListener('hidden.bs.modal', function () { imgEl.src = ''; imgEl.alt = ''; });
            // Close when clicking outside content or on body area
            imgModalEl.addEventListener('click', function (e) {
              const content = imgModalEl.querySelector('.modal-content');
              if (!content) return;
              if (!content.contains(e.target)) {
                const inst = bootstrap.Modal.getInstance(imgModalEl) || new bootstrap.Modal(imgModalEl);
                inst.hide();
              }
            });
            // Also allow closing when clicking image area (zoom out)
            imgModalEl.querySelector('.modal-body')?.addEventListener('click', function(){
              const inst = bootstrap.Modal.getInstance(imgModalEl) || new bootstrap.Modal(imgModalEl);
              inst.hide();
            });

        });

          // ===== Uploader ảnh (bản chắc chắn) =====
        const uploaderState = new Map();

        function getDT(wrapperId) {
          if (!uploaderState.has(wrapperId)) uploaderState.set(wrapperId, new DataTransfer());
          return uploaderState.get(wrapperId);
        }

        function openPicker(inputId) {
          const inp = document.getElementById(inputId);
          if (inp) inp.click(); // hidden bằng CSS vẫn ok
        }

        // gọi từ input[type=file].onchange
        function uploaderAddFiles(wrapperId, files, max) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;                  // id của input thật
          const realInput = document.getElementById(inputId);  // input sẽ submit cùng form
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const remain = Math.max(0, max - dt.files.length);
          Array.from(files).slice(0, remain).forEach(f => dt.items.add(f));

          // Luôn đồng bộ về input thật
          realInput.files = dt.files;

          renderUploader(wrapperId);
        }

        function uploaderRemove(wrapperId, idx) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;
          const realInput = document.getElementById(inputId);
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const next = new DataTransfer();
          Array.from(dt.files).forEach((f, i) => { if (i !== idx) next.items.add(f); });
          uploaderState.set(wrapperId, next);

          realInput.files = next.files;
          renderUploader(wrapperId);
        }

        function renderUploader(wrapperId) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const max = parseInt(wrap.dataset.max || '5', 10);
          const inputId = wrap.dataset.input;
          const dt = getDT(wrapperId);

          wrap.innerHTML = '';

          Array.from(dt.files).forEach((f, i) => {
            const box = document.createElement('div');
            box.className = 'thumb';
            const img = document.createElement('img');
            img.className = 'zoomable';
            const fr = new FileReader();
            fr.onload = e => img.src = e.target.result;
            fr.readAsDataURL(f);

            const rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'remove';
            rm.innerText = '×';
            rm.onclick = () => uploaderRemove(wrapperId, i);

            box.appendChild(img);
            box.appendChild(rm);
            wrap.appendChild(box);
          });

          const rest = max - dt.files.length;
          if (rest > 0) {
            const add = document.createElement('div');
            add.className = 'slot slot-add';
            add.onclick = () => openPicker(inputId);

            const icon = document.createElement('i');
            icon.className = 'bi bi-camera';
            const counter = document.createElement('span');
            counter.className = 'counter';
            counter.textContent = `${dt.files.length}/${max}`;

            add.appendChild(icon);
            add.appendChild(counter);
            wrap.appendChild(add);

            for (let i = 1; i < rest; i++) {
              const empty = document.createElement('div');
              empty.className = 'slot';
              wrap.appendChild(empty);
            }
          }
        }

        // init preview
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.uploader').forEach(w => renderUploader(w.id));
        });

        // Log trước khi submit để tự kiểm chứng
        document.addEventListener('submit', function (e) {
          const form = e.target.closest('form');
          if (!form) return;
          const inp = form.querySelector('input[name=ImageFiles]');
          if (inp) console.log('[VIEW] files before submit =', inp.files?.length || 0);
        }, true);

        /* ========= TOS Modal ========= */
        async function openTosModal(providerId) {
            const body = document.getElementById('tosModalBody');
            const modalEl = document.getElementById('tosModal');
            if (!body || !modalEl) return;

            body.innerHTML = '<div class="muted">Đang tải điều khoản...</div>';
            
            try {
                const url = '@Url.Action("GetTermsByProvider", "BookingService", new { area = "Customer" })' + '?providerId=' + providerId;
                const res = await fetch(url, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (res.ok) {
                    const html = await res.text();
                    body.innerHTML = html;
                } else {
                    body.innerHTML = '<div style="color:#c00">Không tải được điều khoản từ máy chủ.</div>';
                }
            } catch (err) {
                body.innerHTML = '<div style="color:#c00">Không tải được điều khoản. Vui lòng thử lại.</div>';
            }

            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
        }

        function closeTosModal() {
            const modalEl = document.getElementById('tosModal');
            if (modalEl) {
                const bsModal = bootstrap.Modal.getInstance(modalEl);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }
    </script>
}

<!-- Modal xem ảnh fullscreen -->
<div class="modal fade" id="imgPreviewModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 1200px;">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
            <div class="modal-body p-0 d-flex justify-content-center align-items-center" style="cursor: zoom-out;">
                <div class="position-relative d-inline-block">
                    <img class="modal-img" src="" alt="" style="max-width: 98vw; max-height: 92vh; border-radius: 10px; background: #fff; object-fit: contain;" />
                    <button type="button" class="btn btn-light position-absolute" data-bs-dismiss="modal" aria-label="Close" style="top: 6px; right: 6px; padding: 2px 6px; line-height: 1; border-radius: 6px;">
                        <i class="bi bi-x-lg" style="font-size: .8rem;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Hủy Đơn (chỉ hiển thị khi đơn ở trạng thái Pending) -->
@if (IsPending)
{
    <div class="modal fade" id="cancelModal-@Model.BookingId" tabindex="-1" aria-labelledby="cancelModalLabel-@Model.BookingId" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form asp-area="Customer" asp-controller="BookingService" asp-action="CancelBooking" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="BookingId" value="@Model.BookingId" />

                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelModalLabel-@Model.BookingId">@(ViewBag.SiteName ?? "localhost:7161") cho biết</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Bạn đang hủy đơn hàng. Sau khi hủy, bạn sẽ được hoàn tiền vào tài khoản ngân hàng đã cung cấp.
                        </div>

                        <div class="mb-3">
                            <label for="Reason-@Model.BookingId" class="form-label fw-bold">
                                Lý do hủy đơn <span class="text-danger">*</span>
                            </label>
                            <textarea name="Reason" 
                                      id="Reason-@Model.BookingId" 
                                      class="form-control" 
                                      rows="4" 
                                      placeholder="Vui lòng nêu rõ lý do hủy đơn..."
                                      required></textarea>
                        </div>

                        <hr />

                        <div class="h6 mb-3">Thông tin tài khoản ngân hàng để nhận hoàn tiền</div>

                        <div class="mb-3">
                            <label for="BankAccountNumber-@Model.BookingId" class="form-label">
                                Số tài khoản <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   name="BankAccountNumber" 
                                   id="BankAccountNumber-@Model.BookingId" 
                                   class="form-control" 
                                   placeholder="Nhập số tài khoản ngân hàng"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="BankName-@Model.BookingId" class="form-label">
                                Tên ngân hàng <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   name="BankName" 
                                   id="BankName-@Model.BookingId" 
                                   class="form-control" 
                                   placeholder="Ví dụ: Vietcombank, Vietinbank..."
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="AccountHolderName-@Model.BookingId" class="form-label">
                                Tên chủ tài khoản
                            </label>
                            <input type="text" 
                                   name="AccountHolderName" 
                                   id="AccountHolderName-@Model.BookingId" 
                                   class="form-control" 
                                   placeholder="Tên chủ tài khoản (không bắt buộc)">
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                        <button type="submit" class="btn btn-primary">OK</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

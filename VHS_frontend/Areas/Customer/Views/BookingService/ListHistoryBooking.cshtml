@model VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.ListHistoryBookingServiceDTOs
@{
    ViewData["Title"] = "Lịch sử đơn dịch vụ";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Nhận cấu hình từ Controller (fallback nếu thiếu)
    var statusOrder = (string[])ViewBag.StatusOrder ?? new[] { "All", "Pending", "Confirmed", "InProgress", "Completed", "Cancelled" };
    var statusViMap = ViewBag.StatusViMap as IDictionary<string, string>
                      ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                      {
                          ["Pending"] = "Chờ xác nhận",
                          ["Confirmed"] = "Xác Nhận",
                          ["InProgress"] = "Bắt Đầu Làm Việc",
                          ["Completed"] = "Hoàn thành",
                          ["Cancelled"] = "Đã hủy",
                          ["All"] = "Tất cả"
                      };

    var fallbackImg = Url.Content("~/images/VeSinh.jpg");



}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="~/css/list-histrory-booking.css" rel="stylesheet" />

<div class="container my-3">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            Lịch sử đơn dịch vụ
        </h1>
        <p class="page-subtitle">Quản lý và theo dõi tất cả các đơn dịch vụ của bạn</p>
    </div>
    <!-- Toast kết quả (tuỳ chọn) -->
    @if (TempData["ToastSuccess"] != null || TempData["ToastError"] != null)
    {
        <div class="custom-alert @(TempData["ToastSuccess"] != null ? "alert-success" : "alert-danger")" role="alert">
            <i class="bi @(TempData["ToastSuccess"] != null ? "bi-check-circle-fill" : "bi-exclamation-circle-fill")"></i>
            <div class="alert-content">
                @(TempData["ToastSuccess"] ?? TempData["ToastError"])
            </div>
            <button type="button" class="alert-close" onclick="this.parentElement.remove()">
                <i class="bi bi-x"></i>
            </button>
        </div>
    }

    <!-- Tabs trạng thái (data-status = code EN, text = VI) -->
    <ul class="nav nav-tabs border-0 nav-status">
        @foreach (var code in statusOrder)
        {
            var text = statusViMap.TryGetValue(code, out var vi) ? vi : code;
            <li class="nav-item">
                <a class="nav-link @(code == "All" ? "active" : "")"
                   data-status="@code"
                   href="javascript:void(0)">@text</a>
            </li>
        }
    </ul>

    <!-- Tìm kiếm -->
    <div class="my-3">
        <div class="search-bar d-flex align-items-center gap-2">
            <i class="bi bi-search"></i>
            <input id="q" class="form-control form-control-sm border-0 bg-transparent"
                   placeholder="Bạn có thể tìm kiếm theo tên Shop, ID đơn hàng hoặc Tên Sản phẩm" />
        </div>
    </div>

    <!-- Danh sách đơn -->
    <div id="order-list" class="d-flex flex-column gap-3">
        @foreach (var o in Model.Items)
        {
            // o.Status là EN (Pending/Accepted/InProgress/Completed/Cancelled)
            var price = $"{o.TotalPrice:N0}đ";
            var isDone = string.Equals(o.Status?.Trim(), "Completed", StringComparison.OrdinalIgnoreCase);
            var statusText = statusViMap.TryGetValue(o.Status ?? "", out var viText) ? viText : (o.Status ?? "");
            // Chuẩn hóa code trạng thái về EN để lọc/tô màu nhất quán; chấp nhận cả VI và EN từ backend
            var stRaw = (o.Status ?? "").Trim();
            string stCode = stRaw; // fallback
            if (stRaw.Equals("Pending", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Chờ xác nhận", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Đang chờ xử lý", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Chờ xử lý", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Pending";
                statusText = "Chờ xác nhận";
            }
            else if (stRaw.Equals("Confirmed", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Xác nhận", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Đã xác nhận", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Confirmed";
                statusText = statusViMap["Confirmed"];
            }
            else if (stRaw.Equals("InProgress", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Bắt đầu làm việc", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Đang thực hiện", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "InProgress";
                statusText = statusViMap["InProgress"];
            }
            else if (stRaw.Equals("Completed", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Hoàn thành", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Completed";
                statusText = statusViMap["Completed"];
            }
            else if (stRaw.Equals("Cancelled", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Canceled", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Đã hủy", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Đã huỷ", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Cancelled";
                statusText = statusViMap["Cancelled"];
            }
            var isReviewed = o.HasReview; // đã có review hay chưa

            <div class="shop-row order-card" data-status="@stCode" data-title="@o.ServiceTitle @o.ProviderName">
                <!-- Header -->
                <div class="shop-head">
                    <img src="/images/shop-badge.svg" width="24" height="24" alt="shop" />
                    <div class="shop-name">@o.ProviderName</div>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger ms-2"
                            onclick="window.location.href='@Url.Action("WithProvider", "ChatCustomer", new { area = "Customer", providerId = o.ProviderId })'">
                        <i class="bi bi-chat-dots me-1"></i> Chat
                    </button>
                    <button class="btn btn-sm btn-outline-secondary">Xem Shop</button>

                    <div class="ms-auto d-flex align-items-center gap-3">
                        <div class="status-pill">
                            <i class="bi bi-truck"></i>
                            @(isDone ? "Hoàn thành dịch vụ" : statusText)
                        </div>
                        @if (isDone && !isReviewed)
                        {
                            <a class="text-danger text-decoration-none fw-bold"
                               href="javascript:void(0)"
                               data-bs-toggle="modal"
                               data-bs-target="#reviewModal-@o.BookingId">ĐÁNH GIÁ</a>
                        }
                        else if (isDone && isReviewed)
                        {
                            <span class="text-muted">Đã đánh giá</span>
                        }

                    </div>
                </div>

                @{
                    // TÍNH TOÁN TIỀN
                    var optionTotal = o.Options?.Sum(op => op.Price) ?? 0m;
                    var servicePrice = o.ServicePrice;
                    var subTotal = servicePrice + optionTotal;
                    var voucher = Math.Max(0m, o.VoucherDiscount); // bảo vệ số âm
                    var grand = Math.Max(0m, subTotal - voucher);

                    // Chuỗi hiển thị
                    string toCurrency(decimal v) => v.ToString("N0") + "đ";
                }

                <!-- Body -->
                <div class="item-body">
                    <img class="order-cover"
                         src="@(o.ServiceImages ?? fallbackImg)"
                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                    <div class="flex-grow-1">
                        <div class="order-title">@o.ServiceTitle</div>
                        @if (o.Options?.Any() == true)
                        {
                            <div class="mt-1">
                                @foreach (var opt in o.Options)
                                {
                                    <span class="option-badge" title="@opt.Description">
                                        @opt.OptionName • @opt.Price.ToString("N0") @opt.UnitType
                                    </span>
                                }
                            </div>
                        }
                    </div>

                    <!-- Cột giá bên phải: tóm tắt gọn -->
                    <div class="price-summary">
                        <div class="price-row">
                            <span class="price-label">Giá dịch vụ:</span>
                            <span class="price-value">@toCurrency(servicePrice)</span>
                        </div>
                        @if (optionTotal > 0)
                        {
                            <div class="price-row">
                                <span class="price-label">Tuỳ chọn:</span>
                                <span class="price-value">@toCurrency(optionTotal)</span>
                            </div>
                        }
                        <div class="price-row subtotal">
                            <span class="price-label">Tổng cộng:</span>
                            <span class="price-value">@toCurrency(subTotal)</span>
                        </div>
                        @if (voucher > 0)
                        {
                            <div class="price-row discount">
                                <span class="price-label">Giảm giá:</span>
                                <span class="price-value">-@toCurrency(voucher)</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Tổng tiền -->
                <div class="price-line">
                    <div>Thành tiền: <span class="fw-bold price-now">@toCurrency(grand)</span></div>
                </div>


                <!-- Action -->
                @{
                    var st = stCode; // EN đã chuẩn hóa
                    var actionName =
                    st.Equals("Cancelled", StringComparison.OrdinalIgnoreCase) ? "CanceledDetail" :
                    "HistoryBookingDetail";

                    var detailText =
                    actionName == "CanceledDetail" ? "Xem chi tiết hủy dịch vụ" :
                    "Xem chi tiết";
                }
                <div class="action-line">
                    <a asp-area="Customer"
                       asp-controller="BookingService"
                       asp-action="@actionName"
                       asp-route-id="@o.BookingId"
                       asp-route-status="@stCode"
                       class="btn btn-outline-primary">
                        @detailText
                    </a>

                    @if (isDone) // Completed
                    {
                        <button class="btn btn-danger">Đặt lại</button>
                        <a asp-area="Customer"
                           asp-controller="BookingService"
                           asp-action="ReportService"
                           asp-route-bookingId="@o.BookingId"
                           class="btn btn-outline-danger btn-report">
                            Báo cáo / Hoàn tiền
                        </a>
                        @if (!isReviewed)
                        {
                            <button class="btn btn-outline-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reviewModal-@o.BookingId">
                                Đánh giá
                            </button>
                        }

                    }
                    else if (st.Equals("Pending", StringComparison.OrdinalIgnoreCase))
                    {
                        <button type="button"
                                class="btn btn-outline-secondary"
                                onclick="window.location.href='@Url.Action("WithProvider", "ChatCustomer", new { area = "Customer", providerId = o.ProviderId })'">
                            <i class="bi bi-chat-text me-1"></i> Liên hệ Shop
                        </button>
                        <button class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#cancelModal-@o.BookingId">
                            Hủy đơn
                        </button>
                    }
                    else if (st.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                    {
                        <button class="btn btn-outline-secondary">Lý do hủy</button>
                        <button class="btn btn-danger">Đặt lại</button>
                    }
                </div>

            </div>

    @if (isDone && !isReviewed)
    {
            <!-- Modal Đánh Giá -->
            <div class="modal fade" id="reviewModal-@o.BookingId" tabindex="-1" aria-labelledby="reviewModalLabel-@o.BookingId" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <form asp-area="Customer"
                              asp-controller="ReviewCustomer"
                              asp-action="Create"
                              method="post"
                              enctype="multipart/form-data"
                              onsubmit="
            const inp = this.querySelector('input[name=ImageFiles]');
            console.log('[VIEW] files before submit =', inp?.files?.length || 0);
          ">
                            @Html.AntiForgeryToken()

                            <div class="modal-header">
                                <h5 class="modal-title">Đánh Giá Dịch Vụ</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                <input type="hidden" name="BookingId" value="@o.BookingId" />
                                <input type="hidden" name="ServiceId" value="@o.ServiceId" />
                                <input type="hidden" name="Rating" id="rating-@o.BookingId" value="0" min="1" />

                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <img src="@(o.ServiceImages ?? fallbackImg)" width="60" height="60" style="object-fit:cover;border-radius:4px;border:1px solid #eee" />
                                    <div>
                                        <div class="fw-bold">@o.ServiceTitle</div>
                                        <small class="text-muted">@o.ProviderName</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Chất lượng dịch vụ:</label>
                                    <div class="rating" data-target="rating-@o.BookingId">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star fs-3 text-warning" data-value="@i"></i>
                                        }
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Nội dung đánh giá:</label>
                                    <textarea name="Comment" class="form-control" rows="3" placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Hình ảnh (tối đa 5):</label>
                                    <div class="d-flex gap-2 mb-2">
                                        <button type="button" class="btn-upload-like" onclick="openPicker('file-@o.BookingId')">
                                            <i class="bi bi-camera"></i> Thêm hình ảnh
                                        </button>
                                    </div>
                                    <input id="file-@o.BookingId"
                                           name="ImageFiles"
                                           type="file"
                                           class="d-none"
                                           accept="image/*"
                                           multiple
                                           onchange="uploaderAddFiles('uploader-@o.BookingId', this.files, 5)" />

                                    <div id="uploader-@o.BookingId" class="uploader" data-input="file-@o.BookingId" data-max="5"></div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="submit" class="btn btn-danger">Gửi đánh giá</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            }
            <!-- Modal Hủy Đơn -->
            <div class="modal fade" id="cancelModal-@o.BookingId" tabindex="-1" aria-labelledby="cancelModalLabel-@o.BookingId" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form asp-area="Customer" asp-controller="BookingService" asp-action="CancelBooking" method="post">
                            @Html.AntiForgeryToken()
                            <div class="modal-header">
                                <h5 class="modal-title" id="cancelModalLabel-@o.BookingId">Hủy đơn hàng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                <input type="hidden" name="BookingId" value="@o.BookingId" />
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Lý do hủy <span class="text-danger">*</span></label>
                                    <textarea class="form-control" name="Reason" rows="3" required placeholder="Vui lòng mô tả ngắn gọn lý do hủy..."></textarea>
                                    <div class="form-text">Ví dụ: Đặt nhầm dịch vụ, thay đổi thời gian, tìm được nhà cung cấp khác...</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Tên ngân hàng <span class="text-danger">*</span></label>
                                    <input class="form-control" name="BankName" required placeholder="VD: Vietcombank" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Tên chủ tài khoản <span class="text-danger">*</span></label>
                                    <input class="form-control" name="AccountHolderName" required placeholder="VD: NGUYEN VAN A" />
                                </div>

                                <div class="mb-1">
                                    <label class="form-label fw-bold">Số tài khoản <span class="text-danger">*</span></label>
                                    <input class="form-control" name="BankAccountNumber" required inputmode="numeric" pattern="[0-9]{6,20}" placeholder="Chỉ nhập số, 6–20 ký tự" />
                                </div>
                                <small class="text-muted">Thông tin ngân hàng được dùng để hoàn tiền (nếu áp dụng).</small>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="submit" class="btn btn-danger">Xác nhận hủy</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Tabs filter theo EN code; "All" = tất cả
            const tabs = document.querySelectorAll('.nav-status .nav-link');
            const input = document.getElementById('q');
            const cards = () => Array.from(document.querySelectorAll('.order-card'));

            function applyFilter(statusCode) {
                const q = (input.value || '').toLowerCase();
                cards().forEach(c => {
                    const status = (c.dataset.status || '').trim().toLowerCase();
                    const okStatus = (statusCode === 'All') || (status === statusCode.trim().toLowerCase());
                    const okQuery  = (c.dataset.title || '').toLowerCase().includes(q);
                    c.style.display = (okStatus && okQuery) ? '' : 'none';
                });
            }

            tabs.forEach(t => {
                t.addEventListener('click', () => {
                    document.querySelector('.nav-status .nav-link.active')?.classList.remove('active');
                    t.classList.add('active');
                    applyFilter(t.dataset.status);
                });
            });

            input.addEventListener('input', () => {
                const active = document.querySelector('.nav-status .nav-link.active')?.dataset.status || 'All';
                applyFilter(active);
            });

            // Rating
            document.querySelectorAll('.rating').forEach(group => {
                const stars = group.querySelectorAll('i');
                const target = document.getElementById(group.dataset.target);
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const val = star.dataset.value;
                        target.value = val;
                        stars.forEach(s => { s.classList.remove('bi-star-fill'); s.classList.add('bi-star'); });
                        for (let i = 0; i < val; i++) {
                            stars[i].classList.remove('bi-star');
                            stars[i].classList.add('bi-star-fill');
                        }
                    });
                });
            });
        });

           // === Uploader ảnh (bản chắc chắn) ===
        const uploaderState = new Map();

        function getDT(wrapperId) {
          if (!uploaderState.has(wrapperId)) uploaderState.set(wrapperId, new DataTransfer());
          return uploaderState.get(wrapperId);
        }

        function openPicker(inputId) {
          const inp = document.getElementById(inputId);
          if (!inp) return;
          inp.click(); // ẩn bằng CSS vẫn click được
        }

        // Gọi từ input[type=file].onchange
        function uploaderAddFiles(wrapperId, files, max) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;                 // id của input thật
          const realInput = document.getElementById(inputId); // input sẽ submit cùng form
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const remain = Math.max(0, max - dt.files.length);
          Array.from(files).slice(0, remain).forEach(f => dt.items.add(f));

          // QUAN TRỌNG: luôn gán về input thật
          realInput.files = dt.files;

          renderUploader(wrapperId);
        }

        function uploaderRemove(wrapperId, idx) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;
          const realInput = document.getElementById(inputId);
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const next = new DataTransfer();
          Array.from(dt.files).forEach((f, i) => { if (i !== idx) next.items.add(f); });
          uploaderState.set(wrapperId, next);

          // Đồng bộ lại vào input thật
          realInput.files = next.files;

          renderUploader(wrapperId);
        }

        function renderUploader(wrapperId) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const max = parseInt(wrap.dataset.max || '5', 10);
          const inputId = wrap.dataset.input;
          const dt = getDT(wrapperId);

          wrap.innerHTML = '';

          Array.from(dt.files).forEach((f, i) => {
            const box = document.createElement('div');
            box.className = 'thumb';
            const img = document.createElement('img');
            const fr = new FileReader();
            fr.onload = e => img.src = e.target.result;
            fr.readAsDataURL(f);

            const rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'remove';
            rm.innerText = '×';
            rm.onclick = () => uploaderRemove(wrapperId, i);

            box.appendChild(img);
            box.appendChild(rm);
            wrap.appendChild(box);
          });

          const rest = max - dt.files.length;
          if (rest > 0) {
            const add = document.createElement('div');
            add.className = 'slot slot-add';
            add.onclick = () => openPicker(inputId);

            const icon = document.createElement('i');
            icon.className = 'bi bi-camera';
            add.appendChild(icon);

            const counter = document.createElement('span');
            counter.className = 'counter';
            counter.textContent = `${dt.files.length}/${max}`;
            add.appendChild(counter);

            wrap.appendChild(add);

            for (let i = 1; i < rest; i++) {
              const empty = document.createElement('div');
              empty.className = 'slot';
              wrap.appendChild(empty);
            }
          }
        }

        // Khởi tạo preview cho tất cả uploader
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.uploader').forEach(w => renderUploader(w.id));
        });

        // Log trước khi submit để tự kiểm chứng
        document.addEventListener('submit', function (e) {
          const form = e.target.closest('form');
          if (!form) return;
          const inp = form.querySelector('input[name=ImageFiles]');
          if (inp) console.log('[VIEW] files before submit =', inp.files?.length || 0);
        }, true);
    </script>
}

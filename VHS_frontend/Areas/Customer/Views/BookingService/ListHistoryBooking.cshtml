@model VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.ListHistoryBookingServiceDTOs
@{
    ViewData["Title"] = "Lịch sử đơn dịch vụ";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Nhận cấu hình từ Controller (fallback nếu thiếu)
    var statusOrder = (string[])ViewBag.StatusOrder ?? new[] { "All", "Pending", "Confirmed", "InProgress", "Completed", "Cancelled" };
    var statusViMap = ViewBag.StatusViMap as IDictionary<string, string>
                      ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                      {
                        ["All"] = "Tất cả",
                          ["Pending"] = "Chờ xác nhận",
                          ["Confirmed"] = "Xác Nhận",
                          ["InProgress"] = "Bắt Đầu Làm Việc",
                          ["Completed"] = "Hoàn thành",
                          ["Cancelled"] = "Đã hủy"
                      };

    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    // Helper để lấy ảnh đầu tiên từ ServiceImages (có thể là JSON array hoặc comma-separated string)
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            // Thử parse JSON array trước
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        // Nếu không phải JSON, thử split bằng dấu phẩy
        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        
        // Nếu không có dấu phẩy, trả về nguyên chuỗi
        return images;
    }

    // Helper để lấy ảnh service (backend đã thêm domain prefix)
    string GetServiceImage(string? serviceImages)
    {
        if (string.IsNullOrWhiteSpace(serviceImages))
            return fallbackImg;
        
        var img = FirstImageOrDefault(serviceImages);
        return !string.IsNullOrWhiteSpace(img) ? img : fallbackImg;
    }

    // Helper để lấy logo provider (backend đã thêm domain prefix, giống ServiceShop/Index.cshtml)
    string GetProviderLogo(string? providerImages)
    {
        if (string.IsNullOrWhiteSpace(providerImages))
            return "/images/VeSinh.jpg"; // Fallback logo
        
        var logo = FirstImageOrDefault(providerImages);
        return !string.IsNullOrWhiteSpace(logo) ? logo : "/images/VeSinh.jpg";
    }

}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="~/css/list-histrory-booking.css" rel="stylesheet" />

<div class="container my-3">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <span class="page-title-icon">📦</span>
            Lịch sử đơn dịch vụ
        </h1>
        <p class="page-subtitle">Quản lý và theo dõi tất cả các đơn dịch vụ của bạn</p>
    </div>

    <!-- Tabs trạng thái (data-status = code EN, text = VI) -->
    <ul class="nav nav-tabs border-0 nav-status">
        @foreach (var code in statusOrder)
        {
            var text = statusViMap.TryGetValue(code, out var vi) ? vi : code;
            <li class="nav-item">
                <a class="nav-link @(code == "All" ? "active" : "")"
                   data-status="@code"
                   href="javascript:void(0)">@text</a>
            </li>
        }
    </ul>

    <!-- Tìm kiếm -->
    <div class="my-3">
        <div class="search-bar d-flex align-items-center gap-2">
            <i class="bi bi-search"></i>
            <input id="q" class="form-control form-control-sm border-0 bg-transparent"
                   placeholder="Bạn có thể tìm kiếm theo tên Shop, ID đơn hàng hoặc Tên Sản phẩm" />
        </div>
    </div>

    <!-- Danh sách đơn -->
    <div id="order-list" class="d-flex flex-column gap-3">
        @foreach (var o in Model.Items)
        {
            // o.Status là EN (Pending/Accepted/InProgress/Completed/Cancelled)
            var price = $"{o.TotalPrice:N0}đ";
            var isDone = string.Equals(o.Status?.Trim(), "Completed", StringComparison.OrdinalIgnoreCase);
            var statusText = statusViMap.TryGetValue(o.Status ?? "", out var viText) ? viText : (o.Status ?? "");
            // Chuẩn hóa code trạng thái về EN để lọc/tô màu nhất quán; chấp nhận cả VI và EN từ backend
            var stRaw = (o.Status ?? "").Trim();
            string stCode = stRaw; // fallback
            
            // Kiểm tra Cancelled/Canceled TRƯỚC để đảm bảo bắt được tất cả các biến thể
            if (stRaw.Equals("Cancelled", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Canceled", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Đã hủy", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Đã huỷ", StringComparison.OrdinalIgnoreCase)
                || stRaw.Contains("hủy", StringComparison.OrdinalIgnoreCase)
                || stRaw.Contains("huy", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Cancelled";
                statusText = statusViMap["Cancelled"];
            }
            else if (stRaw.Equals("Pending", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Chờ xác nhận", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Đang chờ xử lý", StringComparison.OrdinalIgnoreCase)
                || stRaw.Equals("Chờ xử lý", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Pending";
                statusText = "Chờ xác nhận";
            }
            else if (stRaw.Equals("Confirmed", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Xác nhận", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Đã xác nhận", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Confirmed";
                statusText = statusViMap["Confirmed"];
            }
            else if (stRaw.Equals("InProgress", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Bắt đầu làm việc", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Đang thực hiện", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "InProgress";
                statusText = statusViMap["InProgress"];
            }
            else if (stRaw.Equals("Completed", StringComparison.OrdinalIgnoreCase)
                     || stRaw.Equals("Hoàn thành", StringComparison.OrdinalIgnoreCase))
            {
                stCode = "Completed";
                statusText = statusViMap["Completed"];
            }
            var isReviewed = o.HasReview; // đã có review hay chưa

            <div class="shop-row order-card" data-status="@stCode" data-title="@o.ServiceTitle @o.ProviderName">
                <!-- Header -->
                <div class="shop-head">
                    <img src="@GetProviderLogo(o.ProviderImages)" width="24" height="24" alt="@o.ProviderName" class="shop-logo" style="object-fit:cover;border-radius:4px;" onerror="this.src='/images/VeSinh.jpg';" />
                    <div class="shop-name">@o.ProviderName</div>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger ms-2"
                            onclick="window.location.href='@Url.Action("WithProvider", "ChatCustomer", new { area = "Customer", providerId = o.ProviderId })'">
                        <i class="bi bi-chat-dots me-1"></i> Chat
                    </button>
                    <a asp-area="" asp-controller="ServiceShop" asp-action="Index" asp-route-providerId="@o.ProviderId" class="btn btn-sm btn-outline-secondary">Xem Shop</a>

                    <div class="ms-auto d-flex align-items-center gap-3">
                        <div class="status-pill">
                            <i class="bi bi-truck"></i>
                            @(isDone ? "Hoàn thành dịch vụ" : statusText)
                        </div>
                        @if (isDone && !isReviewed)
                        {
                            <a class="text-danger text-decoration-none fw-bold"
                               href="javascript:void(0)"
                               data-bs-toggle="modal"
                               data-bs-target="#reviewModal-@o.BookingId">ĐÁNH GIÁ</a>
                        }
                        else if (isDone && isReviewed)
                        {
                            <span class="text-muted">Đã đánh giá</span>
                        }

                    </div>
                </div>

                @{
                    // TÍNH TOÁN TIỀN
                    var optionTotal = o.Options?.Sum(op => op.Price) ?? 0m;
                    var servicePrice = o.ServicePrice;
                    var subTotal = servicePrice + optionTotal;
                    var voucher = Math.Max(0m, o.VoucherDiscount); // bảo vệ số âm
                    var grand = Math.Max(0m, subTotal - voucher);

                    // Chuỗi hiển thị
                    string toCurrency(decimal v) => v.ToString("N0") + "đ";
                }

                <!-- Body -->
                <div class="item-body">
                    <img class="order-cover"
                         src="@GetServiceImage(o.ServiceImages)"
                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                    <div class="flex-grow-1">
                        <div class="order-title">@o.ServiceTitle</div>
                        @if (o.Options?.Any() == true)
                        {
                            <div class="mt-1">
                                @foreach (var opt in o.Options)
                                {
                                    <span class="option-badge" title="@opt.Description">
                                        @opt.OptionName • @opt.Price.ToString("N0") @opt.UnitType
                                    </span>
                                }
                            </div>
                        }
                    </div>

                    <!-- Cột giá bên phải: tóm tắt gọn -->
                    <div class="price-summary">
                        <div class="price-row">
                            <span class="price-label">Giá dịch vụ:</span>
                            <span class="price-value">@toCurrency(servicePrice)</span>
                        </div>
                        @if (optionTotal > 0)
                        {
                            <div class="price-row">
                                <span class="price-label">Tuỳ chọn:</span>
                                <span class="price-value">@toCurrency(optionTotal)</span>
                            </div>
                        }
                        <div class="price-row subtotal">
                            <span class="price-label">Tổng cộng:</span>
                            <span class="price-value">@toCurrency(subTotal)</span>
                        </div>
                        @if (voucher > 0)
                        {
                            <div class="price-row discount">
                                <span class="price-label">Giảm giá:</span>
                                <span class="price-value">-@toCurrency(voucher)</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Tổng tiền -->
                <div class="price-line">
                    <div>Thành tiền: <span class="fw-bold price-now">@toCurrency(grand)</span></div>
                </div>


                <!-- Action -->
                @{
                    var st = stCode; // EN đã chuẩn hóa
                    var actionName =
                    st.Equals("Cancelled", StringComparison.OrdinalIgnoreCase) ? "CanceledDetail" :
                    "HistoryBookingDetail";

                    var detailText =
                    actionName == "CanceledDetail" ? "Xem chi tiết hủy dịch vụ" :
                    "Xem chi tiết";
                }
                <div class="action-line">
                    <a asp-area="Customer"
                       asp-controller="BookingService"
                       asp-action="@actionName"
                       asp-route-id="@o.BookingId"
                       asp-route-status="@stCode"
                       class="btn btn-outline-primary">
                        @detailText
                    </a>

                    @if (isDone) // Completed
                    {
                        <form asp-area="Customer" asp-controller="BookingService" asp-action="ReorderBooking" method="post" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="bookingId" value="@o.BookingId" />
                            <input type="hidden" name="serviceId" value="@o.ServiceId" />
                            @if (o.Options?.Any() == true)
                            {
                                @foreach (var opt in o.Options)
                                {
                                    <input type="hidden" name="optionIds" value="@opt.OptionId" />
                                }
                            }
                            <button type="submit" class="btn btn-danger">Đặt lại</button>
                        </form>
                        <a asp-area="Customer"
                           asp-controller="BookingService"
                           asp-action="ReportService"
                           asp-route-bookingId="@o.BookingId"
                           class="btn btn-outline-danger btn-report">
                            Báo cáo
                        </a>
                        @if (!isReviewed)
                        {
                            <button class="btn btn-outline-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reviewModal-@o.BookingId">
                                Đánh giá
                            </button>
                        }

                    }
                    else if (st.Equals("Pending", StringComparison.OrdinalIgnoreCase))
                    {
                        <button type="button"
                                class="btn btn-outline-secondary"
                                onclick="window.location.href='@Url.Action("WithProvider", "ChatCustomer", new { area = "Customer", providerId = o.ProviderId })'">
                            <i class="bi bi-chat-text me-1"></i> Liên hệ Shop
                        </button>
                        <button class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#cancelModal-@o.BookingId">
                            Hủy đơn
                        </button>
                    }
                    else if (st.Equals("Cancelled", StringComparison.OrdinalIgnoreCase))
                    {
                        <form asp-area="Customer" asp-controller="BookingService" asp-action="ReorderBooking" method="post" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="bookingId" value="@o.BookingId" />
                            <input type="hidden" name="serviceId" value="@o.ServiceId" />
                            @if (o.Options?.Any() == true)
                            {
                                @foreach (var opt in o.Options)
                                {
                                    <input type="hidden" name="optionIds" value="@opt.OptionId" />
                                }
                            }
                            <button type="submit" class="btn btn-danger">Đặt lại</button>
                        </form>
                    }
                </div>

            </div>

    @if (isDone && !isReviewed)
    {
            <!-- Modal Đánh Giá -->
            <div class="modal fade" id="reviewModal-@o.BookingId" tabindex="-1" aria-labelledby="reviewModalLabel-@o.BookingId" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-lg review-modal">
                    <div class="modal-content">
                        <form asp-area="Customer"
                              asp-controller="ReviewCustomer"
                              asp-action="Create"
                              method="post"
                              enctype="multipart/form-data"
                              novalidate
                              onsubmit="
            const inp = this.querySelector('input[name=ImageFiles]');
            console.log('[VIEW] files before submit =', inp?.files?.length || 0);
          ">
                            @Html.AntiForgeryToken()

                            <div class="modal-header border-bottom">
                                <h5 class="modal-title d-flex align-items-center gap-2">
                                    <i class="bi bi-star-fill text-warning"></i>
                                    Đánh Giá Dịch Vụ
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                            </div>

                            <div class="modal-body p-4">
                                <input type="hidden" name="BookingId" value="@o.BookingId" />
                                <input type="hidden" name="ServiceId" value="@o.ServiceId" />
                                <input type="hidden" name="Rating" id="rating-@o.BookingId" value="0" min="1" />

                                <!-- Thông tin dịch vụ -->
                                <div class="service-info-card mb-4">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="service-image-wrapper">
                                            <img src="@GetServiceImage(o.ServiceImages)" alt="@o.ServiceTitle" class="service-image" />
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-2">@o.ServiceTitle</h6>
                                            <div class="text-muted d-flex align-items-center gap-2">
                                                <i class="bi bi-shop text-primary"></i>
                                                <span class="small">@o.ProviderName</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Đánh giá sao -->
                                <div class="rating-section mb-4">
                                    <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <span>Chất lượng dịch vụ</span>
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="rating-container">
                                        <div class="rating d-flex gap-3 justify-content-center" data-target="rating-@o.BookingId">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                                <i class="bi bi-star rating-star" data-value="@i"></i>
                                            }
                                        </div>
                                        <div class="rating-text text-center mt-2 text-muted small" id="ratingError-@o.BookingId" style="display: none;">
                                            <i class="bi bi-exclamation-circle text-danger"></i> <span class="text-danger">Vui lòng chọn số sao đánh giá</span>
                                        </div>
                                        <div class="rating-text text-center mt-2 text-muted small" id="ratingHint-@o.BookingId">
                                            <i class="bi bi-info-circle"></i> Vui lòng chọn số sao đánh giá
                                        </div>
                                    </div>
                                </div>

                                <!-- Nội dung đánh giá -->
                                <div class="comment-section mb-4">
                                    <label class="form-label fw-bold d-flex align-items-center gap-2 mb-2">
                                        <i class="bi bi-chat-left-text-fill text-primary"></i>
                                        <span>Nội dung đánh giá</span>
                                    </label>
                                    <textarea name="Comment" class="form-control form-control-lg" rows="5" placeholder="Chia sẻ trải nghiệm của bạn về dịch vụ này..."></textarea>
                                    <div class="invalid-feedback d-none" id="commentError-@o.BookingId">
                                        <i class="bi bi-exclamation-circle me-1"></i>
                                        <span></span>
                                    </div>
                                    <div class="form-text mt-2 d-flex align-items-start gap-2">
                                        <i class="bi bi-lightbulb-fill text-warning mt-1"></i>
                                        <span>Đánh giá chi tiết sẽ giúp người khác hiểu rõ hơn về dịch vụ</span>
                                    </div>
                                </div>

                                <!-- Hình ảnh -->
                                <div class="image-section">
                                    <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3">
                                        <i class="bi bi-images text-primary"></i>
                                        <span>Hình ảnh</span>
                                        <span class="badge bg-secondary">Tối đa 5</span>
                                    </label>
                                    <div class="d-flex gap-2 mb-3">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPicker('file-@o.BookingId')">
                                            <i class="bi bi-camera-fill me-1"></i> Thêm hình ảnh
                                        </button>
                                    </div>
                                    <input id="file-@o.BookingId"
                                           name="ImageFiles"
                                           type="file"
                                           class="d-none"
                                           accept="image/*"
                                           multiple
                                           onchange="uploaderAddFiles('uploader-@o.BookingId', this.files, 5)" />

                                    <div id="uploader-@o.BookingId" class="uploader" data-input="file-@o.BookingId" data-max="5"></div>
                                    <div class="form-text mt-2 d-flex align-items-start gap-2">
                                        <i class="bi bi-image-fill text-info mt-1"></i>
                                        <span>Bạn có thể thêm tối đa 5 hình ảnh để minh họa cho đánh giá</span>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer border-top justify-content-center gap-3">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i> Hủy
                                </button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-send me-1"></i> Gửi đánh giá
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            }
            <!-- Modal Hủy Đơn -->
            <div class="modal fade" id="cancelModal-@o.BookingId" tabindex="-1" aria-labelledby="cancelModalLabel-@o.BookingId" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable modal-lg cancel-order-modal">
                    <div class="modal-content">
                        <form asp-area="Customer" asp-controller="BookingService" asp-action="CancelBooking" method="post" novalidate>
                            @Html.AntiForgeryToken()
                            <div class="modal-header border-bottom">
                                <h5 class="modal-title d-flex align-items-center gap-2" id="cancelModalLabel-@o.BookingId">
                                    <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                    Hủy đơn hàng
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                            </div>

                            <div class="modal-body p-4">
                                <input type="hidden" name="BookingId" value="@o.BookingId" />
                                
                                <!-- Thông báo -->
                                <div class="alert alert-warning d-flex align-items-start gap-3 mb-4 cancel-warning-alert" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill fs-4 mt-1"></i>
                                    <div>
                                        <strong class="d-block mb-1">Lưu ý quan trọng</strong>
                                        <span>Việc hủy đơn có thể ảnh hưởng đến quá trình hoàn tiền. Vui lòng điền đầy đủ thông tin ngân hàng để nhận hoàn tiền (nếu áp dụng).</span>
                                    </div>
                                </div>

                                <!-- Lý do hủy -->
                                <div class="cancel-reason-section mb-4">
                                    <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3">
                                        <i class="bi bi-chat-left-text-fill text-danger"></i>
                                        <span>Lý do hủy</span>
                                        <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control form-control-lg" name="Reason" rows="5" placeholder="Vui lòng mô tả ngắn gọn lý do hủy đơn hàng của bạn..."></textarea>
                                    <div class="invalid-feedback d-none" id="reasonError-@o.BookingId">
                                        <i class="bi bi-exclamation-circle me-1"></i>
                                        <span></span>
                                    </div>
                                    <div class="form-text mt-2 d-flex align-items-start gap-2">
                                        <i class="bi bi-lightbulb-fill text-warning mt-1"></i>
                                        <span>Ví dụ: Đặt nhầm dịch vụ, thay đổi thời gian, tìm được nhà cung cấp khác...</span>
                                    </div>
                                </div>

                                <!-- Thông tin ngân hàng -->
                                <div class="bank-info-section border-top pt-4">
                                    <div class="d-flex align-items-center gap-2 mb-4">
                                        <div class="bank-icon-wrapper">
                                            <i class="bi bi-bank2 text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-0">Thông tin ngân hàng để hoàn tiền</h6>
                                            <small class="text-muted">Điền đầy đủ để nhận hoàn tiền (nếu áp dụng)</small>
                                        </div>
                                </div>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold d-flex align-items-center gap-2">
                                                <i class="bi bi-building text-primary"></i>
                                                <span>Tên ngân hàng</span>
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input class="form-control" name="BankName" placeholder="VD: Vietcombank, Techcombank, BIDV..." />
                                            <div class="invalid-feedback d-none" id="bankNameError-@o.BookingId">
                                                <i class="bi bi-exclamation-circle me-1"></i>
                                                <span></span>
                                            </div>
                                </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold d-flex align-items-center gap-2">
                                                <i class="bi bi-person-badge text-primary"></i>
                                                <span>Tên chủ tài khoản</span>
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input class="form-control text-uppercase" name="AccountHolderName" placeholder="VD: NGUYEN VAN A" />
                                            <div class="invalid-feedback d-none" id="accountHolderError-@o.BookingId">
                                                <i class="bi bi-exclamation-circle me-1"></i>
                                                <span></span>
                                            </div>
                                </div>

                                        <div class="col-12">
                                            <label class="form-label fw-semibold d-flex align-items-center gap-2">
                                                <i class="bi bi-credit-card text-primary"></i>
                                                <span>Số tài khoản</span>
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input class="form-control" name="BankAccountNumber" inputmode="numeric" placeholder="Chỉ nhập số, từ 6–20 ký tự" />
                                            <div class="invalid-feedback d-none" id="accountNumberError-@o.BookingId">
                                                <i class="bi bi-exclamation-circle me-1"></i>
                                                <span></span>
                                            </div>
                                            <div class="form-text mt-2 d-flex align-items-start gap-2">
                                                <i class="bi bi-shield-check-fill text-success mt-1"></i>
                                                <span>Thông tin ngân hàng được bảo mật và chỉ dùng để hoàn tiền (nếu áp dụng).</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer border-top justify-content-center gap-3">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i> Đóng
                                </button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-check-circle me-1"></i> Xác nhận hủy
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Tabs filter theo EN code; "All" = tất cả
            const tabs = document.querySelectorAll('.nav-status .nav-link');
            const input = document.getElementById('q');
            const cards = () => Array.from(document.querySelectorAll('.order-card'));

            function applyFilter(statusCode) {
                const q = (input.value || '').toLowerCase();
                const targetStatus = (statusCode || '').trim().toLowerCase();
                
                cards().forEach(c => {
                    const status = (c.dataset.status || '').trim().toLowerCase();
                    // Debug log để kiểm tra
                    // console.log('Card status:', status, 'Target:', targetStatus, 'Match:', status === targetStatus || targetStatus === 'all');
                    
                    const okStatus = (targetStatus === 'all') || (status === targetStatus);
                    const okQuery  = (c.dataset.title || '').toLowerCase().includes(q);
                    c.style.display = (okStatus && okQuery) ? '' : 'none';
                });
            }

            tabs.forEach(t => {
                t.addEventListener('click', () => {
                    document.querySelector('.nav-status .nav-link.active')?.classList.remove('active');
                    t.classList.add('active');
                    applyFilter(t.dataset.status);
                });
            });

            input.addEventListener('input', () => {
                const active = document.querySelector('.nav-status .nav-link.active')?.dataset.status || 'All';
                applyFilter(active);
            });

            // Rating
            document.querySelectorAll('.rating').forEach(group => {
                const stars = group.querySelectorAll('i');
                const target = document.getElementById(group.dataset.target);
                const bookingId = target.id.replace('rating-', '');
                const ratingError = document.getElementById(`ratingError-${bookingId}`);
                const ratingHint = document.getElementById(`ratingHint-${bookingId}`);
                
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const val = star.dataset.value;
                        target.value = val;
                        stars.forEach(s => { s.classList.remove('bi-star-fill'); s.classList.add('bi-star'); });
                        for (let i = 0; i < val; i++) {
                            stars[i].classList.remove('bi-star');
                            stars[i].classList.add('bi-star-fill');
                        }
                        // Ẩn error khi chọn rating
                        if (ratingError) ratingError.style.display = 'none';
                        if (ratingHint) ratingHint.style.display = 'block';
                    });
                });
            });
            
            // Validation cho form đánh giá
            document.querySelectorAll('form[action*="ReviewCustomer/Create"]').forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Ngăn submit mặc định
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                    let hasError = false;
                    
                    // Validate rating
                    const ratingInput = form.querySelector('input[name="Rating"]');
                    const ratingValue = parseInt(ratingInput?.value || '0', 10);
                    const ratingError = document.getElementById(`ratingError-${bookingId}`);
                    const ratingHint = document.getElementById(`ratingHint-${bookingId}`);
                    
                    if (!ratingValue || ratingValue < 1 || ratingValue > 5) {
                        hasError = true;
                        if (ratingError) ratingError.style.display = 'block';
                        if (ratingHint) ratingHint.style.display = 'none';
                    } else {
                        if (ratingError) ratingError.style.display = 'none';
                        if (ratingHint) ratingHint.style.display = 'block';
                    }
                    
                    // Validate comment
                    const comment = form.querySelector('textarea[name="Comment"]')?.value?.trim();
                    const commentError = document.getElementById(`commentError-${bookingId}`);
                    const commentTextarea = form.querySelector('textarea[name="Comment"]');
                    
                    if (!comment || comment.length < 10) {
                        hasError = true;
                        if (commentTextarea) {
                            commentTextarea.classList.add('is-invalid');
                        }
                        if (commentError) {
                            commentError.querySelector('span').textContent = comment ? 'Nội dung đánh giá phải có ít nhất 10 ký tự.' : 'Vui lòng nhập nội dung đánh giá.';
                            commentError.classList.remove('d-none');
                        }
                    } else {
                        if (commentTextarea) {
                            commentTextarea.classList.remove('is-invalid');
                        }
                        if (commentError) {
                            commentError.classList.add('d-none');
                        }
                    }
                    
                    // Nếu có lỗi, scroll đến phần đầu tiên có lỗi
                    if (hasError) {
                        const firstError = form.querySelector('.is-invalid') || ratingError;
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            if (firstError.tagName === 'TEXTAREA') {
                                firstError.focus();
                            }
                        }
                        return false;
                    }
                    
                    // Nếu không có lỗi, submit form
                    form.submit();
                });
                
                // Clear error khi user nhập comment
                const commentTextarea = form.querySelector('textarea[name="Comment"]');
                if (commentTextarea) {
                    commentTextarea.addEventListener('input', function() {
                        if (this.classList.contains('is-invalid')) {
                            this.classList.remove('is-invalid');
                            const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                            const commentError = document.getElementById(`commentError-${bookingId}`);
                            if (commentError) {
                                commentError.classList.add('d-none');
                            }
                        }
                    });
                }
            });
        });

           // === Uploader ảnh (bản chắc chắn) ===
        const uploaderState = new Map();

        function getDT(wrapperId) {
          if (!uploaderState.has(wrapperId)) uploaderState.set(wrapperId, new DataTransfer());
          return uploaderState.get(wrapperId);
        }

        function openPicker(inputId) {
          const inp = document.getElementById(inputId);
          if (!inp) return;
          inp.click(); // ẩn bằng CSS vẫn click được
        }

        // Gọi từ input[type=file].onchange
        function uploaderAddFiles(wrapperId, files, max) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;                 // id của input thật
          const realInput = document.getElementById(inputId); // input sẽ submit cùng form
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const remain = Math.max(0, max - dt.files.length);
          Array.from(files).slice(0, remain).forEach(f => dt.items.add(f));

          // QUAN TRỌNG: luôn gán về input thật
          realInput.files = dt.files;

          renderUploader(wrapperId);
        }

        function uploaderRemove(wrapperId, idx) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const inputId = wrap.dataset.input;
          const realInput = document.getElementById(inputId);
          if (!realInput) return;

          const dt = getDT(wrapperId);
          const next = new DataTransfer();
          Array.from(dt.files).forEach((f, i) => { if (i !== idx) next.items.add(f); });
          uploaderState.set(wrapperId, next);

          // Đồng bộ lại vào input thật
          realInput.files = next.files;

          renderUploader(wrapperId);
        }

        function renderUploader(wrapperId) {
          const wrap = document.getElementById(wrapperId);
          if (!wrap) return;

          const max = parseInt(wrap.dataset.max || '5', 10);
          const inputId = wrap.dataset.input;
          const dt = getDT(wrapperId);

          wrap.innerHTML = '';

          Array.from(dt.files).forEach((f, i) => {
            const box = document.createElement('div');
            box.className = 'thumb';
            const img = document.createElement('img');
            const fr = new FileReader();
            fr.onload = e => img.src = e.target.result;
            fr.readAsDataURL(f);

            const rm = document.createElement('button');
            rm.type = 'button';
            rm.className = 'remove';
            rm.innerText = '×';
            rm.onclick = () => uploaderRemove(wrapperId, i);

            box.appendChild(img);
            box.appendChild(rm);
            wrap.appendChild(box);
          });

          const rest = max - dt.files.length;
          if (rest > 0) {
            const add = document.createElement('div');
            add.className = 'slot slot-add';
            add.onclick = () => openPicker(inputId);

            const icon = document.createElement('i');
            icon.className = 'bi bi-camera';
            add.appendChild(icon);

            const counter = document.createElement('span');
            counter.className = 'counter';
            counter.textContent = `${dt.files.length}/${max}`;
            add.appendChild(counter);

            wrap.appendChild(add);

            for (let i = 1; i < rest; i++) {
              const empty = document.createElement('div');
              empty.className = 'slot';
              wrap.appendChild(empty);
            }
          }
        }

        // Khởi tạo preview cho tất cả uploader
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.uploader').forEach(w => renderUploader(w.id));
        });

        // Log trước khi submit để tự kiểm chứng
        document.addEventListener('submit', function (e) {
          const form = e.target.closest('form');
          if (!form) return;
          const inp = form.querySelector('input[name=ImageFiles]');
          if (inp) console.log('[VIEW] files before submit =', inp.files?.length || 0);
        }, true);

        // Validation cho form hủy đơn - hiển thị lỗi dưới từng field
        document.querySelectorAll('form[action*="CancelBooking"]').forEach(form => {
            // Clear errors khi modal được mở
            const modalId = form.closest('.modal')?.id;
            if (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('show.bs.modal', function() {
                        // Clear tất cả errors khi mở modal
                        form.querySelectorAll('.is-invalid').forEach(field => {
                            field.classList.remove('is-invalid');
                        });
                        form.querySelectorAll('.invalid-feedback').forEach(errorDiv => {
                            errorDiv.classList.add('d-none');
                        });
                    });
                }
            }
            
            // Lưu timeout IDs để có thể clear (scope ngoài submit handler)
            const errorTimeouts = {};
            
            form.addEventListener('submit', function(e) {
                // Ngăn submit mặc định ngay từ đầu
                e.preventDefault();
                e.stopPropagation();
                
                const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                let hasError = false;
                
                // Helper function để hiển thị/ẩn lỗi
                function showError(fieldName, errorId, message) {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    const errorDiv = document.getElementById(`${errorId}-${bookingId}`);
                    
                    if (field && errorDiv) {
                        // Clear timeout cũ nếu có
                        if (errorTimeouts[errorId]) {
                            clearTimeout(errorTimeouts[errorId]);
                            delete errorTimeouts[errorId];
                        }
                        
                        if (message) {
                            field.classList.add('is-invalid');
                            errorDiv.querySelector('span').textContent = message;
                            errorDiv.classList.remove('d-none');
                            hasError = true;
                            
                            // Tự động ẩn sau 5 giây
                            errorTimeouts[errorId] = setTimeout(() => {
                                field.classList.remove('is-invalid');
                                errorDiv.classList.add('d-none');
                                delete errorTimeouts[errorId];
                            }, 5000);
                        } else {
                            field.classList.remove('is-invalid');
                            errorDiv.classList.add('d-none');
                            // Clear timeout nếu đang có
                            if (errorTimeouts[errorId]) {
                                clearTimeout(errorTimeouts[errorId]);
                                delete errorTimeouts[errorId];
                            }
                        }
                    }
                }
                
                // Validate từng field
                const reason = form.querySelector('textarea[name="Reason"]')?.value?.trim();
                const bankName = form.querySelector('input[name="BankName"]')?.value?.trim();
                const accountHolder = form.querySelector('input[name="AccountHolderName"]')?.value?.trim();
                const accountNumber = form.querySelector('input[name="BankAccountNumber"]')?.value?.trim();
                
                // Clear all errors first
                showError('Reason', 'reasonError', '');
                showError('BankName', 'bankNameError', '');
                showError('AccountHolderName', 'accountHolderError', '');
                showError('BankAccountNumber', 'accountNumberError', '');
                
                // Validate và hiển thị lỗi
                if (!reason) {
                    showError('Reason', 'reasonError', 'Vui lòng nhập lý do hủy đơn hàng.');
                }
                
                if (!bankName) {
                    showError('BankName', 'bankNameError', 'Vui lòng nhập tên ngân hàng.');
                }
                
                if (!accountHolder) {
                    showError('AccountHolderName', 'accountHolderError', 'Vui lòng nhập tên chủ tài khoản.');
                }
                
                if (!accountNumber) {
                    showError('BankAccountNumber', 'accountNumberError', 'Vui lòng nhập số tài khoản.');
                } else if (!/^\d{6,20}$/.test(accountNumber)) {
                    showError('BankAccountNumber', 'accountNumberError', 'Số tài khoản phải là số và có từ 6 đến 20 ký tự.');
                }
                
                // Nếu có lỗi, ngăn submit và scroll đến field đầu tiên có lỗi
                if (hasError) {
                    const firstError = form.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                    return false;
                }
                
                // Nếu không có lỗi, submit form thủ công
                form.submit();
            });
            
            // Clear error khi user nhập
            form.querySelectorAll('input, textarea').forEach(field => {
                field.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        this.classList.remove('is-invalid');
                        const fieldName = this.getAttribute('name');
                        let errorId = '';
                        if (fieldName === 'Reason') errorId = 'reasonError';
                        else if (fieldName === 'BankName') errorId = 'bankNameError';
                        else if (fieldName === 'AccountHolderName') errorId = 'accountHolderError';
                        else if (fieldName === 'BankAccountNumber') errorId = 'accountNumberError';
                        
                        if (errorId) {
                            const bookingId = form.querySelector('input[name="BookingId"]')?.value;
                            const errorDiv = document.getElementById(`${errorId}-${bookingId}`);
                            if (errorDiv) {
                                errorDiv.classList.add('d-none');
                            }
                            // Clear timeout nếu có
                            if (errorTimeouts[errorId]) {
                                clearTimeout(errorTimeouts[errorId]);
                                delete errorTimeouts[errorId];
                            }
                        }
                    }
                });
            });
        });
    </script>
}

@using VHS_frontend.Areas.Customer.Models.BookingServiceDTOs
@model VHS_frontend.Areas.Customer.Models.BookingServiceDTOs.HistoryBookingDetailDTO
@{
    ViewData["Title"] = "Chi tiết đơn đã hủy";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string FmtMoney(decimal v) => string.Format("{0:#,0}", v);
    string FmtDate(DateTime? d) => d.HasValue ? d.Value.ToString("HH:mm dd-MM-yyyy") : "—";

    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    // Helper để lấy ảnh đầu tiên từ ServiceImages (có thể là JSON array hoặc comma-separated string)
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            // Thử parse JSON array trước
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        // Nếu không phải JSON, thử split bằng dấu phẩy
        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        
        // Nếu không có dấu phẩy, trả về nguyên chuỗi
        return images;
    }

    // Helper để lấy ảnh service (backend đã thêm domain prefix)
    string GetServiceImage(string? serviceImages)
    {
        if (string.IsNullOrWhiteSpace(serviceImages))
            return fallbackImg;
        
        var img = FirstImageOrDefault(serviceImages);
        return !string.IsNullOrWhiteSpace(img) ? img : fallbackImg;
    }

    // Helper để lấy logo provider (backend đã thêm domain prefix)
    string GetProviderLogo(string? providerImages)
    {
        if (!string.IsNullOrWhiteSpace(providerImages))
        {
            var logo = FirstImageOrDefault(providerImages);
            if (!string.IsNullOrWhiteSpace(logo)) return logo;
        }
        
        // Fallback về shop-badge.svg nếu không có providerImages
        return "/images/shop-badge.svg";
    }

    // Tính toán giá
    var servicePrice = Model?.Service?.UnitPrice ?? 0m;
    var optionTotal = 0m; // Options no longer have Price
    var subtotal = Model?.Subtotal ?? 0m;
    var shippingFee = Model?.ShippingFee ?? 0m;
    var voucherDiscount = Model?.VoucherDiscount ?? 0m;
    var total = Model?.Total ?? 0m;
    var paidAmount = Model?.PaidAmount ?? 0m;
}

<link rel="stylesheet" href="~/css/cancel-booking-detail.css" asp-append-version="true" />

<div class="kb kb-container">
    <!-- Header -->
    <div class="kb-header-compact">
        <h2 class="kb-title">Chi tiết hủy đơn</h2>
        <nav aria-label="breadcrumb" class="kb-breadcrumb-nav">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-area="Customer" asp-controller="BookingService" asp-action="ListHistoryBooking" class="breadcrumb-link">Lịch sử đặt hàng </a>
                </li>
                <li> / </li>
                <li class="breadcrumb-item active" aria-current="page"> Chi tiết hủy đơn</li>
            </ol>
        </nav>
    </div>

    <!-- Timeline -->
    @if (Model?.Timeline?.Any() ?? false)
    {
        <div class="kb-card kb-timeline">
            <div class="kb-card-header">
                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" class="kb-icon">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M7.5 4.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5zm0 5a.5.5 0 0 1 .5.5h.5a.5.5 0 0 1 0 1H8a.5.5 0 0 1-.5-.5v-.5a.5.5 0 0 1 .5-.5z"/>
                </svg>
                <span>Tiến trình</span>
            </div>
            <div class="kb-card-body">
                <ol class="kb-steps">
                    @foreach (var ev in Model.Timeline.OrderBy(t => t.Time))
                    {
                        <li class="kb-step">
                            <div class="kb-step-dot"></div>
                            <div class="kb-step-content">
                                <div class="kb-step-title">@ev.Title</div>
                                @if (!string.IsNullOrWhiteSpace(ev.Description))
                                {
                                    <div class="kb-step-desc">@ev.Description</div>
                                }
                                <div class="kb-step-time">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" class="kb-icon-small">
                                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                    </svg>
                                    <span>@ev.Time:HH:mm dd-MM-yyyy</span>
                                </div>
                            </div>
                        </li>
                    }
                </ol>
            </div>
        </div>
    }

    <!-- Service / Product -->
    <div class="kb-card">
        <div class="kb-card-body">
            @if (!string.IsNullOrWhiteSpace(Model?.ProviderName))
            {
                <div class="kb-provider-info">
                    <img src="@GetProviderLogo(Model?.ProviderImages)" alt="@Model.ProviderName" class="kb-provider-logo" 
                         loading="lazy" decoding="async"
                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                    <div class="kb-provider-details">
                        <div class="kb-provider-name">@Model.ProviderName</div>
                        <div class="kb-provider-label">Nhà cung cấp dịch vụ</div>
                    </div>
                </div>
                <div class="kb-provider-divider"></div>
            }
            
            <div class="kb-service-layout">
                <div class="kb-service-left">
                    <div class="kb-service-row">
                        <div class="kb-service-image-wrapper">
                            <img src="@GetServiceImage(Model?.ServiceImages)" alt="Ảnh dịch vụ" class="kb-thumb" loading="lazy" decoding="async"
                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                        </div>
                        <div class="kb-service-content">
                            <div class="kb-service-title">@Model?.Service?.Title</div>
                            
                            @if (Model?.Options?.Any() ?? false)
                            {
                                @* Hiển thị danh sách options phẳng (không có nhóm) cho Customer *@
                                @* Tách options thành 2 nhóm: non-textarea trước, textarea sau *@
                                var nonTextareaOptions = Model.Options.Where(opt => 
                                    !(opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text")).ToList();
                                var textareaOptions = Model.Options.Where(opt => 
                                    opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text").ToList();
                                
                                <div class="kb-options-section">
                                    <div class="opt-section">
                                        @* Hiển thị non-textarea options trước *@
                                        @foreach (var op in nonTextareaOptions)
                                        {
                                            <div class="opt-row">
                                                <div class="opt-name" style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 500; margin-bottom: 8px;">
                                                        <span>✓</span>
                                                        <span>@op.OptionName</span>
                                                    </div>
                                                    @if (!string.IsNullOrWhiteSpace(op.Value))
                                                    {
                                                        <div style="margin-top: 8px;">
                                                            <span class="text-muted" style="margin-left: 4px;">@op.Value</span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                        
                                        @* Hiển thị textarea options sau cùng *@
                                        @foreach (var op in textareaOptions)
                                        {
                                            var isTextarea = op.Type?.ToLower() == "textarea" || op.Type?.ToLower() == "text";
                                            <div class="opt-row">
                                                <div class="opt-name" style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 500; margin-bottom: 8px;">
                                                        <span>✓</span>
                                                        <span>@op.OptionName</span>
                                                    </div>
                                                    @if (!string.IsNullOrWhiteSpace(op.Value))
                                                    {
                                                        <div style="margin-top: 8px;">
                                                       
                                                            @if (isTextarea)
                                                            {
                                                                <div class="option-value-text" style="white-space: pre-wrap; word-wrap: break-word; margin-top: 4px; font-size: 0.9em; line-height: 1.5;">@op.Value</div>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted" style="margin-left: 4px;">@op.Value</span>
                                                            }
                                                        </div>
                                                    }
                                                    else if (isTextarea)
                                                    {
                                                        <div style="margin-top: 8px; color: #6c757d; font-size: 0.875em;">
                                                            <i class="bi bi-info-circle" style="margin-right: 4px;"></i>Chưa có
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                
                <div class="kb-service-right">
                    <div class="kb-price-box">
                        <div class="kb-price-item">
                            <span class="kb-price-label">Giá dịch vụ:</span>
                            <span class="kb-price-value">@FmtMoney(servicePrice)</span>
                        </div>
                        @if (optionTotal > 0)
                        {
                            <div class="kb-price-item">
                                <span class="kb-price-label">Tuỳ chọn:</span>
                                <span class="kb-price-value">@FmtMoney(optionTotal)</span>
                            </div>
                        }
                        @if (voucherDiscount > 0)
                        {
                            <div class="kb-price-item kb-price-item-discount">
                                <span class="kb-price-label">Giảm giá:</span>
                                <span class="kb-price-value kb-price-value-discount">-@FmtMoney(voucherDiscount)</span>
                            </div>
                        }
                        <div class="kb-price-divider"></div>
                        <div class="kb-price-total-box">
                            <span class="kb-price-label">Tổng cộng:</span>
                            <span class="kb-price-total-value">@FmtMoney(total)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="kb-card-footer">
            <div class="kb-payment-summary">
                <div class="kb-payment-total">
                    <span class="kb-payment-total-label">Thành tiền:</span>
                    <span class="kb-payment-total-value">@FmtMoney(total)</span>
                </div>
                <!-- <div class="kb-payment-status-wrapper">
                    <span class="kb-payment-status-label">Xử lí:</span>
                    @{
                        var paymentStatusTop = Model?.PaymentStatus ?? "";
                        var refundStatusTop = Model?.RefundStatus ?? "";
                        var isPaidTop = paidAmount > 0 || paymentStatusTop.Equals("Paid", StringComparison.OrdinalIgnoreCase) || 
                                        paymentStatusTop.Equals("Đã thanh toán", StringComparison.OrdinalIgnoreCase);
                        
                        string displayStatusTop = "";
                        string statusClassTop = "";
                        string statusIconTop = "";
                        bool showIconTop = false;
                        
                        if (!string.IsNullOrWhiteSpace(refundStatusTop))
                        {
                            if (refundStatusTop.Equals("Approved", StringComparison.OrdinalIgnoreCase))
                            {
                                displayStatusTop = "Đã duyệt hoàn tiền";
                                statusClassTop = "kb-payment-status-refunded";
                                statusIconTop = "bi-check-circle-fill";
                                showIconTop = true;
                            }
                            else if (refundStatusTop.Equals("Rejected", StringComparison.OrdinalIgnoreCase))
                            {
                                displayStatusTop = "Đã từ chối hoàn tiền";
                                statusClassTop = "kb-payment-status-rejected";
                                statusIconTop = "bi-x-circle-fill";
                                showIconTop = true;
                            }
                            else if (refundStatusTop.Equals("Pending", StringComparison.OrdinalIgnoreCase))
                            {
                                displayStatusTop = "Đang chờ xử lý";
                                statusClassTop = "kb-payment-status-pending";
                                statusIconTop = "bi-clock-fill";
                                showIconTop = true;
                            }
                        }
                        else if (isPaidTop)
                        {
                            displayStatusTop = "Đã thanh toán";
                            statusClassTop = "kb-payment-status-paid";
                            statusIconTop = "bi-check-circle";
                            showIconTop = true;
                        }
                        else
                        {
                            displayStatusTop = "Chưa thanh toán";
                            statusClassTop = "kb-payment-status-pending";
                            statusIconTop = "";
                            showIconTop = false;
                        }
                    }
                    <div class="kb-payment-status @statusClassTop">
                        @if (showIconTop)
                        {
                            <i class="bi @statusIconTop"></i>
                        }
                        <span>@displayStatusTop</span>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <!-- Receiver & Address -->
    <div class="kb-card">
        <div class="kb-card-header">
            <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" class="kb-icon">
                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
            </svg>
            <span>Người nhận & địa chỉ</span>
        </div>
        <div class="kb-card-body">
            <div class="kb-address-list">
                <div class="kb-address-name">
                    @Model?.RecipientFullName <span class="kb-address-phone">— @Model?.RecipientPhone</span>
                </div>
                <div class="kb-address-line">@Model?.AddressLine</div>
                @if (!string.IsNullOrWhiteSpace(Model?.ShippingTrackingCode))
                {
                    <div class="kb-tracking-code">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" class="kb-icon-small">
                            <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5v5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 0 8.5v-5zM1.5 3a.5.5 0 0 0-.5.5v.793l.853.853A.5.5 0 0 0 3 4.707V3.5a.5.5 0 0 0-.5-.5h-1zm11 .5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.207l.853.853A.5.5 0 0 0 11 4.707V3.5zm-2.5 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                        </svg>
                        <span>Mã vận đơn: @Model.ShippingTrackingCode</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Cancel / Refund info -->
    <div class="kb-card">
        <div class="kb-card-header">
            <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" class="kb-icon">
                <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5zm8-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5z"/>
            </svg>
            <span>Thông tin hủy</span>
        </div>
        <div class="kb-card-body">
            <!-- Lý do hủy -->
            <div class="kb-cancel-reason-section">
                <div class="kb-cancel-reason-label">LÝ DO HỦY</div>
                <div class="kb-cancel-reason-value">
                    @if (!string.IsNullOrWhiteSpace(Model?.CancelReason))
                    {
                        @Model.CancelReason
                    }
                    else
                    {
                        <span style="color: var(--muted-foreground); font-style: italic;">Chưa có thông tin</span>
                    }
                </div>
            </div>
        </div>
    </div>

  
</div>


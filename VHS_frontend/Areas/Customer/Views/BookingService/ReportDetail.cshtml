@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@model VHS_frontend.Areas.Customer.Models.ReportDTOs.ReadReportDTO
@{
    ViewData["Title"] = "Chi tiết báo cáo";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string FmtMoney(decimal v) => string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:#,0}", v);
    
    // Get backend URL for images
    var backendUrl = Configuration["Apis:Backend"] ?? "http://localhost:5154";
    string GetFullImageUrl(string relativePath)
    {
        if (string.IsNullOrWhiteSpace(relativePath)) return "/images/placeholder.png";
        if (relativePath.StartsWith("http://") || relativePath.StartsWith("https://")) return relativePath;
        return backendUrl + relativePath;
    }

    var statusBadgeClass = Model?.Status switch
    {
        "Pending" => "kb-badge-warning",
        "InReview" => "kb-badge-info",
        "Resolved" => "kb-badge-success",
        "Rejected" => "kb-badge-danger",
        _ => "kb-badge-secondary"
    };

    var statusText = Model?.Status switch
    {
        "Pending" => "Chờ xử lý",
        "InReview" => "Đang xem xét",
        "Resolved" => "Đã giải quyết",
        "Rejected" => "Đã từ chối",
        _ => Model?.Status ?? "Không xác định"
    };
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/report-detail.css" asp-append-version="true" />

<div class="kb container py-4">

    <!-- Header -->
    <div class="kb-header d-flex flex-wrap align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center gap-2">
            <h2 class="kb-title mb-0">Chi tiết báo cáo</h2>
            <span class="kb-badge @statusBadgeClass">
                <i class="bi bi-shield-exclamation me-1"></i>@statusText
            </span>
        </div>
        <div class="d-flex gap-2">
            <a asp-area="Customer" asp-controller="BookingService" asp-action="ListHistoryBooking" class="btn btn-ghost">
                <i class="bi bi-clock-history me-1"></i>Lịch sử đơn
            </a>
            <a href="javascript:history.back()" class="btn btn-brand">
                <i class="bi bi-arrow-left-short me-1"></i>Quay lại
            </a>
        </div>
    </div>

    <!-- Service / Product -->
    <div class="kb-card mb-4">
        <div class="kb-card-header">
            <i class="bi bi-bag me-2"></i>Dịch vụ
        </div>
        <div class="kb-card-body">
            <div class="row g-3 align-items-start">
                <div class="col">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <div class="fw-bold fs-6">@Model?.ServiceName</div>
                        @if (!string.IsNullOrWhiteSpace(Model?.ProviderName))
                        {
                            <span class="kb-chip"><i class="bi bi-shop me-1"></i>@Model.ProviderName</span>
                        }
                    </div>

                    <div class="text-muted small mt-1">
                        <span>Mã đơn: <strong>@Model?.BookingId</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Complaint Details -->
    <div class="kb-card mb-4">
        <div class="kb-card-header">
            <i class="bi bi-flag me-2"></i>Nội dung báo cáo
        </div>
        <div class="kb-card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="kb-label">Loại báo cáo</div>
                    <div class="fw-semibold">@Model?.ComplaintType</div>
                </div>
                <div class="col-md-4">
                    <div class="kb-label">Ngày tạo</div>
                    <div class="text-muted">@Model?.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</div>
                </div>
                <div class="col-md-4">
                    <div class="kb-label">Trạng thái</div>
                    <div class="fw-semibold">@statusText</div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <div class="kb-label">Tiêu đề</div>
                    <div class="fw-semibold">@Model?.Title</div>
                </div>
                <div class="col-12">
                    <div class="kb-label">Mô tả chi tiết</div>
                    <div class="text-muted">@(!string.IsNullOrWhiteSpace(Model?.Description) ? Model!.Description : "—")</div>
                </div>
            </div>

            @if (Model?.AttachmentUrls != null && Model.AttachmentUrls.Any())
            {
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <div class="kb-label">Hình ảnh đính kèm</div>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var url in Model.AttachmentUrls)
                            {
                                var fullImageUrl = GetFullImageUrl(url);
                                <a href="@fullImageUrl" target="_blank" rel="noopener">
                                    <img src="@fullImageUrl" class="img-thumbnail" style="width:100px;height:100px;object-fit:cover;" 
                                         alt="Attachment"
                                         onerror="this.onerror=null;this.src='/images/placeholder.png';" />
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Model?.ResolutionNote))
            {
                <div class="row g-3 mt-3">
                    <div class="col-12">
                        <div class="kb-label">Ghi chú xử lý</div>
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>@Model.ResolutionNote
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Actions -->
    @if (Model?.Status == "Pending" || Model?.Status == "InReview")
    {
        <div class="kb-card">
            <div class="kb-card-body d-flex flex-wrap gap-2 justify-content-end">
                <a asp-area="Customer"
                   asp-controller="BookingService"
                   asp-action="ListHistoryBooking"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Quay lại danh sách
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="kb-card">
            <div class="kb-card-body">
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Báo cáo này đã được xử lý. Nếu bạn có thắc mắc, vui lòng liên hệ bộ phận hỗ trợ.
                </div>
            </div>
        </div>
    }

</div>

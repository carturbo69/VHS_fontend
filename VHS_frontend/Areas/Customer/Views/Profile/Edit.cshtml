@model VHS_frontend.Areas.Customer.Models.Profile.EditProfileViewModel
@{
    ViewData["Title"] = "Chỉnh sửa thông tin cá nhân";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}

@await Html.PartialAsync("_ProfileNavigation")

<div class="profile-edit-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="bi bi-pencil-square"></i> Chỉnh sửa thông tin cá nhân</h1>
            <p>Cập nhật thông tin cá nhân của bạn</p>
        </div>
        <div class="header-actions">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="edit-form-container">
        <form asp-action="Edit" method="post" class="profile-edit-form">
            @Html.AntiForgeryToken()
            
            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
            
            <!-- Profile Image Section -->
            <div class="form-section">
                <h3><i class="bi bi-image"></i> Ảnh đại diện</h3>
                <div class="image-section">
                    <div class="current-image">
                        <img src="@ImageHelper.GetImageUrl(Model.GetCurrentImageUrl(), Configuration)" alt="Ảnh hiện tại" class="profile-image-preview">
                        <div class="image-overlay">
                            <button type="button" class="btn btn-sm btn-primary" onclick="openImageUpload()">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                    </div>
                    <div class="image-actions">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="openImageUpload()">
                            <i class="bi bi-camera me-1"></i>Đổi ảnh
                        </button>
                        @if (!string.IsNullOrEmpty(Model.CurrentImage))
                        {
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteProfileImage()">
                                <i class="bi bi-trash me-1"></i>Xóa ảnh
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="form-section">
                <h3><i class="bi bi-person"></i> Thông tin cá nhân</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label asp-for="AccountName" class="form-label required"></label>
                        <input asp-for="AccountName" class="form-control" placeholder="Nhập tên tài khoản">
                        <span asp-validation-for="AccountName" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Email" class="form-label required"></label>
                        <input asp-for="Email" type="email" class="form-control" placeholder="Nhập email">
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="FullName" class="form-label"></label>
                        <input asp-for="FullName" class="form-control" placeholder="Nhập họ và tên">
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="PhoneNumber" class="form-label"></label>
                        <input asp-for="PhoneNumber" type="tel" class="form-control" placeholder="Nhập số điện thoại">
                        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Address Section -->
            <div class="form-section">
                <h3><i class="bi bi-geo-alt"></i> Địa chỉ</h3>
                <div class="form-group">
                    <label asp-for="Address" class="form-label"></label>
                    <textarea asp-for="Address" class="form-control" rows="3" placeholder="Nhập địa chỉ của bạn"></textarea>
                    <span asp-validation-for="Address" class="text-danger"></span>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-x-circle"></i> Hủy
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Lưu thay đổi
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="imageUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đổi ảnh đại diện</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="profileImage" class="form-label">Chọn ảnh</label>
                        <input type="file" class="form-control" id="profileImage" name="image" accept="image/*" required>
                        <div class="form-text">Chỉ chấp nhận file JPG, PNG, GIF, BMP, WEBP (tối đa 5MB)</div>
                    </div>
                    <div class="image-preview" id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="uploadProfileImage()">
                    <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner"></span>
                    <i class="bi bi-upload" id="uploadIcon"></i>
                    Tải lên
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/image-helper.js"></script>
    <script>
        // AccountName validation
        document.addEventListener('DOMContentLoaded', function() {
            const accountNameInput = document.querySelector('input[name="AccountName"]');
            const accountNameError = document.querySelector('span[data-valmsg-for="AccountName"]');
            
            if (accountNameInput) {
                // Validation on blur (khi rời khỏi trường)
                accountNameInput.addEventListener('blur', function() {
                    validateAccountName(this);
                });
                
                // Clear error when user starts typing again
                accountNameInput.addEventListener('input', function() {
                    // Chỉ xóa lỗi khi người dùng bắt đầu nhập lại, không validate real-time
                    if (this.classList.contains('is-invalid')) {
                        const formGroup = this.closest('.form-group');
                        const errorSpan = formGroup ? formGroup.querySelector('span[asp-validation-for], span.text-danger') : null;
                        if (errorSpan) {
                            errorSpan.style.display = 'none';
                        }
                        this.classList.remove('is-invalid');
                    }
                });
            }
            
            function validateAccountName(input) {
                const value = input.value.trim();
                const formGroup = input.closest('.form-group');
                const errorSpan = formGroup ? formGroup.querySelector('span[asp-validation-for], span.text-danger') : null;
                
                // Remove previous error classes
                input.classList.remove('is-invalid');
                if (errorSpan) {
                    errorSpan.textContent = '';
                    errorSpan.style.display = 'none';
                }
                
                // Validation rules
                if (value.length === 0) {
                    return; // Let required validation handle empty
                }
                
                if (value.length < 8) {
                    showError(input, 'Tối thiểu 8 ký tự, chữ và số, không dấu, không khoảng cách');
                    return false;
                }
                
                // Check for invalid characters (non-alphanumeric)
                if (!/^[a-zA-Z0-9]+$/.test(value)) {
                    showError(input, 'Tối thiểu 8 ký tự, chữ và số, không dấu, không khoảng cách');
                    return false;
                }
                
                // Valid
                input.classList.remove('is-invalid');
                if (errorSpan) {
                    errorSpan.textContent = '';
                    errorSpan.style.display = 'none';
                }
                return true;
            }
            
            function showError(input, message) {
                input.classList.add('is-invalid');
                const formGroup = input.closest('.form-group');
                const errorSpan = formGroup ? formGroup.querySelector('span[asp-validation-for], span.text-danger') : null;
                if (errorSpan) {
                    errorSpan.textContent = message;
                    errorSpan.style.display = 'block';
                }
            }
            
            // Form submit validation
            const form = document.querySelector('.profile-edit-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const accountNameInput = document.querySelector('input[name="AccountName"]');
                    if (accountNameInput && !validateAccountName(accountNameInput)) {
                        e.preventDefault();
                        e.stopPropagation();
                        accountNameInput.focus();
                        return false;
                    }
                });
            }
        });
        
        // Image upload functionality
        function openImageUpload() {
            const modal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
            modal.show();
        }

        // Preview image before upload
        document.getElementById('profileImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Upload profile image
        async function uploadProfileImage() {
            const fileInput = document.getElementById('profileImage');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Vui lòng chọn ảnh để tải lên', 'error');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Kích thước file không được vượt quá 5MB', 'error');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showToast('Chỉ chấp nhận file ảnh JPG, PNG, GIF, BMP, WEBP', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            const uploadBtn = document.querySelector('#imageUploadModal .btn-primary');
            const spinner = document.getElementById('uploadSpinner');
            const icon = document.getElementById('uploadIcon');

            // Show loading state
            uploadBtn.disabled = true;
            spinner.classList.remove('d-none');
            icon.classList.add('d-none');

            try {
                const response = await fetch('@Url.Action("UploadImage")', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Tải ảnh lên thành công!', 'success');
                    // Dùng helper function để lấy URL đầy đủ
                    let fullImageUrl = typeof getImageUrl !== 'undefined' 
                        ? getImageUrl(result.imageUrl) 
                        : result.imageUrl;
                    document.querySelector('.profile-image-preview').src = fullImageUrl;
                    bootstrap.Modal.getInstance(document.getElementById('imageUploadModal')).hide();
                    
                    // Reset form
                    document.getElementById('imageUploadForm').reset();
                    document.getElementById('imagePreview').style.display = 'none';
                } else {
                    showToast(result.message || 'Có lỗi xảy ra khi tải ảnh lên', 'error');
                }
            } catch (error) {
                showToast('Có lỗi xảy ra khi tải ảnh lên', 'error');
            } finally {
                // Hide loading state
                uploadBtn.disabled = false;
                spinner.classList.add('d-none');
                icon.classList.remove('d-none');
            }
        }

        // Delete profile image
        async function deleteProfileImage() {
            if (!confirm('Bạn có chắc chắn muốn xóa ảnh đại diện?')) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("DeleteImage")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Xóa ảnh thành công!', 'success');
                    document.querySelector('.profile-image-preview').src = '/images/default-avatar.png';
                } else {
                    showToast(result.message || 'Có lỗi xảy ra khi xóa ảnh', 'error');
                }
            } catch (error) {
                showToast('Có lỗi xảy ra khi xóa ảnh', 'error');
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Implementation depends on your toast system
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    </script>
}

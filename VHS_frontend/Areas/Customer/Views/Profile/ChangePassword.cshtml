@model VHS_frontend.Areas.Customer.Models.Profile.ChangePasswordViewModel
@{
    ViewData["Title"] = "Đổi mật khẩu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}

@await Html.PartialAsync("_ProfileNavigation")

<div class="profile-edit-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="bi bi-shield-lock"></i> Đổi mật khẩu</h1>
            <p>Bảo mật tài khoản của bạn bằng cách đổi mật khẩu</p>
        </div>
        <div class="header-actions">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="edit-form-container">
        <form method="post" class="profile-edit-form" id="changePasswordForm" action="">
            @Html.AntiForgeryToken()
            
            <!-- Error message container -->
            <div id="formError" class="alert alert-danger" style="display: none;" role="alert">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span id="formErrorText"></span>
            </div>
            
            <!-- Security Notice -->
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Lưu ý:</strong> Để đổi mật khẩu, hệ thống sẽ gửi mã OTP đến email của bạn để xác thực.
            </div>

            <!-- Password Section -->
            <div class="form-section">
                <h3><i class="bi bi-key"></i> Thông tin mật khẩu</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label asp-for="CurrentPassword" class="form-label required"></label>
                        <div class="input-group">
                            <input asp-for="CurrentPassword" type="password" class="form-control" placeholder="Nhập mật khẩu hiện tại">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('CurrentPassword')">
                                <i class="bi bi-eye" id="CurrentPassword-icon"></i>
                            </button>
                        </div>
                        <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="NewPassword" class="form-label required"></label>
                        <div class="input-group">
                            <input asp-for="NewPassword" type="password" class="form-control" placeholder="Nhập mật khẩu mới">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('NewPassword')">
                                <i class="bi bi-eye" id="NewPassword-icon"></i>
                            </button>
                        </div>
                        <span asp-validation-for="NewPassword" class="text-danger"></span>
                        <div class="password-requirements">
                            <small class="text-muted">Mật khẩu phải có ít nhất 6 ký tự</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="ConfirmPassword" class="form-label required"></label>
                        <div class="input-group">
                            <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Nhập lại mật khẩu mới">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('ConfirmPassword')">
                                <i class="bi bi-eye" id="ConfirmPassword-icon"></i>
                            </button>
                        </div>
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- OTP Section -->
            <div class="form-section">
                <h3><i class="bi bi-shield-check"></i> Xác thực OTP</h3>
                <div class="otp-section">
                    <div class="otp-info">
                        <i class="bi bi-envelope"></i>
                        <div>
                            <p>Mã OTP sẽ được gửi đến email của bạn</p>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="requestOTP()" id="requestOTPBtn">
                                <i class="bi bi-send"></i> Gửi mã OTP
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="OTP" class="form-label required"></label>
                        <input asp-for="OTP" class="form-control otp-input" id="otpInput" placeholder="Nhập mã OTP 6 số" maxlength="6">
                        <span asp-validation-for="OTP" class="text-danger"></span>
                        <div class="otp-timer" id="otpTimer" style="display: none;">
                            <small class="text-muted">Có thể gửi lại sau <span id="countdown">2:00</span> phút</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-x-circle"></i> Hủy
                </button>
                <button type="submit" class="btn btn-warning" id="submitPasswordBtn">
                    <i class="bi bi-shield-check"></i> Đổi mật khẩu
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let otpCooldown = 0;
        let otpTimerInterval = null;

        // Toggle password visibility
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + '-icon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }

        // Request OTP
        async function requestOTP() {
            const btn = document.getElementById('requestOTPBtn');
            const timer = document.getElementById('otpTimer');
            const countdown = document.getElementById('countdown');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang gửi...';

            try {
                const response = await fetch('@Url.Action("RequestPasswordChangeOTP")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Mã OTP đã được gửi đến email của bạn', 'success');
                    
                    // Start cooldown timer (2 phút = 120 giây)
                    otpCooldown = 120;
                    timer.style.display = 'block';
                    startOTPTimer();
                } else {
                    showToast(result.message || 'Có lỗi xảy ra khi gửi OTP', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-send"></i> Gửi mã OTP';
                }
            } catch (error) {
                showToast('Có lỗi xảy ra khi gửi OTP', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send"></i> Gửi mã OTP';
            }
        }

        // Start OTP timer
        function startOTPTimer() {
            otpTimerInterval = setInterval(() => {
                otpCooldown--;
                
                // Format thời gian: phút:giây (ví dụ: 2:00, 1:59, 0:30)
                const minutes = Math.floor(otpCooldown / 60);
                const seconds = otpCooldown % 60;
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('countdown').textContent = timeString;
                
                if (otpCooldown <= 0) {
                    clearInterval(otpTimerInterval);
                    document.getElementById('otpTimer').style.display = 'none';
                    document.getElementById('requestOTPBtn').disabled = false;
                    document.getElementById('requestOTPBtn').innerHTML = '<i class="bi bi-send"></i> Gửi mã OTP';
                }
            }, 1000);
        }

        // Translate error messages to Vietnamese
        function translateError(message) {
            if (!message) return message;
            
            const errorMap = {
                // OTP errors
                'OTP code is required': 'Mã OTP là bắt buộc',
                'OTP code must be exactly 6 digits': 'Mã OTP phải có đúng 6 chữ số',
                'OTP is required': 'Mã OTP là bắt buộc',
                'OTP must be exactly 6 digits': 'Mã OTP phải có đúng 6 chữ số',
                'Invalid OTP': 'Mã OTP không hợp lệ',
                'Invalid or expired OTP': 'Mã OTP không đúng hoặc đã hết hạn',
                'OTP has expired': 'Mã OTP đã hết hạn',
                'OTP expired': 'Mã OTP đã hết hạn',
                
                // Password errors
                'Current password is incorrect': 'Mật khẩu hiện tại không đúng',
                'Password is required': 'Mật khẩu là bắt buộc',
                'Password must be at least 8 characters long': 'Mật khẩu phải có ít nhất 8 ký tự',
                'Password confirmation does not match': 'Mật khẩu xác nhận không khớp',
                'New password must be different from current password': 'Mật khẩu mới phải khác mật khẩu hiện tại',
                
                // General errors
                'Bad request': 'Yêu cầu không hợp lệ',
                'Unauthorized': 'Bạn chưa đăng nhập hoặc phiên đăng nhập đã hết hạn',
                'Not found': 'Không tìm thấy dữ liệu',
                'Internal server error': 'Lỗi hệ thống. Vui lòng thử lại sau',
                'Account not found': 'Không tìm thấy tài khoản',
            };
            
            // Check exact match first
            if (errorMap.hasOwnProperty(message)) {
                var exactValue = Object.getOwnPropertyDescriptor(errorMap, message);
                if (exactValue && exactValue.value) {
                    return exactValue.value;
                }
            }
            
            // Check case-insensitive match
            const lowerMessage = message.toLowerCase();
            var errorMapKeys = Object.keys(errorMap);
            for (var i = 0; i < errorMapKeys.length; i++) {
                var key = errorMapKeys[i];
                if (errorMap.hasOwnProperty(key) && lowerMessage.includes(key.toLowerCase())) {
                    return errorMap[key];
                }
            }
            
            // Check for common patterns
            if (lowerMessage.includes('otp') && lowerMessage.includes('required')) {
                return 'Mã OTP là bắt buộc';
            }
            if (lowerMessage.includes('otp') && (lowerMessage.includes('digit') || lowerMessage.includes('6'))) {
                return 'Mã OTP phải có đúng 6 chữ số';
            }
            if (lowerMessage.includes('otp') && (lowerMessage.includes('invalid') || lowerMessage.includes('expired') || lowerMessage.includes('hết hạn'))) {
                return 'Mã OTP không đúng hoặc đã hết hạn';
            }
            if (lowerMessage.includes('password') && (lowerMessage.includes('incorrect') || lowerMessage.includes('không đúng'))) {
                return 'Mật khẩu không đúng';
            }
            if (lowerMessage.includes('password') && lowerMessage.includes('required')) {
                return 'Mật khẩu là bắt buộc';
            }
            if (lowerMessage.includes('password') && (lowerMessage.includes('match') || lowerMessage.includes('khớp'))) {
                return 'Mật khẩu xác nhận không khớp';
            }
            
            return message;
        }
        
        // Translate all validation errors on the page
        function translateValidationErrors() {
            // Translate span validation errors
            var allSpans = document.getElementsByTagName('span');
            for (var i = 0; i < allSpans.length; i++) {
                var span = allSpans.item(i);
                if (span.hasAttribute('data-valmsg-for') && span.textContent.trim()) {
                    span.textContent = translateError(span.textContent.trim());
                }
            }
            
            // Translate field validation errors
            var errorElements = document.getElementsByClassName('text-danger');
            for (var i = 0; i < errorElements.length; i++) {
                var element = errorElements.item(i);
                if (element.textContent.trim()) {
                    element.textContent = translateError(element.textContent.trim());
                }
            }
            
            var fieldErrors = document.getElementsByClassName('field-validation-error');
            for (var i = 0; i < fieldErrors.length; i++) {
                var element = fieldErrors.item(i);
                if (element.textContent.trim()) {
                    element.textContent = translateError(element.textContent.trim());
                }
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Translate error messages
            const translatedMessage = type === 'error' ? translateError(message) : message;
            // Implementation depends on your toast system
            console.log(`${type.toUpperCase()}: ${translatedMessage}`);
            
            // Hiển thị toast notification (nếu có toast system)
            if (typeof toastr !== 'undefined') {
                if (type === 'success') {
                    toastr.success(translatedMessage);
                } else if (type === 'error') {
                    toastr.error(translatedMessage);
                } else {
                    toastr.info(translatedMessage);
                }
            } else {
                // Fallback: Hiển thị alert
                alert(translatedMessage);
            }
        }
        
        // Handle form submission with better error handling
        document.addEventListener('DOMContentLoaded', function() {
            // Translate validation errors on page load
            translateValidationErrors();
            
            // Auto request OTP for better UX
            setTimeout(() => {
                if (otpCooldown === 0) {
                    requestOTP();
                }
            }, 1000);
            
            // Observe for new validation errors (from server-side validation)
            const observer = new MutationObserver(() => {
                translateValidationErrors();
            });
            
            // Observe changes to validation error spans
            var allSpans = document.getElementsByTagName('span');
            var errorSpans = document.getElementsByClassName('text-danger');
            var fieldErrors = document.getElementsByClassName('field-validation-error');
            
            for (var i = 0; i < allSpans.length; i++) {
                var currentSpan = allSpans.item(i);
                if (currentSpan && currentSpan.hasAttribute('data-valmsg-for')) {
                    observer.observe(currentSpan, { childList: true, characterData: true, subtree: true });
                }
            }
            for (var i = 0; i < errorSpans.length; i++) {
                var currentErrorSpan = errorSpans.item(i);
                if (currentErrorSpan) {
                    observer.observe(currentErrorSpan, { childList: true, characterData: true, subtree: true });
                }
            }
            for (var i = 0; i < fieldErrors.length; i++) {
                var currentFieldError = fieldErrors.item(i);
                if (currentFieldError) {
                    observer.observe(currentFieldError, { childList: true, characterData: true, subtree: true });
                }
            }
            
            const form = document.getElementById('changePasswordForm');
            const formError = document.getElementById('formError');
            const formErrorText = document.getElementById('formErrorText');
            const submitBtn = document.getElementById('submitPasswordBtn');
            
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Hide previous errors
                    if (formError) {
                        formError.style.display = 'none';
                        formErrorText.textContent = '';
                    }
                    
                    // Clear ASP.NET Core validation errors
                    var validationSpans = form.querySelectorAll('span[data-valmsg-for]');
                    for (var i = 0; i < validationSpans.length; i++) {
                        var span = validationSpans.item(i);
                        if (span) {
                            span.textContent = '';
                            span.style.display = 'none';
                        }
                    }
                    
                    // Clear invalid classes from inputs
                    var invalidInputs = form.querySelectorAll('.is-invalid');
                    for (var i = 0; i < invalidInputs.length; i++) {
                        var input = invalidInputs.item(i);
                        if (input) {
                            input.classList.remove('is-invalid');
                        }
                    }
                    
                    // Client-side validation
                    const currentPasswordInput = document.querySelector('input[name="CurrentPassword"]');
                    const newPasswordInput = document.querySelector('input[name="NewPassword"]');
                    const confirmPasswordInput = document.querySelector('input[name="ConfirmPassword"]');
                    const otpInput = document.getElementById('otpInput');
                    
                    let hasError = false;
                    let errorMessages = [];
                    
                    // Validate Current Password
                    if (!currentPasswordInput || !currentPasswordInput.value.trim()) {
                        hasError = true;
                        errorMessages.push('Mật khẩu hiện tại là bắt buộc');
                        if (currentPasswordInput) {
                            currentPasswordInput.classList.add('is-invalid');
                        }
                    } else {
                        currentPasswordInput.classList.remove('is-invalid');
                    }
                    
                    // Validate New Password
                    if (!newPasswordInput || !newPasswordInput.value.trim()) {
                        hasError = true;
                        errorMessages.push('Mật khẩu mới là bắt buộc');
                        if (newPasswordInput) {
                            newPasswordInput.classList.add('is-invalid');
                        }
                    } else {
                        var newPasswordValue = newPasswordInput.value.trim();
                        if (newPasswordValue.length < 6) {
                            hasError = true;
                            errorMessages.push('Mật khẩu mới phải có ít nhất 6 ký tự');
                            newPasswordInput.classList.add('is-invalid');
                        } else {
                            newPasswordInput.classList.remove('is-invalid');
                        }
                    }
                    
                    // Validate Confirm Password
                    if (!confirmPasswordInput || !confirmPasswordInput.value.trim()) {
                        hasError = true;
                        errorMessages.push('Mật khẩu xác nhận là bắt buộc');
                        if (confirmPasswordInput) {
                            confirmPasswordInput.classList.add('is-invalid');
                        }
                    } else {
                        var confirmPasswordValue = confirmPasswordInput.value.trim();
                        var newPasswordValue = newPasswordInput ? newPasswordInput.value.trim() : '';
                        if (confirmPasswordValue !== newPasswordValue) {
                            hasError = true;
                            errorMessages.push('Mật khẩu xác nhận không khớp');
                            confirmPasswordInput.classList.add('is-invalid');
                        } else {
                            confirmPasswordInput.classList.remove('is-invalid');
                        }
                    }
                    
                    // Validate OTP
                    if (!otpInput) {
                        hasError = true;
                        errorMessages.push('Mã OTP là bắt buộc');
                    } else {
                        var otpValueRaw = otpInput.value || '';
                        var otpValue = otpValueRaw.trim().replace(/\s+/g, '').replace(/-/g, '').replace(/\./g, '');
                        
                        // Always update input value to cleaned version
                        if (otpValueRaw !== otpValue && otpValue.length > 0) {
                            otpInput.value = otpValue;
                        }
                        
                        if (!otpValue || otpValue.length === 0) {
                            hasError = true;
                            errorMessages.push('Mã OTP là bắt buộc');
                            otpInput.classList.add('is-invalid');
                        } else {
                            // Check if OTP is exactly 6 digits (only numbers, no spaces)
                            var otpLength = otpValue.length;
                            var isAllDigits = /^\d+$/.test(otpValue);
                            
                            if (otpLength !== 6 || !isAllDigits) {
                                hasError = true;
                                errorMessages.push('Mã OTP phải có đúng 6 chữ số');
                                otpInput.classList.add('is-invalid');
                            } else {
                                // Ensure input value is set correctly before submit
                                otpInput.value = otpValue;
                                otpInput.classList.remove('is-invalid');
                            }
                        }
                    }
                    
                    // If validation fails, show errors and return
                    if (hasError) {
                        const errorMessage = errorMessages.join(', ');
                        if (formError && formErrorText) {
                            formErrorText.textContent = errorMessage;
                            formError.style.display = 'block';
                            formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        showToast(errorMessage, 'error');
                        return;
                    }
                    
                    // Ensure OTP is cleaned one more time before submit
                    if (otpInput) {
                        var finalOtpValue = (otpInput.value || '').trim().replace(/\s+/g, '').replace(/-/g, '').replace(/\./g, '');
                        if (finalOtpValue.length === 6 && /^\d+$/.test(finalOtpValue)) {
                            otpInput.value = finalOtpValue;
                        }
                    }
                    
                    // Show loading state
                    if (submitBtn) {
                        const originalBtnText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
                        
                        try {
                            // Convert form to JSON object
                            const data = {
                                CurrentPassword: currentPasswordInput ? currentPasswordInput.value : '',
                                NewPassword: newPasswordInput ? newPasswordInput.value : '',
                                ConfirmPassword: confirmPasswordInput ? confirmPasswordInput.value : '',
                                OTP: otpInput ? otpInput.value : ''
                            };
                            
                            var tokenInput = null;
                            var allInputs = document.getElementsByTagName('input');
                            for (var i = 0; i < allInputs.length; i++) {
                                var currentInput = allInputs.item(i);
                                if (currentInput && currentInput.name === '__RequestVerificationToken') {
                                    tokenInput = currentInput;
                                    break;
                                }
                            }
                            var token = tokenInput ? tokenInput.value : '';
                            
                            // Use explicit URL to ensure we hit the JSON endpoint
                            // Build URL manually to avoid Razor rendering issues
                            const baseUrl = window.location.origin;
                            const changePasswordUrl = baseUrl + '/Customer/Profile/ChangePasswordApi';
                            
                            console.log('[ChangePassword] Base URL:', baseUrl);
                            console.log('[ChangePassword] Full URL:', changePasswordUrl);
                            console.log('[ChangePassword] Sending request to:', changePasswordUrl);
                            console.log('[ChangePassword] Request data:', { 
                                CurrentPassword: '***', 
                                NewPassword: '***', 
                                ConfirmPassword: '***', 
                                OTP: data.OTP 
                            });
                            
                            const response = await fetch(changePasswordUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json; charset=utf-8',
                                    'Accept': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'RequestVerificationToken': token
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify(data)
                            });
                            
                            console.log('[ChangePassword] Response status:', response.status);
                            console.log('[ChangePassword] Response ok:', response.ok);
                            console.log('[ChangePassword] Response headers:', Object.fromEntries(response.headers.entries()));
                            
                            // Always read response as text first
                            const responseText = await response.text();
                            let result = null;
                            
                            // Try to parse as JSON
                            try {
                                result = JSON.parse(responseText);
                            } catch (parseError) {
                                // If not JSON, check if it's HTML or plain text
                                console.warn('Response is not JSON:', responseText.substring(0, 200));
                                result = { success: false, message: 'Có lỗi xảy ra khi đổi mật khẩu' };
                            }
                            
                            if (!response.ok) {
                                // Handle HTTP errors (400, 500, etc.)
                                let errorMessage = 'Có lỗi xảy ra khi đổi mật khẩu';
                                
                                // Try multiple ways to extract error message
                                if (result) {
                                    errorMessage = result.message || result.Message || result.error || result.Error || errorMessage;
                                    
                                    // If it's a validation error, try to extract more details
                                    if (result.errors && typeof result.errors === 'object') {
                                        // Handle dictionary-style errors { "FieldName": ["Error1", "Error2"] }
                                        var allErrorMessages = [];
                                        for (var fieldName in result.errors) {
                                            if (result.errors.hasOwnProperty(fieldName)) {
                                                var fieldErrors = result.errors[fieldName];
                                                if (Array.isArray(fieldErrors)) {
                                                    allErrorMessages = allErrorMessages.concat(fieldErrors);
                                                } else if (typeof fieldErrors === 'string') {
                                                    allErrorMessages.push(fieldErrors);
                                                }
                                            }
                                        }
                                        if (allErrorMessages.length > 0) {
                                            errorMessage = allErrorMessages.join(', ');
                                        }
                                        
                                        // Display specific validation errors for each field
                                        for (var fieldName in result.errors) {
                                            if (result.errors.hasOwnProperty(fieldName)) {
                                                var fieldErrors = result.errors[fieldName];
                                                var errorText = Array.isArray(fieldErrors) ? fieldErrors.join(', ') : fieldErrors;
                                                
                                                // Find and update the error span for this field
                                                var errorSpan = form.querySelector('span[data-valmsg-for="' + fieldName + '"]');
                                                if (errorSpan) {
                                                    errorSpan.textContent = translateError(errorText);
                                                    errorSpan.style.display = 'block';
                                                }
                                                
                                                // Also mark the input as invalid
                                                var inputField = form.querySelector('[name="' + fieldName + '"]');
                                                if (inputField) {
                                                    inputField.classList.add('is-invalid');
                                                }
                                            }
                                        }
                                    }
                                    
                                    // Check for detail field (common in API error responses)
                                    if (result.detail || result.Detail) {
                                        errorMessage = result.detail || result.Detail;
                                    }
                                } else if (responseText) {
                                    // If we couldn't parse JSON, try to extract error from HTML/text
                                    var responseTextLength = responseText.length;
                                    if (responseTextLength < 500) {
                                        // If response is short, might be plain text error
                                        errorMessage = responseText.trim();
                                    }
                                }
                                
                                // Translate error message to Vietnamese
                                errorMessage = translateError(errorMessage);
                                
                                // Show error in form
                                if (formError && formErrorText) {
                                    formErrorText.textContent = errorMessage;
                                    formError.style.display = 'block';
                                    formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                                
                                showToast(errorMessage, 'error');
                                
                                // Reset button state
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = originalBtnText;
                                }
                                return;
                            }
                            
                            if (result.success) {
                                showToast('Đổi mật khẩu thành công!', 'success');
                                setTimeout(() => {
                                    window.location.href = '@Url.Action("Index", "Profile")';
                                }, 1500);
                            } else {
                                let errorMessage = result.message || result.Message || 'Có lỗi xảy ra khi đổi mật khẩu';
                                
                                // Translate error message to Vietnamese
                                errorMessage = translateError(errorMessage);
                                
                                // Display specific validation errors if available
                                if (result.errors && typeof result.errors === 'object') {
                                    for (var fieldName in result.errors) {
                                        if (result.errors.hasOwnProperty(fieldName)) {
                                            var fieldErrors = result.errors[fieldName];
                                            var errorText = Array.isArray(fieldErrors) ? fieldErrors.join(', ') : fieldErrors;
                                            
                                            // Find and update the error span for this field
                                            var errorSpan = form.querySelector('span[data-valmsg-for="' + fieldName + '"]');
                                            if (errorSpan) {
                                                errorSpan.textContent = translateError(errorText);
                                                errorSpan.style.display = 'block';
                                            }
                                            
                                            // Also mark the input as invalid
                                            var inputField = form.querySelector('[name="' + fieldName + '"]');
                                            if (inputField) {
                                                inputField.classList.add('is-invalid');
                                            }
                                        }
                                    }
                                }
                                
                                // Show error in form
                                if (formError && formErrorText) {
                                    formErrorText.textContent = errorMessage;
                                    formError.style.display = 'block';
                                    formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                                
                                showToast(errorMessage, 'error');
                                
                                // Reset button state
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = originalBtnText;
                                }
                            }
                        } catch (error) {
                            console.error('Error changing password:', error);
                            const errorMessage = 'Có lỗi xảy ra khi đổi mật khẩu: ' + (error.message || 'Vui lòng thử lại');
                            
                            // Show error in form
                            if (formError && formErrorText) {
                                formErrorText.textContent = errorMessage;
                                formError.style.display = 'block';
                                formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            
                            showToast(errorMessage, 'error');
                            
                            // Reset button state
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                            }
                        }
                    }
                });
            }
        });
    </script>
}

@using VHS_frontend.Helpers
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration

@model VHS_frontend.Areas.Customer.Models.Profile.ProfileViewModel
@{
    ViewData["Title"] = "Thông tin cá nhân";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}

<!-- Toast Container -->
<div class="profile-toast-container" id="profileToastContainer"></div>

<div class="profile-container">
    <!-- Header Section -->
    <div class="profile-header">
        <div class="profile-avatar-section">
            <div class="avatar-container @(Model.HasProfileImage ? "has-image" : "no-image")">
                <img id="profileAvatar" 
                     src="@Model.GetProfileImageUrl(Configuration["Apis:Backend"])" 
                     alt="@Model.GetDisplayName()" 
                     class="profile-avatar" />
                <div class="avatar-overlay">
                    <button type="button" class="btn btn-sm btn-primary" onclick="openImageUpload()">
                        <i class="bi bi-camera"></i>
                    </button>
                </div>
            </div>
            <div class="avatar-actions" id="avatarActions">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="openImageUpload()">
                    <i class="bi bi-camera me-1"></i>Đổi ảnh
                </button>
                @if (Model.HasProfileImage)
                {
                    <button type="button" id="deleteImageBtn" class="btn btn-outline-danger btn-sm" onclick="deleteProfileImage()">
                        <i class="bi bi-trash me-1"></i>Xóa ảnh
                    </button>
                }
            </div>
        </div>
        
        <div class="profile-info">
            <h1 class="profile-name">@Model.GetDisplayName()</h1>
            <p class="profile-email">@Model.Email</p>
            <div class="profile-meta">
                <span class="meta-item">
                    <i class="bi bi-person-badge"></i>
                    @Model.Role
                </span>
                <span class="meta-item">
                    <i class="bi bi-calendar-event"></i>
                    Tham gia @Model.CreatedAt?.ToString("dd/MM/yyyy")
                </span>
            </div>
        </div>
    </div>

    <!-- Profile Completion -->
    <div class="profile-completion-card">
        <div class="completion-header">
            <h3><i class="bi bi-clipboard-check me-2"></i>Hoàn thiện hồ sơ</h3>
            <span class="completion-percentage" id="completionPercentage">@Model.GetProfileCompletionPercentage()%</span>
        </div>
        <div class="completion-progress">
            <div class="progress-bar" id="progressBar" style="width: @Model.GetProfileCompletionPercentage()%"></div>
        </div>
        <div class="completion-items">
            <div class="completion-item @(string.IsNullOrEmpty(Model.FullName) ? "incomplete" : "complete")" 
                 data-field="fullname" 
                 data-complete="@(string.IsNullOrEmpty(Model.FullName) ? "false" : "true")">
                <i class="bi bi-@(string.IsNullOrEmpty(Model.FullName) ? "x-circle" : "check-circle")"></i>
                <span>Họ và tên</span>
            </div>
            <div class="completion-item @(string.IsNullOrEmpty(Model.PhoneNumber) ? "incomplete" : "complete")" 
                 data-field="phone" 
                 data-complete="@(string.IsNullOrEmpty(Model.PhoneNumber) ? "false" : "true")">
                <i class="bi bi-@(string.IsNullOrEmpty(Model.PhoneNumber) ? "x-circle" : "check-circle")"></i>
                <span>Số điện thoại</span>
            </div>
            <div class="completion-item @(string.IsNullOrEmpty(Model.Address) ? "incomplete" : "complete")" 
                 data-field="address" 
                 data-complete="@(string.IsNullOrEmpty(Model.Address) ? "false" : "true")">
                <i class="bi bi-@(string.IsNullOrEmpty(Model.Address) ? "x-circle" : "check-circle")"></i>
                <span>Địa chỉ</span>
            </div>
            <div class="completion-item @(!Model.HasProfileImage ? "incomplete" : "complete")" 
                 data-field="avatar" 
                 data-complete="@(!Model.HasProfileImage ? "false" : "true")">
                <i class="bi bi-@(!Model.HasProfileImage ? "x-circle" : "check-circle")"></i>
                <span>Ảnh đại diện</span>
            </div>
        </div>
    </div>

    <!-- Profile Details -->
    <div class="profile-details-grid">
        <!-- Personal Information Card -->
        <div class="detail-card">
            <div class="card-header">
                <h3><i class="bi bi-person"></i> Thông tin cá nhân</h3>
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="bi bi-pencil"></i> Chỉnh sửa
                </button>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <label><i class="bi bi-person-circle me-2"></i>Tên tài khoản</label>
                    <span>@Model.AccountName</span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-envelope-fill me-2"></i>Email</label>
                    <span>@Model.Email</span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-person-fill me-2"></i>Họ và tên</label>
                    <span class="@(string.IsNullOrEmpty(Model.FullName) ? "text-muted" : "")">
                        @if (string.IsNullOrEmpty(Model.FullName))
                        {
                            <span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>
                        }
                        else
                        {
                            @Model.FullName
                        }
                    </span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-telephone-fill me-2"></i>Số điện thoại</label>
                    <span class="@(string.IsNullOrEmpty(Model.PhoneNumber) ? "text-muted" : "")">
                        @if (string.IsNullOrEmpty(Model.PhoneNumber))
                        {
                            <span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>
                        }
                        else
                        {
                            @Model.PhoneNumber
                        }
                    </span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-geo-alt-fill me-2"></i>Địa chỉ</label>
                    <span class="@(string.IsNullOrEmpty(Model.Address) ? "text-muted" : "")">
                        @if (string.IsNullOrEmpty(Model.Address))
                        {
                            <span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>
                        }
                        else
                        {
                            @Model.Address
                        }
                    </span>
                </div>
            </div>
        </div>

        <!-- Account Security Card -->
        <div class="detail-card">
            <div class="card-header">
                <h3><i class="bi bi-shield-lock"></i> Bảo mật tài khoản</h3>
            </div>
            <div class="card-body">
                <div class="security-item">
                    <div class="security-info">
                        <i class="bi bi-key"></i>
                        <div>
                            <h4>Mật khẩu</h4>
                            <p>Đổi mật khẩu để bảo mật tài khoản</p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        <i class="bi bi-pencil"></i> Đổi mật khẩu
                    </button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <i class="bi bi-envelope"></i>
                        <div>
                            <h4>Email</h4>
                            <p>Đổi email đăng nhập</p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#changeEmailModal">
                        <i class="bi bi-pencil"></i> Đổi email
                    </button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <i class="bi bi-shop"></i>
                        <div>
                            <h4>Đăng ký nhà cung cấp</h4>
                            <p>Đăng ký trở thành nhà cung cấp dịch vụ</p>
                        </div>
                    </div>
                    <a asp-area="Customer" asp-controller="RegisterProvider" asp-action="Register" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-person-plus"></i> Đăng ký
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Statistics Card -->
    <div class="detail-card stats-card-full">
        <div class="card-header">
            <h3><i class="bi bi-graph-up"></i> Thống kê tài khoản</h3>
        </div>
        <div class="card-body stats-body">
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">@Model.CompletedOrdersCount</span>
                    <span class="stat-label">Đơn hàng đã hoàn thành</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="bi bi-star"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">@Model.ReviewsCount</span>
                    <span class="stat-label">Đánh giá đã viết</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">@((DateTime.Now - (Model.CreatedAt ?? DateTime.Now)).Days)</span>
                    <span class="stat-label">Ngày tham gia</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="imageUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đổi ảnh đại diện</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="profileImage" class="form-label">Chọn ảnh</label>
                        <input type="file" class="form-control" id="profileImage" name="image" accept="image/*" required>
                        <div class="form-text">Chỉ chấp nhận file JPG, PNG, GIF, BMP, WEBP (tối đa 5MB)</div>
                    </div>
                    <div class="image-preview" id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="uploadProfileImage()">
                    <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner"></span>
                    <i class="bi bi-upload" id="uploadIcon"></i>
                    Tải lên
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa thông tin cá nhân
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProfileForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" name="AccountName" value="@Model.AccountName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="Email" value="@Model.Email" readonly />
                        <small class="text-muted">Email không thể thay đổi ở đây. Sử dụng "Đổi email" để thay đổi.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Họ và tên</label>
                        <input type="text" class="form-control" name="FullName" value="@Model.FullName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" 
                               class="form-control" 
                               name="PhoneNumber" 
                               id="phoneNumberInput"
                               value="@Model.PhoneNumber" 
                               placeholder="0907444556 hoặc +84907444556" />
                        <div class="invalid-feedback" id="phoneNumberError">
                            Số điện thoại không hợp lệ. Vui lòng nhập 10 số bắt đầu bằng 0 (ví dụ: 0907444556) hoặc +84 (ví dụ: +84907444556)
                        </div>
                        <small class="form-text text-muted">
                            Ví dụ: 0907444556 hoặc +84907444556 (10-11 số). Để trống nếu không có số điện thoại.
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Địa chỉ</label>
                        <textarea class="form-control" name="Address" rows="3">@Model.Address</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2"></i>Đổi mật khẩu
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="changePasswordForm">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Chúng tôi sẽ gửi mã OTP đến email của bạn để xác minh.
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Mật khẩu hiện tại</label>
                            <input type="password" class="form-control" name="CurrentPassword" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Mật khẩu mới</label>
                            <input type="password" class="form-control" name="NewPassword" 
                                   pattern=".{6,}"
                               required />
                            <small class="text-muted">Tối thiểu 6 ký tự</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Xác nhận mật khẩu mới</label>
                            <input type="password" class="form-control" name="ConfirmPassword" required />
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Mã OTP</label>
                                <button type="button" class="btn btn-link btn-sm p-0" id="btnRequestOTP">
                                    <i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP
                                </button>
                            </div>
                            <input type="text" class="form-control" name="OTP" maxlength="6" 
                                   pattern="\d{6}" placeholder="Nhập 6 chữ số" required />
                            <small class="text-muted" id="otpTimer"></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-2"></i>Đổi mật khẩu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Email Modal -->
    <div class="modal fade" id="changeEmailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-envelope me-2"></i>Đổi email
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="changeEmailForm">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Chúng tôi sẽ gửi mã OTP đến email hiện tại <strong>(@Model.Email)</strong> để xác minh.
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email mới</label>
                            <input type="email" class="form-control" name="NewEmail" required />
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Mã OTP</label>
                                <button type="button" class="btn btn-link btn-sm p-0" id="btnRequestEmailOTP">
                                    <i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP
                                </button>
                            </div>
                            <input type="text" class="form-control" name="OTP" id="emailOtpInput" maxlength="6" 
                                   pattern="\d{6}" placeholder="Nhập 6 chữ số" required />
                            <span class="text-danger" id="emailOtpError" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;"></span>
                            <small class="text-muted" id="emailOtpTimer"></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-2"></i>Đổi email
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

@section Scripts {
    <script src="~/js/image-helper.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Profile page script loaded');
            
            // Xóa tất cả tooltip (title attribute)
            $('[title]').removeAttr('title');
            
            // Xóa tooltip từ Bootstrap nếu có
            $('[data-bs-toggle="tooltip"]').removeAttr('data-bs-toggle').removeAttr('data-bs-title');
            $('[data-toggle="tooltip"]').removeAttr('data-toggle').removeAttr('title');
            
            // Make functions global
            window.openImageUpload = function() {
                console.log('Opening image upload modal');
                const modalElement = document.getElementById('imageUploadModal');
                if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modal = new bootstrap.Modal(modalElement);
                    
                    // Reset form and button state when opening modal
                    const form = document.getElementById('imageUploadForm');
                    if (form) {
                        form.reset();
                    }
                    const imagePreview = document.getElementById('imagePreview');
                    if (imagePreview) {
                        imagePreview.style.display = 'none';
                    }
                    
                    // Reset upload button state
                    const uploadBtn = modalElement.querySelector('.btn-primary');
                    if (uploadBtn) {
                        uploadBtn.disabled = false;
                    }
                    const uploadSpinner = document.getElementById('uploadSpinner');
                    if (uploadSpinner) {
                        uploadSpinner.classList.add('d-none');
                    }
                    const uploadIcon = document.getElementById('uploadIcon');
                    if (uploadIcon) {
                        uploadIcon.style.display = 'inline';
                    }
                    
                    // Reset preview URL
                    currentPreviewImageUrl = null;
                    
                    modal.show();
                } else {
                    console.error('Bootstrap Modal not available');
                }
            };

            window.deleteProfileImage = async function() {
                if (!confirm('Bạn có chắc muốn xóa ảnh đại diện?')) {
                    return;
                }
                
                try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (!token) {
                        showToast('Không tìm thấy token bảo mật', 'error');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('__RequestVerificationToken', token.value);
                    
                    const response = await fetch('@Url.Action("DeleteImage", "Profile", new { area = "Customer" })', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Delete result:', result);
                    
                    if (result.success) {
                        showToast('Xóa ảnh thành công!', 'success');
                        
                        // Update avatar to default
                        const avatarImg = document.getElementById('profileAvatar');
                        if (avatarImg) {
                            avatarImg.src = '/images/default-avatar.png?t=' + new Date().getTime();
                        }
                        
                        // Update avatar container class
                        const avatarContainer = document.querySelector('.avatar-container');
                        if (avatarContainer) {
                            avatarContainer.classList.remove('has-image');
                            avatarContainer.classList.add('no-image');
                        }
                        
                        // Hide delete button
                        toggleDeleteImageButton(false);
                        
                        // Update completion item
                        updateCompletionItem('avatar', false);
                        
                        // Update percentage
                        updateCompletionPercentage();
                        
                        // Reload page after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra khi xóa ảnh', 'error');
                        console.error('Delete failed:', result);
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('Có lỗi xảy ra khi xóa ảnh: ' + error.message, 'error');
                }
            };

            // Store preview image URL globally for use in upload function
            let currentPreviewImageUrl = null;

            window.uploadProfileImage = async function() {
                console.log('uploadProfileImage called');
                const fileInput = document.getElementById('profileImage');
                if (!fileInput) {
                    console.error('File input not found');
                    showToast('Không tìm thấy input file', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                const uploadBtn = document.querySelector('#imageUploadModal .btn-primary');
                const uploadSpinner = document.getElementById('uploadSpinner');
                const uploadIcon = document.getElementById('uploadIcon');
                
                // Check if button is already disabled (prevent double click)
                if (uploadBtn && uploadBtn.disabled) {
                    console.log('Upload button is already disabled, ignoring click');
                    return;
                }
                
                if (!file) {
                    showToast('Vui lòng chọn ảnh để tải lên', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showToast('Kích thước file không được vượt quá 5MB', 'error');
                    return;
                }

                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    showToast('Chỉ chấp nhận file ảnh JPG, PNG, GIF, BMP, WEBP', 'error');
                    return;
                }

                // Get preview image URL for immediate update
                // Use the globally stored preview URL, or try to get from preview element
                let previewImageUrl = currentPreviewImageUrl;
                if (!previewImageUrl) {
                    const previewImg = document.getElementById('previewImg');
                    if (previewImg && previewImg.src && previewImg.src.startsWith('data:')) {
                        previewImageUrl = previewImg.src;
                    }
                }

                // Show loading state
                if (uploadBtn) uploadBtn.disabled = true;
                if (uploadSpinner) uploadSpinner.classList.remove('d-none');
                if (uploadIcon) uploadIcon.style.display = 'none';

                const formData = new FormData();
                formData.append('image', file);
                
                // Get AntiForgeryToken
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }
                
                try {
                    const response = await fetch('@Url.Action("UploadImage", "Profile", new { area = "Customer" })', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Upload result:', result);
                    
                    if (result.success) {
                        showToast('Tải ảnh lên thành công!', 'success');
                        
                        // Immediately update avatar with preview image (from FileReader) for instant feedback
                        const avatarImg = document.getElementById('profileAvatar');
                        if (avatarImg) {
                            // Use preview image first for immediate visual feedback
                            if (previewImageUrl && previewImageUrl.startsWith('data:')) {
                                avatarImg.src = previewImageUrl;
                                // Force image to reload
                                avatarImg.onload = function() {
                                    this.style.opacity = '1';
                                };
                            }
                        
                        // Update avatar container class
                        const avatarContainer = document.querySelector('.avatar-container');
                        if (avatarContainer) {
                            avatarContainer.classList.remove('no-image');
                            avatarContainer.classList.add('has-image');
                            }
                        }
                        
                        // Show delete button
                        toggleDeleteImageButton(true);
                        
                        // Update completion item
                        updateCompletionItem('avatar', true);
                        
                        // Update percentage
                        updateCompletionPercentage();
                        
                        // Close modal and reset form
                        const modal = bootstrap.Modal.getInstance(document.getElementById('imageUploadModal'));
                        if (modal) modal.hide();
                        
                        // Reset form and preview
                        const form = document.getElementById('imageUploadForm');
                        if (form) form.reset();
                        const preview = document.getElementById('imagePreview');
                        if (preview) preview.style.display = 'none';
                        
                        // Reset button state
                        if (uploadBtn) uploadBtn.disabled = false;
                        if (uploadSpinner) uploadSpinner.classList.add('d-none');
                        if (uploadIcon) uploadIcon.style.display = 'inline';
                        currentPreviewImageUrl = null;
                        
                        // Update avatar with server URL after a delay to ensure it's saved
                        // First try to get URL from response
                        let serverImageUrl = result.imageUrl || result.imagePath || result.data?.imageUrl;
                        if (serverImageUrl && avatarImg) {
                            // Construct full URL if needed
                            if (!serverImageUrl.startsWith('http://') && !serverImageUrl.startsWith('https://')) {
                                const backendUrl = '@(Configuration["Apis:Backend"] ?? "https://apivhs.cuahangkinhdoanh.com")';
                                serverImageUrl = backendUrl + (serverImageUrl.startsWith('/') ? '' : '/') + serverImageUrl;
                            }
                            
                            // Update with server URL after a short delay
                            setTimeout(() => {
                                if (avatarImg) {
                                    avatarImg.src = serverImageUrl + '?t=' + new Date().getTime();
                                }
                            }, 500);
                        } else {
                            // If no URL in response, reload page to get updated image
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        }
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra khi tải ảnh lên', 'error');
                        console.error('Upload failed:', result);
                        
                        // Reset loading state on error
                        if (uploadBtn) uploadBtn.disabled = false;
                        if (uploadSpinner) uploadSpinner.classList.add('d-none');
                        if (uploadIcon) uploadIcon.style.display = 'inline';
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showToast('Có lỗi xảy ra khi tải ảnh lên: ' + error.message, 'error');
                    
                    // Reset loading state on error
                    if (uploadBtn) uploadBtn.disabled = false;
                    if (uploadSpinner) uploadSpinner.classList.add('d-none');
                    if (uploadIcon) uploadIcon.style.display = 'inline';
                }
            };

            // Preview image
            const profileImageInput = document.getElementById('profileImage');
            if (profileImageInput) {
                profileImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const uploadBtn = document.querySelector('#imageUploadModal .btn-primary');
                    
                    // Enable upload button when file is selected
                    if (uploadBtn) {
                        uploadBtn.disabled = false;
                    }
                    
                    if (file) {
                        // Validate file before showing preview
                        if (file.size > 5 * 1024 * 1024) {
                            showToast('Kích thước file không được vượt quá 5MB', 'error');
                            e.target.value = ''; // Clear input
                            if (uploadBtn) uploadBtn.disabled = true;
                            return;
                        }
                        
                        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
                        if (!allowedTypes.includes(file.type)) {
                            showToast('Chỉ chấp nhận file ảnh JPG, PNG, GIF, BMP, WEBP', 'error');
                            e.target.value = ''; // Clear input
                            if (uploadBtn) uploadBtn.disabled = true;
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewUrl = e.target.result;
                            currentPreviewImageUrl = previewUrl; // Store globally
                            const previewImg = document.getElementById('previewImg');
                            const imagePreview = document.getElementById('imagePreview');
                            if (previewImg) {
                                previewImg.src = previewUrl;
                            }
                            if (imagePreview) {
                                imagePreview.style.display = 'block';
                            }
                            
                            // Ensure upload button is enabled
                            if (uploadBtn) {
                                uploadBtn.disabled = false;
                            }
                        };
                        reader.onerror = function() {
                            showToast('Lỗi khi đọc file ảnh', 'error');
                            if (uploadBtn) uploadBtn.disabled = true;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        currentPreviewImageUrl = null;
                        const imagePreview = document.getElementById('imagePreview');
                        if (imagePreview) {
                            imagePreview.style.display = 'none';
                        }
                        // Disable upload button if no file
                        if (uploadBtn) uploadBtn.disabled = true;
                    }
                });
            }
            
            // Ensure upload button is initially disabled until file is selected
            const modalElement = document.getElementById('imageUploadModal');
            if (modalElement) {
                modalElement.addEventListener('show.bs.modal', function() {
                    const uploadBtn = modalElement.querySelector('.btn-primary');
                    const fileInput = document.getElementById('profileImage');
                    if (uploadBtn && fileInput) {
                        // Enable button only if file is already selected
                        uploadBtn.disabled = !fileInput.files || fileInput.files.length === 0;
                    }
                });
            }

            // Function to calculate and update completion percentage
            function updateCompletionPercentage() {
                const items = document.querySelectorAll('.completion-item');
                let completedCount = 0;
                const totalFields = 4;
                
                items.forEach(item => {
                    const isComplete = item.getAttribute('data-complete') === 'true';
                    if (isComplete) {
                        completedCount++;
                    }
                });
                
                const percentage = Math.round((completedCount / totalFields) * 100);
                
                // Update percentage text
                const percentageEl = document.getElementById('completionPercentage');
                if (percentageEl) {
                    percentageEl.textContent = percentage + '%';
                }
                
                // Update progress bar
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
                
                return percentage;
            }
            
            // Function to show/hide delete image button
            function toggleDeleteImageButton(show) {
                const avatarActions = document.getElementById('avatarActions');
                if (!avatarActions) return;
                
                let deleteBtn = document.getElementById('deleteImageBtn');
                
                if (show) {
                    // Show button if it doesn't exist
                    if (!deleteBtn) {
                        deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.id = 'deleteImageBtn';
                        deleteBtn.className = 'btn btn-outline-danger btn-sm';
                        deleteBtn.onclick = deleteProfileImage;
                        deleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Xóa ảnh';
                        avatarActions.appendChild(deleteBtn);
                    } else {
                        deleteBtn.style.display = '';
                    }
                } else {
                    // Hide button
                    if (deleteBtn) {
                        deleteBtn.style.display = 'none';
                    }
                }
            }
            
            // Function to update completion item status
            function updateCompletionItem(fieldName, isComplete) {
                const item = document.querySelector(`.completion-item[data-field="${fieldName}"]`);
                if (item) {
                    item.setAttribute('data-complete', isComplete ? 'true' : 'false');
                    const icon = item.querySelector('i');
                    if (icon) {
                        if (isComplete) {
                            item.classList.remove('incomplete');
                            item.classList.add('complete');
                            icon.className = 'bi bi-check-circle';
                        } else {
                            item.classList.remove('complete');
                            item.classList.add('incomplete');
                            icon.className = 'bi bi-x-circle';
                        }
                    }
                }
            }
            
            // Function to update profile info display
            function updateProfileInfo(fieldName, value) {
                if (!value || value.trim() === '') {
                    value = '';
                } else {
                    value = value.trim();
                }
                
                const infoRows = document.querySelectorAll('.info-row');
                infoRows.forEach(row => {
                    const label = row.querySelector('label');
                    if (!label) return;
                    
                    const span = row.querySelector('span');
                    if (!span) return;
                    
                    let shouldUpdate = false;
                    if (fieldName === 'fullname' && (label.textContent.includes('Họ và tên') || label.textContent.includes('FullName'))) {
                        shouldUpdate = true;
                    } else if (fieldName === 'phone' && (label.textContent.includes('Số điện thoại') || label.textContent.includes('PhoneNumber'))) {
                        shouldUpdate = true;
                    } else if (fieldName === 'address' && (label.textContent.includes('Địa chỉ') || label.textContent.includes('Address'))) {
                        shouldUpdate = true;
                    }
                    
                    if (shouldUpdate) {
                        // Remove badge if exists
                        const badge = span.querySelector('.badge');
                        if (badge) {
                            badge.remove();
                        }
                        
                        if (value && value.trim() !== '') {
                        span.innerHTML = value;
                        span.classList.remove('text-muted');
                        } else {
                            span.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>';
                            span.classList.add('text-muted');
                        }
                    }
                });
            }
            
            // Phone number validation function
            window.validatePhoneNumber = function(input) {
                if (!input) return false;
                
                const phoneNumber = input.value.trim();
                const phoneError = document.getElementById('phoneNumberError');
                
                // Remove all non-digit characters except + for validation
                const cleaned = phoneNumber.replace(/[^\d+]/g, '');
                
                // Vietnamese phone number patterns
                // 10 digits starting with 0 (e.g., 0123456789)
                // 11-12 characters starting with +84 (e.g., +84123456789)
                const phonePattern = /^(0[0-9]{9}|\+84[0-9]{9,10})$/;
                
                if (phoneNumber === '') {
                    // Empty is allowed (optional field)
                    input.classList.remove('is-invalid', 'is-valid');
                    if (phoneError) {
                        phoneError.style.display = 'none';
                        phoneError.classList.remove('show');
                    }
                    return true;
                }
                
                if (!phonePattern.test(cleaned)) {
                    input.classList.add('is-invalid');
                    input.classList.remove('is-valid');
                    if (phoneError) {
                        phoneError.style.display = 'block';
                        phoneError.classList.add('show');
                        phoneError.textContent = 'Số điện thoại không hợp lệ. Vui lòng nhập 10 số bắt đầu bằng 0 (ví dụ: 0123456789) hoặc +84 (ví dụ: +84123456789)';
                    }
                    return false;
                } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                    if (phoneError) {
                        phoneError.style.display = 'none';
                        phoneError.classList.remove('show');
                    }
                    // Update input value to cleaned format if different
                    if (cleaned !== phoneNumber && cleaned !== input.value) {
                        input.value = cleaned;
                    }
                    return true;
                }
            };
            
            // Real-time phone number formatting and validation
            $(document).ready(function() {
                function setupPhoneValidation() {
                    const phoneInput = document.getElementById('phoneNumberInput');
                    if (!phoneInput) return;
                    
                    // Check if already set up to avoid duplicate listeners
                    if (phoneInput.dataset.validationSetup === 'true') return;
                    phoneInput.dataset.validationSetup = 'true';
                    
                    // Format on input
                    phoneInput.addEventListener('input', function(e) {
                        let value = e.target.value;
                        const originalValue = value;
                        
                        // Remove all non-digit characters except +
                        value = value.replace(/[^\d+]/g, '');
                        
                        // Limit length based on format
                        if (value.startsWith('+84')) {
                            if (value.length > 13) value = value.substring(0, 13);
                        } else if (value.startsWith('0')) {
                            if (value.length > 10) value = value.substring(0, 10);
                        } else if (value.length > 0 && !value.startsWith('+')) {
                            // If starts with number other than 0, prepend 0
                            if (/^[1-9]/.test(value)) {
                                value = '0' + value;
                            }
                            if (value.length > 10) value = value.substring(0, 10);
                        }
                        
                        // Update value if changed
                        if (value !== originalValue) {
                            e.target.value = value;
                        }
                        
                        // Validate
                        validatePhoneNumber(e.target);
                    });
                    
                    // Validate on blur
                    phoneInput.addEventListener('blur', function(e) {
                        validatePhoneNumber(e.target);
                    });
                    
                    // Initial validation if value exists
                    if (phoneInput.value) {
                        validatePhoneNumber(phoneInput);
                    }
                }
                
                // Setup validation initially
                setupPhoneValidation();
                
                // Re-setup validation when modal is shown (in case modal content is re-rendered)
                const editModal = document.getElementById('editProfileModal');
                if (editModal) {
                    editModal.addEventListener('shown.bs.modal', function() {
                        // Reset the flag to allow re-setup
                        const phoneInput = document.getElementById('phoneNumberInput');
                        if (phoneInput) {
                            phoneInput.dataset.validationSetup = 'false';
                        }
                        setupPhoneValidation();
                    });
                }
            });
            
            // Modal form handlers
            const editForm = document.getElementById('editProfileForm');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validate phone number before submit
                    const phoneInput = document.getElementById('phoneNumberInput');
                    if (phoneInput && !validatePhoneNumber(phoneInput)) {
                        showToast('Vui lòng nhập số điện thoại hợp lệ', 'error');
                        phoneInput.focus();
                        return;
                    }
                    
                    const formData = new FormData(this);
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
                    
                    // Show loading state
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Đang lưu...';
                    }
                    
                    try {
                        const response = await fetch('@Url.Action("UpdateProfile", "Profile", new { area = "Customer" })', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('Update result:', result);
                        
                        if (result.success) {
                            showToast('Cập nhật thông tin thành công!', 'success');
                            
                            // Update completion items based on form data
                            const fullName = formData.get('FullName');
                            const phoneNumber = formData.get('PhoneNumber');
                            const address = formData.get('Address');
                            
                            if (fullName && fullName.trim() !== '') {
                                updateCompletionItem('fullname', true);
                                updateProfileInfo('fullname', fullName.trim());
                            } else {
                                updateCompletionItem('fullname', false);
                            }
                            
                            if (phoneNumber && phoneNumber.trim() !== '') {
                                updateCompletionItem('phone', true);
                                updateProfileInfo('phone', phoneNumber.trim());
                            } else {
                                updateCompletionItem('phone', false);
                            }
                            
                            if (address && address.trim() !== '') {
                                updateCompletionItem('address', true);
                                updateProfileInfo('address', address.trim());
                            } else {
                                updateCompletionItem('address', false);
                            }
                            
                            // Update percentage
                            updateCompletionPercentage();
                            
                            // Close modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                            if (modal) modal.hide();
                            
                            // Reload page after a short delay to ensure all updates are visible
                            setTimeout(() => {
                                location.reload();
                            }, 500);
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra khi cập nhật thông tin', 'error');
                            console.error('Update failed:', result);
                        }
                    } catch (error) {
                        console.error('Update error:', error);
                        showToast('Có lỗi xảy ra khi cập nhật thông tin: ' + error.message, 'error');
                    } finally {
                        // Reset button state
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    }
                });
            }

            // Request OTP for password change
            const btnRequestOTP = document.getElementById('btnRequestOTP');
            if (btnRequestOTP) {
                btnRequestOTP.addEventListener('click', async function() {
                    console.log('Requesting password change OTP...');
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Đang gửi...';
                    
                    try {
                        const response = await fetch('@Url.Action("RequestPasswordChangeOTP")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            showToast('Mã OTP đã được gửi đến email của bạn. Vui lòng kiểm tra email.', 'success');
                            this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Đã gửi';
                            // Countdown timer (2 phút = 120 giây)
                            let countdown = 120;
                            const timer = setInterval(() => {
                                countdown--;
                                if (countdown > 0) {
                                    // Format thời gian: phút:giây (ví dụ: 2:00, 1:59, 0:30)
                                    const minutes = Math.floor(countdown / 60);
                                    const seconds = countdown % 60;
                                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                                    this.innerHTML = `<i class="bi bi-clock me-1"></i>Gửi lại (${timeString})`;
                                } else {
                                    clearInterval(timer);
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                                }
                            }, 1000);
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra khi gửi OTP', 'error');
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                        }
                    } catch (error) {
                        console.error('Error requesting OTP:', error);
                        showToast('Có lỗi xảy ra khi gửi OTP', 'error');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                    }
                });
            }

            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    try {
                        const response = await fetch('@Url.Action("ChangePassword")', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast('Đổi mật khẩu thành công!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                            this.reset();
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra', 'error');
                        }
                    } catch (error) {
                        showToast('Có lỗi xảy ra khi đổi mật khẩu', 'error');
                    }
                });
            }

            // Request OTP for email change
            const btnRequestEmailOTP = document.getElementById('btnRequestEmailOTP');
            if (btnRequestEmailOTP) {
                btnRequestEmailOTP.addEventListener('click', async function() {
                    console.log('Requesting email change OTP...');
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Đang gửi...';
                    
                    try {
                        const response = await fetch('@Url.Action("RequestEmailChangeOTP")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            showToast('Mã OTP đã được gửi đến email hiện tại của bạn. Vui lòng kiểm tra email.', 'success');
                            this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Đã gửi';
                            // Countdown timer (2 phút = 120 giây)
                            let countdown = 120;
                            const timer = setInterval(() => {
                                countdown--;
                                if (countdown > 0) {
                                    // Format thời gian: phút:giây (ví dụ: 2:00, 1:59, 0:30)
                                    const minutes = Math.floor(countdown / 60);
                                    const seconds = countdown % 60;
                                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                                    this.innerHTML = `<i class="bi bi-clock me-1"></i>Gửi lại (${timeString})`;
                                } else {
                                    clearInterval(timer);
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                                }
                            }, 1000);
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra khi gửi OTP', 'error');
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                        }
                    } catch (error) {
                        console.error('Error requesting email OTP:', error);
                        showToast('Có lỗi xảy ra khi gửi OTP', 'error');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                    }
                });
            }

            // Translate error messages to Vietnamese
            function translateError(message) {
                if (!message) return message;
                
                const errorMap = {
                    // OTP errors
                    'OTP code is required': 'Mã OTP là bắt buộc',
                    'OTP code must be exactly 6 digits': 'Mã OTP phải có đúng 6 chữ số',
                    'OTP is required': 'Mã OTP là bắt buộc',
                    'OTP must be exactly 6 digits': 'Mã OTP phải có đúng 6 chữ số',
                    'Invalid OTP': 'Mã OTP không hợp lệ',
                    'OTP has expired': 'Mã OTP đã hết hạn',
                    'OTP expired': 'Mã OTP đã hết hạn',
                    
                    // Email errors
                    'Email is required': 'Email là bắt buộc',
                    'Email is invalid': 'Email không hợp lệ',
                    'Email already exists': 'Email đã tồn tại',
                    'This email is already in use': 'Email này đã được sử dụng',
                    
                    // General errors
                    'Bad request': 'Yêu cầu không hợp lệ',
                    'Unauthorized': 'Bạn chưa đăng nhập hoặc phiên đăng nhập đã hết hạn',
                    'Not found': 'Không tìm thấy dữ liệu',
                    'Internal server error': 'Lỗi hệ thống. Vui lòng thử lại sau',
                };
                
                // Check exact match first
                if (errorMap[message]) {
                    return errorMap[message];
                }
                
                // Check case-insensitive match
                const lowerMessage = message.toLowerCase();
                for (const [key, value] of Object.entries(errorMap)) {
                    if (lowerMessage.includes(key.toLowerCase())) {
                        return value;
                    }
                }
                
                // Check for common patterns
                if (lowerMessage.includes('otp') && lowerMessage.includes('required')) {
                    return 'Mã OTP là bắt buộc';
                }
                if (lowerMessage.includes('otp') && (lowerMessage.includes('digit') || lowerMessage.includes('6'))) {
                    return 'Mã OTP phải có đúng 6 chữ số';
                }
                if (lowerMessage.includes('otp') && (lowerMessage.includes('invalid') || lowerMessage.includes('không hợp lệ'))) {
                    return 'Mã OTP không hợp lệ';
                }
                if (lowerMessage.includes('otp') && (lowerMessage.includes('expired') || lowerMessage.includes('hết hạn'))) {
                    return 'Mã OTP đã hết hạn';
                }
                if (lowerMessage.includes('email') && lowerMessage.includes('required')) {
                    return 'Email là bắt buộc';
                }
                if (lowerMessage.includes('email') && (lowerMessage.includes('invalid') || lowerMessage.includes('không hợp lệ'))) {
                    return 'Email không hợp lệ';
                }
                if (lowerMessage.includes('email') && (lowerMessage.includes('already') || lowerMessage.includes('tồn tại'))) {
                    return 'Email đã tồn tại';
                }
                
                return message;
            }
            
            // Validate Email OTP Input (similar to ChangePassword)
            function validateEmailOTPInput(value) {
                const emailOtpInput = document.getElementById('emailOtpInput');
                const emailOtpError = document.getElementById('emailOtpError');
                
                if (!emailOtpInput) return false;
                
                const trimmed = (value || '').trim().replace(/\s+/g, '').replace(/-/g, '').replace(/\./g, '');
                
                if (trimmed === '') {
                    emailOtpInput.classList.remove('is-valid');
                    emailOtpInput.classList.add('is-invalid');
                    if (emailOtpError) {
                        emailOtpError.textContent = 'Mã OTP không được để trống';
                        emailOtpError.style.display = 'block';
                    }
                    return false;
                }
                
                if (trimmed.length !== 6) {
                    emailOtpInput.classList.remove('is-valid');
                    emailOtpInput.classList.add('is-invalid');
                    if (emailOtpError) {
                        emailOtpError.textContent = 'Mã OTP phải có đúng 6 chữ số';
                        emailOtpError.style.display = 'block';
                    }
                    return false;
                }
                
                if (!/^[0-9]{6}$/.test(trimmed)) {
                    emailOtpInput.classList.remove('is-valid');
                    emailOtpInput.classList.add('is-invalid');
                    if (emailOtpError) {
                        emailOtpError.textContent = 'Mã OTP chỉ được chứa số';
                        emailOtpError.style.display = 'block';
                    }
                    return false;
                }
                
                // Valid OTP - update input value to cleaned version
                if (emailOtpInput.value !== trimmed) {
                    emailOtpInput.value = trimmed;
                }
                emailOtpInput.classList.remove('is-invalid');
                emailOtpInput.classList.add('is-valid');
                if (emailOtpError) {
                    emailOtpError.textContent = '';
                    emailOtpError.style.display = 'none';
                }
                return true;
            }
            
            // Clear OTP errors when ChangeEmail modal is opened
            const changeEmailModal = document.getElementById('changeEmailModal');
            if (changeEmailModal) {
                changeEmailModal.addEventListener('show.bs.modal', function() {
                    const emailOtpInput = document.getElementById('emailOtpInput');
                    const emailOtpError = document.getElementById('emailOtpError');
                    if (emailOtpInput) {
                        emailOtpInput.value = '';
                        emailOtpInput.classList.remove('is-invalid', 'is-valid');
                    }
                    if (emailOtpError) {
                        emailOtpError.textContent = '';
                        emailOtpError.style.display = 'none';
                    }
                });
            }
            
            // Setup OTP input validation for ChangeEmail
            const emailOtpInput = document.getElementById('emailOtpInput');
            if (emailOtpInput) {
                // Input event - chỉ cho phép số và tự động clean
                emailOtpInput.addEventListener('input', function(e) {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;
                    
                    // Validate when has value
                    if (value.length > 0) {
                        validateEmailOTPInput(value);
                    } else {
                        emailOtpInput.classList.remove('is-invalid', 'is-valid');
                        const emailOtpError = document.getElementById('emailOtpError');
                        if (emailOtpError) {
                            emailOtpError.style.display = 'none';
                        }
                    }
                });

                emailOtpInput.addEventListener('blur', function() {
                    validateEmailOTPInput(this.value);
                });

                // Ngăn chặn nhập ký tự không phải số
                emailOtpInput.addEventListener('keydown', function(e) {
                    if (e.key.length === 1 && !/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });

                // Xử lý paste
                emailOtpInput.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
                    e.target.value = digits;
                    if (digits.length > 0) {
                        validateEmailOTPInput(digits);
                    }
                });
            }
            
            const changeEmailForm = document.getElementById('changeEmailForm');
            if (changeEmailForm) {
                changeEmailForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Get OTP input
                    const emailOtpInput = document.getElementById('emailOtpInput');
                    const emailOtpError = document.getElementById('emailOtpError');
                    
                    // Validate OTP before submit
                    let isValid = true;
                    let otpValue = '';
                    
                    console.log('[ChangeEmail] Starting validation...');
                    console.log('[ChangeEmail] OTP Input element:', emailOtpInput);
                    
                    if (!emailOtpInput) {
                        isValid = false;
                        console.error('[ChangeEmail] OTP input not found!');
                        showToast('Không tìm thấy trường nhập OTP', 'error');
                    } else {
                        // Get raw OTP value
                        const rawOtpValue = emailOtpInput.value || '';
                        console.log('[ChangeEmail] Raw OTP value:', rawOtpValue, 'Length:', rawOtpValue.length);
                        
                        // Get and clean OTP value
                        otpValue = rawOtpValue.trim().replace(/\s+/g, '').replace(/-/g, '').replace(/\./g, '');
                        console.log('[ChangeEmail] Cleaned OTP value:', otpValue, 'Length:', otpValue.length);
                        
                        // Validate OTP
                        if (!otpValue || otpValue.length === 0) {
                            isValid = false;
                            console.error('[ChangeEmail] OTP is empty');
                            emailOtpInput.classList.add('is-invalid');
                            emailOtpInput.classList.remove('is-valid');
                            if (emailOtpError) {
                                emailOtpError.textContent = 'Mã OTP không được để trống';
                                emailOtpError.style.display = 'block';
                            }
                            showToast('Vui lòng nhập mã OTP', 'error');
                        } else if (otpValue.length !== 6) {
                            isValid = false;
                            console.error('[ChangeEmail] OTP length is not 6:', otpValue.length);
                            emailOtpInput.classList.add('is-invalid');
                            emailOtpInput.classList.remove('is-valid');
                            if (emailOtpError) {
                                emailOtpError.textContent = 'Mã OTP phải có đúng 6 chữ số';
                                emailOtpError.style.display = 'block';
                            }
                            showToast('Mã OTP phải có đúng 6 chữ số', 'error');
                        } else if (!/^[0-9]{6}$/.test(otpValue)) {
                            isValid = false;
                            console.error('[ChangeEmail] OTP contains non-numeric characters');
                            emailOtpInput.classList.add('is-invalid');
                            emailOtpInput.classList.remove('is-valid');
                            if (emailOtpError) {
                                emailOtpError.textContent = 'Mã OTP chỉ được chứa số';
                                emailOtpError.style.display = 'block';
                            }
                            showToast('Mã OTP chỉ được chứa số', 'error');
                        } else {
                            // Valid OTP - update input value
                            console.log('[ChangeEmail] OTP is valid:', otpValue);
                            if (emailOtpInput.value !== otpValue) {
                                emailOtpInput.value = otpValue;
                                console.log('[ChangeEmail] Updated OTP input value to:', otpValue);
                            }
                            emailOtpInput.classList.remove('is-invalid');
                            emailOtpInput.classList.add('is-valid');
                            if (emailOtpError) {
                                emailOtpError.textContent = '';
                                emailOtpError.style.display = 'none';
                            }
                        }
                    }
                    
                    // If validation fails, stop and focus on OTP input
                    if (!isValid) {
                        console.error('[ChangeEmail] Validation failed, stopping submit');
                        if (emailOtpInput) {
                            emailOtpInput.focus();
                            emailOtpInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return false;
                    }
                    
                    console.log('[ChangeEmail] Validation passed, preparing form data...');
                    
                    // Create form data and ensure OTP is set correctly
                    const formData = new FormData(this);
                    
                    // Log all form data before setting OTP
                    console.log('[ChangeEmail] Form data before OTP update:');
                    for (const pair of formData.entries()) {
                        console.log('  ', pair[0], ':', pair[1]);
                    }
                    
                    // Update OTP in formData with cleaned value
                    formData.set('OTP', otpValue);
                    console.log('[ChangeEmail] OTP set in formData:', otpValue);
                    
                    // Verify OTP is in formData
                    const verifyOtp = formData.get('OTP');
                    console.log('[ChangeEmail] Verified OTP in formData:', verifyOtp);
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
                    
                    // Show loading state
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Đang xử lý...';
                    }
                    
                    try {
                        console.log('[ChangeEmail] Sending request to:', '@Url.Action("ChangeEmail")');
                        const response = await fetch('@Url.Action("ChangeEmail")', {
                            method: 'POST',
                            body: formData
                        });
                        
                        console.log('[ChangeEmail] Response status:', response.status, response.statusText);
                        console.log('[ChangeEmail] Response headers:', response.headers.get('content-type'));
                        
                        // Always read response as text first to handle both JSON and non-JSON responses
                        const responseText = await response.text();
                        console.log('[ChangeEmail] Response text:', responseText);
                        
                        let result;
                        try {
                            result = JSON.parse(responseText);
                            console.log('[ChangeEmail] Parsed JSON result:', result);
                        } catch (parseError) {
                            console.error('[ChangeEmail] Failed to parse JSON:', parseError);
                            // If not JSON, create error result
                            result = { 
                                success: false, 
                                message: responseText.length < 500 ? responseText : 'Có lỗi xảy ra khi đổi email' 
                            };
                        }
                        
                        if (!response.ok) {
                            console.error('[ChangeEmail] Request failed with status:', response.status);
                            // Handle HTTP errors (400, 500, etc.)
                            let errorMessage = result.message || result.Message || result.error || result.Error || 'Có lỗi xảy ra khi đổi email';
                            
                            // If it's a validation error, try to extract more details
                            if (result.errors && typeof result.errors === 'object') {
                                const errorMessages = Object.values(result.errors).flat();
                                if (errorMessages.length > 0) {
                                    errorMessage = errorMessages.map(msg => translateError(msg)).join(', ');
                                }
                            } else {
                                // Translate error message to Vietnamese
                                errorMessage = translateError(errorMessage);
                            }
                            
                            console.error('[ChangeEmail] Error message:', errorMessage);
                            showToast(errorMessage, 'error');
                            
                            // Reset button state
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                            }
                            return;
                        }
                        
                        if (result.success) {
                            showToast('Đổi email thành công!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('changeEmailModal')).hide();
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            let errorMessage = result.message || result.Message || 'Có lỗi xảy ra khi đổi email';
                            // Translate error message to Vietnamese
                            errorMessage = translateError(errorMessage);
                            showToast(errorMessage, 'error');
                            
                            // Reset button state
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                            }
                        }
                    } catch (error) {
                        console.error('Error changing email:', error);
                        showToast('Có lỗi xảy ra khi đổi email: ' + (error.message || 'Vui lòng thử lại'), 'error');
                        
                        // Reset button state
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    }
                });
            }

            // Toast notification function
            function showToast(message, type = 'info') {
                const container = document.getElementById('profileToastContainer');
                if (!container) return;

                // Translate error messages to Vietnamese
                const translatedMessage = type === 'error' ? translateError(message) : message;

                const toast = document.createElement('div');
                toast.className = `profile-toast profile-toast-${type}`;

                const icons = {
                    success: '✓',
                    error: '✕',
                    info: 'ℹ'
                };

                toast.innerHTML = `
                    <span class="profile-toast-icon">${icons[type] || icons.info}</span>
                    <span class="profile-toast-message">${translatedMessage}</span>
                    <button type="button" class="profile-toast-close" onclick="this.parentElement.remove()">×</button>
                `;

                container.appendChild(toast);

                // Auto remove after 3 seconds
                setTimeout(() => {
                    toast.classList.add('slide-out');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Make showToast global
            window.showToast = showToast;

            console.log('All handlers attached');
        });
    </script>
}

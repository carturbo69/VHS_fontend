@model VHS_frontend.Areas.Customer.Models.Profile.ProfileViewModel
@{
    ViewData["Title"] = "Thông tin cá nhân";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}

<!-- Toast Container -->
<div class="profile-toast-container" id="profileToastContainer"></div>

<div class="profile-container">
    <!-- Header Section -->
    <div class="profile-header">
        <div class="profile-avatar-section">
            <div class="avatar-container @(Model.HasProfileImage ? "has-image" : "no-image")">
                <img id="profileAvatar"
                     src="@Model.GetProfileImageUrl()"
                     alt="@Model.GetDisplayName()"
                     class="profile-avatar" />
                <div class="avatar-overlay">
                    <button type="button" class="btn btn-sm btn-primary" onclick="openImageUpload()">
                        <i class="bi bi-camera"></i>
                    </button>
                </div>
            </div>
            <div class="avatar-actions" id="avatarActions">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="openImageUpload()">
                    <i class="bi bi-camera me-1"></i>Đổi ảnh
                </button>
                @if (Model.HasProfileImage)
                {
                    <button type="button" id="deleteImageBtn" class="btn btn-outline-danger btn-sm" onclick="deleteProfileImage()">
                        <i class="bi bi-trash me-1"></i>Xóa ảnh
                    </button>
                }
            </div>
        </div>

        <div class="profile-info">
            <h1 class="profile-name">@Model.GetDisplayName()</h1>
            <p class="profile-email">@Model.Email</p>
            <div class="profile-meta">
                <span class="meta-item">
                    <i class="bi bi-person-badge"></i>
                    @Model.Role
                </span>
                <span class="meta-item">
                    <i class="bi bi-calendar-event"></i>
                    Tham gia @Model.CreatedAt?.ToString("dd/MM/yyyy")
                </span>
            </div>
        </div>
    </div>

    <!-- Profile Completion -->
    <div class="profile-completion-card">
        <div class="completion-header">
            <h3><i class="bi bi-clipboard-check me-2"></i>Hoàn thiện hồ sơ</h3>
            <span class="completion-percentage" id="completionPercentage">@Model.GetProfileCompletionPercentage()%</span>
        </div>
        <div class="completion-progress">
            <div class="progress-bar" id="progressBar" style="width: @Model.GetProfileCompletionPercentage()%"></div>
        </div>
        <div class="completion-items">
            <div class="completion-item @(string.IsNullOrEmpty(Model.FullName) ? "incomplete" : "complete")"
                 data-field="fullname"
                 data-complete="@(string.IsNullOrEmpty(Model.FullName) ? "false" : "true")">
                <i class="bi bi-@(string.IsNullOrEmpty(Model.FullName) ? "x-circle" : "check-circle")"></i>
                <span>Họ và tên</span>
            </div>
            <div class="completion-item @(string.IsNullOrEmpty(Model.PhoneNumber) ? "incomplete" : "complete")"
                 data-field="phone"
                 data-complete="@(string.IsNullOrEmpty(Model.PhoneNumber) ? "false" : "true")">
                <i class="bi bi-@(string.IsNullOrEmpty(Model.PhoneNumber) ? "x-circle" : "check-circle")"></i>
                <span>Số điện thoại</span>
            </div>
            <div class="completion-item @(string.IsNullOrEmpty(Model.Address) ? "incomplete" : "complete")"
                 data-field="address"
                 data-complete="@(string.IsNullOrEmpty(Model.Address) ? "false" : "true")">
                <i class="bi bi-@(string.IsNullOrEmpty(Model.Address) ? "x-circle" : "check-circle")"></i>
                <span>Địa chỉ</span>
            </div>
            <div class="completion-item @(!Model.HasProfileImage ? "incomplete" : "complete")"
                 data-field="avatar"
                 data-complete="@(!Model.HasProfileImage ? "false" : "true")">
                <i class="bi bi-@(!Model.HasProfileImage ? "x-circle" : "check-circle")"></i>
                <span>Ảnh đại diện</span>
            </div>
        </div>
    </div>

    <!-- Profile Details -->
    <div class="profile-details-grid">
        <!-- Personal Information Card -->
        <div class="detail-card">
            <div class="card-header">
                <h3><i class="bi bi-person"></i> Thông tin cá nhân</h3>
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="bi bi-pencil"></i> Chỉnh sửa
                </button>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <label><i class="bi bi-person-circle me-2"></i>Tên tài khoản</label>
                    <span>@Model.AccountName</span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-envelope-fill me-2"></i>Email</label>
                    <span>@Model.Email</span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-person-fill me-2"></i>Họ và tên</label>
                    <span class="@(string.IsNullOrEmpty(Model.FullName) ? "text-muted" : "")">
                        @if (string.IsNullOrEmpty(Model.FullName))
                        {
                            <span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>
                        }
                        else
                        {
                            @Model.FullName
                        }
                    </span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-telephone-fill me-2"></i>Số điện thoại</label>
                    <span class="@(string.IsNullOrEmpty(Model.PhoneNumber) ? "text-muted" : "")">
                        @if (string.IsNullOrEmpty(Model.PhoneNumber))
                        {
                            <span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>
                        }
                        else
                        {
                            @Model.PhoneNumber
                        }
                    </span>
                </div>
                <div class="info-row">
                    <label><i class="bi bi-geo-alt-fill me-2"></i>Địa chỉ</label>
                    <span class="@(string.IsNullOrEmpty(Model.Address) ? "text-muted" : "")">
                        @if (string.IsNullOrEmpty(Model.Address))
                        {
                            <span class="badge bg-secondary"><i class="bi bi-exclamation-circle me-1"></i>Chưa cập nhật</span>
                        }
                        else
                        {
                            @Model.Address
                        }
                    </span>
                </div>
            </div>
        </div>

        <!-- Account Security Card -->
        <div class="detail-card">
            <div class="card-header">
                <h3><i class="bi bi-shield-lock"></i> Bảo mật tài khoản</h3>
            </div>
            <div class="card-body">
                <div class="security-item">
                    <div class="security-info">
                        <i class="bi bi-key"></i>
                        <div>
                            <h4>Mật khẩu</h4>
                            <p>Đổi mật khẩu để bảo mật tài khoản</p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        <i class="bi bi-pencil"></i> Đổi mật khẩu
                    </button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <i class="bi bi-envelope"></i>
                        <div>
                            <h4>Email</h4>
                            <p>Đổi email đăng nhập</p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#changeEmailModal">
                        <i class="bi bi-pencil"></i> Đổi email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Statistics Card -->
    <div class="detail-card stats-card-full">
        <div class="card-header">
            <h3><i class="bi bi-graph-up"></i> Thống kê tài khoản</h3>
        </div>
        <div class="card-body stats-body">
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">@Model.CompletedOrdersCount</span>
                    <span class="stat-label">Đơn hàng đã hoàn thành</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="bi bi-star"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">@Model.ReviewsCount</span>
                    <span class="stat-label">Đánh giá đã viết</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">@((DateTime.Now - (Model.CreatedAt ?? DateTime.Now)).Days)</span>
                    <span class="stat-label">Ngày tham gia</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="imageUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đổi ảnh đại diện</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="profileImage" class="form-label">Chọn ảnh</label>
                        <input type="file" class="form-control" id="profileImage" name="image" accept="image/*" required>
                        <div class="form-text">Chỉ chấp nhận file JPG, PNG, GIF, BMP, WEBP (tối đa 5MB)</div>
                    </div>
                    <div class="image-preview" id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-fluid rounded">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="uploadProfileImage()">
                    <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner"></span>
                    <i class="bi bi-upload" id="uploadIcon"></i>
                    Tải lên
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa thông tin cá nhân
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProfileForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" name="AccountName" value="@Model.AccountName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="Email" value="@Model.Email" readonly />
                        <small class="text-muted">Email không thể thay đổi ở đây. Sử dụng "Đổi email" để thay đổi.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Họ và tên</label>
                        <input type="text" class="form-control" name="FullName" value="@Model.FullName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-control" name="PhoneNumber" value="@Model.PhoneNumber" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Địa chỉ</label>
                        <textarea class="form-control" name="Address" rows="3">@Model.Address</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock me-2"></i>Đổi mật khẩu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Chúng tôi sẽ gửi mã OTP đến email của bạn để xác minh.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" name="CurrentPassword" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mật khẩu mới</label>
                        <input type="password" class="form-control" name="NewPassword"
                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$"
                               required />
                        <small class="text-muted">Tối thiểu 8 ký tự, bao gồm chữ hoa, chữ thường và số</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Xác nhận mật khẩu mới</label>
                        <input type="password" class="form-control" name="ConfirmPassword" required />
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Mã OTP</label>
                            <button type="button" class="btn btn-link btn-sm p-0" id="btnRequestOTP">
                                <i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP
                            </button>
                        </div>
                        <input type="text" class="form-control" name="OTP" maxlength="6"
                               pattern="\d{6}" placeholder="Nhập 6 chữ số" required />
                        <small class="text-muted" id="otpTimer"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Đổi mật khẩu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Email Modal -->
<div class="modal fade" id="changeEmailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope me-2"></i>Đổi email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changeEmailForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Chúng tôi sẽ gửi mã OTP đến email hiện tại <strong>(@Model.Email)</strong> để xác minh.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email mới</label>
                        <input type="email" class="form-control" name="NewEmail" required />
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Mã OTP</label>
                            <button type="button" class="btn btn-link btn-sm p-0" id="btnRequestEmailOTP">
                                <i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP
                            </button>
                        </div>
                        <input type="text" class="form-control" name="OtpCode" maxlength="6"
                               pattern="\d{6}" placeholder="Nhập 6 chữ số" required />
                        <small class="text-muted" id="emailOtpTimer"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Đổi email
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Profile page script loaded');

            // Xóa tất cả tooltip (title attribute)
            $('[title]').removeAttr('title');
            
            // Xóa tooltip từ Bootstrap nếu có
            $('[data-bs-toggle="tooltip"]').removeAttr('data-bs-toggle').removeAttr('data-bs-title');
            $('[data-toggle="tooltip"]').removeAttr('data-toggle').removeAttr('title');

            // Make functions global
            window.openImageUpload = function() {
                console.log('Opening image upload modal');
                const modalElement = document.getElementById('imageUploadModal');
                if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.error('Bootstrap Modal not available');
                }
            };

            window.deleteProfileImage = async function() {
                try {
                    const response = await fetch('@Url.Action("DeleteImage")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        showToast('Xóa ảnh thành công!', 'success');
                        document.getElementById('profileAvatar').src = '/images/default-avatar.png';

                        // Update avatar container class
                        const avatarContainer = document.querySelector('.avatar-container');
                        if (avatarContainer) {
                            avatarContainer.classList.remove('has-image');
                            avatarContainer.classList.add('no-image');
                        }

                        // Hide delete button
                        toggleDeleteImageButton(false);

                        // Update completion item
                        updateCompletionItem('avatar', false);

                        // Update percentage
                        updateCompletionPercentage();
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra khi xóa ảnh', 'error');
                    }
                } catch (error) {
                    showToast('Có lỗi xảy ra khi xóa ảnh', 'error');
                }
            };

            window.uploadProfileImage = async function() {
                const fileInput = document.getElementById('profileImage');
                const file = fileInput.files[0];

                if (!file) {
                    showToast('Vui lòng chọn ảnh để tải lên', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showToast('Kích thước file không được vượt quá 5MB', 'error');
                    return;
                }

                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    showToast('Chỉ chấp nhận file ảnh JPG, PNG, GIF, BMP, WEBP', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch('@Url.Action("UploadImage")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        showToast('Tải ảnh lên thành công!', 'success');
                        // Thêm backend URL nếu imageUrl là đường dẫn tương đối
                        let fullImageUrl = result.imageUrl;
                        if (fullImageUrl && !fullImageUrl.startsWith('http://') && !fullImageUrl.startsWith('https://')) {
                            fullImageUrl = 'http://localhost:5154' + fullImageUrl;
                        }
                        document.getElementById('profileAvatar').src = fullImageUrl;

                        // Update avatar container class
                        const avatarContainer = document.querySelector('.avatar-container');
                        if (avatarContainer) {
                            avatarContainer.classList.remove('no-image');
                            avatarContainer.classList.add('has-image');
                        }

                        // Show delete button
                        toggleDeleteImageButton(true);

                        // Update completion item
                        updateCompletionItem('avatar', true);

                        // Update percentage
                        updateCompletionPercentage();

                        bootstrap.Modal.getInstance(document.getElementById('imageUploadModal')).hide();
                        document.getElementById('imageUploadForm').reset();
                        document.getElementById('imagePreview').style.display = 'none';
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra khi tải ảnh lên', 'error');
                    }
                } catch (error) {
                    showToast('Có lỗi xảy ra khi tải ảnh lên', 'error');
                }
            };

            // Preview image
            const profileImageInput = document.getElementById('profileImage');
            if (profileImageInput) {
                profileImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Function to calculate and update completion percentage
            function updateCompletionPercentage() {
                const items = document.querySelectorAll('.completion-item');
                let completedCount = 0;
                const totalFields = 4;

                items.forEach(item => {
                    const isComplete = item.getAttribute('data-complete') === 'true';
                    if (isComplete) {
                        completedCount++;
                    }
                });

                const percentage = Math.round((completedCount / totalFields) * 100);

                // Update percentage text
                const percentageEl = document.getElementById('completionPercentage');
                if (percentageEl) {
                    percentageEl.textContent = percentage + '%';
                }

                // Update progress bar
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }

                return percentage;
            }

            // Function to show/hide delete image button
            function toggleDeleteImageButton(show) {
                const avatarActions = document.getElementById('avatarActions');
                if (!avatarActions) return;

                let deleteBtn = document.getElementById('deleteImageBtn');

                if (show) {
                    // Show button if it doesn't exist
                    if (!deleteBtn) {
                        deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.id = 'deleteImageBtn';
                        deleteBtn.className = 'btn btn-outline-danger btn-sm';
                        deleteBtn.onclick = deleteProfileImage;
                        deleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Xóa ảnh';
                        avatarActions.appendChild(deleteBtn);
                    } else {
                        deleteBtn.style.display = '';
                    }
                } else {
                    // Hide button
                    if (deleteBtn) {
                        deleteBtn.style.display = 'none';
                    }
                }
            }

            // Function to update completion item status
            function updateCompletionItem(fieldName, isComplete) {
                const item = document.querySelector(`.completion-item[data-field="${fieldName}"]`);
                if (item) {
                    item.setAttribute('data-complete', isComplete ? 'true' : 'false');
                    const icon = item.querySelector('i');
                    if (icon) {
                        if (isComplete) {
                            item.classList.remove('incomplete');
                            item.classList.add('complete');
                            icon.className = 'bi bi-check-circle';
                        } else {
                            item.classList.remove('complete');
                            item.classList.add('incomplete');
                            icon.className = 'bi bi-x-circle';
                        }
                    }
                }
            }

            // Function to update profile info display
            function updateProfileInfo(fieldName, value) {
                if (!value || value.trim() === '') return;

                const infoRows = document.querySelectorAll('.info-row');
                infoRows.forEach(row => {
                    const label = row.querySelector('label');
                    if (!label) return;

                    const span = row.querySelector('span');
                    if (!span) return;

                    let shouldUpdate = false;
                    if (fieldName === 'fullname' && label.textContent.includes('Họ và tên')) {
                        shouldUpdate = true;
                    } else if (fieldName === 'phone' && label.textContent.includes('Số điện thoại')) {
                        shouldUpdate = true;
                    } else if (fieldName === 'address' && label.textContent.includes('Địa chỉ')) {
                        shouldUpdate = true;
                    }

                    if (shouldUpdate) {
                        // Remove badge if exists
                        const badge = span.querySelector('.badge');
                        if (badge) {
                            badge.remove();
                        }
                        span.innerHTML = value;
                        span.classList.remove('text-muted');
                    }
                });
            }

            // Modal form handlers
            const editForm = document.getElementById('editProfileForm');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    try {
                        const response = await fetch('@Url.Action("UpdateProfile")', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast('Cập nhật thông tin thành công!', 'success');

                            // Update completion items based on form data
                            const fullName = formData.get('FullName');
                            const phoneNumber = formData.get('PhoneNumber');
                            const address = formData.get('Address');

                            if (fullName) {
                                updateCompletionItem('fullname', true);
                                updateProfileInfo('fullname', fullName);
                            }
                            if (phoneNumber) {
                                updateCompletionItem('phone', true);
                                updateProfileInfo('phone', phoneNumber);
                            }
                            if (address) {
                                updateCompletionItem('address', true);
                                updateProfileInfo('address', address);
                            }

                            // Update percentage
                            updateCompletionPercentage();

                            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra', 'error');
                        }
                    } catch (error) {
                        showToast('Có lỗi xảy ra khi cập nhật thông tin', 'error');
                    }
                });
            }

            // Request OTP for password change
            const btnRequestOTP = document.getElementById('btnRequestOTP');
            if (btnRequestOTP) {
                btnRequestOTP.addEventListener('click', async function() {
                    console.log('Requesting password change OTP...');
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Đang gửi...';

                    try {
                        const response = await fetch('@Url.Action("RequestPasswordChangeOTP")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        if (result.success) {
                            showToast('Mã OTP đã được gửi đến email của bạn. Vui lòng kiểm tra email.', 'success');
                            this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Đã gửi';
                            // Countdown timer
                            let countdown = 60;
                            const timer = setInterval(() => {
                                countdown--;
                                if (countdown > 0) {
                                    this.innerHTML = `<i class="bi bi-clock me-1"></i>Gửi lại (${countdown}s)`;
                                } else {
                                    clearInterval(timer);
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                                }
                            }, 1000);
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra khi gửi OTP', 'error');
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                        }
                    } catch (error) {
                        console.error('Error requesting OTP:', error);
                        showToast('Có lỗi xảy ra khi gửi OTP', 'error');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                    }
                });
            }

            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    try {
                        const response = await fetch('@Url.Action("ChangePassword")', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast('Đổi mật khẩu thành công!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                            this.reset();
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra', 'error');
                        }
                    } catch (error) {
                        showToast('Có lỗi xảy ra khi đổi mật khẩu', 'error');
                    }
                });
            }

            // Request OTP for email change
            const btnRequestEmailOTP = document.getElementById('btnRequestEmailOTP');
            if (btnRequestEmailOTP) {
                btnRequestEmailOTP.addEventListener('click', async function() {
                    console.log('Requesting email change OTP...');
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Đang gửi...';

                    try {
                        const response = await fetch('@Url.Action("RequestEmailChangeOTP")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        if (result.success) {
                            showToast('Mã OTP đã được gửi đến email hiện tại của bạn. Vui lòng kiểm tra email.', 'success');
                            this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Đã gửi';
                            // Countdown timer
                            let countdown = 60;
                            const timer = setInterval(() => {
                                countdown--;
                                if (countdown > 0) {
                                    this.innerHTML = `<i class="bi bi-clock me-1"></i>Gửi lại (${countdown}s)`;
                                } else {
                                    clearInterval(timer);
                                    this.disabled = false;
                                    this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                                }
                            }, 1000);
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra khi gửi OTP', 'error');
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                        }
                    } catch (error) {
                        console.error('Error requesting email OTP:', error);
                        showToast('Có lỗi xảy ra khi gửi OTP', 'error');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-envelope-paper me-1"></i>Gửi mã OTP';
                    }
                });
            }

            const changeEmailForm = document.getElementById('changeEmailForm');
            if (changeEmailForm) {
                changeEmailForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    try {
                        const response = await fetch('@Url.Action("ChangeEmail")', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast('Đổi email thành công!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('changeEmailModal')).hide();
                            location.reload();
                        } else {
                            showToast(result.message || 'Có lỗi xảy ra', 'error');
                        }
                    } catch (error) {
                        showToast('Có lỗi xảy ra khi đổi email', 'error');
                    }
                });
            }

            // Toast notification function
            function showToast(message, type = 'info') {
                const container = document.getElementById('profileToastContainer');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `profile-toast profile-toast-${type}`;

                const icons = {
                    success: '✓',
                    error: '✕',
                    info: 'ℹ'
                };

                toast.innerHTML = `
                    <span class="profile-toast-icon">${icons[type] || icons.info}</span>
                    <span class="profile-toast-message">${message}</span>
                    <button type="button" class="profile-toast-close" onclick="this.parentElement.remove()">×</button>
                `;

                container.appendChild(toast);

                // Auto remove after 3 seconds
                setTimeout(() => {
                    toast.classList.add('slide-out');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, 3000);
            }

            // Make showToast global
            window.showToast = showToast;

            console.log('All handlers attached');
        });
    </script>
}

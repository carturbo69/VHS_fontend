@model VHS_frontend.Areas.Customer.Models.Notification.NotificationListResponse
@{
    ViewData["Title"] = "Thông báo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Html.AntiForgeryToken()

<div class="notification-page">
    <div class="container">
        <div class="notification-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="icon-bell"></i>
                    Thông báo của tôi
                </h1>
                <div class="notification-stats">
                    <span class="stat-item">
                        <span class="stat-number">@Model.TotalCount</span>
                        <span class="stat-label">Tổng cộng</span>
                    </span>
                    <span class="stat-item unread">
                        <span class="stat-number">@Model.UnreadCount</span>
                        <span class="stat-label">Chưa đọc</span>
                    </span>
                </div>
            </div>
            
            @if (Model.Data.Any())
            {
                <div class="header-actions">
                    <button type="button" class="btn-action mark-read" id="markAllReadBtn"
                            onclick="markAllReadInline()">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Đánh dấu tất cả đã đọc</span>
                    </button>
                    <button type="button" class="btn-action delete-all" id="clearAllBtn"
                            onclick="clearAllInline()">
                        <i class="bi bi-trash3-fill"></i>
                        <span>Xóa tất cả</span>
                    </button>
                    <button type="button" class="btn-action reset" id="resetDataBtn"
                            onclick="resetDataInline()">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Reset dữ liệu test</span>
                    </button>
                </div>
            }
        </div>

        <div class="notification-filters">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all" onclick="filterNotifications('all')">
                    Tất cả <span class="count">@Model.TotalCount</span>
                </button>
                <button class="filter-tab" data-filter="unread" onclick="filterNotifications('unread')">
                    Chưa đọc <span class="count">@Model.UnreadCount</span>
                </button>
                <button class="filter-tab" data-filter="booking" onclick="filterNotifications('booking')">
                    Đặt lịch <span class="count">@Model.Data.Count(n => n.NotificationType == "Booking")</span>
                </button>
                <button class="filter-tab" data-filter="payment" onclick="filterNotifications('payment')">
                    Thanh toán <span class="count">@Model.Data.Count(n => n.NotificationType == "Payment")</span>
                </button>
            </div>
        </div>

        <div class="notification-list">
            @if (Model.Data.Any())
            {
                @foreach (var notification in Model.Data)
                {
                    <div class="notification-item @(notification.IsRead ? "read" : "unread")" 
                         data-type="@notification.NotificationType.ToLower()"
                         data-notification-id="@notification.NotificationId"
                         @if (!notification.IsRead) { <text>onclick="markAsReadInline('@notification.NotificationId', this)"</text> }>
                        
                        <div class="notification-icon">
                            @switch (notification.NotificationType.ToLower())
                            {
                                case "booking":
                                    <i class="icon-calendar"></i>
                                    break;
                                case "payment":
                                    <i class="icon-credit-card"></i>
                                    break;
                                case "system":
                                    <i class="icon-settings"></i>
                                    break;
                                default:
                                    <i class="icon-bell"></i>
                                    break;
                            }
                        </div>
                        
                        <div class="notification-content">
                            <div class="content-text">@notification.Content</div>
                            <div class="notification-meta">
                                <span class="time">@notification.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                <span class="type-badge type-@notification.NotificationType.ToLower()">
                                    @notification.NotificationType
                                </span>
                            </div>
                        </div>
                        
                        <div class="notification-actions">
                            <button class="action-btn delete" 
                                    data-notification-id="@notification.NotificationId"
                                    title="Xóa"
                                    onclick="event.stopPropagation(); deleteNotificationInline('@notification.NotificationId', this)">
                                <i class="icon-trash"></i>
                            </button>
                        </div>
                        
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="icon-bell-off"></i>
                    </div>
                    <h3>Chưa có thông báo nào</h3>
                    <p>Bạn sẽ nhận được thông báo khi có hoạt động mới.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // XÓA BỎ HOÀN TOÀN đóm xanh ngay khi load (nhưng giữ lại số thông báo)
        function forceRemoveGreenDots() {
            // Remove tất cả unread indicators (nhưng không xóa notification badge chính)
            const unreadIndicators = document.querySelectorAll('.unread-indicator, .notification-dot');
            unreadIndicators.forEach(indicator => {
                // Chỉ xóa nếu không phải là notification badge chính
                if (!indicator.id || indicator.id !== 'notificationBadge') {
                    indicator.remove();
                }
            });
            
            // Remove tất cả elements có class chứa "dot", "indicator" (nhưng không xóa badge chính)
            const dotElements = document.querySelectorAll('[class*="dot"]:not(#notificationBadge), [class*="indicator"]:not(#notificationBadge)');
            dotElements.forEach(element => {
                if (element.style && element.id !== 'notificationBadge') {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                    element.style.opacity = '0';
                }
            });
            
            // Force hide tất cả pseudo-elements và green dots (nhưng không ẩn notification badge chính)
            let existingStyle = document.getElementById('force-hide-green-dots');
            if (!existingStyle) {
                const style = document.createElement('style');
                style.id = 'force-hide-green-dots';
                style.textContent = `
                    .notification-item.unread::after,
                    .notification-item::after,
                    .notification-item.unread *::after,
                    .notification-item *::after,
                    .unread-indicator,
                    .notification-dot,
                    [class*="dot"]:not(#notificationBadge),
                    [class*="indicator"]:not(#notificationBadge) {
                        display: none !important;
                        content: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                        width: 0 !important;
                        height: 0 !important;
                        background: none !important;
                        border: none !important;
                        position: absolute !important;
                        left: -9999px !important;
                        top: -9999px !important;
                        z-index: -9999 !important;
                    }
                    
                    /* Đảm bảo notification badge chính vẫn hiển thị */
                    #notificationBadge.notification-badge {
                        display: inline-block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        width: auto !important;
                        height: auto !important;
                        background: var(--danger, #dc3545) !important;
                        border-radius: 50% !important;
                        position: absolute !important;
                        top: -8px !important;
                        right: -8px !important;
                        z-index: 1000 !important;
                        color: white !important;
                        font-size: 12px !important;
                        min-width: 18px !important;
                        height: 18px !important;
                        line-height: 18px !important;
                        text-align: center !important;
                        padding: 0 !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Chạy ngay khi load
        forceRemoveGreenDots();
        
        // Set để theo dõi các notification đang được xóa
        window.deletingNotifications = new Set();
        
        // Cải thiện UI khi load
        document.addEventListener('DOMContentLoaded', function() {
            // Thêm animation cho notification items
            const notificationItems = document.querySelectorAll('.notification-item');
            notificationItems.forEach((item, index) => {
                item.style.animation = `slideIn 0.3s ease-in-out ${index * 0.1}s both`;
            });
            
            // Đảm bảo notification badge hiển thị đúng
            ensureNotificationBadgeVisible();
            
            // Cập nhật badge ngay khi load
            updateNotificationBell();
            
            // Force remove đóm xanh sau khi load
            setTimeout(forceRemoveGreenDots, 100);
        });
        
        // Function để đảm bảo notification badge hiển thị đúng
        function ensureNotificationBadgeVisible() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                // Đảm bảo badge có đúng class và style
                badge.classList.add('notification-badge');
                badge.style.cssText = `
                    position: absolute !important;
                    top: -6px !important;
                    right: -6px !important;
                    min-width: 18px !important;
                    height: 18px !important;
                    padding: 0 5px !important;
                    border-radius: 999px !important;
                    background: var(--primary, #007bff) !important;
                    color: var(--primary-foreground, white) !important;
                    font-size: .72rem !important;
                    font-weight: 700 !important;
                    display: grid !important;
                    place-items: center !important;
                    z-index: 1000 !important;
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up notification handlers');
            
            // Setup event listeners cho trang notification
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            // Setup individual button handlers
            setupIndividualButtonHandlers();
            
            // Function để setup individual button handlers
            function setupIndividualButtonHandlers() {
                // Tìm tất cả các nút mark-read
                const markReadButtons = document.querySelectorAll('.action-btn.mark-read');
                console.log('Found mark-read buttons:', markReadButtons.length);
                
                markReadButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const notificationId = this.dataset.notificationId;
                        console.log('Mark read button clicked, notificationId:', notificationId);
                        
                        if (notificationId) {
                            markAsRead(notificationId, this);
                        }
                    });
                });
                
                // Tìm tất cả các nút delete
                const deleteButtons = document.querySelectorAll('.action-btn.delete');
                console.log('Found delete buttons:', deleteButtons.length);
                
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const notificationId = this.dataset.notificationId;
                        console.log('Delete button clicked, notificationId:', notificationId);
                        
                        if (notificationId) {
                            deleteNotification(notificationId, this);
                        }
                    });
                });
            }
            
            // Không cần event listeners nữa vì đã dùng inline onclick handlers
            
            // Function để đánh dấu đã đọc
            async function markAsRead(notificationId, buttonElement) {
                try {
                    const response = await fetch(`/Customer/Notification/MarkRead/${notificationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Xóa thông báo khỏi UI
                        const notificationItem = buttonElement.closest('.notification-item');
                        if (notificationItem) {
                            notificationItem.remove();
                        }
                        
                        // Cập nhật số lượng thông báo
                        updateNotificationCounts();
                        
                        // Cập nhật chuông thông báo
                        updateNotificationBell();
                        
                        // Không hiển thị thông báo khi đánh dấu đã đọc
                    } else {
                        alert('Có lỗi xảy ra: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi đánh dấu đã đọc');
                }
            }
            
            // Function để xóa thông báo
            async function deleteNotification(notificationId, buttonElement) {
                // Xóa trực tiếp không cần xác nhận
                try {
                    // Lấy token an toàn hơn
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (!token) {
                        console.error('RequestVerificationToken not found');
                        alert('Không tìm thấy token xác thực');
                        return;
                    }
                    
                    const response = await fetch(`/Customer/Notification/Delete/${notificationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': token
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Delete response:', result);
                    
                    if (result.success) {
                        // Xóa thông báo khỏi UI
                        const notificationItem = buttonElement.closest('.notification-item');
                        if (notificationItem) {
                            notificationItem.remove();
                        }
                        
                        // Cập nhật số lượng thông báo
                        updateNotificationCounts();
                        
                        // Không hiển thị thông báo khi xóa
                    } else {
                        console.error('Delete failed:', result);
                        alert('Có lỗi xảy ra: ' + (result.message || 'Không xác định được lỗi'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa thông báo: ' + error.message);
                }
            }
            
            // Function để cập nhật số lượng thông báo
            function updateNotificationCounts() {
                const notificationItems = document.querySelectorAll('.notification-item');
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                
                // Cập nhật số lượng trong header stats
                const totalCountElement = document.querySelector('.stat-item:not(.unread) .stat-number');
                const unreadCountElement = document.querySelector('.stat-item.unread .stat-number');
                
                if (totalCountElement) {
                    totalCountElement.textContent = notificationItems.length;
                }
                
                if (unreadCountElement) {
                    unreadCountElement.textContent = unreadItems.length;
                }
                
                // Cập nhật filter tabs
                const filterTabs = document.querySelectorAll('.filter-tab .count');
                filterTabs.forEach(tab => {
                    const tabElement = tab.closest('.filter-tab');
                    if (tabElement.dataset.filter === 'all') {
                        tab.textContent = notificationItems.length;
                    } else if (tabElement.dataset.filter === 'unread') {
                        tab.textContent = unreadItems.length;
                    }
                });
                
                // Ẩn nút mark all read nếu không còn thông báo chưa đọc
                const markAllReadBtn = document.getElementById('markAllReadBtn');
                if (unreadItems.length === 0 && markAllReadBtn) {
                    markAllReadBtn.style.display = 'none';
                }
                
                // Hiển thị empty state nếu không còn thông báo
                if (notificationItems.length === 0) {
                    showEmptyState();
                }
            }
            
            // Function để hiển thị empty state
            function showEmptyState() {
                const notificationList = document.querySelector('.notification-list');
                if (notificationList) {
                    notificationList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="icon-bell-off"></i>
                            </div>
                            <h3>Chưa có thông báo nào</h3>
                            <p>Bạn sẽ nhận được thông báo khi có hoạt động mới.</p>
                        </div>
                    `;
                }
            }
            
            // Function để hiển thị toast notification
            function showToast(message, type = 'info') {
                // Tạo toast element
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#16a34a' : '#3b82f6'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    transform: translateX(100%);
                    opacity: 0;
                    transition: all 0.3s ease;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                    toast.style.opacity = '1';
                }, 10);
                
                // Tự động xóa sau 3 giây
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        });
        
        // Global functions cho inline onclick handlers
        window.markAsReadInline = async function(notificationId, element) {
            console.log('markAsReadInline called with notificationId:', notificationId);
            
            const notificationItem = element.closest ? element.closest('.notification-item') : element;
            
            try {
                const response = await fetch(`/Customer/Notification/MarkRead/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                if (result.success) {
                    // Animation đẹp khi đánh dấu đã đọc
                    notificationItem.style.transition = 'all 0.3s ease-in-out';
                    notificationItem.style.backgroundColor = 'var(--muted)';
                    notificationItem.style.transform = 'scale(0.98)';
                    
                    setTimeout(() => {
                        notificationItem.classList.remove('unread');
                        notificationItem.classList.add('read');
                        notificationItem.removeAttribute('onclick');
                        
                        // Reset style
                        notificationItem.style.backgroundColor = '';
                        notificationItem.style.transform = '';
                        
                        // Cập nhật số lượng thông báo
                        updateNotificationCounts();
                        
                        // Cập nhật chuông thông báo
                        updateNotificationBell();
                        
                        // Force remove đóm xanh
                        forceRemoveGreenDots();
                        
                        // Không hiển thị thông báo khi đánh dấu đã đọc
                    }, 300);
                } else {
                    alert('Có lỗi xảy ra: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi đánh dấu đã đọc');
            }
        };
        
        window.deleteNotificationInline = async function(notificationId, buttonElement) {
            console.log('deleteNotificationInline called with notificationId:', notificationId);
            
            // Kiểm tra xem notification này có đang được xóa không
            if (window.deletingNotifications.has(notificationId)) {
                console.log('Notification is already being deleted, returning');
                return;
            }
            
            // Ngăn chặn double click và kiểm tra xem notification còn tồn tại không
            if (buttonElement.disabled) {
                console.log('Button already disabled, returning');
                return;
            }
            
            // Kiểm tra xem notification item còn tồn tại không
            const notificationItem = buttonElement.closest('.notification-item');
            if (!notificationItem) {
                console.log('Notification item not found in DOM');
                return;
            }
            
            // Đánh dấu notification này đang được xóa
            window.deletingNotifications.add(notificationId);
            buttonElement.disabled = true;
            
            // Xóa trực tiếp không cần xác nhận
            try {
                // Lấy token an toàn hơn
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (!token) {
                    console.error('RequestVerificationToken not found');
                    alert('Không tìm thấy token xác thực');
                    buttonElement.disabled = false;
                    return;
                }
                
                const response = await fetch(`/Customer/Notification/Delete/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': token
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Delete response:', result);
                
                if (result.success) {
                    console.log('Delete successful, removing from DOM');
                    // Xóa thông báo ngay lập tức
                    if (notificationItem && notificationItem.parentNode) {
                        // Thêm animation trước khi xóa
                        notificationItem.style.transition = 'all 0.3s ease-out';
                        notificationItem.style.opacity = '0';
                        notificationItem.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            if (notificationItem.parentNode) {
                                notificationItem.remove();
                            }
                            
                            // Cập nhật số lượng thông báo ngay lập tức
                            updateNotificationCounts();
                            
                            // Cập nhật chuông thông báo ngay lập tức - Ẩn đóm xanh
                            updateNotificationBell();
                            
                            // Force remove đóm xanh
                            forceRemoveGreenDots();
                            
                            // Không hiển thị thông báo khi xóa
                        }, 300);
                    } else {
                        console.log('Notification item already removed from DOM');
                        // Vẫn cập nhật counts nếu item đã bị xóa
                        updateNotificationCounts();
                        updateNotificationBell();
                    }
                    
                    // Xóa notification khỏi set tracking
                    window.deletingNotifications.delete(notificationId);
                } else {
                    console.error('Delete failed:', result);
                    // Chỉ hiển thị alert nếu thực sự có lỗi từ server
                    if (result.message && !result.message.includes('Không tìm thấy thông báo')) {
                        alert('Có lỗi xảy ra: ' + result.message);
                    }
                    buttonElement.disabled = false;
                    // Xóa notification khỏi set tracking
                    window.deletingNotifications.delete(notificationId);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa thông báo: ' + error.message);
                buttonElement.disabled = false;
                // Xóa notification khỏi set tracking
                window.deletingNotifications.delete(notificationId);
            }
        };
        
        // Global function để lọc thông báo
        window.filterNotifications = function(filterType) {
            const notificationItems = document.querySelectorAll('.notification-item');
            const filterTabs = document.querySelectorAll('.filter-tab');
            
            // Cập nhật active tab
            filterTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Lọc và hiển thị thông báo
            notificationItems.forEach(item => {
                let shouldShow = false;
                
                switch (filterType) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'unread':
                        shouldShow = item.classList.contains('unread');
                        break;
                    case 'booking':
                        shouldShow = item.dataset.type === 'booking';
                        break;
                    case 'payment':
                        shouldShow = item.dataset.type === 'payment';
                        break;
                    default:
                        shouldShow = true;
                }
                
                if (shouldShow) {
                    item.style.display = 'flex';
                    item.style.animation = 'fadeIn 0.3s ease-in-out';
                } else {
                    item.style.display = 'none';
                }
            });
            
            console.log('Filtered notifications by:', filterType);
        };

        // Global function để cập nhật số lượng thông báo
        window.updateNotificationCounts = function() {
            const notificationItems = document.querySelectorAll('.notification-item');
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            
            console.log('Updating notification counts:', {
                total: notificationItems.length,
                unread: unreadItems.length
            });
            
            // Cập nhật số lượng trong header stats
            const totalCountElement = document.querySelector('.stat-item:not(.unread) .stat-number');
            const unreadCountElement = document.querySelector('.stat-item.unread .stat-number');
            
            if (totalCountElement) {
                totalCountElement.textContent = notificationItems.length;
            }
            
            if (unreadCountElement) {
                unreadCountElement.textContent = unreadItems.length;
            }
            
            // Cập nhật filter tabs với animation
            const filterTabs = document.querySelectorAll('.filter-tab .count');
            filterTabs.forEach(tab => {
                const tabElement = tab.closest('.filter-tab');
                if (tabElement) {
                    const filterType = tabElement.dataset.filter;
                    let count = 0;
                    
                    switch (filterType) {
                        case 'all':
                            count = notificationItems.length;
                            break;
                        case 'unread':
                            count = unreadItems.length;
                            break;
                        case 'booking':
                            count = document.querySelectorAll('.notification-item[data-type="booking"]').length;
                            break;
                        case 'payment':
                            count = document.querySelectorAll('.notification-item[data-type="payment"]').length;
                            break;
                    }
                    
                    // Animation khi thay đổi số
                    tab.style.transform = 'scale(1.2)';
                    tab.style.color = 'var(--primary)';
                    setTimeout(() => {
                        tab.textContent = count;
                        tab.style.transform = 'scale(1)';
                        tab.style.color = '';
                    }, 150);
                }
            });
            
            // Ẩn nút mark all read nếu không còn thông báo chưa đọc
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            if (unreadItems.length === 0 && markAllReadBtn) {
                markAllReadBtn.style.display = 'none';
            }
            
            // Hiển thị empty state nếu không còn thông báo
            if (notificationItems.length === 0) {
                showEmptyState();
            }
            
            // Log để debug
            console.log('Updated counts:', {
                total: notificationItems.length,
                unread: unreadItems.length,
                markAllReadVisible: markAllReadBtn ? markAllReadBtn.style.display !== 'none' : false
            });
        };
        
        // Global function để hiển thị empty state
        window.showEmptyState = function() {
            const notificationList = document.querySelector('.notification-list');
            if (notificationList) {
                notificationList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="icon-bell-off"></i>
                        </div>
                        <h3>Chưa có thông báo nào</h3>
                        <p>Bạn sẽ nhận được thông báo khi có hoạt động mới.</p>
                    </div>
                `;
            }
        };
        
        // Global function để hiển thị toast notification
        window.showToast = function(message, type = 'info') {
            // Tạo toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#16a34a' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                transform: translateX(100%);
                opacity: 0;
                transition: all 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            }, 10);
            
            // Tự động xóa sau 3 giây
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        };
        
        // Global function để mark all as read
        window.markAllReadInline = async function() {
            console.log('markAllReadInline called');
            
            const button = document.getElementById('markAllReadBtn');
            if (button.disabled) return;
            
            if (confirm('Bạn có chắc chắn muốn đánh dấu tất cả thông báo đã đọc?')) {
                // Disable button và thêm loading state
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                
                const icon = button.querySelector('i');
                icon.className = 'bi bi-hourglass-split';
                icon.style.animation = 'spin 1s linear infinite';
                try {
                    const response = await fetch('/Customer/Notification/MarkAllRead', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Đánh dấu tất cả đã đọc ngay lập tức
                        const unreadItems = document.querySelectorAll('.notification-item.unread');
                        unreadItems.forEach(item => {
                            item.classList.remove('unread');
                            item.classList.add('read');
                            item.removeAttribute('onclick');
                        });
                        
                        // Cập nhật số lượng ngay lập tức
                        updateNotificationCounts();
                        
                        // Cập nhật badge ngay lập tức - Ẩn đóm xanh
                        updateNotificationBell();
                        
                        // Force remove đóm xanh
                        forceRemoveGreenDots();
                        
                        // Ẩn nút mark all read
                        const markAllReadBtn = document.getElementById('markAllReadBtn');
                        if (markAllReadBtn) {
                            markAllReadBtn.style.display = 'none';
                        }
                        
                        // Không hiển thị thông báo khi đánh dấu tất cả đã đọc
                    } else {
                        alert('Có lỗi xảy ra: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi đánh dấu tất cả đã đọc');
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.style.opacity = '';
                    button.style.cursor = '';
                    icon.className = 'bi bi-check-circle';
                    icon.style.animation = '';
                }
            }
        };
        
        // Global function để clear all notifications
        window.clearAllInline = async function() {
            console.log('clearAllInline called');
            
            const button = document.getElementById('clearAllBtn');
            if (button.disabled) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa tất cả thông báo?')) {
                // Disable button và thêm loading state
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                
                const icon = button.querySelector('i');
                icon.className = 'bi bi-hourglass-split';
                icon.style.animation = 'spin 1s linear infinite';
                try {
                    const response = await fetch('/Customer/Notification/ClearAll', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Xóa tất cả thông báo ngay lập tức
                        const notificationList = document.querySelector('.notification-list');
                        if (notificationList) {
                            notificationList.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="icon-bell-off"></i>
                                    </div>
                                    <h3>Chưa có thông báo nào</h3>
                                    <p>Bạn sẽ nhận được thông báo khi có hoạt động mới.</p>
                                </div>
                            `;
                        }
                        
                        // Ẩn header actions
                        const headerActions = document.querySelector('.header-actions');
                        if (headerActions) {
                            headerActions.style.display = 'none';
                        }
                        
                        // Cập nhật số lượng thông báo ngay lập tức
                        updateNotificationCounts();
                        
                        // Cập nhật chuông thông báo ngay lập tức - Ẩn đóm xanh
                        updateNotificationBell();
                        
                        // Force remove đóm xanh
                        forceRemoveGreenDots();
                        
                        // Không hiển thị thông báo khi xóa tất cả
                    } else {
                        alert('Có lỗi xảy ra: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa tất cả thông báo');
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.style.opacity = '';
                    button.style.cursor = '';
                    icon.className = 'bi bi-trash3';
                    icon.style.animation = '';
                }
            }
        };
        
        // Global function để reset dữ liệu ảo
        window.resetDataInline = async function() {
            console.log('resetDataInline called');
            
            const button = document.getElementById('resetDataBtn');
            if (button.disabled) return;
            
            if (confirm('Bạn có chắc chắn muốn reset dữ liệu ảo về trạng thái ban đầu?')) {
                // Disable button và thêm loading state
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                
                const icon = button.querySelector('i');
                icon.className = 'bi bi-hourglass-split';
                icon.style.animation = 'spin 1s linear infinite';
                try {
                    const response = await fetch('/Customer/Notification/ResetData');
                    const result = await response.json();
                    
                    if (result.success) {
                        // Reload trang để hiển thị dữ liệu mới
                        window.location.reload();
                    } else {
                        showToast('Có lỗi xảy ra khi reset dữ liệu', 'error');
                    }
                } catch (error) {
                    console.error('Error resetting data:', error);
                    showToast('Có lỗi xảy ra khi reset dữ liệu', 'error');
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.style.opacity = '';
                    button.style.cursor = '';
                    icon.className = 'bi bi-arrow-clockwise';
                    icon.style.animation = '';
                }
            }
        };

        // Global function để cập nhật chuông thông báo
        window.updateNotificationBell = function() {
            try {
                // Tính toán số lượng thông báo chưa đọc từ DOM
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                const unreadCount = unreadItems.length;
                
                console.log('Updating notification bell, unread count:', unreadCount);
                
                // Cập nhật badge trong header ngay lập tức
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline-block';
                        badge.style.visibility = 'visible';
                        badge.style.opacity = '1';
                    } else {
                        badge.style.display = 'none';
                        badge.style.visibility = 'hidden';
                        badge.style.opacity = '0';
                        badge.textContent = '0';
                    }
                    console.log('Badge updated:', badge.style.display, badge.textContent);
                } else {
                    console.log('Badge element not found');
                }
                
                // Force remove tất cả đóm xanh ngay lập tức
                forceRemoveGreenDots();
                
                // Cập nhật dropdown nếu có
                if (window.loadNotifications) {
                    window.loadNotifications();
                }
                
            } catch (error) {
                console.error('Error updating notification bell:', error);
            }
        };
    </script>
}

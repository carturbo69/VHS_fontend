@model VHS_frontend.Areas.Customer.Models.Notification.NotificationListResponse
@{
    ViewData["Title"] = "Th√¥ng b√°o";
    Layout = "~/Views/Shared/_Layout.cshtml";
    
    // Helper function to convert NotificationType to Vietnamese
    string GetNotificationTypeVN(string type)
    {
        return type switch
        {
            "PAYMENT_SUCCESS" => "Thanh to√°n th√†nh c√¥ng",
            "NEW_BOOKING" => "ƒê∆°n h√†ng m·ªõi",
            "BOOKING_CONFIRMED" => "X√°c nh·∫≠n ƒë∆°n h√†ng",
            "BOOKING_CANCELLED" => "H·ªßy ƒë∆°n h√†ng",
            "BOOKING_COMPLETED" => "Ho√†n th√†nh ƒë∆°n h√†ng",
            "Payment" => "Thanh to√°n",
            "Booking" => "ƒê·∫∑t l·ªãch",
            "System" => "H·ªá th·ªëng",
            _ => type
        };
    }
    
    // Database ƒë√£ l∆∞u theo gi·ªù Vi·ªát Nam, kh√¥ng c·∫ßn convert n·ªØa
    DateTime ToVietnamTime(DateTime vietnamTime)
    {
        return vietnamTime;
    }
}

<style>
/* CRITICAL FIX - Force chat icon on notification page */
/* Let Bootstrap Icons CSS handle content, just ensure visibility */
body .site-header a.icon-btn.chat-btn i#chatIcon.bi.bi-chat-dots-fill.fs-4::before,
body .site-header .nav-actions .chat-btn i#chatIcon.bi.bi-chat-dots-fill::before,
html body #chatIcon.bi.bi-chat-dots-fill::before,
i#chatIcon.bi-chat-dots-fill::before,
i#chatIcon.bi::before,
#chatIcon::before {
    font-family: "bootstrap-icons" !important;
    font-style: normal !important;
    font-weight: normal !important;
    font-variant: normal !important;
    text-transform: none !important;
    line-height: 1 !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
    width: auto !important;
    height: auto !important;
    position: static !important;
    left: auto !important;
    top: auto !important;
    z-index: auto !important;
}

/* Ensure chat icon element itself is visible */
#chatIcon,
i#chatIcon,
.bi-chat-dots-fill#chatIcon,
a.chat-btn > #chatIcon {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: static !important;
    left: auto !important;
    top: auto !important;
    width: auto !important;
    height: auto !important;
}

</style>

@Html.AntiForgeryToken()

<div class="notification-page">
    <div class="container">
        <div class="notification-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="icon-bell"></i>
                    Th√¥ng b√°o c·ªßa t√¥i
                </h1>
                <div class="notification-stats">
                    <span class="stat-item">
                        <span class="stat-number">@Model.TotalCount</span>
                        <span class="stat-label">T·ªïng c·ªông</span>
                    </span>
                    <span class="stat-item unread">
                        <span class="stat-number">@Model.UnreadCount</span>
                        <span class="stat-label">Ch∆∞a ƒë·ªçc</span>
                    </span>
                </div>
            </div>
            
            <div class="header-actions" id="headerActions" style="display: @(Model.Data.Any() ? "flex" : "none")">
                <button type="button" class="btn-action mark-read" id="markAllReadBtn"
                        onclick="markAllReadInline()" style="display: @(Model.Data.Any(n => !n.IsRead) ? "flex" : "none")">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</span>
                </button>
                <button type="button" class="btn-action delete-all" id="clearAllBtn"
                        onclick="clearAllInline()">
                    <i class="bi bi-trash3-fill"></i>
                    <span>X√≥a t·∫•t c·∫£</span>
                </button>
            </div>
        </div>

        <div class="notification-filters">
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all" onclick="filterNotifications('all')">
                    T·∫•t c·∫£ <span class="count">@Model.TotalCount</span>
                </button>
                <button class="filter-tab" data-filter="unread" onclick="filterNotifications('unread')">
                    Ch∆∞a ƒë·ªçc <span class="count">@Model.UnreadCount</span>
                </button>
                <!-- <button class="filter-tab" data-filter="booking" onclick="filterNotifications('booking')">
                    ƒê·∫∑t l·ªãch <span class="count">@Model.Data.Count(n => n.NotificationType == "Booking")</span>
                </button>
                <button class="filter-tab" data-filter="payment" onclick="filterNotifications('payment')">
                    Thanh to√°n <span class="count">@Model.Data.Count(n => n.NotificationType.Contains("Payment", StringComparison.OrdinalIgnoreCase) || n.NotificationType.Contains("PAYMENT", StringComparison.OrdinalIgnoreCase))</span>
                </button> -->
            </div>
        </div>

        <div class="notification-list">
            @if (Model.Data.Any())
            {
                @foreach (var notification in Model.Data)
                {
                    <div class="notification-item @(notification.IsRead ? "read" : "unread")" 
                         data-type="@notification.NotificationType.ToLower()"
                         data-notification-id="@notification.NotificationId"
                         @if (!notification.IsRead) { <text>onclick="markAsReadInline('@notification.NotificationId', this)"</text> }>
                        
                        <div class="notification-icon">
                            @{
                                var notifType = notification.NotificationType.ToLower();
                                if (notifType.Contains("payment"))
                                {
                                    <i class="icon-credit-card"></i>
                                }
                                else if (notifType.Contains("booking"))
                                {
                                    <i class="icon-calendar"></i>
                                }
                                else if (notifType == "system")
                                {
                                    <i class="icon-settings"></i>
                                }
                                else
                                {
                                    <i class="icon-bell"></i>
                                }
                            }
                        </div>
                        
                        <div class="notification-content">
                            <div class="content-text">@notification.Content</div>
                            <div class="notification-meta">
                                <span class="time">@ToVietnamTime(notification.CreatedAt).ToString("dd/MM/yyyy HH:mm")</span>
                                <span class="type-badge type-@notification.NotificationType.ToLower()">
                                    @GetNotificationTypeVN(notification.NotificationType)
                                </span>
                            </div>
                        </div>
                        
                        <div class="notification-actions">
                            <button class="action-btn delete" 
                                    data-notification-id="@notification.NotificationId"
                                    title="X√≥a"
                                    onclick="event.stopPropagation(); deleteNotificationInline('@notification.NotificationId', this)">
                                <i class="icon-trash"></i>
                            </button>
                        </div>
                        
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="icon-bell-off"></i>
                    </div>
                    <h3>Ch∆∞a c√≥ th√¥ng b√°o n√†o</h3>
                    <p>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ ho·∫°t ƒë·ªông m·ªõi.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // X√ìA B·ªé HO√ÄN TO√ÄN ƒë√≥m xanh ngay khi load (nh∆∞ng gi·ªØ l·∫°i s·ªë th√¥ng b√°o)
        function forceRemoveGreenDots() {
            // Remove t·∫•t c·∫£ unread indicators (nh∆∞ng kh√¥ng x√≥a notification badge ch√≠nh)
            const unreadIndicators = document.querySelectorAll('.unread-indicator, .notification-dot');
            unreadIndicators.forEach(indicator => {
                // Ch·ªâ x√≥a n·∫øu kh√¥ng ph·∫£i l√† notification badge ch√≠nh
                if (!indicator.id || indicator.id !== 'notificationBadge') {
                    indicator.remove();
                }
            });
            
            // Remove t·∫•t c·∫£ elements c√≥ class ch·ª©a "dot", "indicator" (nh∆∞ng kh√¥ng x√≥a badge ch√≠nh v√† KH√îNG ·∫®N CHAT ICON)
            const dotElements = document.querySelectorAll('[class*="dot"]:not(#notificationBadge):not(#chatIcon), [class*="indicator"]:not(#notificationBadge)');
            dotElements.forEach(element => {
                // Kh√¥ng ·∫©n chatIcon ho·∫∑c notificationBadge
                if (element.style && element.id !== 'notificationBadge' && element.id !== 'chatIcon') {
                    element.style.display = 'none';
                    element.style.visibility = 'hidden';
                    element.style.opacity = '0';
                }
            });
            
            // Force hide t·∫•t c·∫£ pseudo-elements v√† green dots (nh∆∞ng kh√¥ng ·∫©n notification badge ch√≠nh)
            let existingStyle = document.getElementById('force-hide-green-dots');
            if (!existingStyle) {
                const style = document.createElement('style');
                style.id = 'force-hide-green-dots';
                style.textContent = `
                    .notification-item.unread::after,
                    .notification-item::after,
                    .notification-item.unread *::after,
                    .notification-item *::after,
                    .unread-indicator,
                    .notification-dot,
                    [class*="dot"]:not(#notificationBadge):not(#chatIcon):not(.bi-chat-dots-fill),
                    [class*="indicator"]:not(#notificationBadge) {
                        display: none !important;
                        content: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                        width: 0 !important;
                        height: 0 !important;
                        background: none !important;
                        border: none !important;
                        position: absolute !important;
                        left: -9999px !important;
                        top: -9999px !important;
                        z-index: -9999 !important;
                    }
                    
                    /* ƒê·∫£m b·∫£o notification badge ch√≠nh v·∫´n hi·ªÉn th·ªã */
                    #notificationBadge.notification-badge {
                        display: inline-block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        width: auto !important;
                        height: auto !important;
                        background: var(--danger, #dc3545) !important;
                        border-radius: 50% !important;
                        position: absolute !important;
                        top: -8px !important;
                        right: -8px !important;
                        z-index: 1000 !important;
                        color: white !important;
                        font-size: 12px !important;
                        min-width: 18px !important;
                        height: 18px !important;
                        line-height: 18px !important;
                        text-align: center !important;
                        padding: 0 !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Ch·∫°y ngay khi load
        forceRemoveGreenDots();
        
        // ============================================
        // FORCE FIX CHAT ICON - APPLY STYLES VIA JAVASCRIPT
        // ============================================
        function forceChatIconVisible() {
            console.log('üîß [Notification Page] Forcing chat icon visible...');
            
            const chatBtn = document.querySelector('.chat-btn');
            const chatIcon = document.getElementById('chatIcon');
            const chatBadge = document.querySelector('.chat-badge');
            
            console.log('Chat elements found:', {
                chatBtn: !!chatBtn,
                chatIcon: !!chatIcon,
                chatBadge: !!chatBadge
            });
            
            if (chatBtn) {
                chatBtn.style.setProperty('opacity', '1', 'important');
                chatBtn.style.setProperty('visibility', 'visible', 'important');
                chatBtn.style.setProperty('display', 'grid', 'important');
                chatBtn.style.setProperty('pointer-events', 'auto', 'important');
                chatBtn.style.setProperty('position', 'relative', 'important');
                console.log('‚úÖ Chat button styles applied');
            } else {
                console.warn('‚ö†Ô∏è Chat button not found!');
            }
            
            if (chatIcon) {
                const isDark = document.documentElement.classList.contains('dark');
                const color = isDark ? '#ffffff' : '#2f2f2f';
                
                // Only set color, opacity and visibility - DON'T override font-family!
                chatIcon.style.setProperty('color', color, 'important');
                chatIcon.style.setProperty('opacity', '1', 'important');
                chatIcon.style.setProperty('visibility', 'visible', 'important');
                chatIcon.style.setProperty('display', 'inline-block', 'important');
                
                console.log('‚úÖ Chat icon styles applied, color:', color);
            } else {
                console.warn('‚ö†Ô∏è Chat icon not found!');
            }
            
            if (chatBadge) {
                chatBadge.style.setProperty('opacity', '1', 'important');
                chatBadge.style.setProperty('visibility', 'visible', 'important');
                chatBadge.style.setProperty('display', 'grid', 'important');
                chatBadge.style.setProperty('z-index', '1000', 'important');
                console.log('‚úÖ Chat badge styles applied');
            }
        }
        
        // Apply styles - ch·ªâ set color, kh√¥ng c·∫ßn inject CSS n·ªØa
        forceChatIconVisible();
        
        // Apply l·∫°i sau 100ms ƒë·ªÉ ƒë·∫£m b·∫£o
        setTimeout(forceChatIconVisible, 100);
        
        // Theo d√µi theme changes v√† reapply
        const themeObserver = new MutationObserver(() => {
            forceChatIconVisible();
        });
        themeObserver.observe(document.documentElement, { 
            attributes: true, 
            attributeFilter: ['class'] 
        });
        
        // Set ƒë·ªÉ theo d√µi c√°c notification ƒëang ƒë∆∞·ª£c x√≥a
        window.deletingNotifications = new Set();
        
        // C·∫£i thi·ªán UI khi load
        document.addEventListener('DOMContentLoaded', function() {
            // Th√™m animation cho notification items
            const notificationItems = document.querySelectorAll('.notification-item');
            notificationItems.forEach((item, index) => {
                item.style.animation = `slideIn 0.3s ease-in-out ${index * 0.1}s both`;
            });
            
            // ƒê·∫£m b·∫£o notification badge hi·ªÉn th·ªã ƒë√∫ng
            ensureNotificationBadgeVisible();
            
            // C·∫≠p nh·∫≠t badge ngay khi load
            updateNotificationBell();
            
            // Force remove ƒë√≥m xanh sau khi load
            setTimeout(forceRemoveGreenDots, 100);
        });
        
        // Function ƒë·ªÉ ƒë·∫£m b·∫£o notification badge hi·ªÉn th·ªã ƒë√∫ng
        function ensureNotificationBadgeVisible() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                // ƒê·∫£m b·∫£o badge c√≥ ƒë√∫ng class v√† style
                badge.classList.add('notification-badge');
                badge.style.cssText = `
                    position: absolute !important;
                    top: -6px !important;
                    right: -6px !important;
                    min-width: 18px !important;
                    height: 18px !important;
                    padding: 0 5px !important;
                    border-radius: 999px !important;
                    background: var(--primary, #007bff) !important;
                    color: var(--primary-foreground, white) !important;
                    font-size: .72rem !important;
                    font-weight: 700 !important;
                    display: grid !important;
                    place-items: center !important;
                    z-index: 1000 !important;
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up notification handlers');
            
            // Setup event listeners cho trang notification
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            // Removed duplicate per-item handlers. Inline onclick handlers are used instead.
            
            // Kh√¥ng c·∫ßn event listeners n·ªØa v√¨ ƒë√£ d√πng inline onclick handlers
            
            // Function ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
            async function markAsRead(notificationId, buttonElement) {
                try {
                    const response = await fetch(`/Customer/Notification/MarkRead/${notificationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // X√≥a th√¥ng b√°o kh·ªèi UI
                        const notificationItem = buttonElement.closest('.notification-item');
                        if (notificationItem) {
                            notificationItem.remove();
                        }
                        
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o
                        updateNotificationCounts();
                        
                        // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o
                        updateNotificationBell();
                        
                        // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                    } else {
                        alert('C√≥ l·ªói x·∫£y ra: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc');
                }
            }
            
            // Function ƒë·ªÉ x√≥a th√¥ng b√°o
            async function deleteNotification(notificationId, buttonElement) {
                // X√≥a tr·ª±c ti·∫øp kh√¥ng c·∫ßn x√°c nh·∫≠n
                try {
                    // L·∫•y token an to√†n h∆°n
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (!token) {
                        console.error('RequestVerificationToken not found');
                        alert('Kh√¥ng t√¨m th·∫•y token x√°c th·ª±c');
                        return;
                    }
                    
                    const response = await fetch(`/Customer/Notification/Delete/${notificationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': token
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Delete response:', result);
                    
                    if (result.success) {
                        // X√≥a th√¥ng b√°o kh·ªèi UI
                        const notificationItem = buttonElement.closest('.notification-item');
                        if (notificationItem) {
                            notificationItem.remove();
                        }
                        
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o
                        updateNotificationCounts();
                        
                        // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o khi x√≥a
                    } else {
                        console.error('Delete failed:', result);
                        alert('C√≥ l·ªói x·∫£y ra: ' + (result.message || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a th√¥ng b√°o: ' + error.message);
                }
            }
            
            // Function ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o
            function updateNotificationCounts() {
                const notificationItems = document.querySelectorAll('.notification-item');
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong header stats
                const totalCountElement = document.querySelector('.stat-item:not(.unread) .stat-number');
                const unreadCountElement = document.querySelector('.stat-item.unread .stat-number');
                
                if (totalCountElement) {
                    totalCountElement.textContent = notificationItems.length;
                }
                
                if (unreadCountElement) {
                    unreadCountElement.textContent = unreadItems.length;
                }
                
                // C·∫≠p nh·∫≠t filter tabs
                const filterTabs = document.querySelectorAll('.filter-tab .count');
                filterTabs.forEach(tab => {
                    const tabElement = tab.closest('.filter-tab');
                    if (tabElement.dataset.filter === 'all') {
                        tab.textContent = notificationItems.length;
                    } else if (tabElement.dataset.filter === 'unread') {
                        tab.textContent = unreadItems.length;
                    }
                });
                
                // T·ª± ƒë·ªông ·∫©n/hi·ªán header actions d·ª±a tr√™n s·ªë l∆∞·ª£ng th√¥ng b√°o
                const headerActions = document.getElementById('headerActions');
                const markAllReadBtn = document.getElementById('markAllReadBtn');
                const clearAllBtn = document.getElementById('clearAllBtn');
                
                if (notificationItems.length === 0) {
                    // ·∫®n to√†n b·ªô header actions n·∫øu kh√¥ng c√≥ th√¥ng b√°o
                    if (headerActions) {
                        headerActions.style.display = 'none';
                    }
                } else {
                    // Hi·ªán header actions n·∫øu c√≥ th√¥ng b√°o
                    if (headerActions) {
                        headerActions.style.display = 'flex';
                    }
                    
                    // ·∫®n n√∫t "ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc" n·∫øu kh√¥ng c√≤n th√¥ng b√°o ch∆∞a ƒë·ªçc
                    if (markAllReadBtn) {
                        markAllReadBtn.style.display = unreadItems.length > 0 ? 'flex' : 'none';
                    }
                }
                
                // Hi·ªÉn th·ªã empty state n·∫øu kh√¥ng c√≤n th√¥ng b√°o
                if (notificationItems.length === 0) {
                    showEmptyState();
                }
            }
            
            // Function ƒë·ªÉ hi·ªÉn th·ªã empty state
            function showEmptyState() {
                const notificationList = document.querySelector('.notification-list');
                if (notificationList) {
                    notificationList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="icon-bell-off"></i>
                            </div>
                            <h3>Ch∆∞a c√≥ th√¥ng b√°o n√†o</h3>
                            <p>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ ho·∫°t ƒë·ªông m·ªõi.</p>
                        </div>
                    `;
                }
            }
            
            // Function ƒë·ªÉ hi·ªÉn th·ªã toast notification
            function showToast(message, type = 'info') {
                // T·∫°o toast element
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#16a34a' : '#3b82f6'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    transform: translateX(100%);
                    opacity: 0;
                    transition: all 0.3s ease;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                    toast.style.opacity = '1';
                }, 10);
                
                // T·ª± ƒë·ªông x√≥a sau 3 gi√¢y
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        });
        
        // Global functions cho inline onclick handlers
        window.markAsReadInline = async function(notificationId, element) {
            console.log('markAsReadInline called with notificationId:', notificationId);
            
            const notificationItem = element.closest ? element.closest('.notification-item') : element;
            
            try {
                const response = await fetch(`/Customer/Notification/MarkRead/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                if (result.success) {
                    // Animation ƒë·∫πp khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                    notificationItem.style.transition = 'all 0.3s ease-in-out';
                    notificationItem.style.backgroundColor = 'var(--muted)';
                    notificationItem.style.transform = 'scale(0.98)';
                    
                    setTimeout(() => {
                        notificationItem.classList.remove('unread');
                        notificationItem.classList.add('read');
                        notificationItem.removeAttribute('onclick');
                        
                        // Reset style
                        notificationItem.style.backgroundColor = '';
                        notificationItem.style.transform = '';
                        
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o
                        updateNotificationCounts();
                        
                        // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o
                        updateNotificationBell();
                        
                        // Force remove ƒë√≥m xanh
                        forceRemoveGreenDots();
                        
                        // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                    }, 300);
                } else {
                    alert('C√≥ l·ªói x·∫£y ra: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc');
            }
        };
        
        window.deleteNotificationInline = async function(notificationId, buttonElement) {
            console.log('deleteNotificationInline called with notificationId:', notificationId);
            
            // Ki·ªÉm tra xem notification n√†y c√≥ ƒëang ƒë∆∞·ª£c x√≥a kh√¥ng
            if (window.deletingNotifications.has(notificationId)) {
                console.log('Notification is already being deleted, returning');
                return;
            }
            
            // NgƒÉn ch·∫∑n double click v√† ki·ªÉm tra xem notification c√≤n t·ªìn t·∫°i kh√¥ng
            if (buttonElement.disabled) {
                console.log('Button already disabled, returning');
                return;
            }
            
            // Ki·ªÉm tra xem notification item c√≤n t·ªìn t·∫°i kh√¥ng
            const notificationItem = buttonElement.closest('.notification-item');
            if (!notificationItem) {
                console.log('Notification item not found in DOM');
                return;
            }
            
            // ƒê√°nh d·∫•u notification n√†y ƒëang ƒë∆∞·ª£c x√≥a
            window.deletingNotifications.add(notificationId);
            buttonElement.disabled = true;
            
            // X√≥a tr·ª±c ti·∫øp kh√¥ng c·∫ßn x√°c nh·∫≠n
            try {
                // L·∫•y token an to√†n h∆°n
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (!token) {
                    console.error('RequestVerificationToken not found');
                    alert('Kh√¥ng t√¨m th·∫•y token x√°c th·ª±c');
                    buttonElement.disabled = false;
                    return;
                }
                
                const response = await fetch(`/Customer/Notification/Delete/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': token
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Delete response:', result);
                
                if (result.success) {
                    console.log('Delete successful, removing from DOM');
                    // X√≥a th√¥ng b√°o ngay l·∫≠p t·ª©c
                    if (notificationItem && notificationItem.parentNode) {
                        // Th√™m animation tr∆∞·ªõc khi x√≥a
                        notificationItem.style.transition = 'all 0.3s ease-out';
                        notificationItem.style.opacity = '0';
                        notificationItem.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            if (notificationItem.parentNode) {
                                notificationItem.remove();
                            }
                            
                            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o ngay l·∫≠p t·ª©c
                            updateNotificationCounts();
                            
                            // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o ngay l·∫≠p t·ª©c - ·∫®n ƒë√≥m xanh
                            updateNotificationBell();
                            
                            // Force remove ƒë√≥m xanh
                            forceRemoveGreenDots();
                            
                            // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o khi x√≥a
                        }, 300);
                    } else {
                        console.log('Notification item already removed from DOM');
                        // V·∫´n c·∫≠p nh·∫≠t counts n·∫øu item ƒë√£ b·ªã x√≥a
                        updateNotificationCounts();
                        updateNotificationBell();
                    }
                    
                    // X√≥a notification kh·ªèi set tracking
                    window.deletingNotifications.delete(notificationId);
                } else {
                    console.error('Delete failed:', result);
                    // Ch·ªâ hi·ªÉn th·ªã alert n·∫øu th·ª±c s·ª± c√≥ l·ªói t·ª´ server
                    if (result.message && !result.message.includes('Kh√¥ng t√¨m th·∫•y th√¥ng b√°o')) {
                        alert('C√≥ l·ªói x·∫£y ra: ' + result.message);
                    }
                    buttonElement.disabled = false;
                    // X√≥a notification kh·ªèi set tracking
                    window.deletingNotifications.delete(notificationId);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a th√¥ng b√°o: ' + error.message);
                buttonElement.disabled = false;
                // X√≥a notification kh·ªèi set tracking
                window.deletingNotifications.delete(notificationId);
            }
        };
        
        // Global function ƒë·ªÉ l·ªçc th√¥ng b√°o
        window.filterNotifications = function(filterType) {
            const notificationItems = document.querySelectorAll('.notification-item');
            const filterTabs = document.querySelectorAll('.filter-tab');
            
            // C·∫≠p nh·∫≠t active tab
            filterTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // L·ªçc v√† hi·ªÉn th·ªã th√¥ng b√°o
            notificationItems.forEach(item => {
                let shouldShow = false;
                
                switch (filterType) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'unread':
                        shouldShow = item.classList.contains('unread');
                        break;
                    case 'booking':
                        shouldShow = item.dataset.type === 'booking';
                        break;
                    case 'payment':
                        shouldShow = item.dataset.type.includes('payment');
                        break;
                    default:
                        shouldShow = true;
                }
                
                if (shouldShow) {
                    item.style.display = 'flex';
                    item.style.animation = 'fadeIn 0.3s ease-in-out';
                } else {
                    item.style.display = 'none';
                }
            });
            
            console.log('Filtered notifications by:', filterType);
        };

        // Global function ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o
        window.updateNotificationCounts = function() {
            const notificationItems = document.querySelectorAll('.notification-item');
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            
            console.log('Updating notification counts:', {
                total: notificationItems.length,
                unread: unreadItems.length
            });
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong header stats
            const totalCountElement = document.querySelector('.stat-item:not(.unread) .stat-number');
            const unreadCountElement = document.querySelector('.stat-item.unread .stat-number');
            
            if (totalCountElement) {
                totalCountElement.textContent = notificationItems.length;
            }
            
            if (unreadCountElement) {
                unreadCountElement.textContent = unreadItems.length;
            }
            
            // C·∫≠p nh·∫≠t filter tabs v·ªõi animation
            const filterTabs = document.querySelectorAll('.filter-tab .count');
            filterTabs.forEach(tab => {
                const tabElement = tab.closest('.filter-tab');
                if (tabElement) {
                    const filterType = tabElement.dataset.filter;
                    let count = 0;
                    
                    switch (filterType) {
                        case 'all':
                            count = notificationItems.length;
                            break;
                        case 'unread':
                            count = unreadItems.length;
                            break;
                        case 'booking':
                            count = document.querySelectorAll('.notification-item[data-type="booking"]').length;
                            break;
                        case 'payment':
                            count = Array.from(document.querySelectorAll('.notification-item')).filter(item => item.dataset.type.includes('payment')).length;
                            break;
                    }
                    
                    // Animation khi thay ƒë·ªïi s·ªë
                    tab.style.transform = 'scale(1.2)';
                    tab.style.color = 'var(--primary)';
                    setTimeout(() => {
                        tab.textContent = count;
                        tab.style.transform = 'scale(1)';
                        tab.style.color = '';
                    }, 150);
                }
            });
            
            // T·ª± ƒë·ªông ·∫©n/hi·ªán header actions d·ª±a tr√™n s·ªë l∆∞·ª£ng th√¥ng b√°o
            const headerActions = document.getElementById('headerActions');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            
            if (notificationItems.length === 0) {
                // ·∫®n to√†n b·ªô header actions n·∫øu kh√¥ng c√≥ th√¥ng b√°o
                if (headerActions) {
                    headerActions.style.display = 'none';
                }
            } else {
                // Hi·ªán header actions n·∫øu c√≥ th√¥ng b√°o
                if (headerActions) {
                    headerActions.style.display = 'flex';
                }
                
                // ·∫®n n√∫t "ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc" n·∫øu kh√¥ng c√≤n th√¥ng b√°o ch∆∞a ƒë·ªçc
                if (markAllReadBtn) {
                    markAllReadBtn.style.display = unreadItems.length > 0 ? 'flex' : 'none';
                }
            }
            
            // Hi·ªÉn th·ªã empty state n·∫øu kh√¥ng c√≤n th√¥ng b√°o
            if (notificationItems.length === 0) {
                showEmptyState();
            }
            
            // Log ƒë·ªÉ debug
            console.log('Updated counts:', {
                total: notificationItems.length,
                unread: unreadItems.length,
                headerActionsVisible: headerActions ? headerActions.style.display !== 'none' : false,
                markAllReadVisible: markAllReadBtn ? markAllReadBtn.style.display !== 'none' : false
            });
        };
        
        // Global function ƒë·ªÉ hi·ªÉn th·ªã empty state
        window.showEmptyState = function() {
            const notificationList = document.querySelector('.notification-list');
            if (notificationList) {
                notificationList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="icon-bell-off"></i>
                        </div>
                        <h3>Ch∆∞a c√≥ th√¥ng b√°o n√†o</h3>
                        <p>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ ho·∫°t ƒë·ªông m·ªõi.</p>
                    </div>
                `;
            }
        };
        
        // Global function ƒë·ªÉ hi·ªÉn th·ªã toast notification
        window.showToast = function(message, type = 'info') {
            // T·∫°o toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#16a34a' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                transform: translateX(100%);
                opacity: 0;
                transition: all 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            }, 10);
            
            // T·ª± ƒë·ªông x√≥a sau 3 gi√¢y
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        };
        
        // Global function ƒë·ªÉ mark all as read
        window.markAllReadInline = async function() {
            console.log('markAllReadInline called');
            
            const button = document.getElementById('markAllReadBtn');
            if (button.disabled) return;
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√°nh d·∫•u t·∫•t c·∫£ th√¥ng b√°o ƒë√£ ƒë·ªçc?')) {
                // Disable button v√† th√™m loading state
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                
                const icon = button.querySelector('i');
                icon.className = 'bi bi-hourglass-split';
                icon.style.animation = 'spin 1s linear infinite';
                try {
                    const response = await fetch('/Customer/Notification/MarkAllRead', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc ngay l·∫≠p t·ª©c
                        const unreadItems = document.querySelectorAll('.notification-item.unread');
                        unreadItems.forEach(item => {
                            item.classList.remove('unread');
                            item.classList.add('read');
                            item.removeAttribute('onclick');
                        });
                        
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ngay l·∫≠p t·ª©c
                        updateNotificationCounts();
                        
                        // C·∫≠p nh·∫≠t badge ngay l·∫≠p t·ª©c - ·∫®n ƒë√≥m xanh
                        updateNotificationBell();
                        
                        // Force remove ƒë√≥m xanh
                        forceRemoveGreenDots();
                        
                        // ·∫®n n√∫t mark all read
                        const markAllReadBtn = document.getElementById('markAllReadBtn');
                        if (markAllReadBtn) {
                            markAllReadBtn.style.display = 'none';
                        }
                        
                        // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o khi ƒë√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
                    } else {
                        alert('C√≥ l·ªói x·∫£y ra: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi ƒë√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc');
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.style.opacity = '';
                    button.style.cursor = '';
                    icon.className = 'bi bi-check-circle';
                    icon.style.animation = '';
                }
            }
        };
        
        // Global function ƒë·ªÉ clear all notifications
        window.clearAllInline = async function() {
            console.log('clearAllInline called');
            
            const button = document.getElementById('clearAllBtn');
            if (button.disabled) return;
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ th√¥ng b√°o?')) {
                // Disable button v√† th√™m loading state
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                
                const icon = button.querySelector('i');
                icon.className = 'bi bi-hourglass-split';
                icon.style.animation = 'spin 1s linear infinite';
                try {
                    const response = await fetch('/Customer/Notification/ClearAll', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // X√≥a t·∫•t c·∫£ th√¥ng b√°o ngay l·∫≠p t·ª©c
                        const notificationList = document.querySelector('.notification-list');
                        if (notificationList) {
                            notificationList.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="icon-bell-off"></i>
                                    </div>
                                    <h3>Ch∆∞a c√≥ th√¥ng b√°o n√†o</h3>
                                    <p>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ ho·∫°t ƒë·ªông m·ªõi.</p>
                                </div>
                            `;
                        }
                        
                        // ·∫®n header actions
                        const headerActions = document.getElementById('headerActions');
                        if (headerActions) {
                            headerActions.style.display = 'none';
                        }
                        
                        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√¥ng b√°o ngay l·∫≠p t·ª©c
                        updateNotificationCounts();
                        
                        // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o ngay l·∫≠p t·ª©c - ·∫®n ƒë√≥m xanh
                        updateNotificationBell();
                        
                        // Force remove ƒë√≥m xanh
                        forceRemoveGreenDots();
                        
                        // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o khi x√≥a t·∫•t c·∫£
                    } else {
                        alert('C√≥ l·ªói x·∫£y ra: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi x√≥a t·∫•t c·∫£ th√¥ng b√°o');
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.style.opacity = '';
                    button.style.cursor = '';
                    icon.className = 'bi bi-trash3';
                    icon.style.animation = '';
                }
            }
        };
        

        // Global function ƒë·ªÉ c·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o
        window.updateNotificationBell = function() {
            try {
                // T√≠nh to√°n s·ªë l∆∞·ª£ng th√¥ng b√°o ch∆∞a ƒë·ªçc t·ª´ DOM
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                const unreadCount = unreadItems.length;
                
                console.log('Updating notification bell, unread count:', unreadCount);
                
                // C·∫≠p nh·∫≠t badge trong header ngay l·∫≠p t·ª©c
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline-block';
                        badge.style.visibility = 'visible';
                        badge.style.opacity = '1';
                    } else {
                        badge.style.display = 'none';
                        badge.style.visibility = 'hidden';
                        badge.style.opacity = '0';
                        badge.textContent = '0';
                    }
                    console.log('Badge updated:', badge.style.display, badge.textContent);
                } else {
                    console.log('Badge element not found');
                }
                
                // Force remove t·∫•t c·∫£ ƒë√≥m xanh ngay l·∫≠p t·ª©c
                forceRemoveGreenDots();
                
                // C·∫≠p nh·∫≠t dropdown n·∫øu c√≥
                if (window.loadNotifications) {
                    window.loadNotifications();
                }
                
            } catch (error) {
                console.error('Error updating notification bell:', error);
            }
        };

        // ===== SignalR Real-time Notifications =====
        let notificationConnection = null;

        async function initNotificationSignalR() {
            try {
                // Load SignalR if not already loaded
                if (typeof signalR === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }

                // Get backend URL from meta tag or default
                const metaBackendUrl = document.querySelector('meta[name="backend-url"]')?.getAttribute('content');
                const backendUrl = metaBackendUrl || 'http://localhost:5154';
                const hubUrl = `${backendUrl}/hubs/notification`;

                // Create connection
                notificationConnection = new signalR.HubConnectionBuilder()
                    .withUrl(hubUrl, {
                        skipNegotiation: false,
                        transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.ServerSentEvents | signalR.HttpTransportType.LongPolling
                    })
                    .withAutomaticReconnect({
                        nextRetryDelayInMilliseconds: retryContext => {
                            if (retryContext.elapsedMilliseconds < 60000) {
                                return 2000;
                            } else {
                                return 10000;
                            }
                        }
                    })
                    .configureLogging(signalR.LogLevel.Warning)
                    .build();

                // Handle connection events
                notificationConnection.onreconnecting(() => {
                    console.log('[NotificationHub] Reconnecting...');
                });

                notificationConnection.onreconnected(() => {
                    console.log('[NotificationHub] Reconnected');
                });

                notificationConnection.onclose(() => {
                    console.log('[NotificationHub] Connection closed');
                });

                // Listen for new notifications
                notificationConnection.on('ReceiveNotification', (notification) => {
                    console.log('[NotificationHub] Received notification:', notification);
                    handleNewNotification(notification);
                });

                // Start connection
                await notificationConnection.start();
                console.log('[NotificationHub] Connected successfully');

            } catch (error) {
                console.error('[NotificationHub] Error initializing SignalR:', error);
            }
        }

        function handleNewNotification(notification) {
            if (!notification) return;

            // Show toast notification
            showNotificationToast(notification);

            // Reload page to show new notification (after a delay to show toast)
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        function showNotificationToast(notification) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; min-width: 320px; max-width: 420px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 10000; opacity: 0; transform: translateX(400px); transition: all 0.3s ease;';
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px; padding: 16px; position: relative;">
                    <div style="flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 10px; color: white; font-size: 1.2rem;">
                        <i class="bi bi-bell-fill"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 0.95rem; color: #111827; margin-bottom: 4px;">Th√¥ng b√°o m·ªõi</div>
                        <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.5; word-wrap: break-word;">${escapeHtml(notification.content || notification.Content || '')}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: #6b7280; cursor: pointer; border-radius: 6px;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize SignalR when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initNotificationSignalR();
            
            // L·∫Øng nghe event t·ª´ dropdown khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
            setupCustomerNotificationSync();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (notificationConnection) {
                notificationConnection.stop();
            }
        });
        
        // ===== Sync v·ªõi dropdown khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc =====
        function setupCustomerNotificationSync() {
            console.log('[CustomerNotificationSync] Setting up sync listeners');
            
            // L·∫Øng nghe custom event t·ª´ layout
            window.addEventListener('notificationMarkedRead', function(event) {
                console.log('[CustomerNotificationSync] Received custom event:', event.detail);
                const { action, data } = event.detail;
                handleCustomerNotificationMarkedRead(action, data);
            });
            
            // L·∫Øng nghe BroadcastChannel ƒë·ªÉ sync gi·ªØa c√°c tabs
            try {
                const channel = new BroadcastChannel('customer_notification_sync');
                channel.addEventListener('message', function(event) {
                    console.log('[CustomerNotificationSync] Received BroadcastChannel message:', event.data);
                    const { action, data } = event.data;
                    handleCustomerNotificationMarkedRead(action, data);
                });
                console.log('[CustomerNotificationSync] BroadcastChannel listener set up');
            } catch (e) {
                console.log('[CustomerNotificationSync] BroadcastChannel not supported');
            }
            
            // L·∫Øng nghe localStorage event (fallback)
            window.addEventListener('storage', function(event) {
                if (event.key === 'customer_notification_update') {
                    console.log('[CustomerNotificationSync] Received storage event');
                    try {
                        const update = JSON.parse(event.newValue);
                        if (update) {
                            handleCustomerNotificationMarkedRead(update.action, update.data);
                        }
                    } catch (e) {
                        console.error('[CustomerNotificationSync] Error parsing notification update:', e);
                    }
                }
            });
        }
        
        // X·ª≠ l√Ω khi notification ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc t·ª´ dropdown
        async function handleCustomerNotificationMarkedRead(action, data) {
            console.log('[CustomerNotificationSync] Received:', action, data);
            
            if (action === 'markRead' && data.id) {
                // C·∫≠p nh·∫≠t UI cho notification c·ª• th·ªÉ
                const notificationItem = document.querySelector(`.notification-item[data-notification-id="${data.id}"]`);
                if (notificationItem) {
                    console.log('[CustomerNotificationSync] Found item, updating UI');
                    
                    // Animation ƒë·∫πp khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                    notificationItem.style.transition = 'all 0.3s ease-in-out';
                    notificationItem.style.backgroundColor = 'var(--muted)';
                    notificationItem.style.transform = 'scale(0.98)';
                    
                    setTimeout(() => {
                        notificationItem.classList.remove('unread');
                        notificationItem.classList.add('read');
                        notificationItem.removeAttribute('onclick');
                        
                        // Reset style
                        notificationItem.style.backgroundColor = '';
                        notificationItem.style.transform = '';
                    }, 300);
                    
                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng unread ngay l·∫≠p t·ª©c
                    if (typeof updateNotificationCounts === 'function') {
                        updateNotificationCounts();
                    }
                    
                    // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o
                    if (typeof updateNotificationBell === 'function') {
                        updateNotificationBell();
                    }
                } else {
                    console.log('[CustomerNotificationSync] Item not found, will reload page');
                    // N·∫øu kh√¥ng t√¨m th·∫•y, reload trang sau m·ªôt ch√∫t
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            } else if (action === 'markAllRead') {
                console.log('[CustomerNotificationSync] Marking all as read');
                
                // C·∫≠p nh·∫≠t t·∫•t c·∫£ notifications th√†nh "ƒê√£ ƒë·ªçc"
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                unreadItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.style.transition = 'all 0.3s ease-in-out';
                        item.style.backgroundColor = 'var(--muted)';
                        item.style.transform = 'scale(0.98)';
                        
                        setTimeout(() => {
                            item.classList.remove('unread');
                            item.classList.add('read');
                            item.removeAttribute('onclick');
                            
                            // Reset style
                            item.style.backgroundColor = '';
                            item.style.transform = '';
                        }, 300);
                    }, index * 50);
                });
                
                // ·∫®n n√∫t "ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc"
                const markAllReadBtn = document.getElementById('markAllReadBtn');
                if (markAllReadBtn) {
                    markAllReadBtn.style.display = 'none';
                }
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng unread ngay l·∫≠p t·ª©c
                if (typeof updateNotificationCounts === 'function') {
                    updateNotificationCounts();
                }
                
                // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o
                if (typeof updateNotificationBell === 'function') {
                    updateNotificationBell();
                }
            }
        }
    </script>
}


@model VHS_frontend.Areas.Provider.Models.Booking.BookingListResultDTO
@{
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    ViewData["Title"] = "Quản lí đặt hàng";
}

<div class="order-management-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-receipt-cutoff"></i>
                    </div>
                    <div class="title-content">
                        <h1>Quản lý Đặt hàng</h1>
                        <p>Xem và quản lý tất cả đơn đặt hàng của khách hàng</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-refresh" onclick="location.reload()" title="Làm mới trang">
                    <i class="bi bi-arrow-clockwise"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Header with Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin" id="filterForm">
                <div class="row g-3 align-items-end">
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label class="form-label">Trạng thái</label>
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="" selected="@(string.IsNullOrEmpty(ViewBag.CurrentStatus))">Tất cả</option>
                            <option value="Pending" selected="@(ViewBag.CurrentStatus == "Pending")">Chờ xử lý</option>
                            <option value="Confirmed" selected="@(ViewBag.CurrentStatus == "Confirmed")">Đã xác nhận</option>
                            <option value="Completed" selected="@(ViewBag.CurrentStatus == "Completed")">Hoàn thành</option>
                            <option value="Canceled" selected="@(ViewBag.CurrentStatus == "Canceled")">Đã hủy</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-2">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                    </div>

                    <!-- Search -->
                    <div class="col-md-4">
                        <label class="form-label">Tìm kiếm</label>
                        <input type="text" name="searchTerm" class="form-control" 
                               placeholder="Tên khách hàng, dịch vụ, provider..." value="@ViewBag.SearchTerm" />
                    </div>

                    <!-- Buttons -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Lọc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards - THÁNG NÀY -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="bi bi-calendar-month"></i> Thống kê tháng @DateTime.Now.ToString("MM/yyyy")
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="stat-card stat-pending">
                        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthPending ?? 0)</h3>
                            <p>Chờ xử lý</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-confirmed">
                        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthConfirmed ?? 0)</h3>
                            <p>Đã xác nhận</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-completed">
                        <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCompleted ?? 0)</h3>
                            <p>Hoàn thành</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-canceled">
                        <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCanceled ?? 0)</h3>
                            <p>Đã hủy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>
                Danh sách đơn hàng (@Model.TotalCount)
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Dịch vụ</th>
                                <th>Thời gian</th>
                                <th>Số tiền</th>
                                <th>Trạng thái</th>
                                <th>Nhân viên</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <strong>@booking.BookingCode</strong>
                                        <br />
                                        <small class="text-muted">@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div>@(!string.IsNullOrEmpty(booking.CustomerName) ? booking.CustomerName : "N/A")</div>
                                        <small class="text-muted">@(!string.IsNullOrEmpty(booking.CustomerPhone) ? booking.CustomerPhone : "")</small>
                                    </td>
                                    <td>@booking.ServiceName</td>
                                    <td>@booking.BookingTime.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <strong>@booking.Amount.ToString("N0")đ</strong>
                                        @if (!string.IsNullOrEmpty(booking.PaymentStatus))
                                        {
                                            <br />
                                            <span class="badge payment-badge payment-@(booking.PaymentStatus.ToLower().Replace(" ", "-"))">
                                                @GetPaymentStatusText(booking.PaymentStatus)
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge status-badge status-@(booking.Status.ToLower().Replace(" ", "-"))" style="color: #000000 !important; font-weight: 800 !important;">
                                            @GetStatusText(booking.Status)
                                        </span>
                                        @* Hiển thị countdown timer cho booking Pending *@
                                        @{
                                            var statusNorm = (booking.Status ?? string.Empty).Trim();
                                            // Kiểm tra nhiều cách viết của Pending
                                            var isPendingBooking = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("chờ", StringComparison.OrdinalIgnoreCase);
                                        }
                                        @if (isPendingBooking)
                                        {
                                            var cancelMinutes = booking.AutoCancelMinutes ?? 30; // Mặc định 30 phút
                                            var createdAt = booking.CreatedAt;
                                            // Sử dụng CreatedAt từ booking, nếu không có thì dùng thời gian hiện tại
                                            DateTime validCreatedAt;
                                            if (createdAt != default(DateTime) && createdAt != DateTime.MinValue && createdAt.Year > 2000)
                                            {
                                                validCreatedAt = createdAt;
                                            }
                                            else
                                            {
                                                // Fallback: dùng thời gian hiện tại nếu CreatedAt không hợp lệ
                                                validCreatedAt = DateTime.Now;
                                            }
                                            var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                                            var remainingMinutes = Math.Max(0, (int)Math.Ceiling((cancelTime - DateTime.Now).TotalMinutes));
                                            <br />
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <small class="text-danger" style="font-size: 0.75rem;">
                                                    <i class="bi bi-clock-history"></i>
                                                    <span class="countdown-timer" 
                                                          data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-booking-id="@booking.BookingId"
                                                          data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-current-cancel-minutes="@cancelMinutes">
                                                        Đang tính...
                                                    </span>
                                                </small>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-warning p-0 px-1" 
                                                        style="font-size: 0.7rem; line-height: 1.2;"
                                                        onclick="showEditCancelTimeModal('@booking.BookingId', '@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")', @cancelMinutes, @remainingMinutes)"
                                                        title="Sửa thời gian hủy">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.StaffName))
                                        {
                                            <span class="text-success">
                                                <i class="bi bi-person-check"></i> @booking.StaffName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">
                                                <i class="bi bi-person-x"></i> Chưa phân công
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="AdminBooking" asp-action="Details" asp-area="Admin" asp-route-id="@booking.BookingId" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Chi tiết
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <div class="card-footer">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                @if (Model.PageNumber > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin"
                                           asp-route-pageNumber="@(Model.PageNumber - 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                }

                                @for (int i = 1; i <= Model.TotalPages; i++)
                                {
                                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                        <a class="page-link" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin"
                                           asp-route-pageNumber="@i"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (Model.PageNumber < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin"
                                           asp-route-pageNumber="@(Model.PageNumber + 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">Không có đơn hàng nào</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/booking-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
    <style>
        /* Force status badge text color to black in light mode */
        .order-management-container .badge.status-badge.status-pending,
        .order-management-container .badge.status-badge.status-confirmed,
        .order-management-container .badge.status-badge.status-completed,
        .order-management-container .badge.status-badge.status-canceled,
        .order-management-container .badge.status-badge.status-cancelled,
        .order-management-container table .badge.status-badge {
            color: #000000 !important;
        }
        
        /* Force payment badge text color to black in light mode */
        .order-management-container .payment-badge.payment-paid,
        .order-management-container .payment-badge.payment-unpaid,
        .order-management-container .payment-badge.payment-pending,
        .order-management-container table .payment-badge {
            color: #000000 !important;
        }
        
        /* Force status badge text color to white in dark mode */
        .dark .order-management-container .badge.status-badge.status-pending,
        .dark .order-management-container .badge.status-badge.status-confirmed,
        .dark .order-management-container .badge.status-badge.status-completed,
        .dark .order-management-container .badge.status-badge.status-canceled,
        .dark .order-management-container .badge.status-badge.status-cancelled,
        .dark .order-management-container table .badge.status-badge {
            color: #ffffff !important;
        }
        
        /* Force payment badge text color to white in dark mode */
        .dark .order-management-container .payment-badge.payment-paid,
        .dark .order-management-container .payment-badge.payment-unpaid,
        .dark .order-management-container .payment-badge.payment-pending,
        .dark .order-management-container table .payment-badge {
            color: #ffffff !important;
        }
        
        /* Allow status and payment badges to wrap text */
        .order-management-container table tbody td {
            white-space: normal !important;
            word-wrap: break-word;
        }
        
        .order-management-container .badge.status-badge,
        .order-management-container .badge.payment-badge {
            white-space: normal !important;
            word-wrap: break-word;
            display: inline-block;
            max-width: 100%;
            line-height: 1.4;
            text-align: center;
        }
        
        /* Đảm bảo tất cả payment badge có border */
        .order-management-container .badge.payment-badge,
        .order-management-container table .badge.payment-badge,
        .order-management-container table tbody td .badge.payment-badge {
            padding: 0.4rem 0.75rem !important;
            border-radius: 6px !important;
        }
        
        /* Border cho payment badge trong light mode */
        .order-management-container .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]),
        .order-management-container table .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]) {
            border: 1px solid #6b7280 !important;
        }
        
        /* Border cho payment badge trong dark mode */
        .dark .order-management-container .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]),
        .dark .order-management-container table .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]) {
            border: 2px solid rgba(156, 163, 175, 0.8) !important;
        }
        
        /* Ensure table cells can wrap */
        .order-management-container table td {
            vertical-align: middle;
        }
        
        /* Status Pending Badge - Vàng (Chờ xử lý) */
        .order-management-container .badge.status-badge.status-pending,
        .order-management-container table .badge.status-badge.status-pending,
        .order-management-container table tbody td .badge.status-badge.status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .order-management-container .badge.status-badge.status-pending,
        .dark .order-management-container table .badge.status-badge.status-pending,
        .dark .order-management-container table tbody td .badge.status-badge.status-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Service Completed Status Badge - Xanh dương nhạt (Xác nhận hoàn thành) */
        .order-management-container .badge.status-badge.status-service-completed,
        .order-management-container table .badge.status-badge.status-service-completed,
        .order-management-container table tbody td .badge.status-badge.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 2px solid #6366f1 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .order-management-container .badge.status-badge.status-service-completed,
        .dark .order-management-container table .badge.status-badge.status-service-completed,
        .dark .order-management-container table tbody td .badge.status-badge.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Paid Badge - Xanh lá (Đã thanh toán) */
        .order-management-container .payment-badge.payment-paid,
        .order-management-container table .payment-badge.payment-paid,
        .order-management-container table tbody td .payment-badge.payment-paid,
        .order-management-container .badge.payment-badge.payment-paid,
        .order-management-container table .badge.payment-badge.payment-paid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: #ffffff !important;
            border: 2px solid #047857 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-paid,
        .dark .order-management-container table .payment-badge.payment-paid,
        .dark .order-management-container table tbody td .payment-badge.payment-paid,
        .dark .order-management-container .badge.payment-badge.payment-paid,
        .dark .order-management-container table .badge.payment-badge.payment-paid {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.5) 0%, rgba(5, 150, 105, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(16, 185, 129, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.5) !important;
        }
        
        /* Payment Unpaid Badge - Đỏ (Chưa thanh toán) */
        .order-management-container .payment-badge.payment-unpaid,
        .order-management-container table .payment-badge.payment-unpaid,
        .order-management-container table tbody td .payment-badge.payment-unpaid,
        .order-management-container .badge.payment-badge.payment-unpaid,
        .order-management-container table .badge.payment-badge.payment-unpaid {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b91c1c !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-unpaid,
        .dark .order-management-container table .payment-badge.payment-unpaid,
        .dark .order-management-container table tbody td .payment-badge.payment-unpaid,
        .dark .order-management-container .badge.payment-badge.payment-unpaid,
        .dark .order-management-container table .badge.payment-badge.payment-unpaid {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.5) !important;
        }
        
        /* Payment Pending Badge - Vàng (Chờ thanh toán) */
        .order-management-container .payment-badge.payment-pending,
        .order-management-container table .payment-badge.payment-pending,
        .order-management-container table tbody td .payment-badge.payment-pending,
        .order-management-container .badge.payment-badge.payment-pending,
        .order-management-container table .badge.payment-badge.payment-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-pending,
        .dark .order-management-container table .payment-badge.payment-pending,
        .dark .order-management-container table tbody td .payment-badge.payment-pending,
        .dark .order-management-container .badge.payment-badge.payment-pending,
        .dark .order-management-container table .badge.payment-badge.payment-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Payment Rejected Badge - Đỏ đậm (Đã từ chối) */
        .order-management-container .payment-badge.payment-rejected,
        .order-management-container table .payment-badge.payment-rejected,
        .order-management-container table tbody td .payment-badge.payment-rejected,
        .order-management-container .badge.payment-badge.payment-rejected,
        .order-management-container table .badge.payment-badge.payment-rejected {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: #ffffff !important;
            border: 2px solid #991b1b !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-rejected,
        .dark .order-management-container table .payment-badge.payment-rejected,
        .dark .order-management-container table tbody td .payment-badge.payment-rejected,
        .dark .order-management-container .badge.payment-badge.payment-rejected,
        .dark .order-management-container table .badge.payment-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.5) 0%, rgba(185, 28, 28, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(220, 38, 38, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.5) !important;
        }
        
        /* Payment Refunded Badge - Cam (Đã hoàn tiền) */
        .order-management-container .payment-badge.payment-refunded,
        .order-management-container table .payment-badge.payment-refunded,
        .order-management-container table tbody td .payment-badge.payment-refunded,
        .order-management-container .badge.payment-badge.payment-refunded,
        .order-management-container table .badge.payment-badge.payment-refunded {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
            color: #ffffff !important;
            border: 2px solid #92400e !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(217, 119, 6, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-refunded,
        .dark .order-management-container table .payment-badge.payment-refunded,
        .dark .order-management-container table tbody td .payment-badge.payment-refunded,
        .dark .order-management-container .badge.payment-badge.payment-refunded,
        .dark .order-management-container table .badge.payment-badge.payment-refunded {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.5) 0%, rgba(180, 83, 9, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(217, 119, 6, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(217, 119, 6, 0.5) !important;
        }
    </style>
}

@section Scripts {
    <script>
        // Countdown timer cho booking Pending
        // Đưa function ra ngoài để có thể gọi từ bất kỳ đâu
        function updateCountdown() {
            const timers = document.querySelectorAll('.countdown-timer');
            console.log('Found countdown timers:', timers.length);
            
            timers.forEach(timer => {
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (!cancelTimeStr) return;
                
                // Parse thời gian hủy (đã là giờ Việt Nam từ server)
                const cancelTime = new Date(cancelTimeStr);
                const now = new Date();
                
                // Tính thời gian còn lại (milliseconds)
                const diff = cancelTime - now;
                
                if (diff <= 0) {
                    // Đã quá thời gian hủy
                    timer.innerHTML = '<span class="text-danger fw-bold">Đã quá thời hạn</span>';
                    timer.classList.add('text-danger');
                } else {
                    // Tính giờ, phút, giây còn lại
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    // Format hiển thị
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours} giờ ${minutes} phút`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes} phút ${seconds} giây`;
                    } else {
                        timeStr = `${seconds} giây`;
                    }
                    
                    // Thêm màu cảnh báo nếu còn < 5 phút
                    if (diff < 5 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-danger fw-bold">Còn ${timeStr}</span>`;
                    } else if (diff < 15 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-warning fw-bold">Còn ${timeStr}</span>`;
                    } else {
                        timer.innerHTML = `Còn ${timeStr}`;
                    }
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Countdown timer script loaded');
            
            // Cập nhật ngay lập tức
            updateCountdown();
            
            // Cập nhật mỗi giây và kiểm tra xem có booking nào hết thời gian không
            let reloadScheduled = false; // Để tránh reload nhiều lần
            setInterval(function() {
                updateCountdown();
                
                // Kiểm tra xem có booking nào đã hết thời gian không (ngay lập tức)
                if (!reloadScheduled) {
                    const timers = document.querySelectorAll('.countdown-timer');
                    let hasExpired = false;
                    
                    timers.forEach(timer => {
                        const cancelTimeStr = timer.getAttribute('data-cancel-time');
                        if (!cancelTimeStr) return;
                        
                        const cancelTime = new Date(cancelTimeStr);
                        const now = new Date();
                        const diff = cancelTime - now;
                        
                        if (diff <= 0) {
                            hasExpired = true;
                        }
                    });
                    
                    if (hasExpired) {
                        reloadScheduled = true; // Đánh dấu đã schedule reload
                        console.log('⏰ Detected expired booking, reloading page in 2 seconds...');
                        // Reload sau 2 giây để đảm bảo backend đã xử lý xong
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    }
                }
            }, 1000); // Check mỗi giây để phát hiện ngay khi hết thời gian
        });

        // Modal và function để admin chỉnh sửa thời gian hủy
        function showEditCancelTimeModal(bookingId, createdAtStr, currentCancelMinutes, remainingMinutes) {
            // Tạo modal HTML
            const modalHtml = `
                <div class="modal fade" id="editCancelTimeModal" tabindex="-1" aria-labelledby="editCancelTimeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editCancelTimeModalLabel">
                                    <i class="bi bi-clock-history me-2"></i>
                                    Sửa thời gian tự động hủy
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Thời gian còn lại hiện tại:</label>
                                    <div class="alert alert-info mb-0">
                                        <strong id="currentRemainingTime">Đang tính...</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="newRemainingMinutes" class="form-label">
                                        Thời gian còn lại mới (phút):
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="newRemainingMinutes" 
                                           min="1" 
                                           max="1440" 
                                           value="${Math.max(1, remainingMinutes)}"
                                           placeholder="Nhập số phút còn lại">
                                    <div id="errorMessage" class="text-danger mt-1" style="display: none; font-size: 0.875rem;"></div>
                                    <small class="form-text text-muted">
                                        Ví dụ: Nhập 1 để đặt thời gian còn lại là 1 phút
                                    </small>
                                </div>
                                <input type="hidden" id="editBookingId" value="${bookingId}">
                                <input type="hidden" id="editCreatedAt" value="${createdAtStr}">
                                <input type="hidden" id="editCurrentCancelMinutes" value="${currentCancelMinutes}">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-warning" onclick="saveCancelTime()">
                                    <i class="bi bi-save me-1"></i>
                                    Lưu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('editCancelTimeModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Thêm modal mới vào body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Hiển thị modal
            const modal = new bootstrap.Modal(document.getElementById('editCancelTimeModal'));
            modal.show();
            
            // Cập nhật thời gian còn lại hiện tại
            updateCurrentRemainingTime();
            
            // Ẩn thông báo lỗi khi người dùng bắt đầu nhập
            const inputField = document.getElementById('newRemainingMinutes');
            const errorDiv = document.getElementById('errorMessage');
            if (inputField) {
                inputField.addEventListener('input', function() {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                        errorDiv.textContent = '';
                    }
                    inputField.classList.remove('is-invalid');
                });
            }
        }

        function updateCurrentRemainingTime() {
            const timer = document.querySelector(`.countdown-timer[data-booking-id="${document.getElementById('editBookingId').value}"]`);
            if (timer) {
                const currentText = timer.textContent.trim();
                document.getElementById('currentRemainingTime').textContent = currentText || 'Đang tính...';
            }
        }

        async function saveCancelTime() {
            const bookingId = document.getElementById('editBookingId').value;
            const createdAtStr = document.getElementById('editCreatedAt').value;
            const newRemainingMinutes = parseInt(document.getElementById('newRemainingMinutes').value);
            const errorDiv = document.getElementById('errorMessage');
            const inputField = document.getElementById('newRemainingMinutes');
            
            // Ẩn thông báo lỗi trước đó
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // Xóa class lỗi từ input
            if (inputField) {
                inputField.classList.remove('is-invalid');
            }
            
            if (!newRemainingMinutes || newRemainingMinutes < 1) {
                // Hiển thị thông báo lỗi dưới ô nhập
                if (errorDiv) {
                    errorDiv.textContent = 'Vui lòng nhập số phút hợp lệ (từ 1 phút trở lên)';
                    errorDiv.style.display = 'block';
                }
                if (inputField) {
                    inputField.classList.add('is-invalid');
                }
                return;
            }
            
            // Disable nút để tránh double submit
            const saveBtn = document.querySelector('#editCancelTimeModal .btn-warning');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Đang xử lý...';
            }
            
            try {
                // Gọi action trong controller để cập nhật
                // Controller sẽ tính toán AutoCancelMinutes dựa trên CreatedAt và remainingMinutes
                const url = `/Admin/AdminBooking/UpdateCancelTime?bookingId=${bookingId}&remainingMinutes=${newRemainingMinutes}&createdAt=${encodeURIComponent(createdAtStr)}`;
                console.log('Calling URL:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error('Lỗi khi cập nhật thời gian hủy: ' + errorText);
                }
                
                const result = await response.json();
                console.log('Result:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Lỗi khi cập nhật thời gian hủy');
                }
                
                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCancelTimeModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Cập nhật countdown timer ngay lập tức mà không cần reload
                const timer = document.querySelector(`.countdown-timer[data-booking-id="${bookingId}"]`);
                if (timer) {
                    // Lấy createdAt từ timer hoặc từ input
                    const timerCreatedAt = timer.getAttribute('data-created-at') || createdAtStr;
                    const createdAt = new Date(timerCreatedAt);
                    
                    // Tính lại thời gian hủy mới
                    const newAutoCancelMinutes = result.newAutoCancelMinutes || newRemainingMinutes;
                    const newCancelTime = new Date(createdAt.getTime() + newAutoCancelMinutes * 60 * 1000);
                    
                    // Format: yyyy-MM-ddTHH:mm:ss (giống format từ server)
                    const year = newCancelTime.getFullYear();
                    const month = String(newCancelTime.getMonth() + 1).padStart(2, '0');
                    const day = String(newCancelTime.getDate()).padStart(2, '0');
                    const hours = String(newCancelTime.getHours()).padStart(2, '0');
                    const minutes = String(newCancelTime.getMinutes()).padStart(2, '0');
                    const seconds = String(newCancelTime.getSeconds()).padStart(2, '0');
                    const formattedTime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
                    
                    // Cập nhật attributes
                    timer.setAttribute('data-cancel-time', formattedTime);
                    timer.setAttribute('data-current-cancel-minutes', newAutoCancelMinutes);
                    
                    // Cập nhật ngay lập tức
                    updateCountdown();
                    
                    console.log('✅ Đã cập nhật countdown timer ngay lập tức:', {
                        bookingId: bookingId,
                        newAutoCancelMinutes: newAutoCancelMinutes,
                        newCancelTime: newCancelTime
                    });
                } else {
                    // Nếu không tìm thấy timer, reload trang
                    console.warn('Không tìm thấy timer, reload trang...');
                    location.reload();
                }
            } catch (error) {
                console.error('Error updating cancel time:', error);
                
                // Hiển thị thông báo lỗi dưới ô nhập
                const errorDiv = document.getElementById('errorMessage');
                const inputField = document.getElementById('newRemainingMinutes');
                if (errorDiv) {
                    errorDiv.textContent = 'Lỗi: ' + error.message;
                    errorDiv.style.display = 'block';
                }
                if (inputField) {
                    inputField.classList.add('is-invalid');
                }
                
                // Re-enable nút
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Lưu';
                }
            }
        }
    </script>
}

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "pendingpayment" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "inprogress" or "in progress" or "in-progress" => "Đang xử lý",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string GetPaymentStatusText(string paymentStatus)
    {
        if (string.IsNullOrWhiteSpace(paymentStatus))
            return "Chưa xác định";
            
        var statusLower = paymentStatus.Trim().ToLower();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            _ => paymentStatus
        };
    }
}


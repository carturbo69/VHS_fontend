@model VHS_frontend.Areas.Provider.Models.Booking.BookingListResultDTO
@{
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    ViewData["Title"] = "Quản lí đặt hàng";
}

<div class="order-management-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-receipt-cutoff"></i>
                    </div>
                    <div class="title-content">
                        <h1>Quản lý Đặt hàng</h1>
                        <p>Xem và quản lý tất cả đơn đặt hàng của khách hàng</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-refresh" onclick="location.reload()" title="Làm mới trang">
                    <i class="bi bi-arrow-clockwise"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Header with Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin" id="filterForm">
                <div class="row g-3 align-items-end">
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label class="form-label">Trạng thái</label>
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="" selected="@(string.IsNullOrEmpty(ViewBag.CurrentStatus))">Tất cả</option>
                            <option value="Pending" selected="@(ViewBag.CurrentStatus == "Pending")">Chờ xử lý</option>
                            <option value="Confirmed" selected="@(ViewBag.CurrentStatus == "Confirmed")">Đã xác nhận</option>
                            <option value="Completed" selected="@(ViewBag.CurrentStatus == "Completed")">Hoàn thành</option>
                            <option value="Canceled" selected="@(ViewBag.CurrentStatus == "Canceled")">Đã hủy</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-2">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                    </div>

                    <!-- Search -->
                    <div class="col-md-4">
                        <label class="form-label">Tìm kiếm</label>
                        <input type="text" name="searchTerm" class="form-control" 
                               placeholder="Tên khách hàng, dịch vụ, nhà cung cấo..." value="@ViewBag.SearchTerm" />
                    </div>

                    <!-- Buttons -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Lọc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards - THÁNG NÀY -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="bi bi-calendar-month"></i> Thống kê tháng @DateTime.Now.ToString("MM/yyyy")
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="stat-card stat-pending">
                        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthPending ?? 0)</h3>
                            <p>Chờ xử lý</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-confirmed">
                        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthConfirmed ?? 0)</h3>
                            <p>Đã xác nhận</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-completed">
                        <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCompleted ?? 0)</h3>
                            <p>Hoàn thành</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-canceled">
                        <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCanceled ?? 0)</h3>
                            <p>Đã hủy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>
                Danh sách đơn hàng (@Model.TotalCount)
            </h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Dịch vụ</th>
                                <th>Thời gian</th>
                                <th>Số tiền</th>
                                <th>Trạng thái</th>
                                <th>Nhân viên</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <strong>@booking.BookingCode</strong>
                                        <br />
                                        <small class="text-muted">@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div>@(!string.IsNullOrEmpty(booking.CustomerName) ? booking.CustomerName : "N/A")</div>
                                        <small class="text-muted">@(!string.IsNullOrEmpty(booking.CustomerPhone) ? booking.CustomerPhone : "")</small>
                                    </td>
                                    <td>@booking.ServiceName</td>
                                    <td>@booking.BookingTime.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <strong>@booking.Amount.ToString("N0")đ</strong>
                                        @if (!string.IsNullOrEmpty(booking.PaymentStatus))
                                        {
                                            <br />
                                            <span class="badge payment-badge payment-@(booking.PaymentStatus.ToLower().Replace(" ", "-"))">
                                                @GetPaymentStatusText(booking.PaymentStatus)
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge status-badge status-@(booking.Status.ToLower().Replace(" ", "-"))" style="color: #000000 !important; font-weight: 800 !important;">
                                            @GetStatusText(booking.Status)
                                        </span>
                                        @* Hiển thị countdown timer cho booking Pending *@
                                        @{
                                            var statusNorm = (booking.Status ?? string.Empty).Trim();
                                            // Kiểm tra nhiều cách viết của Pending
                                            var isPendingBooking = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("chờ", StringComparison.OrdinalIgnoreCase);
                                        }
                                        @if (isPendingBooking)
                                        {
                                            var cancelMinutes = booking.AutoCancelMinutes ?? 30; // Mặc định 30 phút
                                            var createdAt = booking.CreatedAt;
                                            // Sử dụng CreatedAt từ booking, nếu không có thì dùng thời gian hiện tại
                                            DateTime validCreatedAt;
                                            if (createdAt != default(DateTime) && createdAt != DateTime.MinValue && createdAt.Year > 2000)
                                            {
                                                validCreatedAt = createdAt;
                                            }
                                            else
                                            {
                                                // Fallback: dùng thời gian hiện tại nếu CreatedAt không hợp lệ
                                                validCreatedAt = DateTime.Now;
                                            }
                                            var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                                            var remainingMinutes = Math.Max(0, (int)Math.Ceiling((cancelTime - DateTime.Now).TotalMinutes));
                                            <br />
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <small class="text-danger" style="font-size: 0.75rem;">
                                                    <i class="bi bi-clock-history"></i>
                                                    <span class="countdown-timer" 
                                                          data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-booking-id="@booking.BookingId"
                                                          data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-current-cancel-minutes="@cancelMinutes">
                                                        Đang tính...
                                                    </span>
                                                </small>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-warning p-0 px-1" 
                                                        style="font-size: 0.7rem; line-height: 1.2;"
                                                        onclick="showEditCancelTimeModal('@booking.BookingId', '@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")', @cancelMinutes, @remainingMinutes)"
                                                        title="Sửa thời gian hủy">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.StaffName))
                                        {
                                            <span class="text-success">
                                                <i class="bi bi-person-check"></i> @booking.StaffName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">
                                                <i class="bi bi-person-x"></i> Chưa phân công
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="AdminBooking" asp-action="Details" asp-area="Admin" asp-route-id="@booking.BookingId" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Chi tiết
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <div class="card-footer">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                @if (Model.PageNumber > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin"
                                           asp-route-pageNumber="@(Model.PageNumber - 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                }

                                @for (int i = 1; i <= Model.TotalPages; i++)
                                {
                                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                        <a class="page-link" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin"
                                           asp-route-pageNumber="@i"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (Model.PageNumber < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-controller="AdminBooking" asp-action="Index" asp-area="Admin"
                                           asp-route-pageNumber="@(Model.PageNumber + 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">Không có đơn hàng nào</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-booking.css" asp-append-version="true" />
    <style>
        /* Force status badge text color to black in light mode */
        .order-management-container .badge.status-badge.status-pending,
        .order-management-container .badge.status-badge.status-confirmed,
        .order-management-container .badge.status-badge.status-completed,
        .order-management-container .badge.status-badge.status-canceled,
        .order-management-container .badge.status-badge.status-cancelled,
        .order-management-container table .badge.status-badge {
            color: #000000 !important;
        }
        
        /* Force payment badge text color to black in light mode */
        .order-management-container .payment-badge.payment-paid,
        .order-management-container .payment-badge.payment-unpaid,
        .order-management-container .payment-badge.payment-pending,
        .order-management-container table .payment-badge {
            color: #000000 !important;
        }
        
        /* Force status badge text color to white in dark mode */
        .dark .order-management-container .badge.status-badge.status-pending,
        .dark .order-management-container .badge.status-badge.status-confirmed,
        .dark .order-management-container .badge.status-badge.status-completed,
        .dark .order-management-container .badge.status-badge.status-canceled,
        .dark .order-management-container .badge.status-badge.status-cancelled,
        .dark .order-management-container table .badge.status-badge {
            color: #ffffff !important;
        }
        
        /* Force payment badge text color to white in dark mode */
        .dark .order-management-container .payment-badge.payment-paid,
        .dark .order-management-container .payment-badge.payment-unpaid,
        .dark .order-management-container .payment-badge.payment-pending,
        .dark .order-management-container table .payment-badge {
            color: #ffffff !important;
        }
        
        /* Allow status and payment badges to wrap text */
        .order-management-container table tbody td {
            white-space: normal !important;
            word-wrap: break-word;
        }
        
        .order-management-container .badge.status-badge,
        .order-management-container .badge.payment-badge {
            white-space: normal !important;
            word-wrap: break-word;
            display: inline-block;
            max-width: 100%;
            line-height: 1.4;
            text-align: center;
        }
        
        /* Đảm bảo tất cả payment badge có border */
        .order-management-container .badge.payment-badge,
        .order-management-container table .badge.payment-badge,
        .order-management-container table tbody td .badge.payment-badge {
            padding: 0.4rem 0.75rem !important;
            border-radius: 6px !important;
        }
        
        /* Border cho payment badge trong light mode */
        .order-management-container .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]),
        .order-management-container table .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]) {
            border: 1px solid #6b7280 !important;
        }
        
        /* Border cho payment badge trong dark mode */
        .dark .order-management-container .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]),
        .dark .order-management-container table .badge.payment-badge:not([class*="payment-paid"]):not([class*="payment-unpaid"]):not([class*="payment-pending"]):not([class*="payment-rejected"]):not([class*="payment-refunded"]) {
            border: 2px solid rgba(156, 163, 175, 0.8) !important;
        }
        
        /* Ensure table cells can wrap */
        .order-management-container table td {
            vertical-align: middle;
        }
        
        /* Status Pending Badge - Vàng (Chờ xử lý) */
        .order-management-container .badge.status-badge.status-pending,
        .order-management-container table .badge.status-badge.status-pending,
        .order-management-container table tbody td .badge.status-badge.status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .order-management-container .badge.status-badge.status-pending,
        .dark .order-management-container table .badge.status-badge.status-pending,
        .dark .order-management-container table tbody td .badge.status-badge.status-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Service Completed Status Badge - Xanh dương nhạt (Xác nhận hoàn thành) */
        .order-management-container .badge.status-badge.status-service-completed,
        .order-management-container table .badge.status-badge.status-service-completed,
        .order-management-container table tbody td .badge.status-badge.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 2px solid #6366f1 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .order-management-container .badge.status-badge.status-service-completed,
        .dark .order-management-container table .badge.status-badge.status-service-completed,
        .dark .order-management-container table tbody td .badge.status-badge.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Paid Badge - Xanh lá (Đã thanh toán) */
        .order-management-container .payment-badge.payment-paid,
        .order-management-container table .payment-badge.payment-paid,
        .order-management-container table tbody td .payment-badge.payment-paid,
        .order-management-container .badge.payment-badge.payment-paid,
        .order-management-container table .badge.payment-badge.payment-paid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: #ffffff !important;
            border: 2px solid #047857 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-paid,
        .dark .order-management-container table .payment-badge.payment-paid,
        .dark .order-management-container table tbody td .payment-badge.payment-paid,
        .dark .order-management-container .badge.payment-badge.payment-paid,
        .dark .order-management-container table .badge.payment-badge.payment-paid {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.5) 0%, rgba(5, 150, 105, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(16, 185, 129, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.5) !important;
        }
        
        /* Payment Unpaid Badge - Đỏ (Chưa thanh toán) */
        .order-management-container .payment-badge.payment-unpaid,
        .order-management-container table .payment-badge.payment-unpaid,
        .order-management-container table tbody td .payment-badge.payment-unpaid,
        .order-management-container .badge.payment-badge.payment-unpaid,
        .order-management-container table .badge.payment-badge.payment-unpaid {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b91c1c !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-unpaid,
        .dark .order-management-container table .payment-badge.payment-unpaid,
        .dark .order-management-container table tbody td .payment-badge.payment-unpaid,
        .dark .order-management-container .badge.payment-badge.payment-unpaid,
        .dark .order-management-container table .badge.payment-badge.payment-unpaid {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.5) !important;
        }
        
        /* Payment Pending Badge - Vàng (Chờ thanh toán) */
        .order-management-container .payment-badge.payment-pending,
        .order-management-container table .payment-badge.payment-pending,
        .order-management-container table tbody td .payment-badge.payment-pending,
        .order-management-container .badge.payment-badge.payment-pending,
        .order-management-container table .badge.payment-badge.payment-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-pending,
        .dark .order-management-container table .payment-badge.payment-pending,
        .dark .order-management-container table tbody td .payment-badge.payment-pending,
        .dark .order-management-container .badge.payment-badge.payment-pending,
        .dark .order-management-container table .badge.payment-badge.payment-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Payment Rejected Badge - Đỏ đậm (Đã từ chối) */
        .order-management-container .payment-badge.payment-rejected,
        .order-management-container table .payment-badge.payment-rejected,
        .order-management-container table tbody td .payment-badge.payment-rejected,
        .order-management-container .badge.payment-badge.payment-rejected,
        .order-management-container table .badge.payment-badge.payment-rejected {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: #ffffff !important;
            border: 2px solid #991b1b !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-rejected,
        .dark .order-management-container table .payment-badge.payment-rejected,
        .dark .order-management-container table tbody td .payment-badge.payment-rejected,
        .dark .order-management-container .badge.payment-badge.payment-rejected,
        .dark .order-management-container table .badge.payment-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.5) 0%, rgba(185, 28, 28, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(220, 38, 38, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.5) !important;
        }
        
        /* Payment Refunded Badge - Cam (Đã hoàn tiền) */
        .order-management-container .payment-badge.payment-refunded,
        .order-management-container table .payment-badge.payment-refunded,
        .order-management-container table tbody td .payment-badge.payment-refunded,
        .order-management-container .badge.payment-badge.payment-refunded,
        .order-management-container table .badge.payment-badge.payment-refunded {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
            color: #ffffff !important;
            border: 2px solid #92400e !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(217, 119, 6, 0.3) !important;
        }
        
        .dark .order-management-container .payment-badge.payment-refunded,
        .dark .order-management-container table .payment-badge.payment-refunded,
        .dark .order-management-container table tbody td .payment-badge.payment-refunded,
        .dark .order-management-container .badge.payment-badge.payment-refunded,
        .dark .order-management-container table .badge.payment-badge.payment-refunded {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.5) 0%, rgba(180, 83, 9, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(217, 119, 6, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(217, 119, 6, 0.5) !important;
        }
    </style>
}

@section Scripts {
    <script>
        // AutoCancelManager: Quản lý tập trung để tránh duplicate calls
        const AutoCancelManager = {
            processed: new Set(),
            inProgress: new Set(),
            callQueue: new Map(),
            
            async call(bookingId, isPendingExpired) {
                const id = String(bookingId).trim();
                
                if (this.processed.has(id) || this.inProgress.has(id)) {
                    return Promise.resolve();
                }
                
                if (this.callQueue.has(id)) {
                    return this.callQueue.get(id);
                }
                
                const promise = this._executeCall(id, isPendingExpired);
                this.callQueue.set(id, promise);
                this.inProgress.add(id);
                
                promise.finally(() => {
                    this.callQueue.delete(id);
                    this.inProgress.delete(id);
                    this.processed.add(id);
                });
                
                return promise;
            },
            
            async _executeCall(bookingId, isPendingExpired) {
                try {
                    const response = await fetch('/Provider/Order/AutoCancel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            bookingId: bookingId,
                            isPendingExpired: isPendingExpired
                        })
                    });
                    
                    // ✨ QUAN TRỌNG: Kiểm tra cả HTTP status VÀ response body
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        throw new Error(`Auto-cancel failed: ${response.status} - ${responseText}`);
                    }
                    
                    // Parse JSON response để kiểm tra success flag
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // Nếu không phải JSON, coi như thành công nếu HTTP status OK
                        return Promise.resolve();
                    }
                    
                    // ✨ KIỂM TRA success flag trong response body
                    if (result && result.success === true) {
                        // API thành công và database đã được cập nhật
                        return Promise.resolve();
                    } else {
                        // API trả về nhưng success = false
                        throw new Error(result?.message || 'Auto-cancel failed: Backend reported failure');
                    }
                } catch (error) {
                    console.error(`[AUTO CANCEL] Error for booking ${bookingId}:`, error);
                    throw error;
                }
            },
            
            reset(bookingId) {
                const id = String(bookingId).trim();
                this.processed.delete(id);
                this.inProgress.delete(id);
                this.callQueue.delete(id);
            }
        };
        
        // Countdown timer cho booking Pending
        // Đưa function ra ngoài để có thể gọi từ bất kỳ đâu
        function updateCountdown() {
            const timers = document.querySelectorAll('.countdown-timer');
            
            timers.forEach(timer => {
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (!cancelTimeStr) return;
                
                const bookingId = timer.getAttribute('data-booking-id');
                if (!bookingId) return;
                
                // Nếu đã được xử lý, ẩn timer
                if (AutoCancelManager.processed.has(String(bookingId).trim())) {
                    const countdownContainer = timer.closest('.d-flex');
                    if (countdownContainer) {
                        countdownContainer.style.display = 'none';
                    } else {
                        timer.style.display = 'none';
                    }
                    return;
                }
                
                const cancelTime = new Date(cancelTimeStr);
                const now = new Date();
                const diff = cancelTime - now;
                
                if (diff <= 0) {
                    // Đã quá thời gian - GỌI API TRƯỚC, KHÔNG CẬP NHẬT UI TRƯỚC
                    if (!AutoCancelManager.processed.has(String(bookingId).trim())) {
                        // Hiển thị "Đang xử lý" trong khi gọi API
                        timer.innerHTML = '<span class="text-warning fw-bold">Đang hủy đơn...</span>';
                        timer.classList.add('text-warning');
                        
                        // Gọi API auto-cancel và đợi kết quả
                        AutoCancelManager.call(bookingId, true).then(() => {
                            // API thành công - refresh để lấy dữ liệu từ database
                            refreshBookingListSilent();
                        }).catch(err => {
                            // Nếu API fail, reset state và hiển thị lỗi
                            AutoCancelManager.reset(bookingId);
                            timer.innerHTML = '<span class="text-danger fw-bold">Lỗi khi hủy</span>';
                            console.error(`[AUTO CANCEL] Error:`, err);
                        });
                        
                        return;
                    }
                    
                    // Nếu đã được xử lý, ẩn timer
                    if (timer.parentElement && timer.isConnected) {
                        timer.style.display = 'none';
                    }
                } else {
                    // Tính giờ, phút, giây còn lại
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    // Format hiển thị
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours} giờ ${minutes} phút`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes} phút ${seconds} giây`;
                    } else {
                        timeStr = `${seconds} giây`;
                    }
                    
                    // Thêm màu cảnh báo nếu còn < 5 phút
                    if (diff < 5 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-danger fw-bold">Còn ${timeStr}</span>`;
                    } else if (diff < 15 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-warning fw-bold">Còn ${timeStr}</span>`;
                    } else {
                        timer.innerHTML = `Còn ${timeStr}`;
                    }
                }
            });
        }
        
        // ========================================
        // AUTO-REFRESH: Tự động cập nhật danh sách booking KHÔNG RELOAD TRANG
        // ========================================
        let isRefreshing = false;
        let refreshInterval = null;
        
        // Function để fetch và cập nhật danh sách booking động (có notification)
        async function refreshBookingList(showNotification = true) {
            if (isRefreshing) return;
            
            // Kiểm tra nếu user đang tương tác với form hoặc modal
            const activeModal = document.querySelector('.modal.show');
            const activeForm = document.querySelector('form:has(input:focus), form:has(textarea:focus)');
            
            if (activeModal || activeForm) {
                return;
            }
            
            isRefreshing = true;
            
            try {
                // Lưu scroll position trước khi cập nhật
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Fetch lại trang với header để nhận HTML
                const response = await fetch(window.location.href, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest', // Đánh dấu đây là AJAX request
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch booking list');
                }
                
                const html = await response.text();
                
                // Parse HTML response và extract phần table body
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTableBody = doc.querySelector('table tbody');
                const newCardFooter = doc.querySelector('.card-footer');
                
                if (newTableBody) {
                    // Lấy table body hiện tại
                    const currentTableBody = document.querySelector('table tbody');
                    const currentCardFooter = document.querySelector('.card-footer');
                    
                    if (currentTableBody) {
                        // Fade out effect (chỉ khi có notification)
                        if (showNotification) {
                            currentTableBody.style.opacity = '0.5';
                            currentTableBody.style.transition = 'opacity 0.3s';
                        }
                        
                        // Replace nội dung sau 300ms (hoặc ngay lập tức nếu không có notification)
                        setTimeout(() => {
                            // Replace table body
                            currentTableBody.innerHTML = newTableBody.innerHTML;
                            
                            // Replace pagination nếu có
                            if (newCardFooter && currentCardFooter) {
                                currentCardFooter.innerHTML = newCardFooter.innerHTML;
                            } else if (newCardFooter && !currentCardFooter) {
                                // Thêm pagination mới nếu không có
                                const card = document.querySelector('.card');
                                if (card) {
                                    card.insertAdjacentHTML('beforeend', newCardFooter.outerHTML);
                                }
                            } else if (!newCardFooter && currentCardFooter) {
                                // Xóa pagination nếu không còn
                                currentCardFooter.remove();
                            }
                            
                            // Fade in effect (chỉ khi có notification)
                            if (showNotification) {
                                currentTableBody.style.opacity = '1';
                            }
                            
                            // Re-initialize các event handlers cần thiết
                            initializeEventHandlers();
                            
                            // Khôi phục scroll position
                            window.scrollTo(0, scrollTop);
                            
                        }, showNotification ? 300 : 0); // Ngay lập tức nếu không có notification
                    } else {
                        throw new Error('Table body container not found');
                    }
                } else {
                    throw new Error('New table body not found in response');
                }
            } catch (error) {
                console.error('❌ Error refreshing booking list:', error);
            } finally {
                isRefreshing = false;
            }
        }
        
        // Function để sync với server im lặng (không hiển thị notification)
        async function refreshBookingListSilent() {
            return refreshBookingList(false); // Gọi với showNotification = false
        }
        
        // Function để hiển thị notification refresh
        function showRefreshNotification(message, type) {
            // Xóa notification cũ nếu có
            const existingNotif = document.querySelector('.refresh-notification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            // Tạo notification mới
            const notification = document.createElement('div');
            notification.className = 'refresh-notification';
            const bgColor = type === 'success' ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)';
            notification.style.cssText = `position: fixed; bottom: 20px; right: 20px; background: ${bgColor}; color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.875rem; z-index: 1050; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;`;
            notification.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            document.body.appendChild(notification);
            
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Function để re-initialize event handlers sau khi cập nhật DOM
        function initializeEventHandlers() {
            // Re-initialize countdown timers
            updateCountdown();
            
            // Re-initialize edit cancel time buttons
            document.querySelectorAll('[onclick*="showEditCancelTimeModal"]').forEach(btn => {
                // Event handlers sẽ tự động hoạt động với onclick attribute
            });
            
            // Re-initialize pagination links (Bootstrap sẽ tự động hoạt động)
            // Re-initialize modal triggers (Bootstrap sẽ tự động hoạt động với data attributes)
        }
        
        // Auto-refresh định kỳ: mỗi 30 giây
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                refreshBookingList();
            }, 30000); // 30 giây
        }
        
        // Khởi động auto-refresh và countdown timer khi page load
        document.addEventListener('DOMContentLoaded', function() {
            
            // Bắt đầu auto-refresh
            startAutoRefresh();
            
            // Cập nhật countdown timer ngay lập tức
            updateCountdown();
            
            // Cập nhật mỗi giây và kiểm tra xem có booking nào hết thời gian không
            let refreshScheduledForExpired = false; // Để tránh refresh nhiều lần
            setInterval(function() {
                updateCountdown(); // Cập nhật countdown và cập nhật DOM ngay khi hết thời gian
                
                // Kiểm tra xem có booking nào đã hết thời gian không (để sync với server)
                if (!refreshScheduledForExpired) {
                    const timers = document.querySelectorAll('.countdown-timer');
                    let hasExpired = false;
                    let expiredBookingIds = [];
                    
                    timers.forEach(timer => {
                        const cancelTimeStr = timer.getAttribute('data-cancel-time');
                        const bookingId = timer.getAttribute('data-booking-id');
                        if (!cancelTimeStr || !bookingId) return;
                        
                        // Chỉ xử lý nếu chưa được gọi auto-cancel
                        if (autoCancelCalled.has(bookingId)) return;
                        
                        const cancelTime = new Date(cancelTimeStr);
                        const now = new Date();
                        const diff = cancelTime - now;
                        
                        if (diff <= 0) {
                            hasExpired = true;
                            expiredBookingIds.push(bookingId);
                        }
                    });
                    
                    // Nếu có booking hết thời gian, gọi auto-cancel cho mỗi booking
                    if (hasExpired && expiredBookingIds.length > 0) {
                        refreshScheduledForExpired = true;
                        
                        // Gọi auto-cancel cho mỗi booking
                        const cancelPromises = expiredBookingIds.map(bookingId => {
                            return AutoCancelManager.call(bookingId, true);
                        });
                        
                        // Đợi tất cả auto-cancel hoàn thành, sau đó refresh
                        Promise.allSettled(cancelPromises).then(results => {
                            const hasSuccess = results.some(r => r.status === 'fulfilled');
                            
                            if (hasSuccess) {
                                refreshBookingListSilent();
                            } else {
                                // Nếu tất cả đều fail, reset state
                                results.forEach((result, index) => {
                                    if (result.status === 'rejected') {
                                        AutoCancelManager.reset(expiredBookingIds[index]);
                                    }
                                });
                            }
                            
                            setTimeout(() => {
                                refreshScheduledForExpired = false;
                            }, 2000);
                        });
                    }
                }
            }, 1000); // Check mỗi giây để phát hiện ngay khi hết thời gian
        });
        
        // Tắt auto-refresh khi page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // Thêm CSS animation (chỉ thêm một lần)
        if (!document.getElementById('refresh-animation-style')) {
            const style = document.createElement('style');
            style.id = 'refresh-animation-style';
            style.textContent = `
                @@keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Modal và function để admin chỉnh sửa thời gian hủy
        function showEditCancelTimeModal(bookingId, createdAtStr, currentCancelMinutes, remainingMinutes) {
            // Tạo modal HTML
            const modalHtml = `
                <div class="modal fade" id="editCancelTimeModal" tabindex="-1" aria-labelledby="editCancelTimeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editCancelTimeModalLabel">
                                    <i class="bi bi-clock-history me-2"></i>
                                    Sửa thời gian tự động hủy
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Thời gian còn lại hiện tại:</label>
                                    <div class="alert alert-info mb-0">
                                        <strong id="currentRemainingTime">Đang tính...</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="newRemainingMinutes" class="form-label">
                                        Thời gian còn lại mới (phút):
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="newRemainingMinutes" 
                                           min="1" 
                                           max="1440" 
                                           value="${Math.max(1, remainingMinutes)}"
                                           placeholder="Nhập số phút còn lại">
                                    <div id="errorMessage" class="text-danger mt-1" style="display: none; font-size: 0.875rem;"></div>
                                    <small class="form-text text-muted">
                                        Ví dụ: Nhập 1 để đặt thời gian còn lại là 1 phút
                                    </small>
                                </div>
                                <input type="hidden" id="editBookingId" value="${bookingId}">
                                <input type="hidden" id="editCreatedAt" value="${createdAtStr}">
                                <input type="hidden" id="editCurrentCancelMinutes" value="${currentCancelMinutes}">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-warning" onclick="saveCancelTime()">
                                    <i class="bi bi-save me-1"></i>
                                    Lưu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('editCancelTimeModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Thêm modal mới vào body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Hiển thị modal
            const modal = new bootstrap.Modal(document.getElementById('editCancelTimeModal'));
            modal.show();
            
            // Cập nhật thời gian còn lại hiện tại
            updateCurrentRemainingTime();
            
            // Ẩn thông báo lỗi khi người dùng bắt đầu nhập
            const inputField = document.getElementById('newRemainingMinutes');
            const errorDiv = document.getElementById('errorMessage');
            if (inputField) {
                inputField.addEventListener('input', function() {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                        errorDiv.textContent = '';
                    }
                    inputField.classList.remove('is-invalid');
                });
            }
        }

        function updateCurrentRemainingTime() {
            const timer = document.querySelector(`.countdown-timer[data-booking-id="${document.getElementById('editBookingId').value}"]`);
            if (timer) {
                const currentText = timer.textContent.trim();
                document.getElementById('currentRemainingTime').textContent = currentText || 'Đang tính...';
            }
        }

        async function saveCancelTime() {
            const bookingId = document.getElementById('editBookingId').value;
            const createdAtStr = document.getElementById('editCreatedAt').value;
            const newRemainingMinutes = parseInt(document.getElementById('newRemainingMinutes').value);
            const errorDiv = document.getElementById('errorMessage');
            const inputField = document.getElementById('newRemainingMinutes');
            
            // Ẩn thông báo lỗi trước đó
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // Xóa class lỗi từ input
            if (inputField) {
                inputField.classList.remove('is-invalid');
            }
            
            if (!newRemainingMinutes || newRemainingMinutes < 1) {
                // Hiển thị thông báo lỗi dưới ô nhập
                if (errorDiv) {
                    errorDiv.textContent = 'Vui lòng nhập số phút hợp lệ (từ 1 phút trở lên)';
                    errorDiv.style.display = 'block';
                }
                if (inputField) {
                    inputField.classList.add('is-invalid');
                }
                return;
            }
            
            // Disable nút để tránh double submit
            const saveBtn = document.querySelector('#editCancelTimeModal .btn-warning');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Đang xử lý...';
            }
            
            try {
                // Gọi action trong controller để cập nhật
                // Controller sẽ tính toán AutoCancelMinutes dựa trên CreatedAt và remainingMinutes
                const url = `/Admin/AdminBooking/UpdateCancelTime?bookingId=${bookingId}&remainingMinutes=${newRemainingMinutes}&createdAt=${encodeURIComponent(createdAtStr)}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error updating cancel time:', errorText);
                    throw new Error('Lỗi khi cập nhật thời gian hủy: ' + errorText);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Lỗi khi cập nhật thời gian hủy');
                }
                
                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCancelTimeModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Reload để lấy dữ liệu mới từ database
                location.reload();
            } catch (error) {
                console.error('Error updating cancel time:', error);
                
                // Hiển thị thông báo lỗi dưới ô nhập
                const errorDiv = document.getElementById('errorMessage');
                const inputField = document.getElementById('newRemainingMinutes');
                if (errorDiv) {
                    errorDiv.textContent = 'Lỗi: ' + error.message;
                    errorDiv.style.display = 'block';
                }
                if (inputField) {
                    inputField.classList.add('is-invalid');
                }
                
                // Re-enable nút
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Lưu';
                }
            }
        }
    </script>
}

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "pendingpayment" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "inprogress" or "in progress" or "in-progress" => "Đang xử lý",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string GetPaymentStatusText(string paymentStatus)
    {
        if (string.IsNullOrWhiteSpace(paymentStatus))
            return "Chưa xác định";
            
        var statusLower = paymentStatus.Trim().ToLower();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            _ => paymentStatus
        };
    }
}



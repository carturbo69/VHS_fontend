@model VHS_frontend.Areas.Provider.Models.Booking.BookingDetailDTO
@{
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    ViewData["Title"] = "Chi tiết đơn hàng";
    // CHỈ XEM - Admin không có quyền chỉnh sửa (update status, assign staff, cancel order)
}

<div class="order-detail-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="title-content">
                        <h1>Chi tiết Đơn hàng</h1>
                        <p>Đơn hàng @Model.BookingCode - Tạo lúc: @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a asp-controller="AdminBooking" asp-action="Index" asp-area="Admin" class="btn-refresh" title="Quay lại danh sách">
                    <i class="bi bi-arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Customer Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Thông tin khách hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Họ tên:</strong> @Model.RecipientName</p>
                            <p><strong>Email:</strong> @Model.CustomerEmail</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Số điện thoại:</strong> @Model.RecipientPhone</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-briefcase me-2"></i>
                        Thông tin dịch vụ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex">
                       @if (!string.IsNullOrEmpty(Model.ServiceImages))
                        {
                            string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
                            var firstImage = Model.ServiceImages.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var firstUrl = ToUrl(firstImage);
                            if (!string.IsNullOrEmpty(firstUrl))
                            {
                                <img src="@firstUrl" alt="@Model.ServiceName" class="service-image me-3" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px;" />
                            }
                        }
                        <div class="flex-grow-1">
                            <h5>@Model.ServiceName</h5>
                            <p class="text-muted">@Model.ServiceDescription</p>
                            <p><strong>Giá cơ bản:</strong> <span class="text-primary">@Model.ServicePrice.ToString("N0") VND</span></p>
                            
                            @if (Model.Options.Any())
                            {
                                <div class="mt-3">
                                    <strong>Tùy chọn đã bao gồm:</strong>
                                    <div class="mt-2">
                                        @foreach (var option in Model.Options)
                                        {
                                            var isTextarea = option.Type?.ToLower() == "textarea" || option.Type?.ToLower() == "text";
                                            <div style="font-size: 0.9375rem; color: #6c757d; margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <i class="bi bi-check-circle-fill me-1" style="color: #198754; font-size: 0.75rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <span>@option.OptionName</span>
                                                        @if (!string.IsNullOrWhiteSpace(option.Value))
                                                        {
                                                            @if (isTextarea)
                                                            {
                                                                @* Xử lý giá trị: split theo xuống dòng hoặc dấu gạch ngang *@
                                                                var valueLines = new List<string>();
                                                                
                                                                @* Kiểm tra xem có ký tự xuống dòng không *@
                                                                if (option.Value.Contains('\n') || option.Value.Contains('\r'))
                                                                {
                                                                    @* Nếu có xuống dòng, split theo \n và \r *@
                                                                    valueLines = option.Value
                                                                        .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
                                                                        .Select(v => v.Trim())
                                                                        .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                        .ToList();
                                                                }
                                                                else
                                                                {
                                                                    @* Nếu không có xuống dòng nhưng có dấu gạch ngang, split theo dấu gạch ngang *@
                                                                    valueLines = option.Value
                                                                        .Split(new[] { " - ", " – ", "-", "–" }, StringSplitOptions.RemoveEmptyEntries)
                                                                        .Select(v => v.Trim())
                                                                        .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                        .ToList();
                                                                }
                                                                
                                                                <div style="margin-top: 0.125rem; font-size: 0.875rem; line-height: 1.4; color: #6c757d;">
                                                                    @foreach (var line in valueLines)
                                                                    {
                                                                        <div>@line</div>
                                                                    }
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted" style="margin-left: 4px;">@option.Value</span>
                                                            }
                                                        }
                                                        else if (isTextarea)
                                                        {
                                                            @* Hiển thị "Chưa có" nếu là textarea nhưng không có giá trị *@
                                                            <div style="margin-top: 0.125rem; color: #6c757d; font-size: 0.875rem;">
                                                                <i class="bi bi-info-circle" style="margin-right: 4px;"></i>Chưa có
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        Thông tin đặt hàng
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>Thời gian thực hiện:</strong> @Model.BookingTime.ToString("dd/MM/yyyy HH:mm")</p>
                    
                    @* ✅ Hiển thị địa chỉ chi tiết từ UserAddresses *@
                    @if (!string.IsNullOrEmpty(Model.ProvinceName) || !string.IsNullOrEmpty(Model.DistrictName) || !string.IsNullOrEmpty(Model.WardName) || !string.IsNullOrEmpty(Model.StreetAddress))
                    {
                        <div class="address-details">
                            <p><strong>Địa chỉ:</strong></p>
                            <div class="address-info">
                                @if (!string.IsNullOrEmpty(Model.RecipientName))
                                {
                                    <p><strong>Người nhận:</strong> @Model.RecipientName</p>
                                }
                                @if (!string.IsNullOrEmpty(Model.RecipientPhone))
                                {
                                    <p><strong>Số điện thoại:</strong> @Model.RecipientPhone</p>
                                }
                                @if (!string.IsNullOrEmpty(Model.StreetAddress))
                                {
                                    <p><strong>Địa chỉ:</strong> @Model.StreetAddress</p>
                                }
                                @if (!string.IsNullOrEmpty(Model.WardName) || !string.IsNullOrEmpty(Model.DistrictName) || !string.IsNullOrEmpty(Model.ProvinceName))
                                {
                                    <p>
                                        @if (!string.IsNullOrEmpty(Model.WardName))
                                        {
                                            <strong>Phường/Xã:</strong> @Model.WardName
                                        }
                                        @if (!string.IsNullOrEmpty(Model.DistrictName))
                                        {
                                            <br />
                                            <strong>Quận/Huyện:</strong> @Model.DistrictName
                                        }
                                        @if (!string.IsNullOrEmpty(Model.ProvinceName))
                                        {
                                            <br />
                                            <strong>Tỉnh/Thành phố:</strong> @Model.ProvinceName
                                        }
                                    </p>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <p><strong>Địa chỉ:</strong> @Model.Address</p>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.VoucherCode))
                    {
                        <p>
                            <strong>Mã giảm giá:</strong> 
                            <span class="badge bg-success">@Model.VoucherCode</span>
                        </p>
                    }
                </div>
            </div>

            <!-- Staff Assignment Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Phân công nhân viên
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.StaffId.HasValue)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-person-check-fill"></i>
                            Đã phân công cho: <strong>@Model.StaffName</strong>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Chưa phân công nhân viên
                        </div>
                    }
                </div>
            </div>

            <!-- Checker Records -->
            @if (Model.CheckerRecords.Any())
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-camera me-2"></i>
                            Check-in/Check-out
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var record in Model.CheckerRecords)
                        {
                            <div class="checker-record mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong>@record.ForStatus</strong>
                                    <small class="text-muted">@record.UploadedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                @if (!string.IsNullOrEmpty(record.StaffName))
                                {
                                    <p class="mb-2"><small>Bởi: @record.StaffName</small></p>
                                }
                                @if (record.MediaType.Contains("image"))
                                {
                                    <img src="@record.FileUrl" alt="Checker media" class="img-fluid rounded" />
                                }
                                else if (record.MediaType.Contains("video"))
                                {
                                    <video controls class="w-100 rounded">
                                        <source src="@record.FileUrl" type="video/mp4" />
                                    </video>
                                }
                                @if (!string.IsNullOrEmpty(record.Description))
                                {
                                    <p class="mt-2 mb-0"><em>@record.Description</em></p>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Trạng thái đơn hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="status-badge-lg status-@(Model.Status.ToLower().Replace(" ", "-"))">
                            @GetStatusText(Model.Status)
                        </span>
                    </div>

                    @{
                        var statusNorm = (Model.Status ?? string.Empty).Trim();
                        bool isPending = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase);
                        bool isConfirmed = string.Equals(statusNorm, "Confirmed", StringComparison.OrdinalIgnoreCase);
                        bool isCompleted = string.Equals(statusNorm, "Completed", StringComparison.OrdinalIgnoreCase);
                        bool isServiceCompleted = string.Equals(statusNorm, "Service Completed", StringComparison.OrdinalIgnoreCase) || 
                                                 string.Equals(statusNorm, "Service-Completed", StringComparison.OrdinalIgnoreCase);
                        bool isCanceled = string.Equals(statusNorm, "Canceled", StringComparison.OrdinalIgnoreCase) ||
                                          string.Equals(statusNorm, "Cancelled", StringComparison.OrdinalIgnoreCase);
                    }
                    
                    @* Hiển thị countdown timer cho booking Pending *@
                    @if (isPending)
                    {
                        var cancelMinutes = Model.AutoCancelMinutes ?? 30; // Mặc định 30 phút
                        // Sử dụng CreatedAt từ Model, nếu không có thì dùng thời gian hiện tại
                        DateTime validCreatedAt;
                        if (Model.CreatedAt != default(DateTime) && Model.CreatedAt != DateTime.MinValue && Model.CreatedAt.Year > 2000)
                        {
                            validCreatedAt = Model.CreatedAt;
                        }
                        else
                        {
                            // Fallback: dùng thời gian hiện tại nếu CreatedAt không hợp lệ
                            validCreatedAt = DateTime.Now;
                        }
                        var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy:</strong>
                                </div>
                                <div class="countdown-timer-detail text-danger fw-bold" 
                                     data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-booking-id="@Model.BookingId"
                                     style="font-size: 1.1rem;">
                                    Đang tính...
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                @if (Model.AutoCancelMinutes.HasValue)
                                {
                                    <text>Thời gian hủy riêng: @Model.AutoCancelMinutes phút</text>
                                }
                                else
                                {
                                    <text>Thời gian hủy mặc định: @cancelMinutes phút</text>
                                }
                            </small>
                        </div>
                    }
                    @if (isConfirmed)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Đơn hàng đã được xác nhận</strong>
                            <p class="mb-0 mt-2 small">
                                Nhân viên <strong>@(Model.StaffName ?? "chưa phân công")</strong> sẽ thực hiện công việc và cập nhật trạng thái qua ứng dụng Staff.
                            </p>
                        </div>
                    }
                    else if (isCompleted || isServiceCompleted)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Đơn hàng đã hoàn thành</strong>
                            <p class="mb-0 mt-2 small">
                                Công việc đã được nhân viên hoàn thành.
                            </p>
                        </div>
                    }
                    else if (isCanceled)
                    {
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">
                                <i class="bi bi-x-circle-fill"></i>
                                <strong>Đơn hàng đã bị từ chối</strong>
                            </h5>
                            @if (!string.IsNullOrEmpty(Model.CancelReason))
                            {
                                <hr />
                                <p class="mb-0">
                                    <strong>Lý do từ chối:</strong><br />
                                    <span class="text-dark">@Model.CancelReason</span>
                                </p>
                            }
                            else
                            {
                                <hr />
                                <p class="mb-0 text-muted">
                                    <em>(Không có lý do cụ thể)</em>
                                </p>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-clock-history"></i>
                            <strong>Đơn hàng đang chờ xử lý</strong>
                        </div>
                    }
                </div>
            </div>

            <!-- Payment Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        Thanh toán
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tổng tiền:</span>
                            <strong class="text-primary">@Model.TotalAmount.ToString("N0") VND</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phương thức:</span>
                            <span>@(Model.PaymentMethod ?? "Chưa thanh toán")</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Trạng thái:</span>
                            @{
                                var paymentStatusClass = "unpaid";
                                var paymentStatusLower = Model.PaymentStatus?.ToLower() ?? "";
                                if (paymentStatusLower.Contains("paid") || paymentStatusLower.Contains("đã"))
                                {
                                    paymentStatusClass = "paid";
                                }
                                else if (paymentStatusLower.Contains("rejected") || paymentStatusLower.Contains("từ chối"))
                                {
                                    paymentStatusClass = "rejected";
                                }
                                else if (paymentStatusLower.Contains("refunded") || paymentStatusLower.Contains("hoàn tiền"))
                                {
                                    paymentStatusClass = "refunded";
                                }
                                else if (paymentStatusLower.Contains("unpaid") || paymentStatusLower.Contains("chưa") || paymentStatusLower.Contains("pending"))
                                {
                                    paymentStatusClass = "unpaid";
                                }
                            }
                            <span class="badge payment-status-badge payment-@(paymentStatusClass.Replace(" ", "-"))">
                                @GetPaymentStatusText(Model.PaymentStatus)
                            </span>
                        </div>
                        @if (Model.PaymentDate.HasValue)
                        {
                            <div class="d-flex justify-content-between mt-2">
                                <span>Ngày thanh toán:</span>
                                <span>@Model.PaymentDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/booking-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
    <style>
        /* Status Pending Badge - Vàng (Chờ xử lý) */
        .status-badge-lg.status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .status-badge-lg.status-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Service Completed Status Badge - Xanh dương nhạt (Xác nhận hoàn thành) */
        .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 2px solid #6366f1 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Paid Badge - Xanh lá (Đã thanh toán) */
        .payment-status-badge.payment-paid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: #ffffff !important;
            border: 2px solid #047857 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-paid {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.5) 0%, rgba(5, 150, 105, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(16, 185, 129, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.5) !important;
        }
        
        /* Payment Unpaid Badge - Đỏ (Chưa thanh toán) */
        .payment-status-badge.payment-unpaid {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b91c1c !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-unpaid {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.5) !important;
        }
        
        /* Payment Pending Badge - Vàng (Chờ thanh toán) */
        .payment-status-badge.payment-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Payment Rejected Badge - Đỏ đậm (Đã từ chối) */
        .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: #ffffff !important;
            border: 2px solid #991b1b !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.5) 0%, rgba(185, 28, 28, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(220, 38, 38, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.5) !important;
        }
        
        /* Payment Refunded Badge - Cam (Đã hoàn tiền) */
        .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
            color: #ffffff !important;
            border: 2px solid #92400e !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(217, 119, 6, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.5) 0%, rgba(180, 83, 9, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(217, 119, 6, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(217, 119, 6, 0.5) !important;
        }
    </style>
}

@section Scripts {
    <script>
        // Countdown timer cho booking Pending
        document.addEventListener('DOMContentLoaded', function() {
            function updateCountdown() {
                const timer = document.querySelector('.countdown-timer-detail');
                if (!timer) return;
                
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (!cancelTimeStr) return;
                
                // Parse thời gian hủy (đã là giờ Việt Nam từ server)
                const cancelTime = new Date(cancelTimeStr);
                const now = new Date();
                
                // Tính thời gian còn lại (milliseconds)
                const diff = cancelTime - now;
                
                if (diff <= 0) {
                    // Đã quá thời gian hủy
                    timer.innerHTML = '<span class="text-danger">Đã quá thời hạn</span>';
                    timer.classList.add('text-danger');
                } else {
                    // Tính giờ, phút, giây còn lại
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    // Format hiển thị
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours} giờ ${minutes} phút ${seconds} giây`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes} phút ${seconds} giây`;
                    } else {
                        timeStr = `${seconds} giây`;
                    }
                    
                    // Thêm màu cảnh báo nếu còn < 5 phút
                    if (diff < 5 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-danger">⏰ ${timeStr}</span>`;
                    } else if (diff < 15 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-warning">⏰ ${timeStr}</span>`;
                    } else {
                        timer.innerHTML = `⏰ ${timeStr}`;
                    }
                }
            }
            
            // Cập nhật ngay lập tức
            updateCountdown();
            
            // Cập nhật mỗi giây và kiểm tra xem có booking nào hết thời gian không
            let reloadScheduled = false; // Để tránh reload nhiều lần
            setInterval(function() {
                updateCountdown();
                
                // Kiểm tra xem có booking nào đã hết thời gian không (ngay lập tức)
                if (!reloadScheduled) {
                    const timers = document.querySelectorAll('.countdown-timer');
                    let hasExpired = false;
                    
                    timers.forEach(timer => {
                        const cancelTimeStr = timer.getAttribute('data-cancel-time');
                        if (!cancelTimeStr) return;
                        
                        const cancelTime = new Date(cancelTimeStr);
                        const now = new Date();
                        const diff = cancelTime - now;
                        
                        if (diff <= 0) {
                            hasExpired = true;
                        }
                    });
                    
                    if (hasExpired) {
                        reloadScheduled = true; // Đánh dấu đã schedule reload
                        console.log('⏰ Detected expired booking, reloading page in 2 seconds...');
                        // Reload sau 2 giây để đảm bảo backend đã xử lý xong
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    }
                }
            }, 1000); // Check mỗi giây để phát hiện ngay khi hết thời gian
        });
    </script>
}

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "pendingpayment" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "inprogress" or "in progress" or "in-progress" => "Đang xử lý",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string GetPaymentStatusText(string? paymentStatus)
    {
        if (string.IsNullOrEmpty(paymentStatus))
            return "Chưa xác định";

        var statusLower = paymentStatus.ToLower().Trim();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            _ => paymentStatus
        };
    }
}


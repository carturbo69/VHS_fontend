@model VHS_frontend.Areas.Provider.Models.Booking.BookingDetailDTO
@{
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    ViewData["Title"] = "Chi tiết đơn hàng";
    // CHỈ XEM - Admin không có quyền chỉnh sửa (update status, assign staff, cancel order)
}

<div class="order-detail-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="title-content">
                        <h1>Chi tiết Đơn hàng</h1>
                        <p>Đơn hàng @Model.BookingCode - Tạo lúc: @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a asp-controller="AdminBooking" asp-action="Index" asp-area="Admin" class="btn-refresh" title="Quay lại danh sách">
                    <i class="bi bi-arrow-left"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Customer Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Thông tin khách hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Họ tên:</strong> @Model.RecipientName</p>
                            <p><strong>Email:</strong> @Model.CustomerEmail</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Số điện thoại:</strong> @Model.RecipientPhone</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-briefcase me-2"></i>
                        Thông tin dịch vụ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex">
                       @if (!string.IsNullOrEmpty(Model.ServiceImages))
                        {
                            string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
                            var firstImage = Model.ServiceImages.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var firstUrl = ToUrl(firstImage);
                            if (!string.IsNullOrEmpty(firstUrl))
                            {
                                <img src="@firstUrl" alt="@Model.ServiceName" class="service-image me-3" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px;" />
                            }
                        }
                        <div class="flex-grow-1">
                            <h5>@Model.ServiceName</h5>
                            <div class="service-description">@(Model.ServiceDescription ?? "")</div>
                            <p><strong>Giá cơ bản:</strong> <span class="text-primary">@Model.ServicePrice.ToString("N0") VND</span></p>
                            
                            @if (Model.Options.Any())
                            {
                                @* Tách options thành 2 nhóm: non-textarea trước, textarea sau *@
                                var nonTextareaOptions = Model.Options.Where(opt => 
                                    !(opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text")).ToList();
                                var textareaOptions = Model.Options.Where(opt => 
                                    opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text").ToList();
                                
                                <div class="mt-3">
                                    <strong>Tùy chọn đã bao gồm:</strong>
                                    <div class="mt-2">
                                        @* Hiển thị non-textarea options trước *@
                                        @foreach (var option in nonTextareaOptions)
                                        {
                                            <div style="font-size: 0.9375rem; color: #6c757d; margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <i class="bi bi-check-circle-fill me-1" style="color: #198754; font-size: 0.75rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <span>@option.OptionName</span>
                                                        @if (!string.IsNullOrWhiteSpace(option.Value))
                                                        {
                                                            <span class="text-muted" style="margin-left: 4px;">@option.Value</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        
                                        @* Hiển thị textarea options sau cùng *@
                                        @foreach (var option in textareaOptions)
                                        {
                                            var isTextarea = option.Type?.ToLower() == "textarea" || option.Type?.ToLower() == "text";
                                            <div style="font-size: 0.9375rem; color: #6c757d; margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <i class="bi bi-check-circle-fill me-1" style="color: #198754; font-size: 0.75rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <span>@option.OptionName</span>
                                                        @if (!string.IsNullOrWhiteSpace(option.Value))
                                                        {
                                                            @if (isTextarea)
                                                            {
                                                                @* Xử lý giá trị: split theo xuống dòng hoặc dấu gạch ngang *@
                                                                var valueLines = new List<string>();
                                                                
                                                                @* Kiểm tra xem có ký tự xuống dòng không *@
                                                                if (option.Value.Contains('\n') || option.Value.Contains('\r'))
                                                                {
                                                                    @* Nếu có xuống dòng, split theo \n và \r *@
                                                                    valueLines = option.Value
                                                                        .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
                                                                        .Select(v => v.Trim())
                                                                        .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                        .ToList();
                                                                }
                                                                else
                                                                {
                                                                    @* Nếu không có xuống dòng nhưng có dấu gạch ngang, split theo dấu gạch ngang *@
                                                                    valueLines = option.Value
                                                                        .Split(new[] { " - ", " – ", "-", "–" }, StringSplitOptions.RemoveEmptyEntries)
                                                                        .Select(v => v.Trim())
                                                                        .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                        .ToList();
                                                                }
                                                                
                                                                <div style="margin-top: 0.125rem; font-size: 0.875rem; line-height: 1.4; color: #6c757d;">
                                                                    @foreach (var line in valueLines)
                                                                    {
                                                                        <div>@line</div>
                                                                    }
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted" style="margin-left: 4px;">@option.Value</span>
                                                            }
                                                        }
                                                        else if (isTextarea)
                                                        {
                                                            @* Hiển thị "Chưa có" nếu là textarea nhưng không có giá trị *@
                                                            <div style="margin-top: 0.125rem; color: #6c757d; font-size: 0.875rem;">
                                                                <i class="bi bi-info-circle" style="margin-right: 4px;"></i>Chưa có
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        Thông tin đặt hàng
                    </h5>
                </div>
                <div class="card-body">
                    <p><strong>Thời gian thực hiện:</strong> @Model.BookingTime.ToString("dd/MM/yyyy HH:mm")</p>
                    
                    @* ✅ Hiển thị địa chỉ từ Booking.Address (không dùng UserAddress nữa) *@
                    <p><strong>Địa chỉ:</strong> @Model.Address</p>
                    @if (!string.IsNullOrEmpty(Model.RecipientName))
                    {
                        <p><strong>Người đặt:</strong> @Model.RecipientName</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.RecipientPhone))
                    {
                        <p><strong>Số điện thoại:</strong> @Model.RecipientPhone</p>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.VoucherCode))
                    {
                        <p>
                            <strong>Mã giảm giá:</strong> 
                            <span class="badge bg-success">@Model.VoucherCode</span>
                        </p>
                    }
                </div>
            </div>

            <!-- Staff Assignment Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Phân công nhân viên
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.StaffId.HasValue)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-person-check-fill"></i>
                            Đã phân công cho: <strong>@Model.StaffName</strong>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Chưa phân công nhân viên
                        </div>
                    }
                </div>
            </div>

            @* ✅ Checker Records đã được hiển thị trong Timeline, không cần section riêng nữa *@
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Trạng thái đơn hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="status-badge-lg status-@(Model.Status.ToLower().Replace(" ", "-"))">
                            @GetStatusText(Model.Status)
                        </span>
                    </div>

                    @{
                        var statusNorm = (Model.Status ?? string.Empty).Trim();
                        bool isPending = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase);
                        bool isConfirmed = string.Equals(statusNorm, "Confirmed", StringComparison.OrdinalIgnoreCase);
                        bool isCompleted = string.Equals(statusNorm, "Completed", StringComparison.OrdinalIgnoreCase);
                        bool isServiceCompleted = string.Equals(statusNorm, "Service Completed", StringComparison.OrdinalIgnoreCase) || 
                                                 string.Equals(statusNorm, "Service-Completed", StringComparison.OrdinalIgnoreCase);
                        bool isCanceled = string.Equals(statusNorm, "Canceled", StringComparison.OrdinalIgnoreCase) ||
                                          string.Equals(statusNorm, "Cancelled", StringComparison.OrdinalIgnoreCase);
                    }
                    
                    @* Hiển thị countdown timer cho booking Pending *@
                    @if (isPending)
                    {
                        var cancelMinutes = Model.AutoCancelMinutes ?? 30; // Mặc định 30 phút
                        // Sử dụng CreatedAt từ Model, nếu không có thì dùng thời gian hiện tại
                        DateTime validCreatedAt;
                        if (Model.CreatedAt != default(DateTime) && Model.CreatedAt != DateTime.MinValue && Model.CreatedAt.Year > 2000)
                        {
                            validCreatedAt = Model.CreatedAt;
                        }
                        else
                        {
                            // Fallback: dùng thời gian hiện tại nếu CreatedAt không hợp lệ
                            validCreatedAt = DateTime.Now;
                        }
                        var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy:</strong>
                                </div>
                                <div class="countdown-timer-detail text-danger fw-bold" 
                                     data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-booking-id="@Model.BookingId"
                                     style="font-size: 1.1rem;">
                                    Đang tính...
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                @if (Model.AutoCancelMinutes.HasValue)
                                {
                                    <text>Thời gian hủy riêng: @Model.AutoCancelMinutes phút</text>
                                }
                                else
                                {
                                    <text>Thời gian hủy mặc định: @cancelMinutes phút</text>
                                }
                            </small>
                        </div>
                    }
                    @if (isConfirmed)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Đơn hàng đã được xác nhận</strong>
                            <p class="mb-0 mt-2 small">
                                Nhân viên <strong>@(Model.StaffName ?? "chưa phân công")</strong> sẽ thực hiện công việc và cập nhật trạng thái qua ứng dụng nhân viên.
                            </p>
                        </div>
                    }
                    else if (isCompleted || isServiceCompleted)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Đơn hàng đã hoàn thành</strong>
                            <p class="mb-0 mt-2 small">
                                Công việc đã được nhân viên hoàn thành.
                            </p>
                        </div>
                    }
                    else if (isCanceled)
                    {
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">
                                <i class="bi bi-x-circle-fill"></i>
                                <strong>Đơn hàng đã bị từ chối</strong>
                            </h5>
                            @if (!string.IsNullOrEmpty(Model.CancelReason))
                            {
                                <hr />
                                <p class="mb-0">
                                    <strong>Lý do từ chối:</strong><br />
                                    <span class="text-dark">@Model.CancelReason</span>
                                </p>
                            }
                            else
                            {
                                <hr />
                                <p class="mb-0 text-muted">
                                    <em>(Không có lý do cụ thể)</em>
                                </p>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-clock-history"></i>
                            <strong>Đơn hàng đang chờ xử lý</strong>
                        </div>
                    }
                </div>
            </div>

            <!-- Payment Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        Thanh toán
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tổng tiền:</span>
                            <strong class="text-primary">@Model.TotalAmount.ToString("N0") VND</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phương thức:</span>
                            <span>@(Model.PaymentMethod ?? "Chưa thanh toán")</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Trạng thái:</span>
                            @{
                                var paymentStatusClass = "unpaid";
                                var paymentStatusLower = Model.PaymentStatus?.ToLower() ?? "";
                                if (paymentStatusLower.Contains("paid") || paymentStatusLower.Contains("đã"))
                                {
                                    paymentStatusClass = "paid";
                                }
                                else if (paymentStatusLower.Contains("rejected") || paymentStatusLower.Contains("từ chối"))
                                {
                                    paymentStatusClass = "rejected";
                                }
                                else if (paymentStatusLower.Contains("refunded") || paymentStatusLower.Contains("hoàn tiền"))
                                {
                                    paymentStatusClass = "refunded";
                                }
                                else if (paymentStatusLower.Contains("unpaid") || paymentStatusLower.Contains("chưa") || paymentStatusLower.Contains("pending"))
                                {
                                    paymentStatusClass = "unpaid";
                                }
                            }
                            <span class="badge payment-status-badge payment-@(paymentStatusClass.Replace(" ", "-"))">
                                @GetPaymentStatusText(Model.PaymentStatus)
                            </span>
                        </div>
                        @if (Model.PaymentDate.HasValue)
                        {
                            <div class="d-flex justify-content-between mt-2">
                                <span>Ngày thanh toán:</span>
                                <span>@Model.PaymentDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                        }
                    </div>
                    
                    @* Hiển thị countdown timer cho Confirmed chưa thanh toán *@
                    @{
                        var statusNormPayment = (Model.Status ?? string.Empty).Trim();
                        bool isConfirmedPayment = string.Equals(statusNormPayment, "Confirmed", StringComparison.OrdinalIgnoreCase);
                    }
                    @if (isConfirmedPayment)
                    {
                        // ✨ ĐỒNG BỘ: Kiểm tra chưa thanh toán - logic giống Provider
                        var paymentStatusLowerCheck = (Model.PaymentStatus ?? string.Empty).ToLower().Trim();
                        var isUnpaid = string.IsNullOrEmpty(Model.PaymentStatus) || 
                                     paymentStatusLowerCheck == "chưa xác định" ||
                                     paymentStatusLowerCheck == "chua xac dinh" ||
                                     (!paymentStatusLowerCheck.Contains("paid") && 
                                      !paymentStatusLowerCheck.Contains("đã thanh toán") &&
                                      !paymentStatusLowerCheck.Contains("đã thanh toan") &&
                                      !paymentStatusLowerCheck.Contains("completed") &&
                                      paymentStatusLowerCheck != "00");
                        
                        if (isUnpaid)
                        {
                            // ✨ QUAN TRỌNG: Timer PHẢI bắt đầu từ ConfirmedAt (thời gian provider xác nhận)
                            // Không dùng CreatedAt cho Confirmed booking - timer chỉ bắt đầu từ khi xác nhận
                            var cancelMinutes = Model.AutoCancelMinutes ?? 30; // Sử dụng AutoCancelMinutes từ model, mặc định 30 phút
                            DateTime validConfirmedAt;
                            
                            // ✨ PHẢI dùng ConfirmedAt từ database (để đồng bộ với provider)
                            // Khi provider xác nhận đơn, ConfirmedAt được lưu vào database ngay lập tức
                            if (Model.ConfirmedAt.HasValue && 
                                Model.ConfirmedAt.Value != default(DateTime) && 
                                Model.ConfirmedAt.Value != DateTime.MinValue && 
                                Model.ConfirmedAt.Value.Year > 2000)
                            {
                                // Dùng ConfirmedAt từ database (thời gian provider xác nhận)
                                validConfirmedAt = Model.ConfirmedAt.Value;
                            }
                            else if (Model.CreatedAt != default(DateTime) && 
                                     Model.CreatedAt != DateTime.MinValue && 
                                     Model.CreatedAt.Year > 2000)
                            {
                                // Fallback: Dùng CreatedAt nếu không có ConfirmedAt (không nên xảy ra)
                                validConfirmedAt = Model.CreatedAt;
                            }
                            else
                            {
                                // Fallback cuối cùng: Dùng thời gian hiện tại (không nên xảy ra với Confirmed booking)
                                // Nếu đến đây, có thể booking chưa được confirm đúng cách
                                validConfirmedAt = DateTime.Now;
                            }
                            
                            // ✨ QUAN TRỌNG: Tính cancelTime từ ConfirmedAt + cancelMinutes (KHÔNG phải CreatedAt)
                            // cancelTime = ConfirmedAt (thời gian xác nhận) + autoCancelMinutes
                            // ✨ ĐỒNG BỘ: Dùng cùng format với Provider để đảm bảo timezone nhất quán
                            var cancelTime = validConfirmedAt.AddMinutes(cancelMinutes);
                            var confirmedAtStr = Model.ConfirmedAt.HasValue && 
                                                Model.ConfirmedAt.Value != default(DateTime) && 
                                                Model.ConfirmedAt.Value != DateTime.MinValue && 
                                                Model.ConfirmedAt.Value.Year > 2000 
                                                ? Model.ConfirmedAt.Value.ToString("yyyy-MM-ddTHH:mm:ss") 
                                                : validConfirmedAt.ToString("yyyy-MM-ddTHH:mm:ss");
                            <div class="alert alert-warning mt-3 mb-0">
                                <div class="mb-2">
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy (chưa thanh toán):</strong>
                                </div>
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="countdown-timer-confirmed-unpaid text-danger fw-bold" 
                                         data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                         data-booking-id="@Model.BookingId"
                                         data-confirmed-at="@confirmedAtStr"
                                         data-auto-cancel-minutes="@(Model.AutoCancelMinutes?.ToString() ?? "")"
                                         data-use-localstorage="false"
                                         style="font-size: 1.1rem;">
                                        Đang tính...
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editCancelTimeModal">
                                        <i class="bi bi-pencil-square"></i> Chỉnh sửa
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="card-block p-3 h-100 mb-4">
                <div class="h6">Tiến trình dịch vụ</div>
                @{
                    var fallbackImg = Url.Content("~/images/VeSinh.jpg");
                }
                <div class="timeline">
                    @* Timeline hiển thị từ trên xuống (grid), nên sắp xếp giảm dần (mới nhất trước) để:
                       - Item đầu tiên (CHECK OUT - mới nhất) ở trên cùng
                       - Item cuối cùng (CREATED - cũ nhất) ở dưới cùng *@
                    @foreach (var e in (Model?.Timeline ?? new List<VHS_frontend.Areas.Provider.Models.Booking.TrackingEventDTO>()).OrderByDescending(t => t.Time))
                    {
                        var code = (e.Code ?? "").Trim().ToUpperInvariant();

                        // Cho CONFIRMED, INPROGRESS, COMPLETED, CHECK IN, CHECK OUT đều hiện ảnh + staff
                        var onlyShowProofFor = code == "CONFIRMED"
                        || code == "INPROGRESS"
                        || code == "COMPLETED"
                        || code == "CHECK IN"
                        || code == "CHECK OUT";

                        var showStaffFor = code == "CONFIRMED"
                        || code == "INPROGRESS"
                        || code == "COMPLETED"
                        || code == "CHECK IN"
                        || code == "CHECK OUT";

                        var staffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                        var staffImage = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;

                        <div class="tl-item">
                            <div class="fw-semibold">@e.Title</div>
                            <div class="text-muted small">@(e.Time.ToString("dd-MM-yyyy HH:mm"))</div>

                            @if (code == "CREATED" && (Model?.TotalAmount ?? 0m) > 0)
                            {
                                <div class="small text-success">Đã thanh toán: <b>@Model.TotalAmount.ToString("N0") VND</b></div>
                            }

                            @if (showStaffFor && !string.IsNullOrWhiteSpace(staffName))
                            {
                                <div class="staff">
                                    <img src="@staffImage"
                                         alt="Ảnh @staffName"
                                         class="zoomable"
                                         loading="lazy"
                                         decoding="async"
                                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    <div class="meta">
                                        <div class="fw-semibold">@staffName</div>
                                        <div class="role">Nhân viên phụ trách</div>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(e.Description))
                            {
                                <div class="small">@e.Description</div>
                            }

                            @if (onlyShowProofFor && (e.Proofs?.Any() == true))
                            {
                                <div class="proofs mt-2">
                                    @foreach (var p in e.Proofs)
                                    {
                                        if ((p.MediaType ?? "image").ToLower() == "image")
                                        {
                                            var src = !string.IsNullOrWhiteSpace(p.Url) ? p.Url : fallbackImg;
                                            <img src="@src"
                                                 alt="@p.Caption"
                                                 class="zoomable"
                                                 loading="lazy"
                                                 decoding="async"
                                                 onerror="this.onerror=null;this.src='@fallbackImg';" />
                                        }
                                        else
                                        {
                                            <a class="btn btn-sm btn-outline-secondary" href="@p.Url" target="_blank" rel="noopener">
                                                <i class="bi bi-play-circle"></i> Xem video
                                            </a>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chỉnh sửa thời gian hủy -->
<div class="modal fade" id="editCancelTimeModal" tabindex="-1" aria-labelledby="editCancelTimeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCancelTimeModalLabel">
                    <i class="bi bi-clock-history me-2"></i>
                    Sửa thời gian tự động hủy
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Thời gian còn lại hiện tại:</label>
                    <div class="alert alert-info mb-0">
                        <strong id="currentRemainingTime">Đang tính...</strong>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="newRemainingMinutes" class="form-label">
                        Thời gian còn lại mới (phút):
                    </label>
                    <input type="number" 
                           class="form-control" 
                           id="newRemainingMinutes" 
                           min="1" 
                           max="1440" 
                           value="1"
                           placeholder="Nhập số phút còn lại">
                    <div id="errorMessage" class="text-danger mt-1" style="display: none; font-size: 0.875rem;"></div>
                    <small class="form-text text-muted">
                        Ví dụ: Nhập 1 để đặt thời gian còn lại là 1 phút
                    </small>
                </div>
                <input type="hidden" id="editBookingId">
                <input type="hidden" id="editCreatedAt">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" id="saveCancelTimeBtn">
                    <i class="bi bi-save me-1"></i>
                    Lưu
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-booking.css" asp-append-version="true" />
    <style>
        /* Status Pending Badge - Vàng (Chờ xử lý) */
        .status-badge-lg.status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .status-badge-lg.status-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Service Completed Status Badge - Xanh dương nhạt (Xác nhận hoàn thành) */
        .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 2px solid #6366f1 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Paid Badge - Xanh lá (Đã thanh toán) */
        .payment-status-badge.payment-paid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: #ffffff !important;
            border: 2px solid #047857 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-paid {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.5) 0%, rgba(5, 150, 105, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(16, 185, 129, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.5) !important;
        }
        
        /* Payment Unpaid Badge - Đỏ (Chưa thanh toán) */
        .payment-status-badge.payment-unpaid {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b91c1c !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-unpaid {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.5) !important;
        }
        
        /* Payment Pending Badge - Vàng (Chờ thanh toán) */
        .payment-status-badge.payment-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border: 2px solid #b45309 !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.5) 0%, rgba(217, 119, 6, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(245, 158, 11, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.5) !important;
        }
        
        /* Payment Rejected Badge - Đỏ đậm (Đã từ chối) */
        .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: #ffffff !important;
            border: 2px solid #991b1b !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.5) 0%, rgba(185, 28, 28, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(220, 38, 38, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.5) !important;
        }
        
        /* Payment Refunded Badge - Cam (Đã hoàn tiền) */
        .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%) !important;
            color: #ffffff !important;
            border: 2px solid #92400e !important;
            font-weight: 800 !important;
            box-shadow: 0 1px 3px rgba(217, 119, 6, 0.3) !important;
        }
        
        .dark .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.5) 0%, rgba(180, 83, 9, 0.45) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(217, 119, 6, 1) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 6px rgba(217, 119, 6, 0.5) !important;
        }
    </style>
}

@section Scripts {
    <script>
        // ✨ QUAN TRỌNG: Khai báo bookingId để dùng trong AutoCancelManager (giống Provider)
        const bookingId = '@Model.BookingId';
        
        // Get backend URL
        const metaBackendUrl = document.querySelector('meta[name="backend-url"]')?.getAttribute('content');
        const backendUrl = metaBackendUrl || 'http://localhost:5154';
        
        // Countdown timer cho booking Pending
        document.addEventListener('DOMContentLoaded', function() {
            // Admin không cần xóa localStorage vì không dùng localStorage
            
            // AutoCancelManager cho Details page
            const AutoCancelManager = {
                inProgress: false,
                
                async call(isPendingExpired) {
                    if (this.inProgress) {
                        return Promise.resolve();
                    }
                    
                    this.inProgress = true;
                    
                try {
                    const bookingIdStr = String(bookingId).trim();
                    if (!bookingIdStr || bookingIdStr === 'undefined' || bookingIdStr === 'null') {
                        throw new Error('Invalid bookingId');
                    }
                    
                    const response = await fetch('/Provider/Order/AutoCancel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            bookingId: bookingIdStr,
                            isPendingExpired: isPendingExpired
                        })
                    });
                    
                    // ✨ QUAN TRỌNG: Kiểm tra cả HTTP status VÀ response body
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        throw new Error(`Auto-cancel failed: ${response.status} - ${responseText}`);
                    }
                    
                    // Parse JSON response để kiểm tra success flag
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // Nếu không phải JSON, coi như thành công nếu HTTP status OK
                        // Reload để lấy dữ liệu từ database
                        location.reload();
                        return;
                    }
                    
                    // ✨ KIỂM TRA success flag trong response body
                    if (result && result.success === true) {
                        // API thành công và database đã được cập nhật
                        // Reload để lấy dữ liệu mới từ database
                        location.reload();
                    } else {
                        // API trả về nhưng success = false
                        throw new Error(result?.message || 'Auto-cancel failed: Backend reported failure');
                    }
                } catch (error) {
                    console.error('[AUTO CANCEL] Error:', error);
                    // Không hiển thị alert, chỉ log để debug
                    this.inProgress = false;
                }
                }
            };
            
            // ✨ Function countdown đơn giản - đồng bộ với Provider và Index
            function updateCountdown(timerSelector) {
                const timer = document.querySelector(timerSelector);
                if (!timer) return;
                
                // Dùng data-cancel-time đã được server tính sẵn từ ConfirmedAt (hoặc CreatedAt)
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                const confirmedAtStr = timer.getAttribute('data-confirmed-at');
                const bookingId = timer.getAttribute('data-booking-id');
                
                if (!cancelTimeStr) {
                    timer.innerHTML = '<span class="text-danger">Đang tải...</span>';
                    return;
                }
                
                // Parse cancelTime - đơn giản, nhất quán
                let cancelTime;
                try {
                    // ✨ ĐỒNG BỘ: Parse trực tiếp - JavaScript tự động xử lý timezone
                    // Đảm bảo format "yyyy-MM-ddTHH:mm:ss" được parse đúng
                    cancelTime = new Date(cancelTimeStr);
                    
                    if (isNaN(cancelTime.getTime())) {
                        timer.innerHTML = '<span class="text-danger">Lỗi thời gian</span>';
                        console.error('[Admin Countdown] Invalid cancelTime:', cancelTimeStr);
                        return;
                    }
                } catch (e) {
                    timer.innerHTML = '<span class="text-danger">Lỗi thời gian</span>';
                    console.error('[Admin Countdown] Parse error:', e, 'cancelTimeStr:', cancelTimeStr);
                    return;
                }
                
                const now = new Date();
                const diff = cancelTime - now;
                
                // Debug: Log mỗi 10 giây để theo dõi
                if (timerSelector === '.countdown-timer-confirmed-unpaid') {
                    const logKey = `lastLog_${bookingId}`;
                    const lastLog = window[logKey] || 0;
                    if (now.getTime() - lastLog > 10000) { // Log mỗi 10 giây
                        console.log('[Admin Countdown] Update:', {
                            bookingId: bookingId,
                            cancelTimeStr: cancelTimeStr,
                            cancelTimeISO: cancelTime.toISOString(),
                            confirmedAtStr: confirmedAtStr,
                            nowISO: now.toISOString(),
                            diffMs: diff,
                            diffSeconds: Math.floor(diff / 1000),
                            diffMinutes: Math.floor(diff / 60000)
                        });
                        window[logKey] = now.getTime();
                    }
                }
                
                if (diff <= 0) {
                    // Đã quá thời gian hủy
                    if (AutoCancelManager.inProgress) {
                        timer.innerHTML = '<span class="text-danger fw-bold">Đang xử lý...</span>';
                        timer.classList.add('text-danger');
                        return;
                    }
                    
                    // ✨ QUAN TRỌNG: GỌI API TRƯỚC, KHÔNG CẬP NHẬT UI TRƯỚC
                    // Hiển thị "Đang xử lý" trong khi gọi API
                    timer.innerHTML = '<span class="text-warning fw-bold">Đang hủy đơn...</span>';
                    timer.classList.add('text-warning');
                    
                    // Gọi API auto-cancel và đợi kết quả
                    AutoCancelManager.call(true).then(() => {
                        // CHỈ KHI API THÀNH CÔNG mới reload để lấy dữ liệu từ database
                        // Reload sẽ tự động cập nhật UI với dữ liệu thật từ database
                    }).catch(error => {
                        // Nếu API fail, chỉ log lỗi, không hiển thị alert
                        timer.innerHTML = '<span class="text-danger fw-bold">Lỗi khi hủy đơn</span>';
                        console.error('[AUTO CANCEL] Error:', error);
                        // Reload ngay lập tức để cập nhật trạng thái
                        location.reload();
                    });
                } else {
                    // Tính giờ, phút, giây còn lại - format giống Index
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    // Format hiển thị giống Index
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours} giờ ${minutes} phút`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes} phút ${seconds} giây`;
                    } else {
                        timeStr = `${seconds} giây`;
                    }
                    
                    // ✨ Tối ưu: Chỉ cập nhật text, không thay đổi structure để tránh nhấp nháy
                    const timeText = `Còn ${timeStr}`;
                    const currentText = timer.textContent.trim();
                    
                    // Chỉ cập nhật nếu text thay đổi
                    if (currentText !== timeText) {
                        // Tìm span bên trong để cập nhật text, không thay đổi structure
                        const innerSpan = timer.querySelector('span');
                        if (innerSpan) {
                            // Chỉ cập nhật text, giữ nguyên class
                            innerSpan.textContent = timeText;
                        } else {
                            // Nếu không có span, chỉ cập nhật text
                            timer.textContent = timeText;
                        }
                    }
                    
                    // ✨ Cập nhật class màu một lần, không mỗi giây
                    const shouldBeDanger = diff < 5 * 60 * 1000;
                    const shouldBeWarning = diff >= 5 * 60 * 1000 && diff < 15 * 60 * 1000;
                    const innerSpan = timer.querySelector('span');
                    if (innerSpan) {
                        if (shouldBeDanger && !innerSpan.classList.contains('text-danger')) {
                            innerSpan.className = 'text-danger fw-bold';
                        } else if (shouldBeWarning && !innerSpan.classList.contains('text-warning')) {
                            innerSpan.className = 'text-warning fw-bold';
                        } else if (!shouldBeDanger && !shouldBeWarning && innerSpan.classList.contains('text-danger')) {
                            innerSpan.className = 'fw-bold';
                        }
                    }
                }
            }
            
            // ✨ ĐỒNG BỘ: Debug - Log giá trị khi page load
            const confirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
            if (confirmedTimer) {
                const cancelTime = confirmedTimer.getAttribute('data-cancel-time');
                const confirmedAt = confirmedTimer.getAttribute('data-confirmed-at');
                const autoCancelMinutes = confirmedTimer.getAttribute('data-auto-cancel-minutes');
                const bookingId = confirmedTimer.getAttribute('data-booking-id');
                
                // Parse và log chi tiết để debug
                let cancelTimeDate = null;
                let confirmedAtDate = null;
                try {
                    if (cancelTime) cancelTimeDate = new Date(cancelTime);
                    if (confirmedAt) confirmedAtDate = new Date(confirmedAt);
                } catch (e) {
                    console.error('[Admin Details] Parse error:', e);
                }
                
                console.log('[Admin Details] Timer initialized:', {
                    bookingId: bookingId,
                    cancelTime: cancelTime,
                    cancelTimeDate: cancelTimeDate ? cancelTimeDate.toISOString() : null,
                    confirmedAt: confirmedAt,
                    confirmedAtDate: confirmedAtDate ? confirmedAtDate.toISOString() : null,
                    autoCancelMinutes: autoCancelMinutes,
                    currentTime: new Date().toISOString(),
                    timeUntilCancel: cancelTimeDate ? Math.floor((cancelTimeDate - new Date()) / 1000) + ' seconds' : null
                });
            }
            
            // ✨ ĐỒNG BỘ: Cập nhật countdown cho Pending và Confirmed chưa thanh toán
            updateCountdown('.countdown-timer-detail');
            updateCountdown('.countdown-timer-confirmed-unpaid');
            
            // ✨ ĐỒNG BỘ: Cập nhật timer mỗi giây (đồng bộ với Provider)
            // Sử dụng setInterval để đảm bảo cả hai trang đều cập nhật cùng lúc
            setInterval(function() {
                updateCountdown('.countdown-timer-detail');
                updateCountdown('.countdown-timer-confirmed-unpaid');
            }, 1000);
            
            // ✨ ĐỒNG BỘ: Đảm bảo timer được cập nhật ngay khi page load
            // Điều này giúp đồng bộ với Provider khi cả hai trang cùng mở
            setTimeout(function() {
                updateCountdown('.countdown-timer-detail');
                updateCountdown('.countdown-timer-confirmed-unpaid');
            }, 100);
            
            // ========== Auto-refresh để đồng bộ với Provider ==========
            let refreshInterval = null;
            
            // ✨ Function đơn giản: Admin refresh để lấy data-cancel-time mới nhất từ server
            let isRefreshing = false;
            async function refreshBookingDetail() {
                if (isRefreshing) return;
                isRefreshing = true;
                
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.set('_t', Date.now().toString());
                    
                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        cache: 'no-store'
                    });
                    
                    if (!response.ok) {
                        isRefreshing = false;
                        return;
                    }
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // ✨ QUAN TRỌNG: Cập nhật status badge ngay lập tức nếu có thay đổi
                    const newStatusBadge = doc.querySelector('.status-badge-lg');
                    const currentStatusBadge = document.querySelector('.status-badge-lg');
                    if (newStatusBadge && currentStatusBadge) {
                        const newStatusText = newStatusBadge.textContent.trim();
                        const newStatusClass = newStatusBadge.className;
                        const currentStatusText = currentStatusBadge.textContent.trim();
                        
                        if (newStatusText !== currentStatusText || newStatusClass !== currentStatusBadge.className) {
                            // Status đã thay đổi - cập nhật mượt mà, không làm giật UI
                            requestAnimationFrame(() => {
                                currentStatusBadge.textContent = newStatusText;
                                currentStatusBadge.className = newStatusClass;
                                
                                // ✨ Cập nhật các phần tử liên quan đến status (chỉ khi cần)
                                const newCancelReasonSection = doc.querySelector('.cancel-reason-section');
                                const currentCancelReasonSection = document.querySelector('.cancel-reason-section');
                                if (newCancelReasonSection && currentCancelReasonSection) {
                                    const newReasonHTML = newCancelReasonSection.innerHTML.trim();
                                    const currentReasonHTML = currentCancelReasonSection.innerHTML.trim();
                                    if (newReasonHTML !== currentReasonHTML) {
                                        currentCancelReasonSection.outerHTML = newCancelReasonSection.outerHTML;
                                    }
                                }
                                
                                // ✨ Cập nhật alert warning nếu có thay đổi
                                const newAlertWarning = doc.querySelector('.alert-warning');
                                const currentAlertWarning = document.querySelector('.alert-warning');
                                if (newAlertWarning && currentAlertWarning) {
                                    const newAlertText = newAlertWarning.textContent.trim();
                                    const currentAlertText = currentAlertWarning.textContent.trim();
                                    if (newAlertText !== currentAlertText) {
                                        currentAlertWarning.outerHTML = newAlertWarning.outerHTML;
                                        // Re-initialize countdown timer nếu có
                                        setTimeout(() => {
                                            updateCountdown('.countdown-timer-confirmed-unpaid');
                                        }, 100);
                                    }
                                }
                            });
                        }
                    }
                    
                    // ✨ Cập nhật Payment Status nếu có thay đổi (chỉ khi thực sự thay đổi)
                    const newPaymentStatus = doc.querySelector('.payment-status-badge');
                    const currentPaymentStatus = document.querySelector('.payment-status-badge');
                    if (newPaymentStatus && currentPaymentStatus) {
                        const newPaymentText = newPaymentStatus.textContent.trim();
                        const newPaymentClass = newPaymentStatus.className;
                        const currentPaymentText = currentPaymentStatus.textContent.trim();
                        
                        if (newPaymentText !== currentPaymentText || newPaymentClass !== currentPaymentStatus.className) {
                            // Cập nhật mượt mà
                            requestAnimationFrame(() => {
                                currentPaymentStatus.textContent = newPaymentText;
                                currentPaymentStatus.className = newPaymentClass;
                            });
                        }
                    }
                    
                    // ✨ Cập nhật Payment Method nếu có thay đổi (chỉ khi thực sự thay đổi)
                    const paymentMethodRows = doc.querySelectorAll('.payment-summary .d-flex');
                    const currentPaymentMethodRows = document.querySelectorAll('.payment-summary .d-flex');
                    if (paymentMethodRows.length === currentPaymentMethodRows.length) {
                        paymentMethodRows.forEach((newRow, index) => {
                            const currentRow = currentPaymentMethodRows[index];
                            if (newRow && currentRow) {
                                const newRowText = newRow.textContent.trim();
                                const currentRowText = currentRow.textContent.trim();
                                if (newRowText !== currentRowText) {
                                    requestAnimationFrame(() => {
                                        currentRow.outerHTML = newRow.outerHTML;
                                    });
                                }
                            }
                        });
                    }
                    
                    // ✨ Cập nhật Staff Assignment Card nếu có thay đổi (chỉ khi thực sự thay đổi)
                    const allNewCards = doc.querySelectorAll('.card');
                    const allCurrentCards = document.querySelectorAll('.card');
                    allNewCards.forEach((newCard, index) => {
                        if (index < allCurrentCards.length) {
                            const currentCard = allCurrentCards[index];
                            const newCardHeader = newCard.querySelector('.card-header h5')?.textContent?.trim();
                            const currentCardHeader = currentCard.querySelector('.card-header h5')?.textContent?.trim();
                            
                            // Kiểm tra nếu là staff card hoặc các card quan trọng khác
                            if (newCardHeader === currentCardHeader && 
                                (newCardHeader?.includes('Phân công nhân viên') || 
                                 newCardHeader?.includes('Trạng thái đơn hàng') ||
                                 newCardHeader?.includes('Thanh toán'))) {
                                const newCardBody = newCard.querySelector('.card-body');
                                const currentCardBody = currentCard.querySelector('.card-body');
                                if (newCardBody && currentCardBody) {
                                    const newCardBodyHTML = newCardBody.innerHTML.trim();
                                    const currentCardBodyHTML = currentCardBody.innerHTML.trim();
                                    if (newCardBodyHTML !== currentCardBodyHTML) {
                                        // Cập nhật mượt mà
                                        requestAnimationFrame(() => {
                                            currentCardBody.innerHTML = newCardBodyHTML;
                                            
                                            // Re-initialize countdown timer nếu có trong card này
                                            const timerInCard = currentCardBody.querySelector('.countdown-timer-confirmed-unpaid');
                                            if (timerInCard) {
                                                setTimeout(() => {
                                                    updateCountdown('.countdown-timer-confirmed-unpaid');
                                                }, 100);
                                            }
                                        });
                                    }
                                }
                            }
                        }
                    });
                    
                    // ✨ Cập nhật data-cancel-time từ server (đã tính từ ConfirmedAt hoặc CreatedAt)
                    const newPendingTimer = doc.querySelector('.countdown-timer-detail');
                    const currentPendingTimer = document.querySelector('.countdown-timer-detail');
                    const newConfirmedTimer = doc.querySelector('.countdown-timer-confirmed-unpaid');
                    const currentConfirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
                    
                    // Cập nhật Pending timer
                    if (newPendingTimer && currentPendingTimer) {
                        const newCancelTime = newPendingTimer.getAttribute('data-cancel-time');
                        const newConfirmedAt = newPendingTimer.getAttribute('data-confirmed-at');
                        const newAutoCancelMinutes = newPendingTimer.getAttribute('data-auto-cancel-minutes');
                        if (newCancelTime) {
                            currentPendingTimer.setAttribute('data-cancel-time', newCancelTime);
                        }
                        if (newConfirmedAt) {
                            currentPendingTimer.setAttribute('data-confirmed-at', newConfirmedAt);
                        }
                        if (newAutoCancelMinutes !== null) {
                            currentPendingTimer.setAttribute('data-auto-cancel-minutes', newAutoCancelMinutes);
                        }
                    }
                    
                    // ✨ Cập nhật Confirmed timer (tính từ ConfirmedAt) - ĐỒNG BỘ với Provider
                    if (newConfirmedTimer && currentConfirmedTimer) {
                        const newCancelTime = newConfirmedTimer.getAttribute('data-cancel-time');
                        const newConfirmedAt = newConfirmedTimer.getAttribute('data-confirmed-at');
                        const newAutoCancelMinutes = newConfirmedTimer.getAttribute('data-auto-cancel-minutes');
                        const oldCancelTime = currentConfirmedTimer.getAttribute('data-cancel-time');
                        
                        // ✨ QUAN TRỌNG: Cập nhật data-cancel-time (đã được server tính từ ConfirmedAt)
                        if (newCancelTime && newCancelTime !== oldCancelTime) {
                            // Debug: So sánh chi tiết trước khi cập nhật
                            const oldCancelTimeDate = oldCancelTime ? new Date(oldCancelTime) : null;
                            const newCancelTimeDate = new Date(newCancelTime);
                            const timeDiff = oldCancelTimeDate ? Math.abs(newCancelTimeDate - oldCancelTimeDate) : null;
                            
                            console.log('[Admin Refresh] ⚠️ Cancel-time changed:', {
                                old: oldCancelTime,
                                new: newCancelTime,
                                oldDate: oldCancelTimeDate ? oldCancelTimeDate.toISOString() : null,
                                newDate: newCancelTimeDate.toISOString(),
                                timeDiffMs: timeDiff,
                                timeDiffSeconds: timeDiff ? Math.floor(timeDiff / 1000) : null
                            });
                            
                            currentConfirmedTimer.setAttribute('data-cancel-time', newCancelTime);
                        }
                        
                        // ✨ QUAN TRỌNG: Cập nhật data-confirmed-at (giống Provider)
                        if (newConfirmedAt) {
                            const oldConfirmedAt = currentConfirmedTimer.getAttribute('data-confirmed-at');
                            if (newConfirmedAt !== oldConfirmedAt) {
                                // Debug: So sánh chi tiết
                                const oldConfirmedAtDate = oldConfirmedAt ? new Date(oldConfirmedAt) : null;
                                const newConfirmedAtDate = new Date(newConfirmedAt);
                                const timeDiff = oldConfirmedAtDate ? Math.abs(newConfirmedAtDate - oldConfirmedAtDate) : null;
                                
                                console.log('[Admin Refresh] ⚠️ Confirmed-at changed:', {
                                    old: oldConfirmedAt,
                                    new: newConfirmedAt,
                                    oldDate: oldConfirmedAtDate ? oldConfirmedAtDate.toISOString() : null,
                                    newDate: newConfirmedAtDate.toISOString(),
                                    timeDiffMs: timeDiff,
                                    timeDiffSeconds: timeDiff ? Math.floor(timeDiff / 1000) : null
                                });
                                
                                currentConfirmedTimer.setAttribute('data-confirmed-at', newConfirmedAt);
                            }
                        }
                        
                        if (newAutoCancelMinutes !== null) {
                            currentConfirmedTimer.setAttribute('data-auto-cancel-minutes', newAutoCancelMinutes);
                        }
                        
                        // ✨ Cập nhật countdown timer ngay lập tức nếu có thay đổi
                        if (newCancelTime && newCancelTime !== oldCancelTime) {
                            updateCountdown('.countdown-timer-confirmed-unpaid');
                        }
                    }
                    
                    // ✨ Cập nhật Pending timer display nếu có
                    if (newPendingTimer && currentPendingTimer) {
                        updateCountdown('.countdown-timer-detail');
                    }
                } catch (error) {
                    console.error('[Admin Refresh] Error:', error);
                } finally {
                    isRefreshing = false;
                }
            }
            
            // ✨ Tắt auto-refresh liên tục để tránh nhấp nháy
            // Chỉ refresh khi có thay đổi thực sự hoặc khi user thực hiện action
            // Refresh một lần sau khi page load để đảm bảo data đúng
            setTimeout(() => {
                refreshBookingDetail();
            }, 1000); // Refresh một lần sau 1 giây khi page load
            
            // ✨ KHÔNG auto-refresh liên tục để tránh nhấp nháy UI
            // Chỉ refresh khi cần thiết (khi có action từ user hoặc khi countdown hết)
            
            // Tắt auto-refresh khi page unload
            window.addEventListener('beforeunload', function() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });
            
            // ========== Xử lý chỉnh sửa thời gian hủy ==========
            const editModal = document.getElementById('editCancelTimeModal');
            const saveBtn = document.getElementById('saveCancelTimeBtn');
            const newRemainingMinutesInput = document.getElementById('newRemainingMinutes');
            const errorMessageDiv = document.getElementById('errorMessage');
            
            // Function để cập nhật thời gian còn lại hiện tại trong modal
            function updateCurrentRemainingTime() {
                const timer = document.querySelector('.countdown-timer-confirmed-unpaid');
                if (timer) {
                    const currentText = timer.textContent.trim();
                    const currentRemainingTimeEl = document.getElementById('currentRemainingTime');
                    if (currentRemainingTimeEl) {
                        // Lấy text từ timer, loại bỏ emoji nếu có
                        const cleanText = currentText.replace(/⏰/g, '').trim();
                        currentRemainingTimeEl.textContent = cleanText || 'Đang tính...';
                    }
                }
            }
            
            // Interval để cập nhật thời gian trong modal
            let modalUpdateInterval = null;
            
            // Khi mở modal, lấy thông tin booking
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function(event) {
                    const timer = document.querySelector('.countdown-timer-confirmed-unpaid');
                    if (timer) {
                        const bookingId = timer.getAttribute('data-booking-id');
                        // ✨ QUAN TRỌNG: Ưu tiên dùng data-confirmed-at cho Confirmed booking
                        // Nếu không có data-confirmed-at, mới dùng data-created-at (backward compatibility)
                        const confirmedAt = timer.getAttribute('data-confirmed-at') || timer.getAttribute('data-created-at');
                        const cancelTimeStr = timer.getAttribute('data-cancel-time');
                        
                        // Lưu vào hidden inputs
                        // ✨ QUAN TRỌNG: Lưu confirmedAt (không phải createdAt) để dùng trong UpdateCancelTime
                        const editBookingIdEl = document.getElementById('editBookingId');
                        const editCreatedAtEl = document.getElementById('editCreatedAt');
                        if (editBookingIdEl) {
                            editBookingIdEl.value = bookingId || '';
                        }
                        if (editCreatedAtEl) {
                            // ✨ Lưu confirmedAt (hoặc createdAt nếu không có) để dùng trong UpdateCancelTime
                            editCreatedAtEl.value = confirmedAt || '';
                        }
                        
                        // Tính thời gian còn lại hiện tại (phút)
                        let remainingMinutes = 1;
                        if (cancelTimeStr) {
                            let cancelTime;
                            if (cancelTimeStr.includes('Z') || cancelTimeStr.match(/[+-]\d{2}:\d{2}$/)) {
                                cancelTime = new Date(cancelTimeStr);
                            } else {
                                cancelTime = new Date(cancelTimeStr.replace('T', ' '));
                            }
                            
                            if (!isNaN(cancelTime.getTime())) {
                                const now = new Date();
                                const diff = cancelTime - now;
                                if (diff > 0) {
                                    remainingMinutes = Math.max(1, Math.ceil(diff / (1000 * 60)));
                                }
                            }
                        }
                        
                        // Set giá trị mặc định cho input
                        if (newRemainingMinutesInput) {
                            newRemainingMinutesInput.value = remainingMinutes;
                        }
                        
                        // Cập nhật thời gian còn lại hiện tại
                        updateCurrentRemainingTime();
                        
                        // Cập nhật thời gian trong modal mỗi giây
                        modalUpdateInterval = setInterval(function() {
                            updateCurrentRemainingTime();
                        }, 1000);
                    }
                });
                
                // Khi đóng modal, dừng interval
                editModal.addEventListener('hide.bs.modal', function(event) {
                    if (modalUpdateInterval) {
                        clearInterval(modalUpdateInterval);
                        modalUpdateInterval = null;
                    }
                });
            }
            
            // Ẩn thông báo lỗi khi người dùng bắt đầu nhập (chỉ thêm listener một lần)
            if (newRemainingMinutesInput) {
                newRemainingMinutesInput.addEventListener('input', function() {
                    if (errorMessageDiv) {
                        errorMessageDiv.style.display = 'none';
                        errorMessageDiv.textContent = '';
                    }
                    newRemainingMinutesInput.classList.remove('is-invalid');
                });
            }
            
            // Xử lý lưu thời gian hủy
            if (saveBtn) {
                saveBtn.addEventListener('click', async function() {
                const bookingId = document.getElementById('editBookingId').value;
                // ✨ QUAN TRỌNG: createdAtStr thực ra là confirmedAt cho Confirmed booking
                // Đổi tên biến để rõ ràng hơn (nhưng vẫn dùng editCreatedAt vì đã lưu confirmedAt vào đó)
                const createdAtStr = document.getElementById('editCreatedAt').value; // Thực ra là confirmedAt
                const newRemainingMinutes = parseInt(newRemainingMinutesInput.value);
                
                // Ẩn thông báo lỗi trước đó
                if (errorMessageDiv) {
                    errorMessageDiv.style.display = 'none';
                    errorMessageDiv.textContent = '';
                }
                
                // Xóa class lỗi từ input
                if (newRemainingMinutesInput) {
                    newRemainingMinutesInput.classList.remove('is-invalid');
                }
                
                if (!bookingId) {
                    if (errorMessageDiv) {
                        errorMessageDiv.textContent = 'Không tìm thấy ID đơn hàng';
                        errorMessageDiv.style.display = 'block';
                    }
                    return;
                }
                
                if (!newRemainingMinutes || newRemainingMinutes < 1) {
                    // Hiển thị thông báo lỗi dưới ô nhập
                    if (errorMessageDiv) {
                        errorMessageDiv.textContent = 'Vui lòng nhập số phút hợp lệ (từ 1 phút trở lên)';
                        errorMessageDiv.style.display = 'block';
                    }
                    if (newRemainingMinutesInput) {
                        newRemainingMinutesInput.classList.add('is-invalid');
                    }
                    return;
                }
                
                // Disable button và hiển thị loading
                saveBtn.disabled = true;
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Đang xử lý...';
                
                try {
                    // Gọi endpoint UpdateCancelTime (giống Index.cshtml)
                    const url = `@Url.Action("UpdateCancelTime", "AdminBooking", new { area = "Admin" })?bookingId=${bookingId}&remainingMinutes=${newRemainingMinutes}&createdAt=${encodeURIComponent(createdAtStr)}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error updating cancel time:', errorText);
                        throw new Error('Lỗi khi cập nhật thời gian hủy: ' + errorText);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Lỗi khi cập nhật thời gian hủy');
                    }
                    
                    // Đóng modal
                    const modal = bootstrap.Modal.getInstance(editModal);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Reload để lấy dữ liệu mới từ database
                    location.reload();
                    
                } catch (error) {
                    console.error('❌ Error updating cancel time:', error);
                    
                    // Hiển thị thông báo lỗi dưới ô nhập
                    if (errorMessageDiv) {
                        errorMessageDiv.textContent = 'Lỗi: ' + error.message;
                        errorMessageDiv.style.display = 'block';
                    }
                    if (newRemainingMinutesInput) {
                        newRemainingMinutesInput.classList.add('is-invalid');
                    }
                } finally {
                    // Restore button
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                    }
                }
            });
            }
        });

        // Image zoom modal (giống Provider)
        document.addEventListener('DOMContentLoaded', function() {
            const zoomableImages = document.querySelectorAll('.zoomable');
            const imgModal = document.getElementById('imageZoomModal');
            const imgEl = imgModal?.querySelector('img');
            const bsImgModal = imgModal ? new bootstrap.Modal(imgModal) : null;

            if (zoomableImages.length > 0 && bsImgModal && imgEl) {
                zoomableImages.forEach(img => {
                    img.style.cursor = 'pointer';
                    img.addEventListener('click', function(e) {
                        e.preventDefault();
                        const src = this.getAttribute('data-full') || this.getAttribute('src') || this.dataset.src;
                        const alt = this.getAttribute('alt') || '';
                        if (src) { 
                            imgEl.src = src; 
                            imgEl.alt = alt; 
                            bsImgModal.show(); 
                        }
                    });
                });
            }
        });
    </script>
}

<!-- Modal: Zoom Image -->
<div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageZoomModalLabel">Xem ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img src="" alt="" class="img-fluid" style="max-height: 80vh; width: auto;" />
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "pendingpayment" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "inprogress" or "in progress" or "in-progress" => "Đang xử lý",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string GetPaymentStatusText(string? paymentStatus)
    {
        if (string.IsNullOrEmpty(paymentStatus))
            return "Chưa xác định";

        var statusLower = paymentStatus.ToLower().Trim();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            _ => paymentStatus
        };
    }
}


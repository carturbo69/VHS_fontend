@model List<VHS_frontend.Areas.Admin.Models.Provider.ProviderDTO>
@{
    ViewData["Title"] = "Quản lý Provider";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    var includeDeleted = (bool)(ViewData["IncludeDeleted"] ?? false);
    var total = Model?.Count ?? 0;
    var deleted = Model?.Count(x => x.Deleted == true) ?? 0;
    var active = total - deleted;
}

@section Styles {
    <link rel="stylesheet" href="~/css/provider.css" asp-append-version="true" />
}

<section class="cat-page container-fluid provider-ui">
    <!-- Header -->
    <div class="cat-head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-briefcase"></i></div>
            <div>
                <h3>Tài khoản Provider</h3>
                <div class="sub">Xem và ẩn/khôi phục tài khoản</div>
            </div>
        </div>
        <div class="right">
            <div class="pill"><span class="lbl">Tổng</span><span class="val">@total</span></div>
            <div class="pill good"><span class="lbl">Hoạt động</span><span class="val">@active</span></div>
            <div class="pill mute"><span class="lbl">Đã xoá</span><span class="val">@deleted</span></div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="cat-toolbar">
        <div class="actions">
            <a class="btn btn-ghost soft"
               asp-area="Admin" asp-controller="AdminProvider" asp-action="Index"
               asp-route-includeDeleted="@( !includeDeleted )">
                <i class="bi @(includeDeleted ? "bi-eye-slash" : "bi-eye")"></i>
                @(includeDeleted ? "Ẩn đã xoá" : "Hiện cả đã xoá")
            </a>
        </div>

        <div class="search">
            <i class="bi bi-search"></i>
            <input id="txtSearch" class="form-control" placeholder="Tìm theo AccountName / Email..." />
        </div>
    </div>

    <!-- Table (không có cột mật khẩu) -->
    <div class="table-wrap">
        <table class="table table-hover align-middle mb-0" id="tblProviders">
            <thead>
                <tr>
                    <th style="width:30%">Tài khoản</th>
                    <th style="width:30%">Email</th>
                    <th style="width:20%">Ngày tạo</th>
                    <th style="width:12%">Trạng thái</th>
                    <th style="width:8%" class="text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody id="tbody">
                @foreach (var a in Model)
                {
                    var isDel = a.Deleted == true;
                    <tr class="cat-row @(isDel ? "open" : "")" data-id="@a.Id" data-name="@a.AccountName" data-email="@a.Email">
                        <td class="acc-cell">
                            <span class="avatar"><i class="bi bi-person-gear"></i></span>
                            <div class="meta">
                                <div class="name ellipsis fw-semibold">@a.AccountName</div>
                            </div>
                        </td>
                        <td class="ellipsis">@a.Email</td>
                        <td>@(a.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>
                            @if (!isDel)
                            {
                                <span class="state ok"><i class="bi bi-check-lg"></i> Hoạt động</span>
                            }
                            else
                            {
                                <span class="state del"><i class="bi bi-archive"></i> Đã xoá</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group action-inline">
                                <button class="btn btn-sm btn-outline-primary soft" onclick="openView('@a.Id')">
                                    <i class="bi bi-eye"></i><span>Xem</span>
                                </button>
                                @if (isDel)
                                {
                                    <button class="btn btn-sm btn-outline-warning soft" onclick="doRestore('@a.Id')">
                                        <i class="bi bi-arrow-counterclockwise"></i><span>Khôi phục</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger soft" onclick="doDelete('@a.Id')">
                                        <i class="bi bi-trash"></i><span>Xoá</span>
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (Model == null || Model.Count == 0)
        {
            <div class="p-3 text-center text-muted">Chưa có tài khoản nào.</div>
        }
    </div>

    <!-- Center Notifications -->
    <div id="notif-root" aria-live="polite" aria-atomic="true"></div>
</section>

<!-- Modal: View (read-only) — bỏ dòng mật khẩu -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-x">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết Provider</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="stack">
                    <div class="row-item"><span class="lbl">Account name</span><div class="val" id="vName">—</div></div>
                    <div class="row-item"><span class="lbl">Email</span><div class="val" id="vEmail">—</div></div>
                    <div class="row-item"><span class="lbl">Ngày tạo</span><div class="val" id="vCreated">—</div></div>
                    <div class="row-item"><span class="lbl">Trạng thái</span><div class="val" id="vState">—</div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const routes = {
          get     : '@Url.Action("Get", "AdminProvider", new { area = "Admin" })',
          del     : '@Url.Action("Delete", "AdminProvider", new { area = "Admin" })',
          restore : '@Url.Action("Restore", "AdminProvider", new { area = "Admin" })'
        };

        // Toast giữa màn hình
        function showNotice(msg, type='info', duration=900){
          const root = document.getElementById('notif-root');
          const box  = document.createElement('div');
          box.className = `center-toast ${type}`;
          box.innerHTML = `
            <div class="toast-box">
              <div class="accent"></div>
              <i class="bi ${type==='success'?'bi-check-circle':
                           type==='error'  ?'bi-x-circle'   :
                           type==='warn'   ?'bi-exclamation-triangle' : 'bi-info-circle'}"></i>
              <span class="msg">${msg}</span>
            </div>`;
          root.appendChild(box);
          requestAnimationFrame(()=> box.classList.add('show'));
          setTimeout(()=> { box.classList.remove('show'); setTimeout(()=> box.remove(), 180); }, duration);
        }

        // Search
        document.getElementById('txtSearch')?.addEventListener('input', function(){
          const q = this.value.toLowerCase().trim();
          document.querySelectorAll('#tblProviders tbody tr').forEach(tr=>{
            const name  = tr.dataset.name?.toLowerCase()  ?? '';
            const email = tr.dataset.email?.toLowerCase() ?? '';
            tr.style.display = (name.includes(q) || email.includes(q)) ? '' : 'none';
          });
        });

        // Modal View
        const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));
        async function openView(id){
          const res = await fetch(routes.get + `?id=${id}`);
          if(!res.ok){ showNotice('Không đọc được dữ liệu.', 'error', 1200); return; }
          const x = await res.json();
          document.getElementById('vName').textContent    = x.accountName ?? '—';
          document.getElementById('vEmail').textContent   = x.email ?? '—';
          document.getElementById('vCreated').textContent = (x.createdAt ? new Date(x.createdAt).toLocaleString() : '—');
          document.getElementById('vState').textContent   = (x.deleted ? 'Đã xoá' : 'Hoạt động');
          viewModal.show();
        }
        window.openView = openView;

        // Soft-delete / Restore
        async function doDelete(id){
          if(!confirm('Ẩn tài khoản này?')) return;
          const res = await fetch(routes.del + `?id=${id}`, { method:'DELETE' });
          if(res.ok){ showNotice('Đã ẩn tài khoản.', 'success', 650); setTimeout(()=> location.reload(), 400); }
          else      { showNotice((await res.text()) || 'Ẩn thất bại.', 'error', 1400); }
        }
        async function doRestore(id){
          const res = await fetch(routes.restore + `?id=${id}`, { method:'POST' });
          if(res.ok){ showNotice('Đã khôi phục tài khoản.', 'success', 650); setTimeout(()=> location.reload(), 400); }
          else      { showNotice((await res.text()) || 'Khôi phục thất bại.', 'error', 1400); }
        }
        window.doDelete = doDelete;
        window.doRestore = doRestore;
    </script>
}

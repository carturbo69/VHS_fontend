@model List<VHS_frontend.Areas.Admin.Models.Provider.ProviderDTO>
@{
    ViewData["Title"] = "Quản lý tài khoản nhà cung cấp";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    var includeDeleted = (bool)(ViewData["IncludeDeleted"] ?? false);
    var total = Model?.Count ?? 0;
    var deleted = Model?.Count(x => x.IsDeleted == true) ?? 0;
    var active = total - deleted;
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-provider.css" asp-append-version="true" />
}

<section class="cat-page container-fluid provider-ui">
    <!-- Header -->
    <div class="cat-head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-briefcase"></i></div>
            <div>
                <h3>Tài khoản nhà cung cấp</h3>
                <div class="sub">Xem và khóa/khôi phục tài khoản</div>
            </div>
        </div>
        <div class="right">
            <div class="pill"><span class="lbl">Tổng</span><span class="val">@total</span></div>
            <div class="pill good"><span class="lbl">Hoạt động</span><span class="val">@active</span></div>
            <div class="pill mute"><span class="lbl">Ngừng hoạt động</span><span class="val">@deleted</span></div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="toolbar-card card-x">
        <div class="cat-toolbar">
            <div class="actions">
                <a class="btn btn-ghost soft"
                   asp-area="Admin" asp-controller="AdminProvider" asp-action="Index"
                   asp-route-includeDeleted="@( !includeDeleted )">
                    <i class="bi @(includeDeleted ? "bi-eye-slash" : "bi-eye")"></i>
                    @(includeDeleted ? "Ẩn ngừng hoạt động" : "Hiện cả ngừng hoạt động")
                </a>
            </div>

            <div class="search">
                <i class="bi bi-search"></i>
                <input id="txtSearch" class="form-control" placeholder="Tìm theo tài khoản / Email..." />
            </div>
        </div>
    </div>

    <!-- Table Card -->
    <div class="table-card card-x">
        <div class="table-wrap">
        <table class="table table-hover align-middle mb-0" id="tblProviders">
            <thead>
                <tr>
                    <th style="width:20%">Tài khoản</th>
                    <th style="width:28%">Email</th>
                    <th style="width:20%">Ngày tạo</th>
                    <th style="width:20%">Trạng thái</th>
                    <th style="width:12%" class="text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody id="tbody">
                @foreach (var a in Model)
                {
                    var isDel = a.IsDeleted == true;
                    <tr class="cat-row @(isDel ? "open" : "")" data-id="@a.Id" data-name="@a.AccountName" data-email="@a.Email">
                        <td class="acc-cell">
                            <span class="avatar"><i class="bi bi-person-gear"></i></span>
                            <div class="meta">
                                <div class="name ellipsis fw-semibold">@a.AccountName</div>
                            </div>
                        </td>
                        <td class="ellipsis">@a.Email</td>
                        <td>@(a.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>
                            @if (!isDel)
                            {
                                <span class="state ok"><i class="bi bi-check-lg"></i> Hoạt động</span>
                            }
                            else
                            {
                                <span class="state del"><i class="bi bi-archive"></i> Ngừng hoạt động</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group action-inline">
                                @if (isDel)
                                {
                                    <button class="btn btn-sm btn-outline-warning soft" onclick="doRestore('@a.Id')">
                                        <i class="bi bi-arrow-counterclockwise"></i><span>Khôi phục</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger soft" onclick="doDelete('@a.Id')">
                                        <i class="bi bi-lock"></i><span>Khóa</span>
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (Model == null || Model.Count == 0)
        {
            <div class="p-3 text-center text-muted">Chưa có tài khoản nào.</div>
        }
    </div>

    <!-- Center Notifications -->
    <div id="notif-root" aria-live="polite" aria-atomic="true"></div>
</section>

<!-- Modal: Nhập lý do khóa tài khoản -->
<div class="modal fade" id="lockAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-x">
            <div class="modal-header">
                <h5 class="modal-title">Khóa tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Lý do khóa tài khoản <span class="text-danger">*</span></label>
                    <textarea id="lockReasonInput" class="form-control" rows="4" placeholder="Nhập lý do khóa tài khoản..." required></textarea>
                    <div class="invalid-feedback">Vui lòng nhập lý do khóa tài khoản.</div>
                </div>
                <div class="form-text">Lý do này sẽ được gửi qua email cho tài khoản bị khóa.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger soft" id="btnConfirmLock">Xác nhận khóa</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const routes = {
          del     : '@Url.Action("Delete", "AdminProvider", new { area = "Admin" })',
          restore : '@Url.Action("Restore", "AdminProvider", new { area = "Admin" })'
        };

        // Toast giữa màn hình
        (function(){
          var toastManager = {
            currentToast: null,
            hideTimeout: null,
            removeTimeout: null,
            
            clearAll: function(){
              // Clear tất cả timeout
              if(this.hideTimeout){
                clearTimeout(this.hideTimeout);
                this.hideTimeout = null;
              }
              if(this.removeTimeout){
                clearTimeout(this.removeTimeout);
                this.removeTimeout = null;
              }
              
              // Xóa toast hiện tại
              if(this.currentToast && this.currentToast.parentNode){
                this.currentToast.classList.remove('show');
                var self = this;
                setTimeout(function(){
                  if(self.currentToast && self.currentToast.parentNode){
                    self.currentToast.remove();
                  }
                  self.currentToast = null;
                }, 100);
              }
              
              // Xóa tất cả toast còn sót trong DOM
              var root = document.getElementById('notif-root');
              if(root){
                var existingToasts = root.querySelectorAll('.center-toast');
                for(var i = 0; i < existingToasts.length; i++){
                  var toast = existingToasts[i];
                  if(toast.parentNode){
                    toast.classList.remove('show');
                    toast.remove();
                  }
                }
              }
            },
            
            show: function(msg, type, duration){
              if(!type) type = 'info';
              if(!duration) duration = 2500;
              
              // Xóa toast cũ trước
              this.clearAll();
              
              var root = document.getElementById('notif-root');
              if(!root) return;
              
              // Tạo toast mới
              var box = document.createElement('div');
              box.className = 'center-toast ' + type;
              var iconClass = type==='success'?'bi-check-circle':
                               type==='error'  ?'bi-x-circle'   :
                               type==='warn'   ?'bi-exclamation-triangle' : 'bi-info-circle';
              box.innerHTML = 
                '<div class="toast-box">' +
                  '<div class="accent"></div>' +
                  '<i class="bi ' + iconClass + '"></i>' +
                  '<span class="msg">' + msg + '</span>' +
                '</div>';
              
              root.appendChild(box);
              this.currentToast = box;
              
              var self = this;
              
              // Hiển thị với animation
              setTimeout(function(){ 
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.add('show'); 
                }
              }, 50);

              // Tự động ẩn sau duration
              this.hideTimeout = setTimeout(function() {
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.remove('show');
                  self.removeTimeout = setTimeout(function(){ 
                    if(self.currentToast && self.currentToast.parentNode){
                      self.currentToast.remove();
                    }
                    self.currentToast = null;
                    self.hideTimeout = null;
                    self.removeTimeout = null;
                  }, 350);
                }
              }, duration);
            }
          };
          
          window.showNotice = function(msg, type, duration){
            toastManager.show(msg, type, duration);
          };
        })();

        // Search
        document.getElementById('txtSearch')?.addEventListener('input', function(){
          const q = this.value.toLowerCase().trim();
          document.querySelectorAll('#tblProviders tbody tr').forEach(tr=>{
            const name  = tr.dataset.name?.toLowerCase()  ?? '';
            const email = tr.dataset.email?.toLowerCase() ?? '';
            tr.style.display = (name.includes(q) || email.includes(q)) ? '' : 'none';
          });
        });


        // Soft-delete / Restore
        let currentDeleteId = null;
        const lockModal = new bootstrap.Modal(document.getElementById('lockAccountModal'));
        const lockReasonInput = document.getElementById('lockReasonInput');
        const btnConfirmLock = document.getElementById('btnConfirmLock');
        
        async function doDelete(id){
          currentDeleteId = id;
          lockReasonInput.value = '';
          lockReasonInput.classList.remove('is-invalid');
          lockModal.show();
        }
        
        btnConfirmLock.addEventListener('click', async function(){
          const reason = lockReasonInput.value.trim();
          if(!reason){
            lockReasonInput.classList.add('is-invalid');
            return;
          }
          
          lockReasonInput.classList.remove('is-invalid');
          btnConfirmLock.disabled = true;
          btnConfirmLock.textContent = 'Đang xử lý...';
          
          try {
            const res = await fetch(routes.del + '?id=' + encodeURIComponent(currentDeleteId), {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ LockReason: reason })
            });
            
            if(res.ok){ 
              showNotice('Đã khóa tài khoản và gửi email thông báo.', 'success', 2500);
              updateRowStatus(currentDeleteId, true);
              lockModal.hide();
            }
            else { 
              showNotice((await res.text()) || 'Khóa thất bại.', 'error', 3000); 
            }
          } catch(error) {
            showNotice('Có lỗi xảy ra: ' + error.message, 'error', 3000);
          } finally {
            btnConfirmLock.disabled = false;
            btnConfirmLock.textContent = 'Xác nhận khóa';
            currentDeleteId = null;
          }
        });
        
        // Reset modal khi đóng
        document.getElementById('lockAccountModal').addEventListener('hidden.bs.modal', function(){
          lockReasonInput.value = '';
          lockReasonInput.classList.remove('is-invalid');
          currentDeleteId = null;
        });
        async function doRestore(id){
          const res = await fetch(routes.restore + '?id=' + encodeURIComponent(id), { method:'POST' });
          if(res.ok){ 
            showNotice('Đã khôi phục tài khoản và gửi email thông báo.', 'success', 2500);
            updateRowStatus(id, false);
          }
          else { 
            showNotice((await res.text()) || 'Khôi phục thất bại.', 'error', 3000); 
          }
        }
        
        function updateRowStatus(id, isDeleted){
          const row = document.querySelector('tr[data-id="' + id + '"]');
          if(!row) return;
          
          const statusCell = row.querySelector('td:nth-child(4)');
          const actionCell = row.querySelector('td:nth-child(5)');
          const btnGroup = actionCell.querySelector('.btn-group');
          
          if(isDeleted){
            // Đổi trạng thái thành "Ngừng hoạt động"
            statusCell.innerHTML = '<span class="state del"><i class="bi bi-archive"></i> Ngừng hoạt động</span>';
            // Đổi nút thành "Khôi phục"
            btnGroup.innerHTML = '<button class="btn btn-sm btn-outline-warning soft" onclick="doRestore(\'' + id + '\')"><i class="bi bi-arrow-counterclockwise"></i><span>Khôi phục</span></button>';
            row.classList.add('open');
            // Cập nhật số đếm: active giảm 1, deleted tăng 1
            updateCounts(-1, 1);
          } else {
            // Đổi trạng thái thành "Hoạt động"
            statusCell.innerHTML = '<span class="state ok"><i class="bi bi-check-lg"></i> Hoạt động</span>';
            // Đổi nút thành "Khóa"
            btnGroup.innerHTML = '<button class="btn btn-sm btn-outline-danger soft" onclick="doDelete(\'' + id + '\')"><i class="bi bi-lock"></i><span>Khóa</span></button>';
            row.classList.remove('open');
            // Cập nhật số đếm: active tăng 1, deleted giảm 1
            updateCounts(1, -1);
          }
        }
        
        function updateCounts(activeChange, deletedChange){
          const activePill = document.querySelector('.pill.good .val');
          const deletedPill = document.querySelector('.pill.mute .val');
          
          if(activePill){
            const current = parseInt(activePill.textContent) || 0;
            activePill.textContent = Math.max(0, current + activeChange);
          }
          if(deletedPill){
            const current = parseInt(deletedPill.textContent) || 0;
            deletedPill.textContent = Math.max(0, current + deletedChange);
          }
        }
        window.doDelete = doDelete;
        window.doRestore = doRestore;
    </script>
}

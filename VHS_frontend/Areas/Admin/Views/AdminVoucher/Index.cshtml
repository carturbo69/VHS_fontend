@using VHS_frontend.Areas.Admin.Models.Voucher
@model List<AdminVoucherItemDTO>

@{
    ViewData["Title"] = "Quản lý Voucher";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    var total = (int)(ViewBag.Total ?? Model.Count);
    var active = (int)(ViewBag.Active ?? Model.Count(x => x.IsActive == true));
    var inactive = (int)(ViewBag.Inactive ?? Model.Count(x => x.IsActive != true));
    var expired = (int)(ViewBag.Expired ?? Model.Count(x => x.IsExpired));
    var keyword = (string)(ViewBag.Keyword ?? "");
    bool? onlyActive = (bool?)ViewBag.OnlyActive;
}

@section Styles {
    <link rel="stylesheet" href="~/css/voucher.css" asp-append-version="true" />
}

<section class="v-page container-fluid">
    <!-- Header / Metrics -->
    <div class="v-head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-ticket-perforated"></i></div>
            <div>
                <h3>Voucher</h3>
                <div class="sub">Quản lý mã giảm giá (Percent &amp; Max Amount)</div>
            </div>
        </div>
        <div class="right">
            <div class="pill"><span class="lbl">Tổng</span><span class="val">@total</span></div>
            <div class="pill good"><span class="lbl">Hoạt động</span><span class="val">@active</span></div>
            <div class="pill mute"><span class="lbl">Ngưng</span><span class="val">@inactive</span></div>
            <div class="pill warn"><span class="lbl">Hết hạn</span><span class="val">@expired</span></div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="toolbar-card card-x">
    <div class="v-toolbar">
        <div class="row g-3">
            <!-- Bên trái: Nút thêm + Chỉ hiện hoạt động + Tìm kiếm (4 cột) -->
            <div class="col-md-4">
                    <div class="search-card">
                        <div class="row g-2">
                        <!-- Hàng trên: Nút thêm + Chỉ hiện hoạt động -->
                        <div class="col-12">
                                <div class="d-flex gap-2 flex-nowrap align-items-center">
                                <button class="btn btn-primary soft" id="btnCreate">
                                        <i class="bi bi-plus-circle"></i> <span>Thêm voucher</span>
                                </button>
                                    <a class="btn btn-ghost soft d-inline-flex align-items-center"
                                   asp-area="Admin" asp-controller="AdminVoucher" asp-action="Index"
                                   asp-route-onlyActive="@( onlyActive.HasValue ? (!onlyActive.Value) : true )"
                                   asp-route-keyword="@keyword">
                                    <i class="bi @(onlyActive==true ? "bi-eye-slash" : "bi-eye")"></i>
                                        <span class="ms-1">@(onlyActive == true ? "Hiện tất cả" : "Hiện hoạt động")</span>
                                </a>
                            </div>
                        </div>
                        <!-- Hàng dưới: Tìm kiếm -->
                        <div class="col-12">
                            <form class="search" method="get" asp-area="Admin" asp-controller="AdminVoucher" asp-action="Index">
                                <div class="input-group">
                                    <input name="keyword" value="@keyword" class="form-control" placeholder="Tìm theo mã / mô tả…" />
                                    <button class="btn btn-outline-secondary" type="submit">
                                        <i class="bi bi-search"></i>
                                    </button>
                                    @if (onlyActive == true)
                                    {
                                        <input type="hidden" name="onlyActive" value="true" />
                                    }
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bên phải: Filter (6 cột) -->
            <div class="col-md-8">
                    <div class="filter-card">
                    <div class="row g-3">
                        <!-- Hàng 1: % Giảm và Trạng thái thời gian ngang nhau -->
                        <div class="col-md-6">
                            <div class="fb-label">% Giảm</div>
                            <div class="fb-row">
                                <input id="pfMin" type="number" class="form-control" placeholder="Từ" min="0" max="100" />
                                <span class="dash">–</span>
                                <input id="pfMax" type="number" class="form-control" placeholder="Đến" min="0" max="100" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="fb-label">Trạng thái thời gian</div>
                            <select id="timeState" class="form-select">
                                <option value="all" selected>Tất cả</option>
                                <option value="upcoming">Chưa bắt đầu</option>
                                <option value="started">Đang diễn ra</option>
                                <option value="expired">Đã hết hạn</option>
                            </select>
                        </div>
                        <!-- Hàng 2: Thời gian áp dụng + Nút Lọc/Xóa -->
                        <div class="col-12">
                            <div class="d-flex gap-2 align-items-end">
                                <div class="flex-grow-1">
                                    <div class="fb-label">Thời gian áp dụng</div>
                                    <div class="fb-row">
                                        <input id="dMin" type="date" class="form-control" />
                                        <span class="dash">→</span>
                                        <input id="dMax" type="date" class="form-control" />
                                    </div>
                                </div>
                                <div class="filter-actions">
                                    <button class="btn btn-primary soft" id="btnApply" type="button">Lọc</button>
                                    <button class="btn btn-ghost soft" id="btnClear" type="button" title="Xoá lọc">Xoá</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Card -->
    <div class="table-card card-x">
        <div class="table-wrap">
        <div class="table-scroll">
            <table class="table table-hover align-middle mb-0" id="tblVouchers">
                <thead>
                    <tr>
                        <th class="w-code">Mã</th>
                        <th>Mô tả</th>
                        <th class="w-number">% giảm</th>
                        <th class="w-number">Giảm tối đa</th>
                        <th class="w-time">Thời gian</th>
                        <th class="w-number">Sử dụng</th>
                        <th class="w-state">Trạng thái</th>
                        <th class="text-end w-actions">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var v in Model)
                    {
                        var sStr = v.StartDate?.ToString("yyyy-MM-dd") ?? "";
                        var eStr = v.EndDate?.ToString("yyyy-MM-dd") ?? "";
                        var sShow = v.StartDate?.ToString("dd/MM/yyyy") ?? "—";
                        var eShow = v.EndDate?.ToString("dd/MM/yyyy") ?? "—";
                        var tState = v.IsUpcoming ? "upcoming" : (v.IsExpired ? "expired" : "started");
                        <tr data-id="@v.VoucherId"
                            data-start="@sStr"
                            data-end="@eStr"
                            data-tstate="@tState">
                            <td class="fw-semibold mono">@v.Code</td>
                            <td class="description-text" title="@v.Description">@v.Description</td>
                            <td>@(v.DiscountPercent?.ToString("0.##") ?? "—")</td>
                            <td>@(v.DiscountMaxAmount?.ToString("N0") ?? "—")đ</td>
                            <td class="time-cell">
                                <div class="date-line">@sShow → @eShow</div>
                                <div class="substate">
                                    @if (v.IsUpcoming)
                                    {
                                        <span class="badge upcoming">Chưa bắt đầu</span>
                                    }
                                    else if (v.IsExpired)
                                    {
                                        <span class="badge expired">Hết hạn</span>
                                    }
                                    else
                                    {
                                        <span class="badge started">Đang diễn ra</span>
                                    }
                                </div>
                            </td>
                            <td>@(v.UsedCount ?? 0) / @(v.UsageLimit?.ToString() ?? "∞")</td>
                            <td>
                                @if (v.IsActive == true)
                                {
                                    <span class="state ok">Hoạt động</span>
                                }
                                else
                                {
                                    <span class="state off">Tạm dừng</span>
                                }
                            </td>
                            <td class="text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-edit soft btn-edit-v">
                                        <i class="bi bi-pencil-square"></i> Sửa
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger soft btn-del-v">
                                        <i class="bi bi-trash"></i> Xoá
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        </div>
    </div>
</section>

<!-- Toast notification root -->
<div id="notif-root"></div>

<!-- Modal: Voucher -->
<div class="modal fade" id="vModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x" id="vForm">
            <div class="modal-header">
                <h5 class="modal-title" id="vModalTitle">Thêm voucher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="vId" />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Mã (Code)</label>
                        <input type="text" id="vCode" class="form-control mono" maxlength="64" required />
                        <div class="invalid-feedback">Vui lòng nhập mã hợp lệ.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Trạng thái</label>
                        <select id="vActive" class="form-select">
                            <option value="true">Hoạt động</option>
                            <option value="false">Tạm dừng</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Mô tả</label>
                        <textarea id="vDesc" class="form-control" rows="2" maxlength="512"></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Giảm (%)</label>
                        <input type="number" id="vPercent" step="0.01" min="0" max="100" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Giảm tối đa</label>
                        <input type="number" id="vMax" step="0.01" min="0" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Bắt đầu</label>
                        <input type="date" id="vStart" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Kết thúc</label>
                        <input type="date" id="vEnd" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Giới hạn dùng</label>
                        <input type="number" id="vLimit" class="form-control" min="0" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Đã dùng</label>
                        <input type="number" id="vUsed" class="form-control" min="0" disabled value="0" />
                    </div>
                </div>

                <div id="vError" class="text-danger small mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary soft" id="btnSaveV">Lưu</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        /* ======= CENTER TOAST (boxed + accent bar + fast) ======= */
        (function(){
          var toastManager = {
            currentToast: null,
            hideTimeout: null,
            removeTimeout: null,
            
            clearAll: function(){
              // Clear tất cả timeout
              if(this.hideTimeout){
                clearTimeout(this.hideTimeout);
                this.hideTimeout = null;
              }
              if(this.removeTimeout){
                clearTimeout(this.removeTimeout);
                this.removeTimeout = null;
              }
              
              // Xóa toast hiện tại
              if(this.currentToast && this.currentToast.parentNode){
                this.currentToast.classList.remove('show');
                var self = this;
                setTimeout(function(){
                  if(self.currentToast && self.currentToast.parentNode){
                    self.currentToast.remove();
                  }
                  self.currentToast = null;
                }, 100);
              }
              
              // Xóa tất cả toast còn sót trong DOM
              var root = document.getElementById('notif-root');
              if(root){
                var existingToasts = root.querySelectorAll('.center-toast');
                for(var i = 0; i < existingToasts.length; i++){
                  var toast = existingToasts[i];
                  if(toast.parentNode){
                    toast.classList.remove('show');
                    toast.remove();
                  }
                }
              }
            },
            
            show: function(msg, type, duration){
              if(!type) type = 'info';
              // Mặc định: success 2500ms, error/warn 3000ms, info 2500ms
              if(!duration) {
                duration = type === 'success' ? 2500 : (type === 'error' || type === 'warn' ? 3000 : 2500);
              }
              
              // Xóa toast cũ trước
              this.clearAll();
              
              var root = document.getElementById('notif-root');
              if(!root) return;
              
              // Tạo toast mới
              var box = document.createElement('div');
              box.className = 'center-toast ' + type;
              var iconClass = type==='success'?'bi-check-circle':
                               type==='error'  ?'bi-x-circle'   :
                               type==='warn'   ?'bi-exclamation-triangle' : 'bi-info-circle';
              box.innerHTML = 
                '<div class="toast-box">' +
                  '<div class="accent"></div>' +
                  '<i class="bi ' + iconClass + '"></i>' +
                  '<span class="msg">' + msg + '</span>' +
                '</div>';
              
              root.appendChild(box);
              this.currentToast = box;
              
              var self = this;
              
              // Hiển thị với animation - đợi một chút để DOM sẵn sàng
              requestAnimationFrame(function() {
                setTimeout(function(){ 
                  if(self.currentToast && self.currentToast.parentNode){
                    self.currentToast.classList.add('show'); 
                  }
                }, 100);
              });

              // Tự động ẩn sau duration - đảm bảo đủ thời gian hiển thị
              this.hideTimeout = setTimeout(function() {
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.remove('show');
                  // Đợi animation fade-out hoàn tất trước khi remove
                  self.removeTimeout = setTimeout(function(){ 
                    if(self.currentToast && self.currentToast.parentNode){
                      self.currentToast.remove();
                    }
                    self.currentToast = null;
                    self.hideTimeout = null;
                    self.removeTimeout = null;
                  }, 400); // Tăng từ 350ms lên 400ms để đảm bảo animation hoàn tất
                }
              }, duration);
            }
          };
          
          window.showNotice = function(msg, type, duration){
            toastManager.show(msg, type, duration);
          };
        })();

        const routes = {
          vGet   : '@Url.Action("Get", "AdminVoucher", new { area = "Admin" })',
          vCreate: '@Url.Action("Create", "AdminVoucher", new { area = "Admin" })',
          vUpdate: '@Url.Action("Update", "AdminVoucher", new { area = "Admin" })',
          vDelete: '@Url.Action("Delete", "AdminVoucher", new { area = "Admin" })'
        };

        // ===== Helper functions =====
        function formatDateYMDToDDMMYYYY(ymd) {
          if (!ymd) return '—';
          // Xử lý cả ISO format (có T và time) và date-only format
          let dateStr = ymd;
          // Nếu có 'T' (ISO format), chỉ lấy phần date trước 'T'
          if (dateStr.indexOf('T') !== -1) {
            dateStr = dateStr.split('T')[0];
          }
          // Nếu có space, chỉ lấy phần date trước space
          if (dateStr.indexOf(' ') !== -1) {
            dateStr = dateStr.split(' ')[0];
          }
          const parts = dateStr.split('-');
          if (parts.length !== 3) return ymd;
          // Đảm bảo day và month có 2 chữ số
          const day = parts[2].padStart(2, '0');
          const month = parts[1].padStart(2, '0');
          const year = parts[0];
          return day + '/' + month + '/' + year;
        }

        function getTimeState(startDate, endDate) {
          if (!startDate || !endDate) return 'started';
          try {
            const now = new Date();
            // Xử lý date string có thể chứa time (ISO format)
            let startStr = startDate;
            let endStr = endDate;
            if (startStr.indexOf('T') !== -1) startStr = startStr.split('T')[0];
            if (endStr.indexOf('T') !== -1) endStr = endStr.split('T')[0];
            if (startStr.indexOf(' ') !== -1) startStr = startStr.split(' ')[0];
            if (endStr.indexOf(' ') !== -1) endStr = endStr.split(' ')[0];
            
            const start = new Date(startStr + 'T00:00:00');
            const end = new Date(endStr + 'T23:59:59');
            if (now < start) return 'upcoming';
            if (now > end) return 'expired';
            return 'started';
          } catch (e) {
            return 'started';
          }
        }

        function getTimeStateBadge(tState) {
          if (tState === 'upcoming') return '<span class="badge upcoming">Chưa bắt đầu</span>';
          if (tState === 'expired') return '<span class="badge expired">Hết hạn</span>';
          return '<span class="badge started">Đang diễn ra</span>';
        }

        function formatNumber(num) {
          if (!num && num !== 0) return '—';
          return num.toLocaleString('vi-VN');
        }

        function addNewVoucherRow(v) {
          const tbody = document.querySelector('#tblVouchers tbody');
          if (!tbody) return;

          // Lấy date string và loại bỏ phần time nếu có
          let sStr = v.startDate || '';
          let eStr = v.endDate || '';
          if (sStr.indexOf('T') !== -1) sStr = sStr.split('T')[0];
          if (eStr.indexOf('T') !== -1) eStr = eStr.split('T')[0];
          if (sStr.indexOf(' ') !== -1) sStr = sStr.split(' ')[0];
          if (eStr.indexOf(' ') !== -1) eStr = eStr.split(' ')[0];
          
          const sShow = formatDateYMDToDDMMYYYY(sStr);
          const eShow = formatDateYMDToDDMMYYYY(eStr);
          const tState = getTimeState(sStr, eStr);
          const percent = v.discountPercent ? parseFloat(v.discountPercent).toFixed(2) : '—';
          const maxAmount = v.discountMaxAmount ? formatNumber(v.discountMaxAmount) + 'đ' : '—';
          const used = v.usedCount || 0;
          const limit = v.usageLimit ? formatNumber(v.usageLimit) : '∞';
          const stateHtml = v.isActive ? '<span class="state ok">Hoạt động</span>' : '<span class="state off">Tạm dừng</span>';

          const tr = document.createElement('tr');
          tr.setAttribute('data-id', v.voucherId);
          tr.setAttribute('data-start', sStr);
          tr.setAttribute('data-end', eStr);
          tr.setAttribute('data-tstate', tState);

          tr.innerHTML = 
            '<td class="fw-semibold mono">' + (v.code || '') + '</td>' +
            '<td class="description-text" title="' + (v.description || '') + '">' + (v.description || '') + '</td>' +
            '<td>' + percent + '</td>' +
            '<td>' + maxAmount + '</td>' +
            '<td class="time-cell">' +
              '<div class="date-line">' + sShow + ' → ' + eShow + '</div>' +
              '<div class="substate">' + getTimeStateBadge(tState) + '</div>' +
            '</td>' +
            '<td>' + used + ' / ' + limit + '</td>' +
            '<td>' + stateHtml + '</td>' +
            '<td class="text-end">' +
              '<div class="btn-group">' +
                '<button class="btn btn-sm btn-edit soft btn-edit-v">' +
                  '<i class="bi bi-pencil-square"></i> Sửa' +
                '</button>' +
                '<button class="btn btn-sm btn-outline-danger soft btn-del-v">' +
                  '<i class="bi bi-trash"></i> Xoá' +
                '</button>' +
              '</div>' +
            '</td>';

          tbody.insertBefore(tr, tbody.firstChild);
        }

        function updateVoucherRow(v) {
          const tr = document.querySelector('tr[data-id="' + v.voucherId + '"]');
          if (!tr) return;

          // Lấy date string và loại bỏ phần time nếu có
          let sStr = v.startDate || '';
          let eStr = v.endDate || '';
          if (sStr.indexOf('T') !== -1) sStr = sStr.split('T')[0];
          if (eStr.indexOf('T') !== -1) eStr = eStr.split('T')[0];
          if (sStr.indexOf(' ') !== -1) sStr = sStr.split(' ')[0];
          if (eStr.indexOf(' ') !== -1) eStr = eStr.split(' ')[0];
          
          const sShow = formatDateYMDToDDMMYYYY(sStr);
          const eShow = formatDateYMDToDDMMYYYY(eStr);
          const tState = getTimeState(sStr, eStr);
          const percent = v.discountPercent ? parseFloat(v.discountPercent).toFixed(2) : '—';
          const maxAmount = v.discountMaxAmount ? formatNumber(v.discountMaxAmount) + 'đ' : '—';
          const used = v.usedCount || 0;
          const limit = v.usageLimit ? formatNumber(v.usageLimit) : '∞';
          const stateHtml = v.isActive ? '<span class="state ok">Hoạt động</span>' : '<span class="state off">Tạm dừng</span>';

          tr.setAttribute('data-start', sStr);
          tr.setAttribute('data-end', eStr);
          tr.setAttribute('data-tstate', tState);

          const tds = tr.querySelectorAll('td');
          if (tds.length >= 7) {
            tds[0].textContent = v.code || '';
            tds[0].setAttribute('title', v.code || '');
            tds[1].textContent = v.description || '';
            tds[1].setAttribute('title', v.description || '');
            tds[2].textContent = percent;
            tds[3].textContent = maxAmount;
            tds[4].innerHTML = '<div class="date-line">' + sShow + ' → ' + eShow + '</div>' +
              '<div class="substate">' + getTimeStateBadge(tState) + '</div>';
            tds[5].textContent = used + ' / ' + limit;
            tds[6].innerHTML = stateHtml;
          }
        }

        // ===== Modal + fields =====
        const vModal = new bootstrap.Modal(document.getElementById('vModal'));
        const vId    = document.getElementById('vId');
        const vCode  = document.getElementById('vCode');
        const vDesc  = document.getElementById('vDesc');
        const vPercent = document.getElementById('vPercent');
        const vMax     = document.getElementById('vMax');
        const vStart   = document.getElementById('vStart');
        const vEnd     = document.getElementById('vEnd');
        const vLimit   = document.getElementById('vLimit');
        const vUsed    = document.getElementById('vUsed');
        const vActive  = document.getElementById('vActive');
        const vError   = document.getElementById('vError');

        // ===== Helpers =====
        function clearError(){
          if (!vError) return;
          vError.textContent = '';
          vError.hidden = true;
        }
        function showError(msg){
          if (!vError) { alert(msg); return; }
          vError.textContent = msg || 'Có lỗi xảy ra.';
          vError.hidden = false;
          vError.classList.remove('shake');
          void vError.offsetWidth; // reflow to retrigger animation
          vError.classList.add('shake');
        }
        async function readJsonMessage(res){
          let msg = '';
          try {
            const j = await res.clone().json();
            if (j && typeof j.message === 'string') msg = j.message;
          } catch(_) {
            try { msg = await res.text(); } catch(_) { msg = ''; }
          }
          return msg || 'Có lỗi xảy ra.';
        }

        // ===== Create button =====
        document.getElementById('btnCreate').addEventListener('click', () => {
          document.getElementById('vModalTitle').textContent = 'Thêm voucher';
          vId.value=''; vCode.value=''; vDesc.value='';
          vPercent.value=''; vMax.value='';
          vStart.value=''; vEnd.value='';
          vLimit.value=''; vUsed.value='0';
          vActive.value='true';
          vCode.classList.remove('is-invalid');
          clearError();
          vModal.show();
        });
        vCode.addEventListener('input', ()=> { if (vCode.value.trim()) vCode.classList.remove('is-invalid'); });

        // ===== Bảng: edit/delete =====
        document.getElementById('tblVouchers').addEventListener('click', async (e)=>{
          const btn = e.target.closest('button'); if(!btn) return;
          const tr = btn.closest('tr'); const id = tr?.dataset?.id; if(!id) return;

          // Edit
          if (btn.classList.contains('btn-edit-v')) {
            try{
              const res = await fetch(routes.vGet + `?id=${encodeURIComponent(id)}`);
              if(!res.ok){ 
                showNotice('Không đọc được voucher.', 'error', 3000);
                return; 
              }
              const v = await res.json();

              document.getElementById('vModalTitle').textContent = 'Sửa voucher';
              vId.value = v.voucherId;
              vCode.value = v.code ?? '';
              vDesc.value = v.description ?? '';
              vPercent.value = v.discountPercent ?? '';
              vMax.value = v.discountMaxAmount ?? '';
              vStart.value = v.startDate ? v.startDate.substring(0,10) : '';
              vEnd.value = v.endDate ? v.endDate.substring(0,10) : '';
              vLimit.value = v.usageLimit ?? '';
              vUsed.value = v.usedCount ?? 0;
              vActive.value = (v.isActive === true) ? 'true' : 'false';
              vCode.classList.remove('is-invalid');
              clearError();
              vModal.show();
            }catch(_){
              showNotice('Không thể tải voucher để sửa.', 'error', 3000);
            }
            return;
          }

          // Delete
          if (btn.classList.contains('btn-del-v')) {
            try{
              const res = await fetch(routes.vDelete + `?id=${encodeURIComponent(id)}`, { method:'DELETE' });
              if (res.status === 204) {
                // Ẩn row ngay lập tức
                tr.style.display = 'none';
                showNotice('Xóa voucher thành công!', 'success', 2800);
                return;
              }
              const msg = await readJsonMessage(res);
              showNotice(msg || 'Không thể xóa voucher', 'error', 3000);
            }catch(_){
              showNotice('Không xoá được voucher.', 'error', 3000);
            }
            return;
          }
        });

        // ===== FILTERS: % + date + time-state (client-side) =====
        const pfMin = document.getElementById('pfMin');
        const pfMax = document.getElementById('pfMax');
        const dMin  = document.getElementById('dMin');
        const dMax  = document.getElementById('dMax');
        const timeState = document.getElementById('timeState');

        document.getElementById('btnApply').addEventListener('click', applyAllFilters);
        document.getElementById('btnClear').addEventListener('click', () => {
          pfMin.value=''; pfMax.value='';
          dMin.value=''; dMax.value='';
          timeState.value='all';
          applyAllFilters();
        });

        [pfMin,pfMax,dMin,dMax,timeState].forEach(el=>{
          el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); applyAllFilters(); }});
        });

        function parseYMD(s){
          if(!s) return null;
          const [y,m,d] = s.split('-').map(Number);
          if(!y || !m || !d) return null;
          return new Date(y, m-1, d);
        }
        function applyAllFilters(){
          const min = pfMin.value === '' ? null : Number(pfMin.value);
          const max = pfMax.value === '' ? null : Number(pfMax.value);
          if (min != null && (isNaN(min) || min<0 || min>100)) { showNotice('Phần trăm tối thiểu phải trong khoảng 0–100.', 'warn', 3000); return; }
          if (max != null && (isNaN(max) || max<0 || max>100)) { showNotice('Phần trăm tối đa phải trong khoảng 0–100.', 'warn', 3000); return; }
          if (min != null && max != null && min > max) { showNotice('Giá trị Từ phải ≤ Đến.', 'warn', 3000); return; }

          const dmin = parseYMD(dMin.value);
          const dmax = parseYMD(dMax.value);
          if (dmin && dmax && dmin.getTime() > dmax.getTime()) { showNotice('Ngày bắt đầu phải trước ngày kết thúc.', 'warn', 3000); return; }

          const want = timeState.value; // 'all' | 'upcoming' | 'started' | 'expired'

          document.querySelectorAll('#tblVouchers tbody tr').forEach(tr=>{
            const pctCell = tr.querySelectorAll('td')[2];
            const percentText = pctCell ? pctCell.textContent.trim() : '';
            const pctVal = (percentText==='—' || percentText==='') ? null : Number(percentText.replace(',', '.'));

            let show = true;
            if (min != null && (pctVal == null || pctVal < min)) show = false;
            if (max != null && (pctVal == null || pctVal > max)) show = false;

            const tstate = tr.dataset.tstate; // upcoming|started|expired
            if (want !== 'all' && tstate !== want) show = false;

            if (dmin || dmax){
              const sStr = tr.dataset.start || '';
              const eStr = tr.dataset.end || '';
              const vs = parseYMD(sStr);
              const ve = parseYMD(eStr);
              const startMs = vs ? vs.getTime() : -8640000000000000;
              const endMs   = ve ? ve.getTime() :  8640000000000000;
              const rangeStart = dmin ? dmin.getTime() : -8640000000000000;
              const rangeEnd   = dmax ? dmax.getTime() :  8640000000000000;
              if (!(startMs <= rangeEnd && endMs >= rangeStart)) show = false;
            }
            tr.style.display = show ? '' : 'none';
          });
        }

        // ===== Validate & Submit (Create/Update) =====
        document.getElementById('vForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          clearError();

          const code = vCode.value.trim();
          if (!code){ vCode.classList.add('is-invalid'); return; }

          if (vPercent.value !== '') {
            const p = Number(vPercent.value);
            if (isNaN(p) || p < 0 || p > 100) { showError('Phần trăm giảm phải trong khoảng 0–100.'); return; }
          }
          if (vStart.value && vEnd.value && vStart.value > vEnd.value) {
            showError('Ngày bắt đầu phải trước ngày kết thúc.'); return;
          }
          if (vLimit.value !== '') {
            const lim = Number(vLimit.value);
            if (isNaN(lim) || lim < 0) { showError('Giới hạn sử dụng phải ≥ 0.'); return; }
            const used = vUsed.value === '' ? 0 : Number(vUsed.value);
            if (used > lim) { showError('Đã dùng vượt quá giới hạn sử dụng.'); return; }
          }

          // Ít nhất 1 trong 2: % hoặc MaxAmount > 0
          const dp = vPercent.value ? Number(vPercent.value) : 0;
          const dm = vMax.value ? Number(vMax.value) : 0;
          if ((isNaN(dp) ? 0 : dp) <= 0 && (isNaN(dm) ? 0 : dm) <= 0) {
            showError('Cần nhập Giảm % hoặc Số tiền tối đa (> 0).');
            return;
          }

          const payload = {
            code,
            description: vDesc.value || null,
            discountPercent: vPercent.value ? Number(vPercent.value) : null,
            discountMaxAmount: vMax.value ? Number(vMax.value) : null,
            startDate: vStart.value || null,
            endDate: vEnd.value || null,
            usageLimit: vLimit.value ? Number(vLimit.value) : null,
            isActive: vActive.value === 'true'
          };

          try {
            let res;
            const isCreate = !vId.value;
            if (isCreate) {
              res = await fetch(routes.vCreate, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
              });
              if (res.status === 201 || res.status === 200) {
                const dto = await res.json();
                vModal.hide();
                addNewVoucherRow(dto);
                showNotice('Thêm voucher thành công!', 'success', 2800);
                // Reset form
                vId.value = '';
                vCode.value = '';
                vDesc.value = '';
                vPercent.value = '';
                vMax.value = '';
                vStart.value = '';
                vEnd.value = '';
                vLimit.value = '';
                vUsed.value = '0';
                vActive.value = 'true';
                vCode.classList.remove('is-invalid');
                clearError();
                return;
              }
            } else {
              res = await fetch(routes.vUpdate + `?id=${encodeURIComponent(vId.value)}`, {
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
              });
              if (res.status === 200) {
                const dto = await res.json();
                vModal.hide();
                updateVoucherRow(dto);
                showNotice('Cập nhật voucher thành công!', 'success', 2800);
                // Reset form
                vId.value = '';
                vCode.value = '';
                vDesc.value = '';
                vPercent.value = '';
                vMax.value = '';
                vStart.value = '';
                vEnd.value = '';
                vLimit.value = '';
                vUsed.value = '0';
                vActive.value = 'true';
                vCode.classList.remove('is-invalid');
                clearError();
                return;
              }
            }

            // Lỗi → phân loại 409 / 400 / khác
            const msg = await readJsonMessage(res);
            if (res.status === 409) {
              showError(msg || 'Mã voucher đã tồn tại, vui lòng nhập mã khác.');
              showNotice(msg || 'Mã voucher đã tồn tại, vui lòng nhập mã khác.', 'error', 3000);
            } else if (res.status === 400) {
              showError(msg || 'Dữ liệu không hợp lệ.');
              showNotice(msg || 'Dữ liệu không hợp lệ.', 'error', 3000);
            } else {
              showError(msg);
              showNotice(msg, 'error', 3000);
            }

          } catch (err) {
            const errorMsg = 'Không thể gửi yêu cầu. Vui lòng thử lại.';
            showError(errorMsg);
            showNotice(errorMsg, 'error', 3000);
          }
        });
    </script>
}


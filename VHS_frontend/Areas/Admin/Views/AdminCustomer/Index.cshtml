@model List<VHS_frontend.Areas.Admin.Models.Customer.CustomerDTO>
@{
    ViewData["Title"] = "Quản lý tài khoản";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    var includeDeleted = (bool)(ViewData["IncludeDeleted"] ?? false);
    var total = Model?.Count ?? 0;
    var deleted = Model?.Count(x => x.IsDeleted == true) ?? 0;
    var active = total - deleted;
}

@section Styles {
    <link rel="stylesheet" href="~/css/customer.css" asp-append-version="true" />
}
<!-- Center Notifications -->
<div id="notif-root" aria-live="polite" aria-atomic="true"></div>

<section class="cat-page container-fluid customer-ui">
    <!-- Header / Metrics -->
    <div class="cat-head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-person-badge"></i></div>
            <div>
                <h3>Tài khoản khách hàng</h3>
                <div class="sub">Tạo, Khóa/khôi phục tài khoản</div>
            </div>
        </div>
        <div class="right">
            <div class="pill"><span class="lbl">Tổng</span><span class="val">@total</span></div>
            <div class="pill good"><span class="lbl">Hoạt động</span><span class="val">@active</span></div>
            <div class="pill mute"><span class="lbl">Ngừng hoạt động</span><span class="val">@deleted</span></div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="toolbar-card card-x">
        <div class="cat-toolbar">
            <div class="actions">
                <button class="btn btn-primary soft" data-bs-toggle="modal" data-bs-target="#accModal">
                    <i class="bi bi-plus-circle"></i> Thêm tài khoản
                </button>

                <a class="btn btn-ghost soft"
                   asp-area="Admin" asp-controller="AdminCustomer" asp-action="Index"
                   asp-route-includeDeleted="@( !includeDeleted )">
                    <i class="bi @(includeDeleted ? "bi-eye-slash" : "bi-eye")"></i>
                    @(includeDeleted ? "Ẩn ngừng hoạt động" : "Hiện cả ngừng hoạt động")
                </a>
            </div>

            <div class="search">
                <i class="bi bi-search"></i>
                <input id="txtSearch" class="form-control" placeholder="Tìm theo tài khoản / Email..." />
            </div>
        </div>
    </div>

    <!-- Table Card -->
    <div class="table-card card-x">
        <div class="table-wrap">
        <table class="table table-hover align-middle mb-0" id="tblAccs">
            <thead>
                <tr>
                    <th style="width:20%">Tài khoản</th>
                    <th style="width:28%">Email</th>
                    <th style="width:20%">Ngày tạo</th>
                    <th style="width:20%">Trạng thái</th>
                    <th style="width:12%" class="text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody id="tbody">
                @foreach (var a in Model)
                {
                    var isDel = a.IsDeleted == true;
                    <tr class="cat-row @(isDel ? "open" : "")" data-id="@a.Id" data-name="@a.AccountName" data-email="@a.Email">
                        <td class="acc-cell">
                            <span class="avatar"><i class="bi bi-person"></i></span>
                            <div class="meta">
                                <div class="name ellipsis fw-semibold">@a.AccountName</div>
                            </div>
                        </td>
                        <td class="ellipsis">@a.Email</td>
                        <td>@(a.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                        <td>
                            @if (!isDel)
                            {
                                <span class="state ok"><i class="bi bi-check-lg"></i> Hoạt động</span>
                            }
                            else
                            {
                                <span class="state del"><i class="bi bi-archive"></i> Ngừng hoạt động</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group action-inline">
                                @if (isDel)
                                {
                                    <button class="btn btn-sm btn-outline-warning soft" onclick="doRestore('@a.Id')">
                                        <i class="bi bi-arrow-counterclockwise"></i><span>Khôi phục</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger soft" onclick="doDelete('@a.Id')">
                                        <i class="bi bi-lock"></i><span>Khóa</span>
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (Model == null || Model.Count == 0)
        {
            <div class="p-3 text-center text-muted">Chưa có tài khoản nào.</div>
        }
        </div>
    </div>
</section>

<!-- Modal: Create (chỉ thêm mới) -->
<div class="modal fade" id="accModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x" id="accForm" onsubmit="return false;" novalidate>
            <div class="modal-header">
                <h5 class="modal-title">Thêm tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Tài khoản</label>
                    <input type="text" id="fName" class="form-control" maxlength="64" />
                    <div class="invalid-feedback">Vui lòng nhập tài khoản.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="fEmail" class="form-control" maxlength="128" />
                    <div class="invalid-feedback">Vui lòng nhập Email hợp lệ.</div>
                </div>
                <div class="mb-1">
                    <label class="form-label">Mật khẩu</label>
                    <input type="password" id="fPass" class="form-control" minlength="6" maxlength="64" />
                    <div class="invalid-feedback">Mật khẩu phải có ít nhất 6 ký tự.</div>
                </div>
                <div class="form-text">Mật khẩu tối thiểu 6 ký tự.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary soft" id="btnSaveAcc">Lưu</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const routes = {
          create  : '@Url.Action("Create", "AdminCustomer", new { area = "Admin" })',
          del     : '@Url.Action("Delete", "AdminCustomer", new { area = "Admin" })',
          restore : '@Url.Action("Restore", "AdminCustomer", new { area = "Admin" })'
        };

        /* ======= CENTER TOAST (boxed + accent bar + fast) ======= */
        (function(){
          var toastManager = {
            currentToast: null,
            hideTimeout: null,
            removeTimeout: null,
            
            clearAll: function(){
              // Clear tất cả timeout
              if(this.hideTimeout){
                clearTimeout(this.hideTimeout);
                this.hideTimeout = null;
              }
              if(this.removeTimeout){
                clearTimeout(this.removeTimeout);
                this.removeTimeout = null;
              }
              
              // Xóa toast hiện tại
              if(this.currentToast && this.currentToast.parentNode){
                this.currentToast.classList.remove('show');
                var self = this;
                setTimeout(function(){
                  if(self.currentToast && self.currentToast.parentNode){
                    self.currentToast.remove();
                  }
                  self.currentToast = null;
                }, 100);
              }
              
              // Xóa tất cả toast còn sót trong DOM
              var root = document.getElementById('notif-root');
              if(root){
                var existingToasts = root.querySelectorAll('.center-toast');
                for(var i = 0; i < existingToasts.length; i++){
                  var toast = existingToasts[i];
                  if(toast.parentNode){
                    toast.classList.remove('show');
                    toast.remove();
                  }
                }
              }
            },
            
            show: function(msg, type, duration){
              if(!type) type = 'info';
              if(!duration) duration = 2500;
              
              // Xóa toast cũ trước
              this.clearAll();
              
              var root = document.getElementById('notif-root');
              if(!root) return;
              
              // Tạo toast mới
              var box = document.createElement('div');
              box.className = 'center-toast ' + type;
              var iconClass = type==='success'?'bi-check-circle':
                               type==='error'  ?'bi-x-circle'   :
                               type==='warn'   ?'bi-exclamation-triangle' : 'bi-info-circle';
              box.innerHTML = 
                '<div class="toast-box">' +
                  '<div class="accent"></div>' +
                  '<i class="bi ' + iconClass + '"></i>' +
                  '<span class="msg">' + msg + '</span>' +
                '</div>';
              
              root.appendChild(box);
              this.currentToast = box;
              
              var self = this;
              
              // Hiển thị với animation
              setTimeout(function(){ 
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.add('show'); 
                }
              }, 50);

              // Tự động ẩn sau duration
              this.hideTimeout = setTimeout(function() {
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.remove('show');
                  self.removeTimeout = setTimeout(function(){ 
                    if(self.currentToast && self.currentToast.parentNode){
                      self.currentToast.remove();
                    }
                    self.currentToast = null;
                    self.hideTimeout = null;
                    self.removeTimeout = null;
                  }, 350);
                }
              }, duration);
            }
          };
          
          window.showNotice = function(msg, type, duration){
            toastManager.show(msg, type, duration);
          };
        })();

        // Search
        document.getElementById('txtSearch')?.addEventListener('input', function(){
          const q = this.value.toLowerCase().trim();
          document.querySelectorAll('#tblAccs tbody tr').forEach(tr=>{
            const name  = tr.dataset.name?.toLowerCase()  ?? '';
            const email = tr.dataset.email?.toLowerCase() ?? '';
            tr.style.display = (name.includes(q) || email.includes(q)) ? '' : 'none';
          });
        });

        // Modal & Form (chỉ dùng để thêm mới)
        const accModalEl = document.getElementById('accModal');
        const accModal = new bootstrap.Modal(accModalEl);
        const accForm  = document.getElementById('accForm');
        
        // Hàm để xóa thông báo lỗi
        function clearInvalidFeedback(inputEl){
          if(inputEl){
            inputEl.classList.remove('is-invalid');
            // Bootstrap tự động ẩn invalid-feedback khi remove class is-invalid
          }
        }
        
        // Event delegation từ form để tự động xóa thông báo lỗi khi nhập
        accForm?.addEventListener('input', function(e){
          var target = e.target;
          if(target && (target.id === 'fName' || target.id === 'fEmail' || target.id === 'fPass')){
            // Xóa class is-invalid ngay khi người dùng bắt đầu nhập
            target.classList.remove('is-invalid');
          }
        }, true);
        
        accForm?.addEventListener('keyup', function(e){
          var target = e.target;
          if(target && (target.id === 'fName' || target.id === 'fEmail' || target.id === 'fPass')){
            // Xóa class is-invalid khi người dùng nhấn phím
            if(target.value.trim()){
              target.classList.remove('is-invalid');
            }
          }
        }, true);
        
        accForm?.addEventListener('paste', function(e){
          var target = e.target;
          if(target && (target.id === 'fName' || target.id === 'fEmail' || target.id === 'fPass')){
            // Xóa class is-invalid sau khi paste
            setTimeout(function(){
              if(target.value.trim()){
                target.classList.remove('is-invalid');
              }
            }, 10);
          }
        }, true);

        // Reset form khi mở modal
        document.querySelector('[data-bs-target="#accModal"]')?.addEventListener('click', function(){
          setTimeout(function(){
            const nameEl = document.getElementById('fName');
            const emailEl = document.getElementById('fEmail');
            const passEl = document.getElementById('fPass');
            if(nameEl){
              nameEl.value = '';
              clearInvalidFeedback(nameEl);
            }
            if(emailEl){
              emailEl.value = '';
              clearInvalidFeedback(emailEl);
            }
            if(passEl){
              passEl.value = '';
              clearInvalidFeedback(passEl);
            }
          }, 100);
        });

        accForm?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          
          // Lấy lại các elements
          const nameEl = document.getElementById('fName');
          const emailEl = document.getElementById('fEmail');
          const passEl = document.getElementById('fPass');
          
          if(!nameEl || !emailEl || !passEl) return;
          
          // Xóa các class invalid trước đó
          clearInvalidFeedback(nameEl);
          clearInvalidFeedback(emailEl);
          clearInvalidFeedback(passEl);
          
          const dto = {
            accountName: nameEl.value.trim(),
            email:       emailEl.value.trim(),
            password:    passEl.value ? passEl.value : null,
            role:        'User'
          };

          let hasError = false;

          // Validation Account name
          if(!dto.accountName){ 
            nameEl.classList.add('is-invalid');
            hasError = true;
          }

          // Validation Email
          if(!dto.email){ 
            emailEl.classList.add('is-invalid');
            hasError = true;
          } else {
            // Kiểm tra format email đơn giản
            var emailStr = dto.email;
            var atChar = String.fromCharCode(64);
            var atIndex = emailStr.indexOf(atChar);
            var lastDotIndex = emailStr.lastIndexOf('.');
            if(atIndex <= 0 || lastDotIndex <= atIndex || lastDotIndex === emailStr.length - 1){
              emailEl.classList.add('is-invalid');
              var emailFeedback = emailEl.parentElement?.querySelector('.invalid-feedback');
              if(emailFeedback){
                emailFeedback.textContent = 'Email không hợp lệ. Vui lòng kiểm tra lại.';
              }
              hasError = true;
            }
          }

          // Validation Password
          if(!dto.password){ 
            passEl.classList.add('is-invalid');
            hasError = true;
          } else if(dto.password.length < 6){
            passEl.classList.add('is-invalid');
            hasError = true;
          }

          if(hasError) return;

          const res = await fetch(routes.create, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(dto) });
          if(res.ok){ 
            showNotice('Đã tạo tài khoản.', 'success', 2500); 
            accModal.hide();
            
            // Thêm row mới vào bảng không cần reload
            addNewRowToTable(dto);
            
            // Reset form
            nameEl.value = ''; 
            emailEl.value = ''; 
            passEl.value = '';
            clearInvalidFeedback(nameEl);
            clearInvalidFeedback(emailEl);
            clearInvalidFeedback(passEl);
          }
          else { 
            showNotice((await res.text()) || 'Tạo thất bại.', 'error', 3000); 
          }
        });

        async function doDelete(id){
          const res = await fetch(routes.del + '?id=' + encodeURIComponent(id), { method:'DELETE' });
          if(res.ok){ 
            showNotice('Đã khóa tài khoản.', 'success', 2500);
            updateRowStatus(id, true);
          }
          else { 
            showNotice((await res.text()) || 'Khóa thất bại.', 'error', 3000); 
          }
        }
        async function doRestore(id){
          const res = await fetch(routes.restore + '?id=' + encodeURIComponent(id), { method:'POST' });
          if(res.ok){ 
            showNotice('Đã khôi phục tài khoản.', 'success', 2500);
            updateRowStatus(id, false);
          }
          else { 
            showNotice((await res.text()) || 'Khôi phục thất bại.', 'error', 3000); 
          }
        }
        
        function updateRowStatus(id, isDeleted){
          const row = document.querySelector('tr[data-id="' + id + '"]');
          if(!row) return;
          
          const statusCell = row.querySelector('td:nth-child(4)');
          const actionCell = row.querySelector('td:nth-child(5)');
          const btnGroup = actionCell.querySelector('.btn-group');
          
          if(isDeleted){
            // Đổi trạng thái thành "Ngừng hoạt động"
            statusCell.innerHTML = '<span class="state del"><i class="bi bi-archive"></i> Ngừng hoạt động</span>';
            // Đổi nút thành "Khôi phục"
            btnGroup.innerHTML = '<button class="btn btn-sm btn-outline-warning soft" onclick="doRestore(\'' + id + '\')"><i class="bi bi-arrow-counterclockwise"></i><span>Khôi phục</span></button>';
            row.classList.add('open');
            // Cập nhật số đếm: active giảm 1, deleted tăng 1
            updateCounts(-1, 1);
          } else {
            // Đổi trạng thái thành "Hoạt động"
            statusCell.innerHTML = '<span class="state ok"><i class="bi bi-check-lg"></i> Hoạt động</span>';
            // Đổi nút thành "Khóa"
            btnGroup.innerHTML = '<button class="btn btn-sm btn-outline-danger soft" onclick="doDelete(\'' + id + '\')"><i class="bi bi-lock"></i><span>Khóa</span></button>';
            row.classList.remove('open');
            // Cập nhật số đếm: active tăng 1, deleted giảm 1
            updateCounts(1, -1);
          }
        }
        
        function updateCounts(activeChange, deletedChange){
          const activePill = document.querySelector('.pill.good .val');
          const deletedPill = document.querySelector('.pill.mute .val');
          const totalPill = document.querySelector('.pill:not(.good):not(.mute) .val');
          
          if(activePill){
            const current = parseInt(activePill.textContent) || 0;
            activePill.textContent = Math.max(0, current + activeChange);
          }
          if(deletedPill){
            const current = parseInt(deletedPill.textContent) || 0;
            deletedPill.textContent = Math.max(0, current + deletedChange);
          }
          if(totalPill){
            const current = parseInt(totalPill.textContent) || 0;
            totalPill.textContent = current + activeChange + deletedChange;
          }
        }
        
        function addNewRowToTable(formData){
          const tbody = document.querySelector('#tblAccs tbody');
          if(!tbody) return;
          
          const accountName = formData.accountName || '';
          const email = formData.email || '';
          const tempId = 'temp-' + Date.now();
          
          // Format ngày hiện tại
          const now = new Date();
          const createdAt = now.toISOString().slice(0, 16).replace('T', ' ');
          
          const row = document.createElement('tr');
          row.className = 'cat-row';
          row.setAttribute('data-id', tempId);
          row.setAttribute('data-name', accountName);
          row.setAttribute('data-email', email);
          
          row.innerHTML = 
            '<td class="acc-cell">' +
              '<span class="avatar"><i class="bi bi-person"></i></span>' +
              '<div class="meta">' +
                '<div class="name ellipsis fw-semibold">' + accountName + '</div>' +
              '</div>' +
            '</td>' +
            '<td class="ellipsis">' + email + '</td>' +
            '<td>' + createdAt + '</td>' +
            '<td>' +
              '<span class="state ok"><i class="bi bi-check-lg"></i> Hoạt động</span>' +
            '</td>' +
            '<td class="text-end">' +
              '<div class="btn-group action-inline">' +
                '<button class="btn btn-sm btn-outline-danger soft" onclick="doDelete(\'' + tempId + '\')">' +
                  '<i class="bi bi-lock"></i><span>Khóa</span>' +
                '</button>' +
              '</div>' +
            '</td>';
          
          // Thêm vào đầu bảng
          tbody.insertBefore(row, tbody.firstChild);
          
          // Xóa message "Chưa có tài khoản nào" nếu có
          const emptyMsg = tbody.parentElement.querySelector('.p-3.text-center.text-muted');
          if(emptyMsg) emptyMsg.remove();
          
          // Cập nhật số đếm (thêm 1 active, tổng tăng 1)
          updateCounts(1, 0);
        }
        window.doDelete = doDelete;
        window.doRestore = doRestore;
    </script>
}

@model List<VHS_frontend.Areas.Admin.Models.Feedback.FeedbackDTO>
@{
    ViewData["Title"] = "Quản lý đánh giá";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    // Lọc chỉ các feedback đang hiển thị (không bị xóa và đang visible) để tính thống kê
    var visibleFeedbacks = Model.Where(f => !f.IsDeleted && f.IsVisible).ToList();

    // Group feedbacks theo ServiceId (group tất cả feedback để hiển thị, nhưng chỉ tính thống kê cho feedback đang hiển thị)
    var serviceGroups = Model
        .GroupBy(f => new { f.ServiceId, f.ServiceName, f.ServiceImage, f.ProviderId, f.ProviderName })
        .Select(g => {
            // Lọc feedback đang hiển thị trong group này để tính thống kê
            var visibleInGroup = g.Where(f => !f.IsDeleted && f.IsVisible).ToList();
            return new
            {
                ServiceId = g.Key.ServiceId ?? Guid.Empty,
                ServiceName = g.Key.ServiceName ?? "Không xác định",
                ServiceImage = g.Key.ServiceImage, // Lấy ServiceImage từ feedback đầu tiên
                ProviderId = g.Key.ProviderId,
                ProviderName = g.Key.ProviderName ?? "N/A",
                Feedbacks = g.ToList(), // Tất cả feedback để hiển thị (kể cả bị ẩn)
                TotalFeedbacks = visibleInGroup.Count, // Chỉ đếm feedback đang hiển thị
                AverageRating = visibleInGroup.Any() ? Math.Round(visibleInGroup.Average(f => f.Rating), 1) : 0.0, // Chỉ tính feedback đang hiển thị
                FiveStarCount = visibleInGroup.Count(f => f.Rating == 5),
                FourStarCount = visibleInGroup.Count(f => f.Rating == 4),
                ThreeStarCount = visibleInGroup.Count(f => f.Rating == 3),
                TwoStarCount = visibleInGroup.Count(f => f.Rating == 2),
                OneStarCount = visibleInGroup.Count(f => f.Rating == 1)
            };
        })
        .OrderByDescending(g => g.TotalFeedbacks)
        .ToList();

    // Tính thống kê tổng thể (chỉ tính các feedback đang hiển thị)
    var totalFeedbacks = Model.Count; // Tổng tất cả feedback (kể cả ẩn)
    var visibleCount = visibleFeedbacks.Count; // Số feedback đang hiển thị
    var deletedCount = Model.Count(f => f.IsDeleted);
    var avgRating = visibleFeedbacks.Any() ? Math.Round(visibleFeedbacks.Average(f => f.Rating), 1) : 0.0; // Chỉ tính feedback đang hiển thị
    var fiveStarCount = visibleFeedbacks.Count(f => f.Rating == 5);
    var fourStarCount = visibleFeedbacks.Count(f => f.Rating == 4);
    var threeStarCount = visibleFeedbacks.Count(f => f.Rating == 3);
    var twoStarCount = visibleFeedbacks.Count(f => f.Rating == 2);
    var oneStarCount = visibleFeedbacks.Count(f => f.Rating == 1);
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-feedback.css" asp-append-version="true" />
}

<div class="admin-feedback-container">
    <!-- Header Section -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <div class="title-content">
                        <h1>Quản lý đánh giá</h1>
                        <p>Tổng hợp đánh giá và phản hồi từ khách hàng cho tất cả dịch vụ</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-refresh" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Overall Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-star-fill"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@avgRating</span>
                <span class="stat-label">Đánh giá trung bình</span>
            </div>
            <div class="stat-decoration">
                <i class="bi bi-star-heart"></i>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-chat-dots-fill"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@totalFeedbacks</span>
                <span class="stat-label">Tổng phản hồi</span>
            </div>
            <div class="stat-decoration">
                <i class="bi bi-chat-square-heart"></i>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-eye-fill"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@visibleCount</span>
                <span class="stat-label">Đang hiển thị</span>
            </div>
            <div class="stat-decoration">
                <i class="bi bi-eye-check"></i>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-award"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@serviceGroups.Count</span>
                <span class="stat-label">Dịch vụ được đánh giá</span>
            </div>
            <div class="stat-decoration">
                <i class="bi bi-trophy"></i>
            </div>
        </div>
    </div>

    <!-- Rating Distribution -->
    <div class="rating-distribution-card mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Phân bố đánh giá</h5>
            </div>
            <div class="card-body">
                <div class="rating-distribution">
                    @for (int i = 5; i >= 1; i--)
                    {
                        var count = i switch
                        {
                            5 => fiveStarCount,
                            4 => fourStarCount,
                            3 => threeStarCount,
                            2 => twoStarCount,
                            1 => oneStarCount,
                            _ => 0
                        };
                        var percentage = totalFeedbacks > 0 ? (count * 100.0 / totalFeedbacks) : 0;

                        <div class="rating-bar">
                            <div class="rating-label">
                                <span class="rating-stars">
                                    @for (int j = 1; j <= i; j++)
                                    {
                                        <i class="bi bi-star-fill"></i>
                                    }
                                </span>
                                <span class="rating-count">@count</span>
                            </div>
                            <div class="rating-progress">
                                <div class="progress">
                                    <div class="progress-bar" style="width: @percentage%"></div>
                                </div>
                                <span class="rating-percentage">@percentage.ToString("F0")%</span>
                            </div>
                        </div>
                    }
            </div>
            </div>
        </div>
    </div>

    <!-- Service Feedback Groups -->
    <div class="service-feedbacks">
        @foreach (var serviceGroup in serviceGroups)
        {
            // Kiểm tra có feedback nào (kể cả bị ẩn) để hiển thị danh sách
            var hasFeedback = serviceGroup.Feedbacks.Any();
            var serviceIdStr = serviceGroup.ServiceId != Guid.Empty ? serviceGroup.ServiceId.ToString() : $"unknown-{serviceGroup.ServiceName.GetHashCode()}";

            <div class="service-feedback-group mb-4">
                <div class="card">
                    <div class="card-header service-header">
                            <div class="service-info">
                            <div class="service-icon">
                                @* Nếu có ServiceImage -> hiển thị ảnh, ngược lại dùng icon *@
                                @if (!string.IsNullOrEmpty(serviceGroup.ServiceImage))
                                {
                                    <img src="@serviceGroup.ServiceImage"
                                         alt="@serviceGroup.ServiceName"
                                         class="service-icon-img"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <i class="bi bi-briefcase-fill" style="display: none;"></i>
                                }
                                else
                                {
                                    <i class="bi bi-briefcase-fill"></i>
                                }
                            </div>
                            <div class="service-details">
                                <h5 class="service-name">@serviceGroup.ServiceName</h5>
                                @if (!string.IsNullOrEmpty(serviceGroup.ProviderName))
                                {
                                    <p class="service-provider"><strong>Nhà cung cấp:</strong> @serviceGroup.ProviderName</p>
                                }
                                <div class="service-rating">
                                    <div class="rating-stars">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= Math.Floor(serviceGroup.AverageRating))
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                            else if (i - 0.5 <= serviceGroup.AverageRating)
                                            {
                                                <i class="bi bi-star-half"></i>
                                        }
                                        else
                                        {
                                                <i class="bi bi-star"></i>
                                            }
                                        }
                                        <span class="rating-value">@serviceGroup.AverageRating.ToString("F1")</span>
                                    </div>
                                    <span class="rating-count">(@serviceGroup.TotalFeedbacks đánh giá)</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#service-@serviceIdStr">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                                    </div>

                    <div class="collapse" id="service-@serviceIdStr" data-has-feedback="@(hasFeedback)">
                        <div class="card-body p-0">
                            @if (!hasFeedback)
                            {
                                <div class="p-4 text-muted fst-italic">
                                    Chưa có đánh giá nào cho dịch vụ này.
                                </div>
                            }
                            else
                            {
                                <div class="feedbacks-list">
                                    @foreach (var feedback in serviceGroup.Feedbacks)
                                    {
                                        var statusCss = feedback.IsDeleted ? "deleted" : (feedback.IsVisible ? "visible" : "hidden");
                                        <div class="feedback-item @statusCss" data-status="@statusCss">
                                            <div class="feedback-content">
                                                <div class="feedback-header">
                                                    <div class="feedback-avatar" title="@feedback.CustomerName">
                                                        @{
                                                            string initials = "";
                                                            if (!string.IsNullOrEmpty(feedback.CustomerName))
                                                            {
                                                                initials = GetInitials(feedback.CustomerName);
                                                            }
                                                            else if (!string.IsNullOrEmpty(feedback.CustomerEmail))
                                                            {
                                                                // Lấy 2 chữ cái đầu từ email (phần trước @)
                                                                var emailPart = feedback.CustomerEmail.Split('@')[0];
                                                                initials = GetInitials(emailPart);
                                                            }
                                                            else
                                                            {
                                                                initials = "??";
                                                            }
                                                        }
                                                        <span class="avatar-initials">@initials</span>
                                                    </div>
                                                    <div class="customer-info-header">
                                                        <h6 class="customer-name">@feedback.CustomerName</h6>
                                                        @if (!string.IsNullOrEmpty(feedback.CustomerEmail))
                                                        {
                                                            <span class="customer-email">@feedback.CustomerEmail</span>
                                                        }
                                                    </div>
                                                    <div class="feedback-rating">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <i class="bi bi-star@(i <= feedback.Rating ? "-fill" : "") @(i <= feedback.Rating ? "filled" : "empty")"></i>
                                                        }
                                                    </div>
                                                    <div class="feedback-meta">
                                                        <span class="feedback-date">@feedback.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                                        <span class="status status-@statusCss">
                                                            @if (feedback.IsVisible)
                                                            {
                                                                <text>Đang hiển thị</text>
                                                            }
                                                            else
                                                            {
                                                                <text>Đã ẩn</text>
                                                            }
                                                        </span>
                                                    </div>
                                                </div>

                                                <div class="feedback-comment">
                                <p>@feedback.Comment</p>
                            </div>

                            @if (feedback.Images != null && feedback.Images.Any())
                            {
                                <div class="feedback-images">
                                                        <div class="image-gallery">
                                                            @foreach (var imgUrl in feedback.Images)
                                                            {
                                                                <div class="image-item" data-full="@imgUrl" onclick="openImageModal('@feedback.Id','@imgUrl')">
                                                                    <img src="@imgUrl" alt="feedback-image" class="gallery-thumbnail" loading="lazy" />
                                                                    <div class="image-overlay"><i class="bi bi-zoom-in"></i></div>
                                                </div>
                                        }
                                    </div>
                                </div>
                            }

                        <div class="feedback-actions">
                            @if (feedback.IsVisible)
                            {
                                <form asp-area="Admin" asp-controller="AdminFeedback" asp-action="Hide" method="post" style="display: inline;" class="hide-feedback-form" data-feedback-id="@feedback.Id">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@feedback.Id" />
                                    <button type="submit" class="btn-action btn-hide">
                                        <i class="bi bi-eye-slash"></i>
                                        Ẩn
                                    </button>
                                </form>
                            }
                            else
                            {
                                <form asp-area="Admin" asp-controller="AdminFeedback" asp-action="Show" method="post" style="display: inline;" class="show-feedback-form" data-feedback-id="@feedback.Id">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@feedback.Id" />
                                    <button type="submit" class="btn-action btn-show">
                                        <i class="bi bi-eye"></i>
                                        Hiện
                                    </button>
                                </form>
                            }
                        </div>
                                            </div>
                                        </div>
                                    }
                    </div>
                }
                        </div>
                    </div>
                </div>
            </div>
            }
    </div>

    @if (!serviceGroups.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <h3>Chưa có đánh giá nào</h3>
                    <p>Khách hàng chưa để lại phản hồi nào trong hệ thống.</p>
                    <div class="empty-decoration">
                        <i class="bi bi-heart"></i>
                        <i class="bi bi-star"></i>
                        <i class="bi bi-chat-square"></i>
                    </div>
                </div>
            }
        </div>

<!-- Toast Notification -->
<div id="toastNotification" class="toast-notification">
    <div class="toast-content">
        <i class="toast-icon"></i>
        <span class="toast-message"></span>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Hình ảnh feedback</h5>
                <div class="image-counter">
                    <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center position-relative">
                <button class="btn btn-outline-light btn-nav btn-prev" onclick="previousImage()" id="prevBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="image-container">
                    <img id="modalImage" src="" alt="" class="img-fluid modal-main-image">
                </div>
                <button class="btn btn-outline-light btn-nav btn-next" onclick="nextImage()" id="nextBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
    </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Đóng
                </button>
                <a id="downloadImage" href="" download class="btn btn-primary">
                    <i class="bi bi-download"></i> Tải xuống
                </a>
</div>
        </div>
    </div>
</div>

@functions {
    string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "??";
        
        var words = name.Trim().Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
        
        if (words.Length == 0)
            return "??";
        
        if (words.Length == 1)
        {
            var word = words[0].Trim();
            if (word.Length == 0)
                return "??";
            else if (word.Length == 1)
                return word.ToUpper();
            else
                return word.Substring(0, Math.Min(2, word.Length)).ToUpper();
        }
        else
        {
            var first = words[0].Trim();
            var last = words[words.Length - 1].Trim();
            
            if (string.IsNullOrEmpty(first) || string.IsNullOrEmpty(last))
                return "??";
            
            var firstChar = first[0].ToString().ToUpper();
            var lastChar = last[0].ToString().ToUpper();
            
            return firstChar + lastChar;
        }
    }

    bool IsUrl(string? v) =>
        !string.IsNullOrWhiteSpace(v) &&
        (v.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
         v.StartsWith("https://", StringComparison.OrdinalIgnoreCase));
}

@section Scripts {
    <script>
        // Toast Notification Handler
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = toast.querySelector('.toast-message');
            const toastIcon = toast.querySelector('.toast-icon');
            
            // Set message
            toastMessage.textContent = message;
            
            // Set icon based on type
            toastIcon.className = 'toast-icon';
            if (type === 'success') {
                toastIcon.classList.add('bi', 'bi-check-circle-fill');
                toast.classList.remove('toast-error', 'toast-warning');
                toast.classList.add('toast-success');
            } else if (type === 'error') {
                toastIcon.classList.add('bi', 'bi-x-circle-fill');
                toast.classList.remove('toast-success', 'toast-warning');
                toast.classList.add('toast-error');
            } else {
                toastIcon.classList.add('bi', 'bi-exclamation-triangle-fill');
                toast.classList.remove('toast-success', 'toast-error');
                toast.classList.add('toast-warning');
            }
            
            // Show toast
            toast.classList.add('show');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Handle form submission with AJAX
        document.addEventListener('DOMContentLoaded', function () {
            // Handle Hide form
            document.querySelectorAll('.hide-feedback-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const feedbackId = this.getAttribute('data-feedback-id');
                    
                    try {
                        const response = await fetch(this.action, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            showToast('Đã ẩn feedback thành công!', 'success');
                            // Reload page after 500ms to update UI
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            showToast('Có lỗi xảy ra khi ẩn feedback!', 'error');
                        }
                    } catch (error) {
                        showToast('Có lỗi xảy ra khi ẩn feedback!', 'error');
                    }
                });
            });
            
            // Handle Show form
            document.querySelectorAll('.show-feedback-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const feedbackId = this.getAttribute('data-feedback-id');
                    
                    try {
                        const response = await fetch(this.action, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            showToast('Đã hiển thị feedback thành công!', 'success');
                            // Reload page after 500ms to update UI
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            showToast('Có lỗi xảy ra khi hiển thị feedback!', 'error');
                        }
                    } catch (error) {
                        showToast('Có lỗi xảy ra khi hiển thị feedback!', 'error');
                    }
                });
            });
            
            // Tự mở nhóm đầu tiên có feedback; nếu không có thì mở nhóm đầu tiên
            const collapses = Array.from(document.querySelectorAll('.collapse'));
            let target = collapses.find(c => c.getAttribute('data-has-feedback') === 'True' || c.getAttribute('data-has-feedback') === 'true');
            if (!target && collapses.length > 0) target = collapses[0];
            if (target) {
                target.classList.add('show');

                // Đồng bộ chevron ngay khi mở ban đầu
                const btn = document.querySelector(`[data-bs-target="#${target.id}"]`);
                const chev = btn?.querySelector('i');
                if (chev && chev.classList.contains('bi-chevron-down')) {
                    chev.classList.replace('bi-chevron-down', 'bi-chevron-up');
                }
        }

            // Toggle chevron khi click
            document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const target = document.querySelector(this.getAttribute('data-bs-target'));
                    const chevron = this.querySelector('i');
                    setTimeout(() => {
                        if (target.classList.contains('show')) {
                            chevron.classList.replace('bi-chevron-down', 'bi-chevron-up');
                        } else {
                            chevron.classList.replace('bi-chevron-up', 'bi-chevron-down');
                        }
                    }, 100);
                });
            });
        });

        // ====== Image modal ======
        let currentImages = [];
        let currentImageIndex = 0;

        function openImageModal(feedbackId, imageUrl) {
            currentImages = [];
            const feedbackItem = document.querySelector(`[data-full="${imageUrl}"]`)?.closest('.feedback-item');
            const scope = feedbackItem || document;
            scope.querySelectorAll('.image-gallery .image-item').forEach(it => {
                const url = it.getAttribute('data-full');
                if (url) currentImages.push(url);
            });

            currentImageIndex = currentImages.indexOf(imageUrl);
            if (currentImageIndex < 0) currentImageIndex = 0;

            updateModalContent();
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function updateModalContent() {
            if (!currentImages.length) return;
            const modalImage = document.getElementById('modalImage');
            const downloadLink = document.getElementById('downloadImage');
            const currentIndexSpan = document.getElementById('currentImageIndex');
            const totalImagesSpan = document.getElementById('totalImages');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const url = currentImages[currentImageIndex];
            modalImage.style.opacity = '0.5';
            modalImage.onload = () => modalImage.style.opacity = '1';
            modalImage.src = url;
            modalImage.alt = 'feedback-image';
            downloadLink.href = url;

            currentIndexSpan.textContent = (currentImageIndex + 1).toString();
            totalImagesSpan.textContent = currentImages.length.toString();

            const multi = currentImages.length > 1;
            prevBtn.style.display = multi ? 'block' : 'none';
            nextBtn.style.display = multi ? 'block' : 'none';
        }

        function previousImage() {
            if (currentImages.length <= 1) return;
                currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            updateModalContent();
        }

        function nextImage() {
            if (currentImages.length <= 1) return;
                currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            updateModalContent();
        }

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            const modal = document.getElementById('imageModal');
            if (modal && modal.classList.contains('show')) {
                if (e.key === 'ArrowLeft') { e.preventDefault(); previousImage(); }
                else if (e.key === 'ArrowRight') { e.preventDefault(); nextImage(); }
                else if (e.key === 'Escape') { e.preventDefault(); bootstrap.Modal.getInstance(modal)?.hide(); }
            }
        });
    </script>
}

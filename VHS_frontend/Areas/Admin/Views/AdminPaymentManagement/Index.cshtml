@model VHS_frontend.Areas.Admin.Controllers.PaymentManagementViewModel
@{
    ViewData["Title"] = "Quản lý Thanh toán";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    var currentTab = ViewBag.Tab as string ?? "dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-service-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin-payment.css" asp-append-version="true" />
}

<div class="admin-service-management">
    <!-- Header -->
    <div class="admin-service-management__header">
        <h3><i class="bi bi-credit-card-2-front-fill"></i>Quản lý Thanh toán</h3>
        <button class="btn btn-secondary btn-sm" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
        </button>
    </div>

    <!-- Tabs -->
    <div class="card-x mb-4">
        <div class="card-body p-0">
            <ul class="nav nav-tabs admin-payment-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a href="@Url.Action("Index", new { tab = "dashboard" })" 
                       class="nav-link @(currentTab == "dashboard" ? "active" : "")">
                        <i class="bi bi-speedometer2 me-2"></i>
                        <span>Tổng quan</span>
                        @{
                            var totalNotifications = (Model.Dashboard?.PendingRefunds ?? 0) + 
                                                    (Model.PendingWithdrawals?.Count ?? 0) + 
                                                    (Model.ApprovedRefunds?.Count ?? 0) + 
                                                    (Model.ProcessedWithdrawals?.Count ?? 0);
                        }
                        @if (totalNotifications > 0)
                        {
                            <span class="badge bg-primary ms-2">@totalNotifications</span>
                        }
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="@Url.Action("Index", new { tab = "refunds" })" 
                       class="nav-link @(currentTab == "refunds" ? "active" : "")">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>
                        <span>Hoàn tiền</span>
                        @if (Model.Dashboard?.PendingRefunds > 0)
                        {
                            <span class="badge bg-warning ms-2">@Model.Dashboard.PendingRefunds</span>
                        }
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="@Url.Action("Index", new { tab = "approved-refunds" })" 
                       class="nav-link @(currentTab == "approved-refunds" ? "active" : "")">
                        <i class="bi bi-check-circle me-2"></i>
                        <span>Đã xử lý hoàn tiền</span>
                        @if (Model.ApprovedRefunds.Count > 0)
                        {
                            <span class="badge bg-success ms-2">@Model.ApprovedRefunds.Count</span>
                        }
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="@Url.Action("Index", new { tab = "withdrawals" })" 
                       class="nav-link @(currentTab == "withdrawals" ? "active" : "")">
                        <i class="bi bi-bank me-2"></i>
                        <span>Yêu cầu rút tiền</span>
                        @if (Model.PendingWithdrawals.Count > 0)
                        {
                            <span class="badge bg-warning ms-2">@Model.PendingWithdrawals.Count</span>
                        }
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="@Url.Action("Index", new { tab = "processed-withdrawals" })" 
                       class="nav-link @(currentTab == "processed-withdrawals" ? "active" : "")">
                        <i class="bi bi-clock-history me-2"></i>
                        <span>Đã xử lý</span>
                        @if (Model.ProcessedWithdrawals.Count > 0)
                        {
                            <span class="badge bg-info ms-2">@Model.ProcessedWithdrawals.Count</span>
                        }
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div>
        @if (currentTab == "dashboard")
        {
            {
                ViewBag.PendingWithdrawals = Model.PendingWithdrawals;
                ViewBag.ProcessedWithdrawals = Model.ProcessedWithdrawals;
            }
            @await Html.PartialAsync("_DashboardPartial", Model.Dashboard)
        }
        else if (currentTab == "refunds")
        {
            @await Html.PartialAsync("_RefundsPartial", Model.UnconfirmedBookings)
        }
        else if (currentTab == "approved-refunds")
        {
            @await Html.PartialAsync("_ApprovedRefundsPartial", Model.ApprovedRefunds)
        }
        else if (currentTab == "withdrawals")
        {
            @await Html.PartialAsync("_WithdrawalsPartial", Model.PendingWithdrawals)
        }
        else if (currentTab == "processed-withdrawals")
        {
            @await Html.PartialAsync("_ProcessedWithdrawalsPartial", Model.ProcessedWithdrawals)
        }
    </div>
</div>

<!-- Modal for Admin Notes -->
<div class="modal fade" id="adminNoteModal" tabindex="-1" aria-labelledby="adminNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="adminNoteInput" class="form-label">Nhập ghi chú cho việc <span id="modalActionText"></span> (tùy chọn):</label>
                <input type="text" class="form-control" id="adminNoteInput" placeholder="Nhập ghi chú...">
                <input type="hidden" id="modalContext" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="modalOkBtn">
                    <i class="bi bi-check-lg me-1"></i>OK
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x me-1"></i>Huỷ
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentModalContext = null;
        let adminNoteModal = null;
        
        // Initialize modal when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const modalElement = document.getElementById('adminNoteModal');
            if (modalElement) {
                adminNoteModal = new bootstrap.Modal(modalElement);
            }
        });

        // Toast notification function
        function showCenterToast(message, type = 'success') {
            const root = document.body;
            const existingToasts = root.querySelectorAll('.center-toast');
            existingToasts.forEach(toast => toast.remove());
            
            const box = document.createElement('div');
            box.className = 'center-toast ' + type;
            
            const iconClass = type === 'success' ? 'bi-check-circle' :
                             type === 'error' ? 'bi-x-circle' :
                             type === 'warn' ? 'bi-exclamation-triangle' : 'bi-info-circle';
            
            box.innerHTML = 
                '<div class="toast-box">' +
                    '<div class="accent"></div>' +
                    '<i class="bi ' + iconClass + '"></i>' +
                    '<span class="msg">' + message + '</span>' +
                '</div>';
            
            root.appendChild(box);
            
            // Trigger animation
            setTimeout(() => box.classList.add('show'), 10);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                box.classList.remove('show');
                setTimeout(() => box.remove(), 300);
            }, 3000);
        }

        // Approve Refund
        function approveRefund(bookingId) {
            if (!adminNoteModal) {
                const modalElement = document.getElementById('adminNoteModal');
                if (modalElement) {
                    adminNoteModal = new bootstrap.Modal(modalElement);
                } else {
                    console.error('Modal element not found');
                    return;
                }
            }
            currentModalContext = { type: 'approveRefund', bookingId: bookingId };
            const modalActionText = document.getElementById('modalActionText');
            const adminNoteInput = document.getElementById('adminNoteInput');
            const modalContext = document.getElementById('modalContext');
            
            if (modalActionText) modalActionText.textContent = 'hoàn tiền';
            if (adminNoteInput) adminNoteInput.value = '';
            if (modalContext) modalContext.value = JSON.stringify(currentModalContext);
            
            if (adminNoteModal) {
                adminNoteModal.show();
            } else {
                console.error('adminNoteModal is not initialized');
            }
        }
        
        // Make function globally accessible
        window.approveRefund = approveRefund;

        // Reject Refund
        function rejectRefund(bookingId) {
            if (!adminNoteModal) {
                const modalElement = document.getElementById('adminNoteModal');
                if (modalElement) {
                    adminNoteModal = new bootstrap.Modal(modalElement);
                } else {
                    console.error('Modal element not found');
                    return;
                }
            }
            currentModalContext = { type: 'rejectRefund', bookingId: bookingId };
            const modalActionText = document.getElementById('modalActionText');
            const adminNoteInput = document.getElementById('adminNoteInput');
            const modalContext = document.getElementById('modalContext');
            
            if (modalActionText) modalActionText.textContent = 'từ chối hoàn tiền';
            if (adminNoteInput) adminNoteInput.value = '';
            if (modalContext) modalContext.value = JSON.stringify(currentModalContext);
            
            if (adminNoteModal) {
                adminNoteModal.show();
            } else {
                console.error('adminNoteModal is not initialized');
            }
        }
        
        // Make function globally accessible
        window.rejectRefund = rejectRefund;


        // Approve/Reject Withdrawal
        function handleWithdrawal(withdrawalId, action) {
            if (!adminNoteModal) {
                const modalElement = document.getElementById('adminNoteModal');
                if (modalElement) {
                    adminNoteModal = new bootstrap.Modal(modalElement);
                } else {
                    console.error('Modal element not found');
                    return;
                }
            }
            const actionText = action === 'Approve' ? 'phê duyệt' : 'từ chối';
            currentModalContext = { type: 'handleWithdrawal', withdrawalId: withdrawalId, action: action };
            document.getElementById('modalActionText').textContent = actionText;
            document.getElementById('adminNoteInput').value = '';
            document.getElementById('modalContext').value = JSON.stringify(currentModalContext);
            adminNoteModal.show();
        }

        // Handle OK button click
        document.addEventListener('DOMContentLoaded', function() {
            const modalOkBtn = document.getElementById('modalOkBtn');
            if (modalOkBtn) {
                modalOkBtn.addEventListener('click', function() {
                    const adminNote = document.getElementById('adminNoteInput').value.trim();
                    const contextStr = document.getElementById('modalContext').value;
                    if (!contextStr) return;
                    
                    const context = JSON.parse(contextStr);
                    if (adminNoteModal) {
                        adminNoteModal.hide();
                    }

                    // Execute action based on context
                    if (context.type === 'approveRefund') {
                        executeApproveRefund(context.bookingId, adminNote);
                    } else if (context.type === 'rejectRefund') {
                        executeRejectRefund(context.bookingId, adminNote);
                    } else if (context.type === 'handleWithdrawal') {
                        executeHandleWithdrawal(context.withdrawalId, context.action, adminNote);
                    }
                });
            }
        });

        function executeApproveRefund(bookingId, adminNote) {
            // Hiển thị thông báo thành công trực tiếp
            showCenterToast('Phê duyệt hoàn tiền thành công!', 'success');
            
            fetch('@Url.Action("ApproveRefund")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ bookingId, adminNote })
            })
            .then(res => res.json().catch(() => ({}))) // Nếu parse lỗi, trả về object rỗng
            .then(data => {
                // Reload ngay lập tức, không cần check response
                location.reload();
            })
            .catch(err => {
                // Nếu có lỗi, vẫn reload vì backend có thể đã xử lý thành công
                location.reload();
            });
        }

        function executeRejectRefund(bookingId, adminNote) {
            // Hiển thị thông báo thành công trực tiếp
            showCenterToast('Từ chối hoàn tiền thành công!', 'success');
            
            fetch('@Url.Action("RejectRefund")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ bookingId, adminNote })
            })
            .then(res => res.json().catch(() => ({}))) // Nếu parse lỗi, trả về object rỗng
            .then(data => {
                // Reload ngay lập tức, không cần check response
                location.reload();
            })
            .catch(err => {
                // Nếu có lỗi, vẫn reload vì backend có thể đã xử lý thành công
                location.reload();
            });
        }


        function executeHandleWithdrawal(withdrawalId, action, adminNote) {
            fetch('@Url.Action("ApproveWithdrawal")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ withdrawalId, action, adminNote })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showCenterToast(data.message, 'success');
                    // Tăng thời gian đợi để đảm bảo database đã commit xong
                    // Sau đó reload để cập nhật badge và danh sách
                    setTimeout(() => {
                        // Giữ nguyên URL hiện tại (bao gồm query string tab nếu có)
                        const currentUrl = window.location.href;
                        // Thêm timestamp để force reload và clear cache
                        const separator = currentUrl.includes('?') ? '&' : '?';
                        window.location.href = currentUrl + separator + '_t=' + new Date().getTime();
                    }, 1000);
                } else {
                    showCenterToast('Lỗi: ' + data.message, 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showCenterToast('Đã có lỗi xảy ra', 'error');
            });
        }

        // Toggle bank info
        function toggleBankInfo(header) {
            const content = header.nextElementSibling;
            const chevron = header.querySelector('.bank-info-chevron');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                chevron.classList.remove('bi-chevron-up');
                chevron.classList.add('bi-chevron-down');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
            }
        }

        // Toggle booking card
        function toggleBookingCard(header) {
            const card = header.closest('.booking-card-collapsible');
            const content = card.querySelector('.booking-content-collapsible');
            const chevron = header.querySelector('.booking-chevron');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                chevron.classList.remove('bi-chevron-up');
                chevron.classList.add('bi-chevron-down');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
            }
        }

        // Toggle withdrawal card
        function toggleWithdrawalCard(header) {
            const card = header.closest('.withdrawal-card-collapsible');
            const content = card.querySelector('.withdrawal-content-collapsible');
            const chevron = header.querySelector('.withdrawal-chevron');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                chevron.classList.remove('bi-chevron-up');
                chevron.classList.add('bi-chevron-down');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
            }
        }
    </script>
}





@model VHS_frontend.Areas.Admin.Controllers.PaymentManagementViewModel
@{
    ViewData["Title"] = "Quản lý Thanh toán";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    var currentTab = ViewBag.Tab as string ?? "dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-payment.css" asp-append-version="true" />
}

<div class="admin-payment-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-credit-card-2-front"></i>
                    </div>
                    <div class="title-content">
                        <h1>Quản lý Thanh toán</h1>
                        <p>Quản lý hoàn tiền, phê duyệt thanh toán và rút tiền</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-refresh" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="payment-tabs">
        <a href="@Url.Action("Index", new { tab = "dashboard" })" 
           class="tab-link @(currentTab == "dashboard" ? "active" : "")">
            <i class="bi bi-speedometer2"></i>
            <span>Tổng quan</span>
            @{
                // Tính tổng số thông báo: pending refunds + pending withdrawals + approved refunds + processed withdrawals
                var totalNotifications = (Model.Dashboard?.PendingRefunds ?? 0) + 
                                        (Model.PendingWithdrawals?.Count ?? 0) + 
                                        (Model.ApprovedRefunds?.Count ?? 0) + 
                                        (Model.ProcessedWithdrawals?.Count ?? 0);
            }
            @if (totalNotifications > 0)
            {
                <span class="badge badge-primary">@totalNotifications</span>
            }
        </a>
        <a href="@Url.Action("Index", new { tab = "refunds" })" 
           class="tab-link @(currentTab == "refunds" ? "active" : "")">
            <i class="bi bi-arrow-counterclockwise"></i>
            <span>Hoàn tiền</span>
            @if (Model.Dashboard?.PendingRefunds > 0)
            {
                <span class="badge">@Model.Dashboard.PendingRefunds</span>
            }
        </a>
        <a href="@Url.Action("Index", new { tab = "approved-refunds" })" 
           class="tab-link @(currentTab == "approved-refunds" ? "active" : "")">
            <i class="bi bi-check-circle"></i>
            <span>Đã hoàn tiền</span>
            @if (Model.ApprovedRefunds.Count > 0)
            {
                <span class="badge badge-success">@Model.ApprovedRefunds.Count</span>
            }
        </a>
        <a href="@Url.Action("Index", new { tab = "withdrawals" })" 
           class="tab-link @(currentTab == "withdrawals" ? "active" : "")">
            <i class="bi bi-bank"></i>
            <span>Yêu cầu rút tiền</span>
            @if (Model.PendingWithdrawals.Count > 0)
            {
                <span class="badge">@Model.PendingWithdrawals.Count</span>
            }
        </a>
        <a href="@Url.Action("Index", new { tab = "processed-withdrawals" })" 
           class="tab-link @(currentTab == "processed-withdrawals" ? "active" : "")">
            <i class="bi bi-clock-history"></i>
            <span>Đã xử lý</span>
            @if (Model.ProcessedWithdrawals.Count > 0)
            {
                <span class="badge badge-info">@Model.ProcessedWithdrawals.Count</span>
            }
        </a>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        @if (currentTab == "dashboard")
        {
            @await Html.PartialAsync("_DashboardPartial", Model.Dashboard)
        }
        else if (currentTab == "refunds")
        {
            @await Html.PartialAsync("_RefundsPartial", Model.UnconfirmedBookings)
        }
        else if (currentTab == "approved-refunds")
        {
            @await Html.PartialAsync("_ApprovedRefundsPartial", Model.ApprovedRefunds)
        }
        else if (currentTab == "withdrawals")
        {
            @await Html.PartialAsync("_WithdrawalsPartial", Model.PendingWithdrawals)
        }
        else if (currentTab == "processed-withdrawals")
        {
            @await Html.PartialAsync("_ProcessedWithdrawalsPartial", Model.ProcessedWithdrawals)
        }
    </div>
</div>

<!-- Modal for Admin Notes -->
<div class="modal fade" id="adminNoteModal" tabindex="-1" aria-labelledby="adminNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminNoteModalLabel">@(ViewBag.SiteName ?? "localhost:7161") cho biết</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="adminNoteInput" class="form-label">Nhập ghi chú cho việc <span id="modalActionText"></span> (tùy chọn):</label>
                <input type="text" class="form-control" id="adminNoteInput" placeholder="Nhập ghi chú...">
                <input type="hidden" id="modalContext" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="modalOkBtn">OK</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentModalContext = null;
        const adminNoteModal = new bootstrap.Modal(document.getElementById('adminNoteModal'));

        // Approve Refund
        function approveRefund(bookingId) {
            currentModalContext = { type: 'approveRefund', bookingId: bookingId };
            document.getElementById('modalActionText').textContent = 'hoàn tiền';
            document.getElementById('adminNoteInput').value = '';
            document.getElementById('modalContext').value = JSON.stringify(currentModalContext);
            adminNoteModal.show();
        }

        // Reject Refund
        function rejectRefund(bookingId) {
            currentModalContext = { type: 'rejectRefund', bookingId: bookingId };
            document.getElementById('modalActionText').textContent = 'từ chối hoàn tiền';
            document.getElementById('adminNoteInput').value = '';
            document.getElementById('modalContext').value = JSON.stringify(currentModalContext);
            adminNoteModal.show();
        }


        // Approve/Reject Withdrawal
        function handleWithdrawal(withdrawalId, action) {
            const actionText = action === 'Approve' ? 'phê duyệt' : 'từ chối';
            currentModalContext = { type: 'handleWithdrawal', withdrawalId: withdrawalId, action: action };
            document.getElementById('modalActionText').textContent = actionText;
            document.getElementById('adminNoteInput').value = '';
            document.getElementById('modalContext').value = JSON.stringify(currentModalContext);
            adminNoteModal.show();
        }

        // Handle OK button click
        document.getElementById('modalOkBtn').addEventListener('click', function() {
            const adminNote = document.getElementById('adminNoteInput').value.trim();
            const contextStr = document.getElementById('modalContext').value;
            if (!contextStr) return;
            
            const context = JSON.parse(contextStr);
            adminNoteModal.hide();

            // Execute action based on context
            if (context.type === 'approveRefund') {
                executeApproveRefund(context.bookingId, adminNote);
            } else if (context.type === 'rejectRefund') {
                executeRejectRefund(context.bookingId, adminNote);
            } else if (context.type === 'handleWithdrawal') {
                executeHandleWithdrawal(context.withdrawalId, context.action, adminNote);
            }
        });

        function executeApproveRefund(bookingId, adminNote) {
            fetch('@Url.Action("ApproveRefund")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ bookingId, adminNote })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Từ chối hoàn tiền thành công!');
                    location.reload();
                } else {
                    alert('Lỗi: ' + (data.message || 'Có lỗi xảy ra'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Có lỗi xảy ra khi xử lý yêu cầu');
            });
        }

        function executeRejectRefund(bookingId, adminNote) {
            fetch('@Url.Action("RejectRefund")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ bookingId, adminNote })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Hoàn tiền thành công!');
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Đã có lỗi xảy ra');
            });
        }


        function executeHandleWithdrawal(withdrawalId, action, adminNote) {
            fetch('@Url.Action("ApproveWithdrawal")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ withdrawalId, action, adminNote })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Đã có lỗi xảy ra');
            });
        }
    </script>
}





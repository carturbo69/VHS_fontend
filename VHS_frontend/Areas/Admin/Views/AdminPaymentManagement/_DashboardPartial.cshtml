@model VHS_frontend.Areas.Admin.Models.Payment.PaymentDashboardDTO

@if (Model != null)
{
    <div>
        <!-- Primary Stats Cards - 2 hàng chính -->
        <div class="row g-3 mb-4">
            <!-- Row 1: 2 cards lớn -->
            <div class="col-lg-6">
                <div class="card-x stat-card payment-stat-primary">
                    <div class="stat-card__icon payment-stat-icon-large" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </div>
                    <div class="stat-card__content payment-stat-content">
                        <div class="payment-stat-value">@Model.PendingRefunds</div>
                        <div class="payment-stat-label">Hoàn tiền chờ xử lý</div>
                        <div class="payment-stat-amount">@Model.TotalRefundAmount.ToString("N0") VNĐ</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card-x stat-card payment-stat-primary">
                    <div class="stat-card__icon payment-stat-icon-large" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                        <i class="bi bi-safe"></i>
                    </div>
                    <div class="stat-card__content payment-stat-content">
                        <div class="payment-stat-value">
                            @(Model.SystemEscrowBalance >= 1000000000 
                                ? (Model.SystemEscrowBalance / 1000000000).ToString("N2") + " Tỷ" 
                                : Model.SystemEscrowBalance >= 1000000 
                                    ? (Model.SystemEscrowBalance / 1000000).ToString("N2") + " Triệu" 
                                    : (Model.SystemEscrowBalance / 1000).ToString("N1") + " Nghìn")
                        </div>
                        <div class="payment-stat-label">Số dư ký quỹ</div>
                        <div class="payment-stat-amount">@Model.SystemEscrowBalance.ToString("N0") VNĐ</div>
                    </div>
                </div>
            </div>
        </div>

        @{
            var pendingWithdrawals = ViewBag.PendingWithdrawals as List<VHS_frontend.Areas.Admin.Models.Payment.ProviderWithdrawalDTO> ?? new List<VHS_frontend.Areas.Admin.Models.Payment.ProviderWithdrawalDTO>();
            var processedWithdrawals = ViewBag.ProcessedWithdrawals as List<VHS_frontend.Areas.Admin.Models.Payment.ProviderWithdrawalDTO> ?? new List<VHS_frontend.Areas.Admin.Models.Payment.ProviderWithdrawalDTO>();
            var totalPendingWithdrawalAmount = pendingWithdrawals.Sum(w => w.Amount);
            var totalProcessedWithdrawalAmount = processedWithdrawals.Sum(w => w.Amount);
        }

        @if (Model.Statistics != null)
        {
            <!-- Secondary Stats Cards - 4 cards nhỏ -->
            <div class="row g-3 mb-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card-x stat-card payment-stat-secondary">
                        <div class="stat-card__icon" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);">
                            <i class="bi bi-calendar-month"></i>
                        </div>
                        <div class="stat-card__content">
                            <div class="payment-stat-value-small">
                                @(Model.Statistics.TotalRefundsThisMonth >= 1000000000 
                                    ? (Model.Statistics.TotalRefundsThisMonth / 1000000000).ToString("N2") + " Tỷ" 
                                    : Model.Statistics.TotalRefundsThisMonth >= 1000000 
                                        ? (Model.Statistics.TotalRefundsThisMonth / 1000000).ToString("N2") + " Triệu" 
                                        : Model.Statistics.TotalRefundsThisMonth >= 1000 
                                            ? (Model.Statistics.TotalRefundsThisMonth / 1000).ToString("N1") + " Nghìn" 
                                            : Model.Statistics.TotalRefundsThisMonth.ToString("N0") + " VNĐ")
                            </div>
                            <div class="payment-stat-label-small">Hoàn tiền tháng này</div>
                            <div class="payment-stat-sub">TB: @Model.Statistics.AverageRefundAmount.ToString("N0") VNĐ</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="card-x stat-card payment-stat-secondary">
                        <div class="stat-card__icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                            <i class="bi bi-calendar-month"></i>
                        </div>
                        <div class="stat-card__content">
                            <div class="payment-stat-value-small">
                                @(Model.Statistics.TotalPayoutsThisMonth >= 1000000000 
                                    ? (Model.Statistics.TotalPayoutsThisMonth / 1000000000).ToString("N2") + " Tỷ" 
                                    : Model.Statistics.TotalPayoutsThisMonth >= 1000000 
                                        ? (Model.Statistics.TotalPayoutsThisMonth / 1000000).ToString("N2") + " Triệu" 
                                        : Model.Statistics.TotalPayoutsThisMonth >= 1000 
                                            ? (Model.Statistics.TotalPayoutsThisMonth / 1000).ToString("N1") + " Nghìn" 
                                            : Model.Statistics.TotalPayoutsThisMonth.ToString("N0") + " VNĐ")
                            </div>
                            <div class="payment-stat-label-small">Thanh toán tháng này</div>
                            <div class="payment-stat-sub">TB: @Model.Statistics.AveragePayoutAmount.ToString("N0") VNĐ</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="card-x stat-card payment-stat-secondary">
                        <div class="stat-card__icon" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-card__content">
                            <div class="payment-stat-value-small">@Model.Statistics.RefundsProcessedToday</div>
                            <div class="payment-stat-label-small">Hoàn tiền hôm nay</div>
                            <div class="payment-stat-sub">Đã xử lý</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-3">
                    <div class="card-x stat-card payment-stat-secondary">
                        <div class="stat-card__icon" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-card__content">
                            <div class="payment-stat-value-small">@Model.Statistics.PayoutsProcessedToday</div>
                            <div class="payment-stat-label-small">Thanh toán hôm nay</div>
                            <div class="payment-stat-sub">Đã xử lý</div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Nếu không có Statistics, chỉ hiển thị 2 cards chính -->
        }

        @if (Model.RecentTransactions != null && Model.RecentTransactions.Any())
        {
            <div class="card-x">
                <div class="card-header">
                    <span><i class="bi bi-clock-history me-2"></i>Giao dịch gần đây</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive @(Model.RecentTransactions.Count > 10 ? "table-scrollable" : "")" style="@(Model.RecentTransactions.Count > 10 ? "max-height: 550px; overflow-y: auto;" : "")">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="position: sticky; top: 0; background: var(--card-bg, #fff); z-index: 10;">
                                <tr>
                                    <th><i class="bi bi-hash me-2"></i>ID</th>
                                    <th><i class="bi bi-tag me-2"></i>Loại</th>
                                    <th><i class="bi bi-currency-exchange me-2"></i>Số tiền</th>
                                    <th><i class="bi bi-info-circle me-2"></i>Trạng thái</th>
                                    <th><i class="bi bi-calendar me-2"></i>Thời gian</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in Model.RecentTransactions)
                                {
                                    <tr>
                                        <td><code>#@transaction.TransactionId.ToString().Substring(0, 8)</code></td>
                                        <td>
                                            @{
                                                var typeText = transaction.Type == "Refund" ? "Hoàn tiền" :
                                                               transaction.Type == "Payout" ? "Thanh toán" :
                                                               transaction.Type;
                                                var typeClass = transaction.Type == "Refund" ? "bg-warning" : "bg-info";
                                            }
                                            <span class="badge @typeClass">@typeText</span>
                                        </td>
                                        <td><strong class="text-success">@transaction.Amount.ToString("N0") VNĐ</strong></td>
                                        <td>
                                            @{
                                                var statusText = transaction.Status == "Pending" ? "Chờ xử lý" :
                                                                  transaction.Status == "Completed" ? "Đã hoàn thành" :
                                                                  transaction.Status == "Failed" ? "Thất bại" :
                                                                  transaction.Status == "Processing" ? "Đang xử lý" :
                                                                  transaction.Status;
                                                var statusClass = transaction.Status == "Pending" ? "status-pending" :
                                                                   transaction.Status == "Completed" ? "status-completed" :
                                                                   transaction.Status == "Failed" ? "status-canceled" :
                                                                   transaction.Status == "Processing" ? "status-processing" :
                                                                   "";
                                            }
                                            <span class="status-badge @statusClass">@statusText</span>
                                        </td>
                                        <td><small>@transaction.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Withdrawals Summary Cards -->
        @if (pendingWithdrawals.Any() || processedWithdrawals.Any())
        {
            <div class="row g-3 mb-4 mt-4">
                <div class="col-lg-6">
                    <div class="card-x stat-card payment-stat-primary">
                        <div class="stat-card__icon payment-stat-icon-large" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                            <i class="bi bi-bank"></i>
                        </div>
                        <div class="stat-card__content payment-stat-content">
                            <div class="payment-stat-value">@pendingWithdrawals.Count</div>
                            <div class="payment-stat-label">Yêu cầu rút tiền chờ xử lý</div>
                            <div class="payment-stat-amount">@totalPendingWithdrawalAmount.ToString("N0") VNĐ</div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card-x stat-card payment-stat-primary">
                        <div class="stat-card__icon payment-stat-icon-large" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-card__content payment-stat-content">
                            <div class="payment-stat-value">@processedWithdrawals.Count</div>
                            <div class="payment-stat-label">Đã xử lý rút tiền</div>
                            <div class="payment-stat-amount">@totalProcessedWithdrawalAmount.ToString("N0") VNĐ</div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Withdrawals Quick View -->
        @if (pendingWithdrawals.Any() || processedWithdrawals.Any())
        {
            <div class="card-x mt-4">
                <div class="card-header">
                    <span><i class="bi bi-bank me-2"></i>Yêu cầu rút tiền</span>
                    <div class="ms-auto">
                        @if (pendingWithdrawals.Any())
                        {
                            <a href="@Url.Action("Index", new { tab = "withdrawals" })" class="btn btn-sm btn-warning">
                                <i class="bi bi-clock me-1"></i>
                                @pendingWithdrawals.Count chờ xử lý
                            </a>
                        }
                        @if (processedWithdrawals.Any())
                        {
                            <a href="@Url.Action("Index", new { tab = "processed-withdrawals" })" class="btn btn-sm btn-info ms-2">
                                <i class="bi bi-check-circle me-1"></i>
                                @processedWithdrawals.Count đã xử lý
                            </a>
                        }
                    </div>
                </div>
                <div class="card-body p-0">
                    @{
                        var totalWithdrawals = pendingWithdrawals.Count + processedWithdrawals.Count;
                    }
                    <div class="table-responsive @(totalWithdrawals > 10 ? "table-scrollable" : "")" style="@(totalWithdrawals > 10 ? "max-height: 550px; overflow-y: auto;" : "")">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="position: sticky; top: 0; background: var(--card-bg, #fff); z-index: 10;">
                                <tr>
                                    <th><i class="bi bi-hash me-2"></i>Mã yêu cầu</th>
                                    <th><i class="bi bi-building me-2"></i>Nhà cung cấp</th>
                                    <th><i class="bi bi-currency-exchange me-2"></i>Số tiền</th>
                                    <th><i class="bi bi-info-circle me-2"></i>Trạng thái</th>
                                    <th><i class="bi bi-calendar me-2"></i>Thời gian</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var withdrawal in pendingWithdrawals)
                                {
                                    <tr>
                                        <td><code>#@withdrawal.WithdrawalId.ToString().Substring(0, 8)</code></td>
                                        <td>@withdrawal.ProviderName</td>
                                        <td><strong class="text-warning">@withdrawal.Amount.ToString("N0") VNĐ</strong></td>
                                        <td><span class="status-badge status-pending">Chờ phê duyệt</span></td>
                                        <td><small>@withdrawal.RequestDate.ToString("dd/MM/yyyy HH:mm")</small></td>
                                    </tr>
                                }
                                @foreach (var withdrawal in processedWithdrawals)
                                {
                                    <tr>
                                        <td><code>#@withdrawal.WithdrawalId.ToString().Substring(0, 8)</code></td>
                                        <td>@withdrawal.ProviderName</td>
                                        <td><strong class="text-success">@withdrawal.Amount.ToString("N0") VNĐ</strong></td>
                                        <td>
                                            @{
                                                var statusText = withdrawal.Status == "Completed" ? "Đã phê duyệt" : 
                                                                 withdrawal.Status == "Rejected" ? "Đã từ chối" : 
                                                                 withdrawal.Status;
                                                var statusClass = withdrawal.Status == "Completed" ? "status-completed" : 
                                                                   withdrawal.Status == "Rejected" ? "status-canceled" : 
                                                                   "status-pending";
                                            }
                                            <span class="status-badge @statusClass">@statusText</span>
                                        </td>
                                        <td><small>@(withdrawal.ProcessedDate?.ToString("dd/MM/yyyy HH:mm") ?? withdrawal.RequestDate.ToString("dd/MM/yyyy HH:mm"))</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="card-x">
        <div class="card-body text-center text-muted py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
            <h3 class="mt-3 mb-0">Không có dữ liệu</h3>
            <p class="mt-2 mb-0">Không thể tải thông tin dashboard.</p>
        </div>
    </div>
}






@using VHS_frontend.Areas.Admin.Models.Notification
@model List<AdminNotificationItemDTO>

@{
    ViewData["Title"] = "Qu·∫£n l√Ω Th√¥ng b√°o";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    var total = (int)(ViewBag.Total ?? Model.Count);
    var unread = (int)(ViewBag.Unread ?? Model.Count(x => x.IsRead != true));
    var read = (int)(ViewBag.Read ?? Model.Count(x => x.IsRead == true));
    var keyword = (string)(ViewBag.Keyword ?? "");
    var role = (string)(ViewBag.Role ?? "");
    var notificationType = (string)(ViewBag.NotificationType ?? "");
    var isRead = (bool?)ViewBag.IsRead;
    
    // T√°ch th√¥ng b√°o theo nh·∫≠n/g·ª≠i
    var inboxNotifications = Model.Where(n => n.ReceiverRole == "Admin").ToList();
    var sentNotifications = Model.Where(n => n.ReceiverRole == "User" || n.ReceiverRole == "Provider").ToList();
    
    var inboxTotal = inboxNotifications.Count;
    var sentTotal = sentNotifications.Count;
    var inboxUnread = inboxNotifications.Count(n => n.IsRead != true);
    var sentUnread = sentNotifications.Count(n => n.IsRead != true);

    // Helper function to convert role to Vietnamese
    string GetRoleInVietnamese(string role)
    {
        return role switch
        {
            "User" => "Ng∆∞·ªùi d√πng",
            "Provider" => "Nh√† cung c·∫•p",
            "Admin" => "Qu·∫£n tr·ªã vi√™n",
            _ => role
        };
    }

    // Helper function to convert notification type to Vietnamese
    string GetNotificationTypeInVietnamese(string type)
    {
        return type switch
        {
            "System" => "H·ªá th·ªëng",
            "Booking" => "ƒê·∫∑t l·ªãch",
            "Payment" => "Thanh to√°n",
            "Promotion" => "Khuy·∫øn m√£i",
            _ => type
        };
    }

    // Helper function to convert DateTime to Vietnam timezone (UTC+7)
    // Note: Database ƒë√£ l∆∞u theo gi·ªù Vi·ªát Nam (Unspecified), n√™n kh√¥ng c·∫ßn convert n·ªØa
    DateTime? ToVietnamTime(DateTime? dateTime)
    {
        if (dateTime == null) return null;
        
        try
        {
            // Database ƒë√£ l∆∞u theo gi·ªù Vi·ªát Nam (Unspecified kind)
            // N·∫øu l√† Unspecified ho·∫∑c Local -> ƒë√£ l√† gi·ªù Vi·ªát Nam r·ªìi, kh√¥ng c·∫ßn convert
            if (dateTime.Value.Kind == DateTimeKind.Unspecified || dateTime.Value.Kind == DateTimeKind.Local)
            {
                return dateTime.Value;
            }
            
            // Ch·ªâ convert n·∫øu th·ª±c s·ª± l√† UTC
            if (dateTime.Value.Kind == DateTimeKind.Utc)
            {
                TimeZoneInfo vietnamTimeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
                return TimeZoneInfo.ConvertTimeFromUtc(dateTime.Value, vietnamTimeZone);
            }
            
            return dateTime.Value;
        }
        catch
        {
            // Fallback: n·∫øu l√† UTC th√¨ c·ªông 7 gi·ªù, c√≤n l·∫°i gi·ªØ nguy√™n
            if (dateTime.Value.Kind == DateTimeKind.Utc)
            {
                return dateTime.Value.AddHours(7);
            }
            return dateTime.Value;
        }
    }

    // Helper function to format DateTime to Vietnamese format
    string FormatVietnamTime(DateTime? dateTime)
    {
        var vietnamTime = ToVietnamTime(dateTime);
        return vietnamTime?.ToString("dd/MM/yyyy HH:mm") ?? "N/A";
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-notification.css" asp-append-version="true" />
}

<section class="v-page container-fluid">
    <!-- Header / Metrics -->
    <div class="v-head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-bell"></i></div>
            <div>
                <h3>Th√¥ng b√°o</h3>
                <div class="sub">Qu·∫£n l√Ω th√¥ng b√°o h·ªá th·ªëng</div>
            </div>
        </div>
        <div class="right">
            <div class="pill pill-total">
                <span class="lbl">T·ªïng</span>
                <span class="val">@total</span>
            </div>
            <div class="pill pill-inbox" onclick="switchToTab('inbox')" title="Click ƒë·ªÉ xem th√¥ng b√°o nh·∫≠n ƒë∆∞·ª£c">
                <span class="lbl">Nh·∫≠n ƒë∆∞·ª£c</span>
                <span class="val">@inboxTotal</span>
                @if (inboxUnread > 0)
                {
                    <span class="badge-notify">@inboxUnread ch∆∞a ƒë·ªçc</span>
                }
            </div>
            <div class="pill pill-sent" onclick="switchToTab('sent')" title="Click ƒë·ªÉ xem th√¥ng b√°o ƒë√£ g·ª≠i">
                <span class="lbl">ƒê√£ g·ª≠i</span>
                <span class="val">@sentTotal</span>
            </div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="toolbar-card card-x">
    <div class="v-toolbar">
        <div class="row g-3">
            <!-- Actions & Search -->
            <div class="col-md-5">
                    <div class="search-card">
                    <!-- Actions Section -->
                    <div class="actions-section">
                        <div class="section-header">
                            <h6 class="mb-0"><i class="bi bi-tools me-2"></i>Thao t√°c</h6>
                        </div>
                        <div class="actions-grid">
                            <button class="btn btn-primary soft action-btn" id="btnCreateNotification">
                                <i class="bi bi-plus-circle"></i> T·∫°o th√¥ng b√°o
                            </button>
                            <button class="btn btn-success soft action-btn" id="btnSendToRole">
                                <i class="bi bi-broadcast"></i> G·ª≠i h√†ng lo·∫°t
                            </button>
                        </div>
                    </div>
                    
                    <!-- Divider -->
                    <div class="section-divider"></div>
                    
                    <!-- Search Section -->
                    <div class="search-section">
                        <div class="section-header">
                            <h6 class="mb-0"><i class="bi bi-search me-2"></i>T√¨m ki·∫øm</h6>
                        </div>
                        <div class="search-form">
                            <div class="input-group">
                                <input name="keyword" value="@keyword" class="form-control" placeholder="T√¨m theo n·ªôi dung th√¥ng b√°o‚Ä¶" id="keywordInput" />
                                <button class="btn btn-outline-secondary" type="button" onclick="applyFilter()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="col-md-7">
                <div class="filter-card card-x">
                    <div class="filter-header">
                        <h6 class="mb-3"><i class="bi bi-funnel me-2"></i>B·ªô l·ªçc n√¢ng cao</h6>
                        <div class="row g-3" id="filterRow">
                            <div class="col-md-4 filter-sent-only" id="roleFilterContainer" style="display: none;">
                                <div class="fb-label"><i class="bi bi-people me-1"></i>Vai tr√≤</div>
                                <select id="roleFilter" class="form-select">
                                    <option value="" selected="@(string.IsNullOrEmpty(role))">T·∫•t c·∫£ vai tr√≤</option>
                                    <option value="User" selected="@(role == "User")">üë§ Kh√°ch h√†ng</option>
                                    <option value="Provider" selected="@(role == "Provider")">üè¢ Nh√† cung c·∫•p</option>
                                </select>
                            </div>
                            <div class="col-md-4 filter-sent-only" id="typeFilterContainer" style="display: none;">
                                <div class="fb-label"><i class="bi bi-tag me-1"></i>Lo·∫°i th√¥ng b√°o</div>
                                <select id="typeFilter" class="form-select">
                                    <option value="" selected="@(string.IsNullOrEmpty(notificationType))">T·∫•t c·∫£ lo·∫°i</option>
                                    <option value="System" selected="@(notificationType == "System")">‚öôÔ∏è H·ªá th·ªëng</option>
                                    <option value="Booking" selected="@(notificationType == "Booking")">üìÖ ƒê·∫∑t l·ªãch</option>
                                    <option value="Payment" selected="@(notificationType == "Payment")">üí≥ Thanh to√°n</option>
                                    <option value="Promotion" selected="@(notificationType == "Promotion")">üéÅ Khuy·∫øn m√£i</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="statusFilterContainer">
                                <div class="fb-label"><i class="bi bi-eye me-1"></i>Tr·∫°ng th√°i</div>
                                <select id="readStatusFilter" class="form-select">
                                    <option value="" selected="@(!isRead.HasValue)">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="false" selected="@(isRead == false)">üî¥ Ch∆∞a ƒë·ªçc</option>
                                    <option value="true" selected="@(isRead == true)">üü¢ ƒê√£ ƒë·ªçc</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <div class="filter-actions">
                                    <button class="btn btn-primary soft" id="btnApplyFilter" type="button">
                                        <i class="bi bi-funnel-fill"></i> √Åp d·ª•ng b·ªô l·ªçc
                                    </button>
                                    <button class="btn btn-ghost soft" id="btnClearFilter" type="button">
                                        <i class="bi bi-arrow-clockwise"></i> X√≥a b·ªô l·ªçc
                                    </button>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Responsive cho filter khi hi·ªÉn th·ªã/·∫©n */
        .filter-sent-only {
            transition: all 0.3s ease;
        }
        
        /* Khi tab sent active, hi·ªÉn th·ªã filters */
        #sent-tab.active ~ * .filter-sent-only,
        .tab-pane#sent.active ~ * .filter-sent-only {
            display: block !important;
        }
    </style>

    <!-- Tabs Navigation -->
    <div class="notification-tabs mb-3">
        <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button" role="tab" aria-controls="inbox" aria-selected="false">
                    <i class="bi bi-inbox-fill me-2"></i>Th√¥ng b√°o nh·∫≠n ƒë∆∞·ª£c
                    <span class="badge bg-primary ms-2">@Model.Count(n => n.ReceiverRole == "Admin")</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab" aria-controls="sent" aria-selected="false">
                    <i class="bi bi-send-fill me-2"></i>Th√¥ng b√°o ƒë√£ g·ª≠i
                    <span class="badge badge-sent-count ms-2">@sentTotal</span>
                </button>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="notificationTabsContent">
        <!-- Inbox Tab -->
        <div class="tab-pane fade" id="inbox" role="tabpanel" aria-labelledby="inbox-tab">
            <div class="table-card card-x">
                <div class="table-wrap">
                <div class="table-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-inbox me-2"></i>Th√¥ng b√°o t·ª´ Kh√°ch h√†ng & Nh√† cung c·∫•p</h6>
                        <div class="table-info">
                            <span class="text-muted small">Hi·ªÉn th·ªã @inboxNotifications.Count th√¥ng b√°o</span>
                        </div>
                    </div>
                </div>
                <div class="table-scroll">
                    <table class="table table-hover align-middle mb-0" id="tblInboxNotifications">
                        <thead>
                            <tr>
                                <th class="w-type"><i class="bi bi-tag me-1"></i>Lo·∫°i</th>
                                <th><i class="bi bi-chat-text me-1"></i>N·ªôi dung</th>
                                <th class="w-time"><i class="bi bi-clock me-1"></i>Th·ªùi gian</th>
                                <th class="w-state"><i class="bi bi-eye me-1"></i>Tr·∫°ng th√°i</th>
                                <th class="text-end w-actions"><i class="bi bi-gear me-1"></i>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (inboxNotifications.Any())
                            {
                                @foreach (var notification in inboxNotifications)
                                {
                                    <tr data-id="@notification.NotificationId" class="notification-row" style="cursor: pointer;">
                                        <td>
                                            <span class="type-badge badge bg-info">@GetNotificationTypeInVietnamese(notification.NotificationType)</span>
                                        </td>
                                        <td class="content-text" title="@notification.Content">@notification.Content</td>
                                        <td class="time-cell">
                                            <div class="date-line">@FormatVietnamTime(notification.CreatedAt)</div>
                                        </td>
                                        <td>
                                            @if (notification.IsRead != true)
                                            {
                                                <span class="state warn">Ch∆∞a ƒë·ªçc</span>
                                            }
                                            else
                                            {
                                                <span class="state ok">ƒê√£ ƒë·ªçc</span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group">
                                                @if (notification.IsRead != true)
                                                {
                                                    <button class="btn btn-sm btn-mark-read" data-id="@notification.NotificationId" type="button">
                                                        <i class="bi bi-check-circle"></i> ƒê·ªçc
                                                    </button>
                                                }
                                                <button class="btn btn-sm btn-delete" data-id="@notification.NotificationId" type="button">
                                                    <i class="bi bi-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                                            <div class="fs-5 fw-semibold mb-2">Ch∆∞a c√≥ th√¥ng b√°o n√†o</div>
                                            <div class="text-muted">B·∫°n ch∆∞a nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o n√†o t·ª´ Kh√°ch h√†ng ho·∫∑c Nh√† cung c·∫•p.</div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>

        <!-- Sent Tab -->
        <div class="tab-pane fade" id="sent" role="tabpanel" aria-labelledby="sent-tab">
            <div class="table-card card-x">
                <div class="table-wrap">
                <div class="table-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-send me-2"></i>Th√¥ng b√°o ƒë√£ g·ª≠i cho Kh√°ch h√†ng & Nh√† cung c·∫•p</h6>
                        <div class="table-info">
                            <span class="text-muted small">Hi·ªÉn th·ªã @sentNotifications.Count th√¥ng b√°o</span>
                        </div>
                    </div>
                </div>
                <div class="table-scroll">
                    <table class="table table-hover align-middle mb-0" id="tblSentNotifications">
                        <thead>
                            <tr>
                                <th class="w-receiver"><i class="bi bi-person me-1"></i>Ng∆∞·ªùi nh·∫≠n</th>
                                <th class="w-role"><i class="bi bi-people me-1"></i>Vai tr√≤</th>
                                <th class="w-type"><i class="bi bi-tag me-1"></i>Lo·∫°i</th>
                                <th><i class="bi bi-chat-text me-1"></i>N·ªôi dung</th>
                                <th class="w-time"><i class="bi bi-clock me-1"></i>Th·ªùi gian</th>
                                <th class="w-state"><i class="bi bi-eye me-1"></i>Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (sentNotifications.Any())
                            {
                                @foreach (var notification in sentNotifications)
                                {
                                    <tr data-id="@notification.NotificationId" class="notification-row notification-row-sent">
                                        <td class="fw-semibold">@(notification.ReceiverName ?? notification.ReceiverEmail ?? "N/A")</td>
                                        <td>
                                            <span class="role-badge badge bg-secondary">@GetRoleInVietnamese(notification.ReceiverRole)</span>
                                        </td>
                                        <td>
                                            <span class="type-badge badge bg-info">@GetNotificationTypeInVietnamese(notification.NotificationType)</span>
                                        </td>
                                        <td class="content-text" title="@notification.Content">@notification.Content</td>
                                        <td class="time-cell">
                                            <div class="date-line">@FormatVietnamTime(notification.CreatedAt)</div>
                                        </td>
                                        <td>
                                            @if (notification.IsRead != true)
                                            {
                                                <span class="state warn">Ch∆∞a ƒë·ªçc</span>
                                            }
                                            else
                                            {
                                                <span class="state ok">ƒê√£ ƒë·ªçc</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="bi bi-send-slash fs-1 text-muted mb-3"></i>
                                            <div class="fs-5 fw-semibold mb-2">Ch∆∞a g·ª≠i th√¥ng b√°o n√†o</div>
                                            <div class="text-muted mb-4">B·∫°n ch∆∞a g·ª≠i th√¥ng b√°o n√†o cho Kh√°ch h√†ng ho·∫∑c Nh√† cung c·∫•p.</div>
                                            <div class="empty-actions">
                                                <button class="btn btn-primary soft" id="btnCreateNotificationEmpty">
                                                    <i class="bi bi-plus-circle"></i> T·∫°o th√¥ng b√°o ƒë·∫ßu ti√™n
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal: Create Notification -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <form class="modal-content card-x" id="notificationForm" novalidate>
            <div class="modal-header">
                <h5 class="modal-title" id="notificationModalTitle">
                    <i class="bi bi-bell-plus-fill"></i>
                    <span>T·∫°o th√¥ng b√°o m·ªõi</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body notification-create-body">
                <input type="hidden" id="notificationId" />
                <div class="row g-4">
                    
                    <div class="col-md-6">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-people-fill"></i>
                            <span>Vai tr√≤ ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-input-wrapper">
                            <select id="receiverRole" class="form-select form-select-modern">
                                <option value="">-- Ch·ªçn vai tr√≤ --</option>
                                <option value="User">üë§ Kh√°ch h√†ng</option>
                                <option value="Provider">üè¢ Nh√† cung c·∫•p</option>
                        </select>
                            <i class="bi bi-chevron-down form-select-icon"></i>
                    </div>
                        <div class="invalid-feedback" id="receiverRole-error" data-message="Vui l√≤ng ch·ªçn vai tr√≤.">Vui l√≤ng ch·ªçn vai tr√≤.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-person-fill"></i>
                            <span>Ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-input-wrapper">
                            <select id="accountReceivedId" class="form-select form-select-modern">
                                <option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option>
                        </select>
                            <i class="bi bi-chevron-down form-select-icon"></i>
                        </div>
                        <div class="invalid-feedback" id="accountReceivedId-error" data-message="Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠n.">Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠n.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-tag-fill"></i>
                            <span>Lo·∫°i th√¥ng b√°o <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-input-wrapper">
                            <select id="notificationType" class="form-select form-select-modern">
                            <option value="">-- Ch·ªçn lo·∫°i th√¥ng b√°o --</option>
                                <option value="System">‚öôÔ∏è H·ªá th·ªëng</option>
                                <option value="Booking">üìÖ ƒê·∫∑t l·ªãch</option>
                                <option value="Payment">üí≥ Thanh to√°n</option>
                                <option value="Promotion">üéÅ Khuy·∫øn m√£i</option>
                        </select>
                            <i class="bi bi-chevron-down form-select-icon"></i>
                        </div>
                        <div class="invalid-feedback" id="notificationType-error" data-message="Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o.">Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-chat-text-fill"></i>
                            <span>N·ªôi dung th√¥ng b√°o <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-textarea-wrapper">
                            <textarea id="content" class="form-control form-control-modern" rows="5" maxlength="1000" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..."></textarea>
                            <div class="form-char-count">
                                <span id="charCount">0</span>/1000 k√Ω t·ª±
                            </div>
                        </div>
                        <div class="invalid-feedback" id="content-error" data-message="Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o.">Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o.</div>
                    </div>
                </div>

                <div id="notificationError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>ƒê√≥ng
                </button>
                <button type="submit" class="btn btn-primary soft" id="btnSaveNotification">
                    <i class="bi bi-check-circle me-2"></i>L∆∞u
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Send to Role -->
<div class="modal fade" id="sendToRoleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <form class="modal-content card-x" id="sendToRoleForm" novalidate>
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-broadcast-fill"></i>
                    <span>G·ª≠i th√¥ng b√°o theo vai tr√≤</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body notification-create-body">
                <div class="row g-4">
                    <div class="col-12">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-people-fill"></i>
                            <span>Vai tr√≤ <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-input-wrapper">
                            <select id="sendToRoleRole" class="form-select form-select-modern">
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                                <option value="All">üåê T·∫•t c·∫£</option>
                                <option value="User">üë§ Kh√°ch h√†ng</option>
                                <option value="Provider">üè¢ Nh√† cung c·∫•p</option>
                        </select>
                            <i class="bi bi-chevron-down form-select-icon"></i>
                        </div>
                        <div class="invalid-feedback" id="sendToRoleRole-error" data-message="Vui l√≤ng ch·ªçn vai tr√≤.">Vui l√≤ng ch·ªçn vai tr√≤.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-tag-fill"></i>
                            <span>Lo·∫°i th√¥ng b√°o <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-input-wrapper">
                            <select id="sendToRoleType" class="form-select form-select-modern">
                            <option value="">-- Ch·ªçn lo·∫°i th√¥ng b√°o --</option>
                                <option value="System">‚öôÔ∏è H·ªá th·ªëng</option>
                                <option value="Booking">üìÖ ƒê·∫∑t l·ªãch</option>
                                <option value="Payment">üí≥ Thanh to√°n</option>
                                <option value="Promotion">üéÅ Khuy·∫øn m√£i</option>
                        </select>
                            <i class="bi bi-chevron-down form-select-icon"></i>
                        </div>
                        <div class="invalid-feedback" id="sendToRoleType-error" data-message="Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o.">Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label form-label-modern">
                            <i class="bi bi-chat-text-fill"></i>
                            <span>N·ªôi dung th√¥ng b√°o <span class="text-danger">*</span></span>
                        </label>
                        <div class="form-textarea-wrapper">
                            <textarea id="sendToRoleContent" class="form-control form-control-modern" rows="5" maxlength="1000" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..."></textarea>
                            <div class="form-char-count">
                                <span id="sendToRoleCharCount">0</span>/1000 k√Ω t·ª±
                            </div>
                        </div>
                        <div class="invalid-feedback" id="sendToRoleContent-error" data-message="Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o.">Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o.</div>
                    </div>
                </div>

                <div id="sendToRoleError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>ƒê√≥ng
                </button>
                <button type="submit" class="btn btn-primary soft" id="btnSendToRoleSubmit">
                    <i class="bi bi-send-fill me-2"></i>G·ª≠i th√¥ng b√°o
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: View Notification Detail -->
<div class="modal fade" id="notificationDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content card-x">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-envelope-open me-2"></i>Chi ti·∫øt th√¥ng b√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body">
                <div class="notification-detail-content">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="detail-field">
                                <label class="detail-label">
                                    <i class="bi bi-person-fill"></i>
                                    <span>Ng∆∞·ªùi nh·∫≠n</span>
                            </label>
                            <div class="detail-value" id="detailReceiverName">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field">
                                <label class="detail-label">
                                    <i class="bi bi-people-fill"></i>
                                    <span>Vai tr√≤</span>
                            </label>
                            <div class="detail-value" id="detailReceiverRole">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field">
                                <label class="detail-label">
                                    <i class="bi bi-tag-fill"></i>
                                    <span>Lo·∫°i th√¥ng b√°o</span>
                            </label>
                            <div class="detail-value" id="detailNotificationType">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field">
                                <label class="detail-label">
                                    <i class="bi bi-clock-fill"></i>
                                    <span>Th·ªùi gian</span>
                            </label>
                            <div class="detail-value" id="detailCreatedAt">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field">
                                <label class="detail-label">
                                    <i class="bi bi-eye-fill"></i>
                                    <span>Tr·∫°ng th√°i</span>
                            </label>
                            <div class="detail-value" id="detailStatus">-</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="detail-field detail-field-full">
                                <label class="detail-label">
                                    <i class="bi bi-chat-text-fill"></i>
                                    <span>N·ªôi dung th√¥ng b√°o</span>
                            </label>
                                <div class="detail-value-content" id="detailContent">-</div>
                        </div>
                    </div>
                </div>
                </div>
                <div id="notificationDetailError" class="text-danger small mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-mark-read" id="btnDetailMarkRead" style="display: none;">
                    <i class="bi bi-check-circle"></i> ƒê·ªçc
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const routes = {
            get: '@Url.Action("Get", "AdminNotification", new { area = "Admin" })',
            create: '@Url.Action("Create", "AdminNotification", new { area = "Admin" })',
            sendToRole: '@Url.Action("SendToRole", "AdminNotification", new { area = "Admin" })',
            delete: '@Url.Action("Delete", "AdminNotification", new { area = "Admin" })',
            markAsRead: '@Url.Action("MarkAsRead", "AdminNotification", new { area = "Admin" })',
            markAllAsRead: '@Url.Action("MarkAllAsRead", "AdminNotification", new { area = "Admin" })',
            getAccounts: '@Url.Action("GetAccounts", "AdminNotification", new { area = "Admin" })'
        };

        // ===== Center Toast Notification =====
        function showCenterToast(message, type = 'success') {
            const root = document.body;
            const existingToasts = root.querySelectorAll('.center-toast');
            existingToasts.forEach(toast => toast.remove());
            
            const box = document.createElement('div');
            box.className = 'center-toast ' + type;
            
            const iconClass = type === 'success' ? 'bi-check-circle' :
                             type === 'error' ? 'bi-x-circle' :
                             type === 'warn' ? 'bi-exclamation-triangle' : 'bi-info-circle';
            
            box.innerHTML = 
                '<div class="toast-box">' +
                    '<div class="accent"></div>' +
                    '<i class="bi ' + iconClass + '"></i>' +
                    '<span class="msg">' + message + '</span>' +
                '</div>';
            
            root.appendChild(box);
            
            requestAnimationFrame(() => {
                box.classList.add('show');
            });
            
            setTimeout(() => {
                box.classList.remove('show');
                setTimeout(() => box.remove(), 350);
            }, 3000);
        }

        // ===== Tab management with localStorage =====
        const TAB_STORAGE_KEY = 'vhs-notification-active-tab';
        
        // ===== Function to toggle filter visibility based on active tab =====
        function toggleFiltersByTab(tabName) {
            const roleFilterContainer = document.getElementById('roleFilterContainer');
            const typeFilterContainer = document.getElementById('typeFilterContainer');
            const statusFilterContainer = document.getElementById('statusFilterContainer');
            const filterRow = document.getElementById('filterRow');
            
            if (tabName === 'sent') {
                // Hi·ªÉn th·ªã filters khi ·ªü tab "Th√¥ng b√°o ƒë√£ g·ª≠i"
                if (roleFilterContainer) roleFilterContainer.style.display = 'block';
                if (typeFilterContainer) typeFilterContainer.style.display = 'block';
                
                // ƒêi·ªÅu ch·ªânh class cho status filter ƒë·ªÉ layout 3 c·ªôt
                if (statusFilterContainer) {
                    statusFilterContainer.className = 'col-md-4';
                }
                if (filterRow) {
                    filterRow.classList.remove('filter-inbox-mode');
                    filterRow.classList.add('filter-sent-mode');
                }
            } else {
                // ·∫®n filters khi ·ªü tab "Th√¥ng b√°o nh·∫≠n ƒë∆∞·ª£c"
                if (roleFilterContainer) roleFilterContainer.style.display = 'none';
                if (typeFilterContainer) typeFilterContainer.style.display = 'none';
                
                // X√≥a gi√° tr·ªã filter khi chuy·ªÉn sang tab inbox
                const roleFilter = document.getElementById('roleFilter');
                const typeFilter = document.getElementById('typeFilter');
                if (roleFilter) roleFilter.value = '';
                if (typeFilter) typeFilter.value = '';
                
                // ƒêi·ªÅu ch·ªânh class cho status filter ƒë·ªÉ layout 1 c·ªôt
                if (statusFilterContainer) {
                    statusFilterContainer.className = 'col-12';
                }
                if (filterRow) {
                    filterRow.classList.remove('filter-sent-mode');
                    filterRow.classList.add('filter-inbox-mode');
                }
            }
        }
        
        // ===== Function to switch tabs programmatically =====
        function switchToTab(tabName, saveToStorage = true) {
            const inboxTab = document.getElementById('inbox-tab');
            const inboxPane = document.getElementById('inbox');
            const sentTab = document.getElementById('sent-tab');
            const sentPane = document.getElementById('sent');
            
            if (tabName === 'inbox' && inboxTab && inboxPane && sentTab && sentPane) {
                inboxTab.classList.add('active');
                inboxTab.setAttribute('aria-selected', 'true');
                sentTab.classList.remove('active');
                sentTab.setAttribute('aria-selected', 'false');
                
                inboxPane.classList.add('show', 'active');
                sentPane.classList.remove('show', 'active');
                
                if (saveToStorage) {
                    localStorage.setItem(TAB_STORAGE_KEY, 'inbox');
                }
                
                // ·∫®n filters cho vai tr√≤ v√† lo·∫°i th√¥ng b√°o
                toggleFiltersByTab('inbox');
                
                // Smooth scroll to tabs
                setTimeout(() => {
                    document.querySelector('.notification-tabs')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else if (tabName === 'sent' && inboxTab && inboxPane && sentTab && sentPane) {
                sentTab.classList.add('active');
                sentTab.setAttribute('aria-selected', 'true');
                inboxTab.classList.remove('active');
                inboxTab.setAttribute('aria-selected', 'false');
                
                sentPane.classList.add('show', 'active');
                inboxPane.classList.remove('show', 'active');
                
                if (saveToStorage) {
                    localStorage.setItem(TAB_STORAGE_KEY, 'sent');
                }
                
                // Hi·ªÉn th·ªã filters cho vai tr√≤ v√† lo·∫°i th√¥ng b√°o
                toggleFiltersByTab('sent');
                
                // Smooth scroll to tabs
                setTimeout(() => {
                    document.querySelector('.notification-tabs')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }

        // ===== Load saved tab or from URL on page load =====
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlTab = urlParams.get('tab');
            const savedTab = localStorage.getItem(TAB_STORAGE_KEY);
            
            // Priority: URL param > localStorage > default (inbox)
            let activeTab = 'inbox';
            if (urlTab === 'inbox' || urlTab === 'sent') {
                activeTab = urlTab;
            } else if (savedTab === 'inbox' || savedTab === 'sent') {
                activeTab = savedTab;
            }
            
            switchToTab(activeTab, false);
            
            // ƒê·∫£m b·∫£o filters ƒë∆∞·ª£c hi·ªÉn th·ªã/·∫©n ƒë√∫ng khi load trang
            toggleFiltersByTab(activeTab);
            
            // Add Enter key listener for search input
            const keywordInput = document.getElementById('keywordInput');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilter();
                    }
                });
            }
            
            // L·∫Øng nghe event t·ª´ dropdown khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
            setupNotificationSync();
        });
        
        // ===== Sync v·ªõi dropdown khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc =====
        function setupNotificationSync() {
            console.log('[NotificationSync] Setting up sync listeners');
            
            // L·∫Øng nghe custom event t·ª´ layout
            window.addEventListener('notificationMarkedRead', function(event) {
                console.log('[NotificationSync] Received custom event:', event.detail);
                const { action, data } = event.detail;
                handleNotificationMarkedRead(action, data);
            });
            
            // L·∫Øng nghe BroadcastChannel ƒë·ªÉ sync gi·ªØa c√°c tabs
            try {
                const channel = new BroadcastChannel('admin_notification_sync');
                channel.addEventListener('message', function(event) {
                    console.log('[NotificationSync] Received BroadcastChannel message:', event.data);
                    const { action, data } = event.data;
                    handleNotificationMarkedRead(action, data);
                });
                console.log('[NotificationSync] BroadcastChannel listener set up');
            } catch (e) {
                console.log('[NotificationSync] BroadcastChannel not supported');
            }
            
            // L·∫Øng nghe localStorage event (fallback)
            window.addEventListener('storage', function(event) {
                if (event.key === 'admin_notification_update') {
                    console.log('[NotificationSync] Received storage event');
                    try {
                        const update = JSON.parse(event.newValue);
                        if (update) {
                            handleNotificationMarkedRead(update.action, update.data);
                        }
                    } catch (e) {
                        console.error('[NotificationSync] Error parsing notification update:', e);
                    }
                }
            });
        }
        
        // X·ª≠ l√Ω khi notification ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc t·ª´ dropdown
        async function handleNotificationMarkedRead(action, data) {
            console.log('[NotificationSync] Received:', action, data);
            
            if (action === 'markRead' && data.id) {
                // C·∫≠p nh·∫≠t UI cho notification c·ª• th·ªÉ (s·ª≠ d·ª•ng data-id v√¨ l√† table row)
                const notificationRow = document.querySelector(`tr[data-id="${data.id}"]`);
                if (notificationRow) {
                    console.log('[NotificationSync] Found row, updating UI');
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong c·ªôt "Tr·∫°ng th√°i"
                    const statusCell = notificationRow.querySelector('td:nth-child(4)');
                    if (statusCell) {
                        statusCell.innerHTML = '<span class="state ok">ƒê√£ ƒë·ªçc</span>';
                    }
                    
                    // ·∫®n n√∫t "ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc" n·∫øu c√≥
                    const markReadBtn = notificationRow.querySelector('.btn-mark-read');
                    if (markReadBtn) {
                        markReadBtn.style.transition = 'opacity 0.3s ease';
                        markReadBtn.style.opacity = '0';
                        setTimeout(() => markReadBtn.remove(), 300);
                    }
                    
                    // Th√™m class ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc (n·∫øu c√≥ styling)
                    notificationRow.classList.remove('unread');
                    notificationRow.classList.add('read');
                } else {
                    console.log('[NotificationSync] Row not found, will reload filter');
                }
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng unread trong tab badge
                updateUnreadCountInHeader();
                
                // Reload filter sau m·ªôt ch√∫t ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu (nh∆∞ng kh√¥ng l√†m m·∫•t UI update)
                setTimeout(async () => {
                    await applyFilter();
                }, 500);
            } else if (action === 'markAllRead') {
                console.log('[NotificationSync] Marking all as read');
                
                // C·∫≠p nh·∫≠t t·∫•t c·∫£ notifications th√†nh "ƒê√£ ƒë·ªçc"
                const unreadRows = document.querySelectorAll('tr.notification-row');
                unreadRows.forEach(row => {
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong c·ªôt "Tr·∫°ng th√°i"
                    const statusCell = row.querySelector('td:nth-child(4)');
                    if (statusCell) {
                        const stateSpan = statusCell.querySelector('.state');
                        if (stateSpan && stateSpan.classList.contains('warn')) {
                            statusCell.innerHTML = '<span class="state ok">ƒê√£ ƒë·ªçc</span>';
                        }
                    }
                    
                    // ·∫®n n√∫t "ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc" n·∫øu c√≥
                    const markReadBtn = row.querySelector('.btn-mark-read');
                    if (markReadBtn) {
                        markReadBtn.style.transition = 'opacity 0.3s ease';
                        markReadBtn.style.opacity = '0';
                        setTimeout(() => markReadBtn.remove(), 300);
                    }
                    
                    // Th√™m class ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                    row.classList.remove('unread');
                    row.classList.add('read');
                });
                
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng unread trong tab badge
                updateUnreadCountInHeader();
                
                // Reload filter sau m·ªôt ch√∫t ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu
                setTimeout(async () => {
                    await applyFilter();
                }, 500);
            }
        }

        // ===== Save tab when user clicks on tab =====
        document.getElementById('inbox-tab')?.addEventListener('click', function() {
            localStorage.setItem(TAB_STORAGE_KEY, 'inbox');
            toggleFiltersByTab('inbox');
        });
        
        document.getElementById('sent-tab')?.addEventListener('click', function() {
            localStorage.setItem(TAB_STORAGE_KEY, 'sent');
            toggleFiltersByTab('sent');
        });
        
        // L·∫Øng nghe s·ª± ki·ªán khi Bootstrap tab thay ƒë·ªïi
        document.querySelectorAll('#notificationTabs button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                const targetTab = e.target.getAttribute('data-bs-target');
                if (targetTab === '#sent') {
                    toggleFiltersByTab('sent');
                } else if (targetTab === '#inbox') {
                    toggleFiltersByTab('inbox');
                }
            });
        });

        // ===== Modals =====
        const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
        const sendToRoleModal = new bootstrap.Modal(document.getElementById('sendToRoleModal'));
        const notificationDetailModal = new bootstrap.Modal(document.getElementById('notificationDetailModal'));

        // ===== Helper function to convert role to Vietnamese =====
        function getRoleInVietnamese(role) {
            switch(role) {
                case 'User': return 'Ng∆∞·ªùi d√πng';
                case 'Provider': return 'Nh√† cung c·∫•p';
                case 'Admin': return 'Qu·∫£n tr·ªã vi√™n';
                default: return role;
            }
        }

        // ===== Helper function to convert notification type to Vietnamese =====
        function getNotificationTypeInVietnamese(type) {
            switch(type) {
                case 'System': return 'H·ªá th·ªëng';
                case 'Booking': return 'ƒê·∫∑t l·ªãch';
                case 'Payment': return 'Thanh to√°n';
                case 'Promotion': return 'Khuy·∫øn m√£i';
                default: return type;
            }
        }

        // ===== View Notification Detail =====
        let currentNotificationId = null;
        
        async function viewNotificationDetail(notificationId) {
            try {
                currentNotificationId = notificationId;
                clearError('notificationDetailError');
                
                // Fetch notification details
                const res = await fetch(routes.get + `?id=${notificationId}`);
                
                if (res.ok) {
                    const notification = await res.json();
                    
                    // Populate modal with data
                    document.getElementById('detailReceiverName').textContent = notification.receiverName || notification.receiverEmail || 'N/A';
                    document.getElementById('detailReceiverRole').innerHTML = `<span class="badge bg-secondary">${getRoleInVietnamese(notification.receiverRole)}</span>`;
                    document.getElementById('detailNotificationType').innerHTML = `<span class="badge bg-info">${getNotificationTypeInVietnamese(notification.notificationType)}</span>`;
                    // Display time (database ƒë√£ l∆∞u theo gi·ªù Vi·ªát Nam r·ªìi)
                    if (notification.createdAt) {
                        const date = new Date(notification.createdAt);
                        // Database ƒë√£ l∆∞u theo gi·ªù Vi·ªát Nam, ch·ªâ c·∫ßn format
                        const formattedDate = date.toLocaleString('vi-VN', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        document.getElementById('detailCreatedAt').textContent = formattedDate;
                    } else {
                        document.getElementById('detailCreatedAt').textContent = 'N/A';
                    }
                    document.getElementById('detailContent').textContent = notification.content || 'N/A';
                    
                    // Show status
                    if (notification.isRead) {
                        document.getElementById('detailStatus').innerHTML = '<span class="badge bg-success">ƒê√£ ƒë·ªçc</span>';
                        document.getElementById('btnDetailMarkRead').style.display = 'none';
                    } else {
                        document.getElementById('detailStatus').innerHTML = '<span class="badge bg-warning">Ch∆∞a ƒë·ªçc</span>';
                        // Only show mark as read button if notification is for Admin
                        if (notification.receiverRole === 'Admin') {
                            document.getElementById('btnDetailMarkRead').style.display = 'inline-block';
                        } else {
                            document.getElementById('btnDetailMarkRead').style.display = 'none';
                        }
                    }
                    
                    // Show modal
                    notificationDetailModal.show();
                    
                } else {
                    const error = await res.json();
                    alert(error.message || 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt th√¥ng b√°o');
                }
            } catch (err) {
                console.error('Error loading notification detail:', err);
                alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt th√¥ng b√°o');
            }
        }

        // ===== Mark as Read (s·ª≠ d·ª•ng capture phase ƒë·ªÉ x·ª≠ l√Ω TR∆Ø·ªöC) =====
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.btn-mark-read');
            if (btn && btn.dataset.id) {
                e.stopPropagation(); // NgƒÉn event bubble l√™n row listener
                e.preventDefault();
                
                const id = btn.dataset.id;
                
                // Disable button ƒë·ªÉ tr√°nh double click
                btn.disabled = true;
                
                try {
                    const res = await fetch(routes.markAsRead + `?id=${id}`, { method: 'POST' });
                    if (res.ok) {
                        // Refresh data without reload
                        await applyFilter();
                    } else {
                        const error = await res.json();
                        alert(error.message || 'C√≥ l·ªói x·∫£y ra');
                        btn.disabled = false;
                    }
                } catch (err) {
                    alert('Kh√¥ng th·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc');
                    btn.disabled = false;
                }
            }
        }, true); // S·ª≠ d·ª•ng capture phase

        // ===== Delete Notification (s·ª≠ d·ª•ng capture phase ƒë·ªÉ x·ª≠ l√Ω TR∆Ø·ªöC) =====
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.btn-delete');
            if (btn && btn.dataset.id) {
                e.stopPropagation(); // NgƒÉn event bubble l√™n row listener
                e.preventDefault();
                
                const id = btn.dataset.id;
                
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng b√°o n√†y?')) return;
                
                // Disable button ƒë·ªÉ tr√°nh double click
                btn.disabled = true;
                
                try {
                    const res = await fetch(routes.delete + `?id=${id}`, { method: 'DELETE' });
                    if (res.status === 204) {
                        // Refresh data without reload
                        await applyFilter();
                    } else {
                        const error = await res.json();
                        alert(error.message || 'C√≥ l·ªói x·∫£y ra');
                        btn.disabled = false;
                    }
                } catch (err) {
                    alert('Kh√¥ng th·ªÉ x√≥a th√¥ng b√°o');
                    btn.disabled = false;
                }
            }
        }, true); // S·ª≠ d·ª•ng capture phase

        // ===== Event listener for notification rows (ƒë·∫∑t SAU event listeners cho buttons) =====
        document.addEventListener('click', async (e) => {
            // Kh√¥ng m·ªü modal n·∫øu click v√†o button, icon, ho·∫∑c b·∫•t k·ª≥ element n√†o b√™n trong button
            const clickedButton = e.target.closest('button');
            if (clickedButton && (clickedButton.classList.contains('btn-mark-read') || clickedButton.classList.contains('btn-delete'))) {
                return; // ƒê√£ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi button listeners ·ªü tr√™n
            }
            
            const row = e.target.closest('.notification-row');
            if (row) {
                // Kh√¥ng m·ªü modal cho c√°c row trong tab "Th√¥ng b√°o ƒë√£ g·ª≠i"
                if (row.classList.contains('notification-row-sent')) {
                    return;
                }
                
                const notificationId = row.dataset.id;
                if (notificationId) {
                    await viewNotificationDetail(notificationId);
                }
            }
        });

        // ===== Mark as read from detail modal =====
        document.getElementById('btnDetailMarkRead')?.addEventListener('click', async () => {
            if (!currentNotificationId) return;
            
            try {
                const res = await fetch(routes.markAsRead + `?id=${currentNotificationId}`, { method: 'POST' });
                if (res.ok) {
                    // Update modal UI
                    document.getElementById('detailStatus').innerHTML = '<span class="badge bg-success">ƒê√£ ƒë·ªçc</span>';
                    document.getElementById('btnDetailMarkRead').style.display = 'none';
                    
                    // Close modal and refresh
                    notificationDetailModal.hide();
                    await applyFilter();
                } else {
                    const error = await res.json();
                    alert(error.message || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (err) {
                alert('Kh√¥ng th·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc');
            }
        });

        // ===== Character Count for Textarea =====
        const contentTextarea = document.getElementById('content');
        const charCountElement = document.getElementById('charCount');
        
        if (contentTextarea && charCountElement) {
            // Update character count on input
            contentTextarea.addEventListener('input', function() {
                const currentLength = this.value.length;
                charCountElement.textContent = currentLength;
                
                // Change color when approaching limit
                if (currentLength > 900) {
                    charCountElement.style.color = '#ef4444';
                } else if (currentLength > 800) {
                    charCountElement.style.color = '#f59e0b';
                } else {
                    charCountElement.style.color = 'var(--success)';
                }
            });
            
            // Initialize character count
            charCountElement.textContent = contentTextarea.value.length;
        }

        // ===== Create Notification Button =====
        document.getElementById('btnCreateNotification').addEventListener('click', () => {
            const modalTitle = document.getElementById('notificationModalTitle');
            modalTitle.innerHTML = '<i class="bi bi-bell-plus-fill"></i><span>T·∫°o th√¥ng b√°o m·ªõi</span>';
            clearNotificationFormCompletely();
            clearError('notificationError');
            if (charCountElement) charCountElement.textContent = '0';
            loadAccounts(); // Load accounts when creating notification
            notificationModal.show();
        });

        // ===== Empty State Create Button =====
        document.getElementById('btnCreateNotificationEmpty')?.addEventListener('click', () => {
            const modalTitle = document.getElementById('notificationModalTitle');
            modalTitle.innerHTML = '<i class="bi bi-bell-plus-fill"></i><span>T·∫°o th√¥ng b√°o m·ªõi</span>';
            clearNotificationFormCompletely();
            clearError('notificationError');
            if (charCountElement) charCountElement.textContent = '0';
            loadAccounts(); // Load accounts when creating notification
            notificationModal.show();
        });

        // ===== Character Count for Send to Role Textarea =====
        const sendToRoleContentTextarea = document.getElementById('sendToRoleContent');
        const sendToRoleCharCountElement = document.getElementById('sendToRoleCharCount');
        
        if (sendToRoleContentTextarea && sendToRoleCharCountElement) {
            // Update character count on input
            sendToRoleContentTextarea.addEventListener('input', function() {
                const currentLength = this.value.length;
                sendToRoleCharCountElement.textContent = currentLength;
                
                // Change color when approaching limit
                if (currentLength > 900) {
                    sendToRoleCharCountElement.style.color = '#ef4444';
                } else if (currentLength > 800) {
                    sendToRoleCharCountElement.style.color = '#f59e0b';
                } else {
                    sendToRoleCharCountElement.style.color = 'var(--success)';
                }
            });
            
            // Initialize character count
            sendToRoleCharCountElement.textContent = sendToRoleContentTextarea.value.length;
        }

        // ===== Send to Role Button =====
        document.getElementById('btnSendToRole').addEventListener('click', () => {
            clearSendToRoleForm();
            clearError('sendToRoleError');
            if (sendToRoleCharCountElement) sendToRoleCharCountElement.textContent = '0';
            sendToRoleModal.show();
        });

        // ===== Role Change Event =====
        document.getElementById('receiverRole').addEventListener('change', () => {
            loadAccounts(); // Reload accounts when role changes
        });

        // ===== Filter Functions =====
        document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
        document.getElementById('btnClearFilter').addEventListener('click', () => {
            const activeTab = localStorage.getItem(TAB_STORAGE_KEY) || 'inbox';
            
            // Ch·ªâ x√≥a role v√† type filter khi ·ªü tab "Th√¥ng b√°o ƒë√£ g·ª≠i"
            if (activeTab === 'sent') {
            document.getElementById('roleFilter').value = '';
            document.getElementById('typeFilter').value = '';
            }
            
            document.getElementById('readStatusFilter').value = '';
            document.querySelector('input[name="keyword"]').value = '';
            applyFilter();
        });

        async function applyFilter() {
            const role = document.getElementById('roleFilter').value;
            const type = document.getElementById('typeFilter').value;
            const readStatus = document.getElementById('readStatusFilter').value;
            const keyword = document.querySelector('input[name="keyword"]').value;
            
            let url = '@Url.Action("Index", "AdminNotification", new { area = "Admin" })';
            const params = new URLSearchParams();
            
            const activeTab = localStorage.getItem(TAB_STORAGE_KEY) || 'inbox';
            
            // Ch·ªâ √°p d·ª•ng role v√† type filter khi ·ªü tab "Th√¥ng b√°o ƒë√£ g·ª≠i"
            if (activeTab === 'sent') {
            if (role) params.append('role', role);
            if (type) params.append('notificationType', type);
            }
            
            // Tr·∫°ng th√°i v√† keyword √°p d·ª•ng cho c·∫£ 2 tab
            if (readStatus) params.append('isRead', readStatus);
            if (keyword) params.append('keyword', keyword);
            
            params.append('tab', activeTab);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            try {
                // Show loading indicator
                showLoadingIndicator();
                
                const response = await fetch(url);
                const html = await response.text();
                
                // Parse HTML ƒë·ªÉ l·∫•y ph·∫ßn content c·∫ßn thi·∫øt
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Update b·∫£ng d·ªØ li·ªáu cho c·∫£ 2 tabs
                const newInboxTable = doc.querySelector('#inbox .table-scroll');
                const newSentTable = doc.querySelector('#sent .table-scroll');
                const newMetrics = doc.querySelector('.v-head .right');
                
                if (newInboxTable) {
                    document.querySelector('#inbox .table-scroll').innerHTML = newInboxTable.innerHTML;
                }
                if (newSentTable) {
                    document.querySelector('#sent .table-scroll').innerHTML = newSentTable.innerHTML;
                }
                if (newMetrics) {
                    document.querySelector('.v-head .right').innerHTML = newMetrics.innerHTML;
                }
                
                // Update URL without reload
                window.history.pushState({}, '', url);
                
                // Hide loading indicator
                hideLoadingIndicator();
                
            } catch (error) {
                console.error('Error applying filter:', error);
                hideLoadingIndicator();
                alert('C√≥ l·ªói x·∫£y ra khi l·ªçc d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function showLoadingIndicator() {
            const tables = document.querySelectorAll('.table-scroll');
            tables.forEach(table => {
                table.classList.add('loading');
            });
        }

        function hideLoadingIndicator() {
            const tables = document.querySelectorAll('.table-scroll');
            tables.forEach(table => {
                table.classList.remove('loading');
            });
        }

        // ===== Custom Validation Functions =====
        function validateField(fieldId, errorId, errorMessage) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(errorId);
            
            if (!field || !errorEl) return true;
            
            const value = field.value.trim();
            
            if (!value || value === '') {
                field.classList.add('is-invalid');
                field.setAttribute('aria-invalid', 'true');
                errorEl.style.display = 'flex';
                errorEl.style.visibility = 'visible';
                errorEl.style.opacity = '1';
                // Prevent browser from showing default validation
                field.setCustomValidity(' '); // Space instead of empty to prevent browser tooltip
                return false;
                    } else {
                field.classList.remove('is-invalid');
                field.setAttribute('aria-invalid', 'false');
                errorEl.style.display = 'none';
                errorEl.style.visibility = 'hidden';
                field.setCustomValidity(''); // Clear custom validity
                return true;
            }
        }

        function validateForm() {
            let isValid = true;
            
            isValid = validateField('accountReceivedId', 'accountReceivedId-error', 'Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠n') && isValid;
            isValid = validateField('receiverRole', 'receiverRole-error', 'Vui l√≤ng ch·ªçn vai tr√≤') && isValid;
            isValid = validateField('notificationType', 'notificationType-error', 'Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o') && isValid;
            isValid = validateField('content', 'content-error', 'Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o') && isValid;
            
            return isValid;
        }

        // ===== Real-time Validation on Input (only clear errors, don't show until submit) =====
        let formSubmitted = false;
        
        document.getElementById('accountReceivedId')?.addEventListener('change', function() {
            if (formSubmitted) {
                validateField('accountReceivedId', 'accountReceivedId-error', 'Vui l√≤ng ch·ªçn ng∆∞·ªùi nh·∫≠n');
            } else {
                // Only clear error if field becomes valid, don't show error until submit
                const field = document.getElementById('accountReceivedId');
                const errorEl = document.getElementById('accountReceivedId-error');
                if (field && errorEl && field.value && field.value !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                }
            }
        });

        document.getElementById('receiverRole')?.addEventListener('change', function() {
            if (formSubmitted) {
                validateField('receiverRole', 'receiverRole-error', 'Vui l√≤ng ch·ªçn vai tr√≤');
                    } else {
                const field = document.getElementById('receiverRole');
                const errorEl = document.getElementById('receiverRole-error');
                if (field && errorEl && field.value && field.value !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                }
            }
        });

        document.getElementById('notificationType')?.addEventListener('change', function() {
            if (formSubmitted) {
                validateField('notificationType', 'notificationType-error', 'Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o');
            } else {
                const field = document.getElementById('notificationType');
                const errorEl = document.getElementById('notificationType-error');
                if (field && errorEl && field.value && field.value !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                    }
            }
        });

        document.getElementById('content')?.addEventListener('input', function() {
            if (formSubmitted) {
                validateField('content', 'content-error', 'Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o');
            } else {
                const field = document.getElementById('content');
                const errorEl = document.getElementById('content-error');
                if (field && errorEl && field.value.trim() !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                }
            }
        });

        // ===== Form Validation =====
        document.getElementById('notificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError('notificationError');
            
            // Mark form as submitted so validation shows errors
            formSubmitted = true;

            // Validate all fields
            if (!validateForm()) {
                // Scroll to first error
                const firstError = document.querySelector('#notificationForm .is-invalid');
                if (firstError) {
                    setTimeout(() => {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }, 100);
                }
                return;
            }
            
            // Reset formSubmitted flag if validation passes
            formSubmitted = false;

            const formData = {
                accountReceivedId: document.getElementById('accountReceivedId').value,
                receiverRole: document.getElementById('receiverRole').value,
                notificationType: document.getElementById('notificationType').value,
                content: document.getElementById('content').value.trim()
            };

            try {
                const res = await fetch(routes.create, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (res.ok) {
                    notificationModal.hide();
                    showCenterToast('T·∫°o th√¥ng b√°o th√†nh c√¥ng!', 'success');
                    setTimeout(() => {
                        applyFilter();
                    }, 500);
                } else {
                    const error = await res.json();
                    console.error('Error creating notification:', error);
                    showError('notificationError', error.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o th√¥ng b√°o');
                }
            } catch (err) {
                console.error('Network error:', err);
                showError('notificationError', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.');
            }
        });

        // ===== Send to Role Form Validation =====
        let sendToRoleFormSubmitted = false;
        
        // Real-time validation for Send to Role form
        document.getElementById('sendToRoleRole')?.addEventListener('change', function() {
            if (sendToRoleFormSubmitted) {
                validateSendToRoleField('sendToRoleRole', 'sendToRoleRole-error', 'Vui l√≤ng ch·ªçn vai tr√≤');
            } else {
                const field = document.getElementById('sendToRoleRole');
                const errorEl = document.getElementById('sendToRoleRole-error');
                if (field && errorEl && field.value && field.value !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                }
            }
        });

        document.getElementById('sendToRoleType')?.addEventListener('change', function() {
            if (sendToRoleFormSubmitted) {
                validateSendToRoleField('sendToRoleType', 'sendToRoleType-error', 'Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o');
            } else {
                const field = document.getElementById('sendToRoleType');
                const errorEl = document.getElementById('sendToRoleType-error');
                if (field && errorEl && field.value && field.value !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                }
            }
        });

        document.getElementById('sendToRoleContent')?.addEventListener('input', function() {
            if (sendToRoleFormSubmitted) {
                validateSendToRoleField('sendToRoleContent', 'sendToRoleContent-error', 'Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o');
            } else {
                const field = document.getElementById('sendToRoleContent');
                const errorEl = document.getElementById('sendToRoleContent-error');
                if (field && errorEl && field.value.trim() !== '') {
                    field.classList.remove('is-invalid');
                    errorEl.style.display = 'none';
                }
            }
        });

        function validateSendToRoleField(fieldId, errorId, errorMessage) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(errorId);
            
            if (!field || !errorEl) return true;
            
            const value = field.value.trim();
            
            if (!value || value === '') {
                field.classList.add('is-invalid');
                field.setAttribute('aria-invalid', 'true');
                errorEl.style.display = 'flex';
                errorEl.style.visibility = 'visible';
                errorEl.style.opacity = '1';
                field.setCustomValidity(' ');
                return false;
            } else {
                field.classList.remove('is-invalid');
                field.setAttribute('aria-invalid', 'false');
                errorEl.style.display = 'none';
                errorEl.style.visibility = 'hidden';
                field.setCustomValidity('');
                return true;
            }
        }

        function validateSendToRoleForm() {
            let isValid = true;
            
            isValid = validateSendToRoleField('sendToRoleRole', 'sendToRoleRole-error', 'Vui l√≤ng ch·ªçn vai tr√≤') && isValid;
            isValid = validateSendToRoleField('sendToRoleType', 'sendToRoleType-error', 'Vui l√≤ng ch·ªçn lo·∫°i th√¥ng b√°o') && isValid;
            isValid = validateSendToRoleField('sendToRoleContent', 'sendToRoleContent-error', 'Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o') && isValid;
            
            return isValid;
        }

        // ===== Send to Role Form =====
        document.getElementById('sendToRoleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError('sendToRoleError');

            // Mark form as submitted
            sendToRoleFormSubmitted = true;

            // Validate all fields
            if (!validateSendToRoleForm()) {
                // Scroll to first error
                const firstError = document.querySelector('#sendToRoleForm .is-invalid');
                if (firstError) {
                    setTimeout(() => {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }, 100);
                }
                return;
            }

            // Reset formSubmitted flag if validation passes
            sendToRoleFormSubmitted = false;

            const role = document.getElementById('sendToRoleRole').value;
            const notificationType = document.getElementById('sendToRoleType').value;
            const content = document.getElementById('sendToRoleContent').value.trim();

            try {
                // If "All" is selected, send to both User and Provider
                if (role === 'All') {
                    // Send to User
                    const userRes = await fetch(routes.sendToRole, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            role: 'User',
                            notificationType: notificationType,
                            content: content
                        })
                    });
                    
                    // Send to Provider
                    const providerRes = await fetch(routes.sendToRole, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            role: 'Provider',
                            notificationType: notificationType,
                            content: content
                        })
                    });
                    
                    if (userRes.ok && providerRes.ok) {
                        sendToRoleModal.hide();
                        showCenterToast('G·ª≠i th√¥ng b√°o th√†nh c√¥ng!', 'success');
                        setTimeout(() => {
                            applyFilter();
                        }, 500);
                    } else {
                        const userError = await userRes.json().catch(() => ({ message: 'L·ªói khi g·ª≠i cho Kh√°ch h√†ng' }));
                        const providerError = await providerRes.json().catch(() => ({ message: 'L·ªói khi g·ª≠i cho Nh√† cung c·∫•p' }));
                        showError('sendToRoleError', userError.message || providerError.message || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i th√¥ng b√°o');
                    }
                } else {
                    // Send to single role
                const res = await fetch(routes.sendToRole, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            role: role,
                            notificationType: notificationType,
                            content: content
                        })
                });

                if (res.ok) {
                    sendToRoleModal.hide();
                        showCenterToast('G·ª≠i th√¥ng b√°o th√†nh c√¥ng!', 'success');
                        setTimeout(() => {
                            applyFilter();
                        }, 500);
                } else {
                    const error = await res.json();
                    showError('sendToRoleError', error.message || 'C√≥ l·ªói x·∫£y ra');
                    }
                }
            } catch (err) {
                console.error('Network error:', err);
                showError('sendToRoleError', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.');
            }
        });

        // ===== Load Accounts =====
        async function loadAccounts() {
            try {
                console.log('Loading accounts...');
                const res = await fetch(routes.getAccounts);
                console.log('Response status:', res.status);
                
                if (res.ok) {
                    const accounts = await res.json();
                    console.log('Loaded accounts:', accounts);
                    
                    const select = document.getElementById('accountReceivedId');
                    const roleSelect = document.getElementById('receiverRole');
                    const selectedRole = roleSelect.value;
                    
                    select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option>';
                    
                    // Filter accounts by selected role and exclude Admin accounts
                    const filteredAccounts = selectedRole ? 
                        accounts.filter(account => account.role === selectedRole && account.role !== 'Admin') : 
                        accounts.filter(account => account.role !== 'Admin');
                    
                    console.log('Filtered accounts:', filteredAccounts);
                    
                    if (filteredAccounts.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = selectedRole ? 'Kh√¥ng c√≥ t√†i kho·∫£n n√†o v·ªõi vai tr√≤ n√†y' : 'Kh√¥ng c√≥ t√†i kho·∫£n n√†o';
                        option.disabled = true;
                        select.appendChild(option);
                    } else {
                        filteredAccounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.accountId;
                            option.textContent = account.accountName;
                            select.appendChild(option);
                        });
                    }
                } else {
                    console.error('Failed to load accounts:', res.status, res.statusText);
                    const select = document.getElementById('accountReceivedId');
                    select.innerHTML = '<option value="">-- L·ªói khi t·∫£i danh s√°ch t√†i kho·∫£n --</option>';
                }
            } catch (err) {
                console.error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i kho·∫£n:', err);
                const select = document.getElementById('accountReceivedId');
                select.innerHTML = '<option value="">-- L·ªói khi t·∫£i danh s√°ch t√†i kho·∫£n --</option>';
            }
        }

        // ===== Helper Functions =====
        function clearNotificationForm() {
            document.getElementById('accountReceivedId').value = '';
            document.getElementById('notificationType').value = '';
            document.getElementById('content').value = '';
            // Keep receiverRole to allow filtering
        }

        function clearNotificationFormCompletely() {
            document.getElementById('notificationId').value = '';
            document.getElementById('accountReceivedId').value = '';
            document.getElementById('receiverRole').value = '';
            document.getElementById('notificationType').value = '';
            const contentField = document.getElementById('content');
            contentField.value = '';
            
            // Reset character count
            if (charCountElement) {
                charCountElement.textContent = '0';
                charCountElement.style.color = 'var(--success)';
            }
            
            // Reset form submitted flag
            formSubmitted = false;
            
            // Remove validation classes
            const form = document.getElementById('notificationForm');
            form.classList.remove('was-validated');
            
            // Remove invalid classes from inputs and hide error messages
            const fields = [
                { field: 'accountReceivedId', error: 'accountReceivedId-error' },
                { field: 'receiverRole', error: 'receiverRole-error' },
                { field: 'notificationType', error: 'notificationType-error' },
                { field: 'content', error: 'content-error' }
            ];
            
            fields.forEach(({ field, error }) => {
                const fieldEl = document.getElementById(field);
                const errorEl = document.getElementById(error);
                if (fieldEl) {
                    fieldEl.classList.remove('is-invalid');
                    // Force remove any browser validation styling
                    fieldEl.setAttribute('aria-invalid', 'false');
                    fieldEl.setCustomValidity(''); // Clear browser validation
                }
                if (errorEl) {
                    errorEl.style.display = 'none';
                    errorEl.style.visibility = 'hidden';
                    errorEl.style.opacity = '0';
                    // Restore original message if needed
                    const originalMessage = errorEl.getAttribute('data-message');
                    if (originalMessage) {
                        errorEl.textContent = originalMessage;
                    }
                }
            });
        }

        function clearSendToRoleForm() {
            document.getElementById('sendToRoleRole').value = '';
            document.getElementById('sendToRoleType').value = '';
            const contentField = document.getElementById('sendToRoleContent');
            contentField.value = '';
            
            // Reset character count
            if (sendToRoleCharCountElement) {
                sendToRoleCharCountElement.textContent = '0';
                sendToRoleCharCountElement.style.color = 'var(--success)';
            }
            
            // Reset form submitted flag
            sendToRoleFormSubmitted = false;
            
            // Remove validation classes
            const form = document.getElementById('sendToRoleForm');
            form.classList.remove('was-validated');
            
            // Remove invalid classes from inputs and hide error messages
            const fields = [
                { field: 'sendToRoleRole', error: 'sendToRoleRole-error' },
                { field: 'sendToRoleType', error: 'sendToRoleType-error' },
                { field: 'sendToRoleContent', error: 'sendToRoleContent-error' }
            ];
            
            fields.forEach(({ field, error }) => {
                const fieldEl = document.getElementById(field);
                const errorEl = document.getElementById(error);
                if (fieldEl) {
                    fieldEl.classList.remove('is-invalid');
                    fieldEl.setAttribute('aria-invalid', 'false');
                    fieldEl.setCustomValidity('');
                }
                if (errorEl) {
                    errorEl.style.display = 'none';
                    errorEl.style.visibility = 'hidden';
                    errorEl.style.opacity = '0';
                    const originalMessage = errorEl.getAttribute('data-message');
                    if (originalMessage) {
                        errorEl.textContent = originalMessage;
                    }
                }
            });
        }

        function clearError(errorId) {
            const errorEl = document.getElementById(errorId);
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
                errorEl.classList.remove('alert', 'alert-danger');
            }
        }

        function showError(errorId, message) {
            const errorEl = document.getElementById(errorId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'flex';
                errorEl.classList.add('alert', 'alert-danger');
                // Scroll to error smoothly
                setTimeout(() => {
                    errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }

        // ===== SignalR Real-time Notifications =====
        let notificationConnection = null;

        async function initNotificationSignalR() {
            try {
                // Load SignalR if not already loaded
                if (typeof signalR === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }

                // Get backend URL from meta tag or default
                const metaBackendUrl = document.querySelector('meta[name="backend-url"]')?.getAttribute('content');
                const backendUrl = metaBackendUrl || 'http://apivhs.cuahangkinhdoanh.com';
                const hubUrl = `${backendUrl}/hubs/notification`;

                // Create connection
                notificationConnection = new signalR.HubConnectionBuilder()
                    .withUrl(hubUrl, {
                        accessTokenFactory: () => {
                            // Get token from session or cookie if available
                            return '';
                        },
                        skipNegotiation: false,
                        transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.ServerSentEvents | signalR.HttpTransportType.LongPolling
                    })
                    .withAutomaticReconnect({
                        nextRetryDelayInMilliseconds: retryContext => {
                            if (retryContext.elapsedMilliseconds < 60000) {
                                return 2000; // Retry after 2 seconds
                            } else {
                                return 10000; // Retry after 10 seconds
                            }
                        }
                    })
                    .configureLogging(signalR.LogLevel.Warning)
                    .build();

                // Handle connection events
                notificationConnection.onreconnecting(() => {
                    console.log('[NotificationHub] Reconnecting...');
                });

                notificationConnection.onreconnected(() => {
                    console.log('[NotificationHub] Reconnected');
                    // Join admin group after reconnection
                    if (notificationConnection.state === signalR.HubConnectionState.Connected) {
                        notificationConnection.invoke('JoinAdminGroup').catch(err => {
                            console.error('[NotificationHub] Error joining admin group:', err);
                        });
                    }
                });

                notificationConnection.onclose(() => {
                    console.log('[NotificationHub] Connection closed');
                });

                // Listen for new notifications
                notificationConnection.on('ReceiveNotification', (notification) => {
                    console.log('[NotificationHub] Received notification:', notification);
                    handleNewNotification(notification);
                });

                // Start connection
                await notificationConnection.start();
                console.log('[NotificationHub] Connected successfully');

                // Join admin group
                await notificationConnection.invoke('JoinAdminGroup');
                console.log('[NotificationHub] Joined admin group');

            } catch (error) {
                console.error('[NotificationHub] Error initializing SignalR:', error);
            }
        }

        function handleNewNotification(notification) {
            if (!notification) return;

            // Show toast notification first
            showNotificationToast(notification);

            // Update notification dropdown if exists
            updateNotificationDropdown(notification);

            // Update unread count in header
            updateUnreadCountInHeader();

            // Reload notifications list if on inbox tab (after a short delay to show toast)
            const currentTab = document.querySelector('.tab-content .tab-pane.active')?.id;
            if (currentTab === 'inbox') {
                setTimeout(() => {
                    // Reload the page to refresh notifications
                    window.location.reload();
                }, 3000); // Wait 3 seconds to show toast first
            }
        }

        function updateUnreadCountInHeader() {
            // Update the unread count badge in the header
            fetch('/Admin/AdminNotification/GetUnreadCount')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.badge-notify');
                    if (badge && data.count > 0) {
                        badge.textContent = `${data.count} ch∆∞a ƒë·ªçc`;
                        badge.style.display = 'inline-block';
                    } else if (badge) {
                        badge.style.display = 'none';
                    }
                })
                .catch(err => console.error('Error updating unread count:', err));
        }

        function showNotificationToast(notification) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">
                        <i class="bi bi-bell-fill"></i>
                    </div>
                    <div class="toast-body">
                        <div class="toast-title">Th√¥ng b√°o m·ªõi</div>
                        <div class="toast-message">${escapeHtml(notification.content || notification.Content || '')}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.remove()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateNotificationDropdown(notification) {
            // Try to update the notification dropdown in the header
            const dropdown = document.querySelector('.notif-menu');
            if (dropdown) {
                // Reload dropdown content
                fetch('/Admin/AdminNotification/GetNotificationsPartial')
                    .then(response => response.text())
                    .then(html => {
                        dropdown.innerHTML = html;
                    })
                    .catch(err => console.error('Error updating notification dropdown:', err));
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize SignalR when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initNotificationSignalR();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (notificationConnection) {
                notificationConnection.stop();
            }
        });
    </script>
}
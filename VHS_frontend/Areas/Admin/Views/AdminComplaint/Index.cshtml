@model VHS_frontend.Areas.Admin.Models.Complaint.PaginatedAdminComplaintDTO
@{
    ViewData["Title"] = "Quản lý Khiếu nại";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-complaint.css" asp-append-version="true" />
}

<div class="admin-complaint-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <div class="title-with-icon">
                    <div class="title-icon">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <div class="title-content">
                        <h1>Quản lý Khiếu nại</h1>
                        <p>Xem và xử lý các khiếu nại từ khách hàng</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-refresh" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" class="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="Status">Trạng thái</label>
                    <select name="Status" id="Status" class="filter-select">
                        <option value="">Tất cả</option>
                        <option value="Pending" selected="@(ViewBag.Filter?.Status == "Pending")">Chờ xử lý</option>
                        <option value="InReview" selected="@(ViewBag.Filter?.Status == "InReview")">Đang xem xét</option>
                        <option value="Resolved" selected="@(ViewBag.Filter?.Status == "Resolved")">Đã giải quyết</option>
                        <option value="Rejected" selected="@(ViewBag.Filter?.Status == "Rejected")">Đã từ chối</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="Type">Loại</label>
                    <select name="Type" id="Type" class="filter-select">
                        <option value="">Tất cả</option>
                        <option value="ServiceQuality" selected="@(ViewBag.Filter?.Type == "ServiceQuality")">Chất lượng dịch vụ</option>
                        <option value="ProviderBehavior" selected="@(ViewBag.Filter?.Type == "ProviderBehavior")">Hành vi nhà cung cấp</option>
                        <option value="PriceIssue" selected="@(ViewBag.Filter?.Type == "PriceIssue")">Vấn đề giá</option>
                        <option value="Delay" selected="@(ViewBag.Filter?.Type == "Delay")">Trễ hẹn</option>
                        <option value="Other" selected="@(ViewBag.Filter?.Type == "Other")">Khác</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="Search">Tìm kiếm</label>
                    <input type="text" name="Search" id="Search" class="filter-input" 
                           placeholder="Tên khách hàng, email, nhà cung cấp..." 
                           value="@ViewBag.Filter?.Search">
                </div>
                <div class="filter-group">
                    <label for="PageSize">Số lượng</label>
                    <select name="PageSize" id="PageSize" class="filter-select">
                        <option value="5" selected="@(ViewBag.Filter?.PageSize == 5)">5</option>
                        <option value="10" selected="@(ViewBag.Filter?.PageSize == 10)">10</option>
                        <option value="20" selected="@(ViewBag.Filter?.PageSize == 20)">20</option>
                        <option value="50" selected="@(ViewBag.Filter?.PageSize == 50)">50</option>
                    </select>
                </div>
                <div class="filter-group filter-actions">
                    <button type="submit" class="btn-filter">
                        <i class="bi bi-funnel"></i> Lọc
                    </button>
                    <a href="@Url.Action("Index")" class="btn-reset">
                        <i class="bi bi-x-circle"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card stat-total">
            <div class="stat-icon">
                <i class="bi bi-receipt"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@Model.TotalCount</span>
                <span class="stat-label">Tổng khiếu nại</span>
            </div>
        </div>
        <div class="stat-card stat-pending">
            <div class="stat-icon">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@Model.Complaints.Count(c => c.Status == "Pending")</span>
                <span class="stat-label">Chờ xử lý</span>
            </div>
        </div>
        <div class="stat-card stat-review">
            <div class="stat-icon">
                <i class="bi bi-search"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@Model.Complaints.Count(c => c.Status == "InReview")</span>
                <span class="stat-label">Đang xem xét</span>
            </div>
        </div>
        <div class="stat-card stat-resolved">
            <div class="stat-icon">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
                <span class="stat-value">@Model.Complaints.Count(c => c.Status == "Resolved")</span>
                <span class="stat-label">Đã giải quyết</span>
            </div>
        </div>
    </div>

    <!-- Complaints List -->
    <div class="complaints-list-container">
        <div class="list-header">
            <h2>Danh sách khiếu nại (@Model.TotalCount)</h2>
        </div>

        <div class="complaints-list">
            @if (Model.Complaints.Any())
            {
                @foreach (var complaint in Model.Complaints)
                {
                    <div class="complaint-item @complaint.Status.ToLower()">
                        <div class="complaint-header">
                            <div class="complaint-meta">
                                <div class="complaint-id">
                                    <span class="badge">#@complaint.ComplaintId.ToString().Substring(0, 8)</span>
                                </div>
                                <div class="complaint-date">
                                    <i class="bi bi-calendar3"></i>
                                    <span>@(complaint.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</span>
                                </div>
                            </div>
                            <div class="complaint-status">
                                <span class="status-badge status-@complaint.Status.ToLower()">
                                    @switch(complaint.Status)
                                    {
                                        case "Pending":
                                            <i class="bi bi-hourglass-split"></i><span> Chờ xử lý</span>
                                            break;
                                        case "InReview":
                                            <i class="bi bi-search"></i><span> Đang xem xét</span>
                                            break;
                                        case "Resolved":
                                            <i class="bi bi-check-circle"></i><span> Đã giải quyết</span>
                                            break;
                                        case "Rejected":
                                            <i class="bi bi-x-circle"></i><span> Đã từ chối</span>
                                            break;
                                        default:
                                            @complaint.Status
                                            break;
                                    }
                                </span>
                            </div>
                        </div>

                        <div class="complaint-content">
                            <div class="complaint-title">
                                <h3>@complaint.Title</h3>
                                <span class="complaint-type">@complaint.ComplaintType</span>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(complaint.Description))
                            {
                                <div class="complaint-description">
                                    <p>@complaint.Description</p>
                                </div>
                            }

                            <div class="complaint-details">
                                <div class="detail-item">
                                    <i class="bi bi-person-circle"></i>
                                    <span><strong>Khách hàng:</strong> @complaint.CustomerName</span>
                                </div>
                                @if (!string.IsNullOrEmpty(complaint.ProviderName))
                                {
                                    <div class="detail-item">
                                        <i class="bi bi-briefcase"></i>
                                        <span><strong>Nhà cung cấp:</strong> @complaint.ProviderName</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(complaint.ServiceName))
                                {
                                    <div class="detail-item">
                                        <i class="bi bi-gear"></i>
                                        <span><strong>Dịch vụ:</strong> @complaint.ServiceName</span>
                                    </div>
                                }
                                @if (complaint.DaysSinceCreated > 0)
                                {
                                    <div class="detail-item">
                                        <i class="bi bi-clock-history"></i>
                                        <span><strong>Thời gian:</strong> @complaint.DaysSinceCreated ngày trước</span>
                                    </div>
                                }
                            </div>

                            @if (complaint.AttachmentUrls != null && complaint.AttachmentUrls.Any())
                            {
                                <div class="complaint-attachments">
                                    <i class="bi bi-paperclip"></i>
                                    <span>@complaint.AttachmentUrls.Length tệp đính kèm</span>
                                </div>
                            }
                        </div>

                        <div class="complaint-actions">
                            <a href="@Url.Action("Details", new { id = complaint.ComplaintId })" 
                               class="btn-action btn-view">
                                <i class="bi bi-eye"></i>
                                Xem chi tiết
                            </a>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-inbox"></i>
                    </div>
                    <h3>Chưa có khiếu nại nào</h3>
                    <p>Hiện tại không có khiếu nại nào trong hệ thống.</p>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="pagination">
                @if (Model.HasPreviousPage)
                {
                    <a href="@Url.Action("Index", new { Page = Model.Page - 1, 
                        Status = ViewBag.Filter?.Status, 
                        Type = ViewBag.Filter?.Type, 
                        Search = ViewBag.Filter?.Search,
                        PageSize = ViewBag.Filter?.PageSize })" 
                       class="page-btn">
                        <i class="bi bi-chevron-left"></i> Trước
                    </a>
                }

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == Model.Page)
                    {
                        <span class="page-btn active">@i</span>
                    }
                    else if (i == 1 || i == Model.TotalPages || (i >= Model.Page - 2 && i <= Model.Page + 2))
                    {
                        <a href="@Url.Action("Index", new { Page = i, 
                            Status = ViewBag.Filter?.Status, 
                            Type = ViewBag.Filter?.Type, 
                            Search = ViewBag.Filter?.Search,
                            PageSize = ViewBag.Filter?.PageSize })" 
                           class="page-btn">@i</a>
                    }
                    else if (i == Model.Page - 3 || i == Model.Page + 3)
                    {
                        <span class="page-ellipsis">...</span>
                    }
                }

                @if (Model.HasNextPage)
                {
                    <a href="@Url.Action("Index", new { Page = Model.Page + 1, 
                        Status = ViewBag.Filter?.Status, 
                        Type = ViewBag.Filter?.Type, 
                        Search = ViewBag.Filter?.Search,
                        PageSize = ViewBag.Filter?.PageSize })" 
                       class="page-btn">
                        Sau <i class="bi bi-chevron-right"></i>
                    </a>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Auto refresh every 60 seconds
        setInterval(() => {
            location.reload();
        }, 60000);

        // Highlight filter inputs
        document.querySelectorAll('.filter-select, .filter-input').forEach(input => {
            input.addEventListener('change', function() {
                // Border color will be handled by CSS focus state
            });
        });
    </script>
}


@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@model VHS_frontend.Areas.Admin.Models.Complaint.ComplaintDetailsDTO
@{
    ViewData["Title"] = "Chi tiết Khiếu nại";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    
    // Lấy URL backend cho hình ảnh
    var backendUrl = Configuration["Apis:Backend"] ?? "http://localhost:5154";
    string GetFullImageUrl(string relativePath)
    {
        if (string.IsNullOrWhiteSpace(relativePath)) return "/images/placeholder.png";
        if (relativePath.StartsWith("http://") || relativePath.StartsWith("https://")) return relativePath;
        return backendUrl + relativePath;
    }
    
    // Helper function để chuyển ComplaintType sang tiếng Việt (đồng bộ với ReportService.cs)
    // Nếu là "Other" nhưng có thông tin ngân hàng trong description, tự động detect là RefundRequest
    string GetComplaintTypeVi(string? type, string? description = null)
    {
        // Tự động detect refund request từ description nếu ComplaintType là "Other"
        if (type == "Other" && !string.IsNullOrWhiteSpace(description))
        {
            var descLower = description.ToLower();
            if (descLower.Contains("--- thông tin ngân hàng để hoàn tiền ---") ||
                descLower.Contains("thông tin ngân hàng") && 
                (descLower.Contains("hoàn tiền") || descLower.Contains("refund") || 
                 descLower.Contains("tên ngân hàng") || descLower.Contains("số tài khoản")))
            {
                return "Yêu cầu hoàn tiền";
            }
        }
        
        return type switch
        {
            "ServiceQuality" => "Chất lượng dịch vụ",
            "ProviderBehavior" => "Hành vi nhà cung cấp",
            "ProviderMisconduct" => "Hành vi sai trái của provider",
            "StaffMisconduct" => "Hành vi sai trái của nhân viên",
            "PriceIssue" => "Vấn đề giá",
            "Dispute" => "Tranh chấp",
            "TechnicalIssue" => "Vấn đề kỹ thuật",
            "RefundRequest" => "Yêu cầu hoàn tiền",
            "Delay" => "Trễ hẹn",
            "Other" => "Khác",
            _ => type ?? "Khác"
        };
    }
    
    // Helper function để chuyển BookingStatus sang tiếng Việt
    string GetBookingStatusVi(string? status)
    {
        return status switch
        {
            "Pending" => "Chờ xử lý",
            "Confirmed" => "Đã xác nhận",
            "InProgress" => "Đang thực hiện",
            "Completed" => "Đã hoàn thành",
            "Cancelled" => "Đã hủy",
            "Rejected" => "Đã từ chối",
            _ => status ?? "Không xác định"
        };
    }
    
    // Helper function để tách thông tin ngân hàng khỏi description
    (string descriptionWithoutBankInfo, string? bankName, string? accountHolderName, string? accountNumber) ExtractBankInfo(string? description)
    {
        if (string.IsNullOrWhiteSpace(description))
            return (description ?? string.Empty, null, null, null);
        
        var bankInfoMarker = "--- THÔNG TIN NGÂN HÀNG ĐỂ HOÀN TIỀN ---";
        var index = description.IndexOf(bankInfoMarker, StringComparison.OrdinalIgnoreCase);
        
        if (index < 0)
            return (description, null, null, null);
        
        // Lấy phần mô tả chính (trước marker)
        var descriptionWithoutBankInfo = description.Substring(0, index).TrimEnd();
        
        // Lấy phần thông tin ngân hàng (sau marker)
        var bankInfoSection = description.Substring(index + bankInfoMarker.Length).Trim();
        
        // Parse thông tin ngân hàng
        string? bankName = null;
        string? accountHolderName = null;
        string? accountNumber = null;
        
        var lines = bankInfoSection.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var line in lines)
        {
            if (line.StartsWith("Tên ngân hàng:", StringComparison.OrdinalIgnoreCase))
            {
                bankName = line.Substring("Tên ngân hàng:".Length).Trim();
            }
            else if (line.StartsWith("Tên chủ tài khoản:", StringComparison.OrdinalIgnoreCase))
            {
                accountHolderName = line.Substring("Tên chủ tài khoản:".Length).Trim();
            }
            else if (line.StartsWith("Số tài khoản:", StringComparison.OrdinalIgnoreCase))
            {
                accountNumber = line.Substring("Số tài khoản:".Length).Trim();
            }
        }
        
        return (descriptionWithoutBankInfo, bankName, accountHolderName, accountNumber);
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-service-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin-complaint.css" asp-append-version="true" />
    <style>
        .toast-container {
            margin-top: 70px !important;
        }
        .toast {
            min-width: 350px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .toast-header {
            font-weight: 600;
        }
        .toast-body {
            padding: 0.75rem;
        }
        .bank-info-detail {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .bank-info-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            border-left: 3px solid #0d6efd;
        }
        .bank-info-item strong {
            margin-right: 0.5rem;
            min-width: 140px;
        }
        .attachment-item-compact {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            max-width: 120px;
            margin: 0 auto;
        }
        .attachment-image-wrapper-compact {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .attachment-image-compact {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .attachment-item-compact:hover .attachment-image-compact {
            transform: scale(1.05);
        }
        .attachment-overlay-compact {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 0.5rem;
        }
        .attachment-item-compact:hover .attachment-overlay-compact {
            opacity: 1;
        }
        .attachment-overlay-compact .btn {
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
}

<div class="admin-service-management">
    <!-- Toast Notification Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055; margin-top: 70px;">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong class="me-auto">Thành công!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Đóng"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                @TempData["Success"]
            </div>
        </div>
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <i class="bi bi-exclamation-circle-fill me-2"></i>
                <strong class="me-auto">Lỗi!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Đóng"></button>
            </div>
            <div class="toast-body" id="toastErrorMessage">
                @TempData["Error"]
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="admin-service-management__header">
        <h3><i class="bi bi-info-circle-fill"></i>Chi tiết Khiếu nại</h3>
        <a href="@Url.Action("Index")" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Quay lại
        </a>
    </div>

    <!-- Complaint Info -->
    <div class="row g-3 mb-4">
        <!-- Main Complaint Info -->
        <div class="col-lg-8">
            <div class="card-x">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <span><i class="bi bi-info-circle me-2"></i>Thông tin Khiếu nại</span>
                        @switch(Model.Status)
                        {
                            case "Pending":
                                <span class="status-badge status-pending">
                                    <i class="bi bi-hourglass-split"></i><span> Chờ xử lý</span>
                                </span>
                                break;
                            case "InReview":
                                <span class="status-badge status-processing">
                                    <i class="bi bi-search"></i><span> Đang xem xét</span>
                                </span>
                                break;
                            case "Resolved":
                                <span class="status-badge status-completed">
                                    <i class="bi bi-check-circle"></i><span> Đã giải quyết</span>
                                </span>
                                break;
                            case "Rejected":
                                <span class="status-badge status-canceled">
                                    <i class="bi bi-x-circle"></i><span> Đã từ chối</span>
                                </span>
                                break;
                            default:
                                <span class="badge bg-secondary">@(Model.Status ?? "Không xác định")</span>
                                break;
                        }
                    </div>
                </div>
                <div class="card-body">
                    <div class="complaint-detail-info">
                        <div class="info-row">
                            <div class="info-label">ID Khiếu nại</div>
                            <div class="info-value"><code>@Model.ComplaintId</code></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Loại khiếu nại</div>
                            <div class="info-value">
                                <span class="badge badge-type">@GetComplaintTypeVi(Model.ComplaintType, Model.Description)</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Tiêu đề</div>
                            <div class="info-value-title">@Model.Title</div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            var (descriptionWithoutBankInfo, bankName, accountHolderName, accountNumber) = ExtractBankInfo(Model.Description);
                            
                            @if (!string.IsNullOrWhiteSpace(descriptionWithoutBankInfo))
                        {
                            <div class="info-row info-row-description">
                                <div class="info-label">Mô tả</div>
                                    <div class="info-value-description">@descriptionWithoutBankInfo</div>
                                </div>
                            }
                            
                            @if (!string.IsNullOrWhiteSpace(bankName) || !string.IsNullOrWhiteSpace(accountHolderName) || !string.IsNullOrWhiteSpace(accountNumber))
                            {
                                <div class="info-row">
                                    <div class="info-label">Thông tin ngân hàng</div>
                                    <div class="info-value">
                                        <div class="bank-info-detail">
                                            @if (!string.IsNullOrWhiteSpace(bankName))
                                            {
                                                <div class="bank-info-item">
                                                    <i class="bi bi-building text-primary me-2"></i>
                                                    <strong>Tên ngân hàng:</strong> @bankName
                                                </div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(accountHolderName))
                                            {
                                                <div class="bank-info-item">
                                                    <i class="bi bi-person-badge text-primary me-2"></i>
                                                    <strong>Tên chủ tài khoản:</strong> @accountHolderName
                                                </div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(accountNumber))
                                            {
                                                <div class="bank-info-item">
                                                    <i class="bi bi-credit-card text-primary me-2"></i>
                                                    <strong>Số tài khoản:</strong> @accountNumber
                                                </div>
                                            }
                                        </div>
                                    </div>
                            </div>
                            }
                        }
                        <div class="info-row-group">
                            <div class="info-row">
                                <div class="info-label">Ngày tạo</div>
                                <div class="info-value">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    @(Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "Không có")
                                </div>
                            </div>
                            @if (Model.UpdatedAt.HasValue)
                            {
                                <div class="info-row">
                                    <div class="info-label">Ngày cập nhật</div>
                                    <div class="info-value">
                                        <i class="bi bi-clock-history me-1"></i>
                                        @Model.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attachments -->
            @if (Model.AttachmentUrls != null && Model.AttachmentUrls.Any())
            {
                <div class="card-x mb-4 mt-4">
                    <div class="card-header">
                        <span><i class="bi bi-paperclip me-2"></i>Tệp đính kèm (@Model.AttachmentUrls.Length)</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            @foreach (var attachment in Model.AttachmentUrls)
                            {
                                var fullImageUrl = GetFullImageUrl(attachment);
                                <div class="col-6 col-md-3 col-lg-2">
                                    <div class="attachment-item-compact">
                                        <div class="attachment-image-wrapper-compact">
                                            <img src="@fullImageUrl" alt="Tệp đính kèm" class="attachment-image-compact"
                                                 onerror="this.onerror=null;this.src='/images/placeholder.png';" />
                                            <div class="attachment-overlay-compact">
                                                <a href="@fullImageUrl" target="_blank" rel="noopener" class="btn btn-sm btn-light">
                                                    <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar Info -->
        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="card-x mb-3">
                <div class="card-header">
                    <span><i class="bi bi-person-circle me-2"></i>Khách hàng</span>
                </div>
                <div class="card-body">
                    <div class="sidebar-info-item">
                        <div class="sidebar-label">Tài khoản</div>
                        <div class="sidebar-value">
                            <i class="bi bi-person me-2"></i>
                            @(!string.IsNullOrWhiteSpace(Model.CustomerName) ? Model.CustomerName : (!string.IsNullOrWhiteSpace(Model.CustomerEmail) ? Model.CustomerEmail.Split('@')[0] : "Không xác định"))
                        </div>
                    </div>
                    <div class="sidebar-info-item">
                        <div class="sidebar-label">Email</div>
                        <div class="sidebar-value">
                            <i class="bi bi-envelope me-2"></i>
                            @Model.CustomerEmail
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.CustomerPhone))
                    {
                        <div class="sidebar-info-item">
                            <div class="sidebar-label">Điện thoại</div>
                            <div class="sidebar-value">
                                <i class="bi bi-telephone me-2"></i>
                                @Model.CustomerPhone
                            </div>
                        </div>
                    }
                    <div class="sidebar-info-item">
                        <div class="sidebar-label">ID Khách hàng</div>
                        <div class="sidebar-value">
                            <code>@Model.UserId</code>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provider Info -->
            @if (Model.ProviderId.HasValue)
            {
                <div class="card-x mb-3">
                    <div class="card-header">
                        <span><i class="bi bi-briefcase me-2"></i>Nhà cung cấp</span>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-info-item">
                            <div class="sidebar-label">Tên</div>
                            <div class="sidebar-value">
                                <i class="bi bi-building me-2"></i>
                                @Model.ProviderName
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.ProviderEmail))
                        {
                            <div class="sidebar-info-item">
                                <div class="sidebar-label">Email</div>
                                <div class="sidebar-value">
                                    <i class="bi bi-envelope me-2"></i>
                                    @Model.ProviderEmail
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.ProviderPhone))
                        {
                            <div class="sidebar-info-item">
                                <div class="sidebar-label">Điện thoại</div>
                                <div class="sidebar-value">
                                    <i class="bi bi-telephone me-2"></i>
                                    @Model.ProviderPhone
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Booking Info -->
            <div class="card-x">
                <div class="card-header">
                    <span><i class="bi bi-calendar-check me-2"></i>Thông tin Đặt dịch vụ</span>
                </div>
                <div class="card-body">
                    <div class="sidebar-info-item">
                        <div class="sidebar-label">Mã đặt dịch vụ</div>
                        <div class="sidebar-value">
                            <code>@Model.BookingId</code>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ServiceName))
                    {
                        <div class="sidebar-info-item">
                            <div class="sidebar-label">Dịch vụ</div>
                            <div class="sidebar-value">
                                <i class="bi bi-gear me-2"></i>
                                @Model.ServiceName
                            </div>
                        </div>
                    }
                    @if (Model.BookingDate.HasValue)
                    {
                        <div class="sidebar-info-item">
                            <div class="sidebar-label">Ngày đặt</div>
                            <div class="sidebar-value">
                                <i class="bi bi-calendar3 me-2"></i>
                                @Model.BookingDate.Value.ToString("dd/MM/yyyy")
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.BookingStatus))
                    {
                        <div class="sidebar-info-item">
                            <div class="sidebar-label">Trạng thái đặt dịch vụ</div>
                            <div class="sidebar-value">
                                <span class="badge badge-status">@GetBookingStatusVi(Model.BookingStatus)</span>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.ServiceLocation))
                    {
                        <div class="sidebar-info-item">
                            <div class="sidebar-label">Địa chỉ</div>
                            <div class="sidebar-value">
                                <i class="bi bi-geo-alt me-2"></i>
                                @Model.ServiceLocation
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Resolution Info -->
    @if (!string.IsNullOrEmpty(Model.ResolutionNote))
    {
        <div class="card-x mb-4">
            <div class="card-header bg-success bg-opacity-10">
                <span><i class="bi bi-check2-circle me-2"></i>Ghi chú xử lý</span>
            </div>
            <div class="card-body">
                <div class="resolution-note-content">
                    <i class="bi bi-chat-quote me-2"></i>
                    <p class="mb-0">@Model.ResolutionNote</p>
                </div>
            </div>
        </div>
    }

    <!-- Handle Complaint Form -->
    @if (Model.Status == "Pending" || Model.Status == "InReview")
    {
        <div class="card-x">
            <div class="card-header">
                <span><i class="bi bi-gear me-2"></i>Xử lý Khiếu nại</span>
            </div>
            <div class="card-body">
                <form method="post" asp-action="HandleComplaint" class="handle-form">
                    <input type="hidden" name="id" value="@Model.ComplaintId" />
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="Status" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                            <select name="Status" id="Status" class="form-select" required>
                                <option value="">-- Chọn trạng thái --</option>
                                <option value="InReview">Đang xem xét</option>
                                <option value="Resolved">Đã giải quyết</option>
                                <option value="Rejected">Đã từ chối</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="ResolutionNote" class="form-label">Ghi chú xử lý <span class="text-danger">*</span></label>
                        <textarea name="ResolutionNote" id="ResolutionNote" 
                                  class="form-control" 
                                  rows="6" 
                                  placeholder="Nhập ghi chú về cách xử lý khiếu nại..."
                                  required></textarea>
                        <small class="form-text text-muted mt-2">Vui lòng mô tả chi tiết cách xử lý khiếu nại này.</small>
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Xác nhận xử lý
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle me-2"></i>Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Tự động làm mới mỗi 60 giây nếu trạng thái là Pending hoặc InReview
        @if (Model.Status == "Pending" || Model.Status == "InReview")
        {
            <text>
            setInterval(() => {
                location.reload();
            }, 60000);
            </text>
        }

        // Xác thực form và thông báo toast
        document.addEventListener('DOMContentLoaded', function() {
            // Hiển thị toast nếu có thông báo thành công/lỗi từ TempData
            @if (TempData["Success"] != null)
            {
                <text>
                const successToastEl = document.getElementById('successToast');
                const successToast = new bootstrap.Toast(successToastEl, {
                    autohide: true,
                    delay: 4000 // 4 giây
                });
                successToast.show();
                </text>
            }
            @if (TempData["Error"] != null)
            {
                <text>
                const errorToastEl = document.getElementById('errorToast');
                const errorToast = new bootstrap.Toast(errorToastEl, {
                    autohide: true,
                    delay: 4000 // 4 giây
                });
                errorToast.show();
                </text>
            }

            const form = document.querySelector('.handle-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const status = document.getElementById('Status').value;
                    const note = document.getElementById('ResolutionNote').value.trim();

                    if (!status || !note) {
                        e.preventDefault();
                        // Hiển thị toast lỗi thay vì alert
                        const errorToastEl = document.getElementById('errorToast');
                        document.getElementById('toastErrorMessage').textContent = 'Vui lòng điền đầy đủ thông tin!';
                        const errorToast = new bootstrap.Toast(errorToastEl, {
                            autohide: true,
                            delay: 4000
                        });
                        errorToast.show();
                        return false;
                    }

                    // Không có hộp thoại xác nhận - chỉ submit
                    // Toast sẽ được hiển thị sau khi trang reload từ phản hồi server
                });
            }
        });
    </script>
}


@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@model VHS_frontend.Areas.Admin.Models.Complaint.ComplaintDetailsDTO
@{
    ViewData["Title"] = "Chi tiết Khiếu nại";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    
    // Get backend URL for images
    var backendUrl = Configuration["Apis:Backend"] ?? "http://localhost:5154";
    string GetFullImageUrl(string relativePath)
    {
        if (string.IsNullOrWhiteSpace(relativePath)) return "/images/placeholder.png";
        if (relativePath.StartsWith("http://") || relativePath.StartsWith("https://")) return relativePath;
        return backendUrl + relativePath;
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-service-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin-complaint.css" asp-append-version="true" />
}

<div class="admin-service-management">
    <!-- Header -->
    <div class="admin-service-management__header">
        <h3><i class="bi bi-info-circle-fill"></i>Chi tiết Khiếu nại</h3>
        <a href="@Url.Action("Index")" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Quay lại
        </a>
    </div>

    <!-- Complaint Info -->
    <div class="row g-3 mb-4">
        <!-- Main Complaint Info -->
        <div class="col-lg-8">
            <div class="card-x">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <span><i class="bi bi-info-circle me-2"></i>Thông tin Khiếu nại</span>
                        @switch(Model.Status)
                        {
                            case "Pending":
                                <span class="status-badge status-pending">
                                    <i class="bi bi-hourglass-split"></i><span> Chờ xử lý</span>
                                </span>
                                break;
                            case "InReview":
                                <span class="status-badge status-processing">
                                    <i class="bi bi-search"></i><span> Đang xem xét</span>
                                </span>
                                break;
                            case "Resolved":
                                <span class="status-badge status-completed">
                                    <i class="bi bi-check-circle"></i><span> Đã giải quyết</span>
                                </span>
                                break;
                            case "Rejected":
                                <span class="status-badge status-canceled">
                                    <i class="bi bi-x-circle"></i><span> Đã từ chối</span>
                                </span>
                                break;
                            default:
                                <span class="badge bg-secondary">@Model.Status</span>
                                break;
                        }
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">ID Khiếu nại</small>
                        <div class="fw-bold"><code>@Model.ComplaintId</code></div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Tiêu đề</small>
                        <h4 class="mb-0">@Model.Title</h4>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Loại</small>
                        <span class="badge bg-info fs-6">@Model.ComplaintType</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="mb-3">
                            <small class="text-muted d-block mb-2"><strong>Mô tả:</strong></small>
                            <p class="mb-0">@Model.Description</p>
                        </div>
                    }
                    <div class="row g-3">
                        <div class="col-md-6">
                            <small class="text-muted d-block mb-1">Ngày tạo</small>
                            <div>@(Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</div>
                        </div>
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1">Ngày cập nhật</small>
                                <div>@Model.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="card-x mb-3">
                <div class="card-header">
                    <span><i class="bi bi-person-circle me-2"></i>Khách hàng</span>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted d-block mb-1">Họ tên</small>
                        <div class="fw-semibold">@Model.CustomerName</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted d-block mb-1">Email</small>
                        <div>@Model.CustomerEmail</div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.CustomerPhone))
                    {
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">Điện thoại</small>
                            <div>@Model.CustomerPhone</div>
                        </div>
                    }
                    <div class="mb-0">
                        <small class="text-muted d-block mb-1">ID Khách hàng</small>
                        <div><code class="small">@Model.UserId</code></div>
                    </div>
                </div>
            </div>

            <!-- Provider Info -->
            @if (Model.ProviderId.HasValue)
            {
                <div class="card-x mb-3">
                    <div class="card-header">
                        <span><i class="bi bi-briefcase me-2"></i>Nhà cung cấp</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">Tên</small>
                            <div class="fw-semibold">@Model.ProviderName</div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.ProviderEmail))
                        {
                            <div class="mb-2">
                                <small class="text-muted d-block mb-1">Email</small>
                                <div>@Model.ProviderEmail</div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.ProviderPhone))
                        {
                            <div class="mb-0">
                                <small class="text-muted d-block mb-1">Điện thoại</small>
                                <div>@Model.ProviderPhone</div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Booking Info -->
            <div class="card-x">
                <div class="card-header">
                    <span><i class="bi bi-calendar-check me-2"></i>Thông tin Đặt dịch vụ</span>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted d-block mb-1">ID Booking</small>
                        <div><code class="small">@Model.BookingId</code></div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ServiceName))
                    {
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">Dịch vụ</small>
                            <div class="fw-semibold">@Model.ServiceName</div>
                        </div>
                    }
                    @if (Model.BookingDate.HasValue)
                    {
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">Ngày đặt</small>
                            <div>@Model.BookingDate.Value.ToString("dd/MM/yyyy")</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.BookingStatus))
                    {
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">Trạng thái</small>
                            <span class="badge bg-secondary">@Model.BookingStatus</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.ServiceLocation))
                    {
                        <div class="mb-0">
                            <small class="text-muted d-block mb-1">Địa chỉ</small>
                            <div>@Model.ServiceLocation</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Attachments -->
    @if (Model.AttachmentUrls != null && Model.AttachmentUrls.Any())
    {
        <div class="card-x mb-4">
            <div class="card-header">
                <span><i class="bi bi-paperclip me-2"></i>Tệp đính kèm (@Model.AttachmentUrls.Length)</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    @foreach (var attachment in Model.AttachmentUrls)
                    {
                        var fullImageUrl = GetFullImageUrl(attachment);
                        <div class="col-md-4 col-lg-3">
                            <div class="attachment-item">
                                <div class="attachment-image-wrapper">
                                    <img src="@fullImageUrl" alt="Attachment" class="attachment-image"
                                         onerror="this.onerror=null;this.src='/images/placeholder.png';" />
                                    <div class="attachment-overlay">
                                        <a href="@fullImageUrl" target="_blank" rel="noopener" class="btn btn-sm btn-light">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>Mở
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Resolution Info -->
    @if (!string.IsNullOrEmpty(Model.ResolutionNote))
    {
        <div class="card-x mb-4">
            <div class="card-header bg-success bg-opacity-10">
                <span><i class="bi bi-check2-circle me-2"></i>Ghi chú xử lý</span>
            </div>
            <div class="card-body">
                <p class="mb-0">@Model.ResolutionNote</p>
            </div>
        </div>
    }

    <!-- Handle Complaint Form -->
    @if (Model.Status == "Pending" || Model.Status == "InReview")
    {
        <div class="card-x">
            <div class="card-header">
                <span><i class="bi bi-gear me-2"></i>Xử lý Khiếu nại</span>
            </div>
            <div class="card-body">
                <form method="post" asp-action="HandleComplaint" class="handle-form">
                    <input type="hidden" name="id" value="@Model.ComplaintId" />
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="Status" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                            <select name="Status" id="Status" class="form-select" required>
                                <option value="">-- Chọn trạng thái --</option>
                                <option value="InReview">Đang xem xét</option>
                                <option value="Resolved">Đã giải quyết</option>
                                <option value="Rejected">Đã từ chối</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="ResolutionNote" class="form-label">Ghi chú xử lý <span class="text-danger">*</span></label>
                        <textarea name="ResolutionNote" id="ResolutionNote" 
                                  class="form-control" 
                                  rows="6" 
                                  placeholder="Nhập ghi chú về cách xử lý khiếu nại..."
                                  required></textarea>
                        <small class="form-text text-muted mt-2">Vui lòng mô tả chi tiết cách xử lý khiếu nại này.</small>
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Xác nhận xử lý
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle me-2"></i>Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto refresh every 60 seconds if status is Pending or InReview
        @if (Model.Status == "Pending" || Model.Status == "InReview")
        {
            <text>
            setInterval(() => {
                location.reload();
            }, 60000);
            </text>
        }

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.handle-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const status = document.getElementById('Status').value;
                    const note = document.getElementById('ResolutionNote').value.trim();

                    if (!status || !note) {
                        e.preventDefault();
                        alert('Vui lòng điền đầy đủ thông tin!');
                        return false;
                    }

                    // Confirm action based on status
                    let confirmMsg = '';
                    switch(status) {
                        case 'Resolved':
                            confirmMsg = 'Bạn có chắc muốn đánh dấu khiếu nại này là ĐÃ GIẢI QUYẾT?';
                            break;
                        case 'Rejected':
                            confirmMsg = 'Bạn có chắc muốn TỪ CHỐI khiếu nại này?';
                            break;
                        default:
                            confirmMsg = 'Bạn có chắc muốn xử lý khiếu nại này?';
                    }

                    if (!confirm(confirmMsg)) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
        });
    </script>
}


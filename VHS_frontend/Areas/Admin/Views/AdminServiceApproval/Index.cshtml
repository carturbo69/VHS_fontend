@model List<VHS_frontend.Services.Admin.AdminServiceApprovalService.PendingServiceItem>
@{
    ViewData["Title"] = "Duyệt dịch vụ";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    
    // Hàm chuyển đổi UnitType sang tiếng Việt
    string GetUnitTypeVietnamese(string? unitType)
    {
        if (string.IsNullOrEmpty(unitType)) return unitType ?? "";
        return unitType switch
        {
            "Hour" => "Giờ",
            "Day" => "Ngày",
            "Visit" => "Lần",
            "Apartment" => "Căn",
            "Room" => "Phòng",
            "SquareMeter" => "Mét vuông (m²)",
            "Person" => "Người",
            "Package" => "Gói",
            "Event" => "Sự kiện",
            _ => unitType
        };
    }
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-scissors me-2"></i>Duyệt dịch vụ đang chờ</h3>
        <a asp-area="Admin" asp-controller="AdminDashboard" asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Ảnh</th>
                                <th>Tên dịch vụ</th>
                                <th>Giá</th>
                                <th>Đơn vị</th>
                                <th>Thẻ</th>
                                <th>Trạng thái</th>
                                <th>Ngày tạo</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var i in Model)
                        {
                            // Xác định ảnh để hiển thị (ưu tiên pending nếu có)
                            var imagesToShow = !string.IsNullOrEmpty(i.PendingImages) ? i.PendingImages : i.Images;
                            var first = (imagesToShow ?? string.Empty).Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var url = string.IsNullOrEmpty(first) ? null : (first.StartsWith("http") ? first : $"http://localhost:5154{first}");
                            
                            // Xác định title và price để hiển thị (ưu tiên pending nếu có)
                            var displayTitle = !string.IsNullOrEmpty(i.PendingTitle) ? i.PendingTitle : i.Title;
                            var displayPrice = i.PendingPrice ?? i.Price;
                            var displayUnitType = !string.IsNullOrEmpty(i.PendingUnitType) ? i.PendingUnitType : i.UnitType;
                            var displayBaseUnit = i.PendingBaseUnit ?? i.BaseUnit;
                            
                            var isUpdate = i.Status == "PendingUpdate";
                            <tr>
                                <td style="width:110px">
                                    @if (!string.IsNullOrEmpty(url))
                                    {
                                        <img src="@url" class="img-thumbnail" style="width:100px;height:100px;object-fit:cover" />
                                    }
                                    else
                                    {
                                        <div class="text-muted small">Không ảnh</div>
                                    }
                                </td>
                                <td>
                                    <strong>@displayTitle</strong>
                                    @if (isUpdate)
                                    {
                                        <br />
                                        <small class="text-info">
                                            <i class="bi bi-arrow-repeat me-1"></i>
                                            Chỉnh sửa từ: <span class="text-muted">@i.CurrentTitle</span>
                                        </small>
                                    }
                                </td>
                                <td>
                                    @displayPrice.ToString("N0") VNĐ
                                    @if (isUpdate && i.CurrentPrice.HasValue && i.CurrentPrice.Value != displayPrice)
                                    {
                                        <br />
                                        <small class="text-muted">
                                            <del>@i.CurrentPrice.Value.ToString("N0") VNĐ</del>
                                        </small>
                                    }
                                </td>
                                <td>@GetUnitTypeVietnamese(displayUnitType) (@displayBaseUnit)</td>
                                <td>
                                    @{
                                        // Xác định Tags để hiển thị (ưu tiên pending nếu có)
                                        var tagsToShow = isUpdate && i.PendingTags != null && i.PendingTags.Any() 
                                            ? i.PendingTags 
                                            : (isUpdate && i.CurrentTags != null && i.CurrentTags.Any() 
                                                ? i.CurrentTags 
                                                : (i.Tags ?? new List<VHS_frontend.Services.Admin.AdminServiceApprovalService.TagInfo>()));
                                        
                                        // Kiểm tra xem tags có thay đổi không (chỉ khi có pending update)
                                        var hasTagChanges = false;
                                        if (isUpdate && i.PendingTags != null && i.PendingTags.Any() && i.CurrentTags != null && i.CurrentTags.Any())
                                        {
                                            var pendingTagNames = i.PendingTags.Select(t => t.Name).OrderBy(x => x).ToList();
                                            var currentTagNames = i.CurrentTags.Select(t => t.Name).OrderBy(x => x).ToList();
                                            hasTagChanges = !pendingTagNames.SequenceEqual(currentTagNames);
                                        }
                                    }
                                    @if (tagsToShow.Any())
                                    {
                                        // Hiển thị tags mới (pending hoặc current)
                                        foreach (var tag in tagsToShow)
                                        {
                                            <span class="badge bg-info me-1">@tag.Name</span>
                                        }
                                        // Chỉ hiển thị tags cũ nếu thực sự có thay đổi
                                        @if (hasTagChanges)
                                        {
                                            <br />
                                            <small class="text-muted">
                                                <del>
                                                    @foreach (var tag in i.CurrentTags)
                                                    {
                                                        <span class="badge bg-secondary me-1">@tag.Name</span>
                                                    }
                                                </del>
                                            </small>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">Không có</span>
                                    }
                                </td>
                                <td>
                                    @if (isUpdate)
                                    {
                                        <span class="badge bg-info">Chờ duyệt chỉnh sửa</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Chờ duyệt mới</span>
                                    }
                                </td>
                                <td>
                                    @if (isUpdate && i.PendingUpdatedAt.HasValue)
                                    {
                                        <span class="text-info">Cập nhật: @i.PendingUpdatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                                        <br />
                                        <small class="text-muted">Tạo: @(i.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")</small>
                                    }
                                    else
                                    {
                                        @(i.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")
                                    }
                                </td>
                                <td class="text-end">
                                    <a asp-action="Detail" asp-route-id="@i.ServiceId" class="btn btn-outline-secondary btn-sm me-2">
                                        <i class="bi bi-eye me-1"></i>Xem
                                    </a>
                                    <form asp-action="Approve" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@i.ServiceId" />
                                        <button type="submit" class="btn btn-approval btn-approval-approve">
                                            <i class="bi bi-check2 me-1"></i>@(isUpdate ? "Duyệt chỉnh sửa" : "Duyệt")
                                        </button>
                                    </form>
                                    <button class="btn btn-approval btn-approval-reject ms-2" data-bs-toggle="modal" data-bs-target="#rejectModal" data-id="@i.ServiceId" data-status="@i.Status">
                                        <i class="bi bi-x-lg me-1"></i>Từ chối
                                    </button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">Không có dịch vụ nào đang chờ.</div>
            }
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Lý do từ chối</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form asp-action="Reject" method="post">
        <div class="modal-body">
            <input type="hidden" name="id" id="rejectId" />
            <textarea class="form-control" name="reason" rows="4" placeholder="Nhập lý do (tuỳ chọn)"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-danger">Xác nhận từ chối</button>
        </div>
      </form>
    </div>
  </div>
  </div>

<script>
    var rejectModal = document.getElementById('rejectModal');
    rejectModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var id = button.getAttribute('data-id');
        document.getElementById('rejectId').value = id;
    });
</script>



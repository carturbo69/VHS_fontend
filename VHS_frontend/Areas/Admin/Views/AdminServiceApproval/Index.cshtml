@model List<VHS_frontend.Services.Admin.AdminServiceApprovalService.PendingServiceItem>
@{
    ViewData["Title"] = "Duyệt dịch vụ";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-scissors me-2"></i>Duyệt dịch vụ đang chờ</h3>
        <a asp-area="Admin" asp-controller="AdminDashboard" asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Ảnh</th>
                                <th>Tên dịch vụ</th>
                                <th>Giá</th>
                                <th>Đơn vị</th>
                                <th>Ngày tạo</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var i in Model)
                        {
                            var first = (i.Images ?? string.Empty).Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var url = string.IsNullOrEmpty(first) ? null : (first.StartsWith("http") ? first : $"http://localhost:5154{first}");
                            <tr>
                                <td style="width:110px">
                                    @if (!string.IsNullOrEmpty(url))
                                    {
                                        <img src="@url" class="img-thumbnail" style="width:100px;height:100px;object-fit:cover" />
                                    }
                                    else
                                    {
                                        <div class="text-muted small">Không ảnh</div>
                                    }
                                </td>
                                <td>@i.Title</td>
                                <td>@i.Price.ToString("N0") VNĐ</td>
                                <td>@i.UnitType (@(i.BaseUnit ?? 0))</td>
                                <td>@(i.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                                <td class="text-end">
                                    <a asp-action="Detail" asp-route-id="@i.ServiceId" class="btn btn-sm btn-outline-primary me-2">
                                        <i class="bi bi-eye me-1"></i>Xem
                                    </a>
                                    <form asp-action="Approve" method="post" class="d-inline">
                                        <input type="hidden" name="id" value="@i.ServiceId" />
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="bi bi-check2 me-1"></i>Duyệt
                                        </button>
                                    </form>
                                    <button class="btn btn-sm btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#rejectModal" data-id="@i.ServiceId">
                                        <i class="bi bi-x-lg me-1"></i>Từ chối
                                    </button>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">Không có dịch vụ nào đang chờ.</div>
            }
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Lý do từ chối</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form asp-action="Reject" method="post">
        <div class="modal-body">
            <input type="hidden" name="id" id="rejectId" />
            <textarea class="form-control" name="reason" rows="4" placeholder="Nhập lý do (tuỳ chọn)"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-danger">Xác nhận từ chối</button>
        </div>
      </form>
    </div>
  </div>
  </div>

<script>
    var rejectModal = document.getElementById('rejectModal');
    rejectModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var id = button.getAttribute('data-id');
        document.getElementById('rejectId').value = id;
    });
</script>



@model List<VHS_frontend.Services.Admin.AdminServiceApprovalService.PendingServiceItem>
@{
    ViewData["Title"] = "Duyệt dịch vụ";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    
    // Thống kê
    var totalPending = Model?.Count ?? 0;
    var pendingNew = Model?.Count(p => p.Status == "Pending") ?? 0;
    var pendingUpdate = Model?.Count(p => p.Status == "PendingUpdate") ?? 0;
    
    // Hàm chuyển đổi UnitType sang tiếng Việt
    string GetUnitTypeVietnamese(string? unitType)
    {
        if (string.IsNullOrEmpty(unitType)) return unitType ?? "";
        return unitType switch
        {
            "Hour" => "Giờ",
            "Day" => "Ngày",
            "Visit" => "Lần",
            "Apartment" => "Căn",
            "Room" => "Phòng",
            "SquareMeter" => "Mét vuông (m²)",
            "Person" => "Người",
            "Package" => "Gói",
            "Event" => "Sự kiện",
            _ => unitType
        };
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-service-management.css" asp-append-version="true" />
}

<div class="admin-service-management">
    <!-- Header -->
    <div class="admin-service-management__header">
        <h3><i class="bi bi-clipboard-check-fill"></i>Duyệt dịch vụ đang chờ</h3>
        <a asp-area="Admin" asp-controller="AdminDashboard" asp-action="Index" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Quay lại
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
        </div>
    }

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4 col-sm-6">
            <div class="card-x stat-card">
                <div class="stat-card__icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-card__content">
                    <div class="stat-card__value" id="statTotalPending">@totalPending</div>
                    <div class="stat-card__label">Tổng dịch vụ chờ duyệt</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card-x stat-card">
                <div class="stat-card__icon" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);">
                    <i class="bi bi-plus-circle"></i>
                </div>
                <div class="stat-card__content">
                    <div class="stat-card__value" id="statPendingNew">@pendingNew</div>
                    <div class="stat-card__label">Dịch vụ mới</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card-x stat-card">
                <div class="stat-card__icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
                <div class="stat-card__content">
                    <div class="stat-card__value" id="statPendingUpdate">@pendingUpdate</div>
                    <div class="stat-card__label">Chờ duyệt chỉnh sửa</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-x">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>Danh sách dịch vụ chờ duyệt</span>
            <span class="badge bg-secondary" id="serviceCount">@totalPending dịch vụ</span>
        </div>
        <div class="card-body">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th><i class="bi bi-image me-2"></i>Ảnh</th>
                                <th><i class="bi bi-tag me-2"></i>Tên dịch vụ</th>
                                <th><i class="bi bi-currency-exchange me-2"></i>Giá</th>
                                <th><i class="bi bi-rulers me-2"></i>Đơn vị</th>
                                <th><i class="bi bi-bookmark me-2"></i>Thẻ</th>
                                <th><i class="bi bi-info-circle me-2"></i>Trạng thái</th>
                                <th><i class="bi bi-calendar me-2"></i>Ngày tạo</th>
                                <th class="text-end"><i class="bi bi-gear me-2"></i>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var i in Model)
                        {
                            // Xác định ảnh để hiển thị (ưu tiên pending nếu có)
                            var imagesToShow = !string.IsNullOrEmpty(i.PendingImages) ? i.PendingImages : i.Images;
                            var first = (imagesToShow ?? string.Empty).Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var url = string.IsNullOrEmpty(first) ? null : (first.StartsWith("http") ? first : $"https://apivhs.cuahangkinhdoanh.com{first}");
                            
                            // Xác định title và price để hiển thị (ưu tiên pending nếu có)
                            var displayTitle = !string.IsNullOrEmpty(i.PendingTitle) ? i.PendingTitle : i.Title;
                            var displayPrice = i.PendingPrice ?? i.Price;
                            var displayUnitType = !string.IsNullOrEmpty(i.PendingUnitType) ? i.PendingUnitType : i.UnitType;
                            var displayBaseUnit = i.PendingBaseUnit ?? i.BaseUnit;
                            
                            var isUpdate = i.Status == "PendingUpdate";
                            <tr>
                                <td style="width:110px">
                                    @if (!string.IsNullOrEmpty(url))
                                    {
                                        <img src="@url" class="service-thumbnail rounded" style="width:80px;height:80px;object-fit:cover" />
                                    }
                                    else
                                    {
                                        <div class="service-thumbnail-placeholder">
                                            <i class="bi bi-image"></i>
                                        </div>
                                    }
                                </td>
                                <td>
                                    <strong>@displayTitle</strong>
                                    @if (isUpdate && !string.IsNullOrEmpty(i.CurrentTitle))
                                    {
                                        <br />
                                        <small class="text-info">
                                            <i class="bi bi-arrow-repeat me-1"></i>
                                            Chỉnh sửa từ: <span class="text-muted">@i.CurrentTitle</span>
                                        </small>
                                    }
                                </td>
                                <td>
                                    <strong class="text-success">@displayPrice.ToString("N0") VNĐ</strong>
                                    @if (isUpdate && i.CurrentPrice.HasValue && i.CurrentPrice.Value != displayPrice)
                                    {
                                        <br />
                                        <small class="text-muted">
                                            <del>@i.CurrentPrice.Value.ToString("N0") VNĐ</del>
                                        </small>
                                    }
                                </td>
                                <td>@GetUnitTypeVietnamese(displayUnitType) (@displayBaseUnit)</td>
                                <td>
                                    @{
                                        // Xác định Tags để hiển thị (ưu tiên pending nếu có)
                                        var tagsToShow = isUpdate && i.PendingTags != null && i.PendingTags.Any() 
                                            ? i.PendingTags 
                                            : (isUpdate && i.CurrentTags != null && i.CurrentTags.Any() 
                                                ? i.CurrentTags 
                                                : (i.Tags ?? new List<VHS_frontend.Services.Admin.AdminServiceApprovalService.TagInfo>()));
                                        
                                        // Kiểm tra xem tags có thay đổi không (chỉ khi có pending update)
                                        var hasTagChanges = false;
                                        if (isUpdate && i.PendingTags != null && i.PendingTags.Any() && i.CurrentTags != null && i.CurrentTags.Any())
                                        {
                                            var pendingTagNames = i.PendingTags.Select(t => t.Name).OrderBy(x => x).ToList();
                                            var currentTagNames = i.CurrentTags.Select(t => t.Name).OrderBy(x => x).ToList();
                                            hasTagChanges = !pendingTagNames.SequenceEqual(currentTagNames);
                                        }
                                    }
                                    @if (tagsToShow.Any())
                                    {
                                        @foreach (var tag in tagsToShow.Take(3))
                                        {
                                            <span class="badge bg-info me-1" style="font-size: 0.7rem;">@tag.Name</span>
                                        }
                                        @if (tagsToShow.Count > 3)
                                        {
                                            <span class="text-muted small">+@(tagsToShow.Count - 3)</span>
                                        }
                                        @if (hasTagChanges)
                                        {
                                            <br />
                                            <small class="text-muted">
                                                <del>
                                                    @foreach (var tag in i.CurrentTags.Take(2))
                                                    {
                                                        <span class="badge bg-secondary me-1" style="font-size: 0.65rem;">@tag.Name</span>
                                                    }
                                                    @if (i.CurrentTags.Count > 2)
                                                    {
                                                        <span class="text-muted">...</span>
                                                    }
                                                </del>
                                            </small>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td>
                                    @if (isUpdate)
                                    {
                                        <span class="badge bg-info">Chờ duyệt chỉnh sửa</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Chờ duyệt mới</span>
                                    }
                                </td>
                                <td>
                                    @if (isUpdate && i.PendingUpdatedAt.HasValue)
                                    {
                                        <span class="text-info small">Cập nhật: @i.PendingUpdatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                                        <br />
                                        <small class="text-muted">Tạo: @(i.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")</small>
                                    }
                                    else
                                    {
                                        <span class="small">@(i.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-")</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="d-flex gap-2 justify-content-end align-items-center flex-wrap">
                                        <a asp-action="Detail" asp-route-id="@i.ServiceId" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-eye me-1"></i>Xem chi tiết
                                        </a>
                                        <form asp-action="Approve" method="post" class="d-inline m-0">
                                            <input type="hidden" name="id" value="@i.ServiceId" />
                                            <button type="submit" class="btn btn-approval btn-approval-approve btn-sm">
                                                <i class="bi bi-check2 me-1"></i>@(isUpdate ? "Duyệt" : "Duyệt")
                                            </button>
                                        </form>
                                        <button class="btn btn-approval btn-approval-reject btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#rejectModal_@i.ServiceId" 
                                                data-id="@i.ServiceId" 
                                                data-status="@i.Status">
                                            <i class="bi bi-x-lg me-1"></i>Từ chối
                                        </button>
                                        
                                        <!-- Reject Modal for each service -->
                                        <div class="modal fade" id="rejectModal_@i.ServiceId" tabindex="-1" aria-labelledby="rejectModalLabel_@i.ServiceId" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="rejectModalLabel_@i.ServiceId">
                                                            <i class="bi bi-x-circle me-2"></i>Lý do từ chối
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <form asp-action="Reject" method="post">
                                                        <div class="modal-body">
                                                            <input type="hidden" name="id" value="@i.ServiceId" />
                                                            <label class="form-label">Lý do từ chối (tuỳ chọn)</label>
                                                            <textarea class="form-control" name="reason" rows="4" placeholder="Nhập lý do từ chối dịch vụ này..."></textarea>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                                <i class="bi bi-x me-1"></i>Hủy
                                                            </button>
                                                            <button type="submit" class="btn btn-danger">
                                                                <i class="bi bi-check-lg me-1"></i>Xác nhận từ chối
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3 mb-0">Không có dịch vụ nào đang chờ duyệt.</p>
                </div>
            }
        </div>
    </div>
</div>



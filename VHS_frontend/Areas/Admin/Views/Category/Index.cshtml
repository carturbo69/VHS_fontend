@using VHS_frontend.Areas.Admin.Models.Category
@using VHS_frontend.Areas.Admin.Models.Tag
@model List<CategoryDTO>

@{
    ViewData["Title"] = "Quản lý danh mục";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    var includeDeleted = (bool)(ViewData["IncludeDeleted"] ?? false);
    var total = Model.Count;
    var active = Model.Count(x => x.IsDeleted != true);
    var deleted = Model.Count(x => x.IsDeleted == true);
}

@section Styles {
    <link rel="stylesheet" href="~/css/category.css" asp-append-version="true" />
    <style>
        .cat-page.container-fluid {
            overflow-x: visible; /* Cho phép scroll ngang trên mobile */
            max-width: 100vw !important;
            width: 100% !important;
        }
        
        /* Chỉ ẩn overflow-x trên desktop lớn */
        @@media (min-width: 1200px) {
            .cat-page.container-fluid {
                overflow-x: hidden;
            }
            body {
                overflow-x: hidden;
            }
        }
    </style>
}

<section class="cat-page container-fluid">
    <!-- Header / Metrics -->
    <div class="cat-head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-collection"></i></div>
            <div>
                <h3>Danh mục</h3>
                <div class="sub">Quản lý danh mục &amp; tag con</div>
            </div>
        </div>
        <div class="right">
            <div class="pill"><span class="lbl">Tổng</span><span class="val">@total</span></div>
            <div class="pill good"><span class="lbl">Hoạt động</span><span class="val">@active</span></div>
            <div class="pill mute"><span class="lbl">Đã xoá</span><span class="val">@deleted</span></div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="toolbar-card card-x">
    <div class="cat-toolbar">
        <div class="actions">
            <button class="btn btn-primary soft" id="btnCreate">
                <i class="bi bi-plus-circle"></i> Thêm danh mục
            </button>

            <a class="btn btn-ghost soft"
               asp-area="Admin" asp-controller="Category" asp-action="Index"
               asp-route-includeDeleted="@( !includeDeleted )">
                <i class="bi @(includeDeleted ? "bi-eye-slash" : "bi-eye")"></i>
                @(includeDeleted ? "Ẩn đã xoá" : "Hiện cả đã xoá")
            </a>
        </div>

        <div class="search">
            <i class="bi bi-search"></i>
            <input id="txtSearch" class="form-control" placeholder="Tìm danh mục theo tên…" />
            </div>
        </div>
    </div>

    <!-- Table Card -->
    <div class="table-card card-x">
        <div class="table-wrap">
        <table class="table table-hover align-middle mb-0" id="tblCats">
            <thead>
                <tr>
                    <th style="width:100px;">Nhánh</th>
                    <th>Tên danh mục</th>
                    <th style="width:160px;">Trạng thái</th>
                    <th style="width:260px;" class="text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count; i++)
                {
                    var item = Model[i];
                    <tr data-id="@item.CategoryId" class="cat-row @(item.IsDeleted == true ? "deleted" : "")">
                        <td>
                            <div class="branch">
                                <button class="btn toggle-tags soft"
                                        data-target="#tags-@item.CategoryId" aria-expanded="false" title="Mở danh sách tag">
                                    <i class="bi bi-caret-right-fill"></i>
                                </button>
                                <!-- CHIP ĐẾM TAG (TRÊN) -->
                                <span class="chip chip-count" data-count-for="@item.CategoryId">–</span>
                            </div>
                        </td>
                        <td class="cat-name fw-semibold @(item.IsDeleted == true ? "cut" : "")">@item.Name</td>
                        <td>
                            @if (item.IsDeleted == true)
                            {
                                <span class="state del">Đã xoá</span>
                            }
                            else
                            {
                                <span class="state ok">Hoạt động</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary soft btn-edit" @(item.IsDeleted == true ? "disabled" : "")>
                                    <i class="bi bi-pencil-square"></i> Sửa
                                </button>
                                @if (item.IsDeleted == true)
                                {
                                    <button class="btn btn-sm btn-outline-warning soft btn-restore-cat">
                                        <i class="bi bi-arrow-counterclockwise"></i> Khôi phục
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger soft btn-delete-cat">
                                        <i class="bi bi-trash"></i> Xoá
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>

                    <!-- Row con: danh sách tag -->
                    <tr class="tag-row">
                        <td colspan="4" class="p-0">
                            <div id="tags-@item.CategoryId" class="tags-box collapse card-x" data-category-id="@item.CategoryId">
                                <div class="tags-top">
                                    <div class="ttl">
                                        <i class="bi bi-tags-fill"></i>
                                        <strong>Thẻ</strong>
                                        <span class="hint">(nhánh con)</span>
                                    </div>
                                    <div class="top-right">
                                        <!-- CHIP ĐẾM TAG (DƯỚI) -->
                                        <span class="chip chip-mini chip-count-bottom" data-count-for="@item.CategoryId">0</span>
                                        <button class="btn btn-sm btn-outline-success soft btn-add-tag" data-category-id="@item.CategoryId">
                                            <i class="bi bi-plus-lg"></i> Thêm tag
                                        </button>
                                    </div>
                                </div>
                                <ul class="list-group tag-list" data-category-id="@item.CategoryId">
                                    <li class="list-group-item note">Nhấn mũi tên để tải danh sách tag…</li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</section>

<!-- Toast notification root -->
<div id="notif-root"></div>

<!-- Modal: Category -->
<div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x" id="catForm">
            <div class="modal-header">
                <h5 class="modal-title" id="catModalTitle">Thêm danh mục</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="catId" />
                <div class="mb-3">
                    <label class="form-label">Tên danh mục</label>
                    <input type="text" id="catName" class="form-control" maxlength="100" required />
                    <div class="invalid-feedback">Vui lòng nhập tên danh mục.</div>
                </div>
                <div id="catError" class="text-danger small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary soft" id="btnSaveCat">Lưu</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Tag -->
<div class="modal fade" id="tagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x" id="tagForm">
            <div class="modal-header">
                <h5 class="modal-title" id="tagModalTitle">Thêm tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tagId" />
                <input type="hidden" id="tagCategoryId" />
                <div class="mb-3">
                    <label class="form-label">Tên tag</label>
                    <input type="text" id="tagName" class="form-control" maxlength="100" required />
                    <div class="invalid-feedback">Vui lòng nhập tên tag.</div>
                </div>
                <div id="tagError" class="text-danger small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary soft" id="btnSaveTag">Lưu</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Option -->
<div class="modal fade" id="optionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x" id="optionForm">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="optionModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Thêm tùy chọn
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="optionId" />
                <input type="hidden" id="optionTagId" />
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-card-heading me-1"></i>Tên tùy chọn <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="optionName" class="form-control" maxlength="255" required placeholder="Nhập tên tùy chọn..." />
                    <div class="invalid-feedback">Vui lòng nhập tên tùy chọn.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-tags me-1"></i>Loại <span class="text-danger">*</span>
                    </label>
                    <select id="optionType" class="form-select" required>
                        <option value="">-- Chọn loại tùy chọn --</option>
                        <option value="checkbox">☑ Chọn nhiều</option>
                        <option value="radio">🔘 Chọn một</option>
                        <option value="textarea">📝 Nhập văn bản</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn loại tùy chọn.</div>
                </div>
                <div class="mb-3" id="optionFamilyGroup" style="display: none;">
                    <label class="form-label">
                        <i class="bi bi-diagram-3 me-1"></i>Nhóm <span class="text-muted small">(Cho radio buttons - chọn 1 trong nhiều)</span>
                    </label>
                    <select id="optionFamily" class="form-select">
                        <option value="">-- Tạo nhóm mới --</option>
                    </select>
                    <input type="hidden" id="optionFamilyUUID" />
                    <small class="text-muted d-block mt-1">
                        <i class="bi bi-info-circle me-1"></i>Radio buttons cần nhóm để chọn 1 trong nhiều. Checkbox không cần nhóm hoặc có thể chọn nhóm tùy ý.
                    </small>
                </div>
                <div id="optionError" class="text-danger small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary soft" id="btnSaveOption">Lưu</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        /* ======= CENTER TOAST (boxed + accent bar + fast) ======= */
        (function(){
          var toastManager = {
            currentToast: null,
            hideTimeout: null,
            removeTimeout: null,
            
            clearAll: function(){
              // Clear tất cả timeout
              if(this.hideTimeout){
                clearTimeout(this.hideTimeout);
                this.hideTimeout = null;
              }
              if(this.removeTimeout){
                clearTimeout(this.removeTimeout);
                this.removeTimeout = null;
              }
              
              // Xóa toast hiện tại
              if(this.currentToast && this.currentToast.parentNode){
                this.currentToast.classList.remove('show');
                var self = this;
                setTimeout(function(){
                  if(self.currentToast && self.currentToast.parentNode){
                    self.currentToast.remove();
                  }
                  self.currentToast = null;
                }, 100);
              }
              
              // Xóa tất cả toast còn sót trong DOM
              var root = document.getElementById('notif-root');
              if(root){
                var existingToasts = root.querySelectorAll('.center-toast');
                for(var i = 0; i < existingToasts.length; i++){
                  var toast = existingToasts[i];
                  if(toast.parentNode){
                    toast.classList.remove('show');
                    toast.remove();
                  }
                }
              }
            },
            
            show: function(msg, type, duration){
              if(!type) type = 'info';
              if(!duration) duration = 2500;
              
              // Xóa toast cũ trước
              this.clearAll();
              
              var root = document.getElementById('notif-root');
              if(!root) return;
              
              // Tạo toast mới
              var box = document.createElement('div');
              box.className = 'center-toast ' + type;
              var iconClass = type==='success'?'bi-check-circle':
                               type==='error'  ?'bi-x-circle'   :
                               type==='warn'   ?'bi-exclamation-triangle' : 'bi-info-circle';
              box.innerHTML = 
                '<div class="toast-box">' +
                  '<div class="accent"></div>' +
                  '<i class="bi ' + iconClass + '"></i>' +
                  '<span class="msg">' + msg + '</span>' +
                '</div>';
              
              root.appendChild(box);
              this.currentToast = box;
              
              var self = this;
              
              // Hiển thị với animation
              setTimeout(function(){ 
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.add('show'); 
                }
              }, 50);

              // Tự động ẩn sau duration
              this.hideTimeout = setTimeout(function() {
                if(self.currentToast && self.currentToast.parentNode){
                  self.currentToast.classList.remove('show');
                  self.removeTimeout = setTimeout(function(){ 
                    if(self.currentToast && self.currentToast.parentNode){
                      self.currentToast.remove();
                    }
                    self.currentToast = null;
                    self.hideTimeout = null;
                    self.removeTimeout = null;
                  }, 350);
                }
              }, duration);
            }
          };
          
          window.showNotice = function(msg, type, duration){
            toastManager.show(msg, type, duration);
          };
        })();

        const routes = {
          catCreate : '@Url.Action("Create", "Category", new { area = "Admin" })',
          catGet    : '@Url.Action("Get", "Category", new { area = "Admin" })',
          catUpdate : '@Url.Action("Update", "Category", new { area = "Admin" })',
          catDelete : '@Url.Action("Delete", "Category", new { area = "Admin" })',
          catRestore: '@Url.Action("Restore", "Category", new { area = "Admin" })',
          tagsByCat : '@Url.Action("GetTags", "Category", new { area = "Admin" })',
          tagCreate : '@Url.Action("CreateTag", "Category", new { area = "Admin" })',
          tagUpdate : '@Url.Action("UpdateTag", "Category", new { area = "Admin" })',
          tagDelete : '@Url.Action("DeleteTag", "Category", new { area = "Admin" })',
          tagRestore: '@Url.Action("RestoreTag", "Category", new { area = "Admin" })',
          optionsByTag : '@Url.Action("GetOptions", "Category", new { area = "Admin" })',
          optionCreate : '@Url.Action("CreateOption", "Category", new { area = "Admin" })',
          optionUpdate : '@Url.Action("UpdateOption", "Category", new { area = "Admin" })',
          optionDelete : '@Url.Action("DeleteOption", "Category", new { area = "Admin" })'
        };
        const includeDeleted = @includeDeleted.ToString().ToLower();


        // Search
        document.getElementById('txtSearch').addEventListener('input', function(){
          const q = this.value.toLowerCase().trim();
          document.querySelectorAll('#tblCats tbody tr.cat-row').forEach(tr=>{
            const name = tr.querySelector('.cat-name').textContent.toLowerCase();
            const show = name.includes(q);
            tr.style.display = show ? '' : 'none';
            const next = tr.nextElementSibling;
            if (next?.classList.contains('tag-row')) next.style.display = show ? '' : 'none';
          });
        });

        // Modals
        const catModal = new bootstrap.Modal(document.getElementById('catModal'));
        const catIdEl = document.getElementById('catId');
        const catNameEl = document.getElementById('catName');
        const catErr = document.getElementById('catError');
        document.getElementById('btnCreate').addEventListener('click', ()=>{
          document.getElementById('catModalTitle').textContent = 'Thêm danh mục';
          catIdEl.value=''; catNameEl.value=''; catErr.textContent='';
          catNameEl.classList.remove('is-invalid');
          catModal.show();
        });
        catNameEl.addEventListener('input', ()=> { if (catNameEl.value.trim()) catNameEl.classList.remove('is-invalid'); });

        // Table events
        document.getElementById('tblCats').addEventListener('click', async (e)=>{
          const btn = e.target.closest('button'); if (!btn) return;
          const row = btn.closest('tr.cat-row') ?? btn.closest('tr')?.previousElementSibling;
          const id = row?.dataset?.id; if (!id) return;

          // toggle tags
          if (btn.classList.contains('toggle-tags')) {
            const targetSel = btn.getAttribute('data-target');
            const pane = document.querySelector(targetSel);
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', (!expanded).toString());
            btn.querySelector('i').className = expanded ? 'bi bi-caret-right-fill' : 'bi bi-caret-down-fill';

            if (!pane.classList.contains('loaded')) {
              await loadTags(id, pane); pane.classList.add('loaded');
            }
            pane.classList.toggle('show');
            row.classList.toggle('open', pane.classList.contains('show'));
            return;
          }

          // edit
          if (btn.classList.contains('btn-edit')) {
            const res = await fetch(routes.catGet + `?id=${id}`);
            if (!res.ok) { showNotice('Không đọc được dữ liệu', 'error', 3000); return; }
            const dto = await res.json();
            document.getElementById('catModalTitle').textContent = 'Sửa danh mục';
            catIdEl.value = dto.categoryId;
            catNameEl.value = dto.name;
            catErr.textContent = '';
            catModal.show(); return;
          }

           // delete
           if (btn.classList.contains('btn-delete-cat')) {
             const res = await fetch(routes.catDelete + `?id=${id}`, { method:'DELETE' });
             if (res.status === 204) {
               // Hide immediately when successful
               if (!includeDeleted) {
                 row.style.display = 'none';
                 const tagRow = row.nextElementSibling;
                 if (tagRow && tagRow.classList.contains('tag-row')) {
                   tagRow.style.display = 'none';
                 }
               } else {
                 // Update UI when showing deleted items
                 row.classList.add('deleted');
                 const catName = row.querySelector('.cat-name');
                 const priI = row.querySelector('.pri-i');
                 const state = row.querySelector('.state');
                 
                 if (catName) catName.classList.add('cut');
                 if (priI) priI.classList.add('muted-i');
                 if (state) state.innerHTML = '<span class="state del">Đã xoá</span>';
                 
                 btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Khôi phục';
                 btn.className = 'btn btn-sm btn-warning soft btn-restore-cat';
                 
                 const editBtn = btn.closest('.btn-group').querySelector('.btn-edit');
                 if (editBtn) editBtn.disabled = true;
                 
                 const tagRow = row.nextElementSibling;
                 if (tagRow && tagRow.classList.contains('tag-row')) {
                   tagRow.style.opacity = '0.6';
                 }
               }
               
               // Update metrics immediately
               updateMetrics();
               
               // Show success message
               showNotice('Xóa danh mục thành công!', 'success', 2500);
             } else {
               const errorText = await res.text();
               showNotice(errorText || 'Không thể xóa danh mục', 'error', 3000);
             }
             return;
           }

           // restore
           if (btn.classList.contains('btn-restore-cat')) {
             const res = await fetch(routes.catRestore + `?id=${id}`, { method:'POST' });
             if (res.status === 204) {
               // Hide immediately when successful
               if (!includeDeleted) {
                 row.style.display = 'none';
                 const tagRow = row.nextElementSibling;
                 if (tagRow && tagRow.classList.contains('tag-row')) {
                   tagRow.style.display = 'none';
                 }
               } else {
                 // Update UI when showing deleted items
                 row.classList.remove('deleted');
                 const catName = row.querySelector('.cat-name');
                 const priI = row.querySelector('.pri-i');
                 const state = row.querySelector('.state');
                 
                 if (catName) catName.classList.remove('cut');
                 if (priI) priI.classList.remove('muted-i');
                 if (state) state.innerHTML = '<span class="state ok">Hoạt động</span>';
                 
                 btn.innerHTML = '<i class="bi bi-trash"></i> Xoá';
                 btn.className = 'btn btn-sm btn-outline-danger soft btn-delete-cat';
                 
                 const editBtn = btn.closest('.btn-group').querySelector('.btn-edit');
                 if (editBtn) editBtn.disabled = false;
                 
                 const tagRow = row.nextElementSibling;
                 if (tagRow && tagRow.classList.contains('tag-row')) {
                   tagRow.style.opacity = '';
                 }
               }
               
               // Update metrics immediately
               updateMetrics();
               
               // Show success message
               showNotice('Khôi phục danh mục thành công!', 'success', 2500);
             } else {
               const errorText = await res.text();
               showNotice(errorText || 'Không thể khôi phục danh mục', 'error', 3000);
             }
             return;
           }
        });

        // Save category
        document.getElementById('catForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const id = catIdEl.value.trim();
          const name = catNameEl.value.trim();
          if (!name){ catNameEl.classList.add('is-invalid'); return; }
          
          // Client-side validation: check for duplicate names
          const existingNames = Array.from(document.querySelectorAll('.cat-name:not(.cut)'))
            .map(el => el.textContent.trim().toLowerCase())
            .filter((n, i, arr) => arr.indexOf(n) === i); // Remove duplicates
          
          if (existingNames.includes(name.toLowerCase()) && !id) {
            catErr.textContent = 'Tên danh mục đã tồn tại. Vui lòng chọn tên khác.';
            return;
          }
          const body = JSON.stringify({ name });

          let res;
          if (!id) res = await fetch(routes.catCreate, { method:'POST', headers:{'Content-Type':'application/json'}, body });
          else     res = await fetch(routes.catUpdate + `?id=${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body });

           if (res.status === 200 || res.status === 201) {
             catModal.hide();
             if (!id) {
               // Create new category - add row to table without reload
               const dto = await res.json();
               addNewCategoryRow(dto);
               updateMetrics();
               showNotice('Thêm danh mục thành công!', 'success', 2500);
               
               // Reset form
               catIdEl.value = '';
               catNameEl.value = '';
               catErr.textContent = '';
               catNameEl.classList.remove('is-invalid');
             } else {
               // Update existing category - update UI immediately
               const row = document.querySelector('tr[data-id="' + id + '"]');
               if (row) {
                 row.querySelector('.cat-name').textContent = name;
                 row.querySelector('.cat-name').classList.remove('cut');
                 
                 // Update metrics
                 updateMetrics();
               }
               showNotice('Cập nhật danh mục thành công!', 'success', 2500);
             }
           } else {
            const errorText = await res.text();
            if (res.status === 409) {
              catErr.textContent = 'Tên danh mục đã tồn tại. Vui lòng chọn tên khác.';
            } else if (res.status === 400) {
              catErr.textContent = errorText || 'Dữ liệu không hợp lệ.';
            } else if (res.status === 404) {
              catErr.textContent = 'Không tìm thấy danh mục.';
            } else {
              catErr.textContent = errorText || 'Có lỗi xảy ra.';
            }
          }
        });

        // ===== TAGS =====
        async function loadTags(categoryId, pane){
          const ul = pane.querySelector('.tag-list');
          ul.innerHTML = '<li class="list-group-item note">Đang tải…</li>';

          const res = await fetch(routes.tagsByCat + `?categoryId=${categoryId}&includeDeleted=${includeDeleted}`);
          if (!res.ok) { ul.innerHTML = '<li class="list-group-item note text-danger">Lỗi tải tag</li>'; return; }
          const list = await res.json();

          // cập nhật CHIP ĐẾM ở TRÊN + DƯỚI
          updateTagCountBadges(categoryId, list?.length ?? 0);

          renderTagList(ul, list, categoryId, pane);
          
          // Prefetch option counts for all tags
          await prefetchOptionCounts(list);
        }

        function updateTagCountBadges(categoryId, count){
          document.querySelectorAll(`.chip-count[data-count-for="${categoryId}"]`)
            .forEach(el => el.textContent = count);
          document.querySelectorAll(`.chip-count-bottom[data-count-for="${categoryId}"]`)
            .forEach(el => el.textContent = count);
        }

        function renderTagList(ul, list, categoryId, pane){
          ul.innerHTML = '';
          if (!list || !list.length){
            ul.innerHTML = '<li class="list-group-item note">Chưa có tag nào.</li>'; return;
          }
          list.forEach(t=>{
            const li = document.createElement('li');
            li.className = 'list-group-item tag-item';
            li.dataset.tagId = t.tagId;

            li.innerHTML = `
              <div class="tag-item-wrapper">
                <div class="tag-item-header">
              <div class="l">
                    <button class="btn toggle-options soft ms-0 me-2" 
                            data-target="#options-${t.tagId}" 
                            aria-expanded="false" 
                            title="Mở/đóng danh sách tùy chọn">
                      <i class="bi bi-caret-right-fill"></i>
                    </button>
                <span class="dot ${t.isDeleted ? 'muted' : 'ok'}"></span>
                <i class="bi bi-tag-fill ${t.isDeleted ? 'muted-i' : 'pri-i'}"></i>
                <span class="tag-name ${t.isDeleted ? 'cut' : ''}">${t.name}</span>
                    <span class="chip chip-count badge bg-info" data-count-for="${t.tagId}" title="Số lượng tùy chọn">0</span>
                ${t.isDeleted ? '<span class="state del ms-2">Đã xoá</span>' : ''}
              </div>
              <div class="r btn-group">
                <button class="btn btn-sm btn-outline-primary soft btn-edit-tag" ${t.isDeleted ? 'disabled' : ''}>
                  <i class="bi bi-pencil-square"></i> Sửa
                </button>
                ${t.isDeleted
                   ? `<button class="btn btn-sm btn-outline-warning soft btn-restore-tag"><i class="bi bi-arrow-counterclockwise"></i> Khôi phục</button>`
                   : `<button class="btn btn-sm btn-outline-danger soft btn-delete-tag"><i class="bi bi-trash"></i> Xoá</button>`}
                  </div>
                </div>
                <div id="options-${t.tagId}" class="options-box collapse" data-tag-id="${t.tagId}" style="margin-top: 0.75rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border-left: 3px solid #0d6efd;">
                  <div class="options-top" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #dee2e6;">
                    <div class="ttl" style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="bi bi-list-check text-primary"></i>
                      <strong style="color: #212529;">Tùy chọn</strong>
                      <span class="hint" style="font-size: 0.875rem; color: #6c757d;">(${t.name})</span>
                    </div>
                    <div class="top-right" style="display: flex; align-items: center; gap: 0.5rem;">
                      <span class="chip chip-mini chip-count-bottom badge bg-info" data-count-for="${t.tagId}" title="Số lượng tùy chọn">0</span>
                      <button class="btn btn-sm btn-outline-success soft btn-add-option" data-tag-id="${t.tagId}" ${t.isDeleted ? 'disabled' : ''} title="Thêm tùy chọn mới">
                        <i class="bi bi-plus-lg"></i> Thêm tùy chọn
                      </button>
                    </div>
                  </div>
                  <ul class="list-group option-list" data-tag-id="${t.tagId}" style="margin: 0;">
                    <li class="list-group-item note" style="font-style: italic; color: #6c757d;"><i class="bi bi-arrow-right-circle me-2"></i>Nhấn mũi tên để tải danh sách tùy chọn…</li>
                  </ul>
                </div>
              </div>`;
            ul.appendChild(li);
          });
        }

        // Tag modal
        const tagModal = new bootstrap.Modal(document.getElementById('tagModal'));
        const tagIdEl = document.getElementById('tagId');
        const tagCatIdEl = document.getElementById('tagCategoryId');
        const tagNameEl = document.getElementById('tagName');
        const tagErr = document.getElementById('tagError');
        tagNameEl.addEventListener('input', ()=> { if (tagNameEl.value.trim()) tagNameEl.classList.remove('is-invalid'); });

        // Add tag - Using event delegation to handle dynamically added buttons
        document.addEventListener('click', (e)=>{
            const btn = e.target.closest('.btn-add-tag');
            if (!btn) return;
            const catId = btn.getAttribute('data-category-id');
          if (!catId) return;
            document.getElementById('tagModalTitle').textContent = 'Thêm tag';
            tagIdEl.value = ''; tagCatIdEl.value = catId; tagNameEl.value = '';
            tagErr.textContent = ''; tagNameEl.classList.remove('is-invalid');
            tagModal.show();
          });

        // List tag events - Using event delegation to handle dynamically added tags
        document.addEventListener('click', async (e)=>{
          // Check if clicked element is inside a tag-list
          const tagList = e.target.closest('.tag-list');
          if (!tagList) return;
          
          const btn = e.target.closest('button'); 
          if (!btn) return;
          
          const li = btn.closest('.tag-item'); 
          const tagId = li?.dataset?.tagId; 
          if (!tagId) return;
          
          const pane = btn.closest('.tags-box'); 
          const catId = pane?.getAttribute('data-category-id');
          if (!catId) return;

            if (btn.classList.contains('btn-edit-tag')) {
              document.getElementById('tagModalTitle').textContent = 'Sửa tag';
              tagIdEl.value = tagId; tagCatIdEl.value = catId;
              tagNameEl.value = li.querySelector('.tag-name').textContent.trim();
              tagErr.textContent = ''; tagNameEl.classList.remove('is-invalid');
            tagModal.show(); 
            return;
            }

            if (btn.classList.contains('btn-delete-tag')) {
              const res = await fetch(routes.tagDelete + `?id=${tagId}`, { method:'DELETE' });
              if (res.status === 204) {
                await reloadTags(catId, pane);
                showNotice('Xóa tag thành công!', 'success', 2500);
              } else {
                const errorText = await res.text();
                showNotice(errorText || 'Không thể xóa tag', 'error', 3000);
              }
              return;
            }

            if (btn.classList.contains('btn-restore-tag')) {
              const res = await fetch(routes.tagRestore + `?id=${tagId}`, { method:'POST' });
              if (res.status === 204) {
                await reloadTags(catId, pane);
                showNotice('Khôi phục tag thành công!', 'success', 2500);
              } else {
                const errorText = await res.text();
                showNotice(errorText || 'Không thể khôi phục tag', 'error', 3000);
              }
              return;
            }
        });

        // Save tag
        document.getElementById('tagForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const id = tagIdEl.value.trim();
          const categoryId = tagCatIdEl.value.trim();
          const name = tagNameEl.value.trim();
          if (!name){ tagNameEl.classList.add('is-invalid'); return; }
          if (!categoryId){ tagErr.textContent = 'Lỗi: không xác định được danh mục'; return; }
          
          // Client-side validation: check for duplicate tag names in the same category
          const categoryPane = document.querySelector(`[data-category-id="${categoryId}"]`);
          if (categoryPane) {
            const existingTagNames = Array.from(categoryPane.querySelectorAll('.tag-name:not(.cut)'))
              .map(el => el.textContent.trim().toLowerCase());
            
            if (existingTagNames.includes(name.toLowerCase()) && !id) {
              tagErr.textContent = 'Tên tag đã tồn tại trong danh mục này. Vui lòng chọn tên khác.';
              return;
            }
          }
          
          const body = JSON.stringify({ categoryId, name });

          let res;
          if (!id) res = await fetch(routes.tagCreate, { method:'POST', headers:{'Content-Type':'application/json'}, body });
          else     res = await fetch(routes.tagUpdate + `?id=${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body });

          if (res.status === 200 || res.status === 201) {
            tagModal.hide();
            // Reload tags for this category
            const pane = document.querySelector(`[data-category-id="${categoryId}"]`);
            if (pane) await reloadTags(categoryId, pane);
            if (!id) {
              showNotice('Thêm tag thành công!', 'success', 2500);
            } else {
              showNotice('Cập nhật tag thành công!', 'success', 2500);
            }
          } else {
            const errorText = await res.text();
            if (res.status === 409) {
              tagErr.textContent = 'Tên tag đã tồn tại trong danh mục này. Vui lòng chọn tên khác.';
            } else if (res.status === 400) {
              tagErr.textContent = errorText || 'Dữ liệu không hợp lệ.';
            } else if (res.status === 404) {
              tagErr.textContent = 'Không tìm thấy tag hoặc danh mục.';
            } else {
              tagErr.textContent = errorText || 'Có lỗi xảy ra.';
            }
          }
        });

        async function reloadTags(catId, pane){
          const res = await fetch(routes.tagsByCat + `?categoryId=${catId}&includeDeleted=${includeDeleted}`);
          if (!res.ok) return;
          const list = await res.json();
          updateTagCountBadges(catId, list?.length ?? 0);
          renderTagList(pane.querySelector('.tag-list'), list, catId, pane);
        }

        // ===== OPTIONS =====
        async function loadOptions(tagId, optionsBox){
          const ul = optionsBox.querySelector('.option-list');
          ul.innerHTML = '<li class="list-group-item note" style="font-style: italic; color: #6c757d;"><i class="bi bi-hourglass-split me-2"></i>Đang tải danh sách tùy chọn…</li>';

          const res = await fetch(routes.optionsByTag + `?tagId=${tagId}`);
          if (!res.ok) { 
            ul.innerHTML = '<li class="list-group-item note text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Lỗi khi tải danh sách tùy chọn. Vui lòng thử lại.</li>'; 
            return; 
          }
          const list = await res.json();

          // Cập nhật chip đếm
          updateOptionCountBadges(tagId, list?.length ?? 0);

          renderOptionList(ul, list, tagId, optionsBox);
        }

        function updateOptionCountBadges(tagId, count){
          document.querySelectorAll(`.chip-count[data-count-for="${tagId}"]`)
            .forEach(el => el.textContent = count);
          document.querySelectorAll(`.chip-count-bottom[data-count-for="${tagId}"]`)
            .forEach(el => el.textContent = count);
        }

        function renderOptionList(ul, list, tagId, optionsBox){
          ul.innerHTML = '';
          if (!list || !list.length){
            ul.innerHTML = '<li class="list-group-item note" style="font-style: italic; color: #6c757d;"><i class="bi bi-inbox me-2"></i>Chưa có tùy chọn nào. Nhấn "Thêm tùy chọn" để tạo mới.</li>'; 
            return;
          }

          // Nhóm options theo Family
          const groupedOptions = {};
          const ungroupedOptions = [];

          list.forEach(o => {
            if (o.family) {
              if (!groupedOptions[o.family]) {
                groupedOptions[o.family] = [];
              }
              groupedOptions[o.family].push(o);
            } else {
              ungroupedOptions.push(o);
            }
          });

          const typeLabels = {
            'checkbox': 'Chọn nhiều',
            'radio': 'Chọn một',
            'textarea': 'Nhập văn bản'
          };

          // Sắp xếp các nhóm theo type (radio trước, checkbox sau)
          const groupOrder = ['radio', 'checkbox'];
          const sortedGroups = Object.keys(groupedOptions).sort((a, b) => {
            const typeA = groupedOptions[a][0]?.type?.toLowerCase() || '';
            const typeB = groupedOptions[b][0]?.type?.toLowerCase() || '';
            const indexA = groupOrder.indexOf(typeA);
            const indexB = groupOrder.indexOf(typeB);
            if (indexA === -1 && indexB === -1) return 0;
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
          });

          // Render các nhóm (Family) - hiển thị trước
          sortedGroups.forEach(familyId => {
            const groupOptions = groupedOptions[familyId];
            const groupType = groupOptions[0]?.type?.toLowerCase() || '';
            const typeLabel = typeLabels[groupType] || groupType || 'Chưa xác định';
            
            // Màu sắc theo loại nhóm
            let borderColor = '#ffc107'; // default (yellow)
            let bgColor = '#fffbf0'; // default
            if (groupType === 'radio') {
              borderColor = '#0d6efd'; // blue
              bgColor = '#e7f3ff';
            } else if (groupType === 'checkbox') {
              borderColor = '#6f42c1'; // purple
              bgColor = '#f3e8ff';
            }
            
            // Header cho nhóm
            const groupHeader = document.createElement('li');
            groupHeader.className = 'list-group-item';
            groupHeader.style.borderLeft = `4px solid ${borderColor}`;
            groupHeader.style.fontWeight = '600';
            groupHeader.style.backgroundColor = bgColor;
            groupHeader.style.padding = '0.75rem 1rem';
            groupHeader.style.marginBottom = '0.25rem';
            groupHeader.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <i class="bi bi-diagram-3" style="color: ${borderColor};"></i>
                  <span>Nhóm: ${typeLabel} (${groupOptions.length} tùy chọn)</span>
                </div>
              </div>
            `;
            ul.appendChild(groupHeader);

            // Render các options trong nhóm
            groupOptions.forEach(o => {
              const optionTypeLabel = typeLabels[o.type?.toLowerCase()] || o.type || 'Chưa xác định';
              const li = document.createElement('li');
              li.className = 'list-group-item option-item';
              li.dataset.optionId = o.optionId;
              li.style.paddingLeft = '2.5rem';
              li.style.borderLeft = `3px solid ${borderColor}`;
              li.style.backgroundColor = bgColor;
              li.style.marginBottom = '0.15rem';
              li.style.borderRadius = '0.25rem';

              li.innerHTML = `
                <div class="l" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                  <span class="dot ok"></span>
                  <i class="bi bi-list-check pri-i text-primary"></i>
                  <span class="option-name fw-semibold">${o.optionName}</span>
                </div>
                <div class="r btn-group">
                  <button class="btn btn-sm btn-outline-primary soft btn-edit-option" title="Sửa tùy chọn">
                    <i class="bi bi-pencil-square"></i> Sửa
                  </button>
                  <button class="btn btn-sm btn-outline-danger soft btn-delete-option" title="Xóa tùy chọn">
                    <i class="bi bi-trash"></i> Xóa
                  </button>
                </div>`;
              ul.appendChild(li);
            });
            
            // Thêm khoảng cách sau mỗi nhóm
            const spacer = document.createElement('li');
            spacer.className = 'list-group-item';
            spacer.style.height = '0.5rem';
            spacer.style.padding = '0';
            spacer.style.border = 'none';
            spacer.style.backgroundColor = 'transparent';
            ul.appendChild(spacer);
          });

          // Render các options không có nhóm - hiển thị sau các nhóm
          if (ungroupedOptions.length > 0) {
            // Header cho options không nhóm
            if (sortedGroups.length > 0) {
              const separator = document.createElement('li');
              separator.className = 'list-group-item';
              separator.style.borderTop = '2px solid #dee2e6';
              separator.style.marginTop = '0.5rem';
              separator.style.padding = '0.5rem 0';
              separator.innerHTML = '<small class="text-muted"><i class="bi bi-three-dots me-1"></i>Options độc lập</small>';
              ul.appendChild(separator);
            }
            
            ungroupedOptions.forEach(o => {
              const typeLabel = typeLabels[o.type?.toLowerCase()] || o.type || 'Chưa xác định';
              const li = document.createElement('li');
              li.className = 'list-group-item option-item';
              li.dataset.optionId = o.optionId;

              li.innerHTML = `
                <div class="l" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                  <span class="dot ok"></span>
                  <i class="bi bi-list-check pri-i text-primary"></i>
                  <span class="option-name fw-semibold">${o.optionName}</span>
                </div>
                <div class="r btn-group">
                  <button class="btn btn-sm btn-outline-primary soft btn-edit-option" title="Sửa tùy chọn">
                    <i class="bi bi-pencil-square"></i> Sửa
                  </button>
                  <button class="btn btn-sm btn-outline-danger soft btn-delete-option" title="Xóa tùy chọn">
                    <i class="bi bi-trash"></i> Xóa
                  </button>
                </div>`;
              ul.appendChild(li);
            });
          }
        }

        // Toggle options - handle click on toggle-options button
        document.addEventListener('click', async (e)=>{
          const btn = e.target.closest('.toggle-options');
          if (!btn) return;
          
          const targetSel = btn.getAttribute('data-target');
          const optionsBox = document.querySelector(targetSel);
          if (!optionsBox) return;

          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', (!expanded).toString());
          btn.querySelector('i').className = expanded ? 'bi bi-caret-right-fill' : 'bi bi-caret-down-fill';

          if (!optionsBox.classList.contains('loaded')) {
            const tagId = optionsBox.getAttribute('data-tag-id');
            if (tagId) {
              await loadOptions(tagId, optionsBox); 
              optionsBox.classList.add('loaded');
            }
          }
          optionsBox.classList.toggle('show');
        });

        // Option modal
        const optionModal = new bootstrap.Modal(document.getElementById('optionModal'));
        const optionIdEl = document.getElementById('optionId');
        const optionTagIdEl = document.getElementById('optionTagId');
        const optionNameEl = document.getElementById('optionName');
        const optionTypeEl = document.getElementById('optionType');
        const optionFamilyEl = document.getElementById('optionFamily');
        const optionFamilyUUIDEl = document.getElementById('optionFamilyUUID');
        const optionFamilyGroupEl = document.getElementById('optionFamilyGroup');
        const optionErr = document.getElementById('optionError');

        optionNameEl.addEventListener('input', ()=> { 
          if (optionNameEl.value.trim()) optionNameEl.classList.remove('is-invalid'); 
        });
        
        // Khi chọn loại option → hiển thị/ẩn nhóm và load nhóm hiện có
        optionTypeEl.addEventListener('change', async ()=> { 
          if (optionTypeEl.value) optionTypeEl.classList.remove('is-invalid');
          
          const optionType = optionTypeEl.value.toLowerCase();
          const tagId = optionTagIdEl.value;
          
          // Chỉ hiển thị nhóm cho radio và checkbox (có thể có nhóm)
          if (optionType === 'radio' || optionType === 'checkbox') {
            optionFamilyGroupEl.style.display = 'block';
            
            // Load các nhóm hiện có cùng loại (cho radio và checkbox)
            await loadExistingGroups(tagId, optionType);
          } else {
            // Textarea không cần nhóm
            optionFamilyGroupEl.style.display = 'none';
            optionFamilyEl.value = '';
            optionFamilyUUIDEl.value = '';
          }
        });
        
        // Khi chọn nhóm → lưu UUID của nhóm
        optionFamilyEl.addEventListener('change', ()=>{
          const selectedValue = optionFamilyEl.value;
          if (selectedValue && selectedValue !== 'NEW_GROUP') {
            optionFamilyUUIDEl.value = selectedValue;
          } else {
            // "Không nhóm" hoặc "Tạo nhóm mới" → để trống, sẽ tự động tạo UUID khi save (nếu cần)
            optionFamilyUUIDEl.value = '';
          }
        });
        
        // Hàm load các nhóm hiện có cùng loại
        async function loadExistingGroups(tagId, optionType) {
          if (!tagId) return;
          
          try {
            const res = await fetch(routes.optionsByTag + `?tagId=${tagId}`);
            if (!res.ok) return;
            const options = await res.json();
            
            // Lọc các nhóm có cùng type và có Family
            const groups = {};
            options.forEach(opt => {
              if (opt.type?.toLowerCase() === optionType && opt.family) {
                if (!groups[opt.family]) {
                  // Lấy tên các options trong nhóm để hiển thị
                  const groupOptions = options.filter(o => o.family === opt.family);
                  const groupNames = groupOptions.map(o => o.optionName).join(', ');
                  groups[opt.family] = {
                    uuid: opt.family,
                    names: groupNames,
                    count: groupOptions.length
                  };
                }
              }
            });
            
            // Cập nhật dropdown
            // Với checkbox → có thêm option "Không nhóm" ở đầu
            let html = '';
            if (optionType === 'checkbox') {
              html = '<option value="">-- Không nhóm (checkbox độc lập) --</option>';
            } else {
              html = '<option value="">-- Tạo nhóm mới --</option>';
            }
            
            // Thêm các nhóm hiện có
            Object.values(groups).forEach(group => {
              html += `<option value="${group.uuid}">Nhóm hiện có (${group.count} tùy chọn): ${group.names.substring(0, 50)}${group.names.length > 50 ? '...' : ''}</option>`;
            });
            
            // Với checkbox → luôn thêm option "Tạo nhóm mới" ở cuối (sau các nhóm hiện có)
            if (optionType === 'checkbox') {
              html += '<option value="NEW_GROUP">-- Tạo nhóm mới --</option>';
            }
            
            optionFamilyEl.innerHTML = html;
            
            // Nếu đang edit và option có family → chọn nhóm đó
            if (optionIdEl.value && optionFamilyUUIDEl.value) {
              optionFamilyEl.value = optionFamilyUUIDEl.value;
            }
          } catch (error) {
            console.error('Error loading groups:', error);
          }
        }

        // Add option - Using event delegation
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('.btn-add-option');
          if (!btn) return;
          const tagId = btn.getAttribute('data-tag-id');
          if (!tagId) return;
          
          document.getElementById('optionModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Thêm tùy chọn';
          optionIdEl.value = ''; 
          optionTagIdEl.value = tagId; 
          optionNameEl.value = '';
          optionTypeEl.value = '';
          optionFamilyEl.value = '';
          optionFamilyUUIDEl.value = '';
          optionFamilyGroupEl.style.display = 'none';
          optionErr.textContent = ''; 
          optionNameEl.classList.remove('is-invalid');
          optionTypeEl.classList.remove('is-invalid');
          optionModal.show();
        });

        // List option events - Using event delegation
        document.addEventListener('click', async (e)=>{
          const optionList = e.target.closest('.option-list');
          if (!optionList) return;
          
          const btn = e.target.closest('button'); 
          if (!btn) return;
          
          const li = btn.closest('.option-item'); 
          const optionId = li?.dataset?.optionId; 
          if (!optionId) return;
          
          const optionsBox = btn.closest('.options-box'); 
          const tagId = optionsBox?.getAttribute('data-tag-id');
          if (!tagId) return;

          if (btn.classList.contains('btn-edit-option')) {
            const res = await fetch(routes.optionsByTag + `?tagId=${tagId}`);
            if (!res.ok) { showNotice('Không thể đọc dữ liệu tùy chọn', 'error', 3000); return; }
            const list = await res.json();
            const opt = list.find(o => o.optionId === optionId);
            if (!opt) { showNotice('Không tìm thấy tùy chọn', 'error', 3000); return; }

            document.getElementById('optionModalTitle').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Sửa tùy chọn';
            optionIdEl.value = optionId; 
            optionTagIdEl.value = tagId;
            optionNameEl.value = opt.optionName || '';
            optionTypeEl.value = opt.type || '';
            
            // Nếu option có family → load nhóm và chọn
            if (opt.family) {
              optionFamilyUUIDEl.value = opt.family;
              // Trigger change event để load groups và chọn nhóm
              optionTypeEl.dispatchEvent(new Event('change'));
            } else {
              optionFamilyEl.value = '';
              optionFamilyUUIDEl.value = '';
              const optionType = opt.type?.toLowerCase() || '';
              if (optionType === 'radio' || optionType === 'checkbox') {
                optionFamilyGroupEl.style.display = 'block';
                await loadExistingGroups(tagId, optionType);
              } else {
                optionFamilyGroupEl.style.display = 'none';
              }
            }
            
            optionErr.textContent = ''; 
            optionNameEl.classList.remove('is-invalid');
            optionTypeEl.classList.remove('is-invalid');
            optionModal.show(); 
            return;
          }

          if (btn.classList.contains('btn-delete-option')) {
            const res = await fetch(routes.optionDelete + `?id=${optionId}`, { method:'DELETE' });
            if (res.status === 204) {
              await reloadOptions(tagId, optionsBox);
              showNotice('Xóa tùy chọn thành công!', 'success', 2500);
            } else if (res.status === 409) {
              // Option đang được sử dụng bởi service
              const errorText = await res.text();
              showNotice(errorText || 'Không thể xóa tùy chọn này vì đang có dịch vụ đang sử dụng.', 'error', 4000);
            } else {
              const errorText = await res.text();
              showNotice(errorText || 'Không thể xóa tùy chọn. Vui lòng thử lại.', 'error', 3000);
            }
            return;
          }
        });

        // Save option
        document.getElementById('optionForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const id = optionIdEl.value.trim();
          const tagId = optionTagIdEl.value.trim();
          const name = optionNameEl.value.trim();
          const type = optionTypeEl.value.trim();
          
          // Lấy family từ UUID field (đã được set khi chọn nhóm) hoặc tạo mới
          let family = optionFamilyUUIDEl.value.trim() || null;
          
          // Kiểm tra nếu chọn "Tạo nhóm mới" (value = "NEW_GROUP") hoặc không có family nhưng cần nhóm
          const selectedFamilyOption = optionFamilyEl.value;
          const needsGroup = type === 'radio' || (type === 'checkbox' && selectedFamilyOption === 'NEW_GROUP');
          
          // Nếu không có family được chọn nhưng option type cần nhóm → tạo UUID mới
          if (!family && needsGroup) {
            // Tạo UUID mới cho nhóm mới
            family = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
              const r = Math.random() * 16 | 0;
              const v = c === 'x' ? r : (r & 0x3 | 0x8);
              return v.toString(16);
            });
          }
          
          // Nếu là checkbox và chọn "Không nhóm" hoặc không chọn gì → family = null
          if (type === 'checkbox' && (!selectedFamilyOption || selectedFamilyOption === '')) {
            family = null;
          }
          
          if (!name){ 
            optionNameEl.classList.add('is-invalid'); 
            optionErr.textContent = 'Vui lòng nhập tên tùy chọn.';
            return; 
          }
          if (!type){ 
            optionTypeEl.classList.add('is-invalid'); 
            optionErr.textContent = 'Vui lòng chọn loại tùy chọn.';
            return; 
          }
          if (!tagId){ 
            optionErr.textContent = 'Lỗi: Không xác định được tag. Vui lòng thử lại.'; 
            return; 
          }

          const body = JSON.stringify({ 
            optionName: name, 
            tagId: tagId, 
            type: type, 
            family: family 
          });

          let res;
          if (!id) {
            res = await fetch(routes.optionCreate, { 
              method:'POST', 
              headers:{'Content-Type':'application/json'}, 
              body 
            });
          } else {
            res = await fetch(routes.optionUpdate + `?id=${id}`, { 
              method:'PUT', 
              headers:{'Content-Type':'application/json'}, 
              body 
            });
          }

          if (res.status === 200 || res.status === 201) {
            optionModal.hide();
            // Reload options for this tag
            const optionsBox = document.querySelector(`[data-tag-id="${tagId}"]`);
            if (optionsBox) await reloadOptions(tagId, optionsBox);
            if (!id) {
              showNotice('Thêm tùy chọn thành công!', 'success', 2500);
            } else {
              showNotice('Cập nhật tùy chọn thành công!', 'success', 2500);
            }
          } else {
            const errorText = await res.text();
            if (res.status === 409) {
              optionErr.textContent = 'Tên tùy chọn đã tồn tại. Vui lòng chọn tên khác.';
            } else if (res.status === 400) {
              optionErr.textContent = errorText || 'Dữ liệu không hợp lệ. Vui lòng kiểm tra lại.';
            } else if (res.status === 404) {
              optionErr.textContent = 'Không tìm thấy tùy chọn hoặc tag. Vui lòng thử lại.';
            } else {
              optionErr.textContent = errorText || 'Có lỗi xảy ra. Vui lòng thử lại sau.';
            }
          }
        });

        async function reloadOptions(tagId, optionsBox){
          const res = await fetch(routes.optionsByTag + `?tagId=${tagId}`);
          if (!res.ok) return;
          const list = await res.json();
          updateOptionCountBadges(tagId, list?.length ?? 0);
          renderOptionList(optionsBox.querySelector('.option-list'), list, tagId, optionsBox);
        }

        // Prefetch: lấy số lượng tùy chọn cho mỗi tag khi load tags
        async function prefetchOptionCounts(tagList){
          for (const tag of tagList || []) {
            if (tag.tagId) {
              fetch(routes.optionsByTag + `?tagId=${tag.tagId}`)
                .then(res => res.ok ? res.json() : [])
                .then(list => {
                  updateOptionCountBadges(tag.tagId, list?.length ?? 0);
                })
                .catch(()=>{
                  // Silently fail - không hiển thị lỗi khi prefetch
                });
            }
          }
        }

         // Function to add new category row to table
         function addNewCategoryRow(dto) {
           const tbody = document.querySelector('#tblCats tbody');
           if (!tbody) return;
           
           // Create category row
           const catRow = document.createElement('tr');
           catRow.className = 'cat-row';
           catRow.setAttribute('data-id', dto.categoryId);
           
           catRow.innerHTML = 
             '<td>' +
               '<div class="branch">' +
                 '<button class="btn toggle-tags soft" data-target="#tags-' + dto.categoryId + '" aria-expanded="false" title="Mở danh sách tag">' +
                   '<i class="bi bi-caret-right-fill"></i>' +
                 '</button>' +
                 '<span class="chip chip-count" data-count-for="' + dto.categoryId + '">0</span>' +
               '</div>' +
             '</td>' +
             '<td class="cat-name fw-semibold">' + dto.name + '</td>' +
             '<td><span class="state ok">Hoạt động</span></td>' +
             '<td class="text-end">' +
               '<div class="btn-group">' +
                 '<button class="btn btn-sm btn-outline-primary soft btn-edit">' +
                   '<i class="bi bi-pencil-square"></i> Sửa' +
                 '</button>' +
                 '<button class="btn btn-sm btn-outline-danger soft btn-delete-cat">' +
                   '<i class="bi bi-trash"></i> Xoá' +
                 '</button>' +
               '</div>' +
             '</td>';
           
           // Create tag row
           const tagRow = document.createElement('tr');
           tagRow.className = 'tag-row';
           tagRow.innerHTML = 
             '<td colspan="4" class="p-0">' +
               '<div id="tags-' + dto.categoryId + '" class="tags-box collapse card-x" data-category-id="' + dto.categoryId + '">' +
                 '<div class="tags-top">' +
                   '<div class="ttl">' +
                     '<i class="bi bi-tags-fill"></i>' +
                     '<strong>Tags</strong>' +
                     '<span class="hint">(nhánh con)</span>' +
                   '</div>' +
                   '<div class="top-right">' +
                     '<span class="chip chip-mini chip-count-bottom" data-count-for="' + dto.categoryId + '">0</span>' +
                     '<button class="btn btn-sm btn-outline-success soft btn-add-tag" data-category-id="' + dto.categoryId + '">' +
                       '<i class="bi bi-plus-lg"></i> Thêm tag' +
                     '</button>' +
                   '</div>' +
                 '</div>' +
                 '<ul class="list-group tag-list" data-category-id="' + dto.categoryId + '">' +
                   '<li class="list-group-item note">Nhấn mũi tên để tải danh sách tag…</li>' +
                 '</ul>' +
               '</div>' +
             '</td>';
           
           // Add both rows to tbody
           tbody.appendChild(catRow);
           tbody.appendChild(tagRow);
        }

         // Function to update metrics (số lượng) ngay lập tức
         function updateMetrics() {
           const rows = document.querySelectorAll('tr.cat-row');
           let total = rows.length;
           let active = 0;
           let deleted = 0;
           
           rows.forEach(row => {
             if (row.classList.contains('deleted')) {
               deleted++;
             } else {
               active++;
             }
           });
           
           // Update metrics in header
           const totalPill = document.querySelector('.pill .val');
           const activePill = document.querySelector('.pill.good .val');
           const deletedPill = document.querySelector('.pill.mute .val');
           
           if (totalPill) totalPill.textContent = total;
           if (activePill) activePill.textContent = active;
           if (deletedPill) deletedPill.textContent = deleted;
         }

         // Prefetch: lấy số lượng cho chip TRÊN/DƯỚI ngay khi vào trang (mềm mượt)
         document.addEventListener('DOMContentLoaded', async ()=>{
           const rows = Array.from(document.querySelectorAll('tr.cat-row'));
           for (const r of rows){
             const id = r.dataset.id;
             fetch(routes.tagsByCat + `?categoryId=${id}&includeDeleted=${includeDeleted}`)
               .then(res => res.ok ? res.json() : [])
               .then(list => {
                 updateTagCountBadges(id, list?.length ?? 0);
                 
                 // Check if category has active tags and update delete button
                 const activeTags = list?.filter(tag => !tag.isDeleted) || [];
                 const deleteBtn = r.querySelector('.btn-delete-cat');
                 if (deleteBtn && activeTags.length > 0) {
                   deleteBtn.title = `Không thể xóa vì còn ${activeTags.length} tag đang hoạt động`;
                   deleteBtn.style.opacity = '0.6';
                 }
               })
               .catch(()=>{});
           }
         });
    </script>
}

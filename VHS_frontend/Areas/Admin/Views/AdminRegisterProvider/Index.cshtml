@using VHS_frontend.Areas.Admin.Models.RegisterProvider
@model List<AdminProviderItemDTO>

@{
    ViewData["Title"] = "Duyệt đăng ký nhà cung cấp";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    var status = (string)(ViewBag.Status ?? "All"); // mặc định Tất cả
    var total = Model.Count;
    var pending = Model.Count(x => 
        string.Equals(x.Status, "Pending", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(x.Status, "Đang chờ duyệt", StringComparison.OrdinalIgnoreCase));
    var approved = Model.Count(x => 
        string.Equals(x.Status, "Approved", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(x.Status, "Đã duyệt", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(x.Status, "Đã phê duyệt", StringComparison.OrdinalIgnoreCase));
    var rejected = Model.Count(x => 
        string.Equals(x.Status, "Rejected", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(x.Status, "Đã từ chối", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(x.Status, "Bị từ chối", StringComparison.OrdinalIgnoreCase));

    string StatusBadgeClass(string s) => s?.ToLower() switch
    {
        "pending" => "st-badge pending",
        "đang chờ duyệt" => "st-badge pending",
        "approved" => "st-badge ok",
        "đã duyệt" => "st-badge ok",
        "đã phê duyệt" => "st-badge ok",
        "rejected" => "st-badge rej",
        "đã từ chối" => "st-badge rej",
        "bị từ chối" => "st-badge rej",
        _ => "st-badge"
    };
    string StatusVi(string s) => s?.ToLower() switch
    {
        "pending" => "Chờ phê duyệt",
        "đang chờ duyệt" => "Chờ phê duyệt",
        "approved" => "Đã phê duyệt",
        "đã duyệt" => "Đã phê duyệt",
        "đã phê duyệt" => "Đã phê duyệt",
        "rejected" => "Bị từ chối",
        "đã từ chối" => "Bị từ chối",
        "bị từ chối" => "Bị từ chối",
        _ => s
    };
    string Short(string? t, int max = 90)
        => string.IsNullOrWhiteSpace(t) ? "" : (t.Length <= max ? t : (t.Substring(0, max).TrimEnd() + "…"));
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-register-provider.css" asp-append-version="true" />
}

<section class="arp container-fluid">
    <!-- Header / Metrics -->
    <div class="arp__head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-person-workspace"></i></div>
            <div>
                <h3>Đăng ký nhà cung cấp</h3>
                <div class="sub">Duyệt hồ sơ nhà cung cấp dịch vụ</div>
            </div>
        </div>
        <div class="right">
            <div class="pill"><span class="lbl">Tổng</span><span class="val">@total</span></div>
            <div class="pill warn"><span class="lbl">Chờ phê duyệt</span><span class="val">@pending</span></div>
            <div class="pill good"><span class="lbl">Đã phê duyệt</span><span class="val">@approved</span></div>
            <div class="pill mute"><span class="lbl">Bị từ chối</span><span class="val">@rejected</span></div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="arp__toolbar">
        <div class="filters">
            <label class="lbl">Trạng thái</label>
            <select id="statusFilter" class="form-select">
                @if (status.Equals("All", StringComparison.OrdinalIgnoreCase))
                {
                    <option value="all" selected>Tất cả</option>
                }
                else
                {
                    <option value="all">Tất cả</option>
                }
                
                @if (status.Equals("đang chờ duyệt", StringComparison.OrdinalIgnoreCase))
                {
                    <option value="đang chờ duyệt" selected>Chờ phê duyệt</option>
                }
                else
                {
                    <option value="đang chờ duyệt">Chờ phê duyệt</option>
                }
                
                @if (status.Equals("đã duyệt", StringComparison.OrdinalIgnoreCase))
                {
                    <option value="đã duyệt" selected>Đã phê duyệt</option>
                }
                else
                {
                    <option value="đã duyệt">Đã phê duyệt</option>
                }
                
                @if (status.Equals("đã từ chối", StringComparison.OrdinalIgnoreCase))
                {
                    <option value="đã từ chối" selected>Bị từ chối</option>
                }
                else
                {
                    <option value="đã từ chối">Bị từ chối</option>
                }
            </select>
        </div>

        <div class="search">
            <i class="bi bi-search"></i>
            <input id="txtSearch" class="form-control" placeholder="Tìm theo tên nhà cung cấp, tài khoản hoặc số điện thoại…" />
        </div>
    </div>

    <!-- Table -->
    <div class="arp-table-wrapper">
    <table class="table table-hover align-middle mb-0 arp-table" id="tblProviders">
        <thead>
            <tr>
                <th class="col-name">Tên Provider</th>
                <th class="col-account">Tên tài khoản</th>
                <th class="col-desc">Mô tả</th>
                <th class="col-status">Trạng thái</th>
                <th class="col-phone">Số điện thoại</th>
                <th class="col-date">Ngày tạo</th>
                <th class="col-act text-end">Chi tiết</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model)
            {
                var badgeCls = StatusBadgeClass(p.Status);
                var statusVi = StatusVi(p.Status);
                <tr class="prow" data-status="@p.Status.ToLower()">
                    <td class="pname text-truncate">@p.ProviderName</td>
                    <td class="paccount text-truncate">@p.AccountName</td>
                    <td class="td-desc" title="@p.Description">@Short(p.Description, 70)</td>
                    <td><span class="@badgeCls">@statusVi</span></td>
                    <td class="pphone">@p.PhoneNumber</td>
                    <td class="pdate">@(p.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                    <td class="text-end col-act">
                        <a class="btn btn-sm btn-primary soft"
                           asp-area="Admin" asp-controller="AdminRegisterProvider" asp-action="Detail" asp-route-id="@p.ProviderId">
                            <i class="bi bi-eye"></i> Xem
                        </a>
                    </td>
                </tr>
            }
            @if (!Model.Any())
            {
                <tr><td colspan="7" class="text-center text-muted">Không có hồ sơ</td></tr>
            }
        </tbody>
    </table>
    </div>

</section>

@section Scripts {
    <script>
        // Initialize with current server value
        const statusFilter = document.getElementById('statusFilter');
        let currentStatusFilter = statusFilter.value.toLowerCase();
        let currentSearchQuery = '';

        // Filter table by status and search
        function filterTable() {
            document.querySelectorAll('#tblProviders tbody tr.prow').forEach(tr => {
                const rowStatus = tr.dataset.status || '';
                const name = tr.querySelector('.pname')?.textContent?.toLowerCase() ?? '';
                const account = tr.querySelector('.paccount')?.textContent?.toLowerCase() ?? '';
                const phone = tr.querySelector('.pphone')?.textContent?.toLowerCase() ?? '';
                
                // Check status filter - map to lowercase for comparison
                const filterLower = currentStatusFilter.toLowerCase();
                const statusMatch = filterLower === 'all' || 
                                  rowStatus === filterLower ||
                                  (filterLower === 'đã duyệt' && (rowStatus === 'đã duyệt' || rowStatus === 'đã phê duyệt' || rowStatus === 'approved')) ||
                                  (filterLower === 'đã từ chối' && (rowStatus === 'đã từ chối' || rowStatus === 'bị từ chối' || rowStatus === 'rejected')) ||
                                  (filterLower === 'đang chờ duyệt' && (rowStatus === 'pending' || rowStatus === 'đang chờ duyệt'));
                
                // Check search filter
                const searchMatch = !currentSearchQuery || 
                                  name.includes(currentSearchQuery) || 
                                  account.includes(currentSearchQuery) || 
                                  phone.includes(currentSearchQuery);
                
                // Show/hide row
                tr.style.display = (statusMatch && searchMatch) ? '' : 'none';
            });
        }

        // Status filter change event
        statusFilter.addEventListener('change', function() {
            currentStatusFilter = this.value.toLowerCase();
            filterTable();
        });

        // Search input event
        document.getElementById('txtSearch').addEventListener('input', function () {
            currentSearchQuery = this.value.toLowerCase().trim();
            filterTable();
        });
        
        // Apply initial filter on page load
        filterTable();
    </script>
}

@using System.Text.Json
@using VHS_frontend.Areas.Admin.Models.RegisterProvider
@model AdminProviderDetailDTO

@{
    ViewData["Title"] = "Chi tiết hồ sơ Provider";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    // ===== Map trạng thái: class + text tiếng Việt
    string MapStatusClass(string s) => s?.ToLower() switch
    {
        "pending" => "st-badge pending",
        "đang chờ duyệt" => "st-badge pending",
        "approved" => "st-badge ok",
        "đã duyệt" => "st-badge ok",
        "đã phê duyệt" => "st-badge ok",
        "rejected" => "st-badge rej",
        "đã từ chối" => "st-badge rej",
        "bị từ chối" => "st-badge rej",
        _ => "st-badge"
    };
    string MapStatusText(string s) => s?.ToLower() switch
    {
        "pending" => "Đang chờ phê duyệt",
        "đang chờ duyệt" => "Đang chờ phê duyệt",
        "approved" => "Đã phê duyệt",
        "đã duyệt" => "Đã phê duyệt",
        "đã phê duyệt" => "Đã phê duyệt",
        "rejected" => "Bị từ chối",
        "đã từ chối" => "Bị từ chối",
        "bị từ chối" => "Bị từ chối",
        _ => s
    };

    // ===== Cat map được truyền từ Controller
    var catMap = ViewBag.CatMap as IDictionary<Guid, string> ?? new Dictionary<Guid, string>();
    string CatName(Guid id) => catMap.TryGetValue(id, out var name) ? name : id.ToString();

    // ===== Parse list ảnh GPKD
    List<string> ToImages(string? json)
    {
        try { return string.IsNullOrWhiteSpace(json) ? new() : (JsonSerializer.Deserialize<List<string>>(json) ?? new()); }
        catch { return new(); }
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-register-provider.css" asp-append-version="true" />
}

<section class="arp container-fluid">
    <!-- Header -->
    <div class="arp__head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-person-badge-fill"></i></div>
            <div>
                <h3>@Model.ProviderName</h3>
                <div class="sub">Mã: <code>@Model.ProviderId</code></div>
            </div>
        </div>
        <div class="right">
            <div class="pill">
                <span class="lbl">Trạng thái</span>
                <span class="val"><span class="@MapStatusClass(Model.Status)">@MapStatusText(Model.Status)</span></span>
            </div>
            <div class="pill"><span class="lbl">Tạo:</span><span class="val">@Model.CreatedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span></div>
            <div class="pill"><span class="lbl">Duyệt:</span><span class="val">@Model.ApprovedAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span></div>
        </div>
    </div>

    <div class="arp__grid">
        <!-- Pane: Thông tin -->
        <div class="card-x pane">
            <div class="pane__head">
                <i class="bi bi-person"></i>
                <h5>Thông tin</h5>
            </div>
            <div class="pane__body">
                <dl class="kv">
                    <dt>Tên Provider</dt>
                    <dd>@Model.ProviderName</dd>

                    <dt>Tên tài khoản</dt>
                    <dd>@Model.AccountName</dd>

                    <dt>Điện thoại</dt>
                    <dd>@Model.PhoneNumber</dd>

                    <dt>Mô tả</dt>
                    <dd class="description-text">@Model.Description</dd>
                </dl>

                <div class="avatar-sec">
                    <div class="lbl">Ảnh đại diện</div>
                    <div class="avatar" onclick="enlargeAvatar(this)">
                        @if (!string.IsNullOrWhiteSpace(Model.Images))
                        {
                            <img src="@Model.Images" alt="Ảnh đại diện" class="clickable-image" data-src="@Model.Images" />
                        }
                        else
                        {
                            <div class="noimg">Không có ảnh</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Pane: Điều khoản & Bảo hiểm -->
        <div class="card-x pane">
            <div class="pane__head">
                <i class="bi bi-shield-check"></i>
                <h5>Điều khoản &amp; Bảo hiểm</h5>
            </div>
            <div class="pane__body">
                <div class="terms">
                    <div class="t-title">@Model.Terms?.Title</div>
                    <div class="t-desc description-text">@Model.Terms?.Description</div>
                </div>
            </div>
        </div>

        <!-- Pane full: Chứng chỉ & Giấy phép kinh doanh -->
        <div class="card-x pane pane--full">
            <div class="pane__head">
                <i class="bi bi-file-earmark-text"></i>
                <h5>Chứng chỉ &amp; Giấy phép kinh doanh</h5>
            </div>
            <div class="pane__body">
                @if (Model.Certificates?.Any() == true)
                {
                    <div class="certs">
                        @for (int i = 0; i < Model.Certificates.Count; i++)
                        {
                            var c = Model.Certificates[i];
                            var imgs = ToImages(c.Images);
                            <div class="cert">
                                <div class="cert__head">
                                    <span class="pill">#@(i + 1)</span>
                                    <div>
                                        <div class="c-kv">
                                            <span class="k">Danh mục:</span>
                                            <span class="v">@CatName(c.CategoryId)</span>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(c.Description))
                                        {
                                            <div class="c-kv"><span class="k">Mô tả:</span> <span class="v description-text">@c.Description</span></div>
                                        }
                                    </div>
                                </div>

                                @if (imgs.Any())
                                {
                                    <div class="bl-grid">
                                        @foreach (var url in imgs)
                                        {
                                            <figure class="thumb" onclick="enlargeCategoryImage(this)">
                                                <img src="@url" alt="Giấy phép kinh doanh" loading="lazy" data-src="@url" />
                                            </figure>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="note muted">Chưa có hình GPKD</div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="note muted">Không có chứng chỉ</div>
                }
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions card-x">
        @if (string.Equals(Model.Status, "Đang chờ duyệt", StringComparison.OrdinalIgnoreCase) || 
             string.Equals(Model.Status, "Pending", StringComparison.OrdinalIgnoreCase))
        {
            <form method="post"
                  asp-area="Admin"
                  asp-controller="AdminRegisterProvider"
                  asp-action="Approve"
                  asp-route-id="@Model.ProviderId"
                  class="d-inline">
                @Html.AntiForgeryToken()
                <button class="btn btn-success soft"><i class="bi bi-check2-circle"></i> Duyệt</button>
            </form>

            <button class="btn btn-danger soft" data-bs-toggle="modal" data-bs-target="#rejectModal">
                <i class="bi bi-x-octagon"></i> Từ chối
            </button>
        }
        <a class="btn btn-ghost soft" asp-area="Admin" asp-controller="AdminRegisterProvider" asp-action="Index">Quay lại</a>
    </div>
</section>

<!-- Modal: Reject -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x"
              method="post"
              asp-area="Admin"
              asp-controller="AdminRegisterProvider"
              asp-action="Reject"
              asp-route-id="@Model.ProviderId">
            @Html.AntiForgeryToken()
            <div class="modal-header">
                <h5 class="modal-title">Từ chối hồ sơ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Lý do (tuỳ chọn)</label>
                <textarea class="form-control" name="reason" rows="3" placeholder="Nhập lý do từ chối (nếu cần)…"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-danger soft">Xác nhận từ chối</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Image lightbox functionality
        document.addEventListener('DOMContentLoaded', function() {
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            const modalImage = document.getElementById('modalImage');
            
            // Add click handlers to all clickable images (except avatar images)
            document.querySelectorAll('.clickable-image').forEach(function(img) {
                // Skip images inside .avatar to avoid conflict
                if (img.closest('.avatar')) {
                    return;
                }
                img.style.cursor = 'pointer';
                img.addEventListener('click', function() {
                    modalImage.src = this.dataset.src || this.src;
                    imageModal.show();
                });
            });
        });

        // Function to enlarge avatar
        function enlargeAvatar(avatarElement) {
            const img = avatarElement.querySelector('img');
            if (!img) return;

            // Check if already enlarged
            if (document.querySelector('.avatar.enlarged')) {
                console.log('Avatar already enlarged, skipping...');
                return;
            }

            console.log('Enlarging avatar...');
            const overlay = document.getElementById('avatarOverlay');
            
            // Hide original avatar
            avatarElement.style.display = 'none';
            console.log('Original avatar hidden');
            
            // Create a new enlarged avatar element
            const enlargedAvatar = document.createElement('div');
            enlargedAvatar.className = 'avatar enlarged';
            enlargedAvatar.innerHTML = `
                <img src="${img.src}" alt="${img.alt}" style="width: 100%; height: 100%; object-fit: contain;" />
                <button type="button" class="close-btn" title="Đóng ảnh phóng to">
                    <i class="bi bi-x"></i>
                </button>
            `;
            
            // Add close button functionality
            const closeBtn = enlargedAvatar.querySelector('.close-btn');
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                closeEnlargedAvatar();
            };
            
            // Add to body
            document.body.appendChild(enlargedAvatar);
            console.log('Enlarged avatar added to body');
            
            // Show overlay
            overlay.classList.add('active');
            console.log('Overlay activated');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Function to close enlarged avatar
        function closeEnlargedAvatar() {
            console.log('Closing enlarged avatar...');
            const enlargedAvatar = document.querySelector('.avatar.enlarged');
            if (!enlargedAvatar) {
                console.log('No enlarged avatar found');
                return;
            }

            const overlay = document.getElementById('avatarOverlay');
            
            // Show original avatar
            const originalAvatar = document.querySelector('.avatar-sec .avatar');
            if (originalAvatar) {
                originalAvatar.style.display = 'flex';
                console.log('Original avatar shown');
            }
            
            // Remove enlarged avatar element
            enlargedAvatar.remove();
            console.log('Enlarged avatar removed');
            
            // Hide overlay
            overlay.classList.remove('active');
            console.log('Overlay deactivated');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Function to enlarge category image
        function enlargeCategoryImage(thumbElement) {
            const img = thumbElement.querySelector('img');
            if (!img) return;

            // Check if already enlarged
            if (document.querySelector('.thumb.enlarged') || document.querySelector('.avatar.enlarged')) {
                console.log('Image already enlarged, skipping...');
                return;
            }

            console.log('Enlarging category image...');
            const overlay = document.getElementById('avatarOverlay');
            
            // Store original position
            const originalRect = thumbElement.getBoundingClientRect();
            thumbElement.dataset.originalTop = originalRect.top + 'px';
            thumbElement.dataset.originalLeft = originalRect.left + 'px';
            thumbElement.dataset.originalWidth = originalRect.width + 'px';
            thumbElement.dataset.originalHeight = originalRect.height + 'px';
            
            // Hide original thumb
            thumbElement.style.display = 'none';
            console.log('Original thumb hidden');
            
            // Create a new enlarged thumb element
            const enlargedThumb = document.createElement('div');
            enlargedThumb.className = 'thumb enlarged';
            enlargedThumb.innerHTML = `
                <img src="${img.src}" alt="${img.alt}" style="width: 100%; height: 100%; object-fit: contain;" />
                <button type="button" class="close-btn" title="Đóng ảnh phóng to">
                    <i class="bi bi-x"></i>
                </button>
            `;
            
            // Add close button functionality
            const closeBtn = enlargedThumb.querySelector('.close-btn');
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                closeEnlargedCategoryImage();
            };
            
            // Add to body
            document.body.appendChild(enlargedThumb);
            console.log('Enlarged thumb added to body');
            
            // Show overlay
            overlay.classList.add('active');
            console.log('Overlay activated');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Function to close enlarged category image
        function closeEnlargedCategoryImage() {
            console.log('Closing enlarged category image...');
            const enlargedThumb = document.querySelector('.thumb.enlarged');
            if (!enlargedThumb) {
                console.log('No enlarged thumb found');
                return;
            }

            const overlay = document.getElementById('avatarOverlay');
            
            // Show original thumb
            const originalThumb = document.querySelector('.bl-grid .thumb');
            if (originalThumb) {
                originalThumb.style.display = 'block';
                console.log('Original thumb shown');
            }
            
            // Remove enlarged thumb element
            enlargedThumb.remove();
            console.log('Enlarged thumb removed');
            
            // Hide overlay
            overlay.classList.remove('active');
            console.log('Overlay deactivated');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEnlargedAvatar();
                closeEnlargedCategoryImage();
            }
        });
    </script>
}

<!-- Image Lightbox Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: fit-content;">
        <div class="modal-content bg-transparent border-0 position-relative">
            <button type="button" class="btn-close btn-close-white image-close-btn" data-bs-dismiss="modal" aria-label="Đóng"></button>
            <img id="modalImage" src="" alt="Ảnh phóng to" class="img-fluid" style="max-height: 90vh; max-width: 90vw; object-fit: contain;" />
        </div>
    </div>
</div>

<!-- Avatar Overlay -->
<div class="avatar-overlay" id="avatarOverlay" onclick="closeEnlargedAvatar()"></div>

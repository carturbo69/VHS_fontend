@using System.Text.Json
@using VHS_frontend.Areas.Admin.Models.RegisterProvider
@model AdminProviderDetailDTO

@{
    ViewData["Title"] = "Chi tiết hồ sơ nhà cung cấp";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";

    // ===== Map trạng thái: class + text tiếng Việt
    string MapStatusClass(string s) => s?.ToLower() switch
    {
        "pending" => "st-badge pending",
        "đang chờ duyệt" => "st-badge pending",
        "approved" => "st-badge ok",
        "đã duyệt" => "st-badge ok",
        "đã phê duyệt" => "st-badge ok",
        "rejected" => "st-badge rej",
        "đã từ chối" => "st-badge rej",
        "bị từ chối" => "st-badge rej",
        _ => "st-badge"
    };
    string MapStatusText(string s) => s?.ToLower() switch
    {
        "pending" => "Chờ phê duyệt",
        "đang chờ duyệt" => "Chờ phê duyệt",
        "approved" => "Đã phê duyệt",
        "đã duyệt" => "Đã phê duyệt",
        "đã phê duyệt" => "Đã phê duyệt",
        "rejected" => "Bị từ chối",
        "đã từ chối" => "Bị từ chối",
        "bị từ chối" => "Bị từ chối",
        _ => s
    };

    // ===== Cat map được truyền từ Controller
    var catMap = ViewBag.CatMap as IDictionary<Guid, string> ?? new Dictionary<Guid, string>();
    string CatName(Guid id) => catMap.TryGetValue(id, out var name) ? name : id.ToString();

    // ===== Tag map được truyền từ Controller
    var tagMap = ViewBag.TagMap as IDictionary<Guid, string> ?? new Dictionary<Guid, string>();
    string TagName(Guid id) => tagMap.TryGetValue(id, out var name) ? name : id.ToString();

    // ===== Parse list ảnh GPKD
    List<string> ToImages(string? json)
    {
        try { return string.IsNullOrWhiteSpace(json) ? new() : (JsonSerializer.Deserialize<List<string>>(json) ?? new()); }
        catch { return new(); }
    }

    // ===== Parse TagIds JSON string -> List<Guid>
    List<Guid> ToTagIds(string? json)
    {
        try { return string.IsNullOrWhiteSpace(json) ? new() : (JsonSerializer.Deserialize<List<Guid>>(json) ?? new()); }
        catch { return new(); }
    }

    // ===== Helper: Format DateTime - Database đã lưu giờ Việt Nam (UTC+7) rồi
    // Backend sử dụng GetVietnamTime() nên CreatedAt/ApprovedAt đã là giờ Việt Nam
    // Chỉ cần format hiển thị, không cần convert thêm
    string ToVietnamTime(DateTime? dateTime)
    {
        if (!dateTime.HasValue) return "-";
        
        // Database đã lưu giờ Việt Nam rồi, chỉ cần format
        return dateTime.Value.ToString("dd/MM/yyyy HH:mm");
    }
    
    // ===== Helper: Check if URL is PDF
    bool IsPDFFile(string url)
    {
        if (string.IsNullOrWhiteSpace(url)) return false;
        
        var lowerUrl = url.ToLower();
        
        // Check various PDF indicators
        // 1. Ends with .pdf
        if (lowerUrl.EndsWith(".pdf")) return true;
        
        // 2. Contains .pdf? (with query params)
        if (lowerUrl.Contains(".pdf?")) return true;
        
        // 3. Contains /pdf/ in path
        if (lowerUrl.Contains("/pdf/")) return true;
        
        // 4. Query parameter indicates PDF
        if (lowerUrl.Contains("type=pdf") || lowerUrl.Contains("format=pdf") || lowerUrl.Contains("filetype=pdf")) return true;
        
        // 5. Check filename in path (extract filename and check extension)
        try
        {
            var uri = new Uri(url, UriKind.RelativeOrAbsolute);
            var segments = uri.Segments;
            if (segments.Length > 0)
            {
                var lastSegment = segments[segments.Length - 1].ToLower();
                if (lastSegment.EndsWith(".pdf") || lastSegment.Contains(".pdf?"))
                    return true;
            }
        }
        catch { }
        
        // 6. Check if URL contains "pdf" as a distinct word (not part of another word)
        var urlWithoutQuery = lowerUrl.Split('?')[0];
        if (urlWithoutQuery.Contains("/pdf") || urlWithoutQuery.Contains("pdf/"))
            return true;
        
        return false;
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-register-provider.css" asp-append-version="true" />
}

<section class="arp container-fluid">
    <!-- Header -->
    <div class="arp__head card-x glass">
        <div class="left">
            <div class="ico"><i class="bi bi-person-badge-fill"></i></div>
            <div>
                <h3>@Model.ProviderName</h3>
                <div class="sub">Mã: <code>@Model.ProviderId</code></div>
            </div>
        </div>
        <div class="right">
            <div class="pill">
                <span class="lbl">Trạng thái</span>
                <span class="val"><span class="@MapStatusClass(Model.Status)">@MapStatusText(Model.Status)</span></span>
            </div>
            <div class="pill"><span class="lbl">Tạo:</span><span class="val">@ToVietnamTime(Model.CreatedAt)</span></div>
            <div class="pill"><span class="lbl">Duyệt:</span><span class="val">@ToVietnamTime(Model.ApprovedAt)</span></div>
        </div>
    </div>

    <div class="arp__grid">
        <!-- Pane: Thông tin -->
        <div class="card-x pane">
            <div class="pane__head">
                <i class="bi bi-person"></i>
                <h5>Thông tin</h5>
            </div>
            <div class="pane__body">
                <dl class="kv">
                    <dt>Tên nhà cung cấp</dt>
                    <dd>@Model.ProviderName</dd>

                    <dt>Tên tài khoản</dt>
                    <dd>@Model.AccountName</dd>

                    <dt>Điện thoại</dt>
                    <dd>@Model.PhoneNumber</dd>

                    <dt>Mô tả</dt>
                    <dd class="description-text">@Model.Description</dd>
                </dl>

                <div class="avatar-sec">
                    <div class="lbl">Ảnh đại diện</div>
                    <div class="avatar" onclick="enlargeAvatar(this)">
                        @if (!string.IsNullOrWhiteSpace(Model.Images))
                        {
                            <img src="@Model.Images" alt="Ảnh đại diện" class="clickable-image" data-src="@Model.Images" />
                        }
                        else
                        {
                            <div class="noimg">Không có ảnh</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Pane: Điều khoản & Bảo hiểm -->
        <div class="card-x pane">
            <div class="pane__head">
                <i class="bi bi-shield-check"></i>
                <h5>Điều khoản &amp; Bảo hiểm</h5>
            </div>
            <div class="pane__body">
                <div class="terms">
                    <div class="t-title">@Model.Terms?.Title</div>
                    <div class="t-desc description-text">@Model.Terms?.Description</div>
                </div>
            </div>
        </div>

        <!-- Pane full: Chứng chỉ & Giấy phép kinh doanh -->
        <div class="card-x pane pane--full">
            <div class="pane__head">
                <i class="bi bi-file-earmark-text"></i>
                <h5>Danh mục &amp; Giấy phép kinh doanh</h5>
            </div>
            <div class="pane__body">
                @{
                    // Tính toán tất cả ảnh GPKD trước (loại bỏ trùng lặp)
                    var allImages = new HashSet<string>(); // Dùng HashSet để tự động loại bỏ trùng
                    if (Model.Certificates?.Any() == true)
                    {
                        // Lấy ảnh từ tất cả certificates (vì tất cả đều có cùng ảnh do dùng chung)
                        // HashSet sẽ tự động loại bỏ trùng lặp
                        foreach (var cert in Model.Certificates)
                        {
                            var imgs = ToImages(cert.Images);
                            foreach (var img in imgs)
                            {
                                if (!string.IsNullOrWhiteSpace(img))
                                {
                                    allImages.Add(img); // HashSet tự động loại bỏ trùng
                                }
                            }
                        }
                    }
                    var uniqueImages = allImages.ToList(); // Convert về List để dễ dùng

                    // Kiểm tra có cho phép xóa không (chỉ khi status = Pending)
                    var canDelete = string.Equals(Model.Status, "Đang chờ duyệt", StringComparison.OrdinalIgnoreCase) || 
                                    string.Equals(Model.Status, "Pending", StringComparison.OrdinalIgnoreCase);
                }

                @if (Model.Certificates?.Any() == true)
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead style="background-color: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <tr>
                                    <th style="width: 50px; text-align: center;">#</th>
                                    <th style="width: 250px;">Danh mục</th>
                                    <th>Tag</th>
                                    @if (canDelete)
                                    {
                                        <th style="width: 150px; text-align: center;">Thao tác</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Certificates.Count; i++)
                                {
                                    var c = Model.Certificates[i];
                                    var tagIds = ToTagIds(c.TagIds);
                                    <tr id="cert-row-@c.CertificateId" style="border-bottom: 1px solid #e2e8f0;">
                                        <td style="text-align: center;">
                                            <span class="badge bg-secondary">#@(i + 1)</span>
                                        </td>
                                        <td>
                                            <strong style="color: #0ea5e9;">@CatName(c.CategoryId)</strong>
                                        </td>
                                        <td>
                                            @if (tagIds.Any())
                                            {
                                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                    @foreach (var tagId in tagIds)
                                                    {
                                                        @if (canDelete)
                                                        {
                                                            <span class="badge bg-primary d-flex align-items-center gap-1" style="padding: 6px 10px;">
                                                                <span>@TagName(tagId)</span>
                                                                <button type="button" 
                                                                        class="btn-close btn-close-white" 
                                                                        style="font-size: 10px; padding: 0; width: 12px; height: 12px;"
                                                                        onclick="removeTag('@c.CertificateId', '@tagId', '@TagName(tagId)')"
                                                                        title="Xóa tag này"
                                                                        aria-label="Xóa @TagName(tagId)"></button>
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-primary" style="padding: 6px 10px;">
                                                                @TagName(tagId)
                                                            </span>
                                                        }
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Không có dịch vụ</span>
                                            }
                                        </td>
                                        @if (canDelete)
                                        {
                                            <td style="text-align: center;">
                                                <button type="button" 
                                                        class="btn btn-sm btn-danger" 
                                                        onclick="deleteCertificate('@c.CertificateId', '@CatName(c.CategoryId)')"
                                                        title="Xóa toàn bộ chứng chỉ này">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @* Hiển thị TẤT CẢ ảnh/file GPKD chung ở đây (đã loại bỏ trùng lặp) *@
                    @if (uniqueImages.Any())
                    {
                        var imageCount = uniqueImages.Count(url => !IsPDFFile(url));
                        var pdfCount = uniqueImages.Count(url => IsPDFFile(url));
                        var totalCount = uniqueImages.Count;
                        
                        <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
                            <h6 style="color: #64748b; font-size: 14px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="bi bi-images" style="margin-right: 8px;"></i>
                                Giấy phép kinh doanh (@totalCount file@(totalCount > 1 ? "s" : "")@(imageCount > 0 && pdfCount > 0 ? $" - {imageCount} ảnh, {pdfCount} PDF" : ""))
                            </h6>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
                                @foreach (var url in uniqueImages)
                                {
                                    var isPDF = IsPDFFile(url);
                                    var fileName = url.Split('/').LastOrDefault() ?? "file";
                                    // Remove query parameters from filename for display
                                    if (fileName.Contains('?'))
                                    {
                                        fileName = fileName.Split('?')[0];
                                    }
                                    
                                    if (isPDF)
                                    {
                                        <figure class="file-preview pdf-preview" 
                                                style="margin: 0; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; transition: all 0.2s; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; gap: 8px;" 
                                                onclick="openPDF('@url')"
                                                onmouseover="this.style.borderColor='#dc2626'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(220,38,38,0.2)'"
                                                onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                                data-url="@url"
                                                title="Click để mở PDF: @fileName">
                                            <i class="bi bi-file-earmark-pdf" style="font-size: 48px; color: #dc2626;"></i>
                                            <div style="text-align: center; width: 100%;">
                                                <div style="font-size: 12px; font-weight: 600; color: #1e293b; word-break: break-word; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4;">
                                                    @(fileName.Length > 20 ? fileName.Substring(0, 20) + "..." : fileName)
                                                </div>
                                                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">PDF</div>
                                            </div>
                                        </figure>
                                    }
                                    else
                                    {
                                        <figure style="margin: 0; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; transition: all 0.2s;" 
                                                onclick="enlargeCategoryImage(this)"
                                                onmouseover="this.style.borderColor='#0ea5e9'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)'"
                                                onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <img src="@url" 
                                                 alt="GPKD" 
                                                 loading="lazy" 
                                                 data-src="@url"
                                                 style="width: 100%; height: 150px; object-fit: cover; display: block;" />
                                        </figure>
                                    }
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div style="margin-top: 24px; padding: 16px; background-color: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                            <p style="margin: 0; color: #92400e;">
                                <i class="bi bi-exclamation-triangle" style="margin-right: 8px;"></i>
                                <strong>Chưa có ảnh/file giấy phép kinh doanh</strong>
                            </p>
                        </div>
                    }
                }
                else
                {
                    <div class="note muted">Không có chứng chỉ</div>
                }
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions card-x">
        @if (string.Equals(Model.Status, "Đang chờ duyệt", StringComparison.OrdinalIgnoreCase) || 
             string.Equals(Model.Status, "Pending", StringComparison.OrdinalIgnoreCase))
        {
            <form method="post"
                  asp-area="Admin"
                  asp-controller="AdminRegisterProvider"
                  asp-action="Approve"
                  asp-route-id="@Model.ProviderId"
                  class="d-inline">
                @Html.AntiForgeryToken()
                <button class="btn btn-success soft"><i class="bi bi-check2-circle"></i> Duyệt</button>
            </form>

            <button class="btn btn-danger soft" data-bs-toggle="modal" data-bs-target="#rejectModal">
                <i class="bi bi-x-octagon"></i> Từ chối
            </button>
        }
        <a class="btn btn-ghost soft" asp-area="Admin" asp-controller="AdminRegisterProvider" asp-action="Index">Quay lại</a>
    </div>
</section>

<!-- Modal: Reject -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content card-x"
              method="post"
              asp-area="Admin"
              asp-controller="AdminRegisterProvider"
              asp-action="Reject"
              asp-route-id="@Model.ProviderId">
            @Html.AntiForgeryToken()
            <div class="modal-header">
                <h5 class="modal-title">Từ chối hồ sơ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Lý do (tuỳ chọn)</label>
                <textarea class="form-control" name="reason" rows="3" placeholder="Nhập lý do từ chối (nếu cần)…"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost soft" data-bs-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-danger soft">Xác nhận từ chối</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Image lightbox functionality
        document.addEventListener('DOMContentLoaded', function() {
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            const modalImage = document.getElementById('modalImage');
            
            // Add click handlers to all clickable images (except avatar images)
            document.querySelectorAll('.clickable-image').forEach(function(img) {
                // Skip images inside .avatar to avoid conflict
                if (img.closest('.avatar')) {
                    return;
                }
                img.style.cursor = 'pointer';
                img.addEventListener('click', function() {
                    modalImage.src = this.dataset.src || this.src;
                    imageModal.show();
                });
            });
        });

        // Function to enlarge avatar
        function enlargeAvatar(avatarElement) {
            const img = avatarElement.querySelector('img');
            if (!img) return;

            // Check if already enlarged
            if (document.querySelector('.avatar.enlarged')) {
                console.log('Avatar already enlarged, skipping...');
                return;
            }

            console.log('Enlarging avatar...');
            const overlay = document.getElementById('avatarOverlay');
            
            // Hide original avatar
            avatarElement.style.display = 'none';
            console.log('Original avatar hidden');
            
            // Create a new enlarged avatar element
            const enlargedAvatar = document.createElement('div');
            enlargedAvatar.className = 'avatar enlarged';
            enlargedAvatar.innerHTML = `
                <img src="${img.src}" alt="${img.alt}" style="width: 100%; height: 100%; object-fit: contain;" />
                <button type="button" class="close-btn" title="Đóng ảnh phóng to">
                    <i class="bi bi-x"></i>
                </button>
            `;
            
            // Add close button functionality
            const closeBtn = enlargedAvatar.querySelector('.close-btn');
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                closeEnlargedAvatar();
            };
            
            // Add to body
            document.body.appendChild(enlargedAvatar);
            console.log('Enlarged avatar added to body');
            
            // Show overlay
            overlay.classList.add('active');
            console.log('Overlay activated');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Function to close enlarged avatar
        function closeEnlargedAvatar() {
            console.log('Closing enlarged avatar...');
            const enlargedAvatar = document.querySelector('.avatar.enlarged');
            if (!enlargedAvatar) {
                console.log('No enlarged avatar found');
                return;
            }

            const overlay = document.getElementById('avatarOverlay');
            
            // Show original avatar
            const originalAvatar = document.querySelector('.avatar-sec .avatar');
            if (originalAvatar) {
                originalAvatar.style.display = 'flex';
                console.log('Original avatar shown');
            }
            
            // Remove enlarged avatar element
            enlargedAvatar.remove();
            console.log('Enlarged avatar removed');
            
            // Hide overlay
            overlay.classList.remove('active');
            console.log('Overlay deactivated');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Function to enlarge category image
        let currentEnlargedOriginal = null; // ✅ Lưu reference đến ảnh gốc
        
        function enlargeCategoryImage(thumbElement) {
            const img = thumbElement.querySelector('img');
            if (!img) return;

            // Check if already enlarged
            if (document.querySelector('.thumb.enlarged') || document.querySelector('.avatar.enlarged')) {
                console.log('Image already enlarged, skipping...');
                return;
            }

            console.log('Enlarging category image...');
            const overlay = document.getElementById('avatarOverlay');
            
            // Lưu reference đến ảnh gốc
            currentEnlargedOriginal = thumbElement;
            
            // Hide original thumb
            thumbElement.style.visibility = 'hidden'; // Dùng visibility thay vì display
            console.log('Original thumb hidden');
            
            // Create a new enlarged thumb element
            const enlargedThumb = document.createElement('div');
            enlargedThumb.className = 'thumb enlarged';
            enlargedThumb.innerHTML = `
                <img src="${img.src}" alt="${img.alt}" style="width: 100%; height: 100%; object-fit: contain;" />
                <button type="button" class="close-btn" title="Đóng ảnh phóng to">
                    <i class="bi bi-x"></i>
                </button>
            `;
            
            // Add close button functionality
            const closeBtn = enlargedThumb.querySelector('.close-btn');
            closeBtn.onclick = function(e) {
                e.stopPropagation();
                closeEnlargedCategoryImage();
            };
            
            // Add to body
            document.body.appendChild(enlargedThumb);
            console.log('Enlarged thumb added to body');
            
            // Show overlay
            overlay.classList.add('active');
            console.log('Overlay activated');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Function to close enlarged category image
        function closeEnlargedCategoryImage() {
            console.log('Closing enlarged category image...');
            const enlargedThumb = document.querySelector('.thumb.enlarged');
            if (!enlargedThumb) {
                console.log('No enlarged thumb found');
                return;
            }

            const overlay = document.getElementById('avatarOverlay');
            
            // Show lại ảnh gốc đã lưu
            if (currentEnlargedOriginal) {
                currentEnlargedOriginal.style.visibility = 'visible';
                console.log('Original thumb shown');
                currentEnlargedOriginal = null; // Reset reference
            }
            
            // Remove enlarged thumb element
            enlargedThumb.remove();
            console.log('Enlarged thumb removed');
            
            // Hide overlay
            overlay.classList.remove('active');
            console.log('Overlay deactivated');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEnlargedAvatar();
                closeEnlargedCategoryImage();
            }
        });

        // Function to remove tag from certificate
        async function removeTag(certId, tagId, tagName) {
            const url = `/Admin/AdminRegisterProvider/RemoveTag/${certId}/${tagId}`;
            console.log('🔥 RemoveTag URL:', url);
            console.log('🔥 CertId:', certId);
            console.log('🔥 TagId:', tagId);

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                console.log('🔥 Response status:', response.status);
                console.log('🔥 Response ok:', response.ok);

                if (response.ok) {
                    const result = await response.json();
                    console.log('🔥 Success result:', result);
                    
                    // Remove the badge from DOM instead of reloading
                    const badges = document.querySelectorAll(`button[onclick="removeTag('${certId}', '${tagId}', '${tagName.replace(/'/g, "\\'")}')"]`);
                    badges.forEach(badgeBtn => {
                        const badge = badgeBtn.closest('span.badge');
                        if (badge) {
                            badge.style.transition = 'opacity 0.2s ease-out';
                            badge.style.opacity = '0';
                            setTimeout(() => badge.remove(), 200);
                        }
                    });
                    
                    // Check if there are any remaining tags
                    setTimeout(() => {
                        const row = document.getElementById(`cert-row-${certId}`);
                        if (!row) return;
                        
                        const tagContainer = row.querySelector('td:nth-child(3)');
                        if (tagContainer) {
                            const remainingBadges = tagContainer.querySelectorAll('span.badge');
                            
                            // Nếu không còn tag nào, tự động xóa certificate
                            if (remainingBadges.length === 0) {
                                // Lấy tên danh mục từ row
                                const categoryCell = row.querySelector('td:nth-child(2)');
                                const categoryName = categoryCell ? categoryCell.textContent.trim() : 'Danh mục';
                                
                                console.log('🔥 Không còn tag nào, tự động xóa certificate:', certId);
                                
                                // Tự động xóa certificate
                                deleteCertificate(certId, categoryName);
                            }
                        }
                    }, 250);
                } else {
                    const error = await response.text();
                    console.error('🔥 Error response:', error);
                    alert(`Lỗi (${response.status}): ${error || 'Không có thông tin lỗi'}`);
                }
            } catch (err) {
                console.error('🔥 Exception:', err);
                alert(`Có lỗi xảy ra: ${err.message}`);
            }
        }

        // Function to remove category (= delete entire certificate)
        async function removeCategory(certId, catId, catName) {
            if (!confirm(`Bạn có chắc muốn bỏ danh mục "${catName}"?\n\n⚠️ Điều này sẽ XÓA TOÀN BỘ chứng chỉ!\nHành động không thể hoàn tác.`)) {
                return;
            }

            await deleteCertificate(certId, catName);
        }

        // Function để hiển thị thông báo ở giữa màn hình
        function showCenterNotification(message, type = 'warning') {
            // Xóa notification cũ nếu có
            const oldNotif = document.getElementById('center-notification');
            if (oldNotif) {
                oldNotif.remove();
            }

            // Tạo notification mới
            const notification = document.createElement('div');
            notification.id = 'center-notification';
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
                background: ${type === 'warning' ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : '#ffffff'};
                color: ${type === 'warning' ? '#92400e' : '#000000'};
                padding: 20px 32px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 2px solid ${type === 'warning' ? '#f59e0b' : '#e2e8f0'};
                font-size: 16px;
                font-weight: 600;
                text-align: center;
                min-width: 400px;
                animation: slideInCenter 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 24px; color: #f59e0b;"></i>
                    <span>${message}</span>
                </div>
            `;

            // Thêm animation CSS nếu chưa có
            if (!document.getElementById('center-notification-style')) {
                const style = document.createElement('style');
                style.id = 'center-notification-style';
                style.textContent = `
                    @@keyframes slideInCenter {
                        from {
                            opacity: 0;
                            transform: translate(-50%, -60%);
                        }
                        to {
                            opacity: 1;
                            transform: translate(-50%, -50%);
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Tự động ẩn sau 2 giây
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Function to detect PDF by trying to load as image
        async function detectPDFType(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(false); // It's an image
                img.onerror = () => {
                    // If image fails to load, might be PDF
                    // Check URL pattern as fallback
                    const lowerUrl = url.toLowerCase();
                    if (lowerUrl.includes('.pdf') || lowerUrl.includes('/pdf/') || 
                        lowerUrl.includes('type=pdf') || lowerUrl.includes('format=pdf')) {
                        resolve(true);
                    } else {
                        // Try to fetch with HEAD request to check content-type
                        fetch(url, { method: 'HEAD' })
                            .then(response => {
                                const contentType = response.headers.get('content-type') || '';
                                resolve(contentType.includes('application/pdf') || contentType.includes('pdf'));
                            })
                            .catch(() => resolve(false)); // Default to image on error
                    }
                };
                img.src = url;
            });
        }

        // Function to open PDF in new tab
        function openPDF(url) {
            window.open(url, '_blank');
        }
        
        // Check and update PDF previews on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const pdfPreviews = document.querySelectorAll('.file-preview.pdf-preview');
            const imagePreviews = document.querySelectorAll('figure:not(.pdf-preview)');
            
            // Check all previews that might be PDFs
            for (const preview of pdfPreviews) {
                const url = preview.dataset.url || preview.getAttribute('data-url');
                if (url) {
                    const isPDF = await detectPDFType(url);
                    if (!isPDF) {
                        // It's actually an image, convert to image preview
                        const figure = document.createElement('figure');
                        figure.style.cssText = 'margin: 0; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; transition: all 0.2s;';
                        figure.setAttribute('onclick', 'enlargeCategoryImage(this)');
                        figure.setAttribute('onmouseover', "this.style.borderColor='#0ea5e9'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)'");
                        figure.setAttribute('onmouseout', "this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none'");
                        figure.innerHTML = `<img src="${url}" alt="GPKD" loading="lazy" data-src="${url}" style="width: 100%; height: 150px; object-fit: cover; display: block;" />`;
                        preview.parentNode.replaceChild(figure, preview);
                    }
                }
            }
            
            // Also check image previews that might be PDFs
            for (const preview of imagePreviews) {
                const img = preview.querySelector('img');
                if (!img) continue;
                const url = img.src || img.dataset.src;
                if (!url) continue;
                
                const isPDF = await detectPDFType(url);
                if (isPDF) {
                    // It's actually a PDF, convert to PDF preview
                    const fileName = url.split('/').pop() || 'file.pdf';
                    const pdfPreview = document.createElement('figure');
                    pdfPreview.className = 'file-preview pdf-preview';
                    pdfPreview.style.cssText = 'margin: 0; cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; transition: all 0.2s; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; gap: 8px;';
                    pdfPreview.setAttribute('onclick', `openPDF('${url}')`);
                    pdfPreview.setAttribute('onmouseover', "this.style.borderColor='#dc2626'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(220,38,38,0.2)'");
                    pdfPreview.setAttribute('onmouseout', "this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none'");
                    pdfPreview.setAttribute('data-url', url);
                    pdfPreview.setAttribute('title', `Click để mở PDF: ${fileName}`);
                    pdfPreview.innerHTML = `
                        <i class="bi bi-file-earmark-pdf" style="font-size: 48px; color: #dc2626;"></i>
                        <div style="text-align: center; width: 100%;">
                            <div style="font-size: 12px; font-weight: 600; color: #1e293b; word-break: break-word; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4;">
                                ${fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName}
                            </div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">PDF</div>
                        </div>
                    `;
                    preview.parentNode.replaceChild(pdfPreview, preview);
                }
            }
        });

        // Function to delete entire certificate
        async function deleteCertificate(certId, categoryName) {
            const row = document.getElementById(`cert-row-${certId}`);
            if (!row) {
                showCenterNotification('Không tìm thấy chứng chỉ!', 'error');
                return;
            }

            try {
                const response = await fetch(`/Admin/AdminRegisterProvider/DeleteCertificate/${certId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                if (response.ok) {
                    // Đếm số certificate còn lại (trước khi xóa row khỏi DOM)
                    const tbody = document.querySelector('tbody');
                    const allCertificateRows = tbody ? Array.from(tbody.children).filter(row => row.id && row.id.startsWith('cert-row-')) : [];
                    const remainingCountAfterDelete = allCertificateRows.length - 1; // Trừ đi row đang xóa
                    
                    // Kiểm tra nếu không còn certificate nào (đã xóa hết) - kiểm tra TRƯỚC khi animate
                    if (remainingCountAfterDelete === 0) {
                        // Đã xóa hết certificate - tự động từ chối hồ sơ provider NGAY LẬP TỨC
                        const providerId = '@Model.ProviderId';
                        const rejectReason = 'Đã xóa hết danh mục dịch vụ';
                        
                        console.log('🔥 Đã xóa hết certificate, tự động từ chối provider:', providerId);
                        
                        // Xóa row ngay lập tức (không animate để nhanh hơn)
                        row.remove();
                        
                        // Hiển thị thông báo ở giữa màn hình
                        showCenterNotification('⚠️ Đã xóa hết danh mục dịch vụ. Hệ thống sẽ tự động từ chối hồ sơ này.', 'warning');
                        
                        // Tạo form để submit reject ngay lập tức
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/Admin/AdminRegisterProvider/Reject/${providerId}`;
                        form.style.display = 'none';
                        
                        // Thêm anti-forgery token
                        const token = document.querySelector('input[name="__RequestVerificationToken"]');
                        if (token) {
                            const tokenInput = document.createElement('input');
                            tokenInput.type = 'hidden';
                            tokenInput.name = '__RequestVerificationToken';
                            tokenInput.value = token.value;
                            form.appendChild(tokenInput);
                        }
                        
                        // Thêm reason
                        const reasonInput = document.createElement('input');
                        reasonInput.type = 'hidden';
                        reasonInput.name = 'reason';
                        reasonInput.value = rejectReason;
                        form.appendChild(reasonInput);
                        
                        // Submit ngay lập tức (không đợi delay)
                        document.body.appendChild(form);
                        form.submit();
                        return; // Không tiếp tục vì sẽ redirect
                    }
                    
                    // Nếu còn certificate, mới animate row removal
                    row.style.backgroundColor = '#fee2e2';
                    row.style.transition = 'opacity 0.1s ease-out';
                    row.style.opacity = '0';
                    
                    setTimeout(() => {
                        row.remove();
                        
                        // Nếu còn certificate, hiển thị empty message nếu table trống
                        const remainingRows = tbody ? Array.from(tbody.children).filter(row => row.id && row.id.startsWith('cert-row-')) : [];
                        if (remainingRows.length === 0) {
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = '<td colspan="4" class="text-center text-muted" style="padding: 40px;">Không có chứng chỉ</td>';
                            tbody.appendChild(emptyRow);
                        }
                    }, 100); // Nhanh hơn - chỉ 100ms
                } else {
                    const error = await response.text();
                    showCenterNotification(`Lỗi xóa chứng chỉ: ${error}`, 'error');
                }
            } catch (err) {
                console.error('Error deleting certificate:', err);
                showCenterNotification('Có lỗi xảy ra khi xóa chứng chỉ!', 'error');
            }
        }
    </script>
}

<!-- Image Lightbox Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: fit-content;">
        <div class="modal-content bg-transparent border-0 position-relative">
            <button type="button" class="btn-close btn-close-white image-close-btn" data-bs-dismiss="modal" aria-label="Đóng"></button>
            <img id="modalImage" src="" alt="Ảnh phóng to" class="img-fluid" style="max-height: 90vh; max-width: 90vw; object-fit: contain;" />
        </div>
    </div>
</div>

<!-- Avatar Overlay -->
<div class="avatar-overlay" id="avatarOverlay" onclick="closeEnlargedAvatar()"></div>

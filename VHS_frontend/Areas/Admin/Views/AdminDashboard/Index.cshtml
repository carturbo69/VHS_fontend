@model VHS_frontend.Areas.Admin.Models.Dashboard.DashboardViewModel
@{
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
    ViewData["Title"] = "Tổng quan";
}

@functions {
    public string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} phút trước";
        else if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} giờ trước";
        else if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} ngày trước";
        else
            return dateTime.ToString("dd/MM/yyyy");
    }
    
    public string FormatLargeCurrency(decimal value)
    {
        if (value >= 1000000000) // >= 1 tỷ
        {
            var ty = value / 1000000000;
            return ty >= 10 ? $"{ty:F0} tỷ" : $"{ty:F1} tỷ";
        }
        else if (value >= 1000000) // >= 1 triệu
        {
            var trieu = value / 1000000;
            return trieu >= 10 ? $"{trieu:F0} triệu" : $"{trieu:F1} triệu";
        }
        else
        {
            return value.ToString("N0");
        }
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />
}

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <div class="welcome-content">
                <h1 class="welcome-title">
                    <i class="bi bi-house-door-fill"></i>
                    Chào mừng trở lại, @{
                        var username = Context.Session.GetString("Username");
                        if (!string.IsNullOrEmpty(username) && username.Contains("@"))
                        {
                            username = username.Split('@')[0];
                        }
                        @username
                    }!
                </h1>
                <p class="welcome-subtitle">Tổng quan hệ thống Viet Home Service</p>
                <div class="welcome-stats">
                    <!-- <div class="mini-stat">
                        <i class="bi bi-clock"></i>
                        <span>Thời gian hoạt động: <strong id="uptime">24h 15m</strong></span>
                    </div> -->
                    <div class="mini-stat">
                        <i class="bi bi-shield-check"></i>
                        <span>Trạng thái: <strong class="status-online">Trực tuyến</strong></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <div class="info-cards-group">
                <div class="date-info">
                    <i class="bi bi-calendar3"></i>
                    <span id="currentDate"></span>
                </div>
                <!-- <div class="weather-info">
                    <i class="bi bi-sun"></i>
                    <span>Cần Thơ, 32°C</span>
                </div> -->
            </div>
            <button class="btn btn-outline-primary btn-refresh" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i>
                Làm mới
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card revenue">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@FormatLargeCurrency(Model.TodayRevenue) đ</div>
                <div class="stat-label">Doanh thu hôm nay</div>
                <div class="stat-change @(Model.RevenueChange >= 0 ? "positive" : "negative")">
                    <i class="bi bi-arrow-@(Model.RevenueChange >= 0 ? "up" : "down")"></i>
                    @(Model.RevenueChange >= 0 ? "+" : "")@Model.RevenueChange.ToString("F1")% so với hôm qua
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: @(Math.Min(Model.RevenueProgress, 100))%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card orders">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-receipt"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.TodayOrders</div>
                <div class="stat-label">Đơn hàng hôm nay</div>
                <div class="stat-change @(Model.OrdersChange >= 0 ? "positive" : "negative")">
                    <i class="bi bi-arrow-@(Model.OrdersChange >= 0 ? "up" : "down")"></i>
                    @(Model.OrdersChange >= 0 ? "+" : "")@Model.OrdersChange.ToString("F1")% so với hôm qua
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: @(Math.Min(Model.OrdersProgress, 100))%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card customers">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.ActiveCustomers</div>
                <div class="stat-label">Khách hàng hoạt động</div>
                <div class="stat-change @(Model.CustomersChange >= 0 ? "positive" : "negative")">
                    <i class="bi bi-arrow-@(Model.CustomersChange >= 0 ? "up" : "down")"></i>
                    @(Model.CustomersChange >= 0 ? "+" : "")@Model.CustomersChange.ToString("F1")% tháng này
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: @(Math.Min(Model.CustomersProgress, 100))%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card providers">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-buildings"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.ActiveProviders</div>
                <div class="stat-label">Nhà cung cấp</div>
                <div class="stat-change @(Model.ProvidersChange >= 0 ? "positive" : Model.ProvidersChange < 0 ? "negative" : "neutral")">
                    <i class="bi bi-@(Model.ProvidersChange > 0 ? "arrow-up" : Model.ProvidersChange < 0 ? "arrow-down" : "dash")"></i>
                    @(Model.ProvidersChange > 0 ? "+" : Model.ProvidersChange < 0 ? "" : "")@(Model.ProvidersChange != 0 ? Model.ProvidersChange.ToString("F1") + "%" : "Không đổi")
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: @(Math.Min(Model.ProvidersProgress, 100))%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card conversion">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.ConversionRate.ToString("F1")%</div>
                <div class="stat-label">Tỷ lệ chuyển đổi</div>
                <div class="stat-change @(Model.ConversionChange >= 0 ? "positive" : "negative")">
                    <i class="bi bi-arrow-@(Model.ConversionChange >= 0 ? "up" : "down")"></i>
                    @(Model.ConversionChange >= 0 ? "+" : "")@Model.ConversionChange.ToString("F1")% so với tuần trước
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: @(Math.Min(Model.ConversionRate, 100))%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card satisfaction">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-star-fill"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.AverageRating.ToString("F1")/5</div>
                <div class="stat-label">Đánh giá trung bình</div>
                <div class="stat-change @(Model.RatingChange >= 0 ? "positive" : "negative")">
                    <i class="bi bi-arrow-@(Model.RatingChange >= 0 ? "up" : "down")"></i>
                    @(Model.RatingChange >= 0 ? "+" : "")@Model.RatingChange.ToString("F1") so với tháng trước
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: @(Math.Min(Model.AverageRating * 20, 100))%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card providers">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-briefcase"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.TotalServices</div>
                <div class="stat-label">Tổng dịch vụ</div>
                <div class="stat-change neutral">
                    <i class="bi bi-dash"></i>
                    Toàn hệ thống
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card revenue">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-menu">
                    <button class="btn-menu" onclick="toggleStatMenu(this)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <div class="stat-content">
                <div class="stat-value">@FormatLargeCurrency(Model.TotalSystemRevenue) đ</div>
                <div class="stat-label">Tổng doanh thu hệ thống</div>
                <div class="stat-change neutral">
                    <i class="bi bi-check-circle"></i>
                    Chỉ tính đơn đã thanh toán
                </div>
                <div class="stat-progress">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container main-chart">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-graph-up"></i> Doanh thu @{
                        var revenueDays = Context.Request.Query["revenueDays"].FirstOrDefault();
                        var days = !string.IsNullOrEmpty(revenueDays) ? int.Parse(revenueDays) : 7;
                        @($"{days} ngày qua");
                    }</h3>
                    <div class="chart-summary">
                        @if (Model.RevenueWeekChange > 0)
                        {
                            <span class="summary-item">
                                <i class="bi bi-arrow-up text-success"></i>
                                <span>Tăng @Model.RevenueWeekChange.ToString("F1")%</span>
                            </span>
                        }
                        else if (Model.RevenueWeekChange < 0)
                        {
                            <span class="summary-item">
                                <i class="bi bi-arrow-down text-danger"></i>
                                <span>Giảm @Math.Abs(Model.RevenueWeekChange).ToString("F1")%</span>
                            </span>
                        }
                        else
                        {
                            <span class="summary-item">
                                <i class="bi bi-dash text-muted"></i>
                                <span>Không đổi</span>
                            </span>
                        }
                        <span class="summary-item">
                            <i class="bi bi-calendar"></i>
                            <span>So với tuần trước</span>
                        </span>
                    </div>
                </div>
                <div class="chart-controls">
                    @{
                        var currentRevenueDays = Context.Request.Query["revenueDays"].FirstOrDefault();
                        var currentDays = !string.IsNullOrEmpty(currentRevenueDays) ? int.Parse(currentRevenueDays) : 7;
                    }
                    <button class="btn btn-sm btn-outline-primary @(currentDays == 7 ? "active" : "")" data-period="7" onclick="changeRevenuePeriod(7)">7 ngày</button>
                    <button class="btn btn-sm btn-outline-primary @(currentDays == 15 ? "active" : "")" data-period="15" onclick="changeRevenuePeriod(15)">15 ngày</button>
                    <button class="btn btn-sm btn-outline-primary @(currentDays == 30 ? "active" : "")" data-period="30" onclick="changeRevenuePeriod(30)">30 ngày</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="exportChart()">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-pie-chart"></i> Phân bố dịch vụ</h3>
                    <div class="chart-summary">
                        <span class="summary-item">
                            <i class="bi bi-info-circle"></i>
                            <span>@(Model.ServiceDistributions?.Count ?? 0) loại dịch vụ</span>
                        </span>
                    </div>
                </div>
                <div class="chart-legend-toggle">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleLegend()">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="serviceChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-bar-chart"></i> Đơn hàng theo giờ</h3>
                    <div class="chart-summary">
                        <span class="summary-item">
                            <i class="bi bi-clock"></i>
                            <span>24 giờ qua</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity & Notifications -->
    <div class="activity-section">
        <div class="activity-container">
            <div class="activity-header">
                <h3><i class="bi bi-clock-history"></i> Hoạt động gần đây</h3>
                <!-- <a href="#" class="btn btn-sm btn-outline-primary">Xem tất cả</a> -->
            </div>
            <div class="activity-list">
                @if (Model.RecentActivities != null && Model.RecentActivities.Any())
                {
                    @foreach (var activity in Model.RecentActivities)
                    {
                        string iconClass = "info-circle";
                        // Xử lý rõ ràng từng loại ActivityType
                        if (activity.ActivityType == "payment")
                        {
                            iconClass = "credit-card"; // Icon cho thanh toán thành công
                        }
                        else if (activity.ActivityType == "new-order")
                        {
                            iconClass = "cart-plus"; // Icon cho đơn hàng mới
                        }
                        else if (activity.ActivityType == "error" || activity.ActivityType == "danger")
                        {
                            iconClass = "x-circle"; // Icon màu đỏ cho hủy đơn
                        }
                        else if (activity.ActivityType == "warning")
                        {
                            iconClass = "exclamation-triangle";
                        }
                        else if (activity.ActivityType == "success")
                        {
                            iconClass = activity.Title.Contains("Thanh toán") ? "credit-card" : "check-circle";
                        }
                        else if (activity.Title.Contains("Đơn hàng mới") || activity.Title.Contains("Đặt đơn"))
                        {
                            iconClass = "cart-plus";
                        }
                        
                        <div class="activity-item">
                            <div class="activity-icon @activity.ActivityType">
                                <i class="bi bi-@iconClass"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">@activity.Title</div>
                                <div class="activity-desc">@activity.Description</div>
                                <div class="activity-time">@GetTimeAgo(activity.CreatedAt)</div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-clock-history fs-1"></i>
                        <p class="mt-2">Chưa có hoạt động nào</p>
                    </div>
                }

            </div>
        </div>

        <div class="provider-registrations-container">
            <div class="provider-registrations-header">
                <h3><i class="bi bi-clipboard-check"></i> Đăng ký nhà cung cấp</h3>
                <a asp-area="Admin" asp-controller="AdminRegisterProvider" asp-action="Index" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
            </div>
            <div class="provider-registrations-list">
                @if (Model.ProviderRegistrations != null && Model.ProviderRegistrations.Any())
                {
                    @foreach (var registration in Model.ProviderRegistrations.Take(4))
                    {
                        <div class="registration-item @registration.Status">
                            <div class="registration-icon">
                                <i class="bi bi-@(registration.Status == "pending" ? "clock" : registration.Status == "approved" ? "check-circle" : "x-circle")"></i>
                            </div>
                            <div class="registration-content">
                                <div class="registration-title">@registration.CompanyName</div>
                                <div class="registration-desc">@registration.ServiceDescription</div>
                                <div class="registration-time">@GetTimeAgo(registration.CreatedAt)</div>
                            </div>
                            <div class="registration-status">
                                <span class="badge bg-@(registration.Status == "pending" ? "warning" : registration.Status == "approved" ? "success" : "danger")">
                                    @(registration.Status == "pending" ? "Chờ duyệt" : registration.Status == "approved" ? "Đã duyệt" : "Từ chối")
                                </span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">Chưa có đăng ký nào</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Additional Charts Section -->
    <div class="additional-charts-section">
        <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-bar-chart-line"></i> Doanh thu theo tháng</h3>
                    <div class="chart-summary">
                        <span class="summary-item">
                            <i class="bi bi-calendar-month"></i>
                            <span>@(Model.SelectedMonths == 12 ? $"Năm {Model.SelectedYear}" : "6 tháng gần nhất")</span>
                        </span>
                    </div>
                </div>
                <div class="chart-controls">
                    <select id="yearSelect" class="form-select form-select-sm" style="width:auto; display:@(Model.SelectedMonths==12 ? "inline-block" : "none"); margin-right:8px;">
                        @{
                            var currentYear = DateTime.Now.Year;
                            for (int y = currentYear; y >= currentYear - 4; y--)
                            {
                                <option value="@y" selected="@(Model.SelectedYear==y)">@y</option>
                            }
                        }
                    </select>
                    <button class="btn btn-sm btn-outline-primary @(Model.SelectedMonths==12 ? "active" : "")" data-period="12m">12 tháng</button>
                    <button class="btn btn-sm btn-outline-primary @(Model.SelectedMonths==6 ? "active" : "")" data-period="6m">6 tháng</button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="monthlyRevenueChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-people-fill"></i> Khách hàng mới</h3>
                    <div class="chart-summary">
                        <span class="summary-item">
                            <i class="bi bi-person-plus"></i>
                            <span>15 ngày qua</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="newCustomersChart"></canvas>
            </div>
        </div>

        <!-- Hàng 2: Đánh giá dịch vụ | Đơn hàng theo tuần -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-star-fill"></i> Đánh giá dịch vụ</h3>
                    <div class="chart-summary">
                        <span class="summary-item">
                            <i class="bi bi-star"></i>
                            <span>Phân bố rating</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="ratingChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">
                    <h3><i class="bi bi-calendar-week"></i> Đơn hàng theo tuần</h3>
                    <div class="chart-summary">
                        <span class="summary-item">
                            <i class="bi bi-calendar3"></i>
                            <span>Tuần hiện tại (Thứ 2 - CN)</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="weeklyOrdersChart"></canvas>
            </div>
        </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <div class="quick-actions-header">
            <h3><i class="bi bi-lightning"></i> Thao tác nhanh</h3>
            <div class="quick-actions-info">
                <span class="info-text">Truy cập nhanh các chức năng chính</span>
            </div>
        </div>
        <div class="actions-grid">
            <a asp-area="Admin" asp-controller="AdminCustomer" asp-action="Index" class="action-card">
                <div class="action-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Quản lý khách hàng</span>
                    <span class="action-desc">@Model.ActiveCustomers khách hàng</span>
                </div>
                <div class="action-arrow">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </a>
            <a asp-area="Admin" asp-controller="AdminProvider" asp-action="Index" class="action-card">
                <div class="action-icon">
                    <i class="bi bi-buildings"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Quản lý nhà cung cấp</span>
                    <span class="action-desc">@Model.ActiveProviders nhà cung cấp</span>
                </div>
                <div class="action-arrow">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </a>
            <a asp-area="Admin" asp-controller="AdminRegisterProvider" asp-action="Index" class="action-card">
                <div class="action-icon">
                    <i class="bi bi-clipboard-check"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Duyệt đăng ký</span>
                    <span class="action-desc">@Model.ProviderRegistrations.Count(r => r.Status == "pending") đăng ký mới</span>
                </div>
                <div class="action-arrow">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </a>
            <a asp-area="Admin" asp-controller="AdminVoucher" asp-action="Index" class="action-card">
                <div class="action-icon">
                    <i class="bi bi-ticket-perforated"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Quản lý voucher</span>
                    <span class="action-desc">@Model.ActiveVouchers voucher hoạt động</span>
                </div>
                <div class="action-arrow">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('vi-VN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Revenue Chart
        const revenueLabels = @Html.Raw(Json.Serialize(Model.RevenueChartLabels));
        const revenueData = @Html.Raw(Json.Serialize(Model.RevenueChartData));
        
        console.log('📊 Revenue Chart Labels:', revenueLabels);
        console.log('💰 Revenue Chart Data:', revenueData);
        
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Doanh thu (₫)',
                    data: revenueData,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₫' + value.toLocaleString('vi-VN');
                            }
                        }
                    }
                }
            }
        });

        // Service Distribution Chart
        const serviceCtx = document.getElementById('serviceChart').getContext('2d');
        const serviceChart = new Chart(serviceCtx, {
            type: 'doughnut',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.ServiceDistributions.Select(s => s.ServiceName))),
                datasets: [{
                    data: @Html.Raw(Json.Serialize(Model.ServiceDistributions.Select(s => s.Percentage))),
                    backgroundColor: [
                        '#2563eb',
                        '#06b6d4',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // Orders by Hour Chart
        const ordersCtx = document.getElementById('ordersChart').getContext('2d');
        const ordersChart = new Chart(ordersCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.OrdersChartLabels)),
                datasets: [{
                    label: 'Đơn hàng',
                    data: @Html.Raw(Json.Serialize(Model.OrdersChartData)),
                    backgroundColor: 'rgba(37, 99, 235, 0.8)',
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 2
                        }
                    }
                }
            }
        });

        // Monthly Revenue Chart
        const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
        const monthlyRevenueChart = new Chart(monthlyRevenueCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.MonthlyRevenueLabels)),
                datasets: [{
                    label: 'Doanh thu (₫)',
                    data: @Html.Raw(Json.Serialize(Model.MonthlyRevenueData)),
                    backgroundColor: 'rgba(37, 99, 235, 0.8)',
                    borderColor: '#2563eb',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value === 0 || value < 0.01) {
                                    return '₫0';
                                }
                                const millions = value / 1000000;
                                if (millions >= 1) {
                                    return '₫' + millions.toFixed(1) + 'M';
                                } else if (millions >= 0.001) {
                                    return '₫' + (millions * 1000).toFixed(0) + 'K';
                                } else {
                                    return '₫' + value.toLocaleString('vi-VN');
                                }
                            }
                        }
                    }
                }
            }
        });

        // New Customers Chart
        const newCustomersCtx = document.getElementById('newCustomersChart').getContext('2d');
        const newCustomersChart = new Chart(newCustomersCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.NewCustomersChartLabels)),
                datasets: [{
                    label: 'Khách hàng mới',
                    data: @Html.Raw(Json.Serialize(Model.NewCustomersChartData)),
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0,
                            callback: function(value) {
                                return Math.round(value);
                            }
                        }
                    }
                }
            }
        });

        // Rating Chart
        const ratingCtx = document.getElementById('ratingChart').getContext('2d');
        const ratingDistributions = @Html.Raw(Json.Serialize(Model.RatingDistributions));
        
        // Hàm gán màu cho từng mức đánh giá
        function getRatingColor(stars) {
            switch(stars) {
                case 1:
                    return '#dc2626'; // Đỏ đậm - Tệ nhất
                case 2:
                    return '#f97316'; // Cam đậm - Kém
                case 3:
                    return '#fbbf24'; // Vàng - Trung bình
                case 4:
                    return '#3b82f6'; // Xanh dương - Tốt
                case 5:
                    return '#10b981'; // Xanh lá - Tuyệt vời
                default:
                    return '#6b7280'; // Xám - Mặc định
            }
        }
        
        // Sắp xếp theo số sao từ 1 đến 5 và gán màu tương ứng
        const sortedRatings = ratingDistributions
            .slice()
            .sort((a, b) => (a.Stars || a.stars) - (b.Stars || b.stars))
            .map(r => {
                const stars = r.Stars || r.stars;
                const percentage = r.Percentage || r.percentage;
                return {
                    label: stars + " sao",
                    data: percentage,
                    color: getRatingColor(stars)
                };
            });
        
        const ratingChart = new Chart(ratingCtx, {
            type: 'doughnut',
            data: {
                labels: sortedRatings.map(r => r.label),
                datasets: [{
                    data: sortedRatings.map(r => r.data),
                    backgroundColor: sortedRatings.map(r => r.color),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        // Weekly Orders Chart - Hiển thị số đơn hàng
        const weeklyOrdersCtx = document.getElementById('weeklyOrdersChart').getContext('2d');
        const weeklyOrdersChart = new Chart(weeklyOrdersCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.WeeklyOrdersLabels)),
                datasets: [{
                    label: 'Số đơn hàng',
                    data: @Html.Raw(Json.Serialize(Model.WeeklyOrdersData)),
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                    borderColor: '#8b5cf6',
                    borderWidth: 2,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1, // Bước nhảy 1 để hiển thị chính xác hơn
                            precision: 0
                        }
                    }
                },
                elements: {
                    bar: {
                        borderRadius: 6
                    }
                }
            }
        });

        // Ensure all charts resize correctly when layout width changes (e.g., sidebar toggle)
        const allCharts = [revenueChart, serviceChart, ordersChart, monthlyRevenueChart, newCustomersChart, ratingChart, weeklyOrdersChart];
        function debounce(fn, delay = 150) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); }; }
        function resizeCharts() { allCharts.forEach(c => { try { c.resize(); } catch(e){} }); }
        window.addEventListener('resize', debounce(resizeCharts, 150));
        if (window.ResizeObserver) {
            const ro = new ResizeObserver(debounce(resizeCharts, 50));
            document.querySelectorAll('.dashboard-container, .charts-section, .additional-charts-section').forEach(el => ro.observe(el));
        }
        document.addEventListener('click', (e) => {
            const sel = '.sidebar-toggle, .menu-toggle, .navbar-toggler, [data-bs-target="#sidebar"], [data-toggle="sidebar"]';
            if (e.target.closest(sel)) {
                setTimeout(resizeCharts, 350);
            }
        });

        // Revenue Chart Period Control
        function changeRevenuePeriod(days) {
            // Cập nhật URL với query parameter
            const url = new URL(window.location.href);
            url.searchParams.set('revenueDays', days);
            
            // Reload trang để lấy dữ liệu mới
            window.location.href = url.toString();
        }

        // Chart period controls for Monthly Revenue
        document.querySelectorAll('.chart-container:not(.main-chart) [data-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.chart-container:not(.main-chart) [data-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const period = this.getAttribute('data-period');
                const url = new URL(window.location.href);
                if (period === '12m') {
                    url.searchParams.set('months', '12');
                    const yearSel = document.getElementById('yearSelect');
                    if (yearSel) {
                        yearSel.style.display = 'inline-block';
                        url.searchParams.set('year', yearSel.value);
                    }
                } else {
                    url.searchParams.set('months', '6');
                    url.searchParams.delete('year');
                }
                window.location.href = url.toString();
            });
        });
        const yearSelect = document.getElementById('yearSelect');
        if (yearSelect) {
            yearSelect.addEventListener('change', function () {
                const url = new URL(window.location.href);
                url.searchParams.set('months', '12');
                url.searchParams.set('year', this.value);
                window.location.href = url.toString();
            });
        }

        // Additional functions
        function refreshDashboard() {
            const btn = document.querySelector('.btn-refresh');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Đang tải...';
            }
            // Reload toàn bộ trang để lấy dữ liệu thật từ server (không random)
            window.location.reload();
        }

        // Ngừng mô phỏng số liệu ngẫu nhiên để tránh “nhảy tào lao”
        function updateStats() { /* no-op: dữ liệu được làm mới qua reload */ }

        function updateCharts() { /* no-op: dữ liệu được làm mới qua reload */ }

        function exportChart() {
            showNotice('Đang xuất biểu đồ...', 'info');
            
            // Simulate chart export
            setTimeout(() => {
                // Create a temporary canvas for export
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 800;
                canvas.height = 400;
                
                // Fill with white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add title
                ctx.fillStyle = '#333333';
                ctx.font = '24px Arial';
                ctx.fillText('Dashboard Export', 50, 50);
                
                // Add timestamp
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666666';
                ctx.fillText(new Date().toLocaleString('vi-VN'), 50, 80);
                
                // Convert to blob and download
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'dashboard-export-' + new Date().getTime() + '.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
                showNotice('Biểu đồ đã được xuất thành công!', 'success');
            }, 1000);
        }

        function toggleLegend() {
            if (typeof serviceChart !== 'undefined') {
                const currentOptions = serviceChart.options.plugins.legend;
                serviceChart.options.plugins.legend.display = !currentOptions.display;
                serviceChart.update();
                showNotice('Chế độ hiển thị đã được chuyển đổi', 'info');
            }
        }

        function toggleStatMenu(btn) {
            // Create dropdown menu
            const menu = document.createElement('div');
            menu.className = 'stat-menu-dropdown';
            menu.innerHTML = `
                <div class="menu-item" onclick="viewDetails('${btn.closest('.stat-card').className.split(' ')[1]}')">
                    <i class="bi bi-eye"></i>
                    <span>Xem chi tiết</span>
                </div>
                <div class="menu-item" onclick="exportStat('${btn.closest('.stat-card').className.split(' ')[1]}')">
                    <i class="bi bi-download"></i>
                    <span>Xuất dữ liệu</span>
                </div>
                <div class="menu-item" onclick="refreshStat('${btn.closest('.stat-card').className.split(' ')[1]}')">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Làm mới</span>
                </div>
            `;
            
            // Position menu
            const rect = btn.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.left = (rect.left - 100) + 'px';
            menu.style.zIndex = '1000';
            
            // Remove existing menu
            document.querySelectorAll('.stat-menu-dropdown').forEach(m => m.remove());
            
            // Add new menu
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target) && e.target !== btn) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }

        function viewDetails(statType) {
            showNotice(`Xem chi tiết ${statType}`, 'info');
        }

        function exportStat(statType) {
            showNotice(`Xuất dữ liệu ${statType}`, 'success');
        }

        function refreshStat(statType) {
            showNotice(`Làm mới ${statType}`, 'info');
        }

        function showNotice(msg, type='info', duration=900){
            const root = document.getElementById('notif-root') || createNotificationRoot();
            const box = document.createElement('div');
            box.className = `center-toast ${type}`;
            box.innerHTML = `
                <div class="toast-box">
                    <div class="accent"></div>
                    <i class="bi ${type==='success'?'bi-check-circle':
                                     type==='error'  ?'bi-x-circle'   :
                                     type==='warn'   ?'bi-exclamation-triangle' : 'bi-info-circle'}"></i>
                    <span class="msg">${msg}</span>
                </div>`;
            root.appendChild(box);
            requestAnimationFrame(()=> box.classList.add('show'));
            setTimeout(()=> { box.classList.remove('show'); setTimeout(()=> box.remove(), 180); }, duration);
        }

        function createNotificationRoot() {
            const root = document.createElement('div');
            root.id = 'notif-root';
            root.setAttribute('aria-live', 'polite');
            root.setAttribute('aria-atomic', 'true');
            document.body.appendChild(root);
            return root;
        }

        // Animate stats on load
        document.addEventListener('DOMContentLoaded', function() {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Animate progress bars
            setTimeout(() => {
                document.querySelectorAll('.progress-bar').forEach(bar => {
                    const width = bar.style.width;
                    bar.style.width = '0%';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, 200);
                });
            }, 1000);
        });
    </script>
}

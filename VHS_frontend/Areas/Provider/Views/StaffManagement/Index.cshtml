@model List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Nh√¢n vi√™n";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/staff-management-index.css" asp-append-version="true" />
    <style>
        /* Force override for password modal - Must be after all other CSS */
        #updatePasswordModal .modal-header.password-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            background-color: #f59e0b !important;
            border-bottom: none !important;
            color: white !important;
        }
        
        #updatePasswordModal .modal-header.password-modal-header .modal-title,
        #updatePasswordModal .modal-header.password-modal-header * {
            color: white !important;
        }
        
        #updatePasswordModal .btn-amber,
        #updatePasswordModal .modal-footer .btn-amber {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            background-color: #f59e0b !important;
            border: none !important;
            color: white !important;
        }
        
        #updatePasswordModal .btn-amber:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
            background-color: #fbbf24 !important;
            color: white !important;
        }
        
        /* Override any btn-primary in password modal */
        #updatePasswordModal .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            background-color: #f59e0b !important;
            border: none !important;
            color: white !important;
        }
        
        /* Password Modal Form Text - Ensure it appears below input */
        #updatePasswordModal .form-text {
            display: block !important;
            margin-top: 0.5rem !important;
            font-size: 0.875rem;
            color: #6c757d;
            line-height: 1.4;
        }
        
        /* Password Modal Invalid Feedback - Below input */
        #updatePasswordModal .invalid-feedback {
            display: block !important;
            width: 100%;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #dc3545;
        }
        
        #updatePasswordModal .invalid-feedback[style*="display: none"] {
            display: none !important;
        }
        
        /* Input validation states */
        #updatePasswordModal .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6 .4.4.4-.4m0 4.8-.4-.4-.4.4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
    </style>
}

<div class="staff-management">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                @if (TempData["Warning"] != null)
                {
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        @TempData["Warning"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["Error"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                
                @* Success message will be shown as toast notification *@
                @if (TempData["Success"] != null)
                {
                    <div id="successMessage" style="display: none;">@TempData["Success"]</div>
                }
                
                <div class="staff-card">
                    <div class="staff-header">
                        <h3 class="staff-title">
                            <i class="bi bi-people-fill"></i>
                            <span>Qu·∫£n l√Ω Nh√¢n vi√™n</span>
                        </h3>
                        <a href="@Url.Action("Create", "StaffManagement")" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i>
                            <span>Th√™m nh√¢n vi√™n m·ªõi</span>
                        </a>
                    </div>
                    
                    <div class="staff-content">
                        @Html.AntiForgeryToken()
                        
                        @if (Model == null || !Model.Any())
                        {
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="bi bi-people"></i>
                                </div>
                                <h4>Ch∆∞a c√≥ nh√¢n vi√™n n√†o</h4>
                                <p>H√£y th√™m nh√¢n vi√™n ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω ƒë·ªôi ng≈© c·ªßa b·∫°n</p>
                                <a href="@Url.Action("Create", "StaffManagement")" class="btn btn-primary">
                                    <i class="bi bi-person-plus me-2"></i>
                                    Th√™m nh√¢n vi√™n m·ªõi
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="staff-list">
                                @{
                                    var activeStaff = Model.Where(s => !s.IsLocked).ToList();
                                    var lockedStaff = Model.Where(s => s.IsLocked).ToList();
                                }
                                
                                @* Hi·ªÉn th·ªã nh√¢n vi√™n ho·∫°t ƒë·ªông tr∆∞·ªõc *@
                                @if (activeStaff.Any())
                                {
                                    <div class="staff-section">
                                        <h6 class="section-title">
                                            <i class="bi bi-person-check"></i>
                                            <span>Nh√¢n vi√™n ho·∫°t ƒë·ªông <strong id="activeStaffCount">(@activeStaff.Count)</strong></span>
                                        </h6>
                                        @foreach (var staff in activeStaff)
                                        {
                                            <div class="staff-row" data-staff-id="@staff.StaffId" data-staff-name="@staff.StaffName">
                                                <div class="staff-avatar">
                                                    @if (!string.IsNullOrEmpty(staff.FaceImage))
                                                    {
                                                        <img src="@ImageHelper.GetImageUrl(staff.FaceImage, Configuration)" 
                                                             alt="@staff.StaffName" 
                                                             class="avatar-img" 
                                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                        <div class="avatar-placeholder" style="display: none;">
                                                            <i class="bi bi-person"></i>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="avatar-placeholder">
                                                            <i class="bi bi-person"></i>
                                                        </div>
                                                    }
                                                </div>
                                                
                                                <div class="staff-info">
                                                    <h5 class="staff-name">@staff.StaffName</h5>
                                                    <p class="staff-citizen-id">CCCD: @staff.CitizenID</p>
                                                </div>
                                                
                                                <div class="staff-status">
                                                    <span class="status-badge status-active">
                                                        <i class="bi bi-check-circle me-1"></i>
                                                        Ho·∫°t ƒë·ªông
                                                    </span>
                                                </div>
                                                
                                                <div class="staff-actions">
                                                    <a href="@Url.Action("Details", "StaffManagement", new { id = staff.StaffId })" 
                                                       class="action-btn view-btn" title="Xem l·ªãch l√†m vi·ªác">
                                                        <i class="bi bi-calendar-week"></i>
                                                    </a>
                                                    
                                                    <a href="@Url.Action("Edit", "StaffManagement", new { id = staff.StaffId })" 
                                                       class="action-btn edit-btn" title="Ch·ªânh s·ª≠a">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    
                                                    <button type="button" 
                                                            class="action-btn password-btn" 
                                                            title="C·∫≠p nh·∫≠t m·∫≠t kh·∫©u"
                                                            onclick="showUpdatePasswordModal('@staff.StaffId', '@staff.StaffName')">
                                                        <i class="bi bi-key"></i>
                                                    </button>
                                                    
                                                    <button type="button" 
                                                            class="action-btn lock-btn" 
                                                            title="Kh√≥a t√†i kho·∫£n"
                                                            onclick="lockStaff('@staff.StaffId', '@staff.StaffName')">
                                                        <i class="bi bi-lock"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                @* Hi·ªÉn th·ªã nh√¢n vi√™n b·ªã kh√≥a sau *@
                                @if (lockedStaff.Any())
                                {
                                    <div class="staff-section">
                                        <h6 class="section-title">
                                            <i class="bi bi-person-x"></i>
                                            <span>Nh√¢n vi√™n b·ªã kh√≥a <strong id="lockedStaffCount">(@lockedStaff.Count)</strong></span>
                                        </h6>
                                        @foreach (var staff in lockedStaff)
                                        {
                                            <div class="staff-row locked-staff" data-staff-id="@staff.StaffId" data-staff-name="@staff.StaffName">
                                                <div class="staff-avatar">
                                                    @if (!string.IsNullOrEmpty(staff.FaceImage))
                                                    {
                                                        <img src="@ImageHelper.GetImageUrl(staff.FaceImage, Configuration)" 
                                                             alt="@staff.StaffName" 
                                                             class="avatar-img" 
                                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                        <div class="avatar-placeholder" style="display: none;">
                                                            <i class="bi bi-person"></i>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="avatar-placeholder">
                                                            <i class="bi bi-person"></i>
                                                        </div>
                                                    }
                                                </div>
                                                
                                                <div class="staff-info">
                                                    <h5 class="staff-name">@staff.StaffName</h5>
                                                    <p class="staff-citizen-id">CCCD: @staff.CitizenID</p>
                                                </div>
                                                
                                                <div class="staff-status">
                                                    <span class="status-badge status-locked">
                                                        <i class="bi bi-lock-fill me-1"></i>
                                                        ƒê√£ kh√≥a
                                                    </span>
                                                </div>
                                                
                                                <div class="staff-actions">
                                                    <a href="@Url.Action("Details", "StaffManagement", new { id = staff.StaffId })" 
                                                       class="action-btn view-btn" title="Xem l·ªãch l√†m vi·ªác">
                                                        <i class="bi bi-calendar-week"></i>
                                                    </a>
                                                    
                                                    <a href="@Url.Action("Edit", "StaffManagement", new { id = staff.StaffId })" 
                                                       class="action-btn edit-btn" title="Ch·ªânh s·ª≠a">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    
                                                    <button type="button" 
                                                            class="action-btn password-btn" 
                                                            title="C·∫≠p nh·∫≠t m·∫≠t kh·∫©u"
                                                            onclick="showUpdatePasswordModal('@staff.StaffId', '@staff.StaffName')">
                                                        <i class="bi bi-key"></i>
                                                    </button>
                                                    
                                                    <button type="button" 
                                                            class="action-btn unlock-btn" 
                                                            title="M·ªü kh√≥a"
                                                            onclick="unlockStaff('@staff.StaffId', '@staff.StaffName')">
                                                        <i class="bi bi-unlock"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üîë Modal C·∫≠p nh·∫≠t m·∫≠t kh·∫©u -->
<div class="modal fade" id="updatePasswordModal" tabindex="-1" aria-labelledby="updatePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header password-modal-header text-white">
                <h5 class="modal-title" id="updatePasswordModalLabel">
                    <i class="bi bi-key me-2"></i>
                    C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nh√¢n vi√™n:</label>
                    <p class="fw-bold text-amber" id="updatePasswordStaffName"></p>
                </div>
                
                <div class="mb-3">
                    <label for="newPassword" class="form-label">M·∫≠t kh·∫©u m·ªõi <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="newPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" required>
                    <div class="invalid-feedback" id="newPasswordError" style="display: none;"></div>
                    <small class="form-text text-muted d-block mt-1">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±</small>
                </div>
                
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
                    <div class="invalid-feedback" id="confirmPasswordError" style="display: none;"></div>
                </div>
                
                <input type="hidden" id="updatePasswordStaffId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-amber" onclick="updateStaffPassword(); return false;">
                    <i class="bi bi-check-lg me-2"></i>
                    C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                </button>
            </div>
        </div>
    </div>
</div>

<!-- üîí Modal X√°c nh·∫≠n Kh√≥a t√†i kho·∫£n -->
<div class="modal fade" id="confirmLockModal" tabindex="-1" aria-labelledby="confirmLockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header lock-modal-header">
                <h5 class="modal-title" id="confirmLockModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    X√°c nh·∫≠n kh√≥a t√†i kho·∫£n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="lock-icon-wrapper">
                        <i class="bi bi-lock-fill"></i>
                    </div>
                </div>
                <p class="text-center mb-3 fs-5">
                    B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√≥a t√†i kho·∫£n c·ªßa nh√¢n vi√™n <strong class="text-primary" id="confirmLockStaffName"></strong>?
                </p>
                <div class="alert alert-amber mb-0">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <small><strong>L∆∞u √Ω:</strong> Kh√¥ng th·ªÉ kh√≥a t√†i kho·∫£n nh√¢n vi√™n ƒëang c√≥ ph√¢n c√¥ng ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω.</small>
                </div>
                <input type="hidden" id="confirmLockStaffId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    H·ªßy
                </button>
                <button type="button" class="btn btn-amber" onclick="confirmLockStaff(); return false;">
                    <i class="bi bi-lock-fill me-2"></i>
                    Kh√≥a t√†i kho·∫£n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- üîì Modal X√°c nh·∫≠n M·ªü kh√≥a t√†i kho·∫£n -->
<div class="modal fade" id="confirmUnlockModal" tabindex="-1" aria-labelledby="confirmUnlockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header unlock-modal-header">
                <h5 class="modal-title" id="confirmUnlockModalLabel">
                    <i class="bi bi-unlock-fill me-2"></i>
                    X√°c nh·∫≠n m·ªü kh√≥a t√†i kho·∫£n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="unlock-icon-wrapper">
                        <i class="bi bi-unlock-fill"></i>
                    </div>
                </div>
                <p class="text-center mb-0 fs-5">
                    B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kh√≥a t√†i kho·∫£n c·ªßa nh√¢n vi√™n <strong class="text-primary" id="confirmUnlockStaffName"></strong>?
                </p>
                <input type="hidden" id="confirmUnlockStaffId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    H·ªßy
                </button>
                <button type="button" class="btn btn-success" onclick="confirmUnlockStaff(); return false;">
                    <i class="bi bi-unlock-fill me-2"></i>
                    M·ªü kh√≥a t√†i kho·∫£n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- üì¢ Toast Notification Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">Th√¥ng b√°o</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // üö´ NgƒÉn reload trang khi submit form ho·∫∑c click button
        document.addEventListener('DOMContentLoaded', function() {
            // Show success toast if TempData["Success"] exists
            const successMessage = document.getElementById('successMessage');
            if (successMessage && successMessage.textContent.trim() !== '') {
                const message = successMessage.textContent.trim();
                showToast('success', 'Th√†nh c√¥ng', message);
            }
            // NgƒÉn t·∫•t c·∫£ form submit m·∫∑c ƒë·ªãnh (n·∫øu c√≥)
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });
            });
            
            // ƒê·∫£m b·∫£o t·∫•t c·∫£ button trong modal c√≥ type="button"
            const modalButtons = document.querySelectorAll('.modal button');
            modalButtons.forEach(btn => {
                if (btn.type === 'submit') {
                    btn.type = 'button';
                }
                // NgƒÉn button trigger form submit
                btn.addEventListener('click', function(e) {
                    if (this.type === 'submit') {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            });
            
            // NgƒÉn Enter key submit form trong modal
            const modalInputs = document.querySelectorAll('.modal input, .modal textarea, .modal select');
            modalInputs.forEach(input => {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.stopPropagation();
                        // N·∫øu l√† input trong password modal v√† ƒëang ·ªü input cu·ªëi c√πng, g·ªçi updateStaffPassword
                        if (this.closest('#updatePasswordModal')) {
                            // Ch·ªâ g·ªçi n·∫øu ƒëang ·ªü input confirmPassword (input cu·ªëi c√πng)
                            if (this.id === 'confirmPassword' && typeof updateStaffPassword === 'function') {
                                updateStaffPassword(e);
                            }
                        }
                        return false;
                    }
                });
            });
            
            // ƒê·∫£m b·∫£o c√°c button action kh√¥ng g√¢y reload
            const actionButtons = document.querySelectorAll('.staff-actions button');
            actionButtons.forEach(btn => {
                if (btn.type !== 'button') {
                    btn.type = 'button';
                }
                btn.addEventListener('click', function(e) {
                    if (this.type === 'submit') {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            });
        });

        // üì¢ Toast Notification Helper
        function showToast(type, title, message) {
            const toast = document.getElementById('toastNotification');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set icon and colors based on type
            let iconClass = 'bi-info-circle';
            let headerClass = '';
            
            switch(type) {
                case 'success':
                    iconClass = 'bi-check-circle-fill text-success';
                    headerClass = 'bg-success text-white';
                    break;
                case 'error':
                case 'danger':
                    iconClass = 'bi-x-circle-fill text-danger';
                    headerClass = 'bg-danger text-white';
                    break;
                case 'warning':
                    iconClass = 'bi-exclamation-triangle-fill text-warning';
                    headerClass = 'bg-warning text-dark';
                    break;
                case 'info':
                default:
                    iconClass = 'bi-info-circle-fill text-info';
                    headerClass = 'bg-info text-white';
                    break;
            }
            
            toastIcon.className = `bi ${iconClass}`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Update header class
            const toastHeader = toast.querySelector('.toast-header');
            toastHeader.className = `toast-header ${headerClass}`;
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 2500  // T·ª± ƒë·ªông t·∫Øt sau 2.5 gi√¢y
            });
            bsToast.show();
        }

        // üîÑ Reload staff list b·∫±ng AJAX
        function reloadStaffList() {
            // T√¨m .staff-content container - ƒë√¢y l√† container ch√≠nh ch·ª©a staff list
            const staffContentContainer = document.querySelector('.staff-content');
            const staffListContainer = document.querySelector('.staff-list');
            
            if (!staffContentContainer) {
                console.error('Staff content container not found, reloading page');
                location.reload();
                return;
            }

            // L∆∞u AntiForgeryToken ƒë·ªÉ gi·ªØ l·∫°i sau khi reload
            const antiForgeryToken = staffContentContainer.querySelector('input[name="__RequestVerificationToken"]');
            const tokenHTML = antiForgeryToken ? antiForgeryToken.outerHTML : '';
            const originalHTML = staffContentContainer.innerHTML;

            // Hi·ªÉn th·ªã loading state
            const loadingHTML = tokenHTML + `
                        <div class="text-center py-5" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; border-width: 0.3em;">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                            <p class="mt-3 text-muted">ƒêang t·∫£i danh s√°ch nh√¢n vi√™n...</p>
                        </div>
            `;
            
            // Fade out v√† hi·ªÉn th·ªã loading
            staffContentContainer.style.transition = 'opacity 0.3s ease';
            staffContentContainer.style.opacity = '0.5';
            
            setTimeout(() => {
                staffContentContainer.innerHTML = loadingHTML;
            }, 200);

            // G·ªçi AJAX ƒë·ªÉ reload staff list
            fetch('/Provider/StaffManagement/Index', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'text/html'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('üì• Received HTML response length:', html.length);
                
                // Parse HTML response - Partial view tr·∫£ v·ªÅ tr·ª±c ti·∫øp HTML c·ªßa staff-list ho·∫∑c empty-state
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html.trim();
                
                // T√¨m staff-list ho·∫∑c empty-state trong response
                let newStaffListElement = tempDiv.querySelector('.staff-list');
                let emptyStateElement = tempDiv.querySelector('.empty-state');
                
                // N·∫øu kh√¥ng t√¨m th·∫•y, c√≥ th·ªÉ element ƒë·∫ßu ti√™n ch√≠nh l√† staff-list ho·∫∑c empty-state
                if (!newStaffListElement && !emptyStateElement && tempDiv.firstElementChild) {
                    const firstChild = tempDiv.firstElementChild;
                    if (firstChild.classList && firstChild.classList.contains('staff-list')) {
                        newStaffListElement = firstChild;
                    } else if (firstChild.classList && firstChild.classList.contains('empty-state')) {
                        emptyStateElement = firstChild;
                    }
                }
                
                // X√°c ƒë·ªãnh content c·∫ßn replace
                // L∆∞u l·∫°i tokenHTML t·ª´ scope ngo√†i (ƒë√£ ƒë∆∞·ª£c l∆∞u tr∆∞·ªõc khi fetch)
                const savedTokenHTML = tokenHTML;
                let newContent = '';
                
                if (newStaffListElement) {
                    // C√≥ staff list - gi·ªØ AntiForgeryToken v√† th√™m staff-list
                    newContent = (savedTokenHTML ? savedTokenHTML + '\n                        ' : '') + newStaffListElement.outerHTML;
                    console.log('‚úÖ Found staff-list in response');
                } else if (emptyStateElement) {
                    // Kh√¥ng c√≥ staff - gi·ªØ AntiForgeryToken v√† th√™m empty-state
                    newContent = (savedTokenHTML ? savedTokenHTML + '\n                        ' : '') + emptyStateElement.outerHTML;
                    console.log('‚úÖ Found empty-state in response');
                } else {
                    // Fallback: s·ª≠ d·ª•ng to√†n b·ªô HTML response v√† th√™m AntiForgeryToken
                    console.warn('‚ö†Ô∏è Could not find .staff-list or .empty-state in response');
                    console.warn('Response HTML (first 500 chars):', html.substring(0, 500));
                    // N·∫øu response kh√¥ng c√≥ structure r√µ r√†ng, th·ª≠ wrap trong staff-list
                    if (html.trim()) {
                        newContent = (savedTokenHTML ? savedTokenHTML + '\n                        ' : '') + '<div class="staff-list">' + html.trim() + '</div>';
                    } else {
                        throw new Error('Empty response from server');
                    }
                }
                
                if (newContent && newContent.trim()) {
                    // Fade out v√† replace content
                    staffContentContainer.style.transition = 'opacity 0.3s ease';
                    staffContentContainer.style.opacity = '0';
                    
                    setTimeout(() => {
                        // Replace content
                        staffContentContainer.innerHTML = newContent;
                        
                        // Fade in animation
                        setTimeout(() => {
                            staffContentContainer.style.opacity = '1';
                            staffContentContainer.style.transition = '';
                            
                            // ƒê·∫£m b·∫£o c√°c button m·ªõi sau khi reload c√≥ event handler ƒë√∫ng
                            // C√°c button ƒë√£ c√≥ onclick attribute trong HTML n√™n s·∫Ω t·ª± ƒë·ªông c√≥ event handler
                            // Nh∆∞ng v·∫´n c·∫ßn ƒë·∫£m b·∫£o type="button" cho t·∫•t c·∫£ button
                            const newButtons = staffContentContainer.querySelectorAll('button');
                            newButtons.forEach(btn => {
                                if (btn.type !== 'button') {
                                    btn.type = 'button';
                                }
                            });
                        }, 50);
                        
                        console.log('‚úÖ Staff list reloaded successfully');
                    }, 300);
                } else {
                    throw new Error('Empty content in response');
                }
            })
            .catch(error => {
                console.error('‚ùå Error reloading staff list:', error);
                // Restore original content
                staffContentContainer.style.opacity = '1';
                staffContentContainer.innerHTML = originalHTML;
                showToast('error', 'L·ªói', 'Kh√¥ng th·ªÉ t·∫£i l·∫°i danh s√°ch nh√¢n vi√™n. ƒêang t·∫£i l·∫°i trang...');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            });
        }

        // üîÑ C·∫≠p nh·∫≠t tr·∫°ng th√°i staff trong UI (real-time update) - DEPRECATED: S·ª≠ d·ª•ng reloadStaffList thay th·∫ø
        function updateStaffStatus(staffId, isLocked) {
            const staffRow = document.querySelector(`.staff-row[data-staff-id="${staffId}"]`);
            if (!staffRow) {
                console.warn(`Staff row not found for ID: ${staffId}`);
                return;
            }

            const staffName = staffRow.getAttribute('data-staff-name');
            const statusBadge = staffRow.querySelector('.staff-status .status-badge');
            const actionsContainer = staffRow.querySelector('.staff-actions');
            
            // T√¨m c√°c section container - T√¨m section ch·ª©a activeStaffCount ho·∫∑c lockedStaffCount
            const activeStaffCountEl = document.getElementById('activeStaffCount');
            const lockedStaffCountEl = document.getElementById('lockedStaffCount');
            const activeSection = activeStaffCountEl ? activeStaffCountEl.closest('.staff-section') : null;
            const lockedSection = lockedStaffCountEl ? lockedStaffCountEl.closest('.staff-section') : null;
            
            if (isLocked) {
                // Chuy·ªÉn sang tr·∫°ng th√°i "ƒê√£ kh√≥a"
                staffRow.classList.add('locked-staff');
                
                // Update status badge
                if (statusBadge) {
                    statusBadge.className = 'status-badge status-locked';
                    statusBadge.innerHTML = '<i class="bi bi-lock-fill me-1"></i>ƒê√£ kh√≥a';
                }
                
                // Update buttons: thay lock button b·∫±ng unlock button
                const lockBtn = actionsContainer.querySelector('.lock-btn');
                if (lockBtn) {
                    lockBtn.className = 'action-btn unlock-btn';
                    lockBtn.title = 'M·ªü kh√≥a';
                    lockBtn.innerHTML = '<i class="bi bi-unlock"></i>';
                    lockBtn.onclick = function() { unlockStaff(staffId, staffName); };
                }
                
                // Animation fade out tr∆∞·ªõc
                staffRow.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                staffRow.style.opacity = '0';
                staffRow.style.transform = 'translateX(-30px)';
                
                setTimeout(() => {
                    // T√¨m ho·∫∑c t·∫°o locked section
                    let targetSection = lockedSection;
                    if (!targetSection) {
                        // T·∫°o locked section n·∫øu ch∆∞a c√≥
                        const staffListContainer = document.querySelector('.staff-list') || document.querySelector('.staff-content');
                        if (staffListContainer) {
                            targetSection = document.createElement('div');
                            targetSection.className = 'staff-section';
                            targetSection.innerHTML = `
                                <h6 class="section-title">
                                    <i class="bi bi-person-x"></i>
                                    <span>Nh√¢n vi√™n b·ªã kh√≥a <strong id="lockedStaffCount">(0)</strong></span>
                                </h6>
                            `;
                            // Insert sau active section ho·∫∑c append v√†o cu·ªëi
                            const activeSectionElement = activeSection;
                            if (activeSectionElement && activeSectionElement.nextSibling) {
                                activeSectionElement.parentNode.insertBefore(targetSection, activeSectionElement.nextSibling);
                            } else if (activeSectionElement) {
                                activeSectionElement.parentNode.appendChild(targetSection);
                            } else {
                                staffListContainer.appendChild(targetSection);
                            }
                            // Update l·∫°i reference
                            lockedSection = targetSection;
                        }
                    }
                    
                    if (targetSection) {
                        // Di chuy·ªÉn DOM element
                        const sectionTitle = targetSection.querySelector('.section-title');
                        const existingLockedRows = targetSection.querySelectorAll('.staff-row.locked-staff');
                        
                        if (existingLockedRows.length > 0) {
                            // Append sau staff-row cu·ªëi c√πng
                            const lastRow = existingLockedRows[existingLockedRows.length - 1];
                            if (lastRow.nextSibling) {
                                lastRow.parentNode.insertBefore(staffRow, lastRow.nextSibling);
                            } else {
                                lastRow.parentNode.appendChild(staffRow);
                            }
                        } else if (sectionTitle) {
                            // Append sau section-title
                            if (sectionTitle.nextSibling) {
                                sectionTitle.parentNode.insertBefore(staffRow, sectionTitle.nextSibling);
                            } else {
                                sectionTitle.parentNode.appendChild(staffRow);
                            }
                        } else {
                            targetSection.appendChild(staffRow);
                        }
                        
                        // Hi·ªÉn th·ªã section
                        targetSection.style.display = '';
                        
                        // Animation fade in
                        setTimeout(() => {
                            staffRow.style.opacity = '1';
                            staffRow.style.transform = 'translateX(0)';
                        }, 50);
                    } else {
                        // Fallback: ch·ªâ update class v√† status
                        staffRow.style.opacity = '1';
                        staffRow.style.transform = 'translateX(0)';
                    }
                }, 200);
                
                // Update section count (active)
                updateSectionCount('activeStaffCount', -1);
                // Update section count (locked)
                updateSectionCount('lockedStaffCount', 1);
                
            } else {
                // Chuy·ªÉn sang tr·∫°ng th√°i "Ho·∫°t ƒë·ªông"
                staffRow.classList.remove('locked-staff');
                
                // Update status badge
                if (statusBadge) {
                    statusBadge.className = 'status-badge status-active';
                    statusBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i>Ho·∫°t ƒë·ªông';
                }
                
                // Update buttons: thay unlock button b·∫±ng lock button
                const unlockBtn = actionsContainer.querySelector('.unlock-btn');
                if (unlockBtn) {
                    unlockBtn.className = 'action-btn lock-btn';
                    unlockBtn.title = 'Kh√≥a t√†i kho·∫£n';
                    unlockBtn.innerHTML = '<i class="bi bi-lock"></i>';
                    unlockBtn.onclick = function() { lockStaff(staffId, staffName); };
                }
                
                // Di chuy·ªÉn staff row sang active section v·ªõi animation
                if (activeSection) {
                    // Animation fade out tr∆∞·ªõc
                    staffRow.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    staffRow.style.opacity = '0';
                    staffRow.style.transform = 'translateX(-30px)';
                    
                    setTimeout(() => {
                        // Di chuy·ªÉn DOM element
                        const sectionTitle = activeSection.querySelector('.section-title');
                        const firstActiveRow = activeSection.querySelector('.staff-row:not(.locked-staff)');
                        
                        if (firstActiveRow && firstActiveRow.parentNode) {
                            // Insert tr∆∞·ªõc staff-row ƒë·∫ßu ti√™n
                            firstActiveRow.parentNode.insertBefore(staffRow, firstActiveRow);
                        } else if (sectionTitle) {
                            // Append sau section-title
                            if (sectionTitle.nextSibling) {
                                sectionTitle.parentNode.insertBefore(staffRow, sectionTitle.nextSibling);
                            } else {
                                sectionTitle.parentNode.appendChild(staffRow);
                            }
                        } else {
                            activeSection.appendChild(staffRow);
                        }
                        
                        // Animation fade in
                        setTimeout(() => {
                            staffRow.style.opacity = '1';
                            staffRow.style.transform = 'translateX(0)';
                        }, 50);
                    }, 200);
                }
                
                // Update section count (active)
                updateSectionCount('activeStaffCount', 1);
                // Update section count (locked)
                updateSectionCount('lockedStaffCount', -1);
                
                // ·∫®n locked section n·∫øu kh√¥ng c√≤n staff n√†o
                if (lockedSection && !lockedSection.querySelector('.staff-row.locked-staff')) {
                    lockedSection.style.display = 'none';
                }
            }
            
            // X√≥a transition sau animation ƒë·ªÉ tr√°nh conflict
            setTimeout(() => {
                staffRow.style.transition = '';
            }, 600);
        }

        // üî¢ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng staff trong section
        function updateSectionCount(elementId, delta) {
            const countElement = document.getElementById(elementId);
            if (countElement) {
                const currentText = countElement.textContent;
                const match = currentText.match(/\((\d+)\)/);
                if (match) {
                    const currentCount = parseInt(match[1]);
                    const newCount = Math.max(0, currentCount + delta);
                    countElement.textContent = `(${newCount})`;
                }
            }
        }

        // üîí Hi·ªÉn th·ªã modal x√°c nh·∫≠n kh√≥a
        function lockStaff(staffId, staffName) {
            document.getElementById('confirmLockStaffId').value = staffId;
            document.getElementById('confirmLockStaffName').textContent = staffName;
            
            // Reset button state
            const confirmBtn = document.querySelector('#confirmLockModal .btn-amber');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="bi bi-lock-fill me-2"></i>Kh√≥a t√†i kho·∫£n';
            
            const modal = new bootstrap.Modal(document.getElementById('confirmLockModal'));
            modal.show();
        }

        // üîí X√°c nh·∫≠n kh√≥a t√†i kho·∫£n
        function confirmLockStaff(event) {
            // NgƒÉn reload trang
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const staffId = document.getElementById('confirmLockStaffId').value;
            const staffName = document.getElementById('confirmLockStaffName').textContent;
            
            // Disable button to prevent double click
            const confirmBtn = document.querySelector('#confirmLockModal .btn-amber');
            confirmBtn.disabled = true;
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';
            
                // Get AntiForgeryToken
                const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                fetch(`/Provider/StaffManagement/${staffId}/lock`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': antiForgeryToken || ''
                    }
                })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error('Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ph·∫£i JSON');
                }
                
                // Ki·ªÉm tra c·∫£ HTTP status code v√† data.error/data.success
                // N·∫øu HTTP status kh√¥ng OK (400, 404, 500, etc) HO·∫∂C c√≥ data.error HO·∫∂C data.success === false
                // => ƒê√¢y l√† l·ªói, kh√¥ng th·ªÉ kh√≥a staff
                if (!response.ok || data.error || data.success === false) {
                    const errorMsg = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
                    console.error('‚ùå Lock staff error:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: data.error,
                        message: data.message,
                        success: data.success
                    });
                    throw new Error(errorMsg);
                }
                
                console.log('‚úÖ Lock staff success:', data);
                return data;
                })
                .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmLockModal'));
                modal.hide();
                
                // Show success toast
                showToast('success', 'Th√†nh c√¥ng', data.message || 'ƒê√£ kh√≥a t√†i kho·∫£n nh√¢n vi√™n th√†nh c√¥ng!');
                
                // Reload staff list b·∫±ng AJAX
                reloadStaffList();
                })
                .catch(error => {
                    console.error('Lock error:', error);
                
                // Re-enable button
                const confirmBtn = document.querySelector('#confirmLockModal .btn-amber');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-lock-fill me-2"></i>Kh√≥a t√†i kho·∫£n';
                
                // Show error toast
                showToast('error', 'L·ªói', error.message);
                });
            
            return false; // NgƒÉn reload trang
        }

        // üîì Hi·ªÉn th·ªã modal x√°c nh·∫≠n m·ªü kh√≥a
        function unlockStaff(staffId, staffName) {
            document.getElementById('confirmUnlockStaffId').value = staffId;
            document.getElementById('confirmUnlockStaffName').textContent = staffName;
            
            // Reset button state
            const confirmBtn = document.querySelector('#confirmUnlockModal .btn-success');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="bi bi-unlock-fill me-2"></i>M·ªü kh√≥a t√†i kho·∫£n';
            
            const modal = new bootstrap.Modal(document.getElementById('confirmUnlockModal'));
            modal.show();
        }

        // üîì X√°c nh·∫≠n m·ªü kh√≥a t√†i kho·∫£n
        function confirmUnlockStaff(event) {
            // NgƒÉn reload trang
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const staffId = document.getElementById('confirmUnlockStaffId').value;
            
            // Disable button to prevent double click
            const confirmBtn = document.querySelector('#confirmUnlockModal .btn-success');
            confirmBtn.disabled = true;
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';
            
                // Get AntiForgeryToken
                const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                
                fetch(`/Provider/StaffManagement/${staffId}/unlock`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': antiForgeryToken || ''
                    }
                })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error('Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ph·∫£i JSON');
                }
                
                // Ki·ªÉm tra c·∫£ HTTP status code v√† data.error/data.success
                // N·∫øu HTTP status kh√¥ng OK (400, 404, 500, etc) HO·∫∂C c√≥ data.error HO·∫∂C data.success === false
                // => ƒê√¢y l√† l·ªói, kh√¥ng th·ªÉ m·ªü kh√≥a staff
                if (!response.ok || data.error || data.success === false) {
                    const errorMsg = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
                    console.error('‚ùå Unlock staff error:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: data.error,
                        message: data.message,
                        success: data.success
                    });
                    throw new Error(errorMsg);
                }
                
                console.log('‚úÖ Unlock staff success:', data);
                return data;
                })
                .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmUnlockModal'));
                modal.hide();
                
                // Show success toast
                showToast('success', 'Th√†nh c√¥ng', data.message || 'ƒê√£ m·ªü kh√≥a t√†i kho·∫£n nh√¢n vi√™n th√†nh c√¥ng!');
                
                // Reload staff list b·∫±ng AJAX
                reloadStaffList();
                })
                .catch(error => {
                    console.error('Unlock error:', error);
                
                // Re-enable button
                const confirmBtn = document.querySelector('#confirmUnlockModal .btn-success');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-unlock-fill me-2"></i>M·ªü kh√≥a t√†i kho·∫£n';
                
                // Show error toast
                showToast('error', 'L·ªói', error.message);
                });
            
            return false; // NgƒÉn reload trang
        }

        // üîë C·∫≠p nh·∫≠t m·∫≠t kh·∫©u cho Staff
        function showUpdatePasswordModal(staffId, staffName) {
            // Set staff info in modal
            document.getElementById('updatePasswordStaffId').value = staffId;
            document.getElementById('updatePasswordStaffName').textContent = staffName;
            
            // Clear form
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const newPasswordError = document.getElementById('newPasswordError');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            
            // Clear validation errors
            newPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.remove('is-invalid');
            if (newPasswordError) {
                newPasswordError.style.display = 'none';
                newPasswordError.textContent = '';
            }
            if (confirmPasswordError) {
                confirmPasswordError.style.display = 'none';
                confirmPasswordError.textContent = '';
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('updatePasswordModal'));
            modal.show();
        }

        // üîë C·∫≠p nh·∫≠t m·∫≠t kh·∫©u cho Staff
        function updateStaffPassword(event) {
            // NgƒÉn reload trang
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const staffId = document.getElementById('updatePasswordStaffId').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Clear previous errors
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const newPasswordError = document.getElementById('newPasswordError');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            
            newPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.remove('is-invalid');
            newPasswordError.style.display = 'none';
            confirmPasswordError.style.display = 'none';
            newPasswordError.textContent = '';
            confirmPasswordError.textContent = '';
            
            let isValid = true;
            
            // Validation
            if (!newPassword || newPassword.trim() === '') {
                newPasswordInput.classList.add('is-invalid');
                newPasswordError.textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi';
                newPasswordError.style.display = 'block';
                isValid = false;
            } else if (newPassword.length < 6) {
                newPasswordInput.classList.add('is-invalid');
                newPasswordError.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
                newPasswordError.style.display = 'block';
                isValid = false;
            }
            
            if (!confirmPassword || confirmPassword.trim() === '') {
                confirmPasswordInput.classList.add('is-invalid');
                confirmPasswordError.textContent = 'Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u';
                confirmPasswordError.style.display = 'block';
                isValid = false;
            } else if (newPassword !== confirmPassword) {
                confirmPasswordInput.classList.add('is-invalid');
                confirmPasswordError.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
                confirmPasswordError.style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) {
                return false;
            }
            
            // Disable button to prevent double click
            const submitBtn = document.querySelector('#updatePasswordModal .btn-amber');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';
            
            // Get AntiForgeryToken
            const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            
            const formData = {
                NewPassword: newPassword,
                ConfirmPassword: confirmPassword
            };
            
            fetch(`/Provider/StaffManagement/${staffId}/update-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'RequestVerificationToken': antiForgeryToken || ''
                },
                body: JSON.stringify(formData)
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                        throw new Error('Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ph·∫£i JSON');
                }
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                return data;
            })
            .then(data => {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('updatePasswordModal'));
                    modal.hide();
                
                // Clear form
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Show success toast
                showToast('success', 'Th√†nh c√¥ng', data.message || 'ƒê√£ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u th√†nh c√¥ng!');
            })
            .catch(error => {
                console.error('Update password error:', error);
                
                // Re-enable button
                const submitBtn = document.querySelector('#updatePasswordModal .btn-amber');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>C·∫≠p nh·∫≠t m·∫≠t kh·∫©u';
                
                // Show error toast
                showToast('error', 'L·ªói', error.message);
            });
            
            return false; // NgƒÉn reload trang
        }
    </script>
}
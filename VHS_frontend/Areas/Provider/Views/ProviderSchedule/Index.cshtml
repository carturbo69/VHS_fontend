@using VHS_frontend.Areas.Provider.Models.Schedule
@model VHS_frontend.Areas.Provider.Models.Schedule.ScheduleOverviewViewModel
@{
    ViewData["Title"] = "Quản lý lịch làm việc";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/provider-schedule.css" asp-append-version="true" />
}

<div class="schedule-container">
    <!-- Header -->
    <div class="schedule-header-card">
        <div class="schedule-header-content">
            <div class="schedule-header-info">
                <h2 class="schedule-title">
                    <i class="bi bi-calendar3 me-2"></i> Quản lý lịch làm việc
                </h2>
                <p class="schedule-subtitle">
                    <i class="bi bi-info-circle me-2"></i> Theo dõi và quản lý lịch làm việc của bạn
                </p>
            </div>
            <div class="schedule-header-actions">
                <button type="button" class="btn btn-schedule-action btn-schedule-weekly" data-bs-toggle="modal" data-bs-target="#createWeeklyModal">
                    <i class="bi bi-plus-circle me-2"></i> Tạo lịch tuần
                </button>
                <button type="button" class="btn btn-schedule-action btn-schedule-daily" data-bs-toggle="modal" data-bs-target="#createDailyModal">
                    <i class="bi bi-calendar-plus me-2"></i> Thêm ngày
                </button>
                <button type="button" class="btn btn-schedule-action btn-schedule-timeoff" data-bs-toggle="modal" data-bs-target="#createTimeOffModal">
                    <i class="bi bi-calendar-x me-2"></i> Tạo ngày nghỉ
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="schedule-stats">
        <div class="schedule-stat-card stat-card-hours">
            <div class="stat-card-body">
                <div class="stat-icon-wrapper">
                    <i class="bi bi-clock-history stat-icon"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@(Model?.TotalWeeklyHours.ToString("0.0") ?? "0.0")h</div>
                    <div class="stat-label">Tổng giờ/tuần</div>
                </div>
            </div>
        </div>
        <div class="schedule-stat-card stat-card-days">
            <div class="stat-card-body">
                <div class="stat-icon-wrapper">
                    <i class="bi bi-calendar-check stat-icon"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@(Model?.Schedules?.Count() ?? 0)</div>
                    <div class="stat-label">Ngày làm việc</div>
                </div>
            </div>
        </div>
        <div class="schedule-stat-card stat-card-status @((Model?.IsAvailableToday ?? false) ? "stat-card-active" : "stat-card-inactive")">
            <div class="stat-card-body">
                <div class="stat-icon-wrapper">
                    <i class="bi bi-circle-fill stat-icon"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@((Model?.IsAvailableToday ?? false) ? "Hoạt động" : "Nghỉ")</div>
                    <div class="stat-label">Hôm nay</div>
                </div>
            </div>
        </div>
        <div class="schedule-stat-card stat-card-timeoff">
            <div class="stat-card-body">
                <div class="stat-icon-wrapper">
                    <i class="bi bi-calendar-x stat-icon"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@(Model?.UpcomingTimeOffs?.Count() ?? 0)</div>
                    <div class="stat-label">Ngày nghỉ sắp tới</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar View -->
    <div class="calendar-card">
        <div class="calendar-card-header">
            <h5 class="calendar-title">
                <i class="bi bi-calendar3 me-2"></i> Lịch tháng
            </h5>
            <div class="calendar-nav">
                <button class="btn-calendar-nav" onclick="previousMonth()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span id="currentMonthDisplay" class="calendar-month-display"></span>
                <button class="btn-calendar-nav" onclick="nextMonth()">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="calendar-card-body">
            <div id="calendarMonth" class="calendar-grid"></div>
        </div>
        
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color legend-available"></div>
                <span>Có lịch làm việc</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-timeoff"></div>
                <span>Ngày nghỉ</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-noschedule"></div>
                <span>Không có lịch</span>
            </div>
        </div>
    </div>

    <!-- Weekly Schedule Table -->
    <div class="schedule-table-card">
        <div class="schedule-table-header">
            <h5 class="schedule-table-title">
                <i class="bi bi-calendar-week me-2"></i> Lịch làm việc trong tuần
            </h5>
        </div>
        <div class="schedule-table-body">
            <div class="table-responsive">
                <table class="table schedule-table">
                    <thead>
                        <tr>
                            <th>Thứ</th>
                            <th>Giờ bắt đầu</th>
                            <th>Giờ kết thúc</th>
                            <th>Thời gian</th>
                            <th>Giới hạn đơn</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.Schedules != null && Model.Schedules.Any())
                        {
                            @foreach (var schedule in Model.Schedules)
                            {
                                <tr>
                                    <td><strong class="schedule-day-name">@schedule.DayName</strong></td>
                                    <td><span class="schedule-time">@schedule.StartTime.ToString("HH:mm")</span></td>
                                    <td><span class="schedule-time">@schedule.EndTime.ToString("HH:mm")</span></td>
                                    <td><span class="schedule-duration">@schedule.WorkDuration.ToString("0.0") giờ</span></td>
                                    <td><span class="schedule-limit">@(schedule.BookingLimit?.ToString() ?? "Không giới hạn")</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-schedule-edit" title="Sửa" 
                                                data-schedule-id="@schedule.ScheduleId"
                                                data-day-name="@schedule.DayName"
                                                data-start-time="@schedule.StartTime.ToString("HH:mm")"
                                                data-end-time="@schedule.EndTime.ToString("HH:mm")"
                                                data-booking-limit="@(schedule.BookingLimit?.ToString() ?? "")"
                                                onclick="openEditScheduleModalFromButton(this)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-schedule-delete" title="Xóa" onclick="deleteSchedule('@schedule.ScheduleId', '@schedule.DayName', '@schedule.StartTime.ToString("HH:mm")', '@schedule.EndTime.ToString("HH:mm")')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="schedule-table-empty">
                                    <i class="bi bi-calendar-x"></i>
                                    <div>Chưa có lịch làm việc nào</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Upcoming Time-Offs -->
    @if (Model?.UpcomingTimeOffs != null && Model.UpcomingTimeOffs.Any())
    {
        <div class="schedule-table-card timeoff-table-card">
            <div class="schedule-table-header">
                <h5 class="schedule-table-title">
                    <i class="bi bi-calendar-x me-2"></i> Ngày nghỉ sắp tới
                </h5>
            </div>
            <div class="schedule-table-body">
                <div class="table-responsive">
                    <table class="table schedule-table">
                        <thead>
                            <tr>
                                <th>Ngày</th>
                                <th>Thứ</th>
                                <th>Lý do</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var timeOff in Model.UpcomingTimeOffs)
                            {
                                <tr>
                                    <td><strong class="timeoff-date">@timeOff.Date.ToString("dd/MM/yyyy")</strong></td>
                                    <td><span class="timeoff-day">@timeOff.DayName</span></td>
                                    <td><span class="timeoff-reason">@(string.IsNullOrEmpty(timeOff.Reason) ? "Nghỉ" : timeOff.Reason)</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-schedule-delete" title="Xóa" onclick="deleteTimeOff('@timeOff.TimeOffId', '@timeOff.Date.ToString("dd/MM/yyyy")', '@(string.IsNullOrEmpty(timeOff.Reason) ? "" : timeOff.Reason)')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<script>
    let currentMonth = new Date();
    
    function updateCalendarDisplay() {
        const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6",
            "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
        document.getElementById('currentMonthDisplay').textContent = 
            `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        renderCalendar();
    }
    
    function previousMonth() {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        updateCalendarDisplay();
    }
    
    function nextMonth() {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        updateCalendarDisplay();
    }
    
    function renderCalendar() {
        const calendar = document.getElementById('calendarMonth');
        if (!calendar) return;
        
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const schedules = @Html.Raw(Json.Serialize(Model?.Schedules ?? Enumerable.Empty<ReadScheduleViewModel>()));
        
        let html = '';
        
        // Day headers
        const dayHeaders = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
        dayHeaders.forEach(day => {
            html += `<div class="calendar-day-header">${day}</div>`;
        });
        
        // Empty cells for days before month starts
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }
        
        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            const hasSchedule = schedules && schedules.length > 0 && schedules.some(s => s.dayOfWeek === dayOfWeek);
            
            let className = 'calendar-day';
            if (hasSchedule) {
                className += ' has-schedule';
            }
            
            html += `<div class="${className}" data-day="${day}">
                <div class="day-number">${day}</div>
            </div>`;
        }
        
        calendar.innerHTML = html;
        
        // Load time-offs
        loadTimeOffsForMonth(firstDay.toISOString().split('T')[0], lastDay.toISOString().split('T')[0]);
    }
    
    function loadTimeOffsForMonth(startDate, endDate) {
        fetch(`/Provider/ProviderSchedule/GetTimeOffs?startDate=${startDate}&endDate=${endDate}`)
            .then(async res => {
                const text = await res.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return { success: false, data: [] };
                }
            })
            .then(result => {
                const timeOffs = result.success ? result.data : (result.data || []);
                if (Array.isArray(timeOffs)) {
                    timeOffs.forEach(to => {
                        const dayElements = document.querySelectorAll(`[data-day]`);
                        dayElements.forEach(el => {
                            if (el.getAttribute('data-day') && parseInt(el.getAttribute('data-day')) === parseInt(to.date.split('-')[2])) {
                                el.classList.remove('has-schedule');
                                el.classList.add('has-timeoff');
                            }
                        });
                    });
                }
            })
            .catch(error => console.error('Error loading time-offs:', error));
    }
    
    // Modal management
    function openCreateWeeklyModal() {
        // Implementation for weekly schedule modal
        alert('Modal Tạo lịch theo tuần');
    }
    
    function openCreateDailyModal() {
        // Implementation for daily schedule modal
        alert('Modal Thêm ngày');
    }
    
    function deleteSchedule(id) {
        if (!confirm('Bạn có chắc muốn xóa lịch này?')) return;
        
        fetch(`/Provider/ProviderSchedule/DeleteSchedule/${id}`, {
            method: 'DELETE'
        })
        .then(async res => {
            const text = await res.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                return { success: false };
            }
        })
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                const errorMsg = translateError(result.message) || 'Không thể xóa lịch làm việc';
                alert('Lỗi: ' + errorMsg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Lỗi khi xóa lịch làm việc');
        });
    }
    
    function deleteTimeOff(id) {
        if (!confirm('Bạn có chắc muốn xóa ngày nghỉ này?')) return;
        
        fetch(`/Provider/ProviderSchedule/DeleteTimeOff/${id}`, {
            method: 'DELETE'
        })
        .then(async res => {
            const text = await res.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                return { success: false };
            }
        })
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                const errorMsg = translateError(result.message) || 'Không thể xóa ngày nghỉ';
                alert('Lỗi: ' + errorMsg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Lỗi khi xóa ngày nghỉ');
        });
    }
    
    // Form handlers
    document.getElementById('weeklyForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const daysOfWeek = [];
        for (let i = 0; i <= 6; i++) {
            if (document.getElementById(`day${i}`).checked) {
                daysOfWeek.push(i);
            }
        }
        
        if (daysOfWeek.length === 0) {
            alert('Vui lòng chọn ít nhất một ngày');
            return;
        }
        
        const data = {
            daysOfWeek: daysOfWeek,
            startTime: document.getElementById('weeklyStartTime').value,
            endTime: document.getElementById('weeklyEndTime').value,
            bookingLimit: document.getElementById('weeklyBookingLimit').value || null
        };
        
        try {
            const res = await fetch('/Provider/ProviderSchedule/CreateWeeklySchedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                const errorMsg = translateError(result.message) || 'Đã xảy ra lỗi khi tạo lịch làm việc';
                alert('Lỗi: ' + errorMsg);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Lỗi khi tạo lịch làm việc');
        }
    });
    
    // Translate error messages from English to Vietnamese
    function translateError(errorText) {
        if (!errorText) return null;
        
        // Try to parse JSON if it's a JSON string
        let message = errorText;
        try {
            const parsed = JSON.parse(errorText);
            if (parsed.message) {
                message = parsed.message;
            } else if (typeof parsed === 'string') {
                message = parsed;
            }
        } catch (e) {
            // Not JSON, use as is
            message = errorText;
        }
        
        const lowerText = message.toLowerCase();
        
        // Error message translations (sắp xếp từ dài đến ngắn để match chính xác hơn)
        const translations = {
            'time-off conflicts with existing bookings': 'Ngày nghỉ trùng với đơn đặt lịch hiện có',
            'time-off already exists for this date': 'Ngày nghỉ đã tồn tại cho ngày này',
            'schedule already exists for this day': 'Lịch làm việc đã tồn tại cho ngày này',
            'time-off already exists': 'Ngày nghỉ đã tồn tại',
            'schedule already exists': 'Lịch làm việc đã tồn tại',
            'already exists for this date': 'Đã tồn tại cho ngày này',
            'conflicts with existing bookings': 'Trùng với đơn đặt lịch hiện có',
            'conflicts with existing': 'Trùng với dữ liệu hiện có',
            'cannot create time-off': 'Không thể tạo ngày nghỉ',
            'cannot add day': 'Không thể thêm ngày',
            'cannot create schedule': 'Không thể tạo lịch làm việc',
            'cannot update schedule': 'Không thể cập nhật lịch làm việc',
            'cannot delete schedule': 'Không thể xóa lịch làm việc',
            'cannot delete time-off': 'Không thể xóa ngày nghỉ',
            'already exists': 'Đã tồn tại',
            'unauthorized': 'Bạn chưa đăng nhập hoặc phiên đăng nhập đã hết hạn',
            'not found': 'Không tìm thấy dữ liệu',
            'bad request': 'Yêu cầu không hợp lệ',
            'internal server error': 'Lỗi hệ thống. Vui lòng thử lại sau',
            'conflicts': 'Xung đột dữ liệu'
        };
        
        // Check for exact matches (từ dài đến ngắn)
        const sortedKeys = Object.keys(translations).sort((a, b) => b.length - a.length);
        for (const key of sortedKeys) {
            if (lowerText.includes(key)) {
                return translations[key];
            }
        }
        
        // Return original message if no translation found
        return message;
    }
    
    // Initialize
    updateCalendarDisplay();
</script>

<!-- Modals Section -->
<div class="modal fade" id="createWeeklyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered schedule-modal-dialog">
        <div class="modal-content schedule-modal">
            <div class="modal-header schedule-modal-header schedule-modal-header-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; color: #fff !important;">
                <h5 class="modal-title" style="color: #fff !important;">
                    <i class="bi bi-calendar-week me-2"></i> Tạo lịch theo tuần
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="weeklyForm" novalidate>
                <div class="modal-body schedule-modal-body">
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-calendar3 me-2"></i> Chọn các ngày trong tuần
                        </label>
                        <div class="schedule-days-grid">
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day0" value="0">
                                <label class="schedule-day-label" for="day0">
                                    <i class="bi bi-calendar-week"></i> Chủ nhật
                                </label>
                            </div>
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day1" value="1">
                                <label class="schedule-day-label" for="day1">
                                    <i class="bi bi-calendar-check"></i> Thứ 2
                                </label>
                            </div>
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day2" value="2">
                                <label class="schedule-day-label" for="day2">
                                    <i class="bi bi-calendar-check"></i> Thứ 3
                                </label>
                            </div>
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day3" value="3">
                                <label class="schedule-day-label" for="day3">
                                    <i class="bi bi-calendar-check"></i> Thứ 4
                                </label>
                            </div>
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day4" value="4">
                                <label class="schedule-day-label" for="day4">
                                    <i class="bi bi-calendar-check"></i> Thứ 5
                                </label>
                            </div>
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day5" value="5">
                                <label class="schedule-day-label" for="day5">
                                    <i class="bi bi-calendar-check"></i> Thứ 6
                                </label>
                            </div>
                            <div class="schedule-day-checkbox">
                                <input class="form-check-input schedule-checkbox" type="checkbox" id="day6" value="6">
                                <label class="schedule-day-label" for="day6">
                                    <i class="bi bi-calendar-check"></i> Thứ 7
                                </label>
                            </div>
                        </div>
                        <div class="error-message" id="days-error"></div>
                        <div class="schedule-days-actions">
                            <button type="button" class="btn btn-schedule-select-all" onclick="selectAllDays()" style="border-color: #f59e0b !important; color: #f59e0b !important; background: rgba(245, 158, 11, 0.1) !important;">
                                <i class="bi bi-check-all me-1"></i> Chọn tất cả
                            </button>
                            <button type="button" class="btn btn-schedule-clear-all" onclick="clearAllDays()" style="border-color: #fbbf24 !important; color: #f59e0b !important; background: rgba(251, 191, 36, 0.1) !important;">
                                <i class="bi bi-x-circle me-1"></i> Bỏ chọn tất cả
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="schedule-form-group">
                                <label class="schedule-form-label">
                                    <i class="bi bi-clock me-2"></i> Giờ bắt đầu
                                </label>
                                <input type="time" class="form-control schedule-form-control" id="weeklyStartTime" required>
                                <div class="error-message" id="weeklyStartTime-error"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="schedule-form-group">
                                <label class="schedule-form-label">
                                    <i class="bi bi-clock-fill me-2"></i> Giờ kết thúc
                                </label>
                                <input type="time" class="form-control schedule-form-control" id="weeklyEndTime" required>
                                <div class="error-message" id="weeklyEndTime-error"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-list-check me-2"></i> Giới hạn đơn mỗi ngày (tùy chọn)
                        </label>
                        <input type="number" class="form-control schedule-form-control" id="weeklyBookingLimit" min="1" max="100" placeholder="Không giới hạn">
                        <small class="schedule-form-text">Để trống nếu không muốn giới hạn</small>
                        <div class="error-message" id="weeklyBookingLimit-error"></div>
                    </div>
                </div>
                <div class="modal-footer schedule-modal-footer">
                    <button type="button" class="btn btn-schedule-cancel" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-schedule-submit btn-schedule-submit-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; color: #fff !important; border: none !important;">
                        <i class="bi bi-check-circle me-2"></i> Tạo lịch
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createDailyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered schedule-modal-dialog">
        <div class="modal-content schedule-modal">
            <div class="modal-header schedule-modal-header schedule-modal-header-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; color: #fff !important;">
                <h5 class="modal-title" style="color: #fff !important;">
                    <i class="bi bi-calendar-plus me-2"></i> Thêm ngày làm việc
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="dailyForm" novalidate>
                <div class="modal-body schedule-modal-body">
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-calendar3 me-2"></i> Thứ trong tuần
                        </label>
                        <select class="form-select schedule-form-control" id="dailyDayOfWeek" required>
                            <option value="">-- Chọn thứ --</option>
                            <option value="0">Chủ nhật</option>
                            <option value="1">Thứ 2</option>
                            <option value="2">Thứ 3</option>
                            <option value="3">Thứ 4</option>
                            <option value="4">Thứ 5</option>
                            <option value="5">Thứ 6</option>
                            <option value="6">Thứ 7</option>
                        </select>
                        <div class="error-message" id="dailyDayOfWeek-error"></div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="schedule-form-group">
                                <label class="schedule-form-label">
                                    <i class="bi bi-clock me-2"></i> Giờ bắt đầu
                                </label>
                                <input type="time" class="form-control schedule-form-control" id="dailyStartTime" required>
                                <div class="error-message" id="dailyStartTime-error"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="schedule-form-group">
                                <label class="schedule-form-label">
                                    <i class="bi bi-clock-fill me-2"></i> Giờ kết thúc
                                </label>
                                <input type="time" class="form-control schedule-form-control" id="dailyEndTime" required>
                                <div class="error-message" id="dailyEndTime-error"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-list-check me-2"></i> Giới hạn đơn
                        </label>
                        <input type="number" class="form-control schedule-form-control" id="dailyBookingLimit" min="1" max="100" placeholder="Không giới hạn">
                        <div class="error-message" id="dailyBookingLimit-error"></div>
                    </div>
                </div>
                <div class="modal-footer schedule-modal-footer">
                    <button type="button" class="btn btn-schedule-cancel" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-schedule-submit btn-schedule-submit-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; color: #fff !important; border: none !important;">
                        <i class="bi bi-plus-circle me-2"></i> Thêm
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Time Off Modal -->
<div class="modal fade" id="createTimeOffModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered schedule-modal-dialog">
        <div class="modal-content schedule-modal">
            <div class="modal-header schedule-modal-header schedule-modal-header-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; color: #fff !important;">
                <h5 class="modal-title" style="color: #fff !important;">
                    <i class="bi bi-calendar-x me-2"></i> Tạo ngày nghỉ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="timeOffForm" novalidate>
                <div class="modal-body schedule-modal-body">
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-calendar-date me-2"></i> Ngày nghỉ
                        </label>
                        <input type="date" class="form-control schedule-form-control" id="timeOffDate" required>
                        <div class="error-message" id="timeOffDate-error"></div>
                    </div>
                    
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-file-text me-2"></i> Lý do nghỉ (tùy chọn)
                        </label>
                        <textarea class="form-control schedule-form-control" id="timeOffReason" rows="3" placeholder="Ví dụ: Nghỉ lễ, Nghỉ phép..."></textarea>
                        <div class="error-message" id="timeOffReason-error"></div>
                    </div>
                </div>
                <div class="modal-footer schedule-modal-footer">
                    <button type="button" class="btn btn-schedule-cancel" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-schedule-submit btn-schedule-submit-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important; color: #fff !important; border: none !important;">
                        <i class="bi bi-calendar-x me-2"></i> Tạo ngày nghỉ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container - Centered -->
<div class="toast-container-center" id="toastContainer"></div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content schedule-modal">
            <div class="modal-header schedule-modal-header schedule-modal-header-warning">
                <h5 class="modal-title" id="confirmModalTitle">
                    <i class="bi bi-exclamation-triangle me-2"></i> Xác nhận
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body schedule-modal-body">
                <p id="confirmModalMessage" class="schedule-confirm-message"></p>
                <div id="confirmModalDetails" class="schedule-confirm-details"></div>
            </div>
            <div class="modal-footer schedule-modal-footer">
                <button type="button" class="btn btn-schedule-cancel" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i> Hủy
                </button>
                <button type="button" class="btn btn-schedule-submit btn-schedule-submit-danger" id="confirmModalButton">
                    <i class="bi bi-check-circle me-2"></i> Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content schedule-modal">
            <div class="modal-header schedule-modal-header schedule-modal-header-warning">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i> Chỉnh sửa lịch làm việc
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editScheduleForm" novalidate>
                <input type="hidden" id="editScheduleId">
                <div class="modal-body schedule-modal-body">
                    <div class="schedule-alert schedule-alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <div>
                            <strong id="editScheduleDayName"></strong>
                            <div class="small">Chỉnh sửa giới hạn đơn nhận trong ngày</div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="schedule-form-group">
                                <label class="schedule-form-label">
                                    <i class="bi bi-clock me-2"></i> Giờ bắt đầu
                                </label>
                                <input type="text" class="form-control schedule-form-control" id="editStartTimeDisplay" readonly style="background-color: #f8f9fa;">
                                <input type="hidden" id="editStartTime">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="schedule-form-group">
                                <label class="schedule-form-label">
                                    <i class="bi bi-clock-fill me-2"></i> Giờ kết thúc
                                </label>
                                <input type="text" class="form-control schedule-form-control" id="editEndTimeDisplay" readonly style="background-color: #f8f9fa;">
                                <input type="hidden" id="editEndTime">
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-form-group">
                        <label class="schedule-form-label">
                            <i class="bi bi-list-check me-2"></i> Giới hạn đơn nhận trong ngày
                        </label>
                        <input type="number" class="form-control schedule-form-control" id="editBookingLimit" min="1" max="100" placeholder="Không giới hạn">
                        <small class="schedule-form-text">Để trống nếu không muốn giới hạn số đơn nhận trong ngày</small>
                        <div class="error-message" id="editBookingLimit-error"></div>
                    </div>
                </div>
                <div class="modal-footer schedule-modal-footer">
                    <button type="button" class="btn btn-schedule-cancel" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-schedule-submit btn-schedule-submit-warning">
                        <i class="bi bi-check-circle me-2"></i> Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Global data for provider-schedule.js
        window.schedulesData = @Html.Raw(Model?.Schedules != null ? Json.Serialize(Model.Schedules) : "[]");
        window.timeOffsData = @Html.Raw(Model?.UpcomingTimeOffs != null ? Json.Serialize(Model.UpcomingTimeOffs) : "[]");
        
        // API URLs
        window.createWeeklyScheduleUrl = '@Url.Action("CreateWeeklySchedule", "ProviderSchedule", new { area = "Provider" })';
        window.createScheduleUrl = '@Url.Action("CreateSchedule", "ProviderSchedule", new { area = "Provider" })';
        window.createTimeOffUrl = '@Url.Action("CreateTimeOff", "ProviderSchedule", new { area = "Provider" })';
    </script>
    
    <!-- Provider Schedule Management Script -->
    <script src="~/js/provider-schedule.js" asp-append-version="true"></script>
}

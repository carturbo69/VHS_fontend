@model VHS_frontend.Areas.Provider.Models.Feedback.ProviderFeedbackViewModel
@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "Phản hồi khách hàng";

    // Đếm dịch vụ có ít nhất 1 feedback
    var servicesRated = Model?.ServiceFeedbacks?.Count(s => (s?.TotalFeedbacks ?? 0) > 0) ?? 0;
}

<div class="feedback-container">
    <!-- Header Section -->
    <div class="feedback-header mb-4">
        <h2 class="mb-2">Phản hồi khách hàng</h2>
        <p class="text-muted">Tổng hợp đánh giá và phản hồi từ khách hàng</p>
    </div>

    <!-- Overall Stats -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon"><i class="bi bi-star-fill"></i></div>
                <div class="stat-content">
                    <h3>@Model.OverallStats.AverageRating.ToString("F1")</h3>
                    <p>Đánh giá trung bình</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon"><i class="bi bi-chat-dots"></i></div>
                <div class="stat-content">
                    <h3>@Model.OverallStats.TotalFeedbacks</h3>
                    <p>Tổng phản hồi</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon"><i class="bi bi-emoji-smile"></i></div>
                <div class="stat-content">
                    <h3>@Model.OverallStats.FiveStarCount</h3>
                    <p>Đánh giá 5 sao</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon"><i class="bi bi-award"></i></div>
                <div class="stat-content">
                    <h3>@servicesRated</h3>
                    <p>Dịch vụ được đánh giá</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Distribution -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Phân bố đánh giá</h5>
                </div>
                <div class="card-body">
                    <div class="rating-distribution">
                        @for (int i = 5; i >= 1; i--)
                        {
                            var count = i switch
                            {
                                5 => Model.OverallStats.FiveStarCount,
                                4 => Model.OverallStats.FourStarCount,
                                3 => Model.OverallStats.ThreeStarCount,
                                2 => Model.OverallStats.TwoStarCount,
                                1 => Model.OverallStats.OneStarCount,
                                _ => 0
                            };
                            var percentage = Model.OverallStats.TotalFeedbacks > 0 ? (count * 100.0 / Model.OverallStats.TotalFeedbacks) : 0;

                            <div class="rating-bar">
                                <div class="rating-label">
                                    <span class="rating-stars">
                                        @for (int j = 1; j <= i; j++)
                                        {
                                            <i class="bi bi-star-fill"></i>
                                        }
                                    </span>
                                    <span class="rating-count">@count</span>
                                </div>
                                <div class="rating-progress">
                                    <div class="progress">
                                        <div class="progress-bar" style="width: @percentage%"></div>
                                    </div>
                                    <span class="rating-percentage">@percentage.ToString("F0")%</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Feedback Groups -->
    <div class="service-feedbacks">
        @foreach (var serviceGroup in Model.ServiceFeedbacks)
        {
            var hasFeedback = (serviceGroup.TotalFeedbacks > 0) && (serviceGroup.Feedbacks != null) && serviceGroup.Feedbacks.Count > 0;

            <div class="service-feedback-group mb-4">
                <div class="card">
                    <div class="card-header service-header">
                        <div class="service-info">
                            <div class="service-icon">
                                @* Nếu là URL ảnh -> img, ngược lại coi là class icon *@
                                @if (IsUrl(serviceGroup.ServiceIcon))
                                {
                                    <img src="@serviceGroup.ServiceIcon"
                                         alt="@serviceGroup.ServiceName"
                                         class="service-icon-img"
                                         onerror="this.style.display='none';" />
                                }
                                else
                                {
                                    <i class="bi @(string.IsNullOrWhiteSpace(serviceGroup.ServiceIcon) ? "bi-image" : serviceGroup.ServiceIcon)"></i>
                                }
                            </div>
                            <div class="service-details">
                                <h5 class="service-name">@serviceGroup.ServiceName</h5>
                                <div class="service-rating">
                                    <div class="rating-stars">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= Math.Floor(serviceGroup.AverageRating))
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                            else if (i - 0.5 <= serviceGroup.AverageRating)
                                            {
                                                <i class="bi bi-star-half"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star"></i>
                                            }
                                        }
                                        <span class="rating-value">@serviceGroup.AverageRating.ToString("F1")</span>
                                    </div>
                                    <span class="rating-count">(@serviceGroup.TotalFeedbacks đánh giá)</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#service-@serviceGroup.ServiceId">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>

                    <div class="collapse" id="service-@serviceGroup.ServiceId" data-has-feedback="@(hasFeedback)">
                        <div class="card-body p-0">
                            @if (!hasFeedback)
                            {
                                <div class="p-4 text-muted fst-italic">
                                    Chưa có đánh giá nào cho dịch vụ này.
                                </div>
                            }
                            else
                            {
                                <div class="feedbacks-list">
                                    @foreach (var feedback in serviceGroup.Feedbacks)
                                    {
                                        <div class="feedback-item">
                                            <div class="feedback-avatar">
                                                @if (!string.IsNullOrWhiteSpace(feedback.CustomerAvatar))
                                                {
                                                    <img class="avatar-circle-img" src="@feedback.CustomerAvatar"
                                                         alt="@feedback.CustomerName"
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div class="avatar-circle" style="display:none;">
                                                        @GetInitials(feedback.CustomerName)
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="avatar-circle">@GetInitials(feedback.CustomerName)</div>
                                                }
                                            </div>

                                            <div class="feedback-content">
                                                <div class="feedback-header">
                                                    <h6 class="customer-name">@feedback.CustomerName</h6>
                                                    <div class="feedback-rating">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <i class="bi bi-star-fill @(i <= feedback.Rating ? "filled" : "empty")"></i>
                                                        }
                                                    </div>
                                                    <div class="feedback-meta">
                                                        <span class="feedback-date">@feedback.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                                        @if (feedback.IsVerified)
                                                        {
                                                            <span class="verified-badge">
                                                                <i class="bi bi-check-circle-fill"></i> Đã xác thực
                                                            </span>
                                                        }
                                                    </div>
                                                </div>

                                                <div class="feedback-comment">
                                                    <p>@feedback.Comment</p>
                                                </div>

                                                @if (feedback.Images != null && feedback.Images.Any())
                                                {
                                                    <div class="feedback-images">
                                                        <div class="image-gallery">
                                                            @foreach (var imgUrl in feedback.Images)
                                                            {
                                                                <div class="image-item" data-full="@imgUrl" onclick="openImageModal('@feedback.ReviewId','@imgUrl')">
                                                                    <img src="@imgUrl" alt="feedback-image" class="gallery-thumbnail" loading="lazy" />
                                                                    <div class="image-overlay"><i class="bi bi-zoom-in"></i></div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                }

                                                @if (!string.IsNullOrWhiteSpace(feedback.Reply))
                                                {
                                                    <div class="provider-reply">
                                                        <div class="reply-header">
                                                            <div class="reply-avatar"><i class="bi bi-building"></i></div>
                                                            <div class="reply-info">
                                                                <span class="reply-author">Bạn</span>
                                                                <span class="reply-date">@feedback.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                                            </div>
                                                        </div>
                                                        <div class="reply-content"><p>@feedback.Reply</p></div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="reply-form" id="reply-form-@feedback.ReviewId" style="display: none;">
                                                        <div class="reply-input-group">
                                                            <textarea class="form-control reply-textarea" placeholder="Trả lời khách hàng..." rows="3"></textarea>
                                                            <div class="reply-actions">
                                                                <button class="btn btn-outline-secondary btn-sm" onclick="cancelReply('@feedback.ReviewId', this)">
                                                                    <i class="bi bi-x"></i> Hủy
                                                                </button>
                                                                <button class="btn btn-primary btn-sm" onclick="submitReply('@feedback.ReviewId', this)">
                                                                    <i class="bi bi-send"></i> Gửi
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="reply-button">
                                                        <button class="btn btn-outline-primary btn-sm" onclick="showReplyForm('@feedback.ReviewId', this)">
                                                            <i class="bi bi-reply"></i> Trả lời
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                </div>
            </div>
        }
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Hình ảnh feedback</h5>
                <div class="image-counter">
                    <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center position-relative">
                <button class="btn btn-outline-light btn-nav btn-prev" onclick="previousImage()" id="prevBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="image-container">
                    <img id="modalImage" src="" alt="" class="img-fluid modal-main-image">
                </div>
                <button class="btn btn-outline-light btn-nav btn-next" onclick="nextImage()" id="nextBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Đóng
                </button>
                <a id="downloadImage" href="" download class="btn btn-primary">
                    <i class="bi bi-download"></i> Tải xuống
                </a>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/provider-feedback.css" asp-append-version="true" />
    <style>
        /* Gợi ý css nhỏ cho icon ảnh */
        .service-icon-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px
        }
    </style>
}

<!-- Anti-forgery token (để JS lấy ra và gắn vào header) -->
<form id="afTokenForm" style="display:none">
    @Html.AntiForgeryToken()
</form>


@section Scripts {
    <script>
        // URL form-post tới action Reply (area Provider)
        const REPLY_URL = '@Url.Action("Reply", "ProviderFeedback", new { area = "Provider" })';

        document.addEventListener('DOMContentLoaded', function () {
            // Tự mở nhóm đầu tiên có feedback; nếu không có thì mở nhóm đầu tiên
            const collapses = Array.from(document.querySelectorAll('.collapse'));
            let target = collapses.find(c => c.getAttribute('data-has-feedback') === 'True'
                                          || c.getAttribute('data-has-feedback') === 'true');
            if (!target && collapses.length > 0) target = collapses[0];
            if (target) {
                target.classList.add('show');

                // Đồng bộ chevron ngay khi mở ban đầu
                const btn = document.querySelector(`[data-bs-target="#${target.id}"]`);
                const chev = btn?.querySelector('i');
                if (chev && chev.classList.contains('bi-chevron-down')) {
                    chev.classList.replace('bi-chevron-down', 'bi-chevron-up');
                }
            }

            // Toggle chevron khi click
            document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const target = document.querySelector(this.getAttribute('data-bs-target'));
                    const chevron = this.querySelector('i');
                    setTimeout(() => {
                        if (target.classList.contains('show')) {
                            chevron.classList.replace('bi-chevron-down', 'bi-chevron-up');
                        } else {
                            chevron.classList.replace('bi-chevron-up', 'bi-chevron-down');
                        }
                    }, 100);
                });
            });
        });

        // ====== Reply UI ======
        function showReplyForm(reviewId, btnEl) {
            const form = document.getElementById(`reply-form-${reviewId}`);
            const btnWrap = btnEl.closest('.reply-button');
            form.style.display = 'block';
            if (btnWrap) btnWrap.style.display = 'none';
            form.querySelector('.reply-textarea').focus();
        }

        function cancelReply(reviewId, btnEl) {
            const form = document.getElementById(`reply-form-${reviewId}`);
            const container = form.parentElement;
            const btnWrap = container.querySelector('.reply-button');
            form.style.display = 'none';
            if (btnWrap) btnWrap.style.display = 'block';
            form.querySelector('.reply-textarea').value = '';
        }

        // GỌI ACTION Reply (form-post + AntiForgery)
        async function submitReply(reviewId, btnEl) {
            const txt = document.querySelector(`#reply-form-${reviewId} .reply-textarea`);
            const content = (txt?.value || '').trim();
            if (!content) { alert('Vui lòng nhập nội dung trả lời!'); return; }

            // Lấy AntiForgery token đã render trong #afTokenForm
            const token = document.querySelector('#afTokenForm input[name="__RequestVerificationToken"]')?.value;
            if (!token) {
                showToast('Thiếu anti-forgery token.', 'danger');
                return;
            }

            btnEl.disabled = true;
            const oldHtml = btnEl.innerHTML;
            btnEl.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang gửi...';

            try {
                // Dùng x-www-form-urlencoded để match [FromForm]
                const form = new URLSearchParams();
                form.append('ReviewId', reviewId);
                form.append('Content', content);

                const res = await fetch(REPLY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: form.toString()
                });

                // Backend redirect về Index khi success/fail (do là action MVC).
                // Để tránh reload, ta xử lý theo JSON nếu có; nếu không có JSON thì fallback reload.
                const text = await res.text();
                let payload = null;
                try { payload = JSON.parse(text); } catch { /* không phải JSON => là HTML redirect */ }

                if (!res.ok) {
                    const msg = payload?.message || `Lỗi gọi API (${res.status} ${res.statusText}).`;
                    throw new Error(msg);
                }

                // Nếu controller trả JSON (khi bạn dùng ReplyAjax) thì đọc success.
                // Với action Reply hiện tại (RedirectToAction), ta coi là thành công và tự update UI.
                if (payload && payload.success === false) {
                    throw new Error(payload.message || 'Gửi phản hồi thất bại.');
                }

                // Thành công: update UI tại chỗ (không cần reload)
                showToast('Đã gửi phản hồi.', 'success');
                applyReplyToDom(reviewId, content);
                cancelReply(reviewId, btnEl);
            } catch (err) {
                console.error(err);
                showToast(err.message || 'Gửi phản hồi thất bại.', 'danger');
            } finally {
                btnEl.disabled = false;
                btnEl.innerHTML = oldHtml;
            }
        }

        function applyReplyToDom(reviewId, content) {
            const containerEl = document.getElementById(`reply-form-${reviewId}`)?.closest('.feedback-content');
            if (!containerEl) return;

            // Ẩn nút "Trả lời"
            const replyBtnWrap = containerEl.querySelector('.reply-button');
            if (replyBtnWrap) replyBtnWrap.style.display = 'none';

            // Nếu đã có block provider-reply thì chỉ cần cập nhật nội dung
            let replyBlock = containerEl.querySelector('.provider-reply');
            if (!replyBlock) {
                replyBlock = document.createElement('div');
                replyBlock.className = 'provider-reply';
                replyBlock.innerHTML = `
                    <div class="reply-header">
                        <div class="reply-avatar"><i class="bi bi-building"></i></div>
                        <div class="reply-info">
                            <span class="reply-author">Bạn</span>
                            <span class="reply-date"></span>
                        </div>
                    </div>
                    <div class="reply-content"><p></p></div>`;
                containerEl.appendChild(replyBlock);
            }

            const dateSpan = replyBlock.querySelector('.reply-date');
            if (dateSpan) dateSpan.textContent = new Date().toLocaleString('vi-VN');

            const p = replyBlock.querySelector('.reply-content > p');
            if (p) p.textContent = content;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `<div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>`;
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(container);
            }
            container.appendChild(toast);
            new bootstrap.Toast(toast).show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        // ====== Image modal ======
        let currentImages = [];
        let currentImageIndex = 0;

        function openImageModal(reviewId, imageUrl) {
            currentImages = [];
            const form = document.getElementById(`reply-form-${reviewId}`);
            const feedbackItem = form ? form.closest('.feedback-item') : null;
            const scope = feedbackItem || document;
            scope.querySelectorAll('.image-gallery .image-item').forEach(it => {
                const url = it.getAttribute('data-full');
                if (url) currentImages.push(url);
            });

            currentImageIndex = currentImages.indexOf(imageUrl);
            if (currentImageIndex < 0) currentImageIndex = 0;

            updateModalContent();
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function updateModalContent() {
            if (!currentImages.length) return;
            const modalImage = document.getElementById('modalImage');
            const downloadLink = document.getElementById('downloadImage');
            const currentIndexSpan = document.getElementById('currentImageIndex');
            const totalImagesSpan = document.getElementById('totalImages');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const url = currentImages[currentImageIndex];
            modalImage.style.opacity = '0.5';
            modalImage.onload = () => modalImage.style.opacity = '1';
            modalImage.src = url;
            modalImage.alt = 'feedback-image';
            downloadLink.href = url;

            currentIndexSpan.textContent = (currentImageIndex + 1).toString();
            totalImagesSpan.textContent = currentImages.length.toString();

            const multi = currentImages.length > 1;
            prevBtn.style.display = multi ? 'block' : 'none';
            nextBtn.style.display = multi ? 'block' : 'none';
        }

        function previousImage() {
            if (currentImages.length <= 1) return;
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            updateModalContent();
        }

        function nextImage() {
            if (currentImages.length <= 1) return;
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            updateModalContent();
        }

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            const modal = document.getElementById('imageModal');
            if (modal.classList.contains('show')) {
                if (e.key === 'ArrowLeft') { e.preventDefault(); previousImage(); }
                else if (e.key === 'ArrowRight') { e.preventDefault(); nextImage(); }
                else if (e.key === 'Escape') { e.preventDefault(); bootstrap.Modal.getInstance(modal).hide(); }
            }
        });
    </script>
}


@functions {
    bool IsUrl(string? v) =>
        !string.IsNullOrWhiteSpace(v) &&
        (v.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
         v.StartsWith("https://", StringComparison.OrdinalIgnoreCase));

    string GetRatingColor(double rating) => rating switch
    {
        >= 4.5 => "success",
        >= 3.5 => "warning",
        >= 2.5 => "info",
        _ => "danger"
    };

    string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpperInvariant();
        return (parts[0][0].ToString() + parts[^1][0].ToString()).ToUpperInvariant();
    }
}
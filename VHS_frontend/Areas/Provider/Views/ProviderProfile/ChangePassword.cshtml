@model VHS_frontend.Areas.Provider.Models.Profile.ChangePasswordDTO
@{
    ViewData["Title"] = "Thay đổi mật khẩu";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/provider-change-password.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/otp-modal.css" asp-append-version="true" />
}

<div class="provider-profile">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                <!-- Header Section -->
                <div class="profile-change-password-header">
                    <div class="header-icon">
                        <i class="bi bi-shield-lock"></i>
                </div>
                    <div class="header-content">
                        <h1 class="header-title">Thay đổi mật khẩu</h1>
                        <p class="header-subtitle">Cập nhật mật khẩu tài khoản của bạn để bảo mật tốt hơn</p>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @TempData["Success"]
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @TempData["Error"]
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

                <!-- Change Password Form Card -->
                <div class="change-password-form-card">
                    <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                        @Html.AntiForgeryToken()
                        
                        <!-- Email (Hidden, for form submission) -->
                        <input asp-for="Email" type="hidden" id="Email" />
                        
                        <!-- Hidden OTP input for form submission (synchronized with visible input) -->
                        <input type="hidden" asp-for="OTP" id="OTP" />
                        
                        <!-- Current Password -->
                        <div class="mb-4">
                            <label asp-for="CurrentPassword" class="form-label">
                                <i class="bi bi-lock"></i>
                                Mật khẩu hiện tại <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="CurrentPassword" type="password" class="form-control" 
                                       id="CurrentPassword"
                                       placeholder="Nhập mật khẩu hiện tại" 
                                       autocomplete="current-password" />
                                <button type="button" class="btn-toggle-password" data-target="CurrentPassword" aria-label="Hiển thị mật khẩu">
                                    <i class="bi bi-eye" id="CurrentPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                        </div>

                        <!-- New Password -->
                        <div class="mb-4">
                            <label asp-for="NewPassword" class="form-label">
                                <i class="bi bi-key"></i>
                                Mật khẩu mới <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="NewPassword" type="password" class="form-control" 
                                       id="NewPassword"
                                       placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" 
                                       autocomplete="new-password" />
                                <button type="button" class="btn-toggle-password" data-target="NewPassword" aria-label="Hiển thị mật khẩu">
                                    <i class="bi bi-eye" id="NewPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Mật khẩu phải có ít nhất 6 ký tự
                            </div>
                            <!-- Password Strength Indicator -->
                            <div class="password-strength" id="passwordStrength">
                                <div class="password-strength-bar">
                                    <div class="password-strength-bar-fill" id="passwordStrengthBar"></div>
                                </div>
                                <div class="password-strength-text" id="passwordStrengthText"></div>
                            </div>
                        </div>

                        <!-- Confirm Password -->
                        <div class="mb-4">
                            <label asp-for="ConfirmPassword" class="form-label">
                                <i class="bi bi-key-fill"></i>
                                Xác nhận mật khẩu mới <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="ConfirmPassword" type="password" class="form-control" 
                                       id="ConfirmPassword"
                                       placeholder="Xác nhận mật khẩu mới" 
                                       autocomplete="new-password" />
                                <button type="button" class="btn-toggle-password" data-target="ConfirmPassword" aria-label="Hiển thị mật khẩu">
                                    <i class="bi bi-eye" id="ConfirmPassword-icon"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                            <div class="text-danger" id="confirmPasswordError" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;">
                                Mật khẩu xác nhận không khớp
                            </div>
                        </div>

                        <!-- OTP Input -->
                        <div class="mb-4">
                            <label asp-for="OTP" class="form-label">
                                <i class="bi bi-shield-check"></i>
                                Mã OTP <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="OTP" type="text" class="form-control" 
                                       id="OTPInput"
                                       placeholder="Nhập mã OTP 6 số" 
                                       maxlength="6"
                                       autocomplete="off" />
                                <button type="button" class="btn-send-otp" id="btnSendOTP">
                                    <i class="bi bi-envelope"></i>
                                    <span id="btnSendOTPText">Gửi OTP</span>
                                </button>
                            </div>
                            <span asp-validation-for="OTP" class="text-danger"></span>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Nhấn "Gửi OTP" để nhận mã xác thực qua email
                            </div>
                            <div class="text-danger" id="otpError" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;"></div>
                            <div class="text-success" id="otpSuccess" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;"></div>
                            <div class="otp-timer" id="otpTimer" style="display: none; margin-top: 0.5rem;">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i>
                                    Có thể gửi lại sau <span id="otpCountdown" style="color: #f59e0b; font-weight: 600;">60</span> giây
                                </small>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="submitBtn">
                                <i class="bi bi-check-circle"></i>
                                <span id="submitText">Thay đổi mật khẩu</span>
                                <span id="loadingSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                            </button>
                            <a href="@Url.Action("Index", "ProviderProfile")" class="btn-cancel">
                                <i class="bi bi-arrow-left"></i>
                                <span>Quay lại</span>
                            </a>
                        </div>
                    </form>
            </div>

                <!-- Security Tips Card -->
                <div class="security-tips-card">
                <div class="card-header">
                        <h6 class="card-title">
                            <i class="bi bi-lightbulb"></i>
                        Mẹo bảo mật mật khẩu
                    </h6>
                </div>
                    <ul class="list-unstyled">
                        <li>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span>Sử dụng ít nhất 6 ký tự</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span>Kết hợp chữ hoa, chữ thường, số và ký tự đặc biệt</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span>Không sử dụng thông tin cá nhân</span>
                        </li>
                        <li>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span>Thay đổi mật khẩu định kỳ</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Xác thực OTP -->
<div id="otpModal" class="modal-overlay" hidden>
    <div class="modal-card otp-modal-card" role="dialog" aria-modal="true">
        <div class="otp-modal-head">
            <div class="otp-modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
            </div>
            <h3 class="otp-modal-title">Xác thực thay đổi mật khẩu</h3>
            <button type="button" class="otp-modal-close" aria-label="Đóng" onclick="closeOTPModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="otp-modal-body">
            <p class="otp-modal-description">
                Chúng tôi đã gửi mã OTP 6 số đến email của bạn
            </p>
            <div class="otp-email-display">
                <i class="bi bi-envelope"></i>
                <span id="otpEmailDisplay"></span>
            </div>
            
            <div class="otp-input-container">
                <label class="otp-input-label">Nhập mã OTP</label>
                <div id="otpInputs" class="otp-inputs-wrapper">
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                </div>
                <input type="hidden" id="otpEmail" />
                <span id="otpError" class="otp-error-message"></span>
                <div id="otpSuccess" class="otp-success-message"></div>
            </div>

            <div class="otp-resend-section">
                <p class="otp-resend-question">Không nhận được mã?</p>
                <div id="otpTimer" class="otp-timer">
                    <i class="bi bi-clock"></i>
                    <span>Mã OTP còn hiệu lực trong: <strong id="otpCountdown">02:00</strong></span>
                </div>
                <button type="button" class="otp-resend-btn" onclick="resendOTPForChangePassword()" id="btnResendOTP">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span id="btnResendText">Gửi lại mã OTP</span>
                </button>
            </div>
        </div>
        <div class="otp-modal-foot">
            <button type="button" class="otp-btn-cancel" onclick="closeOTPModal()">
                <i class="bi bi-x-circle"></i>
                <span>Đóng</span>
            </button>
            <button type="button" class="otp-btn-confirm" onclick="submitChangePasswordWithOTP()" id="btnActivate">
                <span id="btnActivateText">Xác nhận</span>
                <span id="btnActivateLoader" class="otp-loader" style="display: none;">
                    <span class="spinner-border spinner-border-sm"></span>
                </span>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function() {
            // ===== Password Toggle =====
            const toggleButtons = document.querySelectorAll('.btn-toggle-password');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const field = document.getElementById(targetId);
                    const icon = document.getElementById(targetId + '-icon');
            
                    if (field && icon) {
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'bi bi-eye-slash';
                            this.setAttribute('aria-label', 'Ẩn mật khẩu');
            } else {
                field.type = 'password';
                icon.className = 'bi bi-eye';
                            this.setAttribute('aria-label', 'Hiển thị mật khẩu');
            }
        }
                });
            });

            // ===== OTP Modal =====
            const emailInput = document.getElementById('Email');
            const otpHiddenInput = document.getElementById('OTP');
            const otpModal = document.getElementById('otpModal');
            const otpEmailDisplay = document.getElementById('otpEmailDisplay');
            const otpEmailInput = document.getElementById('otpEmail');
            const otpError = document.getElementById('otpError');
            const otpSuccess = document.getElementById('otpSuccess');
            let otpSent = false;
            let passwordValidated = false;

            // OTP Inputs - 6 separate inputs (in modal)
            const otpInputs = document.querySelectorAll('#otpModal .otp-digit');
            const btnActivate = document.getElementById('btnActivate');
            const btnActivateText = document.getElementById('btnActivateText');
            const btnActivateLoader = document.getElementById('btnActivateLoader');
            
            // Function to update hidden input with OTP code
            function updateOTPCode() {
                const code = Array.from(otpInputs).map(input => input.value).join('');
                if (otpHiddenInput) {
                    otpHiddenInput.value = code;
                }
                
                // Validate when all 6 digits are filled
                if (code.length === 6) {
                    validateOTP(code);
                    // Enable button
                    if (btnActivate) {
                        btnActivate.disabled = false;
                        btnActivate.style.opacity = '1';
                    }
                } else {
                    clearOTPError();
                    // Disable button
                    if (btnActivate) {
                        btnActivate.disabled = true;
                        btnActivate.style.opacity = '0.6';
                    }
                }
            }
            
            // Setup OTP inputs
            otpInputs.forEach((input, index) => {
                // Input event - chỉ cho phép số và tự động chuyển sang ô tiếp theo
                input.addEventListener('input', function(e) {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;
                    
                    // Thêm class filled khi có giá trị
                    if (value) {
                        e.target.classList.add('filled');
                    } else {
                        e.target.classList.remove('filled');
                    }
                    
                    // Tự động chuyển sang ô tiếp theo khi nhập số
                    if (value && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                    
                    updateOTPCode();
                });
                
                // Keydown event - xử lý Backspace
                input.addEventListener('keydown', function(e) {
                    // Nếu nhấn Backspace và ô hiện tại trống, quay lại ô trước
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        otpInputs[index - 1].focus();
                        otpInputs[index - 1].value = '';
                        otpInputs[index - 1].classList.remove('filled');
                        updateOTPCode();
                    }
                    // Ngăn chặn nhập ký tự không phải số
                    else if (e.key.length === 1 && !/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
                
                // Paste event - xử lý paste OTP
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
                    
                    // Điền vào các ô
                    digits.split('').forEach((digit, i) => {
                        if (otpInputs[i]) {
                            otpInputs[i].value = digit;
                            otpInputs[i].classList.add('filled');
                        }
                    });
                    
                    // Focus vào ô cuối cùng nếu đủ 6 số, hoặc ô tiếp theo nếu chưa đủ
                    if (digits.length === 6) {
                        otpInputs[5].focus();
                    } else if (digits.length > 0) {
                        otpInputs[digits.length].focus();
                    }
                    
                    updateOTPCode();
                });
                
                // Focus event - select all text khi focus
                input.addEventListener('focus', function(e) {
                    e.target.select();
                });
            });

            // Open OTP Modal
            function openOTPModal(email) {
                if (otpModal) {
                    // Set email
                    if (otpEmailDisplay) otpEmailDisplay.textContent = email;
                    if (otpEmailInput) otpEmailInput.value = email;
                    
                    // Clear OTP inputs
                    otpInputs.forEach(input => {
                        input.value = '';
                        input.classList.remove('filled', 'is-invalid', 'is-valid');
                    });
                    if (otpHiddenInput) otpHiddenInput.value = '';
                    
                    // Clear errors
                    if (otpError) {
                        otpError.textContent = '';
                        otpError.style.display = 'none';
                    }
                    if (otpSuccess) {
                        otpSuccess.textContent = '';
                        otpSuccess.style.display = 'none';
                    }
                    
                    // Reset button
                    if (btnActivate) {
                        btnActivate.disabled = true;
                        btnActivate.style.opacity = '0.6';
                    }
                    
                    // Show modal
                    otpModal.removeAttribute('hidden');
                    otpModal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                    
                    // Start timer (use global function)
                    if (typeof startOTPTimer === 'function') {
                        startOTPTimer(120);
                    }
                    
                    // Focus vào ô đầu tiên
                    setTimeout(() => {
                        if (otpInputs[0]) {
                            otpInputs[0].focus();
                        }
                    }, 300);
                }
            }
            
            // Setup modal event listeners
            if (otpModal) {
                // Click outside to close
                otpModal.addEventListener('click', function(e) {
                    if (e.target === otpModal) {
                        if (typeof closeOTPModal === 'function') {
                            closeOTPModal();
                        }
                    }
                });
                
                // ESC key to close
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && otpModal && !otpModal.hasAttribute('hidden')) {
                        if (typeof closeOTPModal === 'function') {
                            closeOTPModal();
                        }
                    }
                });
            }
            
            // Store timer variables in window for global access
            window.otpTimerInterval = null;
            window.otpTimeLeft = 0;

            // Validate OTP
            function validateOTP(value) {
                const trimmed = value?.trim() || '';
                const otpInputs = document.querySelectorAll('#otpModal .otp-digit');
                
                if (trimmed === '') {
                    showOTPError('Mã OTP không được để trống');
                    otpInputs.forEach(input => input.classList.add('is-invalid'));
                    return false;
                }
                if (trimmed.length !== 6) {
                    showOTPError('Mã OTP phải có 6 chữ số');
                    otpInputs.forEach(input => {
                        if (!input.value) input.classList.add('is-invalid');
                    });
                    return false;
                }
                if (!/^[0-9]{6}$/.test(trimmed)) {
                    showOTPError('Mã OTP chỉ được chứa số');
                    otpInputs.forEach(input => input.classList.add('is-invalid'));
                    return false;
                }
                clearOTPError();
                otpInputs.forEach(input => {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                });
                return true;
            }

            function showOTPError(message) {
                const otpError = document.getElementById('otpError');
                const otpSuccess = document.getElementById('otpSuccess');
                if (otpError) {
                    otpError.textContent = message;
                    otpError.style.display = 'block';
                }
                if (otpSuccess) {
                    otpSuccess.style.display = 'none';
                }
            }

            function clearOTPError() {
                const otpError = document.getElementById('otpError');
                const otpSuccess = document.getElementById('otpSuccess');
                if (otpError) {
                    otpError.textContent = '';
                    otpError.style.display = 'none';
                }
                if (otpSuccess) {
                    otpSuccess.textContent = '';
                    otpSuccess.style.display = 'none';
                }
                // Clear invalid state from inputs
                const otpInputs = document.querySelectorAll('#otpModal .otp-digit');
                otpInputs.forEach(input => {
                    input.classList.remove('is-invalid', 'is-valid');
                });
            }

            // ===== Form Validation =====
            const form = document.getElementById('changePasswordForm');
            const currentPasswordInput = document.getElementById('CurrentPassword');
            const newPasswordInput = document.getElementById('NewPassword');
            const confirmPasswordInput = document.getElementById('ConfirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const otpInput = document.getElementById('OTPInput');
            // otpHiddenInput đã được khai báo ở trên (dòng 303 trong OTP Modal section), không khai báo lại
            const otpErrorDisplay = document.getElementById('otpError');
            const otpSuccessDisplay = document.getElementById('otpSuccess');
            const otpTimer = document.getElementById('otpTimer');
            const otpCountdown = document.getElementById('otpCountdown');
            
            // OTP cooldown timer (global scope để có thể truy cập từ bên ngoài IIFE)
            window.otpCooldown = 0;
            window.otpTimerInterval = null;
            
            // Thêm event listener cho nút "Gửi OTP" thay vì dùng onclick
            const btnSendOTP = document.getElementById('btnSendOTP');
            if (btnSendOTP) {
                btnSendOTP.addEventListener('click', function() {
                    if (typeof sendOTPForChangePassword === 'function') {
                        sendOTPForChangePassword();
                    } else {
                        console.error('sendOTPForChangePassword function is not defined');
                    }
                });
            }

            // Helper function để hiển thị lỗi
            function showFieldError(input, message) {
                if (!input) return;
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                let errorSpan = input.parentElement.parentElement.querySelector('.text-danger');
                if (errorSpan) {
                    errorSpan.textContent = message;
                }
            }

            // Helper function để xóa lỗi
            function clearFieldError(input) {
                if (!input) return;
                input.classList.remove('is-invalid');
                const errorSpan = input.parentElement.parentElement.querySelector('.text-danger');
                if (errorSpan) {
                    errorSpan.textContent = '';
                }
            }

            // Validate Current Password
            function validateCurrentPassword(value) {
                const trimmed = value?.trim() || '';
                if (trimmed === '') {
                    showFieldError(currentPasswordInput, 'Mật khẩu hiện tại không được để trống');
                    return false;
                }
                clearFieldError(currentPasswordInput);
                currentPasswordInput.classList.add('is-valid');
                return true;
            }

            // Validate New Password
            function validateNewPassword(value) {
                const trimmed = value?.trim() || '';
                if (trimmed === '') {
                    showFieldError(newPasswordInput, 'Mật khẩu mới không được để trống');
                    updatePasswordStrength('', '');
                    return false;
                }
                if (trimmed.length < 6) {
                    showFieldError(newPasswordInput, 'Mật khẩu mới phải có ít nhất 6 ký tự');
                    updatePasswordStrength(trimmed, 'weak');
                    return false;
                }
                if (trimmed.length > 100) {
                    showFieldError(newPasswordInput, 'Mật khẩu mới không được vượt quá 100 ký tự');
                    return false;
                }
                clearFieldError(newPasswordInput);
                newPasswordInput.classList.add('is-valid');
                updatePasswordStrength(trimmed, calculatePasswordStrength(trimmed));
                return true;
            }

            // Validate Confirm Password
            function validateConfirmPassword(value) {
                const trimmed = value?.trim() || '';
                const newPassword = newPasswordInput?.value?.trim() || '';
                
                if (trimmed === '') {
                    showFieldError(confirmPasswordInput, 'Xác nhận mật khẩu không được để trống');
                    if (confirmPasswordError) confirmPasswordError.style.display = 'none';
                    return false;
                }
                
                if (trimmed !== newPassword) {
                    showFieldError(confirmPasswordInput, '');
                    if (confirmPasswordError) {
                        confirmPasswordError.style.display = 'block';
                        confirmPasswordError.textContent = 'Mật khẩu xác nhận không khớp với mật khẩu mới';
                    }
                    return false;
                }
                
                clearFieldError(confirmPasswordInput);
                if (confirmPasswordError) confirmPasswordError.style.display = 'none';
                confirmPasswordInput.classList.add('is-valid');
                return true;
            }

            // Validate OTP
            function validateOTPInput(value) {
                const trimmed = value?.trim() || '';
                
                if (trimmed === '') {
                    if (otpInput) {
                        otpInput.classList.remove('is-valid');
                        otpInput.classList.add('is-invalid');
                    }
                    if (otpErrorDisplay) {
                        otpErrorDisplay.textContent = 'Mã OTP không được để trống';
                        otpErrorDisplay.style.display = 'block';
                    }
                    return false;
                }
                
                if (trimmed.length !== 6) {
                    if (otpInput) {
                        otpInput.classList.remove('is-valid');
                        otpInput.classList.add('is-invalid');
                    }
                    if (otpErrorDisplay) {
                        otpErrorDisplay.textContent = 'Mã OTP phải có đúng 6 chữ số';
                        otpErrorDisplay.style.display = 'block';
                    }
                    return false;
                }
                
                if (!/^[0-9]{6}$/.test(trimmed)) {
                    if (otpInput) {
                        otpInput.classList.remove('is-valid');
                        otpInput.classList.add('is-invalid');
                    }
                    if (otpErrorDisplay) {
                        otpErrorDisplay.textContent = 'Mã OTP chỉ được chứa số';
                        otpErrorDisplay.style.display = 'block';
                    }
                    return false;
                }
                
                // Valid OTP
                if (otpInput) {
                    otpInput.classList.remove('is-invalid');
                    otpInput.classList.add('is-valid');
                }
                if (otpErrorDisplay) {
                    otpErrorDisplay.textContent = '';
                    otpErrorDisplay.style.display = 'none';
                }
                return true;
            }

            // Calculate Password Strength
        function calculatePasswordStrength(password) {
                if (!password || password.length === 0) return '';
                
            let score = 0;
            if (password.length >= 6) score++;
                if (password.length >= 8) score++;
            if (password.match(/[a-z]/)) score++;
            if (password.match(/[A-Z]/)) score++;
            if (password.match(/[0-9]/)) score++;
            if (password.match(/[^a-zA-Z0-9]/)) score++;
                
                if (score <= 2) return 'weak';
                if (score <= 4) return 'medium';
                return 'strong';
        }

            // Update Password Strength Indicator
            function updatePasswordStrength(password, strength) {
                const strengthContainer = document.getElementById('passwordStrength');
                const strengthBar = document.getElementById('passwordStrengthBar');
                const strengthText = document.getElementById('passwordStrengthText');
                
                if (!strengthContainer || !strengthBar || !strengthText) return;
                
                if (!password || password.length === 0 || !strength) {
                    strengthContainer.classList.remove('show');
                    return;
                }
                
                strengthContainer.classList.add('show');
                strengthBar.className = 'password-strength-bar-fill ' + strength;
                strengthText.className = 'password-strength-text ' + strength;
                
                const strengthLabels = {
                    'weak': 'Mật khẩu yếu',
                    'medium': 'Mật khẩu trung bình',
                    'strong': 'Mật khẩu mạnh'
                };
                
                strengthText.textContent = strengthLabels[strength] || '';
            }

            // Real-time validation cho Current Password
            if (currentPasswordInput) {
                currentPasswordInput.addEventListener('blur', function() {
                    validateCurrentPassword(this.value);
                });
                currentPasswordInput.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateCurrentPassword(this.value);
                    }
                });
            }

            // Real-time validation cho New Password
            if (newPasswordInput) {
                newPasswordInput.addEventListener('blur', function() {
                    validateNewPassword(this.value);
                    // Re-validate confirm password if it has value
                    if (confirmPasswordInput?.value) {
                        validateConfirmPassword(confirmPasswordInput.value);
                    }
                });
                newPasswordInput.addEventListener('input', function() {
                    validateNewPassword(this.value);
                    // Re-validate confirm password if it has value
                    if (confirmPasswordInput?.value) {
                        validateConfirmPassword(confirmPasswordInput.value);
                    }
                });
            }

            // Real-time validation cho Confirm Password
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('blur', function() {
                    validateConfirmPassword(this.value);
                });
                confirmPasswordInput.addEventListener('input', function() {
                    validateConfirmPassword(this.value);
                });
            }

            // OTP Input - chỉ cho phép số và tự động cập nhật hidden input
            if (otpInput) {
                otpInput.addEventListener('input', function(e) {
                    // Chỉ cho phép số
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;
                    
                    // Cập nhật hidden input
                    if (otpHiddenInput) {
                        otpHiddenInput.value = value;
                    }
                    
                    // Validate khi có giá trị
                    if (value.length > 0) {
                        validateOTPInput(value);
                    } else {
                        if (otpInput) {
                            otpInput.classList.remove('is-invalid', 'is-valid');
                        }
                        if (otpErrorDisplay) {
                            otpErrorDisplay.style.display = 'none';
                        }
                    }
                });

                otpInput.addEventListener('blur', function() {
                    validateOTPInput(this.value);
                });

                // Ngăn chặn nhập ký tự không phải số
                otpInput.addEventListener('keydown', function(e) {
                    if (e.key.length === 1 && !/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });

                // Xử lý paste
                otpInput.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const paste = (e.clipboardData || window.clipboardData).getData('text');
                    const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
                    e.target.value = digits;
                    if (otpHiddenInput) {
                        otpHiddenInput.value = digits;
                    }
                    if (digits.length > 0) {
                        validateOTPInput(digits);
                    }
                });
            }

            // Form submit validation
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    let isValid = true;

                    // Validate tất cả các trường password
                    if (!validateCurrentPassword(currentPasswordInput?.value)) {
                        isValid = false;
                    }
                    if (!validateNewPassword(newPasswordInput?.value)) {
                        isValid = false;
                    }
                    if (!validateConfirmPassword(confirmPasswordInput?.value)) {
                        isValid = false;
                    }

                    // Validate OTP - BẮT BUỘC phải có và đúng
                    const otpValue = otpInput?.value?.trim() || '';
                    if (!otpValue) {
                        if (otpErrorDisplay) {
                            otpErrorDisplay.textContent = 'Vui lòng nhập mã OTP.';
                            otpErrorDisplay.style.display = 'block';
                        }
                        if (otpInput) {
                            otpInput.classList.add('is-invalid');
                            otpInput.focus();
                            otpInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        isValid = false;
                    } else if (!validateOTPInput(otpValue)) {
                        isValid = false;
                        if (otpInput) {
                            otpInput.focus();
                            otpInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }

                    if (!isValid) {
                        // Scroll đến trường đầu tiên có lỗi
                        const firstError = form.querySelector('.is-invalid');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstError.focus();
                        }
                        return false;
                    }

                    // Đảm bảo OTP được cập nhật vào hidden input trước khi submit
                    if (otpInput && otpHiddenInput) {
                        otpHiddenInput.value = otpInput.value.trim();
                    }

                    const submitBtn = document.getElementById('submitBtn');
                    const submitText = document.getElementById('submitText');
                    const loadingSpinner = document.getElementById('loadingSpinner');

                    // Show loading state
                    if (submitBtn) submitBtn.disabled = true;
                    if (submitText) submitText.textContent = 'Đang xử lý...';
                    if (loadingSpinner) loadingSpinner.style.display = 'inline-block';

                    // Submit form thực sự (OTP đã được validate ở trên)
                    form.submit();
                });
            }
        })();
        
        // ===== Global Functions for OTP Modal =====
        // Close OTP Modal
        function closeOTPModal() {
            const otpModal = document.getElementById('otpModal');
            if (otpModal) {
                otpModal.classList.remove('show');
                document.body.style.overflow = '';
                setTimeout(() => {
                    otpModal.setAttribute('hidden', '');
                }, 180);
                
                // Clear timer
                if (window.otpTimerInterval) {
                    clearInterval(window.otpTimerInterval);
                    window.otpTimerInterval = null;
                }
            }
        }
        
        // Start OTP Timer
        function startOTPTimer(seconds) {
            window.otpTimeLeft = seconds;
            const countdownEl = document.getElementById('otpCountdown');
            const timerEl = document.getElementById('otpTimer');
            const btnResend = document.getElementById('btnResendOTP');
            
            if (window.otpTimerInterval) {
                clearInterval(window.otpTimerInterval);
            }
            
            if (btnResend) {
                btnResend.disabled = true;
                btnResend.style.opacity = '0.5';
            }
            
            updateCountdownDisplay();
            
            window.otpTimerInterval = setInterval(() => {
                window.otpTimeLeft--;
                updateCountdownDisplay();
                
                if (window.otpTimeLeft <= 0) {
                    clearInterval(window.otpTimerInterval);
                    window.otpTimerInterval = null;
                    
                    if (countdownEl) countdownEl.textContent = '00:00';
                    if (timerEl) {
                        timerEl.innerHTML = '<span style="color: #dc3545; font-weight: 600;">Mã OTP đã hết hạn. Vui lòng gửi lại mã mới.</span>';
                    }
                    
                    if (btnResend) {
                        btnResend.disabled = false;
                        btnResend.style.opacity = '1';
                    }
                }
            }, 1000);
        }
        
        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('otpCountdown');
            if (countdownEl && window.otpTimeLeft !== undefined) {
                const minutes = Math.floor(window.otpTimeLeft / 60);
                const seconds = window.otpTimeLeft % 60;
                countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (window.otpTimeLeft <= 30) {
                    countdownEl.style.color = '#dc3545';
                } else {
                    countdownEl.style.color = '#d97706';
                }
            }
        }
        
        // Resend OTP
        async function resendOTPForChangePassword() {
            const otpEmailInput = document.getElementById('otpEmail');
            const emailInput = document.getElementById('Email');
            const email = otpEmailInput?.value || emailInput?.value || '';
            const otpError = document.getElementById('otpError');
            const otpSuccess = document.getElementById('otpSuccess');
            
            if (!email) {
                if (otpError) {
                    otpError.textContent = 'Email không hợp lệ.';
                    otpError.style.display = 'block';
                }
                return;
            }
            
            const btnResend = document.getElementById('btnResendOTP');
            const btnResendText = document.getElementById('btnResendText');
            const otpInputs = document.querySelectorAll('#otpModal .otp-digit');
            const otpHiddenInput = document.getElementById('OTP');
            const btnActivate = document.getElementById('btnActivate');
            
            if (otpError) otpError.style.display = 'none';
            if (otpSuccess) otpSuccess.style.display = 'none';
            
            const originalText = btnResendText?.textContent || 'Gửi lại mã OTP';
            if (btnResend) {
                btnResend.disabled = true;
                btnResend.style.opacity = '0.5';
            }
            if (btnResendText) btnResendText.textContent = 'Đang gửi...';
            
            try {
                const response = await fetch('@Url.Action("SendOTP", "ProviderProfile")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ Email: email })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (otpSuccess) {
                        otpSuccess.textContent = '✓ Mã OTP mới đã được gửi đến email của bạn.';
                        otpSuccess.style.display = 'block';
                    }
                    
                    // Clear OTP inputs
                    otpInputs.forEach(input => {
                        input.value = '';
                        input.classList.remove('filled');
                    });
                    if (otpHiddenInput) otpHiddenInput.value = '';
                    if (btnActivate) {
                        btnActivate.disabled = true;
                        btnActivate.style.opacity = '0.6';
                    }
                    
                    // Reset timer
                    const timerEl = document.getElementById('otpTimer');
                    if (timerEl) {
                        timerEl.innerHTML = 'Mã OTP còn hiệu lực trong: <span id="otpCountdown" style="color: #d97706;">02:00</span>';
                    }
                    setTimeout(() => {
                        startOTPTimer(120);
                    }, 50);
                    
                    if (otpInputs[0]) otpInputs[0].focus();
                } else {
                    if (otpError) {
                        otpError.textContent = result.message || 'Không thể gửi lại OTP.';
                        otpError.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Resend OTP error:', error);
                if (otpError) {
                    otpError.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
                    otpError.style.display = 'block';
                }
            } finally {
                if (btnResend) {
                    btnResend.disabled = true;
                    btnResend.style.opacity = '0.5';
                }
                if (btnResendText) btnResendText.textContent = originalText;
            }
        }
        
        // Send OTP for Change Password
        async function sendOTPForChangePassword() {
            const btnSendOTP = document.getElementById('btnSendOTP');
            const btnSendOTPText = document.getElementById('btnSendOTPText');
            const otpErrorDisplay = document.getElementById('otpError');
            const otpSuccessDisplay = document.getElementById('otpSuccess');
            const otpInput = document.getElementById('OTPInput');
            const otpTimer = document.getElementById('otpTimer');
            const otpCountdown = document.getElementById('otpCountdown');
            
            // Kiểm tra cooldown
            if (window.otpCooldown > 0) {
                if (otpErrorDisplay) {
                    otpErrorDisplay.textContent = `Vui lòng đợi ${window.otpCooldown} giây trước khi gửi lại.`;
                    otpErrorDisplay.style.display = 'block';
                }
                return;
            }
            
            if (otpErrorDisplay) otpErrorDisplay.style.display = 'none';
            if (otpSuccessDisplay) otpSuccessDisplay.style.display = 'none';
            
            const originalText = btnSendOTPText?.textContent || 'Gửi OTP';
            if (btnSendOTP) {
                btnSendOTP.disabled = true;
            }
            if (btnSendOTPText) btnSendOTPText.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang gửi...';
            
            try {
                // Tạo URL với Area
                const url = '@Url.Action("RequestPasswordChangeOTP", "ProviderProfile", new { area = "Provider" })';
                console.log('Sending OTP request to:', url);
                
                // Lấy anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                console.log('Anti-forgery token exists:', !!token);
                
                // Gọi API gửi OTP (giống Customer)
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                // Kiểm tra status code
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    if (otpErrorDisplay) {
                        otpErrorDisplay.textContent = 'Không thể gửi mã OTP. Vui lòng thử lại sau.';
                        otpErrorDisplay.style.display = 'block';
                    }
                    return;
                }
                
                let result;
                try {
                    const responseText = await response.text();
                    console.log('Response text:', responseText);
                    result = JSON.parse(responseText);
                    console.log('Parsed result:', result);
                } catch (jsonError) {
                    console.error('Error parsing response:', jsonError);
                    if (otpErrorDisplay) {
                        otpErrorDisplay.textContent = 'Có lỗi xảy ra khi xử lý phản hồi từ server. Vui lòng thử lại sau.';
                        otpErrorDisplay.style.display = 'block';
                    }
                    return;
                }
                
                if (result && result.success) {
                    console.log('OTP sent successfully');
                    if (otpSuccessDisplay) {
                        otpSuccessDisplay.textContent = '✓ Mã OTP đã được gửi đến email của bạn.';
                        otpSuccessDisplay.style.display = 'block';
                    }
                    if (otpInput) {
                        otpInput.focus();
                    }
                    
                    // Start cooldown timer
                    window.otpCooldown = 60;
                    if (otpTimer) otpTimer.style.display = 'block';
                    startOTPCooldownTimer();
                } else {
                    const errorMsg = result?.message || 'Không thể gửi mã OTP. Vui lòng thử lại sau.';
                    console.error('OTP send failed:', errorMsg);
                    if (otpErrorDisplay) {
                        otpErrorDisplay.textContent = errorMsg;
                        otpErrorDisplay.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Send OTP error:', error);
                if (otpErrorDisplay) {
                    otpErrorDisplay.textContent = 'Đã xảy ra lỗi: ' + error.message + '. Vui lòng thử lại.';
                    otpErrorDisplay.style.display = 'block';
                }
            } finally {
                if (btnSendOTP) {
                    btnSendOTP.disabled = false;
                }
                if (btnSendOTPText) btnSendOTPText.textContent = originalText;
            }
        }
        
        // Start OTP cooldown timer
        function startOTPCooldownTimer() {
            const otpTimer = document.getElementById('otpTimer');
            const otpCountdown = document.getElementById('otpCountdown');
            
            if (window.otpTimerInterval) {
                clearInterval(window.otpTimerInterval);
            }
            
            window.otpTimerInterval = setInterval(() => {
                window.otpCooldown--;
                if (otpCountdown) {
                    otpCountdown.textContent = window.otpCooldown;
                }
                
                if (window.otpCooldown <= 0) {
                    clearInterval(window.otpTimerInterval);
                    window.otpTimerInterval = null;
                    if (otpTimer) otpTimer.style.display = 'none';
                    const btnSendOTP = document.getElementById('btnSendOTP');
                    if (btnSendOTP) btnSendOTP.disabled = false;
                }
            }, 1000);
        }
        
        // Submit Change Password with OTP
        async function submitChangePasswordWithOTP() {
            const otpHiddenInput = document.getElementById('OTP');
            const otpCode = otpHiddenInput?.value || '';
            const otpError = document.getElementById('otpError');
            const otpSuccess = document.getElementById('otpSuccess');
            const btnActivate = document.getElementById('btnActivate');
            const btnActivateText = document.getElementById('btnActivateText');
            const btnActivateLoader = document.getElementById('btnActivateLoader');
            
            if (!otpCode || otpCode.length !== 6) {
                if (otpError) {
                    otpError.textContent = 'Vui lòng nhập đầy đủ mã OTP 6 số.';
                    otpError.style.display = 'block';
                }
                return;
            }
            
            if (otpError) otpError.style.display = 'none';
            if (otpSuccess) otpSuccess.style.display = 'none';
            
            if (btnActivate) {
                btnActivate.disabled = true;
                if (btnActivateText) btnActivateText.style.display = 'none';
                if (btnActivateLoader) btnActivateLoader.style.display = 'inline';
            }
            
            // Submit form
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.submit();
            }
        }
    </script>
}

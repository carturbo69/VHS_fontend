@model VHS_frontend.Areas.Provider.Models.Profile.ProviderProfileUpdateDTO
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Ch·ªânh s·ª≠a Profile";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
}
@using VHS_frontend.Helpers

@section Styles {
    <link rel="stylesheet" href="~/css/provider-profile-edit.css" asp-append-version="true" />
}

<div class="provider-profile">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-9">
                <!-- Header Section -->
                <div class="profile-edit-header">
                    <div class="header-icon">
                        <i class="bi bi-pencil-square"></i>
                    </div>
                    <div class="header-content">
                        <h1 class="header-title">Ch·ªânh s·ª≠a Profile Provider</h1>
                        <p class="header-subtitle">C·∫≠p nh·∫≠t th√¥ng tin v√† ·∫£nh ƒë·∫°i di·ªán c·ªßa b·∫°n</p>
                    </div>
                    </div>

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                            @TempData["Error"]
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        @TempData["Success"]
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                <!-- Edit Form Card -->
                <div class="edit-form-card">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label asp-for="ProviderName" class="form-label">
                                        <i class="bi bi-building"></i>
                                        T√™n nh√† cung c·∫•p <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="ProviderName" class="form-control" placeholder="Nh·∫≠p t√™n nh√† cung c·∫•p" />
                                    <span asp-validation-for="ProviderName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label asp-for="PhoneNumber" class="form-label">
                                        <i class="bi bi-telephone"></i>
                                        S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="PhoneNumber" class="form-control" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i (v√≠ d·ª•: 0912345678 ho·∫∑c +84912345678)" maxlength="15" />
                                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-4">
                                    <label asp-for="Description" class="form-label">
                                        <i class="bi bi-file-text"></i>
                                        M√¥ t·∫£ d·ªãch v·ª• <span class="text-danger">*</span>
                                    </label>
                                    <textarea asp-for="Description" class="form-control" rows="5" placeholder="Nh·∫≠p m√¥ t·∫£ v·ªÅ d·ªãch v·ª• c·ªßa b·∫°n..."></textarea>
                                    <span asp-validation-for="Description" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-4">
                                    <label for="ImageFile" class="form-label">
                                        <i class="bi bi-image"></i>
                                        ·∫¢nh ƒë·∫°i di·ªán
                                    </label>
                                    
                                    <div class="avatar-upload-section">
                                        <!-- Avatar Upload UI -->
                                        @{
                                            var currentImageUrl = !string.IsNullOrEmpty(Model.Images) 
                                                ? ImageHelper.GetImageUrl(Model.Images, Configuration) 
                                                : string.Empty;
                                        }
                                        
                                        @if (string.IsNullOrEmpty(currentImageUrl))
                                        {
                                            <!-- Placeholder khi ch∆∞a c√≥ ·∫£nh -->
                                            <button type="button" id="avatarPlaceholder" class="avatar-tile" aria-label="Ch·ªçn ·∫£nh t·ª´ t·ªáp">
                                                <div class="tile-icon">üì∑</div>
                                                <div class="tile-text">Ch·ªçn t·ª´ t·ªáp</div>
                                            </button>
                                        }
                                        
                                        <div id="avatarPreviewWrap" class="avatar-wrap @(string.IsNullOrEmpty(currentImageUrl) ? "d-none" : "")">
                                            <div class="avatar-img-wrap">
                                                <img id="imgPreview" class="avatar-img" alt="·∫¢nh ƒë·∫°i di·ªán" 
                                                     src="@(string.IsNullOrEmpty(currentImageUrl) ? "/images/placeholder-avatar.png" : currentImageUrl)" 
                                                     onerror="this.src='/images/placeholder-avatar.png'" />
                                                <button type="button" id="avatarOverlay" class="avatar-overlay" title="X√≥a ·∫£nh">
                                                    <span class="overlay-x">√ó</span>
                                                </button>
                                            </div>
                                            
                                            <div class="file-row">
                                                <input type="file" asp-for="ImageFile" id="ImageFile" name="ImageFile" accept="image/*" class="file-input" />
                                                <div class="file-actions">
                                                    <span id="fileName" class="file-name">@(string.IsNullOrEmpty(currentImageUrl) ? "Ch∆∞a ch·ªçn t·ªáp" : "·∫¢nh hi·ªán t·∫°i")</span>
                                                    <label for="ImageFile" class="btn ghost">Ch·ªçn t·ªáp kh√°c</label>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    
                                    <!-- Hidden field ƒë·ªÉ l∆∞u URL h√¨nh ·∫£nh hi·ªán t·∫°i -->
                                    <input asp-for="Images" type="hidden" id="Images" value="@Model.Images" />
                                    
                                    <span asp-validation-for="ImageFile" class="text-danger"></span>
                                    <div class="field-error text-danger small d-none mt-1" id="imageError"></div>
                                    <div class="form-text">Ch·ªçn file h√¨nh ·∫£nh t·ª´ m√°y t√≠nh (JPG, PNG, GIF - t·ªëi ƒëa 5MB)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">
                                <i class="bi bi-check-circle"></i>
                                <span>C·∫≠p nh·∫≠t Profile</span>
                                </button>
                            <a href="@Url.Action("Index", "ProviderProfile")" class="btn-cancel">
                                <i class="bi bi-arrow-left"></i>
                                <span>Quay l·∫°i</span>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function() {
            // ===== Avatar Upload =====
            const fileInput = document.getElementById("ImageFile");
            const placeholder = document.getElementById("avatarPlaceholder");
            const previewWrap = document.getElementById("avatarPreviewWrap");
            const img = document.getElementById("imgPreview");
            const fileNameEl = document.getElementById("fileName");
            const overlayBtn = document.getElementById("avatarOverlay");
            const imagesInput = document.getElementById("Images");
            const imageError = document.getElementById("imageError");

            // Click placeholder ƒë·ªÉ ch·ªçn file
            if (placeholder) {
                placeholder.addEventListener("click", () => fileInput?.click());
            }

            // X·ª≠ l√Ω khi ch·ªçn file
            fileInput?.addEventListener("change", function(e) {
                const f = e.target.files?.[0];
                if (!f) return;

                // Validate file
                if (!f.type.startsWith("image/")) {
                    showImageError("·∫¢nh ƒë·∫°i di·ªán kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh.");
                    fileInput.value = "";
                            return;
                        }

                        // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (5MB)
                if (f.size > 5 * 1024 * 1024) {
                    showImageError("File kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB.");
                    fileInput.value = "";
                            return;
                        }

                        // Hi·ªÉn th·ªã preview
                const objectUrl = URL.createObjectURL(f);
                img.src = objectUrl;
                if (fileNameEl) fileNameEl.textContent = f.name;
                
                // ·∫®n placeholder, hi·ªán preview
                if (placeholder) placeholder.classList.add("d-none");
                if (previewWrap) previewWrap.classList.remove("d-none");
                
                // X√≥a error state
                clearImageError();
                if (placeholder) placeholder.classList.remove('is-invalid');
            });

            // X√≥a ·∫£nh ƒë√£ ch·ªçn
            if (overlayBtn) {
                overlayBtn.addEventListener("click", function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    if (fileInput) fileInput.value = "";
                    
                    // Reset v·ªÅ ·∫£nh c≈© n·∫øu c√≥
                    const currentImageUrl = imagesInput?.value || "";
                    if (currentImageUrl && img) {
                        img.src = currentImageUrl;
                        if (previewWrap) previewWrap.classList.remove("d-none");
                        if (placeholder) placeholder.classList.add("d-none");
                        if (fileNameEl) fileNameEl.textContent = "·∫¢nh hi·ªán t·∫°i";
                            } else {
                        if (previewWrap) previewWrap.classList.add("d-none");
                        if (placeholder) placeholder.classList.remove("d-none");
                        if (fileNameEl) fileNameEl.textContent = "Ch∆∞a ch·ªçn t·ªáp";
                        img.src = '/images/placeholder-avatar.png';
                    }
                    
                    clearImageError();
                });
            }

            // Helper functions
            function showImageError(message) {
                if (imageError) {
                    imageError.textContent = message;
                    imageError.classList.remove('d-none');
                }
            }

            function clearImageError() {
                if (imageError) {
                    imageError.textContent = "";
                    imageError.classList.add('d-none');
                }
            }

            // Clear error khi ch·ªçn file l·∫°i
            fileInput?.addEventListener('change', clearImageError);

            // ===== Form Validation =====
            const form = document.querySelector('form[method="post"]');
            const providerNameInput = document.getElementById('ProviderName');
            const phoneNumberInput = document.getElementById('PhoneNumber');
            const descriptionInput = document.getElementById('Description');

            // Helper function ƒë·ªÉ hi·ªÉn th·ªã l·ªói
            function showFieldError(input, message) {
                if (!input) return;
                
                // X√≥a class valid n·∫øu c√≥
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                
                // T√¨m ho·∫∑c t·∫°o error element
                let errorSpan = input.parentElement.querySelector('.text-danger');
                if (!errorSpan) {
                    errorSpan = document.createElement('span');
                    errorSpan.className = 'text-danger';
                    errorSpan.setAttribute('asp-validation-for', input.name);
                    input.parentElement.appendChild(errorSpan);
                }
                errorSpan.textContent = message;
            }

            // Helper function ƒë·ªÉ x√≥a l·ªói
            function clearFieldError(input) {
                if (!input) return;
                input.classList.remove('is-invalid');
                const errorSpan = input.parentElement.querySelector('.text-danger');
                if (errorSpan && errorSpan.getAttribute('asp-validation-for')) {
                    errorSpan.textContent = '';
                }
            }

            // Validate ProviderName
            function validateProviderName(value) {
                const trimmed = value?.trim() || '';
                if (trimmed === '') {
                    showFieldError(providerNameInput, 'T√™n nh√† cung c·∫•p kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
                    return false;
                }
                if (trimmed.length > 100) {
                    showFieldError(providerNameInput, 'T√™n nh√† cung c·∫•p kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 100 k√Ω t·ª±');
                    return false;
                }
                clearFieldError(providerNameInput);
                providerNameInput.classList.add('is-valid');
                return true;
            }

            // Validate PhoneNumber
            function validatePhoneNumber(value) {
                const trimmed = value?.trim() || '';
                if (trimmed === '') {
                    showFieldError(phoneNumberInput, 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
                    return false;
                }
                
                // Format: 
                // - 0xxxxxxxxx (10 s·ªë) - v√≠ d·ª•: 0912345678
                // - 0xxxxxxxxxx (11 s·ªë) - v√≠ d·ª•: 01234567890
                // - +84xxxxxxxxx (12 k√Ω t·ª±) - v√≠ d·ª•: +84912345678
                // - +84xxxxxxxxxx (13 k√Ω t·ª±) - v√≠ d·ª•: +841234567890
                const phoneRegex = /^(0[0-9]{9,10}|\+84[0-9]{9,10})$/;
                if (!phoneRegex.test(trimmed)) {
                    showFieldError(phoneNumberInput, 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i 10-11 ch·ªØ s·ªë (b·∫Øt ƒë·∫ßu b·∫±ng 0 ho·∫∑c +84)');
                    return false;
                }
                
                if (trimmed.length > 15) {
                    showFieldError(phoneNumberInput, 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 15 k√Ω t·ª±');
                    return false;
                }
                
                clearFieldError(phoneNumberInput);
                phoneNumberInput.classList.add('is-valid');
                return true;
            }

            // Validate Description
            function validateDescription(value) {
                const trimmed = value?.trim() || '';
                if (trimmed === '') {
                    showFieldError(descriptionInput, 'M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
                    return false;
                }
                if (trimmed.length > 500) {
                    showFieldError(descriptionInput, 'M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 500 k√Ω t·ª±');
                    return false;
                }
                clearFieldError(descriptionInput);
                descriptionInput.classList.add('is-valid');
                return true;
            }

            // Real-time validation cho ProviderName
            if (providerNameInput) {
                providerNameInput.addEventListener('blur', function() {
                    validateProviderName(this.value);
                });
                providerNameInput.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateProviderName(this.value);
                    }
                });
            }

            // Real-time validation cho PhoneNumber
            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('blur', function() {
                    validatePhoneNumber(this.value);
                });
                phoneNumberInput.addEventListener('input', function() {
                    // Ch·ªâ cho ph√©p s·ªë, d·∫•u + v√† kho·∫£ng tr·∫Øng (s·∫Ω x√≥a kho·∫£ng tr·∫Øng)
                    this.value = this.value.replace(/[^\d+]/g, '');
                    if (this.classList.contains('is-invalid')) {
                        validatePhoneNumber(this.value);
                    }
                });
            }

            // Real-time validation cho Description
            if (descriptionInput) {
                descriptionInput.addEventListener('blur', function() {
                    validateDescription(this.value);
                });
                descriptionInput.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateDescription(this.value);
                    }
                });
            }

            // Form submit validation
            if (form) {
                form.addEventListener('submit', function(e) {
                    let isValid = true;

                    // Validate t·∫•t c·∫£ c√°c tr∆∞·ªùng
                    if (!validateProviderName(providerNameInput?.value)) {
                        isValid = false;
                    }
                    if (!validatePhoneNumber(phoneNumberInput?.value)) {
                        isValid = false;
                    }
                    if (!validateDescription(descriptionInput?.value)) {
                        isValid = false;
                    }

                    if (!isValid) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Scroll ƒë·∫øn tr∆∞·ªùng ƒë·∫ßu ti√™n c√≥ l·ªói
                        const firstError = form.querySelector('.is-invalid');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstError.focus();
                        }
                        
                        return false;
                    }
                });
            }
        })();
    </script>
}
@using VHS_frontend.Areas.Provider.Models.ChatDTOs
@using Microsoft.AspNetCore.Html

@model ChatPageVm

@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "Chat";
    var me = Model.CurrentAccount?.AccountId ?? Guid.Empty;

    var selected = Model.SelectedConversation;
    var hasSelection = selected != null;

    MessageAccountDto? otherInSelected = null;
    if (hasSelection)
    {
        otherInSelected = (selected!.ParticipantA?.AccountId == me ? selected.ParticipantB : selected.ParticipantA);
    }

    var fallbackImg = Url.Content("~/images/vhs_logo.png");

    // Helper function để xử lý ImageUrl trong tin nhắn (giống ServiceShop/Index.cshtml)
    // Backend đã tự động thêm domain prefix, nên chỉ cần dùng trực tiếp
    string GetMessageImageUrl(MessageDto message)
    {
        // Giống như ServiceShop: dùng trực tiếp ImageUrl, backend đã xử lý domain rồi
        if (string.IsNullOrWhiteSpace(message.ImageUrl)) return fallbackImg;
        return message.ImageUrl.Trim();
    }

    // ===== Map hỗ trợ hiển thị trích dẫn tin gốc (reply) =====
    Func<MessageDto, string> SnippetOf = (MessageDto m) =>
    {
        if (m == null) return "(Không có nội dung)";
        // DECODE trước khi cắt
        var bodyDecoded = string.IsNullOrWhiteSpace(m.Body) ? "" : System.Net.WebUtility.HtmlDecode(m.Body);
        if (!string.IsNullOrWhiteSpace(bodyDecoded))
            return bodyDecoded.Length > 140 ? bodyDecoded.Substring(0, 140) + "…" : bodyDecoded;
        if (!string.IsNullOrWhiteSpace(m.ImageUrl)) return "[Ảnh]";
        return "(Không có nội dung)";
    };
    var msgMap = hasSelection && selected?.Messages != null
        ? selected.Messages.ToDictionary(x => x.MessageId)
        : new Dictionary<Guid, MessageDto>();
}

@functions {
    private static TimeZoneInfo GetVnTz()
    {
        try
        {
            var tzId = Environment.OSVersion.Platform == PlatformID.Win32NT
                ? "SE Asia Standard Time"
                : "Asia/Ho_Chi_Minh";
            return TimeZoneInfo.FindSystemTimeZoneById(tzId);
        }
        catch
        {
            // fallback +07:00 nếu máy chủ không có TZ
            return TimeZoneInfo.CreateCustomTimeZone("VN_Fallback", TimeSpan.FromHours(7), "VN", "VN");
        }
    }

    public static DateTime ToVnLocal(DateTime utc)
    {
        // nếu utc không phải UTC, coi như UTC để tránh lệch
        var dtUtc = DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        return TimeZoneInfo.ConvertTimeFromUtc(dtUtc, GetVnTz());
    }
    
    public static string ToVnHHmm(DateTime? utc)
        => utc.HasValue ? ToVnLocal(utc.Value).ToString("HH:mm") : "";

    // Hàm format thời gian thông minh cho chat (đồng bộ giữa message list và conversation list)
    private static string FormatChatTime(DateTime utc)
    {
        var fixedUtc = utc.Kind == DateTimeKind.Utc ? utc : DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        var vn = TimeZoneInfo.ConvertTimeFromUtc(fixedUtc, GetVnTz());
        var now = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, GetVnTz());
        
        // Cùng ngày: chỉ hiển thị giờ
        if (vn.Date == now.Date)
        {
            return vn.ToString("HH:mm");
        }
        
        // Hôm qua
        if (vn.Date == now.Date.AddDays(-1))
        {
            return "Hôm qua " + vn.ToString("HH:mm");
        }
        
        // Trong 7 ngày gần đây: hiển thị thứ và giờ
        if ((now.Date - vn.Date).TotalDays <= 7)
        {
            var dayOfWeek = vn.DayOfWeek switch
            {
                DayOfWeek.Monday => "Thứ 2",
                DayOfWeek.Tuesday => "Thứ 3",
                DayOfWeek.Wednesday => "Thứ 4",
                DayOfWeek.Thursday => "Thứ 5",
                DayOfWeek.Friday => "Thứ 6",
                DayOfWeek.Saturday => "Thứ 7",
                DayOfWeek.Sunday => "CN",
                _ => ""
            };
            return dayOfWeek + " " + vn.ToString("HH:mm");
        }
        
        // Trong cùng năm: hiển thị ngày/tháng và giờ
        if (vn.Year == now.Year)
        {
            return vn.ToString("dd/MM HH:mm");
        }
        
        // Khác năm: hiển thị đầy đủ
        return vn.ToString("dd/MM/yyyy HH:mm");
    }

    // Overload cho DateTimeOffset
    private static string FormatChatTime(DateTimeOffset dto) => FormatChatTime(dto.UtcDateTime);
    
    // Overload cho DateTime? (nullable)
    private static string FormatChatTime(DateTime? utc)
    {
        if (!utc.HasValue) return "";
        return FormatChatTime(utc.Value);
    }

    // Helper hiển thị trạng thái
    public static Microsoft.AspNetCore.Html.IHtmlContent RenderStatus(MessageStatus status)
    {
        string icon = status switch
        {
            MessageStatus.Pending => "<i class=\"bi bi-clock-history\"></i>",
            MessageStatus.Sent => "<i class=\"bi bi-check\"></i>",
            MessageStatus.Delivered => "<i class=\"bi bi-check2-all\"></i>",
            MessageStatus.Seen => "<i class=\"bi bi-check2-all\"></i>",
            _ => ""
        };
        string text = status switch
        {
            MessageStatus.Pending => "Đang gửi",
            MessageStatus.Sent => "Đã gửi",
            MessageStatus.Delivered => "Đã nhận",
            MessageStatus.Seen => "Đã xem",
            _ => ""
        };
        return new Microsoft.AspNetCore.Html.HtmlString(
            $"<span class=\"msg-status\" data-status=\"{status}\">{icon}<span class=\"status-text\">{text}</span></span>"
        );
    }
}

<link rel="stylesheet" href="~/css/chat-provider.css" asp-append-version="true" />

<div class="chat-wrapper">
    <div class="chat-grid">
        <!-- Sidebar -->
        <aside class="chat-sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <span class="search-icon"><i class="bi bi-search"></i></span>
                    <input type="text" class="search-input" placeholder="Tìm theo tên hoặc nội dung…" />
                </div>
            </div>

            <div class="conversations-header">
                <div class="conversations-title">
                    <i class="bi bi-chat-dots"></i>
                    <span>Tất cả cuộc trò chuyện</span>
                </div>
                <span class="conversations-count">@Model.Conversations.Count</span>
            </div>

            <div class="chat-with-admin-section">
                <form method="post" action='@Url.Action("StartWithAdmin", "ChatProvider", new { area = "Provider" })'>
                    @Html.AntiForgeryToken()
                    <button type="submit" class="chat-admin-btn">
                        <i class="bi bi-headset"></i>
                        <span>Chat với Admin</span>
                    </button>
                </form>
            </div>

            <div class="chat-scroll px-2" id="conversationList">
                @foreach (var c in Model.Conversations
                                .OrderByDescending(x => x.IsPinned)
                                .ThenByDescending(x => x.LastMessageAt))
                {
                    var isActive = c.ConversationId == Model.SelectedConversationId;

                    string? avatarUrlToUse = null;
                    if (!string.IsNullOrWhiteSpace(c.AvatarUrl))
                    {
                        avatarUrlToUse = c.AvatarUrl;
                    }
                    else if (isActive && hasSelection && otherInSelected != null && !string.IsNullOrWhiteSpace(otherInSelected.AvatarUrl))
                    {
                        avatarUrlToUse = otherInSelected.AvatarUrl;
                    }

                    <a class="d-flex align-items-start gap-2 p-2 rounded conv-item @(isActive ? "bg-light" : "")"
                       href="@Url.Action("Index", "ChatProvider", new { area = "Provider", id = c.ConversationId })"
                       data-search-title="@(c.Title?.ToLower() ?? "")"
                       data-search-snippet="@(c.LastMessageSnippet?.ToLower() ?? "")"
                       data-conversation-id="@c.ConversationId"
                       data-avatar-url="@(avatarUrlToUse ?? "")"
                       data-conversation-url="@Url.Action("Index", "ChatProvider", new { area = "Provider", id = c.ConversationId })">

                        <img class="avatar"
                             src="@(avatarUrlToUse ?? fallbackImg)"
                             alt=""
                             loading="lazy"
                             decoding="async"
                             referrerpolicy="no-referrer"
                             onerror="this.onerror=null;this.src='@fallbackImg';" />

                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="conv-header">
                                    <div class="conv-title">@c.Title</div>
                                </div>
                                <div class="d-flex flex-column align-items-end gap-1 ms-2">
                                    <div class="conv-time">@(c.LastMessageAt.HasValue ? FormatChatTime(c.LastMessageAt.Value) : "")</div>
                                    @if (c.UnreadCount > 0)
                                    {
                                        <span class="badge rounded-pill bg-danger conv-unread">@c.UnreadCount</span>
                                    }
                                </div>
                            </div>
                            <div class="small text-muted text-ellipsis-1 conv-snippet">@c.LastMessageSnippet</div>
                        </div>
                    </a>
                }
            </div>

        </aside>

        <!-- Khung chat -->
        @if (!hasSelection)
        {
            <!-- Chưa chọn hội thoại: panel phải trắng, không header, không nội dung, không ô soạn -->
            <main class="chat-main empty"></main>
        }
        else
        {
            <!-- Đã chọn hội thoại: hiển thị đầy đủ -->
            <main class="chat-main" data-selected-conv="@Model.SelectedConversationId">
                <!-- Header -->
                <div class="chat-header">
                    <!-- Nút Quay lại (chỉ hiện trên mobile) -->
                    <button type="button" class="chat-back-btn" id="chatBackBtn" title="Quay lại danh sách">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    
                    <img class="avatar"
                         src="@(otherInSelected?.AvatarUrl ?? fallbackImg)"
                         alt=""
                         loading="lazy"
                         decoding="async"
                         referrerpolicy="no-referrer"
                         onerror="this.onerror=null;this.src='@fallbackImg';" />

                    <div class="chat-header-info">
                        <div class="chat-header-name">
                            @(otherInSelected?.AccountName ?? selected!.Title ?? "Đối tác")
                        </div>
                    </div>

                    <!-- Nút 3 chấm ở góc phải -->
                    <div class="chat-header-menu">
                        <button type="button"
                                class="menu-toggle-btn"
                                id="headerMenuBtn"
                                aria-expanded="false"
                                title="Tùy chọn">
                            <i class="bi bi-three-dots"></i>
                        </button>

                        <div class="dropdown-menu hidden" id="headerMenu">
                            <form method="post"
                                  action='@Url.Action("DeleteConversation", "ChatProvider", new { area = "Provider", id = Model.SelectedConversationId, hide = true })'>
                                @Html.AntiForgeryToken()
                                <button type="submit" class="dropdown-item delete-item">Xóa cuộc trò chuyện</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Danh sách tin nhắn -->
                <div id="msgList" class="msg-list">
                    @if (selected?.Messages?.Count > 0)
                    {
                        foreach (var m in selected.Messages.OrderBy(x => x.CreatedAt))
                        {
                            var isMe = m.SenderAccountId == me;
                            var createdIso = m.CreatedAt.ToUniversalTime().ToString("o");

                            var senderName = isMe ? "Bạn" : (otherInSelected?.AccountName ?? "Đối tác");
                            var snippetThis = SnippetOf(m);

                            <div class="msg-wrapper @(isMe ? "msg-me" : "msg-other")">
                                <div class="bubble @(isMe ? "me" : "other")"
                                     data-message-id="@m.MessageId"
                                     data-created-at="@createdIso"
                                     data-is-mine="@(isMe ? "true" : "false")"
                                     data-status="@m.Status"
                                     data-sender-name="@senderName"
                                     data-snippet="@snippetThis">

                                    @* Nếu là reply, hiển thị tham chiếu tin gốc *@
                                    @if (m.ReplyToMessageId != null && msgMap.TryGetValue(m.ReplyToMessageId.Value, out var parent))
                                    {
                                        var parentName = parent.SenderAccountId == me ? "Bạn" : (otherInSelected?.AccountName ?? "Người kia");
                                        <div class="reply-ref">
                                            <div class="reply-ref-name">@parentName</div>
                                            <div class="reply-ref-text">@SnippetOf(parent)</div>
                                        </div>
                                    }

                                    @* Nội dung *@
                                    @{
                                        var decodedBody = string.IsNullOrWhiteSpace(m.Body) ? "" : System.Net.WebUtility.HtmlDecode(m.Body);
                                    }
                                    @if (!string.IsNullOrWhiteSpace(decodedBody))
                                    {
                                        <div class="msg-body">@decodedBody</div>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(m.ImageUrl))
                                    {
                                        <img src="@m.ImageUrl"
                                             class="msg-image"
                                             loading="lazy"
                                             decoding="async"
                                             referrerpolicy="no-referrer"
                                             onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    }

                                    <div class="msg-meta">
                                        <button type="button" class="reply-btn" title="Trả lời">
                                            <i class="bi bi-reply"></i> <span class="reply-text">Reply</span>
                                        </button>
                                        <span class="msg-time">@FormatChatTime(m.CreatedAt)</span>

                                        @if (isMe)
                                        {
                                            @RenderStatus(m.Status)
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    @* KHÔNG else: đã bỏ empty-state + quick replies *@
                </div>

                <!-- Ô soạn tin -->
                <div class="msg-input">
                    <form method="post"
                          action='@Url.Action("Send", "ChatProvider", new { area = "Provider" })'
                          class="msg-form"
                          enctype="multipart/form-data">

                        @Html.AntiForgeryToken()
                        <input type="hidden" name="conversationId" value="@Model.SelectedConversationId" />
                        <!-- ===== Hidden + pill hiển thị đang trả lời ===== -->
                        <input type="hidden" name="replyToMessageId" id="replyToMessageId" value="" />
                        <div id="replyPreview" class="replying-pill hidden">
                            <i class="bi bi-reply"></i>
                            <div class="replying-content">
                                <div class="replying-name" id="replyingToName"></div>
                                <div class="replying-snippet" id="replyingSnippet"></div>
                            </div>
                            <button type="button" id="cancelReplyBtn" class="cancel-reply-btn">Hủy</button>
                        </div>

                        <div id="attachPreview" class="attach-preview hidden">
                            <div class="attach-preview-box">
                                <div class="attach-thumb-wrapper">
                                    <img id="attachThumb"
                                         src=""
                                         alt="Xem trước"
                                         class="attach-thumb"
                                         onerror="this.onerror=null;this.src='@fallbackImg';" />
                                    <button type="button" id="removeAttachBtn" class="remove-attach-btn" title="Xóa ảnh">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="msg-input-row">
                            <input type="text"
                                   name="body"
                                   class="msg-input-field"
                                   placeholder="Nhập tin nhắn…"
                                   autocomplete="off" />

                            <input type="file"
                                   id="fileInput"
                                   name="image"
                                   class="file-input-hidden"
                                   accept="image/*" />

                            <button type="button"
                                    id="pickFileBtn"
                                    class="attach-btn"
                                    title="Đính kèm ảnh">
                                <i class="bi bi-paperclip"></i>
                            </button>

                            <button type="submit" class="send-btn">
                                Gửi
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        }
    </div>
</div>


@section Scripts {
    @* Hệ thống quản lý avatar trong conversation list (sử dụng sessionStorage) *@
    <script>
        (function() {
            try {
                var fallbackImg = '@fallbackImg';
                var STORAGE_KEY = 'chat_avatars_provider';

                // Khởi tạo storage nếu chưa có
                function initStorage() {
                    if (!sessionStorage.getItem(STORAGE_KEY)) {
                        sessionStorage.setItem(STORAGE_KEY, JSON.stringify({}));
                    }
                }

                // Lấy avatar từ storage
                function getAvatarFromStorage(convId) {
                    try {
                        var storage = JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '{}');
                        return storage[convId] || null;
                    } catch (e) {
                        return null;
                    }
                }

                // Lưu avatar vào storage
                function saveAvatarToStorage(convId, avatarUrl) {
                    try {
                        initStorage();
                        var storage = JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '{}');
                        if (avatarUrl && avatarUrl.trim()) {
                            storage[convId] = avatarUrl;
                            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
                            return true;
                        }
                    } catch (e) {
                        console.warn('Failed to save avatar to storage:', e);
                    }
                    return false;
                }

                // Cập nhật avatar trong conversation item
                function updateAvatarInListItem(convItem, avatarUrl) {
                    if (!convItem || !avatarUrl) return;

                    var avatarImg = convItem.querySelector('.avatar');
                    if (!avatarImg) return;

                    var currentSrc = avatarImg.getAttribute('src') || '';
                    var isFallback = !currentSrc || currentSrc === fallbackImg || currentSrc.indexOf('vhs_logo.png') > -1;

                    // Cập nhật nếu đang hiển thị fallback hoặc URL khác
                    if (isFallback || (currentSrc && currentSrc !== avatarUrl && !currentSrc.includes(avatarUrl.split('?')[0]))) {
                        var separator = avatarUrl.indexOf('?') > -1 ? '&' : '?';
                        avatarImg.src = avatarUrl + separator + 't=' + new Date().getTime();
                        // Cập nhật data-avatar-url attribute
                        convItem.setAttribute('data-avatar-url', avatarUrl);
                    }
                }

                // Áp dụng avatar từ storage cho tất cả conversations
                function applyStoredAvatars() {
                    var convItems = document.querySelectorAll('.conv-item[data-conversation-id]');
                    convItems.forEach(function(convItem) {
                        var convId = convItem.getAttribute('data-conversation-id');
                        if (convId) {
                            var storedAvatar = getAvatarFromStorage(convId);
                            if (storedAvatar) {
                                updateAvatarInListItem(convItem, storedAvatar);
                            }
                        }
                    });
                }

                // Khởi tạo
                initStorage();

                // Áp dụng avatar từ storage ngay khi trang load
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', applyStoredAvatars);
                } else {
                    applyStoredAvatars();
                }

                // Lưu hàm vào window để sử dụng từ các script khác
                window.chatAvatarManager = {
                    save: saveAvatarToStorage,
                    get: getAvatarFromStorage,
                    update: updateAvatarInListItem,
                    applyAll: applyStoredAvatars
                };
            } catch (e) {
                console.warn('Failed to initialize avatar manager:', e);
            }
        })();
    </script>

    @* Lưu avatar từ selected conversation vào storage *@
    @if (hasSelection && otherInSelected != null && Model.SelectedConversationId.HasValue && !string.IsNullOrWhiteSpace(otherInSelected.AvatarUrl))
    {
        <script>
            (function() {
                try {
                    var selectedConvId = '@Model.SelectedConversationId.Value';
                    var correctAvatarUrl = '@(Html.Raw(otherInSelected.AvatarUrl?.Replace("'", "\\'").Replace("\"", "&quot;") ?? ""))';

                    if (selectedConvId && correctAvatarUrl && window.chatAvatarManager) {
                        // Lưu vào storage
                        window.chatAvatarManager.save(selectedConvId, correctAvatarUrl);

                        // Cập nhật ngay trong list
                        var selectedConvItem = document.querySelector('.conv-item[data-conversation-id="' + selectedConvId + '"]');
                        if (selectedConvItem) {
                            window.chatAvatarManager.update(selectedConvItem, correctAvatarUrl);
                        }

                        // Áp dụng lại cho tất cả conversations (để đảm bảo)
                        setTimeout(function() {
                            window.chatAvatarManager.applyAll();
                        }, 100);
                    }
                } catch (e) {
                    console.warn('Failed to save avatar from selected conversation:', e);
                }
            })();
        </script>
    }

    @* Mobile toggle functions *@
    <script>
        // Functions để toggle giữa conversation list và chat view trên mobile
        window.showConversationList = function() {
            var sidebar = document.querySelector('.chat-sidebar');
            var chatMain = document.querySelector('.chat-main');
            var chatWrapper = document.querySelector('.chat-wrapper');
            
            if (sidebar && chatMain && chatWrapper) {
                sidebar.classList.add('show');
                chatMain.style.display = 'none';
                chatWrapper.classList.remove('show-chat');
            }
        };
        
        window.showChatView = function() {
            var sidebar = document.querySelector('.chat-sidebar');
            var chatMain = document.querySelector('.chat-main');
            var chatWrapper = document.querySelector('.chat-wrapper');
            
            if (sidebar && chatMain && chatWrapper) {
                sidebar.classList.remove('show');
                chatMain.style.display = 'flex';
                chatWrapper.classList.add('show-chat');
            }
        };
        
        // Event listener cho nút Quay lại - sử dụng event delegation để hoạt động với dynamic content
        document.addEventListener('click', function(e) {
            var backBtn = e.target.closest('#chatBackBtn');
            if (backBtn) {
                e.preventDefault();
                e.stopPropagation();
                window.showConversationList();
            }
        });
    </script>

    @* Ngăn reload khi click vào conversation và load qua AJAX *@
    <script>
        (function() {
            var isLoading = false;

            // Lắng nghe khi có conversation được click
            document.addEventListener('click', function(e) {
                var convItem = e.target.closest('.conv-item[data-conversation-id]');
                if (!convItem) return;

                // Ngăn navigation mặc định
                e.preventDefault();
                e.stopPropagation();

                // Nếu đang loading, bỏ qua
                if (isLoading) {
                    console.log('[Chat] Already loading, ignoring click');
                    return;
                }

                var convId = convItem.getAttribute('data-conversation-id');
                var convUrl = convItem.getAttribute('data-conversation-url') || convItem.getAttribute('href');
                var avatarUrl = convItem.getAttribute('data-avatar-url');

                if (!convId || !convUrl) {
                    console.warn('[Chat] Missing conversation ID or URL');
                    return;
                }

                // Lưu avatar vào storage nếu có
                if (window.chatAvatarManager && avatarUrl && avatarUrl.trim()) {
                    window.chatAvatarManager.save(convId, avatarUrl);
                }

                // Cập nhật active state trong sidebar
                document.querySelectorAll('.conv-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                convItem.classList.add('active');

                // Ẩn unread badge
                var unreadBadge = convItem.querySelector('.unread-badge');
                if (unreadBadge) {
                    unreadBadge.style.display = 'none';
                    unreadBadge.remove();
                }

                // Load conversation qua AJAX
                isLoading = true;
                var chatMain = document.querySelector('.chat-main');

                // Hiển thị loading state
                if (chatMain) {
                    chatMain.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><div style="text-align: center;"><div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div><div style="margin-top: 1rem;">Đang tải cuộc trò chuyện...</div></div></div>';
                }

                // Fetch conversation mới
                fetch(convUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'text/html'
                    },
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.text();
                })
                .then(function(html) {
                    // Parse HTML response
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');

                    // Extract chat-main từ response
                    var newChatMain = doc.querySelector('.chat-main');
                    if (newChatMain && chatMain) {
                        // Update chat-main content (không include scripts để tránh duplicate execution)
                        chatMain.outerHTML = newChatMain.outerHTML;

                        // Update URL với History API (không reload)
                        if (window.history && window.history.pushState) {
                            window.history.pushState({ conversationId: convId }, '', convUrl);
                        }
                        
                        // Trên mobile: hiển thị chat view và ẩn sidebar
                        if (window.innerWidth <= 767.98) {
                            window.showChatView();
                        }

                        // Re-init SignalR sau khi scripts đã execute
                        if (window.__initProviderChatRealtime) {
                            setTimeout(function() {
                                window.__initProviderChatRealtime();
                            }, 200);
                        }

                        // Re-init các event handlers
                        setTimeout(function() {
                            // File attach preview
                            var pickBtn = document.getElementById('pickFileBtn');
                            var fileInput = document.getElementById('fileInput');
                            var previewWrap = document.getElementById('attachPreview');
                            var imgEl = document.getElementById('attachThumb');
                            var removeBtn = document.getElementById('removeAttachBtn');
                            var objectUrl = null;

                            if (pickBtn && fileInput) {
                                pickBtn.addEventListener('click', function() { fileInput.click(); });

                                fileInput.addEventListener('change', function() {
                                    if (objectUrl) { URL.revokeObjectURL(objectUrl); objectUrl = null; }

                                    if (fileInput.files && fileInput.files.length > 0) {
                                        var f = fileInput.files[0];
                                        if (!f.type || !f.type.startsWith('image/')) {
                                            alert('Vui lòng chọn file ảnh.');
                                            fileInput.value = '';
                                            if (previewWrap) previewWrap.classList.add('hidden');
                                            return;
                                        }
                                        objectUrl = URL.createObjectURL(f);
                                        if (imgEl) imgEl.src = objectUrl;
                                        if (previewWrap) previewWrap.classList.remove('hidden');
                                    } else {
                                        if (previewWrap) previewWrap.classList.add('hidden');
                                    }
                                });

                                if (removeBtn) {
                                    removeBtn.addEventListener('click', function() {
                                        if (objectUrl) { URL.revokeObjectURL(objectUrl); objectUrl = null; }
                                        if (fileInput) fileInput.value = '';
                                        if (imgEl) imgEl.src = '';
                                        if (previewWrap) previewWrap.classList.add('hidden');
                                    });
                                }
                            }

                            // Reply UI
                            var pageMain = document.querySelector('main.chat-main[data-selected-conv]');
                            if (pageMain) {
                                var form = pageMain.querySelector('form[action*="ChatProvider/Send"]');
                                var bodyInput = form?.querySelector('input[name="body"]');
                                var replyHidden = form?.querySelector('#replyToMessageId');
                                var replyPreview = document.getElementById('replyPreview');
                                var replyingToName = document.getElementById('replyingToName');
                                var replyingSnippet = document.getElementById('replyingSnippet');
                                var cancelReplyBtn = document.getElementById('cancelReplyBtn');

                                function showReplyPreview(id, name, snippet) {
                                    if (!replyHidden || !replyPreview) return;
                                    replyHidden.value = id || '';
                                    if (replyingToName) replyingToName.textContent = name || '—';
                                    if (replyingSnippet) replyingSnippet.textContent = snippet || '';
                                    replyPreview.classList.remove('hidden');
                                    if (bodyInput) bodyInput.focus();
                                }

                                function clearReplyPreview() {
                                    if (replyHidden) replyHidden.value = '';
                                    if (replyingToName) replyingToName.textContent = '';
                                    if (replyingSnippet) replyingSnippet.textContent = '';
                                    if (replyPreview) replyPreview.classList.add('hidden');
                                }

                                if (cancelReplyBtn) {
                                    cancelReplyBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        clearReplyPreview();
                                    });
                                }

                                pageMain.addEventListener('click', function(e) {
                                    var btn = e.target.closest('.reply-btn');
                                    if (!btn) return;
                                    var bubble = btn.closest('.bubble');
                                    if (!bubble) return;

                                    var id = bubble.getAttribute('data-message-id') || '';
                                    var name = bubble.getAttribute('data-sender-name') || '—';
                                    var sn = bubble.getAttribute('data-snippet') || '';

                                    showReplyPreview(id, name, sn);
                                }, {passive: true});
                            }

                            // Menu header toggle
                            var headerMenuBtn = document.getElementById('headerMenuBtn');
                            var headerMenu = document.getElementById('headerMenu');
                            if (headerMenuBtn && headerMenu) {
                                function closeMenu() {
                                    headerMenu.classList.add('hidden');
                                    headerMenuBtn.setAttribute('aria-expanded', 'false');
                                }
                                function openMenu() {
                                    headerMenu.classList.remove('hidden');
                                    headerMenuBtn.setAttribute('aria-expanded', 'true');
                                }

                                headerMenuBtn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (headerMenu.classList.contains('hidden')) {
                                        openMenu();
                                    } else {
                                        closeMenu();
                                    }
                                });

                                headerMenu.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    if (e.target.closest('button[type="submit"]')) {
                                        setTimeout(closeMenu, 100);
                                    }
                                });

                                document.addEventListener('click', function(e) {
                                    if (headerMenu.contains(e.target) || e.target === headerMenuBtn || headerMenuBtn.contains(e.target) || e.target.closest('.dropdown-menu')) {
                                        return;
                                    }
                                    closeMenu();
                                }, { passive: true });

                                document.addEventListener('keydown', function(e) {
                                    if (e.key === 'Escape') closeMenu();
                                });
                            }

                            // Auto-scroll to bottom
                            setTimeout(function() {
                                var msgList = document.getElementById('msgList');
                                if (msgList) {
                                    msgList.scrollTop = msgList.scrollHeight;
                                }
                            }, 100);
                        }, 150);
                    } else {
                        console.error('[Chat] Could not find chat-main in response');
                        // Fallback: reload page
                        window.location.href = convUrl;
                    }
                })
                .catch(function(error) {
                    console.error('[Chat] Error loading conversation:', error);
                    // Fallback: reload page
                    window.location.href = convUrl;
                })
                .finally(function() {
                    isLoading = false;
                });
            }, true); // Use capture phase to intercept early
        })();
    </script>

    @* Auto-scroll khi đã chọn hội thoại *@
    @if (hasSelection)
    {
        <script>
            (function () {
              // Sử dụng setTimeout để đảm bảo DOM đã render xong
              setTimeout(function() {
                var el = document.getElementById('msgList');
                if (el) {
                  el.scrollTop = el.scrollHeight;
                }
              }, 100);

              // Scroll lại sau khi images load xong
              var imgEls = document.querySelectorAll('#msgList img');
              var loadedCount = 0;
              imgEls.forEach(function(img) {
                if (img.complete) {
                  loadedCount++;
                } else {
                  img.addEventListener('load', function() {
                    loadedCount++;
                    if (loadedCount === imgEls.length) {
                      var el = document.getElementById('msgList');
                      if (el) el.scrollTop = el.scrollHeight;
                    }
                  });
                }
              });

              if (loadedCount === imgEls.length && imgEls.length > 0) {
                setTimeout(function() {
              var el = document.getElementById('msgList');
              if (el) el.scrollTop = el.scrollHeight;
                }, 200);
              }
            })();
        </script>
    }

    <script>
        // ===== Ẩn badge unread khi click vào conversation và scroll xuống tin nhắn mới nhất =====
        (function() {
          document.addEventListener('click', function(e) {
            var convItem = e.target.closest('.conv-item');
            if (!convItem) return;

            var unreadBadge = convItem.querySelector('.unread-badge');
            if (unreadBadge) {
              // Ẩn badge ngay lập tức
              unreadBadge.style.display = 'none';
              unreadBadge.remove();
            }

            // Khi click vào conversation, sau khi page load sẽ scroll xuống tin nhắn mới nhất
            // Logic này sẽ được thực hiện trong phần auto-scroll ở trên
          });
        })();

        // ===== Menu header toggle (khởi tạo ngay, không cần SignalR) =====
        (function () {
          var btn = document.getElementById('headerMenuBtn');
          var menu = document.getElementById('headerMenu');
          if (!btn || !menu) return;

          function closeMenu() {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
          }
          function openMenu() {
            menu.classList.remove('hidden');
            btn.setAttribute('aria-expanded', 'true');
          }

          btn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Menu button clicked, current state:', menu.classList.contains('hidden'));
            if (menu.classList.contains('hidden')) {
              openMenu();
              console.log('Menu opened');
            } else {
              closeMenu();
              console.log('Menu closed');
            }
          });

          // Không đóng menu khi click vào menu item hoặc form
          menu.addEventListener('click', function(e){
            e.stopPropagation();
            // Nếu click vào button submit, cho phép form submit nhưng vẫn đóng menu sau
            if (e.target.closest('button[type="submit"]')) {
              setTimeout(function() {
                closeMenu();
              }, 100);
              return;
            }
          });

          document.addEventListener('click', function (e) {
            // Không đóng menu nếu click vào menu, button, hoặc form
            if (menu.contains(e.target) || e.target === btn || btn.contains(e.target) || e.target.closest('.dropdown-menu')) {
              return;
            }
            closeMenu();
          }, { passive: true });

          document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeMenu();
          });
        })();
    </script>

    <script>
        // ===== File attach preview + chặn gửi rỗng =====
        (function () {
          var pickBtn = document.getElementById('pickFileBtn');
          var fileInput = document.getElementById('fileInput');
          var previewWrap = document.getElementById('attachPreview');
          var imgEl = document.getElementById('attachThumb');
          var removeBtn = document.getElementById('removeAttachBtn');
          var objectUrl = null;

          // Form/Inputs
          var form = document.querySelector('form[action*="ChatProvider/Send"]');
          var bodyInput = form?.querySelector('input[name="body"]');
          var sendBtn = form?.querySelector('button[type="submit"]');

          function hasPayload() {
            var hasText = !!(bodyInput && bodyInput.value.trim().length > 0);
            var hasImage = !!(fileInput && fileInput.files && fileInput.files.length > 0);
            return hasText || hasImage;
          }
          function refreshSendState() { if (sendBtn) sendBtn.disabled = !hasPayload(); }

          form?.addEventListener('submit', function (e) {
            if (!hasPayload()) {
              e.preventDefault();
              alert('Vui lòng nhập nội dung hoặc đính kèm ảnh trước khi gửi.');
              bodyInput?.focus();
              return false;
            }
            if (sendBtn) sendBtn.disabled = true; // chặn spam
          });

          bodyInput?.addEventListener('input', refreshSendState);

          if (!pickBtn || !fileInput) return;

          pickBtn.addEventListener('click', function () { fileInput.click(); });

          fileInput.addEventListener('change', function () {
            if (objectUrl) { URL.revokeObjectURL(objectUrl); objectUrl = null; }

            if (fileInput.files && fileInput.files.length > 0) {
              var f = fileInput.files[0];

              if (!f.type || !f.type.startsWith('image/')) {
                alert('Vui lòng chọn file ảnh.');
                fileInput.value = '';
                previewWrap.classList.add('hidden');
                return;
              }

              objectUrl = URL.createObjectURL(f);
              imgEl.src = objectUrl;
              previewWrap.classList.remove('hidden');
            } else {
              previewWrap.classList.add('hidden');
            }
            refreshSendState();
          });

          removeBtn?.addEventListener('click', function () {
            if (objectUrl) { URL.revokeObjectURL(objectUrl); objectUrl = null; }
            fileInput.value = '';
            imgEl.src = '';
            previewWrap.classList.add('hidden');
            refreshSendState();
          });
        })();

        // ===== Reply UI: KHỞI TẠO ĐỘC LẬP KHỎI SIGNALR =====
        (function initReplyUi(){
          var pageMain = document.querySelector('main.chat-main[data-selected-conv]');
          if (!pageMain) return;

          var form = pageMain.querySelector('form[action*="ChatProvider/Send"]');
          var bodyInput = form?.querySelector('input[name="body"]');
          var replyHidden = form?.querySelector('#replyToMessageId');

          var replyPreview = document.getElementById('replyPreview');
          var replyingToName = document.getElementById('replyingToName');
          var replyingSnippet = document.getElementById('replyingSnippet');
          var cancelReplyBtn = document.getElementById('cancelReplyBtn');

          function showReplyPreview(id, name, snippet){
            if (!replyHidden || !replyPreview) return;
            replyHidden.value = id || '';
            if (replyingToName) replyingToName.textContent = name || '—';
            if (replyingSnippet) replyingSnippet.textContent = snippet || '';
            replyPreview.classList.remove('hidden');
            bodyInput?.focus();
          }
          function clearReplyPreview(){
            if (replyHidden) replyHidden.value = '';
            if (replyingToName) replyingToName.textContent = '';
            if (replyingSnippet) replyingSnippet.textContent = '';
            replyPreview?.classList.add('hidden');
          }

          cancelReplyBtn?.addEventListener('click', function(e){
            e.preventDefault();
            clearReplyPreview();
          });

          // Bắt nút Reply (event delegation) — bám theo chính nút btn
          pageMain.addEventListener('click', function(e){
            var btn = e.target.closest('.reply-btn');
            if (!btn) return;
            var bubble = btn.closest('.bubble');
            if (!bubble) return;

            var id = bubble.getAttribute('data-message-id') || '';
            var name = bubble.getAttribute('data-sender-name') || '—';
            var sn  = bubble.getAttribute('data-snippet') || '';

            showReplyPreview(id, name, sn);
          }, {passive:true});
        })();
    </script>

    @* ====== SignalR realtime (Provider) dùng chung window.__chatConnection như Admin ====== *@
    <script>
        // Lấy conversationId đang mở (lowercase để so sánh)
        function __providerChatGetCurrentConvId() {
            const main = document.querySelector('main.chat-main[data-selected-conv]');
            if (!main) return '';
            const attr = main.getAttribute('data-selected-conv') || '';
            return attr.toLowerCase();
        }

        // Lấy conversationId raw (dùng cho API)
        function __providerChatGetCurrentConvIdRaw() {
            const main = document.querySelector('main.chat-main[data-selected-conv]');
            if (!main) return '';
            return main.getAttribute('data-selected-conv') || '';
        }

        // Gọi MarkRead cho hội thoại hiện tại
        function __providerChatMarkReadCurrent() {
            const convId = __providerChatGetCurrentConvIdRaw();
            if (!convId) return;

            const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenEl ? tokenEl.value : '';

            const url = '@Url.Action("MarkRead", "ChatProvider", new { area = "Provider" })'
                       + '?conversationId=' + encodeURIComponent(convId);

            fetch(url, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token },
                credentials: 'same-origin'
            })
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json().catch(() => ({}));
            })
            .then(d => console.log('[provider-chat] ✅ MarkRead OK', d))
            .catch(err => console.error('[provider-chat] ❌ MarkRead lỗi', err));
        }

        // Helper parse ISO date string
        function __providerParseIso(s) {
            if (!s) return null;

            s = String(s).trim();
            if (!s) return null;

            // Có phần time hay không
            const hasTime = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s);
            // Có timezone (Z hoặc +07:00 / -05:00) hay chưa
            const hasZone = /Z$|[+\-]\d{2}:?\d{2}$/.test(s);

            // Nếu có time mà không có timezone -> coi là UTC
            if (hasTime && !hasZone) {
                s = s + 'Z';
            }

            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }

        // Hàm format thời gian thông minh cho chat (đồng bộ với C# FormatChatTime)
        function __providerFormatChatTime(dateStr) {
            if (!dateStr) return '';

            const sourceDate = __providerParseIso(dateStr);
            if (!sourceDate) return '';

            const TZ = 'Asia/Ho_Chi_Minh';

            const formatDateKey = (date) => {
                const formatted = new Intl.DateTimeFormat('en-CA', {
                    timeZone: TZ,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).format(date); // yyyy-mm-dd
                const [year, month, day] = formatted.split('-').map(Number);
                return {
                    key: formatted,
                    year,
                    month,
                    day,
                    utcMidnightMs: Date.UTC(year, month - 1, day)
                };
            };

            const msgDateInfo = formatDateKey(sourceDate);
            const todayDate = new Date();
            const todayInfo = formatDateKey(todayDate);
            const yesterdayInfo = formatDateKey(new Date(todayDate.getTime() - 86400000));

            const timeFormatter = new Intl.DateTimeFormat('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: TZ
            });
            const hhmm = timeFormatter.format(sourceDate);

            // Cùng ngày: chỉ hiển thị giờ
            if (msgDateInfo.key === todayInfo.key) {
                return hhmm;
            }

            // Hôm qua
            if (msgDateInfo.key === yesterdayInfo.key) {
                return 'Hôm qua ' + hhmm;
            }

            // Khoảng cách ngày theo múi giờ VN
            const diffDays = Math.round((todayInfo.utcMidnightMs - msgDateInfo.utcMidnightMs) / 86400000);
            if (diffDays > 0 && diffDays <= 7) {
                const weekdayKey = new Intl.DateTimeFormat('en-US', {
                    weekday: 'short',
                    timeZone: TZ
                }).format(sourceDate);
                const dayMap = {
                    Sun: 'CN',
                    Mon: 'Thứ 2',
                    Tue: 'Thứ 3',
                    Wed: 'Thứ 4',
                    Thu: 'Thứ 5',
                    Fri: 'Thứ 6',
                    Sat: 'Thứ 7'
                };
                const dayLabel = dayMap[weekdayKey] || weekdayKey;
                return dayLabel + ' ' + hhmm;
            }

            // Trong cùng năm: hiển thị ngày/tháng + giờ
            if (msgDateInfo.year === todayInfo.year) {
                const dateFormatterWithinYear = new Intl.DateTimeFormat('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    timeZone: TZ
                });
                return dateFormatterWithinYear.format(sourceDate) + ' ' + hhmm;
            }

            // Khác năm: hiển thị đầy đủ
            const fullFormatter = new Intl.DateTimeFormat('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: TZ
            });
            return fullFormatter.format(sourceDate) + ' ' + hhmm;
        }

        function __providerStatusHtml(status) {
            let icon = '', text = '';
            switch (status) {
                case 'Pending':   icon = '<i class="bi bi-clock-history"></i>'; text = 'Đang gửi'; break;
                case 'Sent':      icon = '<i class="bi bi-check"></i>';         text = 'Đã gửi';   break;
                case 'Delivered': icon = '<i class="bi bi-check2-all"></i>';    text = 'Đã nhận';  break;
                case 'Seen':      icon = '<i class="bi bi-check2-all"></i>';    text = 'Đã xem';   break;
            }
            return '<span class="msg-status" data-status="' + status + '">' +
                    icon + '<span class="status-text">' + text + '</span></span>';
        }

        function __providerSetBubbleStatus(bubble, status) {
            if (!bubble) return;
            bubble.setAttribute('data-status', status);
            const meta = bubble.querySelector('.msg-meta');
            if (!meta) return;

            let statusEl = meta.querySelector('.msg-status');
            if (!statusEl) {
                if (bubble.dataset.isMine === 'true') {
                    meta.insertAdjacentHTML('beforeend', __providerStatusHtml(status));
                }
            } else {
                statusEl.outerHTML = __providerStatusHtml(status);
            }
        }

        function __providerApplyReadUpTo(lastReadAtIso) {
            const lastReadAt = __providerParseIso(lastReadAtIso);
            if (!lastReadAt) return;

            document.querySelectorAll('.bubble[data-is-mine="true"]').forEach(b => {
                const created = __providerParseIso(b.getAttribute('data-created-at'));
                if (created && created <= lastReadAt) {
                    __providerSetBubbleStatus(b, 'Delivered');
                }
            });
        }

        function __providerAttachReplyRefIfAny(bubbleEl, msg) {
            if (!msg || !msg.replyToMessageId) return;

            const refId = String(msg.replyToMessageId);
            const parent = document.querySelector('.bubble[data-message-id="' + refId + '"]');

            const name = parent?.getAttribute('data-sender-name') || (msg.replyToSenderName || '—');
            const sn   = parent?.getAttribute('data-snippet')      || (msg.replyToSnippet || '(Không có nội dung)');

            const wrap = document.createElement('div');
            wrap.className = 'reply-ref';

            const nameEl = document.createElement('div');
            nameEl.className = 'reply-ref-name';
            nameEl.textContent = name;

            const snEl = document.createElement('div');
            snEl.className = 'reply-ref-text';
            snEl.textContent = sn;

            wrap.appendChild(nameEl);
            wrap.appendChild(snEl);
            bubbleEl.insertAdjacentElement('afterbegin', wrap);
        }

        // ===== Khởi tạo realtime cho Chat Provider (dùng chung window.__chatConnection) =====
        window.__initProviderChatRealtime = function () {
            console.log('[provider-chat] 🚀 __initProviderChatRealtime được gọi');

            const me = '@(Model.CurrentAccount?.AccountId.ToString() ?? Guid.Empty.ToString())'.toLowerCase();
            const GUID_EMPTY = '00000000-0000-0000-0000-000000000000';

            if (!me || me === GUID_EMPTY) {
                console.warn('[provider-chat] me là GUID rỗng, bỏ qua SignalR init');
                return;
            }

            let connection = window.__chatConnection;
            if (!connection) {
                console.log('[provider-chat] ⏳ Chưa có window.__chatConnection, sẽ thử lại sau');
                if (!window.__providerChatRetryCount) window.__providerChatRetryCount = 0;
                if (window.__providerChatRetryCount < 50) {
                    window.__providerChatRetryCount++;
                    setTimeout(window.__initProviderChatRealtime, 300);
                } else {
                    console.error('[provider-chat] ❌ Không tìm thấy window.__chatConnection sau 50 lần thử');
                }
                return;
            }

            console.log('[provider-chat] ✅ Dùng lại window.__chatConnection, state =', connection.state);

            // ===== Gắn handler global (chỉ 1 lần trên connection) =====
            if (!connection.__providerHandlersAttached) {
                connection.__providerHandlersAttached = true;
                console.log('[provider-chat] Gắn handlers SignalR cho Provider Chat');

                // 1) Người kia đọc đến đâu
                connection.on('conversation:readUpTo', payload => {
                    console.log('[provider-chat] conversation:readUpTo', payload);
                    if (!payload) return;

                    const currentConvId = __providerChatGetCurrentConvId();
                    if (!currentConvId) return;

                    const payloadConvId = String(
                        payload.conversationId ?? payload.ConversationId ?? ''
                    ).toLowerCase();

                    if (!payloadConvId || payloadConvId !== currentConvId) return;

                    const lastReadAt = payload.lastReadAt ?? payload.LastReadAt ?? null;
                    __providerApplyReadUpTo(lastReadAt);
                });

                // 2) Tin nhắn mới
                connection.on('message:created', msg => {
                    console.log('[provider-chat] message:created', msg);
                    if (!msg) return;

                    const currentConvId = __providerChatGetCurrentConvId();
                    if (!currentConvId) return;

                    const msgConvId = String(
                        msg.conversationId ?? msg.ConversationId ?? ''
                    ).toLowerCase();
                    if (!msgConvId || msgConvId !== currentConvId) {
                        // Thuộc hội thoại khác -> sidebar sẽ được cập nhật qua conversationList:update
                        return;
                    }

                    const list = document.getElementById('msgList');
                    if (!list) return;

                    const senderId = String(msg.senderAccountId ?? msg.SenderAccountId ?? '').toLowerCase();
                    const isMine = senderId === me;

                    const messageId = msg.messageId ?? msg.MessageId;
                    const createdAt = msg.createdAt ?? msg.CreatedAt;
                    const body      = msg.body ?? msg.Body;
                    const imageUrl  = msg.imageUrl ?? msg.ImageUrl;
                    const status    = msg.status ?? msg.Status ?? 'Sent';

                    const replyToId = msg.replyToMessageId ?? msg.ReplyToMessageId;

                    // Lưu avatar nếu backend gửi (dùng avatar manager đã viết)
                    if ((msg.conversationId || msg.ConversationId) && msg.sender && msg.sender.avatarUrl && window.chatAvatarManager) {
                        const cId = msg.conversationId ?? msg.ConversationId;
                        window.chatAvatarManager.save(cId, msg.sender.avatarUrl);
                        const convItem = document.querySelector('.conv-item[data-conversation-id="' + cId + '"]');
                        if (convItem) {
                            window.chatAvatarManager.update(convItem, msg.sender.avatarUrl);
                        }
                    }

                    const wrap = document.createElement('div');
                    wrap.className = 'msg-wrapper ' + (isMine ? 'msg-me' : 'msg-other');

                    const bubble = document.createElement('div');
                    bubble.className = 'bubble ' + (isMine ? 'me' : 'other');
                    bubble.setAttribute('data-message-id', messageId);
                    bubble.setAttribute('data-created-at', createdAt);
                    bubble.setAttribute('data-is-mine', isMine ? 'true' : 'false');
                    bubble.setAttribute('data-status', status);

                    const senderName = isMine ? 'Bạn' : (msg.senderName ?? msg.SenderName ?? 'Đối tác');
                    const snippetThis = body ? body : (imageUrl ? '[Ảnh]' : '(Không có nội dung)');

                    bubble.setAttribute('data-sender-name', senderName);
                    bubble.setAttribute('data-snippet', snippetThis);

                    __providerAttachReplyRefIfAny(bubble, {
                        replyToMessageId: replyToId,
                        replyToSenderName: msg.replyToSenderName ?? msg.ReplyToSenderName,
                        replyToSnippet: msg.replyToSnippet ?? msg.ReplyToSnippet
                    });

                    if (body) {
                        const bodyEl = document.createElement('div');
                        bodyEl.className = 'msg-body';
                        bodyEl.textContent = body;
                        bubble.appendChild(bodyEl);
                    }

                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.className = 'msg-image';
                        img.loading = 'lazy';
                        img.decoding = 'async';
                        img.referrerPolicy = 'no-referrer';
                        img.onerror = function () {
                            this.onerror = null;
                            this.src = '@fallbackImg';
                        };
                        bubble.appendChild(img);
                    }

                    const meta = document.createElement('div');
                    meta.className = 'msg-meta';

                    // Format thời gian đồng bộ với C# FormatChatTime
                    const formattedTime = __providerFormatChatTime(createdAt);

                    meta.innerHTML =
                        '<button type="button" class="reply-btn" title="Trả lời">' +
                            '<i class="bi bi-reply"></i> <span class="reply-text">Reply</span>' +
                        '</button>' +
                        '<span class="msg-time">' + formattedTime + '</span>' +
                        (isMine ? __providerStatusHtml(status) : '');

                    bubble.appendChild(meta);
                    wrap.appendChild(bubble);
                    list.appendChild(wrap);

                    setTimeout(() => {
                        list.scrollTop = list.scrollHeight;
                    }, 50);

                    // Nếu là tin của người kia -> auto MarkRead
                    if (!isMine) {
                        __providerChatMarkReadCurrent();
                    }
                });

                // 3) Update sidebar (tên hội thoại, snippet, giờ, badge unread)
                connection.on('conversationList:update', item => {
                    console.log('[provider-chat] conversationList:update', item);
                    if (!item) return;

                    const list = document.querySelector('.chat-sidebar .chat-scroll');
                    if (!list) return;

                    const convId = String(item.conversationId ?? item.ConversationId ?? '');
                    if (!convId) return;

                    const row = list.querySelector('.conv-item[data-conversation-id="' + convId + '"]');
                    if (!row) return;

                    const titleEl = row.querySelector('.conv-title');
                    if (titleEl) titleEl.textContent = item.title ?? item.Title ?? '';

                    const snEl = row.querySelector('.conv-snippet');
                    if (snEl) snEl.textContent = item.lastMessageSnippet ?? item.LastMessageSnippet ?? '';

                    const timeEl = row.querySelector('.conv-time');
                    const lastAt = item.lastMessageAt ?? item.LastMessageAt;
                    if (timeEl && lastAt) {
                        // Format thời gian đồng bộ với C# FormatChatTime
                        timeEl.textContent = __providerFormatChatTime(lastAt);
                    }

                    // Badge unread - tìm container chứa thời gian (flex-column)
                    const timeContainer = timeEl ? timeEl.parentElement : null;
                    let badge = row.querySelector('.conv-unread');
                    const currentConvId = __providerChatGetCurrentConvId();
                    let unread = item.unreadCount ?? item.UnreadCount ?? 0;

                    if (currentConvId && convId.toLowerCase() === currentConvId) {
                        unread = 0; // đang mở thì không hiển thị unread
                    }

                    if (!badge && unread > 0 && timeContainer) {
                        badge = document.createElement('span');
                        badge.className = 'badge rounded-pill bg-danger conv-unread';
                        timeContainer.appendChild(badge);
                    }

                    if (badge) {
                        if (unread > 0) {
                            badge.textContent = unread;
                            badge.style.display = '';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });

                // totalUnread:update đã được layout Provider xử lý cho badge ở topbar rồi,
                // nên ở đây không gắn lại để tránh double handler.
            }

            // Per-conversation: vừa mở là MarkRead luôn
            const main = document.querySelector('main.chat-main[data-selected-conv]');
            if (main && !main.__providerHandlersAttached) {
                main.__providerHandlersAttached = true;
                __providerChatMarkReadCurrent();
            }

            // Nếu connection hỗ trợ onreconnected thì sau reconnect MarkRead lại
            if (connection && !connection.__providerReconnectedHooked && connection.onreconnected) {
                connection.__providerReconnectedHooked = true;
                connection.onreconnected(() => {
                    console.log('[provider-chat] 🔁 onreconnected -> MarkRead lại hội thoại đang mở');
                    __providerChatMarkReadCurrent();
                });
            }
        };

        // Gọi init sau khi DOM sẵn sàng
        (function () {
            function start() {
                window.__initProviderChatRealtime();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', start);
            } else {
                start();
            }
        })();
    </script>

}


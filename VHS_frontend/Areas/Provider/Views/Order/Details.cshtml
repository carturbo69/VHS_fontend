@model VHS_frontend.Areas.Provider.Models.Booking.BookingDetailDTO
@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "Chi tiết đặt dịch vụ";
    var fallbackImg = Url.Content("~/images/VeSinh.jpg");
    
    // Helper function để xử lý URL ảnh (thêm domain prefix nếu cần)
    string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
}

<div class="order-detail-container">
    <!-- Header -->
    <div class="order-detail-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="order-detail-title-section">
                <h3 class="order-detail-main-title mb-3">
                    <i class="bi bi-file-text me-2"></i>
                    Chi tiết đặt dịch vụ
                </h3>
                <div class="order-detail-info-row">
                    <div class="order-code-simple">
                        <i class="bi bi-receipt me-2"></i>
                        <span class="order-code-label">Mã đơn:</span>
                        <span class="order-code-value">@Model.BookingCode</span>
                    </div>
                    <p class="order-detail-meta mb-0">
                        <i class="bi bi-calendar3"></i> 
                        <span>Tạo lúc: @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
            </p>
                </div>
        </div>
        <div>
                <a asp-action="Index" class="btn btn-back">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Customer Info Card -->
            <div class="card detail-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Thông tin khách hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="detail-info-item">
                                <span class="detail-label"><i class="bi bi-person me-2"></i>Họ tên:</span>
                                <span class="detail-value">@Model.CustomerName</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-info-item">
                                <span class="detail-label"><i class="bi bi-telephone me-2"></i>Số điện thoại:</span>
                                <span class="detail-value">@Model.CustomerPhone</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="detail-info-item">
                                <span class="detail-label"><i class="bi bi-envelope me-2"></i>Email:</span>
                                <span class="detail-value">@Model.CustomerEmail</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Info Card -->
            <div class="card detail-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-briefcase me-2"></i>
                        Thông tin dịch vụ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="service-detail-wrapper">
                        @if (!string.IsNullOrEmpty(Model.ServiceImages))
                        {
                            var firstImage = Model.ServiceImages.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var firstUrl = ToUrl(firstImage);
                            if (!string.IsNullOrEmpty(firstUrl))
                            {
                                <div class="service-image-wrapper">
                                    <img src="@firstUrl" alt="@Model.ServiceName" class="service-image" />
                                </div>
                            }
                        }
                        <div class="service-info-content">
                            <h5 class="service-name">@Model.ServiceName</h5>
                            <div class="service-description">@(Model.ServiceDescription ?? "")</div>
                            <div class="service-price-box">
                                <span class="price-label">Giá:</span>
                                <span class="price-value">@Model.ServicePrice.ToString("N0") VND</span>
                            </div>
                            
                            @if (Model.Options.Any())
                            {
                                @* Tách options thành 2 nhóm: non-textarea trước, textarea sau *@
                                var nonTextareaOptions = Model.Options.Where(opt => 
                                    !(opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text")).ToList();
                                var textareaOptions = Model.Options.Where(opt => 
                                    opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text").ToList();
                                
                                <div class="service-options mt-3">
                                    <strong class="options-title"><i class="bi bi-list-check me-2"></i>Tùy chọn đã bao gồm:</strong>
                                    <div class="mt-2">
                                        @* Hiển thị non-textarea options trước *@
                                        @foreach (var option in nonTextareaOptions)
                                        {
                                            <div style="font-size: 0.9375rem; color: var(--muted-foreground, #6c757d); margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <i class="bi bi-check-circle-fill me-1" style="color: var(--success, #198754); font-size: 0.75rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <span>@option.OptionName</span>
                                                        @if (!string.IsNullOrWhiteSpace(option.Value))
                                                        {
                                                            <div style="margin-top: 0.125rem; font-size: 0.875rem; line-height: 1.4; color: #6c757d;">
                                                                <span>@option.Value</span>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        
                                        @* Hiển thị textarea options sau cùng *@
                                        @foreach (var option in textareaOptions)
                                        {
                                            var isTextarea = option.Type?.ToLower() == "textarea" || option.Type?.ToLower() == "text";
                                            <div style="font-size: 0.9375rem; color: var(--muted-foreground, #6c757d); margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <i class="bi bi-check-circle-fill me-1" style="color: var(--success, #198754); font-size: 0.75rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <span>@option.OptionName</span>
                                                        @if (isTextarea && !string.IsNullOrWhiteSpace(option.Value))
                                                        {
                                                            @* Xử lý giá trị: split theo xuống dòng hoặc dấu gạch ngang *@
                                                            var valueLines = new List<string>();
                                                            
                                                            @* Kiểm tra xem có ký tự xuống dòng không *@
                                                            if (option.Value.Contains('\n') || option.Value.Contains('\r'))
                                                            {
                                                                @* Nếu có xuống dòng, split theo \n và \r *@
                                                                valueLines = option.Value
                                                                    .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
                                                                    .Select(v => v.Trim())
                                                                    .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                    .ToList();
                                                            }
                                                            else
                                                            {
                                                                @* Nếu không có xuống dòng nhưng có dấu gạch ngang, split theo dấu gạch ngang *@
                                                                valueLines = option.Value
                                                                    .Split(new[] { " - ", " – ", "-", "–" }, StringSplitOptions.RemoveEmptyEntries)
                                                                    .Select(v => v.Trim())
                                                                    .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                    .ToList();
                                                            }
                                                            
                                                            <div style="margin-top: 0.125rem; font-size: 0.875rem; line-height: 1.4; color: #6c757d;">
                                                                @foreach (var line in valueLines)
                                                                {
                                                                    <div>@line</div>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Info Card -->
            <div class="card detail-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        Thông tin đặt dịch vụ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="detail-info-item mb-3">
                        <span class="detail-label"><i class="bi bi-clock me-2"></i>Thời gian thực hiện:</span>
                        <span class="detail-value">@Model.BookingTime.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    
                    <!-- ✅ Địa chỉ từ Booking.Address (không dùng UserAddress nữa) -->
                    <div class="detail-info-item mb-3">
                        <span class="detail-label mb-2 d-block"><i class="bi bi-geo-alt me-2"></i>Địa chỉ:</span>
                        <div class="address-detail-box">
                            @if (!string.IsNullOrEmpty(Model.RecipientName))
                            {
                                <div class="address-recipient mb-2">
                                    <strong><i class="bi bi-person me-1"></i>Người đặt:</strong> 
                                    <span>@Model.RecipientName</span>
                                    @if (!string.IsNullOrEmpty(Model.RecipientPhone))
                                    {
                                        <span class="ms-2 text-muted">
                                            <i class="bi bi-telephone me-1"></i>@Model.RecipientPhone
                                        </span>
                                    }
                                </div>
                            }
                            <div class="address-line">
                                <i class="bi bi-house-door me-2 text-primary"></i>
                                <span class="detail-value">@Model.Address</span>
                            </div>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(Model.VoucherCode))
                    {
                        <div class="detail-info-item">
                            <span class="detail-label"><i class="bi bi-ticket-perforated me-2"></i>Mã giảm giá:</span>
                            <span class="voucher-badge">@Model.VoucherCode</span>
                        </div>
                    }
                </div>
            </div>

            @{
                var currentStatus = (Model.Status ?? string.Empty).Trim();
                var isCompletedOrCancelled = string.Equals(currentStatus, "Completed", StringComparison.OrdinalIgnoreCase) || 
                                            string.Equals(currentStatus, "Cancelled", StringComparison.OrdinalIgnoreCase) ||
                                            string.Equals(currentStatus, "Canceled", StringComparison.OrdinalIgnoreCase);
                var isServiceCompletedCheck = string.Equals(currentStatus, "Service Completed", StringComparison.OrdinalIgnoreCase) ||
                                             string.Equals(currentStatus, "Service-Completed", StringComparison.OrdinalIgnoreCase);
                
                // Kiểm tra xem có event CHECK IN trong timeline không
                var hasCheckedIn = Model?.Timeline != null && Model.Timeline.Any(e => 
                    string.Equals((e.Code ?? "").Trim(), "CHECK IN", StringComparison.OrdinalIgnoreCase));
            }
            
            @* Chỉ hiển thị phần phân công nhân viên nếu đơn hàng chưa hoàn thành hoặc hủy (Service Completed vẫn hiển thị nhưng disable) *@
            @if (!isCompletedOrCancelled)
            {
                <!-- Staff Assignment Card -->
                <div class="card detail-card mb-4">
                    <div class="card-header detail-card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>
                            Phân công nhân viên
                        </h5>
                    </div>
                    <div class="card-body">
                        @{
                            var isPendingStatus = string.Equals((Model.Status ?? string.Empty).Trim(), "Pending", StringComparison.OrdinalIgnoreCase);
                            var isConfirmedOrAbove = string.Equals((Model.Status ?? string.Empty).Trim(), "Confirmed", StringComparison.OrdinalIgnoreCase) ||
                                                    string.Equals((Model.Status ?? string.Empty).Trim(), "InProgress", StringComparison.OrdinalIgnoreCase) ||
                                                    string.Equals((Model.Status ?? string.Empty).Trim(), "Completed", StringComparison.OrdinalIgnoreCase);
                            var isServiceCompletedForStaff = string.Equals((Model.Status ?? string.Empty).Trim(), "Service Completed", StringComparison.OrdinalIgnoreCase) ||
                                                             string.Equals((Model.Status ?? string.Empty).Trim(), "Service-Completed", StringComparison.OrdinalIgnoreCase);
                        }
                        
                        @* Hiển thị "Đã phân công" khi status là Confirmed trở lên (bao gồm Service Completed) hoặc đã check-in *@
                        @if ((isConfirmedOrAbove || isServiceCompletedForStaff || hasCheckedIn) && Model.StaffId.HasValue)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-person-check-fill"></i>
                                Đã phân công cho: <strong>@Model.StaffName</strong>
                                @if (isServiceCompletedForStaff)
                                {
                                    <p class="mb-0 mt-2 small">
                                        Đơn hàng đã được nhân viên hoàn thành và đang chờ khách hàng xác nhận. 
                                        Không thể thay đổi phân công nhân viên lúc này.
                                    </p>
                                }
                                else if (hasCheckedIn)
                                {
                                    <p class="mb-0 mt-2 small">
                                        Nhân viên đã bắt đầu làm việc (đã check-in). 
                                        Không thể thay đổi phân công nhân viên lúc này.
                                    </p>
                                }
                            </div>
                        }
                        else if (isPendingStatus)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Đơn hàng đang chờ xử lý</strong>
                                <p class="mb-0 mt-2 small">
                                    Bạn có thể chọn nhân viên trước, sau đó nhấn "Xác nhận đơn hàng" để gán chính thức. 
                                    Nếu không chọn, hệ thống sẽ tự động gán nhân viên rảnh có ít công việc nhất.
                                </p>
                            </div>
                        }
                        else if (isServiceCompletedForStaff && !Model.StaffId.HasValue)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-hourglass-split"></i>
                                <strong>Đang chờ khách hàng xác nhận</strong>
                                <p class="mb-0 mt-2 small">
                                    Đơn hàng đã được hoàn thành và đang chờ khách hàng xác nhận. 
                                    Không thể thay đổi phân công nhân viên lúc này.
                                </p>
                            </div>
                        }
                        else if (!isServiceCompletedForStaff)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Chưa phân công nhân viên
                            </div>
                        }

                        @* Chỉ hiển thị phần chọn nhân viên khi chưa Service Completed và chưa check-in *@
                        @if (!isServiceCompletedForStaff && !hasCheckedIn && ViewBag.StaffList != null && ((List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>)ViewBag.StaffList).Any())
                        {
                            <div class="mt-3">
                                <!-- Thông báo lỗi/thành công -->
                                <div id="staffAssignmentMessage" class="alert d-none" role="alert">
                                    <span id="staffAssignmentMessageText"></span>
                                </div>
                                
                                <label class="form-label">Chọn nhân viên:</label>
                                <div class="input-group">
                                    <select id="staffSelect" class="form-select">
                                        <option value="">-- Chọn nhân viên (tùy chọn) --</option>
                                        @foreach (var staff in (List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>)ViewBag.StaffList)
                                        {
                                            @* Chỉ pre-select nhân viên nếu status là Confirmed trở lên *@
                                            var isSelected = isConfirmedOrAbove && Model.StaffId.HasValue && 
                                                            Guid.TryParse(staff.StaffId, out var staffGuid) && 
                                                            staffGuid == Model.StaffId.Value;
                                            
                                            @* Logic: 
                                               - Nếu nhân viên không bị xóa: hiển thị bình thường
                                               - Nếu nhân viên bị xóa nhưng đã được phân công: vẫn hiển thị để người dùng biết, nhưng disable
                                               - Nếu nhân viên bị xóa và chưa được phân công: ẩn khỏi danh sách
                                            *@
                                            var isAssignedStaff = isSelected;
                                            var isDeleted = staff.IsDeleted == true;
                                            var shouldShow = !isDeleted || isAssignedStaff;
                                            
                                            @if (shouldShow)
                                            {
                                                <option value="@staff.StaffId" 
                                                        selected="@isSelected"
                                                        disabled="@isDeleted"
                                                        data-deleted="@isDeleted.ToString().ToLower()">
                                                    @staff.StaffName@(isDeleted ? " (Đã xóa)" : "")
                                            </option>
                                            }
                                        }
                                    </select>
                                    <button type="button" class="btn btn-assign-staff" onclick="assignStaff()">
                                        <i class="bi bi-check"></i> Phân công
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Checker Records đã được hiển thị trong Timeline, không cần section riêng nữa *@
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card detail-card status-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Trạng thái đặt dịch vụ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="status-badge-wrapper mb-4">
                        @{
                            // Nếu đã check-in, hiển thị "Bắt đầu làm việc" thay vì status hiện tại
                            var displayStatus = hasCheckedIn ? "Bắt đầu làm việc" : GetStatusText(Model.Status);
                            var statusClass = hasCheckedIn ? "status-inprogress" : Model.Status.ToLower().Replace(" ", "-");
                        }
                        <span class="status-badge-lg status-@statusClass">
                            @displayStatus
                        </span>
                    </div>

                    @{ 
                        var statusNorm = (Model.Status ?? string.Empty).Trim();
                        bool isPending = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase);
                        bool isConfirmed = string.Equals(statusNorm, "Confirmed", StringComparison.OrdinalIgnoreCase);
                        bool isCompleted = string.Equals(statusNorm, "Completed", StringComparison.OrdinalIgnoreCase);
                        bool isServiceCompleted = string.Equals(statusNorm, "Service Completed", StringComparison.OrdinalIgnoreCase) ||
                                                 string.Equals(statusNorm, "Service-Completed", StringComparison.OrdinalIgnoreCase);
                        bool isCanceled  = string.Equals(statusNorm, "Canceled", StringComparison.OrdinalIgnoreCase) ||
                                          string.Equals(statusNorm, "Cancelled", StringComparison.OrdinalIgnoreCase);
                        // Hiển thị nút nếu đơn chưa ở các trạng thái cuối cùng (bao gồm Service Completed) VÀ chưa check-in
                        bool canAct = !(isConfirmed || isCompleted || isServiceCompleted || isCanceled || hasCheckedIn);
                        
                        // Kiểm tra xem có nhân viên nào không bị xóa không
                        var staffList = ViewBag.StaffList as List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>;
                        var hasAvailableStaff = staffList != null && staffList.Any(s => s.IsDeleted != true);
                    }
                    
                    @* Hiển thị countdown timer cho booking Pending *@
                    @if (isPending)
                    {
                        var defaultCancelMinutes = (int)(ViewBag.DefaultCancelMinutes ?? 30);
                        var cancelMinutes = Model.AutoCancelMinutes ?? defaultCancelMinutes; // Dùng giá trị từ system settings
                        DateTime validCreatedAt;
                        if (Model.CreatedAt != default(DateTime) && Model.CreatedAt != DateTime.MinValue && Model.CreatedAt.Year > 2000)
                        {
                            validCreatedAt = Model.CreatedAt;
                        }
                        else
                        {
                            validCreatedAt = DateTime.Now;
                        }
                        var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy:</strong>
                                </div>
                                <div class="countdown-timer-detail text-danger fw-bold" 
                                     data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-booking-id="@Model.BookingId"
                                     data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-auto-cancel-minutes="@cancelMinutes"
                                     style="font-size: 1.1rem;">
                                    Đang tính...
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                @if (Model.AutoCancelMinutes.HasValue)
                                {
                                    <text>Thời gian hủy riêng: @Model.AutoCancelMinutes phút</text>
                                }
                                else
                                {
                                    <text>Thời gian hủy mặc định: @cancelMinutes phút</text>
                                }
                            </small>
                        </div>
                    }
                    
                    @if (canAct)
                    {
                        <!-- Thông báo lỗi/thành công cho status -->
                        <div id="statusUpdateMessage" class="alert d-none mb-3" role="alert">
                            <span id="statusUpdateMessageText"></span>
                        </div>
                        
                        @if (!hasAvailableStaff)
                        {
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Không có nhân viên nào để phân công.</strong><br>
                                <small>Vui lòng thêm nhân viên hoặc mở khóa nhân viên trong phần "Quản lí nhân viên" trước khi xác nhận đơn hàng.</small>
                            </div>
                        }
                        
                        <div class="action-buttons">
                            @if (hasAvailableStaff)
                            {
                                <button type="button" class="btn btn-confirm btn-lg" onclick="updateStatus('Confirmed')">
                                <i class="bi bi-check-circle"></i> Xác nhận đơn hàng
                            </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-confirm btn-lg" disabled>
                                    <i class="bi bi-check-circle"></i> Xác nhận đơn hàng
                                </button>
                            }
                            <button type="button" class="btn btn-cancel" onclick="cancelOrder()">
                                <i class="bi bi-x-circle"></i> Từ chối đơn hàng
                            </button>
                        </div>
                    }
                    else if (hasCheckedIn)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-check-circle"></i>
                            <strong>Nhân viên đã bắt đầu làm việc</strong>
                            <p class="mb-0 mt-2 small">
                                Nhân viên <strong>@(Model.StaffName ?? "chưa phân công")</strong> đã check-in và đang thực hiện công việc. 
                                Bạn không thể xác nhận hoặc từ chối đơn hàng lúc này.
                            </p>
                        </div>
                    }
                    else if (Model.Status == "Confirmed")
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Đơn hàng đã được xác nhận</strong>
                            <p class="mb-0 mt-2 small">
                                Nhân viên <strong>@(Model.StaffName ?? "chưa phân công")</strong> sẽ thực hiện công việc và cập nhật trạng thái qua ứng dụng nhân viên.
                            </p>
                        </div>
                        <!-- Chỉ cho phép hủy nếu thực sự cần -->
                        @* <button type="button" class="btn btn-outline-danger btn-sm" onclick="cancelOrder()">
                            <i class="bi bi-x-circle"></i> Hủy đơn hàng (khẩn cấp)
                        </button> *@
                    }
                    else if (isServiceCompleted)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-hourglass-split"></i>
                            <strong>Đang chờ khách hàng xác nhận</strong>
                            <p class="mb-0 mt-2">
                                Đơn hàng đã được nhân viên hoàn thành và đang chờ khách hàng xác nhận. 
                                Bạn không thể thực hiện thêm thao tác nào cho đến khi khách hàng xác nhận hoàn thành.
                            </p>
                        </div>
                    }
                    else if (isCompleted)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Đơn hàng đã hoàn thành</strong>
                            <p class="mb-0 mt-2">
                                @if (!string.IsNullOrEmpty(Model.StaffName))
                                {
                                    <text>Đơn hàng đã được nhân viên <strong>@Model.StaffName</strong> hoàn thành và đã được khách hàng xác nhận.</text>
                                }
                                else
                                {
                                    <text>Công việc đã được nhân viên hoàn thành và đã được khách hàng xác nhận.</text>
                                }
                            </p>
                        </div>
                    }
                    else if (isCanceled)
                    {
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">
                                <i class="bi bi-x-circle-fill"></i>
                                <strong>Đơn hàng này đã được hủy</strong>
                            </h5>
                            @if (!string.IsNullOrEmpty(Model.CancelReason))
                            {
                                <hr />
                                <p class="mb-0">
                                    <strong>Lý do hủy:</strong><br />
                                    <span class="text-dark">@Model.CancelReason</span>
                                </p>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Payment Card -->
            <div class="card detail-card payment-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        Thanh toán
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-summary">
                        <div class="payment-item payment-total">
                            <span class="payment-label">Tổng tiền:</span>
                            <span class="payment-value">@Model.TotalAmount.ToString("N0") VND</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label"><i class="bi bi-wallet2 me-1"></i>Phương thức:</span>
                            <span class="payment-method">@GetPaymentMethodText(Model.PaymentMethod)</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Trạng thái:</span>
                            @{
                                var paymentStatusClass = "unpaid";
                                var paymentStatusLower = Model.PaymentStatus?.ToLower() ?? "";
                                if (paymentStatusLower.Contains("paid") || paymentStatusLower.Contains("đã"))
                                {
                                    paymentStatusClass = "paid";
                                }
                                else if (paymentStatusLower.Contains("rejected") || paymentStatusLower.Contains("từ chối"))
                                {
                                    paymentStatusClass = "rejected";
                                }
                                else if (paymentStatusLower.Contains("refunded") || paymentStatusLower.Contains("hoàn tiền"))
                                {
                                    paymentStatusClass = "refunded";
                                }
                                else if (paymentStatusLower.Contains("unpaid") || paymentStatusLower.Contains("chưa") || paymentStatusLower.Contains("pending"))
                                {
                                    paymentStatusClass = "unpaid";
                                }
                            }
                            <span class="badge payment-status-badge payment-@(paymentStatusClass.Replace(" ", "-"))">
                                @GetPaymentStatusText(Model.PaymentStatus)
                            </span>
                        </div>
                        @if (Model.PaymentDate.HasValue)
                        {
                            <div class="payment-item payment-date">
                                <span class="payment-label"><i class="bi bi-calendar3 me-1"></i>Ngày thanh toán:</span>
                                <span class="payment-date-value">@Model.PaymentDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                        }
                    </div>
                    
                    @* Hiển thị countdown timer cho Confirmed chưa thanh toán *@
                    @{
                        var statusNormPayment = (Model.Status ?? string.Empty).Trim();
                        bool isConfirmedPayment = string.Equals(statusNormPayment, "Confirmed", StringComparison.OrdinalIgnoreCase);
                    }
                    @if (isConfirmedPayment)
                    {
                        // ĐỒNG BỘ: Kiểm tra chưa thanh toán - logic giống Admin
                        var paymentStatusLowerCheck = (Model.PaymentStatus ?? string.Empty).ToLower().Trim();
                        var isUnpaid = string.IsNullOrEmpty(Model.PaymentStatus) || 
                                     paymentStatusLowerCheck == "chưa xác định" ||
                                     paymentStatusLowerCheck == "chua xac dinh" ||
                                     (!paymentStatusLowerCheck.Contains("paid") && 
                                      !paymentStatusLowerCheck.Contains("đã thanh toán") &&
                                      !paymentStatusLowerCheck.Contains("đã thanh toan") &&
                                      !paymentStatusLowerCheck.Contains("completed") &&
                                      paymentStatusLowerCheck != "00");
                        
                        if (isUnpaid)
                        {
                            // QUAN TRỌNG: Timer PHẢI bắt đầu từ ConfirmedAt (thời gian provider xác nhận)
                            // Không dùng CreatedAt cho Confirmed booking - timer chỉ bắt đầu từ khi xác nhận
                            var defaultCancelMinutes = (int)(ViewBag.DefaultCancelMinutes ?? 30);
                            var cancelMinutes = Model.AutoCancelMinutes ?? defaultCancelMinutes; // Sử dụng AutoCancelMinutes từ model, dùng giá trị từ system settings nếu null
                            DateTime validConfirmedAt;
                            
                            // PHẢI dùng ConfirmedAt từ database (để đồng bộ với admin)
                            // Khi provider xác nhận đơn, ConfirmedAt được lưu vào database ngay lập tức
                            if (Model.ConfirmedAt.HasValue && 
                                Model.ConfirmedAt.Value != default(DateTime) && 
                                Model.ConfirmedAt.Value != DateTime.MinValue && 
                                Model.ConfirmedAt.Value.Year > 2000)
                            {
                                // Dùng ConfirmedAt từ database (thời gian provider xác nhận)
                                validConfirmedAt = Model.ConfirmedAt.Value;
                            }
                            else if (Model.CreatedAt != default(DateTime) && 
                                    Model.CreatedAt != DateTime.MinValue && 
                                    Model.CreatedAt.Year > 2000)
                                {
                                // Fallback: Dùng CreatedAt nếu không có ConfirmedAt (không nên xảy ra)
                                    validConfirmedAt = Model.CreatedAt;
                                }
                                else
                                {
                                // Fallback cuối cùng: Dùng thời gian hiện tại (không nên xảy ra với Confirmed booking)
                                // Nếu đến đây, có thể booking chưa được confirm đúng cách
                                    validConfirmedAt = DateTime.Now;
                            }
                            
                            // QUAN TRỌNG: Tính cancelTime từ ConfirmedAt + cancelMinutes (KHÔNG phải CreatedAt)
                            // cancelTime = ConfirmedAt (thời gian xác nhận) + autoCancelMinutes
                            // ĐỒNG BỘ: Dùng cùng format với Admin để đảm bảo timezone nhất quán
                            var cancelTime = validConfirmedAt.AddMinutes(cancelMinutes);
                            var confirmedAtStr = Model.ConfirmedAt.HasValue && 
                                                Model.ConfirmedAt.Value != default(DateTime) && 
                                                Model.ConfirmedAt.Value != DateTime.MinValue && 
                                                Model.ConfirmedAt.Value.Year > 2000 
                                                ? Model.ConfirmedAt.Value.ToString("yyyy-MM-ddTHH:mm:ss") 
                                                : validConfirmedAt.ToString("yyyy-MM-ddTHH:mm:ss");
                            <div class="alert alert-warning mt-3 mb-0">
                                <div class="mb-2">
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy (chưa thanh toán):</strong>
                                </div>
                                <div class="countdown-timer-confirmed-unpaid text-danger fw-bold" 
                                     data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-booking-id="@Model.BookingId"
                                     data-confirmed-at="@confirmedAtStr"
                                     data-auto-cancel-minutes="@(Model.AutoCancelMinutes?.ToString() ?? "")"
                                     data-use-localstorage="false"
                                     style="font-size: 1.1rem;">
                                    Đang tính...
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="card-block p-3 h-100 mb-4">
                <div class="h6">Tiến trình dịch vụ</div>
                <div class="timeline">
                    @* Timeline hiển thị từ trên xuống (grid), nên sắp xếp giảm dần (mới nhất trước) để:
                       - Item đầu tiên (CHECK OUT - mới nhất) ở trên cùng
                       - Item cuối cùng (CREATED - cũ nhất) ở dưới cùng *@
                    @foreach (var e in (Model?.Timeline ?? new List<VHS_frontend.Areas.Provider.Models.Booking.TrackingEventDTO>()).OrderByDescending(t => t.Time))
                        {
                            var code = (e.Code ?? "").Trim().ToUpperInvariant();

                            // Cho CONFIRMED, INPROGRESS, COMPLETED, CHECK IN, CHECK OUT đều hiện ảnh + staff
                            var onlyShowProofFor = code == "CONFIRMED"
                            || code == "INPROGRESS"
                            || code == "COMPLETED"
                            || code == "CHECK IN"
                            || code == "CHECK OUT";

                            var showStaffFor = code == "CONFIRMED"
                            || code == "INPROGRESS"
                            || code == "COMPLETED"
                            || code == "CHECK IN"
                            || code == "CHECK OUT";

                            var staffName = string.IsNullOrWhiteSpace(Model?.StaffName) ? null : Model!.StaffName;
                            var staffImageRaw = string.IsNullOrWhiteSpace(Model?.StaffImage) ? "/images/staff-placeholder.png" : Model!.StaffImage!;
                            var staffImage = ToUrl(staffImageRaw);

                            <div class="tl-item">
                                <div class="fw-semibold">@e.Title</div>
                                <div class="text-muted small">@(e.Time.ToString("dd-MM-yyyy HH:mm"))</div>

                                @if (code == "CREATED" && (Model?.TotalAmount ?? 0m) > 0)
                                {
                                    <div class="small text-success">Đã thanh toán: <b>@Model.TotalAmount.ToString("N0") VND</b></div>
                                }

                                @if (showStaffFor && !string.IsNullOrWhiteSpace(staffName))
                                {
                                    <div class="staff">
                                        <img src="@staffImage"
                                             alt="Ảnh @staffName"
                                             class="zoomable"
                                             loading="lazy"
                                             decoding="async"
                                             onerror="this.onerror=null;this.src='@fallbackImg';" />
                                        <div class="meta">
                                            <div class="fw-semibold">@staffName</div>
                                            <div class="role">Nhân viên phụ trách</div>
                                        </div>
                                    </div>
                                }

                                @if (!string.IsNullOrWhiteSpace(e.Description))
                                {
                                    <div class="small">@e.Description</div>
                                }

                                @if (onlyShowProofFor && (e.Proofs?.Any() == true))
                                {
                                    <div class="proofs mt-2">
                                        @foreach (var p in e.Proofs)
                                        {
                                            if ((p.MediaType ?? "image").ToLower() == "image")
                                            {
                                                var src = !string.IsNullOrWhiteSpace(p.Url) ? p.Url : fallbackImg;
                                                <img src="@src"
                                                     alt="@p.Caption"
                                                     class="zoomable"
                                                     loading="lazy"
                                                     decoding="async"
                                                     onerror="this.onerror=null;this.src='@fallbackImg';" />
                                            }
                                            else
                                            {
                                                <a class="btn btn-sm btn-outline-secondary" href="@p.Url" target="_blank" rel="noopener">
                                                    <i class="bi bi-play-circle"></i> Xem video
                                                </a>
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        }

                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/provider-timeline.css" asp-append-version="true" />
    <style>
        /* Service Completed Status Badge - Màu xanh dương nhạt để phân biệt với Completed */
        .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 1px solid #6366f1 !important;
            font-weight: 800 !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Rejected Badge */
        .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
            color: #000000 !important;
            border: 1px solid #ef4444 !important;
            font-weight: 800 !important;
        }
        
        .dark .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
        }
        
        /* Payment Refunded Badge */
        .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            color: #000000 !important;
            border: 1px solid #f59e0b !important;
            font-weight: 800 !important;
        }
        
        .dark .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(251, 191, 36, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3) !important;
        }
        
        /* Provider Cancel Modal - Màu cam đồng bộ với theme Provider */
        #cancelReasonModal .modal-content {
            border: 2px solid #f59e0b !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.2) !important;
            overflow: hidden !important;
        }
        
        .dark #cancelReasonModal .modal-content {
            background: var(--card) !important;
            border-color: #f59e0b !important;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3) !important;
        }
        
        /* Modal Header - Màu cam gradient */
        .provider-cancel-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15) !important;
            padding: 1.25rem 1.5rem !important;
        }
        
        .provider-cancel-modal-header .modal-title {
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 1.25rem !important;
            letter-spacing: 0.3px !important;
        }
        
        .provider-cancel-modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%) !important;
            opacity: 0.9 !important;
            transition: opacity 0.2s ease !important;
        }
        
        .provider-cancel-modal-header .btn-close:hover {
            opacity: 1 !important;
        }
        
        .dark .provider-cancel-modal-header {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(217, 119, 6, 0.95) 100%) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Modal Body - Spacing và styling hiện đại */
        .provider-cancel-modal-body {
            padding: 1.5rem !important;
            background: #ffffff !important;
        }
        
        .dark .provider-cancel-modal-body {
            background: var(--card) !important;
        }
        
        /* Warning Alert - Styling hiện đại */
        .provider-cancel-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            border: 1px solid #f59e0b !important;
            border-left: 4px solid #f59e0b !important;
            border-radius: 8px !important;
            padding: 1rem !important;
            margin-bottom: 1.5rem !important;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1) !important;
        }
        
        .dark .provider-cancel-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%) !important;
            border-color: #f59e0b !important;
            color: var(--fg) !important;
        }
        
        /* Form Group */
        .provider-cancel-form-group {
            margin-bottom: 0 !important;
        }
        
        /* Label - Styling hiện đại */
        .provider-cancel-label {
            font-size: 0.875rem !important;
            font-weight: 700 !important;
            letter-spacing: 0.5px !important;
            text-transform: uppercase !important;
            color: var(--fg) !important;
            margin-bottom: 0.75rem !important;
        }
        
        /* Textarea - Styling hiện đại */
        .provider-cancel-textarea {
            border: 2px solid var(--border) !important;
            border-radius: 8px !important;
            padding: 0.875rem 1rem !important;
            font-size: 0.9375rem !important;
            line-height: 1.6 !important;
            transition: all 0.2s ease !important;
            resize: vertical !important;
        }
        
        .provider-cancel-textarea:focus {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
            outline: none !important;
        }
        
        .dark .provider-cancel-textarea {
            background: var(--muted) !important;
            border-color: var(--border) !important;
            color: var(--fg) !important;
        }
        
        .dark .provider-cancel-textarea:focus {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2) !important;
        }
        
        /* Info và Counter */
        .provider-cancel-info {
            font-size: 0.8125rem !important;
        }
        
        .provider-cancel-counter {
            font-size: 0.8125rem !important;
            font-weight: 500 !important;
        }
        
        /* Modal Footer - Căn giữa và spacing */
        .provider-cancel-modal-footer {
            border-top: 2px solid var(--border) !important;
            padding: 1.25rem 1.5rem !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            gap: 1rem !important;
            background: var(--muted) !important;
        }
        
        .dark .provider-cancel-modal-footer {
            background: var(--muted) !important;
            border-top-color: var(--border) !important;
        }
        
        /* Buttons - Cùng chiều cao, căn giữa, styling hiện đại */
        .provider-cancel-btn-cancel,
        .provider-cancel-btn-submit {
            min-width: 140px !important;
            height: 44px !important;
            padding: 0.625rem 1.5rem !important;
            font-weight: 600 !important;
            font-size: 0.9375rem !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            border: 2px solid transparent !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        .provider-cancel-btn-cancel {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: #ffffff !important;
        }
        
        .provider-cancel-btn-cancel:hover {
            background-color: #5a6268 !important;
            border-color: #545b62 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3) !important;
        }
        
        .provider-cancel-btn-cancel:active {
            transform: translateY(0) !important;
        }
        
        .provider-cancel-btn-submit {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: #ffffff !important;
        }
        
        .provider-cancel-btn-submit:hover {
            background-color: #c82333 !important;
            border-color: #bd2130 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
        }
        
        .provider-cancel-btn-submit:active {
            transform: translateY(0) !important;
        }
        
        
    </style>
}

@section Scripts {
    <script>
        const bookingId = '@Model.BookingId';

        function showStatusMessage(message, type) {
            const messageDiv = document.getElementById('statusUpdateMessage');
            const messageText = document.getElementById('statusUpdateMessageText');
            
            if (!messageDiv || !messageText) return;
            
            // Xóa các class cũ
            messageDiv.className = 'alert mb-3';
            messageDiv.classList.add('alert-' + type);
            
            // Set nội dung
            messageText.innerHTML = message;
            
            // Hiển thị
            messageDiv.classList.remove('d-none');
            
            // Scroll vào view
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Tự động ẩn sau 5 giây nếu là thông báo thành công
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 5000);
            }
        }

        // Lưu trạng thái ban đầu để revert nếu có lỗi
        let originalStatus = '@Model.Status';
        let originalStatusHtml = null;
        let originalButtonsHtml = null;

        // Cập nhật UI ngay lập tức (optimistic update)
        function updateUIOptimistically(newStatus) {
            // Lưu trạng thái ban đầu
            const statusBadge = document.querySelector('.status-badge-lg');
            if (statusBadge) {
                originalStatusHtml = statusBadge.outerHTML;
            }
            
            const actionButtons = document.querySelector('.action-buttons');
            if (actionButtons) {
                originalButtonsHtml = actionButtons.innerHTML;
            }
            
            // Cập nhật status badge ngay lập tức
            if (statusBadge && newStatus === 'Confirmed') {
                statusBadge.className = 'status-badge-lg status-confirmed';
                statusBadge.textContent = 'Đã xác nhận';
            } else if (statusBadge && newStatus === 'Canceled') {
                statusBadge.className = 'status-badge-lg status-canceled';
                statusBadge.textContent = 'Đã hủy';
            }
            
            // Ẩn action buttons ngay lập tức
            if (actionButtons) {
                actionButtons.innerHTML = '<button type="button" class="btn btn-confirm btn-lg" disabled><i class="bi bi-hourglass-split"></i> Đang xử lý...</button>';
            }
            
            // Hiển thị thông báo thành công ngay lập tức
            showStatusMessage(
                '<i class="bi bi-hourglass-split me-2"></i><strong>Đang xử lý...</strong>',
                'info'
            );
        }
        
        // Revert UI về trạng thái ban đầu nếu có lỗi
        function revertUI() {
            const statusBadge = document.querySelector('.status-badge-lg');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (statusBadge && originalStatusHtml) {
                statusBadge.outerHTML = originalStatusHtml;
            }
            
            if (actionButtons && originalButtonsHtml) {
                actionButtons.innerHTML = originalButtonsHtml;
            }
        }

        function updateStatus(newStatus) {
            
            // Ẩn thông báo cũ
            const messageDiv = document.getElementById('statusUpdateMessage');
            if (messageDiv) {
                messageDiv.classList.add('d-none');
            }
            
            // Nếu xác nhận đơn hàng, kiểm tra xem có nhân viên nào không bị xóa không
            if (newStatus === 'Confirmed') {
                const staffSelect = document.getElementById('staffSelect');
                let availableStaffCount = 0;
                
                if (staffSelect) {
                    // Đếm số nhân viên không bị xóa trong dropdown
                    for (let i = 0; i < staffSelect.options.length; i++) {
                        const option = staffSelect.options[i];
                        if (option.value && option.getAttribute('data-deleted') !== 'true') {
                            availableStaffCount++;
                        }
                    }
                }
                
                // Nếu không có nhân viên nào, hiển thị thông báo và dừng
                if (availableStaffCount === 0) {
                    showStatusMessage(
                        '<i class="bi bi-exclamation-triangle me-2"></i><strong>Không có nhân viên nào để phân công.</strong><br>' +
                        'Vui lòng thêm nhân viên hoặc mở khóa nhân viên trong phần "Quản lí nhân viên" trước khi xác nhận đơn hàng.',
                        'warning'
                    );
                    return;
                }
            }
            
            // Cập nhật UI ngay lập tức (optimistic update)
            updateUIOptimistically(newStatus);
            
            // Nếu xác nhận đơn hàng, lấy staffId từ dropdown (nếu có)
            let selectedStaffId = null;
            if (newStatus === 'Confirmed') {
                const staffSelect = document.getElementById('staffSelect');
                if (staffSelect && staffSelect.value) {
                    selectedStaffId = staffSelect.value;
                }
            }
            
            const payload = {
                bookingId: bookingId,
                newStatus: newStatus,
                reason: null,
                selectedStaffId: selectedStaffId  // Gửi staffId đã chọn (nếu có)
            };
            

            fetch('/Provider/Order/UpdateStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('[ERROR] Response error:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Cập nhật UI ngay lập tức, không cần reload
                    showStatusMessage(
                        '<i class="bi bi-check-circle me-2"></i><strong>' + data.message + '</strong>',
                        'success'
                    );
                    
                    // Cập nhật UI ngay lập tức cho Confirmed status
                    if (newStatus === 'Confirmed') {
                        // Cập nhật status badge
                        const statusBadge = document.querySelector('.status-badge-lg');
                        if (statusBadge) {
                            statusBadge.className = 'status-badge-lg status-confirmed';
                            statusBadge.textContent = 'Đã xác nhận';
                        }
                        
                        // Ẩn action buttons
                        const actionButtons = document.querySelector('.action-buttons');
                        if (actionButtons) {
                            actionButtons.innerHTML = '';
                        }
                        
                        // Trigger refresh NGAY LẬP TỨC - không chờ
                        if (typeof refreshBookingDetail === 'function') {
                            refreshBookingDetail(); // Refresh ngay, không delay
                        }
                    }
                } else {
                    // Revert UI về trạng thái ban đầu
                    revertUI();
                    
                    // Kiểm tra nếu là lỗi không có nhân viên
                    let errorMessage = data.message || 'Có lỗi xảy ra khi cập nhật trạng thái';
                    let messageType = 'danger';
                    
                    if (errorMessage.toLowerCase().includes('nhân viên') || 
                        errorMessage.toLowerCase().includes('staff') ||
                        errorMessage.toLowerCase().includes('không có') ||
                        errorMessage.toLowerCase().includes('no staff') ||
                        errorMessage.toLowerCase().includes('available')) {
                        errorMessage = '<i class="bi bi-exclamation-triangle me-2"></i><strong>Không có nhân viên nào để phân công.</strong><br>' +
                                      'Vui lòng thêm nhân viên hoặc mở khóa nhân viên trong phần "Quản lí nhân viên" trước khi xác nhận đơn hàng.';
                        messageType = 'warning';
                    } else {
                        errorMessage = '<i class="bi bi-exclamation-circle me-2"></i>' + errorMessage;
                    }
                    
                    showStatusMessage(errorMessage, messageType);
                }
            })
            .catch(error => {
                console.error('[ERROR] Catch error:', error);
                // Revert UI về trạng thái ban đầu
                revertUI();
                
                showStatusMessage(
                    '<i class="bi bi-exclamation-circle me-2"></i>Có lỗi xảy ra: ' + error.message,
                    'danger'
                );
            });
        }

        function updateCharCount() {
            const textarea = document.getElementById('cancelReason');
            const charCount = document.getElementById('charCount');
            charCount.textContent = textarea.value.length;
            
            // Đổi màu nếu chưa đủ 10 ký tự
            if (textarea.value.length < 10) {
                charCount.classList.add('text-danger');
                charCount.classList.remove('text-success');
            } else {
                charCount.classList.add('text-success');
                charCount.classList.remove('text-danger');
            }
        }

        function cancelOrder() {
            
            // Reset form
            document.getElementById('cancelReason').value = '';
            updateCharCount(); // Reset counter
            
            // Mở modal thay vì dùng prompt()
            const modal = new bootstrap.Modal(document.getElementById('cancelReasonModal'));
            modal.show();
        }

        function submitCancelReason() {
            const textarea = document.getElementById('cancelReason');
            const reason = textarea.value.trim();
            
            // Validation
            if (!reason) {
                alert('⚠️ Vui lòng nhập lý do từ chối đơn hàng!');
                return;
            }
            
            if (reason.length < 10) {
                alert('⚠️ Lý do từ chối phải có ít nhất 10 ký tự! (Hiện tại: ' + reason.length + ' ký tự)');
                return;
            }
            
            if (reason.length > 500) {
                alert('⚠️ Lý do từ chối không được quá 500 ký tự!');
                return;
            }

            // Tạo payload
            const payload = {
                bookingId: bookingId,
                newStatus: 'Canceled',
                reason: reason
            };

            // Đóng modal
            const modalElement = document.getElementById('cancelReasonModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }

            // Cập nhật UI ngay lập tức (optimistic update)
            updateUIOptimistically('Canceled');

            // Gửi request
            fetch('/Provider/Order/UpdateStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('[SUBMIT CANCEL] Error:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showStatusMessage(
                        '<i class="bi bi-check-circle me-2"></i><strong>' + data.message + '</strong>',
                        'success'
                    );
                    // Cập nhật UI ngay lập tức, không cần reload
                    // Cập nhật status badge thành Canceled
                    const statusBadge = document.querySelector('.status-badge-lg');
                    if (statusBadge) {
                        statusBadge.className = 'status-badge-lg status-canceled';
                        statusBadge.textContent = 'Đã hủy';
                    }
                    
                    // Ẩn action buttons
                    const actionButtons = document.querySelector('.action-buttons');
                    if (actionButtons) {
                        actionButtons.innerHTML = '';
                    }
                    
                    // Ẩn countdown timer nếu có
                    const confirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
                    if (confirmedTimer) {
                        confirmedTimer.style.display = 'none';
                    }
                    
                    // Trigger refresh NGAY LẬP TỨC - không chờ
                    if (typeof refreshBookingDetail === 'function') {
                        refreshBookingDetail(); // Refresh ngay, không delay
                    }
                } else {
                    // Revert UI về trạng thái ban đầu
                    revertUI();
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[SUBMIT CANCEL] Error:', error);
                // Revert UI về trạng thái ban đầu
                revertUI();
                alert('❌ Có lỗi xảy ra: ' + error.message);
            });
        }

        function showStaffMessage(message, type) {
            const messageDiv = document.getElementById('staffAssignmentMessage');
            const messageText = document.getElementById('staffAssignmentMessageText');
            
            if (!messageDiv || !messageText) return;
            
            // Xóa các class cũ
            messageDiv.className = 'alert';
            messageDiv.classList.add('alert-' + type);
            
            // Set nội dung
            messageText.innerHTML = message;
            
            // Hiển thị
            messageDiv.classList.remove('d-none');
            
            // Scroll vào view
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Tự động ẩn sau 5 giây nếu là thông báo thành công
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 5000);
            }
        }

        function assignStaff() {
            
            // Ẩn thông báo cũ
            const messageDiv = document.getElementById('staffAssignmentMessage');
            if (messageDiv) {
                messageDiv.classList.add('d-none');
            }
            
            // Kiểm tra trạng thái booking
            const bookingStatus = '@Model.Status'.trim().toLowerCase();
            
            // Kiểm tra xem có event CHECK IN trong timeline không
            const timelineItems = @Html.Raw(Json.Serialize(Model?.Timeline ?? new List<VHS_frontend.Areas.Provider.Models.Booking.TrackingEventDTO>()));
            const hasCheckedIn = timelineItems && timelineItems.some(e => {
                const code = (e.code || '').trim().toUpperCase();
                return code === 'CHECK IN';
            });
            
            // Không cho phép gán khi đã check-in
            if (hasCheckedIn) {
                showStaffMessage(
                    '<i class="bi bi-check-circle me-2"></i><strong>Nhân viên đã bắt đầu làm việc (đã check-in).</strong><br>' +
                    'Không thể thay đổi phân công nhân viên khi nhân viên đã bắt đầu làm việc.',
                    'info'
                );
                return;
            }
            
            // Chỉ cho phép gán khi status là Confirmed
            if (bookingStatus !== 'confirmed') {
                if (bookingStatus === 'pending') {
                    showStaffMessage(
                        '<i class="bi bi-info-circle me-2"></i><strong>Đơn hàng đang ở trạng thái chờ xử lý.</strong><br>' +
                        'Vui lòng xác nhận đơn hàng trước khi phân công nhân viên.<br>' +
                        '<small>Bạn có thể: 1) Chọn nhân viên, sau đó nhấn "Xác nhận đơn hàng" - hệ thống sẽ gán nhân viên bạn chọn. 2) Nhấn "Xác nhận đơn hàng" trực tiếp - hệ thống sẽ tự động gán nhân viên rảnh có ít công việc nhất.</small>',
                        'info'
                    );
                } else if (bookingStatus === 'service completed' || bookingStatus === 'service-completed') {
                    showStaffMessage(
                        '<i class="bi bi-hourglass-split me-2"></i><strong>Đơn hàng đang chờ khách hàng xác nhận.</strong><br>' +
                        'Không thể phân công nhân viên cho đơn hàng đã hoàn thành và đang chờ khách hàng xác nhận.',
                        'info'
                    );
                } else if (bookingStatus === 'completed' || bookingStatus === 'cancelled' || bookingStatus === 'canceled') {
                    showStaffMessage(
                        '<i class="bi bi-exclamation-triangle me-2"></i>Không thể phân công nhân viên cho đơn hàng đã hoàn thành hoặc đã hủy.',
                        'warning'
                    );
                } else {
                    showStaffMessage(
                        '<i class="bi bi-exclamation-triangle me-2"></i>Chỉ có thể phân công nhân viên cho đơn hàng đã được xác nhận.',
                        'warning'
                    );
                }
                return;
            }
            
            const staffSelect = document.getElementById('staffSelect');
            
            // Kiểm tra nếu select bị disabled
            if (staffSelect.disabled) {
                showStaffMessage(
                    '<i class="bi bi-exclamation-triangle me-2"></i>Không thể phân công nhân viên cho đơn hàng này.',
                    'warning'
                );
                return;
            }
            
            const staffId = staffSelect.value;
            
            
            if (!staffId || staffId === '') {
                showStaffMessage(
                    '<i class="bi bi-exclamation-triangle me-2"></i>Vui lòng chọn nhân viên',
                    'warning'
                );
                return;
            }
            
            // Kiểm tra xem nhân viên có bị xóa không
            const selectedOption = staffSelect.options[staffSelect.selectedIndex];
            const isDeleted = selectedOption.getAttribute('data-deleted') === 'true';
            
            if (isDeleted) {
                showStaffMessage(
                    '<i class="bi bi-trash me-2"></i><strong>Nhân viên này đã bị xóa.</strong><br>Vui lòng chọn nhân viên khác.',
                    'warning'
                );
                return;
            }

            const payload = {
                bookingId: bookingId,
                staffId: staffId
            };
            

            fetch('/Provider/Order/AssignStaff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('[ERROR] Response error:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                    if (data.success) {
                        showStaffMessage(
                            '<i class="bi bi-check-circle me-2"></i><strong>' + data.message + '</strong>',
                            'success'
                        );
                        // Cập nhật UI ngay lập tức - KHÔNG CHỜ
                        if (typeof refreshBookingDetail === 'function') {
                            refreshBookingDetail(); // Refresh ngay, không delay
                        }
                    } else {
                    // Kiểm tra nếu là lỗi nhân viên bị xóa
                    let errorMessage = data.message || 'Có lỗi xảy ra khi phân công nhân viên';
                    let messageType = 'danger';
                    
                    if (errorMessage.toLowerCase().includes('xóa') || 
                        errorMessage.toLowerCase().includes('deleted') ||
                        errorMessage.toLowerCase().includes('khóa') || 
                        errorMessage.toLowerCase().includes('locked') ||
                        errorMessage.toLowerCase().includes('disabled') ||
                        errorMessage.toLowerCase().includes('inactive')) {
                        errorMessage = '<i class="bi bi-trash me-2"></i><strong>Nhân viên này đã bị xóa hoặc khóa.</strong><br>Vui lòng chọn nhân viên khác.';
                        messageType = 'warning';
                    } else {
                        errorMessage = '<i class="bi bi-exclamation-circle me-2"></i>' + errorMessage;
                    }
                    
                    showStaffMessage(errorMessage, messageType);
                }
            })
            .catch(error => {
                console.error('[ERROR] Catch error:', error);
                showStaffMessage(
                    '<i class="bi bi-exclamation-circle me-2"></i>Có lỗi xảy ra: ' + error.message,
                    'danger'
                );
            });
        }

        // ========== Countdown Timer ==========
        let currentBookingStatus = '@Model.Status';
        
        // AutoCancelManager cho Details page - TỐI ƯU
        const AutoCancelManager = {
            inProgress: false,
            originalUIState: null,
            
            // Lưu trạng thái UI ban đầu để revert nếu cần
            saveUIState() {
                this.originalUIState = {
                    statusBadge: document.querySelector('.status-badge-lg')?.outerHTML,
                    actionButtons: document.querySelector('.action-buttons')?.outerHTML,
                    countdownTimer: document.querySelector('.countdown-timer-detail, .countdown-timer-confirmed-unpaid')?.outerHTML
                };
            },
            
            // Cập nhật UI ngay lập tức (optimistic update)
            updateUIImmediately() {
                // Cập nhật status badge thành "Đã hủy"
                const statusBadge = document.querySelector('.status-badge-lg');
                if (statusBadge) {
                    statusBadge.className = 'status-badge-lg status-canceled';
                    statusBadge.textContent = 'Đã hủy';
                }
                
                // Ẩn countdown timer
                const countdownTimer = document.querySelector('.countdown-timer-detail, .countdown-timer-confirmed-unpaid');
                if (countdownTimer) {
                    countdownTimer.style.display = 'none';
                }
                
                // Ẩn action buttons
                const actionButtons = document.querySelector('.action-buttons');
                if (actionButtons) {
                    actionButtons.innerHTML = '';
                }
                
                // Hiển thị thông báo đã hủy
                const statusCard = document.querySelector('.status-card .card-body');
                if (statusCard) {
                    const existingAlert = statusCard.querySelector('.alert-danger');
                    if (!existingAlert) {
                        const cancelAlert = document.createElement('div');
                        cancelAlert.className = 'alert alert-danger';
                        cancelAlert.innerHTML = `
                            <h5 class="alert-heading">
                                <i class="bi bi-x-circle-fill"></i>
                                <strong>Đơn hàng này đã được hủy tự động</strong>
                            </h5>
                            <p class="mb-0">Đơn hàng đã hết thời gian chờ và được hủy tự động.</p>
                        `;
                        statusCard.insertBefore(cancelAlert, statusCard.firstChild);
                    }
                }
            },
            
            // Revert UI về trạng thái ban đầu nếu API fail
            revertUI() {
                if (!this.originalUIState) return;
                
                const statusBadge = document.querySelector('.status-badge-lg');
                if (statusBadge && this.originalUIState.statusBadge) {
                    statusBadge.outerHTML = this.originalUIState.statusBadge;
                }
                
                const actionButtons = document.querySelector('.action-buttons');
                if (actionButtons && this.originalUIState.actionButtons) {
                    actionButtons.outerHTML = this.originalUIState.actionButtons;
                }
                
                const countdownTimer = document.querySelector('.countdown-timer-detail, .countdown-timer-confirmed-unpaid');
                if (countdownTimer && this.originalUIState.countdownTimer) {
                    countdownTimer.outerHTML = this.originalUIState.countdownTimer;
                }
            },
            
            async call(isPendingExpired) {
                if (this.inProgress) {
                    return Promise.resolve();
                }
                
                this.inProgress = true;
                
                // Lưu trạng thái UI ban đầu
                this.saveUIState();
                
                // Cập nhật UI ngay lập tức (optimistic update)
                this.updateUIImmediately();
                
                try {
                    const bookingIdStr = String(bookingId).trim();
                    if (!bookingIdStr || bookingIdStr === 'undefined' || bookingIdStr === 'null') {
                        throw new Error('Invalid bookingId');
                    }
                    
                    // Tạo AbortController để có thể timeout - GIẢM XUỐNG 3 GIÂY
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); // Timeout 3 giây (đủ nhanh)
                    
                    try {
                        const response = await fetch('/Provider/Order/AutoCancel', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                            },
                            body: JSON.stringify({
                                bookingId: bookingIdStr,
                                isPendingExpired: isPendingExpired
                            }),
                            signal: controller.signal // Thêm signal để có thể abort
                        });
                        
                        clearTimeout(timeoutId);
                        
                        // QUAN TRỌNG: Kiểm tra cả HTTP status VÀ response body
                        const responseText = await response.text();
                        
                        if (!response.ok) {
                            throw new Error(`Auto-cancel failed: ${response.status} - ${responseText}`);
                        }
                        
                        // Parse JSON response để kiểm tra success flag
                        let result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            // Nếu không phải JSON, coi như thành công nếu HTTP status OK
                            console.log('[AUTO CANCEL] Response is not JSON, treating as success');
                            // Refresh ngay lập tức - KHÔNG CHỜ
                            if (typeof refreshBookingDetail === 'function') {
                                refreshBookingDetail();
                            }
                            return;
                        }
                        
                        // KIỂM TRA success flag trong response body
                        if (result && result.success === true) {
                            // API thành công - UI đã được cập nhật trước đó, refresh NGAY LẬP TỨC
                            console.log('[AUTO CANCEL] ✅ Success - Refreshing to sync data');
                            if (typeof refreshBookingDetail === 'function') {
                                refreshBookingDetail(); // KHÔNG CHỜ - refresh ngay
                            }
                        } else {
                            // API trả về nhưng success = false - revert UI
                            throw new Error(result?.message || 'Auto-cancel failed: Backend reported failure');
                        }
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('Request timeout - Vui lòng thử lại');
                        }
                        throw fetchError;
                    }
                } catch (error) {
                    console.error('[AUTO CANCEL] ❌ Error:', error);
                    
                    // Revert UI về trạng thái ban đầu
                    this.revertUI();
                    
                    // Hiển thị thông báo lỗi
                    const timer = document.querySelector('.countdown-timer-detail, .countdown-timer-confirmed-unpaid');
                    if (timer) {
                        timer.innerHTML = '<span class="text-danger fw-bold">Lỗi khi hủy đơn. Vui lòng thử lại.</span>';
                        timer.style.display = 'block';
                    }
                    
                    this.inProgress = false;
                    
                    // Thử refresh NGAY để lấy trạng thái thực tế từ server
                    if (typeof refreshBookingDetail === 'function') {
                        refreshBookingDetail(); // Refresh ngay, không chờ
                    }
                    
                    throw error;
                }
            }
        };
        
        // Function countdown đơn giản - đồng bộ với Admin và Index
        function updateCountdown(timerSelector) {
            const timer = document.querySelector(timerSelector);
            if (!timer) return;
            
            // Dùng data-cancel-time đã được server tính sẵn từ ConfirmedAt (hoặc CreatedAt)
            const cancelTimeStr = timer.getAttribute('data-cancel-time');
            const confirmedAtStr = timer.getAttribute('data-confirmed-at');
            const bookingId = timer.getAttribute('data-booking-id');
            
            if (!cancelTimeStr) {
                timer.innerHTML = '<span class="text-danger">Đang tải...</span>';
                return;
            }
            
            // Parse cancelTime - đơn giản, nhất quán
            let cancelTime;
            try {
                // ĐỒNG BỘ: Parse trực tiếp - JavaScript tự động xử lý timezone
                // Đảm bảo format "yyyy-MM-ddTHH:mm:ss" được parse đúng
                cancelTime = new Date(cancelTimeStr);
                
                if (isNaN(cancelTime.getTime())) {
                    timer.innerHTML = '<span class="text-danger">Lỗi thời gian</span>';
                    console.error('[Provider Countdown] Invalid cancelTime:', cancelTimeStr);
                    return;
                }
            } catch (e) {
                timer.innerHTML = '<span class="text-danger">Lỗi thời gian</span>';
                console.error('[Provider Countdown] Parse error:', e, 'cancelTimeStr:', cancelTimeStr);
                return;
            }
            
            const now = new Date();
            const diff = cancelTime - now;
            
            // Debug: Log mỗi 10 giây để theo dõi
            if (timerSelector === '.countdown-timer-confirmed-unpaid') {
                const logKey = `lastLog_${bookingId}`;
                const lastLog = window[logKey] || 0;
                if (now.getTime() - lastLog > 10000) { // Log mỗi 10 giây
                    console.log('[Provider Countdown] Update:', {
                        bookingId: bookingId,
                        cancelTimeStr: cancelTimeStr,
                        cancelTimeISO: cancelTime.toISOString(),
                        confirmedAtStr: confirmedAtStr,
                        nowISO: now.toISOString(),
                        diffMs: diff,
                        diffSeconds: Math.floor(diff / 1000),
                        diffMinutes: Math.floor(diff / 60000)
                    });
                    window[logKey] = now.getTime();
                }
            }
            
            if (diff <= 0) {
                // Đã quá thời gian hủy
                
                // Kiểm tra xem đã hủy chưa (tránh gọi API nhiều lần)
                const statusBadge = document.querySelector('.status-badge-lg');
                const isAlreadyCanceled = statusBadge && (
                    statusBadge.classList.contains('status-canceled') ||
                    statusBadge.textContent.includes('hủy') ||
                    statusBadge.textContent.includes('Hủy')
                );
                
                if (isAlreadyCanceled) {
                    // Đã hủy rồi, không cần làm gì
                    timer.innerHTML = '<span class="text-danger fw-bold">Đã hủy</span>';
                    timer.style.display = 'none';
                    return;
                }
                
                if (AutoCancelManager.inProgress) {
                    timer.innerHTML = '<span class="text-warning fw-bold">Đang xử lý...</span>';
                    timer.classList.add('text-warning');
                    return;
                }
                
                // TỐI ƯU: Xác định isPendingExpired dựa vào loại timer
                // - .countdown-timer-detail = Pending booking (isPendingExpired = true)
                // - .countdown-timer-confirmed-unpaid = Confirmed booking (isPendingExpired = false)
                const isPendingExpired = timerSelector === '.countdown-timer-detail';
                
                console.log('[AUTO CANCEL] Timer expired:', {
                    timerSelector: timerSelector,
                    isPendingExpired: isPendingExpired,
                    bookingId: bookingId
                });
                
                // Gọi API ngay - UI sẽ được cập nhật ngay lập tức trong AutoCancelManager
                AutoCancelManager.call(isPendingExpired).catch(error => {
                    // Error đã được xử lý trong AutoCancelManager
                    console.error('[AUTO CANCEL] Error in countdown:', error);
                });
                
                // Dừng countdown timer để tránh gọi lại
                return;
            } else {
                // Tính giờ, phút, giây còn lại - format giống Index
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Format hiển thị giống Index
                let timeStr = '';
                if (hours > 0) {
                    timeStr = `${hours} giờ ${minutes} phút`;
                } else if (minutes > 0) {
                    timeStr = `${minutes} phút ${seconds} giây`;
                } else {
                    timeStr = `${seconds} giây`;
                }
                
                // Tối ưu: Chỉ cập nhật text, không thay đổi structure để tránh nhấp nháy
                const timeText = `Còn ${timeStr}`;
                const currentText = timer.textContent.trim();
                
                // Chỉ cập nhật nếu text thay đổi
                if (currentText !== timeText) {
                    // Tìm span bên trong để cập nhật text, không thay đổi structure
                    const innerSpan = timer.querySelector('span');
                    if (innerSpan) {
                        // Chỉ cập nhật text, giữ nguyên class
                        innerSpan.textContent = timeText;
                    } else {
                        // Nếu không có span, chỉ cập nhật text
                        timer.textContent = timeText;
                    }
                }
                
                // Cập nhật class màu một lần, không mỗi giây
                const shouldBeDanger = diff < 5 * 60 * 1000;
                const shouldBeWarning = diff >= 5 * 60 * 1000 && diff < 15 * 60 * 1000;
                const innerSpan = timer.querySelector('span');
                if (innerSpan) {
                    if (shouldBeDanger && !innerSpan.classList.contains('text-danger')) {
                        innerSpan.className = 'text-danger fw-bold';
                    } else if (shouldBeWarning && !innerSpan.classList.contains('text-warning')) {
                        innerSpan.className = 'text-warning fw-bold';
                    } else if (!shouldBeDanger && !shouldBeWarning && innerSpan.classList.contains('text-danger')) {
                        innerSpan.className = 'fw-bold';
                    }
                }
            }
        }
        
        // Khởi tạo countdown timer
        document.addEventListener('DOMContentLoaded', function() {
            // ĐỒNG BỘ: Debug - Log giá trị khi page load
            const confirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
            if (confirmedTimer) {
                const cancelTime = confirmedTimer.getAttribute('data-cancel-time');
                const confirmedAt = confirmedTimer.getAttribute('data-confirmed-at');
                const autoCancelMinutes = confirmedTimer.getAttribute('data-auto-cancel-minutes');
                const bookingId = confirmedTimer.getAttribute('data-booking-id');
                
                // Parse và log chi tiết để debug
                let cancelTimeDate = null;
                let confirmedAtDate = null;
                try {
                    if (cancelTime) cancelTimeDate = new Date(cancelTime);
                    if (confirmedAt) confirmedAtDate = new Date(confirmedAt);
                } catch (e) {
                    console.error('[Provider Details] Parse error:', e);
                }
                
                console.log('[Provider Details] Timer initialized:', {
                    bookingId: bookingId,
                    cancelTime: cancelTime,
                    cancelTimeDate: cancelTimeDate ? cancelTimeDate.toISOString() : null,
                    confirmedAt: confirmedAt,
                    confirmedAtDate: confirmedAtDate ? confirmedAtDate.toISOString() : null,
                    autoCancelMinutes: autoCancelMinutes,
                    currentTime: new Date().toISOString(),
                    timeUntilCancel: cancelTimeDate ? Math.floor((cancelTimeDate - new Date()) / 1000) + ' seconds' : null
                });
            }
            
            // Cập nhật countdown ngay lập tức
            updateCountdown('.countdown-timer-detail');
            updateCountdown('.countdown-timer-confirmed-unpaid');
            
            // ĐỒNG BỘ: Cập nhật timer mỗi giây (đồng bộ với Admin)
            // Sử dụng setInterval để đảm bảo cả hai trang đều cập nhật cùng lúc
            setInterval(function() {
                updateCountdown('.countdown-timer-detail');
                updateCountdown('.countdown-timer-confirmed-unpaid');
            }, 1000);
            
            // ĐỒNG BỘ: Đảm bảo timer được cập nhật ngay khi page load
            // Điều này giúp đồng bộ với Admin khi cả hai trang cùng mở
            setTimeout(function() {
                updateCountdown('.countdown-timer-detail');
                updateCountdown('.countdown-timer-confirmed-unpaid');
            }, 100);
            
            // ========== Auto-refresh để cập nhật UI ngay lập tức ==========
            let refreshInterval = null;
            let isRefreshing = false;
            
            async function refreshBookingDetail() {
                if (isRefreshing) return;
                isRefreshing = true;
                
                try {
                    const url = new URL(window.location.href);
                    url.searchParams.set('_t', Date.now().toString());
                    
                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        },
                        cache: 'no-store'
                    });
                    
                    if (!response.ok) {
                        isRefreshing = false;
                        return;
                    }
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // QUAN TRỌNG: Cập nhật status badge ngay lập tức nếu có thay đổi
                    const newStatusBadge = doc.querySelector('.status-badge-lg');
                    const currentStatusBadge = document.querySelector('.status-badge-lg');
                    if (newStatusBadge && currentStatusBadge) {
                        const newStatusText = newStatusBadge.textContent.trim();
                        const newStatusClass = newStatusBadge.className;
                        const currentStatusText = currentStatusBadge.textContent.trim();
                        
                        if (newStatusText !== currentStatusText || newStatusClass !== currentStatusBadge.className) {
                            // Status đã thay đổi - cập nhật mượt mà, không làm giật UI
                            requestAnimationFrame(() => {
                                currentStatusBadge.textContent = newStatusText;
                                currentStatusBadge.className = newStatusClass;
                                
                                // Cập nhật action buttons nếu status thay đổi (chỉ khi có thay đổi)
                                const newActionButtons = doc.querySelector('.action-buttons');
                                const currentActionButtons = document.querySelector('.action-buttons');
                                if (newActionButtons && currentActionButtons) {
                                    const newButtonsHTML = newActionButtons.innerHTML.trim();
                                    const currentButtonsHTML = currentActionButtons.innerHTML.trim();
                                    if (newButtonsHTML !== currentButtonsHTML) {
                                        currentActionButtons.innerHTML = newButtonsHTML;
                                    }
                                }
                                
                                // Cập nhật cancel reason section nếu status thay đổi (chỉ khi có thay đổi)
                                const newCancelReasonSection = doc.querySelector('.cancel-reason-section');
                                const currentCancelReasonSection = document.querySelector('.cancel-reason-section');
                                if (newCancelReasonSection && currentCancelReasonSection) {
                                    const newReasonHTML = newCancelReasonSection.innerHTML.trim();
                                    const currentReasonHTML = currentCancelReasonSection.innerHTML.trim();
                                    if (newReasonHTML !== currentReasonHTML) {
                                        currentCancelReasonSection.outerHTML = newCancelReasonSection.outerHTML;
                                    }
                                }
                                
                                // Cập nhật alert warning nếu có thay đổi
                                const newAlertWarning = doc.querySelector('.alert-warning');
                                const currentAlertWarning = document.querySelector('.alert-warning');
                                if (newAlertWarning && currentAlertWarning) {
                                    const newAlertText = newAlertWarning.textContent.trim();
                                    const currentAlertText = currentAlertWarning.textContent.trim();
                                    if (newAlertText !== currentAlertText) {
                                        currentAlertWarning.outerHTML = newAlertWarning.outerHTML;
                                        // Re-initialize countdown timer ngay lập tức
                                        updateCountdown('.countdown-timer-confirmed-unpaid'); // Không chờ, update ngay
                                    }
                                }
                            });
                        }
                    }
                    
                    // Cập nhật Payment Status nếu có thay đổi (chỉ khi thực sự thay đổi)
                    const newPaymentStatus = doc.querySelector('.payment-status-badge');
                    const currentPaymentStatus = document.querySelector('.payment-status-badge');
                    if (newPaymentStatus && currentPaymentStatus) {
                        const newPaymentText = newPaymentStatus.textContent.trim();
                        const newPaymentClass = newPaymentStatus.className;
                        const currentPaymentText = currentPaymentStatus.textContent.trim();
                        
                        if (newPaymentText !== currentPaymentText || newPaymentClass !== currentPaymentStatus.className) {
                            // Cập nhật mượt mà
                            requestAnimationFrame(() => {
                                currentPaymentStatus.textContent = newPaymentText;
                                currentPaymentStatus.className = newPaymentClass;
                            });
                        }
                    }
                    
                    // Cập nhật Payment Method nếu có thay đổi (chỉ khi thực sự thay đổi)
                    const paymentMethodRows = doc.querySelectorAll('.payment-summary .d-flex');
                    const currentPaymentMethodRows = document.querySelectorAll('.payment-summary .d-flex');
                    if (paymentMethodRows.length === currentPaymentMethodRows.length) {
                        paymentMethodRows.forEach((newRow, index) => {
                            const currentRow = currentPaymentMethodRows[index];
                            if (newRow && currentRow) {
                                const newRowText = newRow.textContent.trim();
                                const currentRowText = currentRow.textContent.trim();
                                if (newRowText !== currentRowText) {
                                    requestAnimationFrame(() => {
                                        currentRow.outerHTML = newRow.outerHTML;
                                    });
                                }
                            }
                        });
                    }
                    
                    // Cập nhật Staff Assignment Card nếu có thay đổi (chỉ khi thực sự thay đổi)
                    const allNewCards = doc.querySelectorAll('.card');
                    const allCurrentCards = document.querySelectorAll('.card');
                    allNewCards.forEach((newCard, index) => {
                        if (index < allCurrentCards.length) {
                            const currentCard = allCurrentCards[index];
                            const newCardHeader = newCard.querySelector('.card-header h5')?.textContent?.trim();
                            const currentCardHeader = currentCard.querySelector('.card-header h5')?.textContent?.trim();
                            
                            // Kiểm tra nếu là staff card hoặc các card quan trọng khác
                            if (newCardHeader === currentCardHeader && 
                                (newCardHeader?.includes('Phân công nhân viên') || 
                                 newCardHeader?.includes('Trạng thái đơn hàng') ||
                                 newCardHeader?.includes('Thanh toán'))) {
                                const newCardBody = newCard.querySelector('.card-body');
                                const currentCardBody = currentCard.querySelector('.card-body');
                                if (newCardBody && currentCardBody) {
                                    const newCardBodyHTML = newCardBody.innerHTML.trim();
                                    const currentCardBodyHTML = currentCardBody.innerHTML.trim();
                                    if (newCardBodyHTML !== currentCardBodyHTML) {
                                        // Cập nhật mượt mà
                                        requestAnimationFrame(() => {
                                            currentCardBody.innerHTML = newCardBodyHTML;
                                            
                                            // Re-initialize countdown timer ngay lập tức
                                            const timerInCard = currentCardBody.querySelector('.countdown-timer-confirmed-unpaid');
                                            if (timerInCard) {
                                                updateCountdown('.countdown-timer-confirmed-unpaid'); // Không chờ, update ngay
                                            }
                                        });
                                    }
                                }
                            }
                        }
                    });
                    
                    // Cập nhật data-cancel-time từ server (đã tính từ ConfirmedAt hoặc CreatedAt)
                    const newPendingTimer = doc.querySelector('.countdown-timer-detail');
                    const currentPendingTimer = document.querySelector('.countdown-timer-detail');
                    const newConfirmedTimer = doc.querySelector('.countdown-timer-confirmed-unpaid');
                    const currentConfirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
                    
                    // Cập nhật Pending timer
                    if (newPendingTimer && currentPendingTimer) {
                        const newCancelTime = newPendingTimer.getAttribute('data-cancel-time');
                        const newConfirmedAt = newPendingTimer.getAttribute('data-confirmed-at');
                        const newAutoCancelMinutes = newPendingTimer.getAttribute('data-auto-cancel-minutes');
                        if (newCancelTime) {
                            currentPendingTimer.setAttribute('data-cancel-time', newCancelTime);
                        }
                        if (newConfirmedAt) {
                            currentPendingTimer.setAttribute('data-confirmed-at', newConfirmedAt);
                        }
                        if (newAutoCancelMinutes !== null) {
                            currentPendingTimer.setAttribute('data-auto-cancel-minutes', newAutoCancelMinutes);
                        }
                    }
                    
                    // Cập nhật Confirmed timer (tính từ ConfirmedAt) - ĐỒNG BỘ với Admin
                    if (newConfirmedTimer && currentConfirmedTimer) {
                        const newCancelTime = newConfirmedTimer.getAttribute('data-cancel-time');
                        const newConfirmedAt = newConfirmedTimer.getAttribute('data-confirmed-at');
                        const newAutoCancelMinutes = newConfirmedTimer.getAttribute('data-auto-cancel-minutes');
                        const oldCancelTime = currentConfirmedTimer.getAttribute('data-cancel-time');
                        
                        // QUAN TRỌNG: Cập nhật data-cancel-time (đã được server tính từ ConfirmedAt)
                        if (newCancelTime && newCancelTime !== oldCancelTime) {
                            currentConfirmedTimer.setAttribute('data-cancel-time', newCancelTime);
                        }
                        
                        // QUAN TRỌNG: Cập nhật data-confirmed-at (giống Admin)
                        if (newConfirmedAt) {
                            const oldConfirmedAt = currentConfirmedTimer.getAttribute('data-confirmed-at');
                            if (newConfirmedAt !== oldConfirmedAt) {
                                currentConfirmedTimer.setAttribute('data-confirmed-at', newConfirmedAt);
                                console.log('[Provider Refresh] ✅ Confirmed-at updated:', oldConfirmedAt, '->', newConfirmedAt);
                            }
                        }
                        
                        if (newAutoCancelMinutes !== null) {
                            currentConfirmedTimer.setAttribute('data-auto-cancel-minutes', newAutoCancelMinutes);
                        }
                        
                        // Cập nhật countdown timer ngay lập tức nếu có thay đổi
                        if (newCancelTime && newCancelTime !== oldCancelTime) {
                            updateCountdown('.countdown-timer-confirmed-unpaid');
                        }
                    }
                    
                    // Cập nhật Pending timer display nếu có
                    if (newPendingTimer && currentPendingTimer) {
                        updateCountdown('.countdown-timer-detail');
                    }
                } catch (error) {
                    console.error('[Provider Refresh] Error:', error);
                } finally {
                    isRefreshing = false;
                }
            }
            
            // Tắt auto-refresh liên tục để tránh nhấp nháy
            // Chỉ refresh khi có thay đổi thực sự hoặc khi user thực hiện action
            // Refresh ngay sau khi page load - KHÔNG CHỜ
            refreshBookingDetail(); // Refresh ngay lập tức, không delay
            
            // KHÔNG auto-refresh liên tục để tránh nhấp nháy UI
            // Chỉ refresh khi cần thiết (khi có action từ user hoặc khi countdown hết)
            
            // Tắt auto-refresh khi page unload
            window.addEventListener('beforeunload', function() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });
        });

        // Zoomable images for timeline
        document.addEventListener('DOMContentLoaded', function() {
            const imgModalEl = document.getElementById('imgPreviewModal');
            if (imgModalEl) {
                const imgEl = imgModalEl.querySelector('.modal-img');
                const bsImgModal = new bootstrap.Modal(imgModalEl);
                document.body.addEventListener('click', function (e) {
                    const t = e.target;
                    if (t && t.tagName === 'IMG' && t.classList.contains('zoomable')) {
                        const src = t.getAttribute('data-full') || t.getAttribute('src') || t.dataset.src;
                        const alt = t.getAttribute('alt') || '';
                        if (src) { 
                            imgEl.src = src; 
                            imgEl.alt = alt; 
                            bsImgModal.show(); 
                        }
                    }
                });
            }
        });
    </script>
}

<!-- Modal: Nhập lý do từ chối đơn hàng -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-labelledby="cancelReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header provider-cancel-modal-header">
                <h5 class="modal-title" id="cancelReasonModalLabel">
                    <i class="bi bi-x-circle me-2"></i> Từ chối đơn hàng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body provider-cancel-modal-body">
                <div class="alert alert-warning provider-cancel-warning d-flex align-items-start" role="alert">
                    <i class="bi bi-exclamation-triangle me-2 flex-shrink-0"></i>
                    <div>
                        <strong>Lưu ý:</strong> Hành động này sẽ từ chối đơn hàng và hoàn tiền cho khách hàng.
                    </div>
                </div>
                <div class="provider-cancel-form-group">
                    <label for="cancelReason" class="form-label provider-cancel-label">
                        LÝ DO TỪ CHỐI: <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        class="form-control provider-cancel-textarea" 
                        id="cancelReason" 
                        rows="4" 
                        placeholder="Vui lòng nhập lý do từ chối đơn hàng (tối thiểu 10 ký tự)..."
                        maxlength="500"
                        oninput="updateCharCount()"
                        required></textarea>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted d-flex align-items-center provider-cancel-info">
                            <i class="bi bi-info-circle me-1"></i> Lý do này sẽ được gửi cho khách hàng.
                        </small>
                        <small class="text-muted provider-cancel-counter">
                            <span id="charCount">0</span> /500 ký tự
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer provider-cancel-modal-footer">
                <button type="button" class="btn provider-cancel-btn-cancel" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> HỦY
                </button>
                <button type="button" class="btn provider-cancel-btn-submit" onclick="submitCancelReason()">
                    <i class="bi bi-check-circle me-1"></i> Xác nhận từ chối
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xem ảnh fullscreen -->
<div class="modal fade" id="imgPreviewModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 1200px;">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
            <div class="modal-body p-0 d-flex justify-content-center align-items-center" style="cursor: zoom-out;">
                <div class="position-relative d-inline-block">
                    <img class="modal-img" src="" alt="" style="max-width: 98vw; max-height: 92vh; border-radius: 10px; background: #fff; object-fit: contain;" />
                    <button type="button" class="btn btn-light position-absolute" data-bs-dismiss="modal" aria-label="Đóng" style="top: 6px; right: 6px; padding: 2px 6px; line-height: 1; border-radius: 6px;">
                        <i class="bi bi-x-lg" style="font-size: .8rem;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "pendingpayment" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "inprogress" or "in progress" or "in-progress" => "Đang xử lý",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string GetPaymentMethodText(string? paymentMethod)
    {
        if (string.IsNullOrEmpty(paymentMethod))
            return "Chưa thanh toán";

        var methodLower = paymentMethod.ToLower().Trim();
        return methodLower switch
        {
            "vnpay" => "VNPAY",
            "refund" => "Hoàn tiền",
            "cash" => "Tiền mặt",
            "bank transfer" => "Chuyển khoản",
            "momo" => "MoMo",
            "zalo pay" => "ZaloPay",
            "hoàn tiền" => "Hoàn tiền",
            "tiền mặt" => "Tiền mặt",
            "chuyển khoản" => "Chuyển khoản",
            _ => paymentMethod
        };
    }

    string GetPaymentStatusText(string? paymentStatus)
    {
        if (string.IsNullOrEmpty(paymentStatus))
            return "Chưa xác định";

        var statusLower = paymentStatus.ToLower().Trim();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            "cancelled" => "Đã hủy",
            "canceled" => "Đã hủy",
            "đã thanh toán" => "Đã thanh toán",
            "chưa thanh toán" => "Chưa thanh toán",
            "đang chờ" => "Chờ thanh toán",
            "đã hoàn tiền" => "Đã hoàn tiền",
            "đã hủy" => "Đã hủy",
            _ => paymentStatus
        };
    }
}


@model VHS_frontend.Areas.Provider.Models.Booking.BookingDetailDTO
@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "Chi tiết đơn hàng";
}

<div class="order-detail-container">
    <!-- Header -->
    <div class="order-detail-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="order-detail-title-section">
                <h3 class="order-detail-main-title mb-3">
                    <i class="bi bi-file-text me-2"></i>
                    Chi tiết đơn hàng
                </h3>
                <div class="order-detail-info-row">
                    <div class="order-code-simple">
                        <i class="bi bi-receipt me-2"></i>
                        <span class="order-code-label">Mã đơn:</span>
                        <span class="order-code-value">@Model.BookingCode</span>
                    </div>
                    <p class="order-detail-meta mb-0">
                        <i class="bi bi-calendar3"></i> 
                        <span>Tạo lúc: @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
            </p>
                </div>
        </div>
        <div>
                <a asp-action="Index" class="btn btn-back">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Customer Info Card -->
            <div class="card detail-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Thông tin khách hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="detail-info-item">
                                <span class="detail-label"><i class="bi bi-person me-2"></i>Họ tên:</span>
                                <span class="detail-value">@Model.CustomerName</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-info-item">
                                <span class="detail-label"><i class="bi bi-telephone me-2"></i>Số điện thoại:</span>
                                <span class="detail-value">@Model.CustomerPhone</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="detail-info-item">
                                <span class="detail-label"><i class="bi bi-envelope me-2"></i>Email:</span>
                                <span class="detail-value">@Model.CustomerEmail</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Info Card -->
            <div class="card detail-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-briefcase me-2"></i>
                        Thông tin dịch vụ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="service-detail-wrapper">
                        @if (!string.IsNullOrEmpty(Model.ServiceImages))
                        {
                            string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
                            var firstImage = Model.ServiceImages.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).FirstOrDefault();
                            var firstUrl = ToUrl(firstImage);
                            if (!string.IsNullOrEmpty(firstUrl))
                            {
                                <div class="service-image-wrapper">
                                    <img src="@firstUrl" alt="@Model.ServiceName" class="service-image" />
                                </div>
                            }
                        }
                        <div class="service-info-content">
                            <h5 class="service-name">@Model.ServiceName</h5>
                            <p class="service-description">@Model.ServiceDescription</p>
                            <div class="service-price-box">
                                <span class="price-label">Giá:</span>
                                <span class="price-value">@Model.ServicePrice.ToString("N0") VND</span>
                            </div>
                            
                            @if (Model.Options.Any())
                            {
                                <div class="service-options mt-3">
                                    <strong class="options-title"><i class="bi bi-list-check me-2"></i>Tùy chọn đã bao gồm:</strong>
                                    <div class="mt-2">
                                        @foreach (var option in Model.Options)
                                        {
                                            var isTextarea = option.Type?.ToLower() == "textarea" || option.Type?.ToLower() == "text";
                                            <div style="font-size: 0.9375rem; color: var(--muted-foreground, #6c757d); margin-bottom: 0.25rem;">
                                                <div style="display: flex; align-items: flex-start;">
                                                    <i class="bi bi-check-circle-fill me-1" style="color: var(--success, #198754); font-size: 0.75rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <span>@option.OptionName</span>
                                                        @if (isTextarea && !string.IsNullOrWhiteSpace(option.Value))
                                                        {
                                                            @* Xử lý giá trị: split theo xuống dòng hoặc dấu gạch ngang *@
                                                            var valueLines = new List<string>();
                                                            
                                                            @* Kiểm tra xem có ký tự xuống dòng không *@
                                                            if (option.Value.Contains('\n') || option.Value.Contains('\r'))
                                                            {
                                                                @* Nếu có xuống dòng, split theo \n và \r *@
                                                                valueLines = option.Value
                                                                    .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
                                                                    .Select(v => v.Trim())
                                                                    .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                    .ToList();
                                                            }
                                                            else
                                                            {
                                                                @* Nếu không có xuống dòng nhưng có dấu gạch ngang, split theo dấu gạch ngang *@
                                                                valueLines = option.Value
                                                                    .Split(new[] { " - ", " – ", "-", "–" }, StringSplitOptions.RemoveEmptyEntries)
                                                                    .Select(v => v.Trim())
                                                                    .Where(v => !string.IsNullOrWhiteSpace(v))
                                                                    .ToList();
                                                            }
                                                            
                                                            <div style="margin-top: 0.125rem; font-size: 0.875rem; line-height: 1.4; color: #6c757d;">
                                                                @foreach (var line in valueLines)
                                                                {
                                                                    <div>@line</div>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Info Card -->
            <div class="card detail-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>
                        Thông tin đặt hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="detail-info-item mb-3">
                        <span class="detail-label"><i class="bi bi-clock me-2"></i>Thời gian thực hiện:</span>
                        <span class="detail-value">@Model.BookingTime.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    
                    <!-- Địa chỉ chi tiết từ UserAddresses -->
                    @if (Model.AddressId.HasValue && (!string.IsNullOrEmpty(Model.ProvinceName) || !string.IsNullOrEmpty(Model.StreetAddress)))
                    {
                        <div class="address-detail-section mb-3">
                            <span class="detail-label mb-2 d-block"><i class="bi bi-geo-alt me-2"></i>Địa chỉ người đặt:</span>
                            <div class="address-detail-box">
                                @if (!string.IsNullOrEmpty(Model.RecipientName))
                                {
                                    <div class="address-recipient mb-2">
                                        <strong><i class="bi bi-person me-1"></i>Người đặt:</strong> 
                                        <span>@Model.RecipientName</span>
                                        @if (!string.IsNullOrEmpty(Model.RecipientPhone))
                                        {
                                            <span class="ms-2 text-muted">
                                                <i class="bi bi-telephone me-1"></i>@Model.RecipientPhone
                                            </span>
                                        }
                                    </div>
                                }
                                
                                <div class="address-full">
                                    @if (!string.IsNullOrEmpty(Model.StreetAddress))
                                    {
                                        <div class="address-line">
                                            <i class="bi bi-house-door me-2 text-primary"></i>
                                            <span>@Model.StreetAddress</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.WardName) || !string.IsNullOrEmpty(Model.DistrictName) || !string.IsNullOrEmpty(Model.ProvinceName))
                                    {
                                        <div class="address-line">
                                            <i class="bi bi-geo me-2 text-primary"></i>
                                            <span>
                                                @if (!string.IsNullOrEmpty(Model.WardName))
                                                {
                                                    <text>@Model.WardName, </text>
                                                }
                                                @if (!string.IsNullOrEmpty(Model.DistrictName))
                                                {
                                                    <text>@Model.DistrictName, </text>
                                                }
                                                @if (!string.IsNullOrEmpty(Model.ProvinceName))
                                                {
                                                    <text>@Model.ProvinceName</text>
                                                }
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Fallback: Hiển thị địa chỉ đơn giản nếu không có thông tin chi tiết -->
                        <div class="detail-info-item mb-3">
                            <span class="detail-label"><i class="bi bi-geo-alt me-2"></i>Địa chỉ:</span>
                            <span class="detail-value">@Model.Address</span>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.VoucherCode))
                    {
                        <div class="detail-info-item">
                            <span class="detail-label"><i class="bi bi-ticket-perforated me-2"></i>Mã giảm giá:</span>
                            <span class="voucher-badge">@Model.VoucherCode</span>
                        </div>
                    }
                </div>
            </div>

            @{
                var currentStatus = (Model.Status ?? string.Empty).Trim();
                var isCompletedOrCancelled = string.Equals(currentStatus, "Completed", StringComparison.OrdinalIgnoreCase) || 
                                            string.Equals(currentStatus, "Cancelled", StringComparison.OrdinalIgnoreCase) ||
                                            string.Equals(currentStatus, "Canceled", StringComparison.OrdinalIgnoreCase);
            }
            
            @* Chỉ hiển thị phần phân công nhân viên nếu đơn hàng chưa hoàn thành hoặc hủy *@
            @if (!isCompletedOrCancelled)
            {
                <!-- Staff Assignment Card -->
                <div class="card detail-card mb-4">
                    <div class="card-header detail-card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>
                            Phân công nhân viên
                        </h5>
                    </div>
                    <div class="card-body">
                        @{
                            var isPendingStatus = string.Equals((Model.Status ?? string.Empty).Trim(), "Pending", StringComparison.OrdinalIgnoreCase);
                            var isConfirmedOrAbove = string.Equals((Model.Status ?? string.Empty).Trim(), "Confirmed", StringComparison.OrdinalIgnoreCase) ||
                                                    string.Equals((Model.Status ?? string.Empty).Trim(), "InProgress", StringComparison.OrdinalIgnoreCase) ||
                                                    string.Equals((Model.Status ?? string.Empty).Trim(), "Completed", StringComparison.OrdinalIgnoreCase);
                        }
                        
                        @* Chỉ hiển thị "Đã phân công" khi status là Confirmed trở lên *@
                        @if (isConfirmedOrAbove && Model.StaffId.HasValue)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-person-check-fill"></i>
                                Đã phân công cho: <strong>@Model.StaffName</strong>
                            </div>
                        }
                        else if (isPendingStatus)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Đơn hàng đang chờ xử lý</strong>
                                <p class="mb-0 mt-2 small">
                                    Bạn có thể chọn nhân viên trước, sau đó nhấn "Xác nhận đơn hàng" để gán chính thức. 
                                    Nếu không chọn, hệ thống sẽ tự động gán nhân viên rảnh có ít công việc nhất.
                                </p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Chưa phân công nhân viên
                            </div>
                        }

                        @if (ViewBag.StaffList != null && ((List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>)ViewBag.StaffList).Any())
                        {
                            <div class="mt-3">
                                <!-- Thông báo lỗi/thành công -->
                                <div id="staffAssignmentMessage" class="alert d-none" role="alert">
                                    <span id="staffAssignmentMessageText"></span>
                                </div>
                                
                                <label class="form-label">Chọn nhân viên:</label>
                                <div class="input-group">
                                    <select id="staffSelect" class="form-select">
                                        <option value="">-- Chọn nhân viên (tùy chọn) --</option>
                                        @foreach (var staff in (List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>)ViewBag.StaffList)
                                        {
                                            @* Chỉ pre-select nhân viên nếu status là Confirmed trở lên *@
                                            var isSelected = isConfirmedOrAbove && Model.StaffId.HasValue && 
                                                            Guid.TryParse(staff.StaffId, out var staffGuid) && 
                                                            staffGuid == Model.StaffId.Value;
                                            
                                            @* Logic: 
                                               - Nếu nhân viên không bị xóa: hiển thị bình thường
                                               - Nếu nhân viên bị xóa nhưng đã được phân công: vẫn hiển thị để người dùng biết, nhưng disable
                                               - Nếu nhân viên bị xóa và chưa được phân công: ẩn khỏi danh sách
                                            *@
                                            var isAssignedStaff = isSelected;
                                            var isDeleted = staff.IsDeleted == true;
                                            var shouldShow = !isDeleted || isAssignedStaff;
                                            
                                            @if (shouldShow)
                                            {
                                                <option value="@staff.StaffId" 
                                                        selected="@isSelected"
                                                        disabled="@isDeleted"
                                                        data-deleted="@isDeleted.ToString().ToLower()">
                                                    @staff.StaffName@(isDeleted ? " (Đã xóa)" : "")
                                            </option>
                                            }
                                        }
                                    </select>
                                    <button type="button" class="btn btn-assign-staff" onclick="assignStaff()">
                                        <i class="bi bi-check"></i> Phân công
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Checker Records -->
            @if (Model.CheckerRecords.Any())
            {
                <div class="card detail-card mb-4">
                    <div class="card-header detail-card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-camera me-2"></i>
                            Check-in/Check-out
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var record in Model.CheckerRecords)
                        {
                            <div class="checker-record">
                                <div class="checker-record-header">
                                    <span class="checker-status">@record.ForStatus</span>
                                    <span class="checker-time">@record.UploadedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>
                                @if (!string.IsNullOrEmpty(record.StaffName))
                                {
                                    <p class="checker-staff"><i class="bi bi-person me-1"></i>Bởi: @record.StaffName</p>
                                }
                                @if (record.MediaType.Contains("image"))
                                {
                                    <div class="checker-media-wrapper">
                                        <img src="@record.FileUrl" alt="Checker media" class="checker-media" />
                                    </div>
                                }
                                else if (record.MediaType.Contains("video"))
                                {
                                    <div class="checker-media-wrapper">
                                        <video controls class="checker-media">
                                        <source src="@record.FileUrl" type="video/mp4" />
                                    </video>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(record.Description))
                                {
                                    <p class="checker-description"><em>@record.Description</em></p>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card detail-card status-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Trạng thái đơn hàng
                    </h5>
                </div>
                <div class="card-body">
                    <div class="status-badge-wrapper mb-4">
                        <span class="status-badge-lg status-@(Model.Status.ToLower().Replace(" ", "-"))">
                            @GetStatusText(Model.Status)
                        </span>
                    </div>

                    @{ 
                        var statusNorm = (Model.Status ?? string.Empty).Trim();
                        bool isPending = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase);
                        bool isConfirmed = string.Equals(statusNorm, "Confirmed", StringComparison.OrdinalIgnoreCase);
                        bool isCompleted = string.Equals(statusNorm, "Completed", StringComparison.OrdinalIgnoreCase);
                        bool isCanceled  = string.Equals(statusNorm, "Canceled", StringComparison.OrdinalIgnoreCase) ||
                                          string.Equals(statusNorm, "Cancelled", StringComparison.OrdinalIgnoreCase);
                        // Hiển thị nút nếu đơn chưa ở các trạng thái cuối cùng
                        bool canAct = !(isConfirmed || isCompleted || isCanceled);
                        
                        // Kiểm tra xem có nhân viên nào không bị xóa không
                        var staffList = ViewBag.StaffList as List<VHS_frontend.Areas.Provider.Models.Staff.StaffDTO>;
                        var hasAvailableStaff = staffList != null && staffList.Any(s => s.IsDeleted != true);
                    }
                    
                    @* Hiển thị countdown timer cho booking Pending *@
                    @if (isPending)
                    {
                        var cancelMinutes = Model.AutoCancelMinutes ?? 30; // Mặc định 30 phút
                        DateTime validCreatedAt;
                        if (Model.CreatedAt != default(DateTime) && Model.CreatedAt != DateTime.MinValue && Model.CreatedAt.Year > 2000)
                        {
                            validCreatedAt = Model.CreatedAt;
                        }
                        else
                        {
                            validCreatedAt = DateTime.Now;
                        }
                        var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy:</strong>
                                </div>
                                <div class="countdown-timer-detail text-danger fw-bold" 
                                     data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-booking-id="@Model.BookingId"
                                     data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-auto-cancel-minutes="@cancelMinutes"
                                     style="font-size: 1.1rem;">
                                    Đang tính...
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                @if (Model.AutoCancelMinutes.HasValue)
                                {
                                    <text>Thời gian hủy riêng: @Model.AutoCancelMinutes phút</text>
                                }
                                else
                                {
                                    <text>Thời gian hủy mặc định: @cancelMinutes phút</text>
                                }
                            </small>
                        </div>
                    }
                    
                    @if (canAct)
                    {
                        <!-- Thông báo lỗi/thành công cho status -->
                        <div id="statusUpdateMessage" class="alert d-none mb-3" role="alert">
                            <span id="statusUpdateMessageText"></span>
                        </div>
                        
                        @if (!hasAvailableStaff)
                        {
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Không có nhân viên nào để phân công.</strong><br>
                                <small>Vui lòng thêm nhân viên hoặc mở khóa nhân viên trong phần "Quản lí nhân viên" trước khi xác nhận đơn hàng.</small>
                            </div>
                        }
                        
                        <div class="action-buttons">
                            @if (hasAvailableStaff)
                            {
                                <button type="button" class="btn btn-confirm btn-lg" onclick="updateStatus('Confirmed')">
                                <i class="bi bi-check-circle"></i> Xác nhận đơn hàng
                            </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-confirm btn-lg" disabled>
                                    <i class="bi bi-check-circle"></i> Xác nhận đơn hàng
                                </button>
                            }
                            <button type="button" class="btn btn-cancel" onclick="cancelOrder()">
                                <i class="bi bi-x-circle"></i> Từ chối đơn hàng
                            </button>
                        </div>
                    }
                    else if (Model.Status == "Confirmed")
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Đơn hàng đã được xác nhận</strong>
                            <p class="mb-0 mt-2 small">
                                Nhân viên <strong>@(Model.StaffName ?? "chưa phân công")</strong> sẽ thực hiện công việc và cập nhật trạng thái qua ứng dụng Staff.
                            </p>
                        </div>
                        <!-- Chỉ cho phép hủy nếu thực sự cần -->
                        @* <button type="button" class="btn btn-outline-danger btn-sm" onclick="cancelOrder()">
                            <i class="bi bi-x-circle"></i> Hủy đơn hàng (khẩn cấp)
                        </button> *@
                    }
                    else if (isCompleted)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Đơn hàng đã hoàn thành</strong>
                            <p class="mb-0 mt-2">
                                @if (!string.IsNullOrEmpty(Model.StaffName))
                                {
                                    <text>Đơn hàng đã được nhân viên <strong>@Model.StaffName</strong> hoàn thành.</text>
                                }
                                else
                                {
                                    <text>Công việc đã được nhân viên hoàn thành.</text>
                                }
                            </p>
                        </div>
                    }
                    else if (isCanceled)
                    {
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">
                                <i class="bi bi-x-circle-fill"></i>
                                <strong>Đơn hàng này đã được hủy</strong>
                            </h5>
                            @if (!string.IsNullOrEmpty(Model.CancelReason))
                            {
                                <hr />
                                <p class="mb-0">
                                    <strong>Lý do hủy:</strong><br />
                                    <span class="text-dark">@Model.CancelReason</span>
                                </p>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Payment Card -->
            <div class="card detail-card payment-card mb-4">
                <div class="card-header detail-card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card me-2"></i>
                        Thanh toán
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-summary">
                        <div class="payment-item payment-total">
                            <span class="payment-label">Tổng tiền:</span>
                            <span class="payment-value">@Model.TotalAmount.ToString("N0") VND</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label"><i class="bi bi-wallet2 me-1"></i>Phương thức:</span>
                            <span class="payment-method">@GetPaymentMethodText(Model.PaymentMethod)</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Trạng thái:</span>
                            @{
                                var paymentStatusClass = "unpaid";
                                var paymentStatusLower = Model.PaymentStatus?.ToLower() ?? "";
                                if (paymentStatusLower.Contains("paid") || paymentStatusLower.Contains("đã"))
                                {
                                    paymentStatusClass = "paid";
                                }
                                else if (paymentStatusLower.Contains("rejected") || paymentStatusLower.Contains("từ chối"))
                                {
                                    paymentStatusClass = "rejected";
                                }
                                else if (paymentStatusLower.Contains("refunded") || paymentStatusLower.Contains("hoàn tiền"))
                                {
                                    paymentStatusClass = "refunded";
                                }
                                else if (paymentStatusLower.Contains("unpaid") || paymentStatusLower.Contains("chưa") || paymentStatusLower.Contains("pending"))
                                {
                                    paymentStatusClass = "unpaid";
                                }
                            }
                            <span class="badge payment-status-badge payment-@(paymentStatusClass.Replace(" ", "-"))">
                                @GetPaymentStatusText(Model.PaymentStatus)
                            </span>
                        </div>
                        @if (Model.PaymentDate.HasValue)
                        {
                            <div class="payment-item payment-date">
                                <span class="payment-label"><i class="bi bi-calendar3 me-1"></i>Ngày thanh toán:</span>
                                <span class="payment-date-value">@Model.PaymentDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                        }
                    </div>
                    
                    @* Hiển thị countdown timer cho Confirmed chưa thanh toán *@
                    @{
                        var statusNormPayment = (Model.Status ?? string.Empty).Trim();
                        bool isConfirmedPayment = string.Equals(statusNormPayment, "Confirmed", StringComparison.OrdinalIgnoreCase);
                    }
                    @if (isConfirmedPayment)
                    {
                        // Kiểm tra chưa thanh toán
                        var isUnpaid = string.IsNullOrEmpty(Model.PaymentStatus) || 
                                     (!Model.PaymentStatus.ToLower().Contains("paid") && 
                                      !Model.PaymentStatus.ToLower().Contains("đã thanh toán") &&
                                      !Model.PaymentStatus.ToLower().Contains("completed") &&
                                      Model.PaymentStatus.ToLower() != "00");
                        
                        if (isUnpaid)
                        {
                            var cancelMinutes = Model.AutoCancelMinutes ?? 30; // Sử dụng AutoCancelMinutes từ model, mặc định 30 phút
                            DateTime validCreatedAt;
                            if (Model.CreatedAt != default(DateTime) && Model.CreatedAt != DateTime.MinValue && Model.CreatedAt.Year > 2000)
                            {
                                validCreatedAt = Model.CreatedAt;
                            }
                            else
                            {
                                validCreatedAt = DateTime.Now;
                            }
                            var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                            <div class="alert alert-warning mt-3 mb-0">
                                <div class="mb-2">
                                    <i class="bi bi-clock-history me-2"></i>
                                    <strong>Thời gian tự động hủy (chưa thanh toán):</strong>
                                </div>
                                <div class="countdown-timer-confirmed-unpaid text-danger fw-bold" 
                                     data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-booking-id="@Model.BookingId"
                                     data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                     data-auto-cancel-minutes="@(Model.AutoCancelMinutes?.ToString() ?? "")"
                                     style="font-size: 1.1rem;">
                                    Đang tính...
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
    <style>
        /* Service Completed Status Badge - Màu xanh dương nhạt để phân biệt với Completed */
        .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 1px solid #6366f1 !important;
            font-weight: 800 !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .status-badge-lg.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Rejected Badge */
        .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
            color: #000000 !important;
            border: 1px solid #ef4444 !important;
            font-weight: 800 !important;
        }
        
        .dark .payment-status-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
        }
        
        /* Payment Refunded Badge */
        .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            color: #000000 !important;
            border: 1px solid #f59e0b !important;
            font-weight: 800 !important;
        }
        
        .dark .payment-status-badge.payment-refunded {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(251, 191, 36, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3) !important;
        }
    </style>
}

@section Scripts {
    <script>
        const bookingId = '@Model.BookingId';
        console.log('Booking ID:', bookingId);

        function showStatusMessage(message, type) {
            const messageDiv = document.getElementById('statusUpdateMessage');
            const messageText = document.getElementById('statusUpdateMessageText');
            
            if (!messageDiv || !messageText) return;
            
            // Xóa các class cũ
            messageDiv.className = 'alert mb-3';
            messageDiv.classList.add('alert-' + type);
            
            // Set nội dung
            messageText.innerHTML = message;
            
            // Hiển thị
            messageDiv.classList.remove('d-none');
            
            // Scroll vào view
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Tự động ẩn sau 5 giây nếu là thông báo thành công
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 5000);
            }
        }

        // Lưu trạng thái ban đầu để revert nếu có lỗi
        let originalStatus = '@Model.Status';
        let originalStatusHtml = null;
        let originalButtonsHtml = null;

        // Cập nhật UI ngay lập tức (optimistic update)
        function updateUIOptimistically(newStatus) {
            // Lưu trạng thái ban đầu
            const statusBadge = document.querySelector('.status-badge-lg');
            if (statusBadge) {
                originalStatusHtml = statusBadge.outerHTML;
            }
            
            const actionButtons = document.querySelector('.action-buttons');
            if (actionButtons) {
                originalButtonsHtml = actionButtons.innerHTML;
            }
            
            // Cập nhật status badge ngay lập tức
            if (statusBadge && newStatus === 'Confirmed') {
                statusBadge.className = 'status-badge-lg status-confirmed';
                statusBadge.textContent = 'Đã xác nhận';
            } else if (statusBadge && newStatus === 'Canceled') {
                statusBadge.className = 'status-badge-lg status-canceled';
                statusBadge.textContent = 'Đã hủy';
            }
            
            // Ẩn action buttons ngay lập tức
            if (actionButtons) {
                actionButtons.innerHTML = '<button type="button" class="btn btn-confirm btn-lg" disabled><i class="bi bi-hourglass-split"></i> Đang xử lý...</button>';
            }
            
            // Hiển thị thông báo thành công ngay lập tức
            showStatusMessage(
                '<i class="bi bi-hourglass-split me-2"></i><strong>Đang xử lý...</strong>',
                'info'
            );
        }
        
        // Revert UI về trạng thái ban đầu nếu có lỗi
        function revertUI() {
            const statusBadge = document.querySelector('.status-badge-lg');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (statusBadge && originalStatusHtml) {
                statusBadge.outerHTML = originalStatusHtml;
            }
            
            if (actionButtons && originalButtonsHtml) {
                actionButtons.innerHTML = originalButtonsHtml;
            }
        }

        function updateStatus(newStatus) {
            console.log('[DEBUG] updateStatus called with:', newStatus);
            
            // Ẩn thông báo cũ
            const messageDiv = document.getElementById('statusUpdateMessage');
            if (messageDiv) {
                messageDiv.classList.add('d-none');
            }
            
            // ✨ Nếu xác nhận đơn hàng, kiểm tra xem có nhân viên nào không bị xóa không
            if (newStatus === 'Confirmed') {
                const staffSelect = document.getElementById('staffSelect');
                let availableStaffCount = 0;
                
                if (staffSelect) {
                    // Đếm số nhân viên không bị xóa trong dropdown
                    for (let i = 0; i < staffSelect.options.length; i++) {
                        const option = staffSelect.options[i];
                        if (option.value && option.getAttribute('data-deleted') !== 'true') {
                            availableStaffCount++;
                        }
                    }
                }
                
                // Nếu không có nhân viên nào, hiển thị thông báo và dừng
                if (availableStaffCount === 0) {
                    showStatusMessage(
                        '<i class="bi bi-exclamation-triangle me-2"></i><strong>Không có nhân viên nào để phân công.</strong><br>' +
                        'Vui lòng thêm nhân viên hoặc mở khóa nhân viên trong phần "Quản lí nhân viên" trước khi xác nhận đơn hàng.',
                        'warning'
                    );
                    return;
                }
            }
            
            // ✨ Cập nhật UI ngay lập tức (optimistic update)
            updateUIOptimistically(newStatus);
            
            // ✨ Nếu xác nhận đơn hàng, lấy staffId từ dropdown (nếu có)
            let selectedStaffId = null;
            if (newStatus === 'Confirmed') {
                const staffSelect = document.getElementById('staffSelect');
                if (staffSelect && staffSelect.value) {
                    selectedStaffId = staffSelect.value;
                    console.log('[DEBUG] Selected staff ID:', selectedStaffId);
                }
            }
            
            const payload = {
                bookingId: bookingId,
                newStatus: newStatus,
                reason: null,
                selectedStaffId: selectedStaffId  // ✨ Gửi staffId đã chọn (nếu có)
            };
            
            console.log('[DEBUG] Sending payload:', payload);

            fetch('/Provider/Order/UpdateStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('[DEBUG] Response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('[ERROR] Response error:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('[DEBUG] Response data:', data);
                if (data.success) {
                    showStatusMessage(
                        '<i class="bi bi-check-circle me-2"></i><strong>' + data.message + '</strong>',
                        'success'
                    );
                    // Reload ngay lập tức để sync với server
                    location.reload();
                } else {
                    // Revert UI về trạng thái ban đầu
                    revertUI();
                    
                    // Kiểm tra nếu là lỗi không có nhân viên
                    let errorMessage = data.message || 'Có lỗi xảy ra khi cập nhật trạng thái';
                    let messageType = 'danger';
                    
                    if (errorMessage.toLowerCase().includes('nhân viên') || 
                        errorMessage.toLowerCase().includes('staff') ||
                        errorMessage.toLowerCase().includes('không có') ||
                        errorMessage.toLowerCase().includes('no staff') ||
                        errorMessage.toLowerCase().includes('available')) {
                        errorMessage = '<i class="bi bi-exclamation-triangle me-2"></i><strong>Không có nhân viên nào để phân công.</strong><br>' +
                                      'Vui lòng thêm nhân viên hoặc mở khóa nhân viên trong phần "Quản lí nhân viên" trước khi xác nhận đơn hàng.';
                        messageType = 'warning';
                    } else {
                        errorMessage = '<i class="bi bi-exclamation-circle me-2"></i>' + errorMessage;
                    }
                    
                    showStatusMessage(errorMessage, messageType);
                }
            })
            .catch(error => {
                console.error('[ERROR] Catch error:', error);
                // Revert UI về trạng thái ban đầu
                revertUI();
                
                showStatusMessage(
                    '<i class="bi bi-exclamation-circle me-2"></i>Có lỗi xảy ra: ' + error.message,
                    'danger'
                );
            });
        }

        function updateCharCount() {
            const textarea = document.getElementById('cancelReason');
            const charCount = document.getElementById('charCount');
            charCount.textContent = textarea.value.length;
            
            // Đổi màu nếu chưa đủ 10 ký tự
            if (textarea.value.length < 10) {
                charCount.classList.add('text-danger');
                charCount.classList.remove('text-success');
            } else {
                charCount.classList.add('text-success');
                charCount.classList.remove('text-danger');
            }
        }

        function cancelOrder() {
            console.log('[DEBUG] cancelOrder called');
            
            // Reset form
            document.getElementById('cancelReason').value = '';
            updateCharCount(); // Reset counter
            
            // Mở modal thay vì dùng prompt()
            const modal = new bootstrap.Modal(document.getElementById('cancelReasonModal'));
            modal.show();
        }

        function submitCancelReason() {
            console.log('=== [SUBMIT CANCEL] START ===');
            
            const textarea = document.getElementById('cancelReason');
            const reason = textarea.value.trim();
            
            console.log('[SUBMIT CANCEL] Reason length:', reason.length);
            console.log('[SUBMIT CANCEL] Reason value:', reason);
            
            // Validation
            if (!reason) {
                alert('⚠️ Vui lòng nhập lý do từ chối đơn hàng!');
                console.log('[SUBMIT CANCEL] VALIDATION FAILED: Empty reason');
                return;
            }
            
            if (reason.length < 10) {
                alert('⚠️ Lý do từ chối phải có ít nhất 10 ký tự! (Hiện tại: ' + reason.length + ' ký tự)');
                console.log('[SUBMIT CANCEL] VALIDATION FAILED: Too short');
                return;
            }
            
            if (reason.length > 500) {
                alert('⚠️ Lý do từ chối không được quá 500 ký tự!');
                console.log('[SUBMIT CANCEL] VALIDATION FAILED: Too long');
                return;
            }

            // Tạo payload
            const payload = {
                bookingId: bookingId,
                newStatus: 'Canceled',
                reason: reason  // ✨ LÝ DO Ở ĐÂY
            };
            
            console.log('=== [SUBMIT CANCEL] PAYLOAD ===');
            console.log(JSON.stringify(payload, null, 2));
            console.log('===============================');

            // Đóng modal
            const modalElement = document.getElementById('cancelReasonModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }

            // ✨ Cập nhật UI ngay lập tức (optimistic update)
            updateUIOptimistically('Canceled');

            // Gửi request
            console.log('[SUBMIT CANCEL] Sending request to /Provider/Order/UpdateStatus...');
            
            fetch('/Provider/Order/UpdateStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('[SUBMIT CANCEL] Response status:', response.status, response.statusText);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('[SUBMIT CANCEL] ERROR Response:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('[SUBMIT CANCEL] SUCCESS Response:', data);
                if (data.success) {
                    showStatusMessage(
                        '<i class="bi bi-check-circle me-2"></i><strong>' + data.message + '</strong>',
                        'success'
                    );
                    // Reload ngay lập tức để sync với server
                    console.log('[SUBMIT CANCEL] Reloading page...');
                    location.reload();
                } else {
                    // Revert UI về trạng thái ban đầu
                    revertUI();
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('[SUBMIT CANCEL] CATCH Error:', error);
                // Revert UI về trạng thái ban đầu
                revertUI();
                alert('❌ Có lỗi xảy ra: ' + error.message);
            });
            
            console.log('=== [SUBMIT CANCEL] END ===');
        }

        function showStaffMessage(message, type) {
            const messageDiv = document.getElementById('staffAssignmentMessage');
            const messageText = document.getElementById('staffAssignmentMessageText');
            
            if (!messageDiv || !messageText) return;
            
            // Xóa các class cũ
            messageDiv.className = 'alert';
            messageDiv.classList.add('alert-' + type);
            
            // Set nội dung
            messageText.innerHTML = message;
            
            // Hiển thị
            messageDiv.classList.remove('d-none');
            
            // Scroll vào view
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Tự động ẩn sau 5 giây nếu là thông báo thành công
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 5000);
            }
        }

        function assignStaff() {
            console.log('[DEBUG] assignStaff called');
            
            // Ẩn thông báo cũ
            const messageDiv = document.getElementById('staffAssignmentMessage');
            if (messageDiv) {
                messageDiv.classList.add('d-none');
            }
            
            // Kiểm tra trạng thái booking
            const bookingStatus = '@Model.Status'.trim().toLowerCase();
            
            // ✨ Chỉ cho phép gán khi status là Confirmed
            if (bookingStatus !== 'confirmed') {
                if (bookingStatus === 'pending') {
                    showStaffMessage(
                        '<i class="bi bi-info-circle me-2"></i><strong>Đơn hàng đang ở trạng thái chờ xử lý.</strong><br>' +
                        'Vui lòng xác nhận đơn hàng trước khi phân công nhân viên.<br>' +
                        '<small>Bạn có thể: 1) Chọn nhân viên, sau đó nhấn "Xác nhận đơn hàng" - hệ thống sẽ gán nhân viên bạn chọn. 2) Nhấn "Xác nhận đơn hàng" trực tiếp - hệ thống sẽ tự động gán nhân viên rảnh có ít công việc nhất.</small>',
                        'info'
                    );
                } else if (bookingStatus === 'completed' || bookingStatus === 'cancelled' || bookingStatus === 'canceled') {
                    showStaffMessage(
                        '<i class="bi bi-exclamation-triangle me-2"></i>Không thể phân công nhân viên cho đơn hàng đã hoàn thành hoặc đã hủy.',
                        'warning'
                    );
                } else {
                    showStaffMessage(
                        '<i class="bi bi-exclamation-triangle me-2"></i>Chỉ có thể phân công nhân viên cho đơn hàng đã được xác nhận.',
                        'warning'
                    );
                }
                return;
            }
            
            const staffSelect = document.getElementById('staffSelect');
            
            // Kiểm tra nếu select bị disabled
            if (staffSelect.disabled) {
                showStaffMessage(
                    '<i class="bi bi-exclamation-triangle me-2"></i>Không thể phân công nhân viên cho đơn hàng này.',
                    'warning'
                );
                return;
            }
            
            const staffId = staffSelect.value;
            
            console.log('[DEBUG] Selected staff ID:', staffId);
            
            if (!staffId || staffId === '') {
                showStaffMessage(
                    '<i class="bi bi-exclamation-triangle me-2"></i>Vui lòng chọn nhân viên',
                    'warning'
                );
                return;
            }
            
            // Kiểm tra xem nhân viên có bị xóa không
            const selectedOption = staffSelect.options[staffSelect.selectedIndex];
            const isDeleted = selectedOption.getAttribute('data-deleted') === 'true';
            
            if (isDeleted) {
                showStaffMessage(
                    '<i class="bi bi-trash me-2"></i><strong>Nhân viên này đã bị xóa.</strong><br>Vui lòng chọn nhân viên khác.',
                    'warning'
                );
                return;
            }

            const payload = {
                bookingId: bookingId,
                staffId: staffId
            };
            
            console.log('[DEBUG] Assign staff payload:', payload);

            fetch('/Provider/Order/AssignStaff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('[DEBUG] Response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('[ERROR] Response error:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('[DEBUG] Response data:', data);
                if (data.success) {
                    showStaffMessage(
                        '<i class="bi bi-check-circle me-2"></i><strong>' + data.message + '</strong>',
                        'success'
                    );
                    // Reload sau 1.5 giây để user thấy thông báo
                    setTimeout(() => {
                    location.reload();
                    }, 1500);
                } else {
                    // Kiểm tra nếu là lỗi nhân viên bị xóa
                    let errorMessage = data.message || 'Có lỗi xảy ra khi phân công nhân viên';
                    let messageType = 'danger';
                    
                    if (errorMessage.toLowerCase().includes('xóa') || 
                        errorMessage.toLowerCase().includes('deleted') ||
                        errorMessage.toLowerCase().includes('khóa') || 
                        errorMessage.toLowerCase().includes('locked') ||
                        errorMessage.toLowerCase().includes('disabled') ||
                        errorMessage.toLowerCase().includes('inactive')) {
                        errorMessage = '<i class="bi bi-trash me-2"></i><strong>Nhân viên này đã bị xóa hoặc khóa.</strong><br>Vui lòng chọn nhân viên khác.';
                        messageType = 'warning';
                    } else {
                        errorMessage = '<i class="bi bi-exclamation-circle me-2"></i>' + errorMessage;
                    }
                    
                    showStaffMessage(errorMessage, messageType);
                }
            })
            .catch(error => {
                console.error('[ERROR] Catch error:', error);
                showStaffMessage(
                    '<i class="bi bi-exclamation-circle me-2"></i>Có lỗi xảy ra: ' + error.message,
                    'danger'
                );
            });
        }

        // Test khi trang load xong
        console.log('[DEBUG] Order details page loaded');
        console.log('[DEBUG] Current status:', '@Model.Status');
        
        // ========== Countdown Timer và Auto-Refresh để đồng bộ với admin ==========
        let refreshInterval = null;
        let bookingCancelTime = null;
        
        // Function để cập nhật countdown timer
        function updateCountdown(timerSelector, isConfirmedUnpaid = false) {
            const timer = document.querySelector(timerSelector);
            if (!timer) return;
            
            const cancelTimeStr = timer.getAttribute('data-cancel-time');
            if (!cancelTimeStr) return;
            
            // Parse thời gian hủy (format: yyyy-MM-ddTHH:mm:ss - local time)
            let cancelTime;
            if (cancelTimeStr.includes('Z') || cancelTimeStr.match(/[+-]\d{2}:\d{2}$/)) {
                cancelTime = new Date(cancelTimeStr);
            } else {
                cancelTime = new Date(cancelTimeStr.replace('T', ' '));
            }
            const now = new Date();
            
            // Tính thời gian còn lại (milliseconds)
            const diff = cancelTime - now;
            
            if (diff <= 0) {
                // Đã quá thời gian hủy
                timer.innerHTML = '<span class="text-danger fw-bold">Đã quá thời hạn</span>';
                timer.classList.add('text-danger');
                
                // Nếu là Confirmed chưa thanh toán, cập nhật UI ngay lập tức
                if (isConfirmedUnpaid) {
                    console.log('⏰ Confirmed unpaid booking expired, updating UI immediately...');
                    const alertContainer = timer.closest('.alert');
                    if (alertContainer) {
                        alertContainer.style.display = 'none';
                    }
                    const statusBadge = document.querySelector('.status-badge-lg');
                    if (statusBadge) {
                        statusBadge.textContent = 'Đã hủy';
                        statusBadge.className = 'status-badge-lg status-canceled';
                        statusBadge.style.cssText = 'color: #000000 !important; font-weight: 800 !important;';
                    }
                }
            } else {
                // Tính giờ, phút, giây còn lại
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Format hiển thị
                let timeStr = '';
                if (hours > 0) {
                    timeStr = `${hours} giờ ${minutes} phút ${seconds} giây`;
                } else if (minutes > 0) {
                    timeStr = `${minutes} phút ${seconds} giây`;
                } else {
                    timeStr = `${seconds} giây`;
                }
                
                // Thêm màu cảnh báo nếu còn < 5 phút
                if (diff < 5 * 60 * 1000) {
                    timer.innerHTML = `<span class="text-danger fw-bold">⏰ ${timeStr}</span>`;
                } else if (diff < 15 * 60 * 1000) {
                    timer.innerHTML = `<span class="text-warning fw-bold">⏰ ${timeStr}</span>`;
                } else {
                    timer.innerHTML = `⏰ ${timeStr}`;
                }
            }
        }
        
        // Function để refresh dữ liệu từ server (đồng bộ với admin)
        async function refreshBookingDetail() {
            try {
                // Fetch lại trang với cache-busting
                const url = new URL(window.location.href);
                url.searchParams.set('_t', Date.now().toString());
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-store'
                });
                
                if (!response.ok) return;
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Tìm countdown timers mới
                const newPendingTimer = doc.querySelector('.countdown-timer-detail');
                const newConfirmedTimer = doc.querySelector('.countdown-timer-confirmed-unpaid');
                
                // Cập nhật timer nếu có thay đổi
                const currentPendingTimer = document.querySelector('.countdown-timer-detail');
                const currentConfirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
                
                if (newPendingTimer && currentPendingTimer) {
                    const newCancelTime = newPendingTimer.getAttribute('data-cancel-time');
                    const currentCancelTime = currentPendingTimer.getAttribute('data-cancel-time');
                    
                    if (newCancelTime && newCancelTime !== currentCancelTime) {
                        console.log('🔄 Pending timer updated:', currentCancelTime, '->', newCancelTime);
                        currentPendingTimer.setAttribute('data-cancel-time', newCancelTime);
                        currentPendingTimer.setAttribute('data-auto-cancel-minutes', newPendingTimer.getAttribute('data-auto-cancel-minutes') || '');
                        bookingCancelTime = newCancelTime;
                    }
                }
                
                if (newConfirmedTimer && currentConfirmedTimer) {
                    const newCancelTime = newConfirmedTimer.getAttribute('data-cancel-time');
                    const currentCancelTime = currentConfirmedTimer.getAttribute('data-cancel-time');
                    
                    if (newCancelTime && newCancelTime !== currentCancelTime) {
                        console.log('🔄 Confirmed unpaid timer updated:', currentCancelTime, '->', newCancelTime);
                        currentConfirmedTimer.setAttribute('data-cancel-time', newCancelTime);
                        currentConfirmedTimer.setAttribute('data-auto-cancel-minutes', newConfirmedTimer.getAttribute('data-auto-cancel-minutes') || '');
                        bookingCancelTime = newCancelTime;
                    }
                }
            } catch (error) {
                console.error('❌ Error refreshing booking detail:', error);
            }
        }
        
        // Khởi tạo countdown timer và auto-refresh
        document.addEventListener('DOMContentLoaded', function() {
            // Lưu cancel time ban đầu để so sánh
            const pendingTimer = document.querySelector('.countdown-timer-detail');
            const confirmedTimer = document.querySelector('.countdown-timer-confirmed-unpaid');
            
            if (pendingTimer) {
                bookingCancelTime = pendingTimer.getAttribute('data-cancel-time');
            } else if (confirmedTimer) {
                bookingCancelTime = confirmedTimer.getAttribute('data-cancel-time');
            }
            
            // Cập nhật countdown ngay lập tức
            updateCountdown('.countdown-timer-detail', false);
            updateCountdown('.countdown-timer-confirmed-unpaid', true);
            
            // Cập nhật mỗi giây
            setInterval(function() {
                updateCountdown('.countdown-timer-detail', false);
                updateCountdown('.countdown-timer-confirmed-unpaid', true);
            }, 1000);
            
            // Auto-refresh mỗi 5 giây để đồng bộ với admin
            if (pendingTimer || confirmedTimer) {
                refreshInterval = setInterval(() => {
                    refreshBookingDetail();
                }, 5000); // 5 giây
            }
        });
        
        // Tắt auto-refresh khi page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
}

<!-- Modal: Nhập lý do từ chối đơn hàng -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-labelledby="cancelReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelReasonModalLabel">
                    <i class="bi bi-x-circle"></i> Từ chối đơn hàng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Lưu ý:</strong> Hành động này sẽ từ chối đơn hàng và hoàn tiền cho khách hàng.
                </div>
                <div class="mb-3">
                    <label for="cancelReason" class="form-label">
                        <strong>Lý do từ chối: <span class="text-danger">*</span></strong>
                    </label>
                    <textarea 
                        class="form-control" 
                        id="cancelReason" 
                        rows="4" 
                        placeholder="Vui lòng nhập lý do từ chối đơn hàng (tối thiểu 10 ký tự)..."
                        maxlength="500"
                        oninput="updateCharCount()"
                        required></textarea>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Lý do này sẽ được gửi cho khách hàng.
                        </small>
                        <small class="text-muted">
                            <span id="charCount">0</span>/500 ký tự
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Hủy
                </button>
                <button type="button" class="btn btn-danger" onclick="submitCancelReason()">
                    <i class="bi bi-check-circle"></i> Xác nhận từ chối
                </button>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "pendingpayment" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "inprogress" or "in progress" or "in-progress" => "Đang xử lý",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status
        };
    }

    string GetPaymentMethodText(string? paymentMethod)
    {
        if (string.IsNullOrEmpty(paymentMethod))
            return "Chưa thanh toán";

        var methodLower = paymentMethod.ToLower().Trim();
        return methodLower switch
        {
            "vnpay" => "VNPAY",
            "refund" => "Hoàn tiền",
            "cash" => "Tiền mặt",
            "bank transfer" => "Chuyển khoản",
            "momo" => "MoMo",
            "zalo pay" => "ZaloPay",
            "hoàn tiền" => "Hoàn tiền",
            "tiền mặt" => "Tiền mặt",
            "chuyển khoản" => "Chuyển khoản",
            _ => paymentMethod
        };
    }

    string GetPaymentStatusText(string? paymentStatus)
    {
        if (string.IsNullOrEmpty(paymentStatus))
            return "Chưa xác định";

        var statusLower = paymentStatus.ToLower().Trim();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            "cancelled" => "Đã hủy",
            "canceled" => "Đã hủy",
            "đã thanh toán" => "Đã thanh toán",
            "chưa thanh toán" => "Chưa thanh toán",
            "đang chờ" => "Chờ thanh toán",
            "đã hoàn tiền" => "Đã hoàn tiền",
            "đã hủy" => "Đã hủy",
            _ => paymentStatus
        };
    }
}


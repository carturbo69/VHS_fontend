@model VHS_frontend.Areas.Provider.Models.Booking.BookingListResultDTO
@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "L·ªãch s·ª≠ ƒë∆°n h√†ng";
}

<div class="order-management-container">
    <!-- Header with Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
                </h5>
                <div class="text-muted">
                    <i class="bi bi-check-circle text-success"></i> ƒê√£ ho√†n th√†nh
                    <span class="mx-2">|</span>
                    <i class="bi bi-x-circle text-danger"></i> ƒê√£ h·ªßy
                </div>
            </div>
            
            <form method="get" asp-action="History" id="filterForm">
                <div class="row g-3 align-items-end">
                    <!-- Status Filter - CH·ªà Completed v√† Canceled -->
                    <div class="col-md-2">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select name="status" class="form-select form-select-filter" onchange="this.form.submit()">
                            <option value="" selected="@(string.IsNullOrEmpty(ViewBag.CurrentStatus))">T·∫•t c·∫£</option>
                            <option value="Completed" selected="@(ViewBag.CurrentStatus == "Completed")">Ho√†n th√†nh</option>
                            <option value="Canceled" selected="@(ViewBag.CurrentStatus == "Canceled")">ƒê√£ h·ªßy</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-2">
                        <label class="form-label">T·ª´ ng√†y</label>
                        <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ƒê·∫øn ng√†y</label>
                        <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                    </div>

                    <!-- Search -->
                    <div class="col-md-4">
                        <label class="form-label">T√¨m ki·∫øm</label>
                        <input type="text" name="searchTerm" class="form-control" 
                               placeholder="T√™n kh√°ch h√†ng, d·ªãch v·ª•..." value="@ViewBag.SearchTerm" />
                    </div>

                    <!-- Buttons -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> L·ªçc
                        </button>
                    </div>
                </div>
                
                <!-- Quick Month Filters -->
                <div class="row mt-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar-month"></i> L·ªçc nhanh theo th√°ng:
                        </label>
                        <div class="btn-group flex-wrap" role="group">
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="filterByMonth(0)">
                                <i class="bi bi-calendar3"></i> Th√°ng n√†y
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByMonth(-1)">
                                Th√°ng tr∆∞·ªõc
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByMonth(-2)">
                                2 th√°ng tr∆∞·ªõc
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByMonth(-3)">
                                3 th√°ng tr∆∞·ªõc
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearDateFilter()">
                                <i class="bi bi-x-circle"></i> X√≥a l·ªçc ng√†y
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i> 
                            V√≠ d·ª•: "Th√°ng n√†y" s·∫Ω hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n t·ª´ ng√†y 1 ƒë·∫øn cu·ªëi th√°ng @DateTime.Now.ToString("MM/yyyy")
                        </small>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards - TH√ÅNG N√ÄY -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="bi bi-calendar-month"></i> Th·ªëng k√™ l·ªãch s·ª≠ th√°ng @DateTime.Now.ToString("MM/yyyy")
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="stat-card stat-completed">
                        <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCompleted ?? 0)</h3>
                            <p>Ho√†n th√†nh</p>
                            <small class="text-muted d-block mt-1">
                                Th√°ng @DateTime.Now.ToString("MM/yyyy")
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card stat-canceled">
                        <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCanceled ?? 0)</h3>
                            <p>ƒê√£ h·ªßy</p>
                            <small class="text-muted d-block mt-1">
                                Th√°ng @DateTime.Now.ToString("MM/yyyy")
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            @{
                int monthCompleted = ViewBag.MonthCompleted ?? 0;
                int monthCanceled = ViewBag.MonthCanceled ?? 0;
                var total = monthCompleted + monthCanceled;
                var successRate = total > 0 ? ((double)monthCompleted / total * 100) : 0;
            }
            @if (total > 0)
            {
                <div class="mt-3 text-center">
                    <div class="progress" style="height: 25px;">
                        @if (successRate > 0)
                        {
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: @successRate%"
                                 aria-valuenow="@successRate" aria-valuemin="0" aria-valuemax="100">
                                @successRate.ToString("F1")% Ho√†n th√†nh
                            </div>
                        }
                        @if (successRate < 100)
                        {
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: @((100-successRate))%"
                                 aria-valuenow="@(100-successRate)" aria-valuemin="0" aria-valuemax="100">
                                @((100-successRate).ToString("F1"))% H·ªßy
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ th√°ng n√†y
                    </small>
                </div>
            }
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0">
                T·ªïng s·ªë: <span class="badge bg-primary">@Model.TotalCount</span> ƒë∆°n h√†ng
            </h6>
        </div>
        <div class="card-body p-0">
            @if (Model.Items != null && Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>D·ªãch v·ª•</th>
                                <th>Th·ªùi gian</th>
                                <th>S·ªë ti·ªÅn</th>
                                <th>Nh√¢n vi√™n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th class="text-center">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <strong class="text-primary">@booking.BookingCode</strong>
                                        <br />
                                        <small class="text-muted">@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        @booking.CustomerName
                                        <br />
                                        <small class="text-muted">
                                            <i class="bi bi-telephone"></i> @booking.CustomerPhone
                                        </small>
                                    </td>
                                    <td>
                                        @booking.ServiceName
                                        <br />
                                        <small class="text-muted">
                                            <i class="bi bi-geo-alt"></i> @booking.Address
                                        </small>
                                    </td>
                                    <td>
                                        <i class="bi bi-calendar3"></i>
                                        @booking.BookingTime.ToString("dd/MM/yyyy")
                                        <br />
                                        <i class="bi bi-clock"></i>
                                        @booking.BookingTime.ToString("HH:mm")
                                    </td>
                                    <td>
                                        <strong class="text-success">@booking.Amount.ToString("N0") VND</strong>
                                        @if (!string.IsNullOrEmpty(booking.PaymentStatus))
                                        {
                                            <br />
                                            <small class="badge bg-info">@GetPaymentStatusText(booking.PaymentStatus)</small>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.StaffName))
                                        {
                                            <i class="bi bi-person-check text-success"></i>
                                            @booking.StaffName
                                        }
                                        else if (booking.Status == "Canceled" || booking.Status == "Cancelled")
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Ch∆∞a ph√¢n c√¥ng</span>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            // üêõ DEBUG: In ra Status th·ª±c t·∫ø
                                            var statusDebug = booking.Status ?? "NULL";
                                            Console.WriteLine($"[History View] BookingId={booking.BookingId}, Status='{statusDebug}'");
                                        }
                                        @if (booking.Status == "Completed")
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle"></i> Ho√†n th√†nh
                                            </span>
                                        }
                                        else if (booking.Status == "Canceled")
                                        {
                                            <span class="badge bg-danger">
                                                <i class="bi bi-x-circle"></i> ƒê√£ h·ªßy
                                            </span>
                                        }
                                        else
                                        {
                                            <!-- üêõ DEBUG: Hi·ªÉn th·ªã Status kh√¥ng match -->
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-question-circle"></i> @booking.Status
                                            </span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <a href="@Url.Action("Details", "Order", new { id = booking.BookingId })" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Chi ti·∫øt
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë∆°n h√†ng n√†o.</p>
                    <small class="text-muted">C√°c ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh ho·∫∑c ƒë√£ h·ªßy s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y.</small>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
}

@functions {
    string GetPaymentStatusText(string paymentStatus)
    {
        var statusLower = paymentStatus?.ToLower() ?? "";
        return statusLower switch
        {
            "paid" => "ƒê√£ thanh to√°n",
            "unpaid" => "Ch∆∞a thanh to√°n",
            "pending" => "Ch·ªù thanh to√°n",
            _ => paymentStatus ?? "Ch∆∞a x√°c ƒë·ªãnh"
        };
    }
}

@section Scripts {
    <script>
        // L·ªçc nhanh theo th√°ng
        function filterByMonth(monthOffset) {
            const today = new Date();
            const targetDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
            
            // Ng√†y ƒë·∫ßu th√°ng
            const fromDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
            const fromDateStr = fromDate.toISOString().split('T')[0];
            
            // Ng√†y cu·ªëi th√°ng
            const toDate = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);
            const toDateStr = toDate.toISOString().split('T')[0];
            
            // Set gi√° tr·ªã v√†o input
            document.querySelector('input[name="fromDate"]').value = fromDateStr;
            document.querySelector('input[name="toDate"]').value = toDateStr;
            
            // Log ƒë·ªÉ debug
            const monthName = targetDate.toLocaleString('vi-VN', { month: 'long', year: 'numeric' });
            console.log(`[Filter by Month] ${monthName}: ${fromDateStr} ‚Üí ${toDateStr}`);
            
            // Submit form
            document.getElementById('filterForm').submit();
        }
        
        // X√≥a filter ng√†y
        function clearDateFilter() {
            document.querySelector('input[name="fromDate"]').value = '';
            document.querySelector('input[name="toDate"]').value = '';
            console.log('[Clear Date Filter] Cleared fromDate and toDate');
            document.getElementById('filterForm').submit();
        }
        
        // Log status c·ªßa bookings ƒë·ªÉ debug
        console.log('[History View] Loaded');
        document.querySelectorAll('.badge').forEach((badge, index) => {
            const status = badge.textContent.trim();
            console.log(`[History View] BookingId=${index}, Status='${status}'`);
        });
    </script>
}

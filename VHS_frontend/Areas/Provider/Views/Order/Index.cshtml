@model VHS_frontend.Areas.Provider.Models.Booking.BookingListResultDTO
@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "Qu·∫£n l√≠ ƒë∆°n h√†ng";
}

<div class="order-management-container">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 order-page-header">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-receipt-cutoff me-2"></i>
                    Qu·∫£n l√Ω ƒê∆°n h√†ng
                </h4>
                <button class="btn btn-secondary btn-sm" onclick="location.reload()" title="L√†m m·ªõi trang">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    L√†m m·ªõi
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card shadow-sm mb-4 filter-card">
        <div class="card-body">
            <form method="get" asp-action="Index" id="filterForm">
                <div class="row g-3 align-items-end">
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select name="status" class="form-select form-select-filter" onchange="this.form.submit()">
                            <option value="" selected="@(string.IsNullOrEmpty(ViewBag.CurrentStatus))">T·∫•t c·∫£</option>
                            <option value="Pending" selected="@(ViewBag.CurrentStatus == "Pending")">Ch·ªù x·ª≠ l√Ω</option>
                            <option value="Confirmed" selected="@(ViewBag.CurrentStatus == "Confirmed")">ƒê√£ x√°c nh·∫≠n</option>
                            <option value="Completed" selected="@(ViewBag.CurrentStatus == "Completed")">Ho√†n th√†nh</option>
                            <option value="Canceled" selected="@(ViewBag.CurrentStatus == "Canceled")">ƒê√£ h·ªßy</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-2">
                        <label class="form-label">T·ª´ ng√†y</label>
                        <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ƒê·∫øn ng√†y</label>
                        <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                    </div>

                    <!-- Search -->
                    <div class="col-md-4">
                        <label class="form-label">T√¨m ki·∫øm</label>
                        <input type="text" name="searchTerm" class="form-control" 
                               placeholder="T√™n kh√°ch h√†ng, d·ªãch v·ª•..." value="@ViewBag.SearchTerm" />
                    </div>

                    <!-- Buttons -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> L·ªçc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="card shadow-sm mb-4">
        <div class="card-header order-stats-header">
            <h6 class="mb-0">
                <i class="bi bi-calendar-month me-2"></i> Th·ªëng k√™ ƒë∆°n h√†ng
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="stat-card stat-pending">
                        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthPending ?? 0)</h3>
                            <p>Ch·ªù x·ª≠ l√Ω</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-confirmed">
                        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthConfirmed ?? 0)</h3>
                            <p>ƒê√£ x√°c nh·∫≠n</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-completed">
                        <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCompleted ?? 0)</h3>
                            <p>Ho√†n th√†nh</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-canceled">
                        <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCanceled ?? 0)</h3>
                            <p>ƒê√£ h·ªßy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card shadow-sm">
        <div class="card-header order-table-header">
            <h6 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>
                Danh s√°ch ƒë∆°n h√†ng (@Model.TotalCount)
            </h6>
        </div>
        <div class="card-body p-0">
            @if (Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0 order-table">
                        <thead>
                            <tr>
                                <th style="width: 12%;">M√£ ƒë∆°n</th>
                                <th style="width: 11%;">Kh√°ch h√†ng</th>
                                <th style="width: 14%;">D·ªãch v·ª•</th>
                                <th style="width: 9%;">Th·ªùi gian</th>
                                <th style="width: 13%;">ƒê·ªãa ch·ªâ</th>
                                <th style="width: 11%;">S·ªë ti·ªÅn</th>
                                <th style="width: 10%;">Tr·∫°ng th√°i</th>
                                <th style="width: 11%;">Nh√¢n vi√™n</th>
                                <th style="width: 9%;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <strong class="booking-code">@booking.BookingCode</strong>
                                        <br />
                                        <small class="text-muted">@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@booking.CustomerName</div>
                                    </td>
                                    <td>
                                        <div class="service-name">@booking.ServiceName</div>
                                    </td>
                                    <td>
                                        <div>@booking.BookingTime.ToString("dd/MM/yyyy")</div>
                                        <small class="text-muted">@booking.BookingTime.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.Address))
                                        {
                                            <div class="address-text" title="@booking.Address">
                                                <i class="bi bi-geo-alt me-1"></i>
                                                @(booking.Address.Length > 30 ? booking.Address.Substring(0, 30) + "..." : booking.Address)
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <strong class="text-primary">@booking.Amount.ToString("N0") VND</strong>
                                        @if (!string.IsNullOrEmpty(booking.PaymentStatus))
                                        {
                                            <br />
                                            <span class="badge payment-badge payment-@(booking.PaymentStatus.ToLower().Replace(" ", "-"))" style="color: #000000 !important; font-weight: 800 !important;">
                                                @GetPaymentStatusText(booking.PaymentStatus)
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge status-badge status-@(booking.Status.ToLower().Replace(" ", "-"))" style="color: #000000 !important; font-weight: 800 !important;">
                                            @GetStatusText(booking.Status)
                                        </span>
                                        @* Hi·ªÉn th·ªã countdown timer cho booking Pending *@
                                        @{
                                            var statusNorm = (booking.Status ?? string.Empty).Trim();
                                            // Ki·ªÉm tra nhi·ªÅu c√°ch vi·∫øt c·ªßa Pending
                                            var isPendingBooking = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("ch·ªù", StringComparison.OrdinalIgnoreCase);
                                        }
                                        @if (isPendingBooking)
                                        {
                                            var cancelMinutes = booking.AutoCancelMinutes ?? 30; // M·∫∑c ƒë·ªãnh 30 ph√∫t
                                            var createdAt = booking.CreatedAt;
                                            // S·ª≠ d·ª•ng CreatedAt t·ª´ booking, n·∫øu kh√¥ng c√≥ th√¨ d√πng th·ªùi gian hi·ªán t·∫°i
                                            DateTime validCreatedAt;
                                            if (createdAt != default(DateTime) && createdAt != DateTime.MinValue && createdAt.Year > 2000)
                                            {
                                                validCreatedAt = createdAt;
                                            }
                                            else
                                            {
                                                // Fallback: d√πng th·ªùi gian hi·ªán t·∫°i n·∫øu CreatedAt kh√¥ng h·ª£p l·ªá
                                                validCreatedAt = DateTime.Now;
                                            }
                                            var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                                            var remainingMinutes = Math.Max(0, (int)Math.Ceiling((cancelTime - DateTime.Now).TotalMinutes));
                                            <br />
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <small class="text-danger" style="font-size: 0.75rem;">
                                                    <i class="bi bi-clock-history"></i>
                                                    <span class="countdown-timer" 
                                                          data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-booking-id="@booking.BookingId"
                                                          data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-current-cancel-minutes="@cancelMinutes">
                                                        ƒêang t√≠nh...
                                                    </span>
                                                </small>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.StaffName))
                                        {
                                            <span class="staff-assigned">
                                                <i class="bi bi-person-check me-1"></i>
                                                <span>@booking.StaffName</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="staff-unassigned">
                                                <i class="bi bi-person-x me-1"></i>
                                                <span>Ch∆∞a ph√¢n c√¥ng</span>
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@booking.BookingId" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <div class="card-footer">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                @if (Model.PageNumber > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index" 
                                           asp-route-pageNumber="@(Model.PageNumber - 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                }

                                @for (int i = 1; i <= Model.TotalPages; i++)
                                {
                                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                        <a class="page-link" asp-action="Index" 
                                           asp-route-pageNumber="@i"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (Model.PageNumber < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index" 
                                           asp-route-pageNumber="@(Model.PageNumber + 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
    <style>
        /* Force status badge text color to black in light mode */
        .order-management-container .badge.status-badge.status-pending,
        .order-management-container .badge.status-badge.status-confirmed,
        .order-management-container .badge.status-badge.status-completed,
        .order-management-container .badge.status-badge.status-canceled,
        .order-table .badge.status-badge.status-pending,
        .order-table .badge.status-badge.status-confirmed,
        .order-table .badge.status-badge.status-completed,
        .order-table .badge.status-badge.status-canceled,
        .order-table tbody td .badge.status-badge {
            color: #000000 !important;
        }
        
        /* Force payment badge text color to black in light mode */
        .order-table .payment-badge.payment-paid,
        .order-table .payment-badge.payment-unpaid,
        .order-table .payment-badge.payment-pending,
        .order-table tbody td .payment-badge {
            color: #000000 !important;
        }
        
        /* Force status badge text color to white in dark mode */
        .dark .order-management-container .badge.status-badge.status-pending,
        .dark .order-management-container .badge.status-badge.status-confirmed,
        .dark .order-management-container .badge.status-badge.status-completed,
        .dark .order-management-container .badge.status-badge.status-canceled,
        .dark .order-table .badge.status-badge.status-pending,
        .dark .order-table .badge.status-badge.status-confirmed,
        .dark .order-table .badge.status-badge.status-completed,
        .dark .order-table .badge.status-badge.status-canceled,
        .dark .order-table tbody td .badge.status-badge {
            color: #ffffff !important;
        }
        
        /* Force payment badge text color to white in dark mode */
        .dark .order-table .payment-badge.payment-paid,
        .dark .order-table .payment-badge.payment-unpaid,
        .dark .order-table .payment-badge.payment-pending,
        .dark .order-table tbody td .payment-badge {
            color: #ffffff !important;
        }
        
        /* Allow status and payment badges to wrap text */
        .order-table tbody td {
            white-space: normal !important;
            word-wrap: break-word;
        }
        
        .order-table .badge.status-badge,
        .order-table .badge.payment-badge {
            white-space: normal !important;
            word-wrap: break-word;
            display: inline-block;
            max-width: 100%;
            line-height: 1.4;
            text-align: center;
        }
        
        /* Ensure table cells can wrap */
        .order-table td {
            vertical-align: middle;
        }
        
        /* Service Completed Status Badge - M√†u xanh d∆∞∆°ng nh·∫°t ƒë·ªÉ ph√¢n bi·ªát v·ªõi Completed */
        .order-management-container .order-table tbody td .badge.status-badge.status-service-completed,
        .order-management-container .order-table tbody td .status-badge.status-service-completed,
        .order-management-container .order-table .badge.status-badge.status-service-completed,
        .order-management-container .order-table .status-badge.status-service-completed,
        .order-table tbody td .badge.status-badge.status-service-completed,
        .order-table tbody td .status-badge.status-service-completed,
        .order-table .badge.status-badge.status-service-completed,
        .order-table .status-badge.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 1px solid #6366f1 !important;
            font-weight: 800 !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .order-management-container .order-table tbody td .badge.status-badge.status-service-completed,
        .dark .order-management-container .order-table tbody td .status-badge.status-service-completed,
        .dark .order-management-container .order-table .badge.status-badge.status-service-completed,
        .dark .order-management-container .order-table .status-badge.status-service-completed,
        .dark .order-table tbody td .badge.status-badge.status-service-completed,
        .dark .order-table tbody td .status-badge.status-service-completed,
        .dark .order-table .badge.status-badge.status-service-completed,
        .dark .order-table .status-badge.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Rejected Badge */
        .order-table .payment-badge.payment-rejected,
        .order-table tbody td .payment-badge.payment-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
            color: #000000 !important;
            border: 1px solid #ef4444 !important;
            font-weight: 800 !important;
        }
        
        .dark .order-table .payment-badge.payment-rejected,
        .dark .order-table tbody td .payment-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
        }
    </style>
}

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Ch∆∞a x√°c ƒë·ªãnh";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "ƒêang ch·ªù x·ª≠ l√Ω",
            "confirmed" => "ƒê√£ x√°c nh·∫≠n",
            "completed" => "Ho√†n th√†nh",
            "service completed" or "service-completed" => "X√°c nh·∫≠n ho√†n th√†nh",
            "canceled" or "cancelled" => "ƒê√£ h·ªßy",
            "inprogress" or "in progress" or "in-progress" => "ƒêang x·ª≠ l√Ω",
            "processing" => "ƒêang x·ª≠ l√Ω",
            "rejected" => "ƒê√£ t·ª´ ch·ªëi",
            "refunded" => "ƒê√£ ho√†n ti·ªÅn",
            _ => status // Gi·ªØ nguy√™n n·∫øu kh√¥ng kh·ªõp, nh∆∞ng n√™n ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü backend
        };
    }

    string GetPaymentStatusText(string paymentStatus)
    {
        if (string.IsNullOrWhiteSpace(paymentStatus))
            return "Ch∆∞a x√°c ƒë·ªãnh";
            
        var statusLower = paymentStatus.Trim().ToLower();
        return statusLower switch
        {
            "paid" => "ƒê√£ thanh to√°n",
            "unpaid" => "Ch∆∞a thanh to√°n",
            "pending" => "Ch·ªù thanh to√°n",
            "refunded" => "ƒê√£ ho√†n ti·ªÅn",
            "waiting for payment" or "waiting-for-payment" => "Ch·ªù thanh to√°n",
            "rejected" => "ƒê√£ t·ª´ ch·ªëi",
            _ => paymentStatus // Gi·ªØ nguy√™n n·∫øu kh√¥ng kh·ªõp
        };
    }
}

@section Scripts {
    <script>
        // Force apply badge text colors (status and payment)
        function applyBadgeColors() {
            const statusBadges = document.querySelectorAll('.order-table .badge.status-badge');
            const paymentBadges = document.querySelectorAll('.order-table .payment-badge');
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#ffffff' : '#000000';
            
            // Apply to status badges
            statusBadges.forEach(badge => {
                badge.style.setProperty('color', textColor, 'important');
                badge.style.setProperty('font-weight', '800', 'important');
            });
            
            // Apply to payment badges
            paymentBadges.forEach(badge => {
                badge.style.setProperty('color', textColor, 'important');
                badge.style.setProperty('font-weight', '800', 'important');
            });
        }
        
        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ track c√°c booking ƒë√£ x·ª≠ l√Ω khi countdown h·∫øt
        let expiredBookingsProcessed = new Set();
        
        // Countdown timer cho booking Pending
        function updateCountdown() {
            const timers = document.querySelectorAll('.countdown-timer');
            
            timers.forEach(timer => {
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (!cancelTimeStr) return;
                
                // Parse th·ªùi gian h·ªßy (ƒë√£ l√† gi·ªù Vi·ªát Nam t·ª´ server)
                const cancelTime = new Date(cancelTimeStr);
                const now = new Date();
                
                // T√≠nh th·ªùi gian c√≤n l·∫°i (milliseconds)
                const diff = cancelTime - now;
                
                if (diff <= 0) {
                    // ƒê√£ qu√° th·ªùi gian h·ªßy - NH∆ØNG refresh ngay ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi t·ª´ server
                    // (c√≥ th·ªÉ admin ƒë√£ gia h·∫°n th√™m th·ªùi gian)
                    const bookingId = timer.getAttribute('data-booking-id');
                    if (bookingId && !expiredBookingsProcessed.has(bookingId)) {
                        console.log(`‚è∞ Countdown expired for booking ${bookingId}, refreshing to check for admin updates...`);
                        expiredBookingsProcessed.add(bookingId);
                        
                        // Refresh ngay l·∫≠p t·ª©c ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi (c√≥ th·ªÉ AutoCancelMinutes ƒë√£ ƒë∆∞·ª£c admin c·∫≠p nh·∫≠t)
                        refreshBookingListSilent().then(() => {
                            // Sau khi refresh, ki·ªÉm tra l·∫°i xem booking c√≥ c√≤n pending kh√¥ng
                            const updatedTimer = document.querySelector(`.countdown-timer[data-booking-id="${bookingId}"]`);
                            if (!updatedTimer) {
                                // N·∫øu kh√¥ng c√≤n timer, c√≥ nghƒ©a l√† booking ƒë√£ b·ªã h·ªßy ho·∫∑c ƒë·ªïi tr·∫°ng th√°i
                                console.log(`‚úÖ Booking ${bookingId} status updated after refresh`);
                            } else {
                                // N·∫øu v·∫´n c√≤n timer, c√≥ nghƒ©a l√† admin ƒë√£ gia h·∫°n th√™m th·ªùi gian
                                const newCancelTimeStr = updatedTimer.getAttribute('data-cancel-time');
                                if (newCancelTimeStr) {
                                    const newCancelTime = new Date(newCancelTimeStr);
                                    const newDiff = newCancelTime - new Date();
                                    if (newDiff > 0) {
                                        console.log(`‚úÖ Booking ${bookingId} was extended by admin, new time remaining: ${Math.ceil(newDiff / 60000)} minutes`);
                                        // C·∫≠p nh·∫≠t l·∫°i countdown v·ªõi th·ªùi gian m·ªõi
                                        updateCountdown();
                                    }
                                }
                            }
                        }).catch(err => {
                            console.error('Error refreshing after countdown expired:', err);
                        });
                    }
                    
                    // Hi·ªÉn th·ªã t·∫°m th·ªùi "ƒêang ki·ªÉm tra..." trong khi refresh
                    timer.innerHTML = '<span class="text-warning fw-bold">ƒêang ki·ªÉm tra...</span>';
                    timer.classList.add('text-warning');
                } else {
                    // T√≠nh gi·ªù, ph√∫t, gi√¢y c√≤n l·∫°i
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    // Format hi·ªÉn th·ªã
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours} gi·ªù ${minutes} ph√∫t`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes} ph√∫t ${seconds} gi√¢y`;
                    } else {
                        timeStr = `${seconds} gi√¢y`;
                    }
                    
                    // Th√™m m√†u c·∫£nh b√°o n·∫øu c√≤n < 5 ph√∫t
                    if (diff < 5 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-danger fw-bold">C√≤n ${timeStr}</span>`;
                    } else if (diff < 15 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-warning fw-bold">C√≤n ${timeStr}</span>`;
                    } else {
                        timer.innerHTML = `C√≤n ${timeStr}`;
                    }
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            applyBadgeColors();
            
            // Watch for theme changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'class') {
                        applyBadgeColors();
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });
            
            // C·∫≠p nh·∫≠t countdown timer ngay l·∫≠p t·ª©c
            updateCountdown();
            
            // C·∫≠p nh·∫≠t m·ªói gi√¢y v√† ki·ªÉm tra xem c√≥ booking n√†o h·∫øt th·ªùi gian kh√¥ng
            let refreshScheduledForExpired = false; // ƒê·ªÉ tr√°nh refresh nhi·ªÅu l·∫ßn
            setInterval(function() {
                updateCountdown(); // C·∫≠p nh·∫≠t countdown v√† c·∫≠p nh·∫≠t DOM ngay khi h·∫øt th·ªùi gian
                
                // Ki·ªÉm tra xem c√≥ booking n√†o ƒë√£ h·∫øt th·ªùi gian kh√¥ng (ƒë·ªÉ sync v·ªõi server)
                if (!refreshScheduledForExpired) {
                    const timers = document.querySelectorAll('.countdown-timer');
                    let hasExpired = false;
                    let expiredBookingIds = [];
                    
                    timers.forEach(timer => {
                        const cancelTimeStr = timer.getAttribute('data-cancel-time');
                        const bookingId = timer.getAttribute('data-booking-id');
                        if (!cancelTimeStr || !bookingId) return;
                        
                        // Ch·ªâ x·ª≠ l√Ω n·∫øu ch∆∞a ƒë∆∞·ª£c x·ª≠ l√Ω
                        if (expiredBookingsProcessed.has(bookingId)) return;
                        
                        const cancelTime = new Date(cancelTimeStr);
                        const now = new Date();
                        const diff = cancelTime - now;
                        
                        if (diff <= 0) {
                            hasExpired = true;
                            expiredBookingIds.push(bookingId);
                            expiredBookingsProcessed.add(bookingId); // ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω
                        }
                    });
                    
                    // N·∫øu c√≥ booking h·∫øt th·ªùi gian, sync v·ªõi server (silently, kh√¥ng th√¥ng b√°o)
                    if (hasExpired && expiredBookingIds.length > 0) {
                        refreshScheduledForExpired = true; // ƒê√°nh d·∫•u ƒë√£ schedule refresh
                        console.log(`‚è∞ Detected ${expiredBookingIds.length} expired booking(s), syncing with server silently...`);
                        
                        // Sync v·ªõi server sau 1 gi√¢y (ƒë·ªÉ backend c√≥ th·ªùi gian x·ª≠ l√Ω) - KH√îNG hi·ªÉn th·ªã notification
                        setTimeout(() => {
                            refreshBookingListSilent().finally(() => {
                                // Reset flag sau 5 gi√¢y
                                setTimeout(() => {
                                    refreshScheduledForExpired = false;
                                }, 5000);
                            });
                        }, 1000); // ƒê·ª£i 1 gi√¢y ƒë·ªÉ backend x·ª≠ l√Ω
                    }
                }
            }, 1000); // Check m·ªói gi√¢y ƒë·ªÉ ph√°t hi·ªán ngay khi h·∫øt th·ªùi gian
        });

        // ========================================
        // AUTO-REFRESH: T·ª± ƒë·ªông c·∫≠p nh·∫≠t danh s√°ch booking KH√îNG RELOAD TRANG
        // ========================================
        let isRefreshing = false;
        let refreshInterval = null;
        let refreshScheduledForExpired = false; // Flag ƒë·ªÉ tr√°nh refresh nhi·ªÅu l·∫ßn khi ph√°t hi·ªán expired
        
        // Function ƒë·ªÉ fetch v√† c·∫≠p nh·∫≠t danh s√°ch booking ƒë·ªông (c√≥ notification)
        async function refreshBookingList(showNotification = true) {
            if (isRefreshing) return;
            
            // Ki·ªÉm tra n·∫øu user ƒëang t∆∞∆°ng t√°c v·ªõi form ho·∫∑c modal
            const activeModal = document.querySelector('.modal.show');
            const activeForm = document.querySelector('form:has(input:focus), form:has(textarea:focus)');
            
            if (activeModal || activeForm) {
                console.log('‚è∏Ô∏è Skipping refresh - user is interacting with form/modal');
                return;
            }
            
            isRefreshing = true;
            
            try {
                // L∆∞u scroll position tr∆∞·ªõc khi c·∫≠p nh·∫≠t
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Fetch l·∫°i trang v·ªõi header ƒë·ªÉ nh·∫≠n HTML - th√™m timestamp ƒë·ªÉ tr√°nh cache
                const url = new URL(window.location.href);
                url.searchParams.set('_t', Date.now().toString()); // Cache busting
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest', // ƒê√°nh d·∫•u ƒë√¢y l√† AJAX request
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    cache: 'no-store' // ƒê·∫£m b·∫£o kh√¥ng cache
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch booking list');
                }
                
                const html = await response.text();
                
                // Parse HTML response v√† extract ph·∫ßn table body
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTableBody = doc.querySelector('.order-table tbody');
                const newCardFooter = doc.querySelector('.card-footer');
                
                if (newTableBody) {
                    // L·∫•y table body hi·ªán t·∫°i
                    const currentTableBody = document.querySelector('.order-table tbody');
                    const currentCardFooter = document.querySelector('.card-footer');
                    
                    if (currentTableBody) {
                        // Fade out effect (ch·ªâ khi c√≥ notification)
                        if (showNotification) {
                            currentTableBody.style.opacity = '0.5';
                            currentTableBody.style.transition = 'opacity 0.3s';
                        }
                        
                        // Replace n·ªôi dung sau 300ms (ho·∫∑c ngay l·∫≠p t·ª©c n·∫øu kh√¥ng c√≥ notification)
                        setTimeout(() => {
                            // Replace table body
                            currentTableBody.innerHTML = newTableBody.innerHTML;
                            
                            // Replace pagination n·∫øu c√≥
                            if (newCardFooter && currentCardFooter) {
                                currentCardFooter.innerHTML = newCardFooter.innerHTML;
                            } else if (newCardFooter && !currentCardFooter) {
                                // Th√™m pagination m·ªõi n·∫øu kh√¥ng c√≥
                                const card = document.querySelector('.card.shadow-sm');
                                if (card) {
                                    card.insertAdjacentHTML('beforeend', newCardFooter.outerHTML);
                                }
                            } else if (!newCardFooter && currentCardFooter) {
                                // X√≥a pagination n·∫øu kh√¥ng c√≤n
                                currentCardFooter.remove();
                            }
                            
                            // Fade in effect (ch·ªâ khi c√≥ notification)
                            if (showNotification) {
                                currentTableBody.style.opacity = '1';
                            }
                            
                            // Re-initialize c√°c event handlers c·∫ßn thi·∫øt
                            initializeEventHandlers();
                            
                            // Reset expiredBookingsProcessed ƒë·ªÉ c√≥ th·ªÉ x·ª≠ l√Ω l·∫°i c√°c booking ƒë√£ ƒë∆∞·ª£c gia h·∫°n
                            expiredBookingsProcessed.clear();
                            
                            // Log ƒë·ªÉ debug ƒë·ªìng b·ªô v√† so s√°nh v·ªõi gi√° tr·ªã c≈©
                            const allTimers = document.querySelectorAll('.countdown-timer');
                            console.log(`üìä After refresh: Found ${allTimers.length} countdown timers`);
                            allTimers.forEach(timer => {
                                const bid = timer.getAttribute('data-booking-id');
                                const ctime = timer.getAttribute('data-cancel-time');
                                const minutes = timer.getAttribute('data-current-cancel-minutes');
                                const createdAt = timer.getAttribute('data-created-at');
                                
                                if (bid && ctime) {
                                    const cancelTime = new Date(ctime);
                                    const now = new Date();
                                    const remaining = Math.max(0, Math.round((cancelTime - now) / 60000));
                                    
                                    // So s√°nh v·ªõi gi√° tr·ªã c≈©
                                    const oldCancelTime = bookingCancelTimes.get(bid);
                                    if (oldCancelTime && oldCancelTime !== ctime) {
                                        const oldTime = new Date(oldCancelTime);
                                        const oldRemaining = Math.max(0, Math.round((oldTime - now) / 60000));
                                        const diff = remaining - oldRemaining;
                                        console.log(`   üîÑ Booking ${bid} UPDATED:`);
                                        console.log(`      Old: ${oldRemaining} min (${oldCancelTime})`);
                                        console.log(`      New: ${remaining} min (${ctime})`);
                                        console.log(`      Diff: ${diff > 0 ? '+' : ''}${diff} minutes`);
                                        console.log(`      AutoCancelMinutes: ${minutes}, CreatedAt: ${createdAt}`);
                                    } else {
                                        console.log(`   Booking ${bid}: ${remaining} minutes remaining (AutoCancelMinutes: ${minutes}, CancelTime: ${ctime})`);
                                    }
                                }
                            });
                            
                            // Kh√¥i ph·ª•c scroll position
                            window.scrollTo(0, scrollTop);
                            
                            console.log('‚úÖ Booking list updated successfully' + (showNotification ? '' : ' (silent)'));
                        }, showNotification ? 300 : 0); // Ngay l·∫≠p t·ª©c n·∫øu kh√¥ng c√≥ notification
                    } else {
                        throw new Error('Table body container not found');
                    }
                } else {
                    throw new Error('New table body not found in response');
                }
            } catch (error) {
                console.error('‚ùå Error refreshing booking list:', error);
            } finally {
                isRefreshing = false;
            }
        }
        
        // Function ƒë·ªÉ sync v·ªõi server im l·∫∑ng (kh√¥ng hi·ªÉn th·ªã notification)
        async function refreshBookingListSilent() {
            return refreshBookingList(false); // G·ªçi v·ªõi showNotification = false
        }
        
        // Function ƒë·ªÉ hi·ªÉn th·ªã notification refresh
        function showRefreshNotification(message, type) {
            // X√≥a notification c≈© n·∫øu c√≥
            const existingNotif = document.querySelector('.refresh-notification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            // T·∫°o notification m·ªõi
            const notification = document.createElement('div');
            notification.className = 'refresh-notification';
            const bgColor = type === 'success' ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)';
            notification.style.cssText = `position: fixed; bottom: 20px; right: 20px; background: ${bgColor}; color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.875rem; z-index: 1050; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;`;
            notification.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            document.body.appendChild(notification);
            
            // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Function ƒë·ªÉ re-initialize event handlers sau khi c·∫≠p nh·∫≠t DOM
        // L∆∞u tr·ªØ cancel time ban ƒë·∫ßu c·ªßa m·ªói booking ƒë·ªÉ so s√°nh khi refresh
        const bookingCancelTimes = new Map();
        
        function initializeEventHandlers() {
            // Re-apply badge colors
            applyBadgeColors();
            
            // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t cancel times
            const timers = document.querySelectorAll('.countdown-timer');
            timers.forEach(timer => {
                const bookingId = timer.getAttribute('data-booking-id');
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                const cancelMinutes = timer.getAttribute('data-current-cancel-minutes');
                const createdAt = timer.getAttribute('data-created-at');
                
                if (bookingId && cancelTimeStr) {
                    const oldCancelTime = bookingCancelTimes.get(bookingId);
                    if (oldCancelTime && oldCancelTime !== cancelTimeStr) {
                        // Cancel time ƒë√£ thay ƒë·ªïi (admin ƒë√£ c·∫≠p nh·∫≠t)
                        const oldTime = new Date(oldCancelTime);
                        const newTime = new Date(cancelTimeStr);
                        const diffMinutes = Math.round((newTime - oldTime) / 60000);
                        console.log(`üîÑ Booking ${bookingId} cancel time updated:`);
                        console.log(`   Old: ${oldCancelTime} (${oldTime.toLocaleString('vi-VN')})`);
                        console.log(`   New: ${cancelTimeStr} (${newTime.toLocaleString('vi-VN')})`);
                        console.log(`   Diff: ${diffMinutes} minutes`);
                        console.log(`   AutoCancelMinutes: ${cancelMinutes}, CreatedAt: ${createdAt}`);
                        bookingCancelTimes.set(bookingId, cancelTimeStr);
                    } else if (!oldCancelTime) {
                        // L·∫ßn ƒë·∫ßu ti√™n th·∫•y booking n√†y
                        console.log(`üìù Initializing booking ${bookingId}: cancelTime=${cancelTimeStr}, minutes=${cancelMinutes}, createdAt=${createdAt}`);
                        bookingCancelTimes.set(bookingId, cancelTimeStr);
                    }
                }
            });
            
            // Re-initialize countdown timers
            updateCountdown();
            
            // Re-initialize pagination links (Bootstrap s·∫Ω t·ª± ƒë·ªông ho·∫°t ƒë·ªông)
            // Re-initialize modal triggers (Bootstrap s·∫Ω t·ª± ƒë·ªông ho·∫°t ƒë·ªông v·ªõi data attributes)
        }
        
        // Auto-refresh ƒë·ªãnh k·ª≥: m·ªói 5 gi√¢y ƒë·ªÉ c·∫≠p nh·∫≠t nhanh h∆°n khi admin thay ƒë·ªïi
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                refreshBookingList();
            }, 5000); // 5 gi√¢y - c·∫≠p nh·∫≠t r·∫•t nhanh ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi thay ƒë·ªïi t·ª´ admin
        }
        
        // Ki·ªÉm tra ƒë·ªãnh k·ª≥ xem c√≥ booking n√†o c√≥ cancel time thay ƒë·ªïi kh√¥ng (m·ªói 2 gi√¢y)
        // V√† so s√°nh v·ªõi d·ªØ li·ªáu t·ª´ server ƒë·ªÉ ph√°t hi·ªán thay ƒë·ªïi t·ª´ admin
        let cancelTimeCheckInterval = null;
        function startCancelTimeCheck() {
            if (cancelTimeCheckInterval) {
                clearInterval(cancelTimeCheckInterval);
            }
            
            cancelTimeCheckInterval = setInterval(() => {
                // Ki·ªÉm tra t·∫•t c·∫£ countdown timers hi·ªán t·∫°i
                const timers = document.querySelectorAll('.countdown-timer');
                let needsRefresh = false;
                
                timers.forEach(timer => {
                    const bookingId = timer.getAttribute('data-booking-id');
                    const currentCancelTime = timer.getAttribute('data-cancel-time');
                    const currentMinutes = timer.getAttribute('data-current-cancel-minutes');
                    
                    if (bookingId && currentCancelTime) {
                        const storedCancelTime = bookingCancelTimes.get(bookingId);
                        if (storedCancelTime && storedCancelTime !== currentCancelTime) {
                            // Cancel time ƒë√£ thay ƒë·ªïi trong DOM - c√≥ th·ªÉ do refresh
                            // Nh∆∞ng c·∫ßn ki·ªÉm tra xem c√≥ ph·∫£i do admin c·∫≠p nh·∫≠t kh√¥ng
                            console.log(`üîÑ Detected cancel time change in DOM for booking ${bookingId}`);
                            console.log(`   Stored: ${storedCancelTime}, Current: ${currentCancelTime}`);
                            needsRefresh = true;
                        }
                    }
                });
                
                // N·∫øu c√≥ thay ƒë·ªïi, refresh ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ server
                if (needsRefresh) {
                    console.log('üîÑ Refreshing to sync with server...');
                    refreshBookingListSilent();
                }
            }, 2000); // Ki·ªÉm tra m·ªói 2 gi√¢y ƒë·ªÉ ph√°t hi·ªán nhanh h∆°n
        }
        
        // Kh·ªüi ƒë·ªông auto-refresh v√† cancel time check khi page load
        document.addEventListener('DOMContentLoaded', function() {
            // B·∫Øt ƒë·∫ßu auto-refresh
            startAutoRefresh();
            
            // B·∫Øt ƒë·∫ßu ki·ªÉm tra cancel time changes
            startCancelTimeCheck();
            
            // Kh·ªüi t·∫°o bookingCancelTimes map v·ªõi c√°c booking hi·ªán t·∫°i
            const timers = document.querySelectorAll('.countdown-timer');
            timers.forEach(timer => {
                const bookingId = timer.getAttribute('data-booking-id');
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (bookingId && cancelTimeStr) {
                    bookingCancelTimes.set(bookingId, cancelTimeStr);
                }
            });
        });
        
        // T·∫Øt auto-refresh v√† cancel time check khi page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (cancelTimeCheckInterval) {
                clearInterval(cancelTimeCheckInterval);
            }
        });
        
        // Th√™m CSS animation (ch·ªâ th√™m m·ªôt l·∫ßn)
        if (!document.getElementById('refresh-animation-style')) {
            const style = document.createElement('style');
            style.id = 'refresh-animation-style';
            style.textContent = `
                @@keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
}


@model VHS_frontend.Areas.Provider.Models.Booking.BookingListResultDTO
@{
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    ViewData["Title"] = "Quản lí đặt dịch vụ";
}

<div class="order-management-container">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 order-page-header">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-receipt-cutoff me-2"></i>
                    Quản lý đặt dịch vụ
                </h4>
                <button class="btn btn-secondary btn-sm" onclick="location.reload()" title="Làm mới trang">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Làm mới
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card shadow-sm mb-4 filter-card">
        <div class="card-body">
            <form method="get" asp-action="Index" id="filterForm">
                <div class="row g-3 align-items-end">
                    <!-- Status Filter -->
                    <div class="col-md-2">
                        <label class="form-label">Trạng thái</label>
                        <select name="status" class="form-select form-select-filter" onchange="this.form.submit()">
                            <option value="" selected="@(string.IsNullOrEmpty(ViewBag.CurrentStatus))">Tất cả</option>
                            <option value="Pending" selected="@(ViewBag.CurrentStatus == "Pending")">Chờ xử lý</option>
                            <option value="Confirmed" selected="@(ViewBag.CurrentStatus == "Confirmed")">Đã xác nhận</option>
                            <option value="InProgress" selected="@(ViewBag.CurrentStatus == "InProgress")">Bắt đầu làm việc</option>
                            <option value="Completed" selected="@(ViewBag.CurrentStatus == "Completed")">Hoàn thành</option>
                            <option value="Canceled" selected="@(ViewBag.CurrentStatus == "Canceled")">Đã hủy</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-2">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                    </div>

                    <!-- Search -->
                    <div class="col-md-4">
                        <label class="form-label">Tìm kiếm</label>
                        <input type="text" name="searchTerm" class="form-control" 
                               placeholder="Tên khách hàng, dịch vụ..." value="@ViewBag.SearchTerm" />
                    </div>

                    <!-- Buttons -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Lọc
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="card shadow-sm mb-4">
        <div class="card-header order-stats-header">
            <h6 class="mb-0">
                <i class="bi bi-calendar-month me-2"></i> Thống kê đặt dịch vụ
            </h6>
        </div>
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="stat-card stat-pending">
                        <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthPending ?? 0)</h3>
                            <p>Chờ xử lý</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-confirmed">
                        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthConfirmed ?? 0)</h3>
                            <p>Đã xác nhận</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-completed">
                        <div class="stat-icon"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCompleted ?? 0)</h3>
                            <p>Hoàn thành</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card stat-canceled">
                        <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                        <div class="stat-info">
                            <h3>@(ViewBag.MonthCanceled ?? 0)</h3>
                            <p>Đã hủy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card shadow-sm">
        <div class="card-header order-table-header">
            <h6 class="mb-0">
                <i class="bi bi-list-ul me-2"></i>
                Danh sách đặt dịch vụ (@Model.TotalCount)
            </h6>
        </div>
        <div class="card-body p-0">
            @if (Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0 order-table">
                        <thead>
                            <tr>
                                <th style="width: 12%;">Mã đơn</th>
                                <th style="width: 11%;">Khách hàng</th>
                                <th style="width: 14%;">Dịch vụ</th>
                                <th style="width: 9%;">Thời gian</th>
                                <th style="width: 13%;">Địa chỉ</th>
                                <th style="width: 11%;">Số tiền</th>
                                <th style="width: 10%;">Trạng thái</th>
                                <th style="width: 11%;">Nhân viên</th>
                                <th style="width: 9%;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <strong class="booking-code">@booking.BookingCode</strong>
                                        <br />
                                        <small class="text-muted">@booking.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@booking.CustomerName</div>
                                    </td>
                                    <td>
                                        <div class="service-name">@booking.ServiceName</div>
                                    </td>
                                    <td>
                                        <div>@booking.BookingTime.ToString("dd/MM/yyyy")</div>
                                        <small class="text-muted">@booking.BookingTime.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.Address))
                                        {
                                            <div class="address-text" title="@booking.Address">
                                                <i class="bi bi-geo-alt me-1"></i>
                                                @(booking.Address.Length > 30 ? booking.Address.Substring(0, 30) + "..." : booking.Address)
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <strong class="text-primary">@booking.Amount.ToString("N0") VND</strong>
                                        @if (!string.IsNullOrEmpty(booking.PaymentStatus))
                                        {
                                            <br />
                                            <span class="badge payment-badge payment-@(booking.PaymentStatus.ToLower().Replace(" ", "-"))" style="color: #000000 !important; font-weight: 800 !important;">
                                                @GetPaymentStatusText(booking.PaymentStatus)
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge status-badge status-@(booking.Status.ToLower().Replace(" ", "-"))" style="color: #000000 !important; font-weight: 800 !important;">
                                            @GetStatusText(booking.Status)
                                        </span>
                                        @* Hiển thị countdown timer cho booking Pending *@
                                        @{
                                            var statusNorm = (booking.Status ?? string.Empty).Trim();
                                            // Kiểm tra nhiều cách viết của Pending
                                            var isPendingBooking = string.Equals(statusNorm, "Pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("pending", StringComparison.OrdinalIgnoreCase) ||
                                                                   statusNorm.Contains("chờ", StringComparison.OrdinalIgnoreCase);
                                        }
                                        @if (isPendingBooking)
                                        {
                                            var defaultCancelMinutes = (int)(ViewBag.DefaultCancelMinutes ?? 30);
                                            var cancelMinutes = booking.AutoCancelMinutes ?? defaultCancelMinutes; // Dùng giá trị từ system settings
                                            var createdAt = booking.CreatedAt;
                                            // Sử dụng CreatedAt từ booking, nếu không có thì dùng thời gian hiện tại
                                            DateTime validCreatedAt;
                                            if (createdAt != default(DateTime) && createdAt != DateTime.MinValue && createdAt.Year > 2000)
                                            {
                                                validCreatedAt = createdAt;
                                            }
                                            else
                                            {
                                                // Fallback: dùng thời gian hiện tại nếu CreatedAt không hợp lệ
                                                validCreatedAt = DateTime.Now;
                                            }
                                            var cancelTime = validCreatedAt.AddMinutes(cancelMinutes);
                                            var remainingMinutes = Math.Max(0, (int)Math.Ceiling((cancelTime - DateTime.Now).TotalMinutes));
                                            <br />
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <small class="text-danger" style="font-size: 0.75rem;">
                                                    <i class="bi bi-clock-history"></i>
                                                    <span class="countdown-timer" 
                                                          data-cancel-time="@cancelTime.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-booking-id="@booking.BookingId"
                                                          data-created-at="@validCreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")"
                                                          data-current-cancel-minutes="@cancelMinutes">
                                                        Đang tính...
                                                    </span>
                                                </small>
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(booking.StaffName))
                                        {
                                            <span class="staff-assigned">
                                                <i class="bi bi-person-check me-1"></i>
                                                <span>@booking.StaffName</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="staff-unassigned">
                                                <i class="bi bi-person-x me-1"></i>
                                                <span>Chưa phân công</span>
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@booking.BookingId" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <div class="card-footer">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                @if (Model.PageNumber > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index" 
                                           asp-route-pageNumber="@(Model.PageNumber - 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                }

                                @for (int i = 1; i <= Model.TotalPages; i++)
                                {
                                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                        <a class="page-link" asp-action="Index" 
                                           asp-route-pageNumber="@i"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (Model.PageNumber < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-action="Index" 
                                           asp-route-pageNumber="@(Model.PageNumber + 1)"
                                           asp-route-status="@ViewBag.CurrentStatus"
                                           asp-route-fromDate="@ViewBag.FromDate"
                                           asp-route-toDate="@ViewBag.ToDate"
                                           asp-route-searchTerm="@ViewBag.SearchTerm">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">Không có đặt dịch vụ nào</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/order-management.css" asp-append-version="true" />
    <style>
        /* Force status badge text color to black in light mode */
        .order-management-container .badge.status-badge.status-pending,
        .order-management-container .badge.status-badge.status-confirmed,
        .order-management-container .badge.status-badge.status-inprogress,
        .order-management-container .badge.status-badge.status-in-progress,
        .order-management-container .badge.status-badge.status-completed,
        .order-management-container .badge.status-badge.status-canceled,
        .order-table .badge.status-badge.status-pending,
        .order-table .badge.status-badge.status-confirmed,
        .order-table .badge.status-badge.status-inprogress,
        .order-table .badge.status-badge.status-in-progress,
        .order-table .badge.status-badge.status-completed,
        .order-table .badge.status-badge.status-canceled,
        .order-table tbody td .badge.status-badge {
            color: #000000 !important;
        }
        
        /* Force payment badge text color to black in light mode */
        .order-table .payment-badge.payment-paid,
        .order-table .payment-badge.payment-unpaid,
        .order-table .payment-badge.payment-pending,
        .order-table tbody td .payment-badge {
            color: #000000 !important;
        }
        
        /* Force status badge text color to white in dark mode */
        .dark .order-management-container .badge.status-badge.status-pending,
        .dark .order-management-container .badge.status-badge.status-confirmed,
        .dark .order-management-container .badge.status-badge.status-inprogress,
        .dark .order-management-container .badge.status-badge.status-in-progress,
        .dark .order-management-container .badge.status-badge.status-completed,
        .dark .order-management-container .badge.status-badge.status-canceled,
        .dark .order-table .badge.status-badge.status-pending,
        .dark .order-table .badge.status-badge.status-confirmed,
        .dark .order-table .badge.status-badge.status-inprogress,
        .dark .order-table .badge.status-badge.status-in-progress,
        .dark .order-table .badge.status-badge.status-completed,
        .dark .order-table .badge.status-badge.status-canceled,
        .dark .order-table tbody td .badge.status-badge {
            color: #ffffff !important;
        }
        
        /* Force payment badge text color to white in dark mode */
        .dark .order-table .payment-badge.payment-paid,
        .dark .order-table .payment-badge.payment-unpaid,
        .dark .order-table .payment-badge.payment-pending,
        .dark .order-table tbody td .payment-badge {
            color: #ffffff !important;
        }
        
        /* Allow status and payment badges to wrap text */
        .order-table tbody td {
            white-space: normal !important;
            word-wrap: break-word;
        }
        
        .order-table .badge.status-badge,
        .order-table .badge.payment-badge {
            white-space: normal !important;
            word-wrap: break-word;
            display: inline-block;
            max-width: 100%;
            line-height: 1.4;
            text-align: center;
        }
        
        /* Ensure table cells can wrap */
        .order-table td {
            vertical-align: middle;
        }
        
        /* Service Completed Status Badge - Màu xanh dương nhạt để phân biệt với Completed */
        .order-management-container .order-table tbody td .badge.status-badge.status-service-completed,
        .order-management-container .order-table tbody td .status-badge.status-service-completed,
        .order-management-container .order-table .badge.status-badge.status-service-completed,
        .order-management-container .order-table .status-badge.status-service-completed,
        .order-table tbody td .badge.status-badge.status-service-completed,
        .order-table tbody td .status-badge.status-service-completed,
        .order-table .badge.status-badge.status-service-completed,
        .order-table .status-badge.status-service-completed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #000000 !important;
            border: 1px solid #6366f1 !important;
            font-weight: 800 !important;
        }
        
        /* Dark mode for Service Completed */
        .dark .order-management-container .order-table tbody td .badge.status-badge.status-service-completed,
        .dark .order-management-container .order-table tbody td .status-badge.status-service-completed,
        .dark .order-management-container .order-table .badge.status-badge.status-service-completed,
        .dark .order-management-container .order-table .status-badge.status-service-completed,
        .dark .order-table tbody td .badge.status-badge.status-service-completed,
        .dark .order-table tbody td .status-badge.status-service-completed,
        .dark .order-table .badge.status-badge.status-service-completed,
        .dark .order-table .status-badge.status-service-completed {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(79, 70, 229, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(99, 102, 241, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
        }
        
        /* Payment Rejected Badge */
        .order-table .payment-badge.payment-rejected,
        .order-table tbody td .payment-badge.payment-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
            color: #000000 !important;
            border: 1px solid #ef4444 !important;
            font-weight: 800 !important;
        }
        
        .dark .order-table .payment-badge.payment-rejected,
        .dark .order-table tbody td .payment-badge.payment-rejected {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.25) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(239, 68, 68, 0.6) !important;
            font-weight: 800 !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
        }
    </style>
}

@functions {
    string GetStatusText(string status)
    {
        if (string.IsNullOrWhiteSpace(status))
            return "Chưa xác định";
            
        var statusLower = status.Trim().ToLower();
        return statusLower switch
        {
            "pending" => "Đang chờ xử lý",
            "confirmed" => "Đã xác nhận",
            "inprogress" or "in progress" or "in-progress" => "Bắt đầu làm việc",
            "completed" => "Hoàn thành",
            "service completed" or "service-completed" => "Xác nhận hoàn thành",
            "canceled" or "cancelled" => "Đã hủy",
            "processing" => "Đang xử lý",
            "rejected" => "Đã từ chối",
            "refunded" => "Đã hoàn tiền",
            _ => status // Giữ nguyên nếu không khớp, nhưng nên được xử lý ở backend
        };
    }

    string GetPaymentStatusText(string paymentStatus)
    {
        if (string.IsNullOrWhiteSpace(paymentStatus))
            return "Chưa xác định";
            
        var statusLower = paymentStatus.Trim().ToLower();
        return statusLower switch
        {
            "paid" => "Đã thanh toán",
            "unpaid" => "Chưa thanh toán",
            "pending" => "Chờ thanh toán",
            "refunded" => "Đã hoàn tiền",
            "waiting for payment" or "waiting-for-payment" => "Chờ thanh toán",
            "rejected" => "Đã từ chối",
            _ => paymentStatus // Giữ nguyên nếu không khớp
        };
    }
}

@section Scripts {
    <script>
        // Force apply badge text colors (status and payment)
        function applyBadgeColors() {
            const statusBadges = document.querySelectorAll('.order-table .badge.status-badge');
            const paymentBadges = document.querySelectorAll('.order-table .payment-badge');
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#ffffff' : '#000000';
            
            // Apply to status badges
            statusBadges.forEach(badge => {
                badge.style.setProperty('color', textColor, 'important');
                badge.style.setProperty('font-weight', '800', 'important');
            });
            
            // Apply to payment badges
            paymentBadges.forEach(badge => {
                badge.style.setProperty('color', textColor, 'important');
                badge.style.setProperty('font-weight', '800', 'important');
            });
        }
        
        // ========================================
        // AUTO-CANCEL MANAGER: Quản lý tập trung để tránh duplicate calls
        // ========================================
        const AutoCancelManager = {
            processed: new Set(), // Track bookings đã xử lý
            inProgress: new Set(), // Track bookings đang xử lý
            callQueue: new Map(), // Queue các calls đang chờ
            
            async call(bookingId, isPendingExpired) {
                const id = String(bookingId).trim();
                
                // Kiểm tra đã xử lý hoặc đang xử lý
                if (this.processed.has(id) || this.inProgress.has(id)) {
                    return Promise.resolve();
                }
                
                // Nếu đã có trong queue, return promise đó
                if (this.callQueue.has(id)) {
                    return this.callQueue.get(id);
                }
                
                // Tạo promise mới
                const promise = this._executeCall(id, isPendingExpired);
                this.callQueue.set(id, promise);
                this.inProgress.add(id);
                
                // Cleanup sau khi hoàn thành
                promise.finally(() => {
                    this.callQueue.delete(id);
                    this.inProgress.delete(id);
                    this.processed.add(id);
                });
                
                return promise;
            },
            
            async _executeCall(bookingId, isPendingExpired) {
                try {
                    const bookingIdStr = String(bookingId).trim();
                    if (!bookingIdStr || bookingIdStr === 'undefined' || bookingIdStr === 'null') {
                        throw new Error('Invalid bookingId');
                    }
                    
                    const response = await fetch('/Provider/Order/AutoCancel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify({
                            bookingId: bookingIdStr,
                            isPendingExpired: isPendingExpired
                        })
                    });
                    
                    // QUAN TRỌNG: Kiểm tra cả HTTP status VÀ response body
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        throw new Error(`Auto-cancel failed: ${response.status} - ${responseText}`);
                    }
                    
                    // Parse JSON response để kiểm tra success flag
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        // Nếu không phải JSON, coi như thành công nếu HTTP status OK
                        return Promise.resolve();
                    }
                    
                    // KIỂM TRA success flag trong response body
                    if (result && result.success === true) {
                        // API thành công và database đã được cập nhật
                        return Promise.resolve();
                    } else {
                        // API trả về nhưng success = false
                        throw new Error(result?.message || 'Auto-cancel failed: Backend reported failure');
                    }
                } catch (error) {
                    console.error(`[AUTO CANCEL] Error for booking ${bookingId}:`, error);
                    throw error;
                }
            },
            
            reset(bookingId) {
                const id = String(bookingId).trim();
                this.processed.delete(id);
                this.inProgress.delete(id);
                this.callQueue.delete(id);
            },
            
            resetAll() {
                this.processed.clear();
                this.inProgress.clear();
                this.callQueue.clear();
            }
        };
        
        // Countdown timer cho booking Pending
        function updateCountdown() {
            const timers = document.querySelectorAll('.countdown-timer');
            const expiredBookings = [];
            
            timers.forEach(timer => {
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (!cancelTimeStr) return;
                
                const bookingId = timer.getAttribute('data-booking-id');
                
                // Parse cancelTime - hỗ trợ nhiều format
                let cancelTime;
                try {
                    // Thử parse với format ISO 8601
                    if (cancelTimeStr.includes('T')) {
                        cancelTime = new Date(cancelTimeStr);
                    } else {
                        // Nếu không có T, thử parse với format khác
                        cancelTime = new Date(cancelTimeStr.replace(' ', 'T'));
                    }
                    
                    // Kiểm tra xem có phải invalid date không
                    if (isNaN(cancelTime.getTime())) {
                        timer.innerHTML = '<span class="text-danger">Lỗi thời gian</span>';
                        return;
                    }
                } catch (e) {
                    timer.innerHTML = '<span class="text-danger">Lỗi thời gian</span>';
                    return;
                }
                
                const now = new Date();
                const diff = cancelTime - now;
                
                // Nếu đã được xử lý, ẩn timer
                if (bookingId && AutoCancelManager.processed.has(String(bookingId).trim())) {
                    const countdownContainer = timer.closest('.d-flex');
                    if (countdownContainer) {
                        countdownContainer.style.display = 'none';
                    } else {
                        timer.style.display = 'none';
                    }
                    return;
                }
                
                if (diff <= 0) {
                    // Đã quá thời gian - đánh dấu để xử lý
                    if (bookingId && !AutoCancelManager.processed.has(String(bookingId).trim())) {
                        expiredBookings.push({ bookingId, timer });
                    }
                } else {
                    // Hiển thị countdown
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours} giờ ${minutes} phút`;
                    } else if (minutes > 0) {
                        timeStr = `${minutes} phút ${seconds} giây`;
                    } else {
                        timeStr = `${seconds} giây`;
                    }
                    
                    if (diff < 5 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-danger fw-bold">Còn ${timeStr}</span>`;
                    } else if (diff < 15 * 60 * 1000) {
                        timer.innerHTML = `<span class="text-warning fw-bold">Còn ${timeStr}</span>`;
                    } else {
                        timer.innerHTML = `Còn ${timeStr}`;
                    }
                }
            });
            
            // Xử lý expired bookings - GỌI API TRƯỚC, SAU ĐÓ MỚI CẬP NHẬT UI
            if (expiredBookings.length > 0) {
                // Gọi API cho tất cả expired bookings
                const cancelPromises = expiredBookings.map(({ bookingId }) => {
                    return AutoCancelManager.call(bookingId, true);
                });
                
                // Đợi tất cả API calls hoàn thành
                Promise.allSettled(cancelPromises).then(results => {
                    // Kiểm tra xem có API nào thành công không
                    const hasSuccess = results.some(r => r.status === 'fulfilled');
                    
                    if (hasSuccess) {
                        // CHỈ KHI API THÀNH CÔNG mới refresh để lấy dữ liệu từ database
                        refreshBookingListSilent();
                    } else {
                        // Nếu tất cả đều fail, reset state và log error
                        results.forEach((result, index) => {
                            if (result.status === 'rejected') {
                                const bookingId = expiredBookings[index].bookingId;
                                AutoCancelManager.reset(bookingId);
                                console.error(`[AUTO CANCEL] Failed for booking ${bookingId}:`, result.reason);
                            }
                        });
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            applyBadgeColors();
            
            // Watch for theme changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'class') {
                        applyBadgeColors();
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });
            
            // Cập nhật countdown timer ngay lập tức
            updateCountdown();
            
            // Cập nhật countdown mỗi giây
            setInterval(() => {
                updateCountdown();
            }, 1000);
        });

        // ========================================
        // AUTO-REFRESH: Tự động cập nhật danh sách booking KHÔNG RELOAD TRANG
        // ========================================
        let isRefreshing = false;
        let refreshInterval = null;
        
        // Function để fetch và cập nhật danh sách booking động (có notification)
        async function refreshBookingList(showNotification = true) {
            if (isRefreshing) return;
            
            // Kiểm tra nếu user đang tương tác với form hoặc modal
            const activeModal = document.querySelector('.modal.show');
            const activeForm = document.querySelector('form:has(input:focus), form:has(textarea:focus)');
            
            if (activeModal || activeForm) {
                return;
            }
            
            isRefreshing = true;
            
            try {
                // Lưu scroll position trước khi cập nhật
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Fetch lại trang với header để nhận HTML - thêm timestamp để tránh cache
                // Đảm bảo lấy dữ liệu mới nhất từ database
                const url = new URL(window.location.href);
                url.searchParams.set('_t', Date.now().toString()); // Cache busting
                url.searchParams.set('_refresh', '1'); // Thêm parameter để server biết đây là refresh request
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest', // Đánh dấu đây là AJAX request
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0',
                        'X-Refresh-Request': 'true' // Header để server biết đây là refresh request
                    },
                    cache: 'no-store' // Đảm bảo không cache - luôn lấy dữ liệu mới từ database
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch booking list');
                }
                
                const html = await response.text();
                
                // Parse HTML response và extract phần table body
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTableBody = doc.querySelector('.order-table tbody');
                const newCardFooter = doc.querySelector('.card-footer');
                
                if (newTableBody) {
                    // Lấy table body hiện tại
                    const currentTableBody = document.querySelector('.order-table tbody');
                    const currentCardFooter = document.querySelector('.card-footer');
                    
                    if (currentTableBody) {
                        // Fade out effect (chỉ khi có notification)
                        if (showNotification) {
                            currentTableBody.style.opacity = '0.5';
                            currentTableBody.style.transition = 'opacity 0.3s';
                        }
                        
                        // Replace nội dung sau 300ms (hoặc ngay lập tức nếu không có notification)
                        setTimeout(() => {
                            // Replace table body
                            currentTableBody.innerHTML = newTableBody.innerHTML;
                            
                            // Replace pagination nếu có
                            if (newCardFooter && currentCardFooter) {
                                currentCardFooter.innerHTML = newCardFooter.innerHTML;
                            } else if (newCardFooter && !currentCardFooter) {
                                // Thêm pagination mới nếu không có
                                const card = document.querySelector('.card.shadow-sm');
                                if (card) {
                                    card.insertAdjacentHTML('beforeend', newCardFooter.outerHTML);
                                }
                            } else if (!newCardFooter && currentCardFooter) {
                                // Xóa pagination nếu không còn
                                currentCardFooter.remove();
                            }
                            
                            // Fade in effect (chỉ khi có notification)
                            if (showNotification) {
                                currentTableBody.style.opacity = '1';
                            }
                            
                            // Re-initialize các event handlers cần thiết
                            initializeEventHandlers();
                            
                            // ✨ KHÔNG clear expiredBookingsProcessed ngay lập tức
                            // Chỉ clear các booking đã bị canceled hoặc không còn trong danh sách
                            // Giữ lại các booking đã expired để tránh xử lý lặp lại
                            const allTimersAfterRefresh = document.querySelectorAll('.countdown-timer');
                            const allBookingIdsAfterRefresh = new Set();
                            allTimersAfterRefresh.forEach(timer => {
                                const bid = timer.getAttribute('data-booking-id');
                                if (bid) {
                                    allBookingIdsAfterRefresh.add(bid);
                                }
                            });
                            
                            // Xóa các booking đã bị canceled hoặc không còn trong danh sách
                            // Cleanup tracking cho các booking đã bị removed hoặc không còn expired
                            AutoCancelManager.processed.forEach(bookingId => {
                                // Kiểm tra xem booking này còn trong danh sách không
                                if (!allBookingIdsAfterRefresh.has(bookingId)) {
                                    // Booking đã bị removed (canceled hoặc không còn pending)
                                    AutoCancelManager.reset(bookingId);
                                } else {
                                    // Kiểm tra xem booking này có còn expired không
                                    const timer = document.querySelector(`.countdown-timer[data-booking-id="${bookingId}"]`);
                                    if (timer) {
                                        const cancelTimeStr = timer.getAttribute('data-cancel-time');
                                        if (cancelTimeStr) {
                                            const cancelTime = new Date(cancelTimeStr);
                                            const now = new Date();
                                            const diff = cancelTime - now;
                                            // Nếu booking không còn expired (admin đã gia hạn), clear tracking
                                            if (diff > 0) {
                                                AutoCancelManager.reset(bookingId);
                                            }
                                        }
                                    }
                                }
                            });
                            
                            // Khôi phục scroll position
                            window.scrollTo(0, scrollTop);
                        }, showNotification ? 300 : 0); // Ngay lập tức nếu không có notification
                    } else {
                        throw new Error('Table body container not found');
                    }
                } else {
                    throw new Error('New table body not found in response');
                }
            } catch (error) {
                console.error('❌ Error refreshing booking list:', error);
            } finally {
                isRefreshing = false;
            }
        }
        
        // Function để sync với server im lặng (không hiển thị notification)
        async function refreshBookingListSilent() {
            return refreshBookingList(false); // Gọi với showNotification = false
        }
        
        // Function để hiển thị notification refresh
        function showRefreshNotification(message, type) {
            // Xóa notification cũ nếu có
            const existingNotif = document.querySelector('.refresh-notification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            // Tạo notification mới
            const notification = document.createElement('div');
            notification.className = 'refresh-notification';
            const bgColor = type === 'success' ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)';
            notification.style.cssText = `position: fixed; bottom: 20px; right: 20px; background: ${bgColor}; color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.875rem; z-index: 1050; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;`;
            notification.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            document.body.appendChild(notification);
            
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Function để re-initialize event handlers sau khi cập nhật DOM
        // Lưu trữ cancel time ban đầu của mỗi booking để so sánh khi refresh
        const bookingCancelTimes = new Map();
        // Lưu trữ status ban đầu của mỗi booking để phát hiện thay đổi từ admin
        const bookingStatuses = new Map();
        
        function initializeEventHandlers() {
            // Re-apply badge colors
            applyBadgeColors();
            
            // Lưu trữ booking status hiện tại để so sánh
            const currentBookings = new Map();
            document.querySelectorAll('.order-table tbody tr').forEach(row => {
                const bookingCodeElement = row.querySelector('.booking-code');
                const statusBadge = row.querySelector('.status-badge');
                const timer = row.querySelector('.countdown-timer');
                
                if (bookingCodeElement && statusBadge) {
                    // Lấy bookingId từ timer hoặc từ booking code
                    let bookingId = timer ? timer.getAttribute('data-booking-id') : null;
                    
                    // Nếu không có timer, thử lấy từ link hoặc data attribute khác
                    if (!bookingId) {
                        const detailLink = row.querySelector('a[href*="/Order/Details/"]');
                        if (detailLink) {
                            const href = detailLink.getAttribute('href');
                            const match = href.match(/\/Order\/Details\/([a-f0-9-]+)/i);
                            if (match) {
                                bookingId = match[1];
                            }
                        }
                    }
                    
                    // Lấy status từ class của badge (chính xác hơn textContent)
                    let status = statusBadge.textContent.trim();
                    const statusClass = Array.from(statusBadge.classList).find(cls => cls.startsWith('status-'));
                    if (statusClass) {
                        // Chuyển đổi class thành status text (ví dụ: status-pending -> Pending)
                        const statusFromClass = statusClass.replace('status-', '').replace(/-/g, ' ');
                        // Giữ nguyên textContent nhưng có thể dùng statusFromClass để so sánh
                        status = statusFromClass;
                    }
                    
                    if (bookingId) {
                        currentBookings.set(bookingId, {
                            status: status,
                            statusText: statusBadge.textContent.trim(),
                            hasTimer: !!timer
                        });
                    }
                }
            });
            
            // So sánh với status cũ để phát hiện thay đổi từ admin
            let hasStatusChange = false;
            currentBookings.forEach((currentData, bookingId) => {
                const oldStatus = bookingStatuses.get(bookingId);
                const currentStatus = currentData.status.toLowerCase();
                const currentStatusText = currentData.statusText;
                
                if (oldStatus && oldStatus.toLowerCase() !== currentStatus) {
                    // Status đã thay đổi từ admin
                    hasStatusChange = true;
                    
                    // Nếu booking bị canceled, hiển thị thông báo
                    if (currentStatus.includes('canceled') || currentStatus.includes('cancelled') || 
                        currentStatusText.includes('hủy') || currentStatusText.includes('Hủy')) {
                        showRefreshNotification(
                            `Đơn hàng ${bookingId.toString().substring(0, 8).toUpperCase()} đã bị hủy`,
                            'success'
                        );
                    } else if (oldStatus.toLowerCase().includes('pending') && 
                               (currentStatus.includes('confirmed') || currentStatusText.includes('xác nhận'))) {
                        // Nếu booking được xác nhận
                        showRefreshNotification(
                            `Đơn hàng ${bookingId.toString().substring(0, 8).toUpperCase()} đã được xác nhận`,
                            'success'
                        );
                    }
                    
                    // Cập nhật stored status
                    bookingStatuses.set(bookingId, currentStatus);
                } else if (!oldStatus) {
                    // Lần đầu tiên thấy booking này
                    bookingStatuses.set(bookingId, currentStatus);
                } else {
                    // Đảm bảo stored status được cập nhật
                    bookingStatuses.set(bookingId, currentStatus);
                }
            });
            
            // Xóa các booking không còn trong danh sách (có thể đã bị xóa hoặc chuyển trang)
            bookingStatuses.forEach((status, bookingId) => {
                if (!currentBookings.has(bookingId)) {
                    bookingStatuses.delete(bookingId);
                    bookingCancelTimes.delete(bookingId);
                }
            });
            
            // Kiểm tra và cập nhật cancel times - phát hiện thay đổi từ admin
            const timers = document.querySelectorAll('.countdown-timer');
            let hasAdminChange = false;
            
            timers.forEach(timer => {
                const bookingId = timer.getAttribute('data-booking-id');
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                const cancelMinutes = timer.getAttribute('data-current-cancel-minutes');
                const createdAt = timer.getAttribute('data-created-at');
                
                if (bookingId && cancelTimeStr) {
                    const oldCancelTime = bookingCancelTimes.get(bookingId);
                    if (oldCancelTime && oldCancelTime !== cancelTimeStr) {
                        // Cancel time đã thay đổi (admin đã cập nhật)
                        hasAdminChange = true;
                        const oldTime = new Date(oldCancelTime);
                        const newTime = new Date(cancelTimeStr);
                        const diffMinutes = Math.round((newTime - oldTime) / 60000);
                        
                        // Cập nhật stored value
                        bookingCancelTimes.set(bookingId, cancelTimeStr);
                        
                        // Hiển thị thông báo nhẹ nhàng cho user (nếu có thay đổi đáng kể)
                        if (Math.abs(diffMinutes) >= 1) {
                            showRefreshNotification(
                                `Admin đã cập nhật thời gian hủy cho đơn ${bookingId.toString().substring(0, 8).toUpperCase()}`,
                                'success'
                            );
                        }
                    } else if (!oldCancelTime) {
                        // Lần đầu tiên thấy booking này
                        bookingCancelTimes.set(bookingId, cancelTimeStr);
                    } else {
                        // Đảm bảo stored value được cập nhật
                        bookingCancelTimes.set(bookingId, cancelTimeStr);
                    }
                }
            });
            
            // Admin changes detected and handled
            
            // Re-initialize countdown timers
            updateCountdown();
            
            // Re-initialize pagination links (Bootstrap sẽ tự động hoạt động)
            // Re-initialize modal triggers (Bootstrap sẽ tự động hoạt động với data attributes)
        }
        
        // Auto-refresh định kỳ: mỗi 2 giây để cập nhật nhanh hơn khi admin thay đổi
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                refreshBookingList(false); // Silent refresh để không làm phiền user
            }, 2000); // 2 giây - cập nhật rất nhanh để đồng bộ với thay đổi từ admin
        }
        
        // Kiểm tra định kỳ xem có booking nào có cancel time thay đổi không (mỗi 2 giây)
        // Và so sánh với dữ liệu từ server để phát hiện thay đổi từ admin
        let cancelTimeCheckInterval = null;
        function startCancelTimeCheck() {
            if (cancelTimeCheckInterval) {
                clearInterval(cancelTimeCheckInterval);
            }
            
            cancelTimeCheckInterval = setInterval(() => {
                // Kiểm tra tất cả countdown timers hiện tại
                const timers = document.querySelectorAll('.countdown-timer');
                let needsRefresh = false;
                
                timers.forEach(timer => {
                    const bookingId = timer.getAttribute('data-booking-id');
                    const currentCancelTime = timer.getAttribute('data-cancel-time');
                    const currentMinutes = timer.getAttribute('data-current-cancel-minutes');
                    
                    if (bookingId && currentCancelTime) {
                        const storedCancelTime = bookingCancelTimes.get(bookingId);
                        if (storedCancelTime && storedCancelTime !== currentCancelTime) {
                            // Cancel time đã thay đổi trong DOM - có thể do admin cập nhật
                            needsRefresh = true;
                        }
                    }
                });
                
                // Nếu có thay đổi, refresh để lấy dữ liệu mới nhất từ server
                if (needsRefresh) {
                    refreshBookingListSilent();
                }
            }, 2000); // Kiểm tra mỗi 2 giây để phát hiện nhanh hơn
        }
        
        // Khởi động auto-refresh và cancel time check khi page load
        document.addEventListener('DOMContentLoaded', function() {
            // Bắt đầu auto-refresh
            startAutoRefresh();
            
            // Bắt đầu kiểm tra cancel time changes
            startCancelTimeCheck();
            
            // Khởi tạo bookingCancelTimes và bookingStatuses map với các booking hiện tại
            const timers = document.querySelectorAll('.countdown-timer');
            timers.forEach(timer => {
                const bookingId = timer.getAttribute('data-booking-id');
                const cancelTimeStr = timer.getAttribute('data-cancel-time');
                if (bookingId && cancelTimeStr) {
                    bookingCancelTimes.set(bookingId, cancelTimeStr);
                }
            });
            
            // Khởi tạo bookingStatuses
            document.querySelectorAll('.order-table tbody tr').forEach(row => {
                const timer = row.querySelector('.countdown-timer');
                const statusBadge = row.querySelector('.status-badge');
                
                if (statusBadge) {
                    let bookingId = timer ? timer.getAttribute('data-booking-id') : null;
                    
                    // Nếu không có timer, thử lấy từ link
                    if (!bookingId) {
                        const detailLink = row.querySelector('a[href*="/Order/Details/"]');
                        if (detailLink) {
                            const href = detailLink.getAttribute('href');
                            const match = href.match(/\/Order\/Details\/([a-f0-9-]+)/i);
                            if (match) {
                                bookingId = match[1];
                            }
                        }
                    }
                    
                    if (bookingId) {
                        // Lấy status từ class
                        const statusClass = Array.from(statusBadge.classList).find(cls => cls.startsWith('status-'));
                        const status = statusClass ? statusClass.replace('status-', '').replace(/-/g, ' ').toLowerCase() : 
                                      statusBadge.textContent.trim().toLowerCase();
                        bookingStatuses.set(bookingId, status);
                    }
                }
            });
        });
        
        // Tắt auto-refresh và cancel time check khi page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (cancelTimeCheckInterval) {
                clearInterval(cancelTimeCheckInterval);
            }
        });
        
        // Thêm CSS animation (chỉ thêm một lần)
        if (!document.getElementById('refresh-animation-style')) {
            const style = document.createElement('style');
            style.id = 'refresh-animation-style';
            style.textContent = `
                @@keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
}


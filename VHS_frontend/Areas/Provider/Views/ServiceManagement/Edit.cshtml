@model VHS_frontend.Areas.Provider.Models.Service.ServiceProviderUpdateDTO
@{
    ViewData["Title"] = "Chỉnh sửa Dịch vụ";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    var serviceId = ViewBag.ServiceId as string;
    var currentImageUrl = ViewBag.CurrentImageUrl as string;
    var categoryName = ViewBag.CategoryName as string;
    var tags = ViewBag.Tags as List<VHS_frontend.Areas.Provider.Models.Service.TagDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.TagDTO>();
    var options = ViewBag.Options as List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/service-management.css" asp-append-version="true" />
}

<div class="service-management-container">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 create-page-header">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-pencil me-2"></i>
                    Chỉnh sửa Dịch vụ
                </h4>
                <a asp-action="Index" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Form Card -->
    <div class="card shadow-sm form-card">
        <div class="card-header form-card-header">
            <h6 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>
                Thông tin Dịch vụ
            </h6>
        </div>
        <div class="card-body">
            <form asp-action="Edit" asp-route-id="@serviceId" method="post" enctype="multipart/form-data" id="editServiceForm">
                @Html.AntiForgeryToken()

                <script>
                    // Validation functions - must be defined before form fields
                    function validateBaseUnit(field) {
                        const value = parseFloat(field.value);
                        if (!field.value || field.value === '' || field.value === null || field.value === undefined) {
                            field.setCustomValidity('Vui lòng nhập số lượng tối thiểu.');
                        } else if (isNaN(value) || value < 1) {
                            field.setCustomValidity('Số lượng tối thiểu phải từ 1 trở lên.');
                        } else {
                            field.setCustomValidity('');
                        }
                    }
                </script>

                <div class="row g-3">
                    <!-- Category (Read-only) -->
                    <div class="col-md-6">
                        <label class="form-label">Danh mục</label>
                        <input type="text" class="form-control" value="@categoryName" readonly />
                        <small class="form-text text-muted small">Danh mục không thể thay đổi sau khi tạo.</small>
                    </div>

                    <!-- Title -->
                    <div class="col-md-6">
                        <label asp-for="Title" class="form-label">Tên dịch vụ <span class="text-danger">*</span></label>
                        <input asp-for="Title" class="form-control" placeholder="VD: Dọn dẹp nhà ở" required />
                        <span asp-validation-for="Title" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Description -->
                <div class="mt-3">
                    <label asp-for="Description" class="form-label">Mô tả <span class="text-danger">*</span></label>
                    <textarea asp-for="Description" name="Description" id="Description" class="form-control" rows="3" placeholder="Mô tả chi tiết về dịch vụ..." 
                              data-val="true" 
                              data-val-required="Vui lòng nhập mô tả dịch vụ."
                              required
                              oninvalid="this.setCustomValidity('Vui lòng nhập mô tả dịch vụ.')"
                              oninput="this.setCustomValidity('')"></textarea>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <div class="row g-3 mt-0">
                    <!-- Price -->
                    <div class="col-md-4">
                        <label asp-for="Price" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                        <input asp-for="Price" asp-format="{0:0}" type="number" class="form-control" min="0" step="1000" placeholder="0" required />
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div>

                    <!-- Unit Type -->
                    <div class="col-md-4">
                        <label asp-for="UnitType" class="form-label">
                            <i class="bi bi-rulers me-1"></i>Đơn vị <span class="text-danger">*</span>
                        </label>
                        <select asp-for="UnitType" class="form-select" id="unitTypeSelect" required>
                            <option value="">-- Chọn đơn vị --</option>
                            <option value="Hour">Giờ</option>
                            <option value="Day">Ngày</option>
                            <option value="Visit">Lần</option>
                            <option value="Apartment">Căn</option>
                            <option value="Room">Phòng</option>
                            <option value="SquareMeter">Mét vuông (m²)</option>
                            <option value="Person">Người</option>
                            <option value="Package">Gói</option>
                            <option value="Event">Sự kiện</option>
                        </select>
                        <span asp-validation-for="UnitType" class="text-danger small"></span>
                    </div>

                    <!-- Base Unit -->
                    <div class="col-md-4">
                        <label asp-for="BaseUnit" class="form-label">
                            <i class="bi bi-123 me-1"></i>Số lượng tối thiểu <span class="text-danger">*</span>
                        </label>
                        <input asp-for="BaseUnit" name="BaseUnit" id="BaseUnit" type="number" class="form-control" min="1" step="1" placeholder="1" 
                               data-val="true" 
                               data-val-required="Vui lòng nhập số lượng tối thiểu."
                               data-val-min="Số lượng tối thiểu phải từ 1 trở lên."
                               data-val-min-min="1"
                               required
                               oninvalid="validateBaseUnit(this)"
                               oninput="this.setCustomValidity('')" />
                        <span asp-validation-for="BaseUnit" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Status -->
                <div class="mt-3">
                    <label asp-for="Status" class="form-label">Trạng thái</label>
                    <select asp-for="Status" class="form-select">
                        <option value="Active">Hoạt động</option>
                        <option value="Inactive">Tạm dừng</option>
                    </select>
                    <span asp-validation-for="Status" class="text-danger small"></span>
                </div>

                <!-- Images (Gộp avatar + ảnh mô tả) -->
                <div class="mt-3">
                    <label class="form-label">Hình ảnh dịch vụ</label>
                    @{
                        var imagesCsv = currentImageUrl ?? string.Empty;
                        var imgs = imagesCsv.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
                        var avatar = imgs.FirstOrDefault();
                        var descImgs = imgs.Skip(1).ToList();
                        string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
                    }

                    <!-- Hình ảnh hiện tại (gộp avatar + mô tả) -->
                    <div class="mb-2">
                        <div class="image-inline-gallery" id="imageGalleryContainer">
                            @if (!string.IsNullOrEmpty(avatar))
                            {
                                var avatarUrl = ToUrl(avatar);
                                <div class="removable-image" data-path="@avatar">
                                    <img src="@avatarUrl" alt="Avatar"
                                         onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'alert alert-warning\'>Không thể tải ảnh</div>';" />
                                    <button type="button" class="btn btn-sm btn-danger remove-image-btn" title="Xoá ảnh" aria-label="Xoá ảnh">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            }
                            @if (descImgs.Any())
                            {
                                foreach (var p in descImgs)
                                {
                                    var u = ToUrl(p);
                                    <div class="removable-image" data-path="@p">
                                        <img src="@u" alt="Desc"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'alert alert-warning p-2\'>Lỗi ảnh</div>';" />
                                        <button type="button" class="btn btn-sm btn-danger remove-image-btn" title="Xoá ảnh" aria-label="Xoá ảnh">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                        <!-- Hidden inputs for removed images -->
                        <div id="removedImagesContainer"></div>
                        <!-- Hidden input to store current images (for keeping old images when no new images are uploaded) -->
                        <input type="hidden" id="currentImagesData" value="@currentImageUrl" />
                        <div class="file-input-wrapper">
                            <input name="Images" type="file" id="imageInputEdit" class="form-control mt-3" accept="image/*" multiple />
                        </div>
                        <span asp-validation-for="Images" class="text-danger small"></span>
                        <small class="form-text text-muted small">Chọn 1 hoặc nhiều ảnh mới. Ảnh mới sẽ được thêm vào cuối; ảnh đại diện hiện tại không thay đổi trừ khi bạn chọn Avatar riêng.</small>
                    </div>
                </div>

                <!-- Tags Section -->
                <div class="mt-3">
                    <label class="form-label fw-bold section-label">
                        <i class="bi bi-tags me-2"></i>
                        Tags (Từ khóa)
                    </label>
                    <div id="tagsContainer" class="tags-options-container">
                        @if (tags.Any())
                        {
                            <div class="row tags-options-row">
                                @foreach (var tag in tags)
                                {
                                    var isChecked = Model.TagIds.Contains(tag.TagId);
                                    <div class="col-12 col-sm-6 col-md-6">
                                        <div class="tag-option-item">
                                            <input class="form-check-input" type="checkbox" name="TagIds" value="@tag.TagId" id="tag_@tag.TagId" @(isChecked ? "checked" : "") />
                                            <label class="form-check-label" for="tag_@tag.TagId">
                                                @tag.Name
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0 small">
                                <i class="bi bi-info-circle me-1"></i>
                                Không có tags nào cho danh mục này.
                            </p>
                        }
                    </div>
                </div>

                <!-- Options Section -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold section-label mb-0">
                            <i class="bi bi-list-check me-2"></i>
                            Options (Lựa chọn bổ sung)
                        </label>
                        <button type="button" class="btn btn-success btn-sm btn-create-option" data-bs-toggle="modal" data-bs-target="#createOptionModalEdit">
                            <i class="bi bi-plus-circle me-1"></i>
                            Tạo Option
                        </button>
                    </div>
                    <div id="optionsContainer" class="tags-options-container">
                        @if (options.Any())
                        {
                            <div class="row tags-options-row">
                                @foreach (var option in options)
                                {
                                    var isChecked = Model.OptionIds.Contains(option.OptionId);
                                    <div class="col-12 col-sm-6 col-md-6">
                                        <div class="tag-option-item">
                                            <input class="form-check-input" type="checkbox" name="OptionIds" value="@option.OptionId" id="option_@option.OptionId" @(isChecked ? "checked" : "") />
                                            <label class="form-check-label" for="option_@option.OptionId">
                                                @option.OptionName
                                                @{
                                                    var unitTypeVietnamese = "";
                                                    switch (option.UnitType)
                                                    {
                                                        case "Hour": unitTypeVietnamese = "Giờ"; break;
                                                        case "Day": unitTypeVietnamese = "Ngày"; break;
                                                        case "Visit": unitTypeVietnamese = "Lần"; break;
                                                        case "Apartment": unitTypeVietnamese = "Căn"; break;
                                                        case "Room": unitTypeVietnamese = "Phòng"; break;
                                                        case "SquareMeter": unitTypeVietnamese = "Mét vuông (m²)"; break;
                                                        case "Person": unitTypeVietnamese = "Người"; break;
                                                        case "Package": unitTypeVietnamese = "Gói"; break;
                                                        case "Event": unitTypeVietnamese = "Sự kiện"; break;
                                                    }
                                                }
                                                @if (!string.IsNullOrEmpty(option.Description) || option.Price > 0)
                                                {
                                                    <small>
                                                        @(!string.IsNullOrEmpty(option.Description) ? option.Description : "")
                                                        @(option.Price > 0 ? (!string.IsNullOrEmpty(option.Description) ? " - " : "") + option.Price.ToString("N0") + " VNĐ/" + unitTypeVietnamese : "")
                                                    </small>
                                                }
                                            </label>
                                            <button type="button" class="remove-option-btn" data-option-id="@option.OptionId" data-option-name="@option.OptionName" title="Xóa option khỏi danh sách">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0 small">
                                <i class="bi bi-info-circle me-1"></i>
                                Chưa có option nào.
                            </p>
                        }
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-2 mt-4 pt-3 border-top">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        Hủy
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script>
        // Override jQuery Validation messages to Vietnamese IMMEDIATELY after jQuery Validation loads
        // This MUST happen before unobtrusive validation is loaded
        if (typeof jQuery !== 'undefined' && jQuery.validator) {
            jQuery.extend(jQuery.validator.messages, {
                required: "Trường này là bắt buộc.",
                remote: "Vui lòng sửa trường này.",
                email: "Vui lòng nhập địa chỉ email hợp lệ.",
                url: "Vui lòng nhập URL hợp lệ.",
                date: "Vui lòng nhập ngày hợp lệ.",
                dateISO: "Vui lòng nhập ngày hợp lệ (ISO).",
                number: "Vui lòng nhập số hợp lệ.",
                digits: "Vui lòng chỉ nhập chữ số.",
                equalTo: "Vui lòng nhập cùng một giá trị.",
                maxlength: jQuery.validator.format("Vui lòng nhập không quá {0} ký tự."),
                minlength: jQuery.validator.format("Vui lòng nhập ít nhất {0} ký tự."),
                rangelength: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1} ký tự."),
                range: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1}."),
                max: jQuery.validator.format("Vui lòng nhập giá trị nhỏ hơn hoặc bằng {0}."),
                min: jQuery.validator.format("Vui lòng nhập giá trị lớn hơn hoặc bằng {0}."),
                step: jQuery.validator.format("Vui lòng nhập bội số của {0}.")
            });
        }
    </script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        // Image Preview Function
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Xoá ảnh hiện tại và thêm input ẩn RemoveImages để submit
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.remove-image-btn');
            if (!btn) return;
            const wrap = btn.closest('.removable-image');
            if (!wrap) return;
            
            // Only process existing images (have data-path), not preview images (have data-preview-index)
            const path = wrap.getAttribute('data-path');
            if (!path) return; // Skip if this is a preview image
            
            const container = document.getElementById('removedImagesContainer');
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'RemoveImages';
            hidden.value = path;
            container.appendChild(hidden);
            wrap.remove();
        });

        // Image preview functionality for Edit form
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('imageInputEdit');
            const galleryContainer = document.getElementById('imageGalleryContainer');
            let selectedFiles = [];

            if (imageInput && galleryContainer) {
                function addPreviewToGallery() {
                    selectedFiles.forEach((file, index) => {
                        if (!file.type.startsWith('image/')) {
                            return;
                        }

                        // Check if preview already exists
                        const existingPreview = galleryContainer.querySelector(`[data-preview-index="${index}"]`);
                        if (existingPreview) {
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageWrapper = document.createElement('div');
                            imageWrapper.className = 'removable-image';
                            imageWrapper.dataset.previewIndex = index;
                            imageWrapper.innerHTML = `
                                <img src="${e.target.result}" alt="Preview ${index + 1}" />
                                <button type="button" class="btn btn-sm btn-danger remove-image-btn remove-preview-btn" data-index="${index}" title="Xóa ảnh" aria-label="Xóa ảnh">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            `;
                            galleryContainer.appendChild(imageWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                imageInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    // Merge với files hiện có (nếu có)
                    selectedFiles = [...selectedFiles, ...newFiles];
                    addPreviewToGallery();
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                });

                // Remove preview image (only for new preview images, not existing ones)
                galleryContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-preview-btn');
                    if (!removeBtn) return;
                    
                    // Make sure this is a preview image, not an existing image
                    const wrapper = removeBtn.closest('[data-preview-index]');
                    if (!wrapper) return; // Existing images have data-path, not data-preview-index

                    const index = parseInt(removeBtn.dataset.index);
                    
                    wrapper.remove();
                    
                    // Remove file from array
                    selectedFiles.splice(index, 1);
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                    
                    // Re-render all previews with correct indices
                    galleryContainer.querySelectorAll('[data-preview-index]').forEach(el => el.remove());
                    addPreviewToGallery();
                });
            }
        });

        // Helper functions for validation messages in modal
        function showFieldErrorEdit(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);
            if (field && errorDiv) {
                field.classList.add('is-invalid');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideFieldErrorEdit(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);
            if (field && errorDiv) {
                field.classList.remove('is-invalid');
                errorDiv.style.display = 'none';
            }
        }

        function clearAllModalErrorsEdit() {
            hideFieldErrorEdit('optionNameEdit', 'optionNameEditError');
            hideFieldErrorEdit('optionPriceEdit', 'optionPriceEditError');
            hideFieldErrorEdit('optionUnitTypeEdit', 'optionUnitTypeEditError');
        }

        // Function to convert UnitType from English to Vietnamese
        function getUnitTypeVietnamese(unitType) {
            const unitMap = {
                'Hour': 'Giờ',
                'Day': 'Ngày',
                'Visit': 'Lần',
                'Apartment': 'Căn',
                'Room': 'Phòng',
                'SquareMeter': 'Mét vuông (m²)',
                'Person': 'Người',
                'Package': 'Gói',
                'Event': 'Sự kiện'
            };
            return unitMap[unitType] || unitType;
        }

        // Notification function - hiển thị ở giữa màn hình
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const iconClass = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
            
            // Xóa thông báo cũ nếu có
            const existingNotification = document.querySelector('.center-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} center-notification notification-show`;
            notification.innerHTML = `
                <i class="bi ${iconClass} me-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            // Tự động ẩn sau 2 giây
            setTimeout(() => {
                notification.classList.add('notification-hide');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 2000);
        }

        // Clear errors on input - Setup event listeners và Create Option handler
        document.addEventListener('DOMContentLoaded', function() {
            // Setup input event listeners
            const optionName = document.getElementById('optionNameEdit');
            const optionPrice = document.getElementById('optionPriceEdit');
            const optionUnitType = document.getElementById('optionUnitTypeEdit');

            if (optionName) {
                optionName.addEventListener('input', function() {
                    hideFieldErrorEdit('optionNameEdit', 'optionNameEditError');
                });
            }

            if (optionPrice) {
                optionPrice.addEventListener('input', function() {
                    hideFieldErrorEdit('optionPriceEdit', 'optionPriceEditError');
                });
            }

            if (optionUnitType) {
                optionUnitType.addEventListener('change', function() {
                    hideFieldErrorEdit('optionUnitTypeEdit', 'optionUnitTypeEditError');
                });
            }

        });

        // Create Option (Edit) handler - Sử dụng event delegation để đảm bảo hoạt động
        // Attach event listener trên document để catch submit từ form trong modal
        document.addEventListener('submit', async function (e) {
            const form = e.target;
            if (form && form.id === 'createOptionFormEdit') {
                e.preventDefault();
                e.stopPropagation();
                
                // Clear previous errors
                clearAllModalErrorsEdit();

                const optionData = {
                    OptionName: document.getElementById('optionNameEdit').value.trim(),
                    Description: document.getElementById('optionDescriptionEdit').value.trim(),
                    Price: parseFloat(document.getElementById('optionPriceEdit').value) || 0,
                    UnitType: document.getElementById('optionUnitTypeEdit').value
                };

                let hasError = false;

                // Validate Option Name
                if (!optionData.OptionName) {
                    showFieldErrorEdit('optionNameEdit', 'optionNameEditError', 'Vui lòng nhập tên option!');
                    hasError = true;
                } else if (optionData.OptionName.length > 50) {
                    showFieldErrorEdit('optionNameEdit', 'optionNameEditError', 'Tên option không được vượt quá 50 ký tự!');
                    hasError = true;
                }

                // Validate Price
                const priceInput = document.getElementById('optionPriceEdit');
                if (!priceInput.value || priceInput.value.trim() === '') {
                    showFieldErrorEdit('optionPriceEdit', 'optionPriceEditError', 'Vui lòng nhập giá!');
                    hasError = true;
                } else if (optionData.Price < 0 || isNaN(optionData.Price)) {
                    showFieldErrorEdit('optionPriceEdit', 'optionPriceEditError', 'Giá phải lớn hơn hoặc bằng 0!');
                    hasError = true;
                }

                // Validate Unit Type
                if (!optionData.UnitType) {
                    showFieldErrorEdit('optionUnitTypeEdit', 'optionUnitTypeEditError', 'Vui lòng chọn đơn vị!');
                    hasError = true;
                }

                if (hasError) {
                    return;
                }

                try {
                    const resp = await fetch('/Provider/ServiceManagement/CreateOption', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(optionData)
                    });
                    const result = await resp.json();
                    
                    if (result && result.success) {
                        const modalElement = document.getElementById('createOptionModalEdit');
                        const modal = bootstrap.Modal.getInstance(modalElement) ?? new bootstrap.Modal(modalElement);
                        modal.hide();
                        form.reset();
                        clearAllModalErrorsEdit();
                        
                        // Thêm option vừa tạo vào danh sách và auto-tick
                        const opt = result.data;
                        const container = document.getElementById('optionsContainer');
                        
                        if (!container) {
                            console.error('optionsContainer not found!');
                            showNotification('Có lỗi xảy ra khi thêm option vào danh sách!', 'error');
                            return;
                        }
                        
                        // Kiểm tra xem option này đã tồn tại chưa (tránh duplicate)
                        const existingCheckbox = container.querySelector(`input[type="checkbox"][value="${opt.optionId}"][name="OptionIds"]`);
                        if (existingCheckbox) {
                            showNotification('Option này đã được thêm vào danh sách!', 'success');
                            return;
                        }
                        
                        // Tìm row hiện có hoặc tạo mới
                        let row = container.querySelector('.tags-options-row');
                        
                        // Nếu không có row, tạo mới
                        if (!row) {
                            // Kiểm tra xem có text-muted (empty message) không
                            const textMuted = container.querySelector('.text-muted');
                            if (textMuted) {
                                // Xóa text-muted và tạo row mới
                                container.innerHTML = '';
                            }
                            // Tạo row mới
                            row = document.createElement('div');
                            row.className = 'row tags-options-row';
                            container.appendChild(row);
                        }

                        // Tạo col mới cho option
                        const col = document.createElement('div');
                        col.className = 'col-12 col-sm-6 col-md-6';
                        const descriptionText = opt.description ? opt.description + (opt.price !== undefined ? ' - ' : '') : '';
                        const unitTypeVietnamese = opt.unitType ? getUnitTypeVietnamese(opt.unitType) : '';
                        const priceText = opt.price !== undefined ? parseInt(opt.price).toLocaleString() + ' VNĐ/' + unitTypeVietnamese : '';
                        col.innerHTML = `
                            <div class="tag-option-item">
                                <input class="form-check-input" type="checkbox" name="OptionIds" value="${opt.optionId}" id="option_${opt.optionId}" checked />
                                <label class="form-check-label" for="option_${opt.optionId}">
                                    ${opt.optionName}
                                    ${descriptionText || priceText ? `<small>${descriptionText}${priceText}</small>` : ''}
                                </label>
                                <button type="button" class="remove-option-btn" data-option-id="${opt.optionId}" data-option-name="${opt.optionName}" title="Xóa option khỏi danh sách">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>`;
                        row.appendChild(col);
                        
                        // Thêm event handler cho nút xóa
                        const removeBtn = col.querySelector('.remove-option-btn');
                        removeBtn.addEventListener('click', function() {
                            removeOptionFromList(opt.optionId, opt.optionName);
                        });
                        
                        showNotification('Tạo option thành công!', 'success');
                    } else {
                        showNotification(result?.message || 'Có lỗi xảy ra khi tạo option!', 'error');
                    }
                } catch (err) {
                    console.error('Error creating option:', err);
                    showNotification('Có lỗi xảy ra khi tạo option!', 'error');
                }
            }
        });

        // Reset form và clear errors when modal is closed
        document.addEventListener('DOMContentLoaded', function() {
            const createOptionModalEdit = document.getElementById('createOptionModalEdit');
            if (createOptionModalEdit) {
                createOptionModalEdit.addEventListener('hidden.bs.modal', function() {
                    const form = document.getElementById('createOptionFormEdit');
                    if (form) {
                        form.reset();
                        clearAllModalErrorsEdit();
                    }
                });
            }
        });

        // Remove option from list (chỉ xóa khỏi UI, không xóa khỏi database)
        function removeOptionFromList(optionId, optionName) {
            if (!confirm(`Bạn có muốn xóa option "${optionName}" khỏi danh sách không?`)) {
                return;
            }
            
            // Tìm và xóa option khỏi UI
            const checkbox = document.querySelector(`input[type="checkbox"][value="${optionId}"][name="OptionIds"]`);
            if (checkbox) {
                const tagOptionItem = checkbox.closest('.tag-option-item');
                if (tagOptionItem) {
                    const col = tagOptionItem.closest('[class*="col-"]');
                    if (col) {
                        col.remove();
                        // Nếu row trống, xóa row
                        const row = col.closest('.tags-options-row');
                        if (row && row.querySelectorAll('[class*="col-"]').length === 0) {
                            row.remove();
                        }
                        // Nếu container trống, hiển thị message
                        const container = document.getElementById('optionsContainer');
                        if (container && container.querySelectorAll('.tags-options-row').length === 0) {
                            container.innerHTML = '<p class="text-muted mb-0 small"><i class="bi bi-info-circle me-1"></i>Chưa có option nào.</p>';
                        }
                        showNotification(`Đã xóa option "${optionName}" khỏi danh sách!`, 'success');
                    }
                }
            }
        }

        // Thêm event handler cho tất cả các nút xóa option (options được render từ server)
        document.addEventListener('DOMContentLoaded', function() {
            const removeButtons = document.querySelectorAll('.remove-option-btn');
            removeButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const optionId = this.getAttribute('data-option-id');
                    const optionName = this.getAttribute('data-option-name');
                    removeOptionFromList(optionId, optionName);
                });
            });

            // Handle form submit to ensure old images are preserved when no new images are uploaded
            const editForm = document.getElementById('editServiceForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    const imageInput = document.getElementById('imageInputEdit');
                    const currentImagesData = document.getElementById('currentImagesData');
                    const removedImagesContainer = document.getElementById('removedImagesContainer');
                    
                    // Get current images list
                    const currentImagesStr = currentImagesData ? currentImagesData.value : '';
                    const currentImages = currentImagesStr 
                        ? currentImagesStr.split(',').map(img => img.trim()).filter(img => img.length > 0)
                        : [];
                    
                    // Get removed images list
                    const removedInputs = removedImagesContainer ? removedImagesContainer.querySelectorAll('input[name="RemoveImages"]') : [];
                    const removedImages = Array.from(removedInputs).map(input => input.value.trim()).filter(img => img.length > 0);
                    
                    // Calculate remaining images (current - removed)
                    const remainingImages = currentImages.filter(img => !removedImages.includes(img));
                    
                    // Check if there are new images being uploaded
                    const hasNewImages = imageInput && imageInput.files && imageInput.files.length > 0;
                    
                    // If no new images are uploaded, send the remaining images as KeepImages
                    // This ensures backend knows which old images to preserve
                    if (!hasNewImages && remainingImages.length > 0) {
                        // Remove any existing KeepImages inputs
                        const existingKeepImages = document.querySelectorAll('input[name="KeepImages"]');
                        existingKeepImages.forEach(input => input.remove());
                        
                        // Add hidden inputs for images to keep
                        remainingImages.forEach(imgPath => {
                            if (imgPath && imgPath.trim().length > 0) {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'KeepImages';
                                hiddenInput.value = imgPath.trim();
                                removedImagesContainer.appendChild(hiddenInput);
                            }
                        });
                    }
                });
            }
        });
    </script>
    
    <!-- Create Option Modal (Edit) -->
    <div class="modal fade" id="createOptionModalEdit" tabindex="-1" aria-labelledby="createOptionModalEditLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header modern-modal-header">
                    <h5 class="modal-title" id="createOptionModalEditLabel">
                        <i class="bi bi-gear me-2"></i>
                        Tạo Option mới
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createOptionFormEdit" novalidate>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="optionNameEdit" class="form-label">Tên Option <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="optionNameEdit" name="optionName" required placeholder="VD: Thêm 2 giờ">
                            <div class="text-danger small mt-1" id="optionNameEditError" style="display: none;"></div>
                        </div>
                        <div class="mb-3">
                            <label for="optionDescriptionEdit" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="optionDescriptionEdit" name="description" rows="3" placeholder="Mô tả chi tiết về option..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="optionPriceEdit" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="optionPriceEdit" name="price" required min="0" step="1000" placeholder="100000">
                                <div class="text-danger small mt-1" id="optionPriceEditError" style="display: none;"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="optionUnitTypeEdit" class="form-label">
                                    <i class="bi bi-rulers me-1"></i>Đơn vị tính giá <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="optionUnitTypeEdit" name="unitType" required>
                                    <option value="">-- Chọn đơn vị tính giá --</option>
                                    <option value="Hour">Giờ</option>
                                    <option value="Day">Ngày</option>
                                    <option value="Visit">Lần</option>
                                    <option value="Apartment">Căn</option>
                                    <option value="Room">Phòng</option>
                                    <option value="SquareMeter">Mét vuông (m²)</option>
                                    <option value="Person">Người</option>
                                    <option value="Package">Gói</option>
                                    <option value="Event">Sự kiện</option>
                                </select>
                                <small class="form-text text-muted small d-block mt-1">
                                    <i class="bi bi-info-circle me-1"></i>Đơn vị tính giá cho option này
                                </small>
                                <div class="text-danger small mt-1" id="optionUnitTypeEditError" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>
                            Tạo Option
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}


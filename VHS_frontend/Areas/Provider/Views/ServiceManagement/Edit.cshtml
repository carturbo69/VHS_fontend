@model VHS_frontend.Areas.Provider.Models.Service.ServiceProviderUpdateDTO
@{
    ViewData["Title"] = "Chỉnh sửa Dịch vụ";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    var serviceId = ViewBag.ServiceId as string;
    var currentImageUrl = ViewBag.CurrentImageUrl as string;
    var categoryName = ViewBag.CategoryName as string;
    var tags = ViewBag.Tags as List<VHS_frontend.Areas.Provider.Models.Service.TagDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.TagDTO>();
    var options = ViewBag.Options as List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/service-management.css" asp-append-version="true" />
}

<div class="service-management-container">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 create-page-header">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-pencil me-2"></i>
                    Chỉnh sửa Dịch vụ
                </h4>
                <a asp-action="Index" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Form Card -->
    <div class="card shadow-sm form-card">
        <div class="card-header form-card-header">
            <h6 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>
                Thông tin Dịch vụ
            </h6>
        </div>
        <div class="card-body">
            <form asp-action="Edit" asp-route-id="@serviceId" method="post" enctype="multipart/form-data" id="editServiceForm">
                @Html.AntiForgeryToken()

                <script>
                    // Validation functions - must be defined before form fields
                    function validateBaseUnit(field) {
                        const value = parseFloat(field.value);
                        if (!field.value || field.value === '' || field.value === null || field.value === undefined) {
                            field.setCustomValidity('Vui lòng nhập số lượng tối thiểu.');
                        } else if (isNaN(value) || value < 1) {
                            field.setCustomValidity('Số lượng tối thiểu phải từ 1 trở lên.');
                        } else {
                            field.setCustomValidity('');
                        }
                    }
                </script>

                <div class="row g-3">
                    <!-- Category (Read-only) -->
                    <div class="col-md-6">
                        <label class="form-label">Danh mục</label>
                        <input type="text" class="form-control" value="@categoryName" readonly />
                        <small class="form-text text-muted small">Danh mục không thể thay đổi sau khi tạo.</small>
                    </div>

                    <!-- Tag Selection -->
                    <div class="col-md-6">
                        <label class="form-label">Tag <span class="text-danger">*</span></label>
                        <!-- Selected Tag Display (hiển thị trong khung giống category) -->
                        <div id="selectedTagDisplay" class="@(Model.TagIds.Any() ? "" : "d-none")">
                            <div class="input-group">
                                <input type="text" class="form-control" id="selectedTagName" value="@(tags.FirstOrDefault(t => Model.TagIds.Contains(t.TagId))?.Name ?? "")" readonly />
                                <button type="button" class="btn btn-outline-secondary" id="removeSelectedTagBtn" title="Xóa tag">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <select class="form-select @(Model.TagIds.Any() ? "d-none" : "")" id="tagSelect" required>
                            <option value="">-- Chọn tag --</option>
                        </select>
                        <small class="form-text text-muted small">Chọn tag để xem các tùy chọn</small>
                        <input type="hidden" name="TagIds" id="selectedTagId" value="@(Model.TagIds.FirstOrDefault().ToString() ?? "")" />
                    </div>
                </div>

                <!-- Title - Hidden, tự động lấy từ tag -->
                <input type="hidden" asp-for="Title" id="titleInput" />

                <!-- Options Section (Options hiển thị ở dưới) -->
                <div class="mt-3" id="selectedOptionsSection" style="display: @(Model.OptionIds.Any() ? "block" : "none");">
                    <label class="form-label fw-bold section-label">
                        <i class="bi bi-list-check me-2"></i>
                        Tùy chọn
                    </label>
                    <div id="selectedOptionsContainer" class="p-3 border rounded">
                        <!-- Tất cả options của các tags đã chọn sẽ hiển thị ở đây -->
                    </div>
                </div>

                <!-- Description -->
                <div class="mt-3">
                    <label asp-for="Description" class="form-label">Mô tả <span class="text-danger">*</span></label>
                    <textarea asp-for="Description" name="Description" id="Description" class="form-control" rows="3" placeholder="Mô tả chi tiết về dịch vụ..." 
                              data-val="true" 
                              data-val-required="Vui lòng nhập mô tả dịch vụ."
                              required
                              oninvalid="this.setCustomValidity('Vui lòng nhập mô tả dịch vụ.')"
                              oninput="this.setCustomValidity('')"></textarea>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <div class="row g-3 mt-0">
                    <!-- Price -->
                    <div class="col-md-4">
                        <label asp-for="Price" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                        <input asp-for="Price" asp-format="{0:0}" type="number" class="form-control" min="0" step="1000" placeholder="0" required />
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div>

                    <!-- Unit Type -->
                    <div class="col-md-4">
                        <label asp-for="UnitType" class="form-label">
                            <i class="bi bi-rulers me-1"></i>Đơn vị <span class="text-danger">*</span>
                        </label>
                        <select asp-for="UnitType" class="form-select" id="unitTypeSelect" required>
                            <option value="">-- Chọn đơn vị --</option>
                            <option value="Hour">Giờ</option>
                            <option value="Day">Ngày</option>
                            <option value="Visit">Lần</option>
                            <option value="Apartment">Căn</option>
                            <option value="Room">Phòng</option>
                            <option value="SquareMeter">Mét vuông (m²)</option>
                            <option value="Person">Người</option>
                            <option value="Package">Gói</option>
                            <option value="Event">Sự kiện</option>
                        </select>
                        <span asp-validation-for="UnitType" class="text-danger small"></span>
                    </div>

                    <!-- Base Unit -->
                    <div class="col-md-4">
                        <label asp-for="BaseUnit" class="form-label">
                            <i class="bi bi-123 me-1"></i>Số lượng tối thiểu <span class="text-danger">*</span>
                        </label>
                        <input asp-for="BaseUnit" name="BaseUnit" id="BaseUnit" type="number" class="form-control" min="1" step="1" placeholder="1" 
                               data-val="true" 
                               data-val-required="Vui lòng nhập số lượng tối thiểu."
                               data-val-min="Số lượng tối thiểu phải từ 1 trở lên."
                               data-val-min-min="1"
                               required
                               oninvalid="validateBaseUnit(this)"
                               oninput="this.setCustomValidity('')" />
                        <span asp-validation-for="BaseUnit" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Status -->
                <div class="mt-3">
                    <label asp-for="Status" class="form-label">Trạng thái</label>
                    <select asp-for="Status" class="form-select">
                        <option value="Active">Hoạt động</option>
                        <option value="Inactive">Tạm dừng</option>
                    </select>
                    <span asp-validation-for="Status" class="text-danger small"></span>
                </div>

                <!-- Images (Gộp avatar + ảnh mô tả) -->
                <div class="mt-3">
                    <label class="form-label">Hình ảnh dịch vụ</label>
                    @{
                        var imagesCsv = currentImageUrl ?? string.Empty;
                        var imgs = imagesCsv.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
                        var avatar = imgs.FirstOrDefault();
                        var descImgs = imgs.Skip(1).ToList();
                        string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
                    }

                    <!-- Hình ảnh hiện tại (gộp avatar + mô tả) -->
                    <div class="mb-2">
                        <div class="image-inline-gallery" id="imageGalleryContainer">
                            @if (!string.IsNullOrEmpty(avatar))
                            {
                                var avatarUrl = ToUrl(avatar);
                                <div class="removable-image" data-path="@avatar">
                                    <img src="@avatarUrl" alt="Avatar"
                                         onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'alert alert-warning\'>Không thể tải ảnh</div>';" />
                                    <button type="button" class="btn btn-sm btn-danger remove-image-btn" title="Xoá ảnh" aria-label="Xoá ảnh">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            }
                            @if (descImgs.Any())
                            {
                                foreach (var p in descImgs)
                                {
                                    var u = ToUrl(p);
                                    <div class="removable-image" data-path="@p">
                                        <img src="@u" alt="Desc"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'alert alert-warning p-2\'>Lỗi ảnh</div>';" />
                                        <button type="button" class="btn btn-sm btn-danger remove-image-btn" title="Xoá ảnh" aria-label="Xoá ảnh">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                        <!-- Hidden inputs for removed images -->
                        <div id="removedImagesContainer"></div>
                        <!-- Hidden input to store current images (for keeping old images when no new images are uploaded) -->
                        <input type="hidden" id="currentImagesData" value="@currentImageUrl" />
                        <div class="file-input-wrapper">
                            <input name="Images" type="file" id="imageInputEdit" class="form-control mt-3" accept="image/*" multiple />
                        </div>
                        <span asp-validation-for="Images" class="text-danger small"></span>
                        <small class="form-text text-muted small">Chọn 1 hoặc nhiều ảnh mới. Ảnh mới sẽ được thêm vào cuối; ảnh đại diện hiện tại không thay đổi trừ khi bạn chọn Avatar riêng.</small>
                    </div>
                </div>


                <div class="d-flex justify-content-center gap-2 mt-4 pt-3 border-top">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        Hủy
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script>
        // Override jQuery Validation messages to Vietnamese IMMEDIATELY after jQuery Validation loads
        // This MUST happen before unobtrusive validation is loaded
        if (typeof jQuery !== 'undefined' && jQuery.validator) {
            jQuery.extend(jQuery.validator.messages, {
                required: "Trường này là bắt buộc.",
                remote: "Vui lòng sửa trường này.",
                email: "Vui lòng nhập địa chỉ email hợp lệ.",
                url: "Vui lòng nhập URL hợp lệ.",
                date: "Vui lòng nhập ngày hợp lệ.",
                dateISO: "Vui lòng nhập ngày hợp lệ (ISO).",
                number: "Vui lòng nhập số hợp lệ.",
                digits: "Vui lòng chỉ nhập chữ số.",
                equalTo: "Vui lòng nhập cùng một giá trị.",
                maxlength: jQuery.validator.format("Vui lòng nhập không quá {0} ký tự."),
                minlength: jQuery.validator.format("Vui lòng nhập ít nhất {0} ký tự."),
                rangelength: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1} ký tự."),
                range: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1}."),
                max: jQuery.validator.format("Vui lòng nhập giá trị nhỏ hơn hoặc bằng {0}."),
                min: jQuery.validator.format("Vui lòng nhập giá trị lớn hơn hoặc bằng {0}."),
                step: jQuery.validator.format("Vui lòng nhập bội số của {0}.")
            });
        }
    </script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        // Image Preview Function
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Xoá ảnh hiện tại và thêm input ẩn RemoveImages để submit
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.remove-image-btn');
            if (!btn) return;
            const wrap = btn.closest('.removable-image');
            if (!wrap) return;
            
            // Only process existing images (have data-path), not preview images (have data-preview-index)
            const path = wrap.getAttribute('data-path');
            if (!path) return; // Skip if this is a preview image
            
            const container = document.getElementById('removedImagesContainer');
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'RemoveImages';
            hidden.value = path;
            container.appendChild(hidden);
            wrap.remove();
        });

        // Image preview functionality for Edit form
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('imageInputEdit');
            const galleryContainer = document.getElementById('imageGalleryContainer');
            let selectedFiles = [];

            if (imageInput && galleryContainer) {
                function addPreviewToGallery() {
                    selectedFiles.forEach((file, index) => {
                        if (!file.type.startsWith('image/')) {
                            return;
                        }

                        // Check if preview already exists
                        const existingPreview = galleryContainer.querySelector(`[data-preview-index="${index}"]`);
                        if (existingPreview) {
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageWrapper = document.createElement('div');
                            imageWrapper.className = 'removable-image';
                            imageWrapper.dataset.previewIndex = index;
                            imageWrapper.innerHTML = `
                                <img src="${e.target.result}" alt="Preview ${index + 1}" />
                                <button type="button" class="btn btn-sm btn-danger remove-image-btn remove-preview-btn" data-index="${index}" title="Xóa ảnh" aria-label="Xóa ảnh">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            `;
                            galleryContainer.appendChild(imageWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                imageInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    // Merge với files hiện có (nếu có)
                    selectedFiles = [...selectedFiles, ...newFiles];
                    addPreviewToGallery();
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                });

                // Remove preview image (only for new preview images, not existing ones)
                galleryContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-preview-btn');
                    if (!removeBtn) return;
                    
                    // Make sure this is a preview image, not an existing image
                    const wrapper = removeBtn.closest('[data-preview-index]');
                    if (!wrapper) return; // Existing images have data-path, not data-preview-index

                    const index = parseInt(removeBtn.dataset.index);
                    
                    wrapper.remove();
                    
                    // Remove file from array
                    selectedFiles.splice(index, 1);
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                    
                    // Re-render all previews with correct indices
                    galleryContainer.querySelectorAll('[data-preview-index]').forEach(el => el.remove());
                    addPreviewToGallery();
                });
            }
        });

        // Helper functions for validation messages in modal
        function showFieldErrorEdit(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);
            if (field && errorDiv) {
                field.classList.add('is-invalid');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideFieldErrorEdit(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(errorId);
            if (field && errorDiv) {
                field.classList.remove('is-invalid');
                errorDiv.style.display = 'none';
            }
        }

        // Function to get Vietnamese label for option type
        function getTypeLabel(type) {
            const typeMap = {
                'checkbox': 'Chọn nhiều',
                'radio': 'Chọn một',
                'textarea': 'Nhập văn bản'
            };
            return typeMap[type?.toLowerCase()] || type || 'Chưa xác định';
        }

        // Routes để lấy options theo tag
        const optionsByTagUrl = '@Url.Action("GetOptions", "Category", new { area = "Admin" })';
        
        // Lấy danh sách optionIds và tagIds đã chọn từ model
        const selectedOptionIds = @Html.Raw(Json.Serialize(Model.OptionIds));
        const initialTagIds = @Html.Raw(Json.Serialize(Model.TagIds));
        const categoryId = '@(ViewBag.CategoryId ?? "")';
        // Lấy giá trị đã lưu của options (từ service options)
        // Dùng cả ViewBag.OptionValues (đã được tạo trong controller) và ViewBag.Options để đảm bảo có dữ liệu
        const optionValuesMap = {};
        
        // Thử từ ViewBag.OptionValues trước (Dictionary đã được tạo trong controller)
        @{
            var optionValuesFromBag = ViewBag.OptionValues as Dictionary<string, string> ?? new Dictionary<string, string>();
        }
        @if (optionValuesFromBag != null && optionValuesFromBag.Any())
        {
            foreach (var kvp in optionValuesFromBag)
            {
                <text>
                optionValuesMap['@kvp.Key'] = @Html.Raw(Json.Serialize(kvp.Value ?? string.Empty));
                </text>
            }
        }
        
        // Nếu không có từ ViewBag.OptionValues, thử từ ViewBag.Options
        @if ((optionValuesFromBag == null || !optionValuesFromBag.Any()) && options != null && options.Any())
        {
            foreach (var opt in options.Where(o => !string.IsNullOrWhiteSpace(o.Value)))
            {
                <text>
                optionValuesMap['@opt.OptionId.ToString()'] = @Html.Raw(Json.Serialize(opt.Value ?? string.Empty));
                </text>
            }
        }
        
        // Debug: Log ngay sau khi khởi tạo
        console.log('=== optionValuesMap INITIALIZED ===');
        console.log('optionValuesMap:', optionValuesMap);
        console.log('optionValuesMap keys:', Object.keys(optionValuesMap));
        console.log('Total options with values:', Object.keys(optionValuesMap).length);
        console.log('ViewBag.OptionValues count:', @(optionValuesFromBag?.Count ?? 0));
        console.log('ViewBag.Options count:', @(options?.Count ?? 0));

        let availableTags = [];
        let selectedTag = null; // Chỉ lưu 1 tag đã chọn: {tagId, name}

        // Load tags vào dropdown khi trang load
        async function loadTagsToDropdown() {
            const tagSelect = document.getElementById('tagSelect');
            
            if (!categoryId) {
                tagSelect.innerHTML = '<option value="">-- Không có danh mục --</option>';
                tagSelect.disabled = true;
                return;
            }

            tagSelect.disabled = false;
            tagSelect.innerHTML = '<option value="">-- Đang tải tags... --</option>';

            try {
                const response = await fetch(`/Provider/ServiceManagement/GetTagsByCategory?categoryId=${categoryId}`);
                const tags = await response.json();

                availableTags = tags || [];

                if (availableTags.length > 0) {
                    let html = '<option value="">-- Chọn tag --</option>';
                    availableTags.forEach(function (tag) {
                        // Hiển thị tất cả tags (vì chỉ chọn 1, không cần ẩn tag đã chọn)
                        html += `<option value="${tag.tagId}" data-tag-name="${tag.name}">${tag.name}</option>`;
                    });
                    tagSelect.innerHTML = html;
                } else {
                    tagSelect.innerHTML = '<option value="">-- Không có tags --</option>';
                }
            } catch (error) {
                console.error('Error loading tags:', error);
                tagSelect.innerHTML = '<option value="">-- Lỗi khi tải tags --</option>';
            }
        }

        // Handle tag selection từ dropdown
        document.getElementById('tagSelect').addEventListener('change', async function() {
            const tagId = this.value;
            if (!tagId) {
                // Nếu chọn "-- Chọn tag --", xóa tag đã chọn
                if (selectedTag) {
                    removeSelectedTag();
                }
                return;
            }

            const selectedOption = this.options[this.selectedIndex];
            const tagName = selectedOption.getAttribute('data-tag-name');

            // Nếu đã có tag được chọn, xóa tag cũ trước
            if (selectedTag) {
                removeSelectedTag();
            }

            // Chọn tag mới
            await setSelectedTag(tagId, tagName);

            // Reset dropdown về "-- Chọn tag --"
            this.value = '';
        });

        // Handle remove tag button
        document.getElementById('removeSelectedTagBtn').addEventListener('click', function() {
            removeSelectedTag();
            document.getElementById('tagSelect').value = '';
        });

        // Set tag đã chọn
        async function setSelectedTag(tagId, tagName) {
            selectedTag = { tagId, name: tagName };

            // Hiển thị tag đã chọn trong khung input (giống category)
            const selectedTagDisplay = document.getElementById('selectedTagDisplay');
            const selectedTagName = document.getElementById('selectedTagName');
            const selectedTagIdInput = document.getElementById('selectedTagId');
            const tagSelect = document.getElementById('tagSelect');
            
            selectedTagName.value = tagName;
            selectedTagIdInput.value = tagId;
            selectedTagDisplay.classList.remove('d-none');
            tagSelect.classList.add('d-none');

            // Load options cho tag này
            const selectedOptionsContainer = document.getElementById('selectedOptionsContainer');
            await loadOptionsForTag(tagId, tagName, selectedOptionsContainer);

            // Hiển thị section options
            document.getElementById('selectedOptionsSection').style.display = 'block';

            // Cập nhật tên dịch vụ
            updateServiceTitleFromTags();
        }

        // Xóa tag đã chọn
        function removeSelectedTag() {
            if (!selectedTag) return;

            // Ẩn hiển thị tag đã chọn và hiển thị lại dropdown
            const selectedTagDisplay = document.getElementById('selectedTagDisplay');
            const selectedTagIdInput = document.getElementById('selectedTagId');
            const tagSelect = document.getElementById('tagSelect');
            
            selectedTagDisplay.classList.add('d-none');
            tagSelect.classList.remove('d-none');
            selectedTagIdInput.value = '';

            // Xóa tất cả options
            const selectedOptionsContainer = document.getElementById('selectedOptionsContainer');
            selectedOptionsContainer.innerHTML = '';

            // Ẩn section options
            document.getElementById('selectedOptionsSection').style.display = 'none';

            // Xóa tag khỏi biến
            selectedTag = null;

            // Cập nhật tên dịch vụ
            updateServiceTitleFromTags();
        }

        // Function để cập nhật tên dịch vụ từ tag đã chọn
        function updateServiceTitleFromTags() {
            const titleInput = document.getElementById('titleInput');
            if (!titleInput) return;

            if (selectedTag) {
                // Lấy tên của tag đã chọn
                titleInput.value = selectedTag.name;
            } else {
                // Nếu không có tag nào được chọn, để trống
                titleInput.value = '';
            }
        }

        // Load options cho một tag (thêm vào container chung)
        async function loadOptionsForTag(tagId, tagName, optionsContainer) {
            // Xóa tất cả options cũ trước khi load mới
            optionsContainer.innerHTML = '';
            
            // Debug: Log optionValuesMap để kiểm tra
            console.log('=== loadOptionsForTag DEBUG ===');
            console.log('optionValuesMap:', optionValuesMap);
            console.log('Type of optionValuesMap:', typeof optionValuesMap);
            if (optionValuesMap && typeof optionValuesMap === 'object') {
                console.log('optionValuesMap keys:', Object.keys(optionValuesMap));
                console.log('optionValuesMap values:', Object.values(optionValuesMap));
            }
            
            // Tạo loading indicator cho tag này
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-muted small mb-2';
            loadingDiv.id = `loading-${tagId}`;
            loadingDiv.dataset.tagId = tagId;
            loadingDiv.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>Đang tải tùy chọn cho "${tagName}"...`;
            optionsContainer.appendChild(loadingDiv);
            
            try {
                const res = await fetch(`${optionsByTagUrl}?tagId=${tagId}`);
                if (!res.ok) {
                    loadingDiv.innerHTML = `<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi tải tùy chọn cho "${tagName}".</div>`;
                            return;
                        }
                        
                const options = await res.json();
                
                // Xóa loading indicator
                loadingDiv.remove();
                
                if (!options || options.length === 0) {
                    const noOptionsDiv = document.createElement('div');
                    noOptionsDiv.className = 'text-muted small mb-2';
                    noOptionsDiv.dataset.tagId = tagId;
                    noOptionsDiv.innerHTML = `<i class="bi bi-inbox me-1"></i>Tag "${tagName}" chưa có tùy chọn nào.`;
                    optionsContainer.appendChild(noOptionsDiv);
                            return;
                        }
                        
                // Nhóm options theo Family
                const groupedOptions = {};
                const ungroupedOptions = [];

                options.forEach(o => {
                    if (o.family) {
                        if (!groupedOptions[o.family]) {
                            groupedOptions[o.family] = [];
                        }
                        groupedOptions[o.family].push(o);
                    } else {
                        ungroupedOptions.push(o);
                    }
                });

                // Sắp xếp các nhóm theo type (radio, select, checkbox)
                const groupOrder = ['radio', 'select', 'checkbox'];
                const sortedGroupIds = Object.keys(groupedOptions).sort((a, b) => {
                    const typeA = groupedOptions[a][0]?.type?.toLowerCase() || '';
                    const typeB = groupedOptions[b][0]?.type?.toLowerCase() || '';
                    const indexA = groupOrder.indexOf(typeA);
                    const indexB = groupOrder.indexOf(typeB);
                    if (indexA === -1 && indexB === -1) return 0;
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                // Render các nhóm (Family) - Sắp xếp theo thứ tự
                sortedGroupIds.forEach(familyId => {
                    const groupOptions = groupedOptions[familyId];
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'option-group mb-3';
                    groupDiv.dataset.tagId = tagId;
                    
                    // Kiểm tra type của nhóm
                    const groupType = groupOptions[0]?.type?.toLowerCase() || 'checkbox';
                    const typeLabel = getTypeLabel(groupType);
                    
                    // Màu sắc theo loại nhóm
                    let borderColor = '#ffc107'; // default (yellow)
                    let bgColor = '#fffbf0'; // default
                    let textColor = '#856404'; // default
                    if (groupType === 'radio') {
                        borderColor = '#0d6efd'; // blue
                        bgColor = '#e7f3ff';
                        textColor = '#084298';
                    } else if (groupType === 'checkbox') {
                        borderColor = '#6f42c1'; // purple
                        bgColor = '#f3e8ff';
                        textColor = '#5a189a';
                    }
                    
                    groupDiv.style.cssText = `padding: 0.75rem; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 0.5rem;`;
                    
                    let groupHtml = `
                        <div class="group-header mb-2" style="font-weight: 600; color: ${textColor}; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-diagram-3" style="color: ${borderColor};"></i>
                            <span>Nhóm: ${typeLabel} (${groupOptions.length} tùy chọn)</span>
                            </div>`;
                    
                    const radioGroupName = `optionFamily_${tagId}_${familyId}`;
                    
                    groupOptions.forEach(o => {
                        const isChecked = Array.isArray(selectedOptionIds) && selectedOptionIds.includes(o.optionId);
                        const optionTypeLabel = getTypeLabel(o.type);
                        const uniqueId = `option_${tagId}_${o.optionId}`;
                        
                        if (groupType === 'radio') {
                            // Radio button - chỉ chọn 1 trong nhóm
                            groupHtml += `
                                <div class="mb-2" style="padding-left: 1.5rem; border-left: 2px solid ${borderColor};">
                                    <input class="form-check-input form-check-input-sm" type="radio" name="${radioGroupName}" value="${o.optionId}" id="${uniqueId}" ${isChecked ? 'checked' : ''} />
                                    <input type="hidden" name="OptionIds" value="${o.optionId}" ${isChecked ? '' : 'disabled'} />
                                    <label class="form-check-label small" for="${uniqueId}">
                                        <span class="fw-semibold">${o.optionName}</span>
                                </label>
                            </div>`;
                    } else {
                            // Checkbox - có thể chọn nhiều
                            groupHtml += `
                                <div class="mb-2" style="padding-left: 1.5rem; border-left: 2px solid ${borderColor};">
                                    <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" ${isChecked ? 'checked' : ''} />
                                    <label class="form-check-label small" for="${uniqueId}">
                                        <span class="fw-semibold">${o.optionName}</span>
                                    </label>
                                </div>`;
                        }
                    });
                    
                    groupDiv.innerHTML = groupHtml;
                    optionsContainer.appendChild(groupDiv);
                    
                    // Xử lý radio buttons - khi chọn radio, enable/disable hidden input
                    if (groupType === 'radio') {
                        groupDiv.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radio => {
                            radio.addEventListener('change', function() {
                                // Disable tất cả hidden inputs trong nhóm
                                groupDiv.querySelectorAll('input[type="hidden"][name="OptionIds"]').forEach(hidden => {
                                    hidden.disabled = true;
                                });
                                // Enable hidden input của radio được chọn
                                const hiddenInput = groupDiv.querySelector(`input[type="hidden"][value="${this.value}"]`);
                                if (hiddenInput) {
                                    hiddenInput.disabled = false;
                                }
                            });
                            
                            // Khởi tạo trạng thái cho radio đã checked
                            if (radio.checked) {
                                const hiddenInput = groupDiv.querySelector(`input[type="hidden"][value="${radio.value}"]`);
                                if (hiddenInput) {
                                    hiddenInput.disabled = false;
                                }
                    }
                });
            }
        });

                // Render các options không có nhóm - hiển thị sau các nhóm
                if (ungroupedOptions.length > 0 && sortedGroupIds.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'mb-2 mt-3';
                    separator.style.cssText = 'border-top: 2px solid #dee2e6; padding-top: 0.75rem;';
                    separator.innerHTML = '<small class="text-muted"><i class="bi bi-three-dots me-1"></i>Options độc lập</small>';
                    optionsContainer.appendChild(separator);
                }
                
                ungroupedOptions.forEach(o => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mb-2';
                    optionDiv.dataset.tagId = tagId;
                    
                    const isChecked = Array.isArray(selectedOptionIds) && selectedOptionIds.includes(o.optionId);
                    const typeLabel = getTypeLabel(o.type);
                    const uniqueId = `option_${tagId}_${o.optionId}`;
                    const optionType = o.type?.toLowerCase() || 'checkbox';
                    
                    if (optionType === 'textarea') {
                        // Textarea - cho phép nhập văn bản nhiều dòng
                        // Tìm giá trị đã nhập từ service options (nếu có)
                        // Convert optionId sang string để so sánh với key trong optionValuesMap (keys đã là string)
                        const optionIdStr = String(o.optionId).toLowerCase().trim();
                        let existingValue = '';
                        
                        // Debug: Log để kiểm tra
                        console.log(`\n--- Textarea option: ${o.optionName} ---`);
                        console.log('o.optionId (raw):', o.optionId, 'type:', typeof o.optionId);
                        console.log('optionIdStr (normalized):', optionIdStr);
                        console.log('optionValuesMap keys:', Object.keys(optionValuesMap));
                        
                        if (optionValuesMap && typeof optionValuesMap === 'object' && Object.keys(optionValuesMap).length > 0) {
                            // Normalize tất cả keys trong optionValuesMap để so sánh
                            const normalizedMap = {};
                            Object.keys(optionValuesMap).forEach(key => {
                                const normalizedKey = String(key).toLowerCase().trim();
                                normalizedMap[normalizedKey] = optionValuesMap[key];
                            });
                            
                            // Thử tìm với normalized key
                            if (normalizedMap[optionIdStr] !== undefined) {
                                existingValue = normalizedMap[optionIdStr];
                                console.log('✅ Found with normalized key');
                            } else {
                                // Thử tìm với exact match (case-sensitive)
                                const exactKey = Object.keys(optionValuesMap).find(k => String(k).toLowerCase().trim() === optionIdStr);
                                if (exactKey) {
                                    existingValue = optionValuesMap[exactKey];
                                    console.log('✅ Found with exact match:', exactKey);
                                } else {
                                    // Thử tìm với partial match (nếu có format khác)
                                    const partialKey = Object.keys(optionValuesMap).find(k => {
                                        const kNorm = String(k).toLowerCase().trim();
                                        return kNorm.includes(optionIdStr) || optionIdStr.includes(kNorm);
                                    });
                                    if (partialKey) {
                                        existingValue = optionValuesMap[partialKey];
                                        console.log('✅ Found with partial match:', partialKey);
                                    } else {
                                        console.log('❌ NOT FOUND - No matching key');
                                        console.log('Available normalized keys:', Object.keys(normalizedMap));
                                    }
                                }
                            }
                        } else {
                            console.log('⚠️ optionValuesMap is empty or not an object');
                        }
                        
                        console.log('Final existingValue:', existingValue);
                        
                        // Escape HTML để tránh XSS và giữ nguyên giá trị
                        const escapedValue = existingValue.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                        
                        // Kiểm tra xem option này đã được chọn chưa (có trong selectedOptionIds)
                        const isChecked = Array.isArray(selectedOptionIds) && selectedOptionIds.includes(o.optionId);
                        const textareaCheckboxId = `textarea_checkbox_${uniqueId}`;
                        
                        optionDiv.innerHTML = `
                            <div class="mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input form-check-input-sm" type="checkbox" id="${textareaCheckboxId}" ${isChecked ? 'checked' : ''} />
                                    <label class="form-check-label small fw-semibold" for="${textareaCheckboxId}">
                                        ${o.optionName}
                                    </label>
                                </div>
                                <textarea class="form-control form-control-sm" id="${uniqueId}" name="OptionValues[${o.optionId}]" rows="2" placeholder="${o.optionName}..." ${isChecked ? '' : 'disabled'}>${escapedValue}</textarea>
                                <input type="hidden" name="OptionIds" value="${o.optionId}" ${isChecked ? '' : 'disabled'} />
                            </div>`;
                        
                        // Xử lý checkbox: enable/disable textarea và hidden input
                        setTimeout(() => {
                            const checkbox = document.getElementById(textareaCheckboxId);
                            const textarea = document.getElementById(uniqueId);
                            const hiddenInput = optionDiv.querySelector('input[type="hidden"][name="OptionIds"]');
                            
                            if (checkbox && textarea && hiddenInput) {
                                // Đảm bảo nếu checkbox đã checked từ đầu, textarea và hidden input phải enabled
                                if (checkbox.checked) {
                                    textarea.disabled = false;
                                    textarea.removeAttribute('disabled');
                                    hiddenInput.disabled = false;
                                    hiddenInput.removeAttribute('disabled');
                                }
                                
                                checkbox.addEventListener('change', function() {
                                    if (this.checked) {
                                        textarea.disabled = false;
                                        textarea.removeAttribute('disabled');
                                        hiddenInput.disabled = false;
                                        hiddenInput.removeAttribute('disabled');
                                    } else {
                                        textarea.disabled = true;
                                        textarea.setAttribute('disabled', 'disabled');
                                        textarea.value = ''; // Xóa giá trị khi bỏ chọn
                                        hiddenInput.disabled = true;
                                        hiddenInput.setAttribute('disabled', 'disabled');
                                    }
                                });
                            }
                        }, 100);
                    } else if (optionType === 'checkbox') {
                        // Checkbox - có thể chọn nhiều
                        optionDiv.innerHTML = `
                            <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" ${isChecked ? 'checked' : ''} />
                            <label class="form-check-label small" for="${uniqueId}">
                                <span class="fw-semibold">${o.optionName}</span>
                            </label>`;
                    } else {
                        // Radio hoặc loại khác - xử lý như checkbox
                        optionDiv.innerHTML = `
                            <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" ${isChecked ? 'checked' : ''} />
                            <label class="form-check-label small" for="${uniqueId}">
                                <span class="fw-semibold">${o.optionName}</span>
                            </label>`;
                    }
                    optionsContainer.appendChild(optionDiv);
                });
            } catch (error) {
                console.error('Error loading options:', error);
                loadingDiv.innerHTML = `<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi tải tùy chọn cho "${tagName}".</div>`;
            }
        }

        // Load tags và options đã chọn khi trang load
        document.addEventListener('DOMContentLoaded', async function() {
            // Debug: Log optionValuesMap ngay khi trang load
            console.log('=== DOMContentLoaded DEBUG ===');
            console.log('optionValuesMap on page load:', optionValuesMap);
            console.log('optionValuesMap type:', typeof optionValuesMap);
            if (optionValuesMap && typeof optionValuesMap === 'object') {
                console.log('optionValuesMap keys on page load:', Object.keys(optionValuesMap));
                console.log('optionValuesMap entries on page load:', Object.entries(optionValuesMap));
            }
            
            // Load tags vào dropdown
            await loadTagsToDropdown();

            // Load tag đã chọn từ model (chỉ lấy tag đầu tiên vì chỉ chọn 1)
            if (Array.isArray(initialTagIds) && initialTagIds.length > 0) {
                const firstTagId = initialTagIds[0];
                // Cần lấy thông tin tag từ danh sách availableTags
                try {
                    const response = await fetch(`/Provider/ServiceManagement/GetTagsByCategory?categoryId=${categoryId}`);
                    const tags = await response.json();

                    if (tags && tags.length > 0) {
                        const tag = tags.find(t => t.tagId === firstTagId);
                        if (tag) {
                            await setSelectedTag(tag.tagId, tag.name);
                        }
                    }

                    // Cập nhật dropdown sau khi load xong tags
                    await loadTagsToDropdown();
                } catch (error) {
                    console.error('Error loading initial tag:', error);
                }
            }

            // Cập nhật tên dịch vụ từ tag đã chọn khi trang load
            updateServiceTitleFromTags();
        });

        // Handle form submit để preserve images
        document.addEventListener('DOMContentLoaded', function() {

            // Handle form submit to ensure old images are preserved when no new images are uploaded
            const editForm = document.getElementById('editServiceForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    console.log('=== FORM SUBMIT: Enabling all textareas ===');
                    
                    // Đảm bảo tất cả textarea đã checked đều enabled trước khi submit
                    const textareaCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="textarea_checkbox_"]');
                    console.log('Found textarea checkboxes:', textareaCheckboxes.length);
                    
                    textareaCheckboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            // Tìm textarea: id của textarea = checkbox.id.replace('textarea_checkbox_', '')
                            const textareaId = checkbox.id.replace('textarea_checkbox_', '');
                            const textarea = document.getElementById(textareaId);
                            
                            // Tìm hidden input trong cùng container với checkbox
                            const container = checkbox.closest('.mb-2');
                            const hiddenInput = container ? container.querySelector('input[type="hidden"][name="OptionIds"]') : null;
                            
                            if (textarea) {
                                textarea.disabled = false;
                                textarea.removeAttribute('disabled'); // Đảm bảo remove disabled attribute
                                console.log('✅ Enabled textarea:', textareaId, 'value:', textarea.value, 'name:', textarea.name);
                            } else {
                                console.warn('❌ Textarea not found:', textareaId);
                            }
                            
                            if (hiddenInput) {
                                hiddenInput.disabled = false;
                                hiddenInput.removeAttribute('disabled'); // Đảm bảo remove disabled attribute
                                console.log('✅ Enabled hidden input for option:', hiddenInput.value);
                            } else {
                                console.warn('❌ Hidden input not found for checkbox:', checkbox.id);
                            }
                        }
                    });
                    
                    // Đảm bảo tất cả textarea có giá trị đều được enable (kể cả khi không có checkbox hoặc checkbox bị lỗi)
                    const allTextareas = document.querySelectorAll('textarea[name^="OptionValues["]');
                    console.log('Found all textareas with OptionValues:', allTextareas.length);
                    
                    allTextareas.forEach(textarea => {
                        const hasValue = textarea.value && textarea.value.trim() !== '';
                        if (hasValue || !textarea.disabled) {
                            textarea.disabled = false;
                            textarea.removeAttribute('disabled');
                            console.log('✅ Enabled textarea by value check:', textarea.name, 'value:', textarea.value);
                            
                            // Tìm và enable hidden input tương ứng
                            const container = textarea.closest('.mb-2');
                            if (container) {
                                const hiddenInput = container.querySelector('input[type="hidden"][name="OptionIds"]');
                                if (hiddenInput) {
                                    hiddenInput.disabled = false;
                                    hiddenInput.removeAttribute('disabled');
                                    console.log('✅ Enabled hidden input by value check:', hiddenInput.value);
                                }
                            }
                        }
                    });
                    
                    // Final check: Log tất cả OptionValues và OptionIds sẽ được submit
                    const formData = new FormData(editForm);
                    console.log('=== FORM DATA TO SUBMIT ===');
                    for (let [key, value] of formData.entries()) {
                        if (key.startsWith('OptionValues[') || key === 'OptionIds') {
                            console.log(key + ':', value);
                        }
                    }
                    
                    const imageInput = document.getElementById('imageInputEdit');
                    const currentImagesData = document.getElementById('currentImagesData');
                    const removedImagesContainer = document.getElementById('removedImagesContainer');
                    
                    // Get current images list
                    const currentImagesStr = currentImagesData ? currentImagesData.value : '';
                    const currentImages = currentImagesStr 
                        ? currentImagesStr.split(',').map(img => img.trim()).filter(img => img.length > 0)
                        : [];
                    
                    // Get removed images list
                    const removedInputs = removedImagesContainer ? removedImagesContainer.querySelectorAll('input[name="RemoveImages"]') : [];
                    const removedImages = Array.from(removedInputs).map(input => input.value.trim()).filter(img => img.length > 0);
                    
                    // Calculate remaining images (current - removed)
                    const remainingImages = currentImages.filter(img => !removedImages.includes(img));
                    
                    // Check if there are new images being uploaded
                    const hasNewImages = imageInput && imageInput.files && imageInput.files.length > 0;
                    
                    // If no new images are uploaded, send the remaining images as KeepImages
                    // This ensures backend knows which old images to preserve
                    if (!hasNewImages && remainingImages.length > 0) {
                        // Remove any existing KeepImages inputs
                        const existingKeepImages = document.querySelectorAll('input[name="KeepImages"]');
                        existingKeepImages.forEach(input => input.remove());
                        
                        // Add hidden inputs for images to keep
                        remainingImages.forEach(imgPath => {
                            if (imgPath && imgPath.trim().length > 0) {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'KeepImages';
                                hiddenInput.value = imgPath.trim();
                                removedImagesContainer.appendChild(hiddenInput);
                            }
                        });
                    }
                });
            }
        });
    </script>
    
}


@model VHS_frontend.Areas.Provider.Models.Service.ServiceProviderCreateDTO
@{
    ViewData["Title"] = "Tạo Dịch vụ mới";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    var categories = ViewBag.Categories as List<VHS_frontend.Areas.Provider.Models.Service.CategoryDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.CategoryDTO>();
    var options = ViewBag.Options as List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/service-management.css" asp-append-version="true" />
}

<div class="service-management-container">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 create-page-header">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    Tạo Dịch vụ mới
                </h4>
                <a asp-action="Index" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Form Card -->
    <div class="card shadow-sm form-card">
        <div class="card-header form-card-header">
            <h6 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>
                Thông tin Dịch vụ
            </h6>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post" enctype="multipart/form-data" id="createServiceForm">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="ProviderId" />
                <input type="hidden" id="currentProviderId" value="@ViewBag.ProviderId" />

                <script>
                    // Validation functions - must be defined before form fields
                    function validateBaseUnit(field) {
                        const value = parseFloat(field.value);
                        if (!field.value || field.value === '' || field.value === null || field.value === undefined) {
                            field.setCustomValidity('Vui lòng nhập số lượng tối thiểu.');
                        } else if (isNaN(value) || value < 1) {
                            field.setCustomValidity('Số lượng tối thiểu phải từ 1 trở lên.');
                        } else {
                            field.setCustomValidity('');
                        }
                    }
                </script>

                <div class="row g-3">
                    <!-- Category Selection -->
                    <div class="col-md-6">
                        <label asp-for="CategoryId" class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <select asp-for="CategoryId" class="form-select" id="categorySelect" required>
                            <option value="">-- Chọn danh mục --</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.CategoryId">@category.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger small"></span>
                    </div>

                    <!-- Tag Selection -->
                    <div class="col-md-6">
                        <label class="form-label">Tag <span class="text-danger">*</span></label>
                        <!-- Selected Tag Display (hiển thị trong khung giống category) -->
                        <div id="selectedTagDisplay" class="d-none">
                            <div class="input-group">
                                <input type="text" class="form-control" id="selectedTagName" readonly />
                                <button type="button" class="btn btn-outline-secondary" id="removeSelectedTagBtn" title="Xóa tag">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <select class="form-select" id="tagSelect" required>
                            <option value="">-- Chọn danh mục trước --</option>
                        </select>
                        <small class="form-text text-muted small">Chọn tag để xem các tùy chọn</small>
                        <input type="hidden" name="TagIds" id="selectedTagId" />
                    </div>
                </div>

                <!-- Title - Hidden, tự động lấy từ tag -->
                <input type="hidden" asp-for="Title" id="titleInput" />

                <!-- Options Section (Options hiển thị ở dưới) -->
                <div class="mt-3" id="selectedOptionsSection" style="display: none;">
                    <label class="form-label fw-bold section-label">
                        <i class="bi bi-list-check me-2"></i>
                        Tùy chọn
                    </label>
                    <div id="selectedOptionsContainer" class="p-3 border rounded">
                        <!-- Tất cả options của các tags đã chọn sẽ hiển thị ở đây -->
                    </div>
                </div>

                <!-- Description -->
                <div class="mt-3">
                    <label asp-for="Description" class="form-label">Mô tả <span class="text-danger">*</span></label>
                    <textarea asp-for="Description" name="Description" id="Description" class="form-control" rows="5" placeholder="Ví dụ: Dịch vụ dọn dẹp nhà cửa chuyên nghiệp bao gồm:
- Quét dọn, lau chùi toàn bộ phòng khách, phòng ngủ, nhà bếp, nhà vệ sinh
- Thời gian: 2-3 giờ/ lần, có thể đặt lịch linh hoạt theo yêu cầu
- Địa điểm: Tại nhà khách hàng
- Cam kết: Đảm bảo sạch sẽ, gọn gàng, an toàn cho sức khỏe,..." 
                              data-val="true" 
                              data-val-required="Vui lòng nhập mô tả dịch vụ."
                              required
                              oninvalid="this.setCustomValidity('Vui lòng nhập mô tả dịch vụ.')"
                              oninput="this.setCustomValidity('')"></textarea>
                    <small class="form-text text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Gợi ý:</strong> Mô tả chi tiết về quy trình, thời gian, địa điểm, yêu cầu đặc biệt. Mô tả càng rõ ràng sẽ giúp khách hàng hiểu và tin tưởng dịch vụ của bạn hơn.
                    </small>
                    <span asp-validation-for="Description" class="text-danger small"></span>
                </div>

                <div class="row g-3 mt-0">
                    <!-- Price -->
                    <div class="col-md-4">
                        <label asp-for="Price" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                        <input asp-for="Price" type="number" class="form-control" min="0" step="1000" placeholder="0" required />
                        <span asp-validation-for="Price" class="text-danger small"></span>
                    </div>

                    <!-- Unit Type -->
                    <div class="col-md-4">
                        <label asp-for="UnitType" class="form-label">
                            <i class="bi bi-rulers me-1"></i>Đơn vị <span class="text-danger">*</span>
                        </label>
                        <select asp-for="UnitType" class="form-select" id="unitTypeSelect" required>
                            <option value="">-- Chọn đơn vị --</option>
                            <option value="Hour">Giờ</option>
                            <option value="Day">Ngày</option>
                            <option value="Visit">Lần</option>
                            <option value="Apartment">Căn</option>
                            <option value="Room">Phòng</option>
                            <option value="SquareMeter">Mét vuông (m²)</option>
                            <option value="Person">Người</option>
                            <option value="Package">Gói</option>
                            <option value="Event">Sự kiện</option>
                        </select>
                        <span asp-validation-for="UnitType" class="text-danger small"></span>
                    </div>

                    <!-- Base Unit -->
                    <div class="col-md-4">
                        <label asp-for="BaseUnit" class="form-label">
                            <i class="bi bi-123 me-1"></i>Số lượng tối thiểu <span class="text-danger">*</span>
                        </label>
                        <input asp-for="BaseUnit" name="BaseUnit" id="BaseUnit" type="number" class="form-control" min="1" step="1" placeholder="1" 
                               data-val="true" 
                               data-val-required="Vui lòng nhập số lượng tối thiểu."
                               data-val-min="Số lượng tối thiểu phải từ 1 trở lên."
                               data-val-min-min="1"
                               required
                               oninvalid="validateBaseUnit(this)"
                               oninput="this.setCustomValidity('')" />
                        <span asp-validation-for="BaseUnit" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Image (Gộp avatar + ảnh mô tả) -->
                <div class="mt-3">
                    <label class="form-label">Hình ảnh dịch vụ</label>
                    <div id="imageGalleryContainer" class="image-inline-gallery mb-2">
                        <!-- Preview images will be added here -->
                    </div>
                    <div class="file-input-wrapper">
                        <input name="Images" type="file" id="imageInput" class="form-control" accept="image/*" multiple />
                    </div>
                    <small class="form-text text-muted small">Ảnh đầu tiên làm ảnh đại diện. Giữ Ctrl/Shift để chọn nhiều ảnh.</small>
                    <span asp-validation-for="Images" class="text-danger small"></span>
                </div>


                <div class="d-flex justify-content-center gap-2 mt-4 pt-3 border-top">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        Hủy
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>
                        Tạo dịch vụ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Tag UI removed -->


@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script>
        // Override jQuery Validation messages to Vietnamese IMMEDIATELY after jQuery Validation loads
        // This MUST happen before unobtrusive validation is loaded
        if (typeof jQuery !== 'undefined' && jQuery.validator) {
            jQuery.extend(jQuery.validator.messages, {
                required: "Trường này là bắt buộc.",
                remote: "Vui lòng sửa trường này.",
                email: "Vui lòng nhập địa chỉ email hợp lệ.",
                url: "Vui lòng nhập URL hợp lệ.",
                date: "Vui lòng nhập ngày hợp lệ.",
                dateISO: "Vui lòng nhập ngày hợp lệ (ISO).",
                number: "Vui lòng nhập số hợp lệ.",
                digits: "Vui lòng chỉ nhập chữ số.",
                equalTo: "Vui lòng nhập cùng một giá trị.",
                maxlength: jQuery.validator.format("Vui lòng nhập không quá {0} ký tự."),
                minlength: jQuery.validator.format("Vui lòng nhập ít nhất {0} ký tự."),
                rangelength: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1} ký tự."),
                range: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1}."),
                max: jQuery.validator.format("Vui lòng nhập giá trị nhỏ hơn hoặc bằng {0}."),
                min: jQuery.validator.format("Vui lòng nhập giá trị lớn hơn hoặc bằng {0}."),
                step: jQuery.validator.format("Vui lòng nhập bội số của {0}.")
            });
        }
    </script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        // Override unobtrusive validation messages AFTER unobtrusive is loaded
        jQuery(document).ready(function($) {
            // Override default messages for specific fields using data attributes
            // This will override the messages that unobtrusive validation uses
            
            // Set custom messages using data-val-* attributes or by modifying the validator
            const form = $('#createServiceForm');
            if (form.length && form.data('validator')) {
                const validator = form.data('validator');
                if (validator && validator.settings) {
                    // Override messages in validator settings
                    if (!validator.settings.messages) {
                        validator.settings.messages = {};
                    }
                    
                    validator.settings.messages.Description = {
                        required: "Vui lòng nhập mô tả dịch vụ."
                    };
                    
                    validator.settings.messages.BaseUnit = {
                        required: "Vui lòng nhập số lượng tối thiểu.",
                        min: "Số lượng tối thiểu phải từ 1 trở lên."
                    };
                    
                    validator.settings.messages.Price = {
                        required: "Vui lòng nhập giá dịch vụ.",
                        min: "Giá phải lớn hơn hoặc bằng 0."
                    };
                    
                    validator.settings.messages.CategoryId = {
                        required: "Vui lòng chọn danh mục."
                    };
                    
                    validator.settings.messages.Title = {
                        required: "Tên dịch vụ không được để trống."
                    };
                    
                    validator.settings.messages.UnitType = {
                        required: "Đơn vị không được để trống."
                    };
                }
            }

            // Alternative: Modify the rules and messages after unobtrusive parses
            if ($.validator && $.validator.unobtrusive) {
                // Override the adapters to use Vietnamese messages
                const adapters = $.validator.unobtrusive.adapters;
                
                // Find all input elements and update their validation messages
                form.find('input, textarea, select').each(function() {
                    const $element = $(this);
                    const name = $element.attr('name');
                    
                    if (name) {
                        // Get existing rules
                        const rules = $element.rules();
                        if (rules) {
                            // Update messages based on field name
                            let customMessages = {};
                            
                            if (name === 'Description') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng nhập mô tả dịch vụ.";
                                }
                            } else if (name === 'BaseUnit') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng nhập số lượng tối thiểu.";
                                }
                                if (rules.min) {
                                    customMessages.min = "Số lượng tối thiểu phải từ 1 trở lên.";
                                }
                            } else if (name === 'Price') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng nhập giá dịch vụ.";
                                }
                                if (rules.min !== undefined) {
                                    customMessages.min = "Giá phải lớn hơn hoặc bằng 0.";
                                }
                            } else if (name === 'CategoryId') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng chọn danh mục.";
                                }
                            } else if (name === 'Title') {
                                if (rules.required) {
                                    customMessages.required = "Tên dịch vụ không được để trống.";
                                }
                            } else if (name === 'UnitType') {
                                if (rules.required) {
                                    customMessages.required = "Đơn vị không được để trống.";
                                }
                            }
                            
                            // Apply custom messages
                            if (Object.keys(customMessages).length > 0) {
                                $element.rules('add', {
                                    messages: customMessages
                                });
                            }
                        }
                    }
                });
            }
        });

        let currentCategoryId = null;

        // Additional validation override for BaseUnit to handle edge cases
        document.addEventListener('DOMContentLoaded', function() {
            const baseUnitField = document.getElementById('BaseUnit');
            if (baseUnitField) {
                // Enhanced validation for BaseUnit
                baseUnitField.addEventListener('change', function() {
                    const value = parseFloat(this.value);
                    if (this.value === '' || this.value === null || this.value === undefined) {
                        this.setCustomValidity('Vui lòng nhập số lượng tối thiểu.');
                    } else if (isNaN(value) || value < 1) {
                        this.setCustomValidity('Số lượng tối thiểu phải từ 1 trở lên.');
                    } else {
                        this.setCustomValidity('');
                    }
                });

                // Also validate on blur
                baseUnitField.addEventListener('blur', function() {
                    const value = parseFloat(this.value);
                    if (this.value === '' || this.value === null || this.value === undefined) {
                        this.setCustomValidity('Vui lòng nhập số lượng tối thiểu.');
                    } else if (isNaN(value) || value < 1) {
                        this.setCustomValidity('Số lượng tối thiểu phải từ 1 trở lên.');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }

            // Enhanced validation for Description
            const descriptionField = document.getElementById('Description');
            if (descriptionField) {
                descriptionField.addEventListener('blur', function() {
                    if (!this.value || !this.value.trim()) {
                        this.setCustomValidity('Vui lòng nhập mô tả dịch vụ.');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }
        });

        // Function to convert UnitType from English to Vietnamese
        function getUnitTypeVietnamese(unitType) {
            const unitMap = {
                'Hour': 'Giờ',
                'Day': 'Ngày',
                'Visit': 'Lần',
                'Apartment': 'Căn',
                'Room': 'Phòng',
                'SquareMeter': 'Mét vuông',
                'Person': 'Người',
                'Package': 'Gói',
                'Event': 'Sự kiện'
            };
            return unitMap[unitType] || unitType;
        }

        let availableTags = [];
        let selectedTag = null; // Chỉ lưu 1 tag đã chọn: {tagId, name}

        // Category selection handler
        document.getElementById('categorySelect').addEventListener('change', async function () {
            currentCategoryId = this.value;
            await loadTagsToDropdown();
            
            // Reset tag đã chọn khi đổi category
            if (selectedTag) {
                removeSelectedTag();
            }
        });

        // Load tags vào dropdown
        async function loadTagsToDropdown() {
            const tagSelect = document.getElementById('tagSelect');
            
            if (!currentCategoryId) {
                tagSelect.innerHTML = '<option value="">-- Chọn danh mục trước --</option>';
                tagSelect.disabled = true;
                return;
            }

            // Lấy providerId từ hidden input
            const providerIdInput = document.getElementById('currentProviderId');
            const providerId = providerIdInput ? providerIdInput.value : null;

            tagSelect.disabled = false;
            tagSelect.innerHTML = '<option value="">-- Đang tải tags... --</option>';

            try {
                // ✅ Đảm bảo API được gọi với categoryId (providerId sẽ được lấy từ session trong controller)
                const url = `/Provider/ServiceManagement/GetTagsByCategory?categoryId=${currentCategoryId}`;
                console.log(`[Create] Loading tags for categoryId=${currentCategoryId}, providerId from session`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const tags = await response.json();
                console.log(`[Create] Received ${tags?.length || 0} tags from API`);

                availableTags = tags || [];

                if (availableTags.length > 0) {
                    let html = '<option value="">-- Chọn tag --</option>';
                    availableTags.forEach(function (tag) {
                        // Hiển thị tất cả tags (vì chỉ chọn 1, không cần ẩn tag đã chọn)
                        html += `<option value="${tag.tagId}" data-tag-name="${tag.name}">${tag.name}</option>`;
                    });
                    tagSelect.innerHTML = html;
                    console.log(`[Create] Displayed ${availableTags.length} tags in dropdown`);
                } else {
                    tagSelect.innerHTML = '<option value="">-- Không có tags --</option>';
                    console.log(`[Create] No tags available for this category`);
                }
            } catch (error) {
                console.error('[Create] Error loading tags:', error);
                tagSelect.innerHTML = '<option value="">-- Lỗi khi tải tags --</option>';
            }
        }

        // Handle tag selection từ dropdown
        document.getElementById('tagSelect').addEventListener('change', async function() {
            const tagId = this.value;
            if (!tagId) {
                // Nếu chọn "-- Chọn tag --", xóa tag đã chọn
                if (selectedTag) {
                    removeSelectedTag();
                }
                return;
            }

            const selectedOption = this.options[this.selectedIndex];
            const tagName = selectedOption.getAttribute('data-tag-name');

            // Nếu đã có tag được chọn, xóa tag cũ trước
            if (selectedTag) {
                removeSelectedTag();
            }

            // Chọn tag mới
            await setSelectedTag(tagId, tagName);

            // Reset dropdown về "-- Chọn tag --"
            this.value = '';
        });

        // Handle remove tag button
        document.getElementById('removeSelectedTagBtn').addEventListener('click', function() {
            removeSelectedTag();
            document.getElementById('tagSelect').value = '';
        });

        // Set tag đã chọn
        async function setSelectedTag(tagId, tagName) {
            selectedTag = { tagId, name: tagName };

            // Hiển thị tag đã chọn trong khung input (giống category)
            const selectedTagDisplay = document.getElementById('selectedTagDisplay');
            const selectedTagName = document.getElementById('selectedTagName');
            const selectedTagIdInput = document.getElementById('selectedTagId');
            const tagSelect = document.getElementById('tagSelect');
            
            selectedTagName.value = tagName;
            selectedTagIdInput.value = tagId;
            selectedTagDisplay.classList.remove('d-none');
            tagSelect.classList.add('d-none');

            // Load options cho tag này
            const selectedOptionsContainer = document.getElementById('selectedOptionsContainer');
            await loadOptionsForTag(tagId, tagName, selectedOptionsContainer);

            // Hiển thị section options
            document.getElementById('selectedOptionsSection').style.display = 'block';

            // Cập nhật tên dịch vụ
            updateServiceTitleFromTags();
        }

        // Xóa tag đã chọn
        function removeSelectedTag() {
            if (!selectedTag) return;

            // Ẩn hiển thị tag đã chọn và hiển thị lại dropdown
            const selectedTagDisplay = document.getElementById('selectedTagDisplay');
            const selectedTagIdInput = document.getElementById('selectedTagId');
            const tagSelect = document.getElementById('tagSelect');
            
            selectedTagDisplay.classList.add('d-none');
            tagSelect.classList.remove('d-none');
            selectedTagIdInput.value = '';

            // Xóa tất cả options
            const selectedOptionsContainer = document.getElementById('selectedOptionsContainer');
            selectedOptionsContainer.innerHTML = '';

            // Ẩn section options
            document.getElementById('selectedOptionsSection').style.display = 'none';

            // Xóa tag khỏi biến
            selectedTag = null;

            // Cập nhật tên dịch vụ
            updateServiceTitleFromTags();
        }

        // Function to get Vietnamese label for option type
        function getTypeLabel(type) {
            const typeMap = {
                'checkbox': 'Chọn nhiều',
                'radio': 'Chọn một',
                'textarea': 'Nhập văn bản'
            };
            return typeMap[type?.toLowerCase()] || type || 'Chưa xác định';
        }

        // Routes để lấy options theo tag
        const optionsByTagUrl = '@Url.Action("GetOptions", "Category", new { area = "Admin" })';

        // Load options cho một tag (thêm vào container chung)
        async function loadOptionsForTag(tagId, tagName, optionsContainer) {
            // Xóa tất cả options cũ trước khi load mới
            optionsContainer.innerHTML = '';
            
            // Tạo loading indicator cho tag này
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-muted small mb-2';
            loadingDiv.id = `loading-${tagId}`;
            loadingDiv.dataset.tagId = tagId;
            loadingDiv.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>Đang tải tùy chọn cho "${tagName}"...`;
            optionsContainer.appendChild(loadingDiv);
            
            try {
                const res = await fetch(`${optionsByTagUrl}?tagId=${tagId}`);
                if (!res.ok) {
                    loadingDiv.innerHTML = `<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi tải tùy chọn cho "${tagName}".</div>`;
                    return;
                }

                const options = await res.json();
                
                // Xóa loading indicator
                loadingDiv.remove();
                
                if (!options || options.length === 0) {
                    const noOptionsDiv = document.createElement('div');
                    noOptionsDiv.className = 'text-muted small mb-2';
                    noOptionsDiv.dataset.tagId = tagId;
                    noOptionsDiv.innerHTML = `<i class="bi bi-inbox me-1"></i>Tag "${tagName}" chưa có tùy chọn nào.`;
                    optionsContainer.appendChild(noOptionsDiv);
                            return;
                        }
                        
                // Nhóm options theo Family
                const groupedOptions = {};
                const ungroupedOptions = [];

                options.forEach(o => {
                    if (o.family) {
                        if (!groupedOptions[o.family]) {
                            groupedOptions[o.family] = [];
                        }
                        groupedOptions[o.family].push(o);
                    } else {
                        ungroupedOptions.push(o);
                    }
                });

                // Sắp xếp các nhóm theo type (radio, checkbox)
                const groupOrder = ['radio', 'checkbox'];
                const sortedGroupIds = Object.keys(groupedOptions).sort((a, b) => {
                    const typeA = groupedOptions[a][0]?.type?.toLowerCase() || '';
                    const typeB = groupedOptions[b][0]?.type?.toLowerCase() || '';
                    const indexA = groupOrder.indexOf(typeA);
                    const indexB = groupOrder.indexOf(typeB);
                    if (indexA === -1 && indexB === -1) return 0;
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                // Render các nhóm (Family) - Sắp xếp theo thứ tự
                sortedGroupIds.forEach(familyId => {
                    const groupOptions = groupedOptions[familyId];
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'option-group mb-3';
                    groupDiv.dataset.tagId = tagId;
                    
                    // Kiểm tra type của nhóm
                    const groupType = groupOptions[0]?.type?.toLowerCase() || 'checkbox';
                    const typeLabel = getTypeLabel(groupType);
                    
                    // Màu sắc theo loại nhóm
                    let borderColor = '#ffc107'; // default (yellow)
                    let bgColor = '#fffbf0'; // default
                    let textColor = '#856404'; // default
                    let groupClass = 'option-group-yellow';
                    if (groupType === 'radio') {
                        borderColor = '#0d6efd'; // blue
                        bgColor = '#e7f3ff';
                        textColor = '#084298';
                        groupClass = 'option-group-radio';
                    } else if (groupType === 'checkbox') {
                        borderColor = '#6f42c1'; // purple
                        bgColor = '#f3e8ff';
                        textColor = '#5a189a';
                        groupClass = 'option-group-checkbox';
                    }
                    
                    // Thêm class để CSS có thể override cho dark mode
                    groupDiv.className = `option-group mb-3 ${groupClass}`;
                    groupDiv.style.cssText = `padding: 0.75rem; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 0.5rem;`;
                    
                    let groupHtml = `
                        <div class="group-header mb-2" style="font-weight: 600; color: ${textColor}; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-diagram-3" style="color: ${borderColor};"></i>
                            <span>Nhóm: ${typeLabel} (${groupOptions.length} tùy chọn)</span>
                            </div>`;
                    
                    const radioGroupName = `optionFamily_${tagId}_${familyId}`;
                    
                    groupOptions.forEach(o => {
                        const optionTypeLabel = getTypeLabel(o.type);
                        const uniqueId = `option_${tagId}_${o.optionId}`;
                        
                        if (groupType === 'radio') {
                            // Radio button - chỉ chọn 1 trong nhóm
                            groupHtml += `
                                <div class="mb-2 option-item-radio" style="padding-left: 1.5rem; border-left: 2px solid ${borderColor};">
                                    <input class="form-check-input form-check-input-sm" type="radio" name="${radioGroupName}" value="${o.optionId}" id="${uniqueId}" />
                                    <input type="hidden" name="OptionIds" value="${o.optionId}" disabled />
                                    <label class="form-check-label small" for="${uniqueId}">
                                        <span class="fw-semibold">${o.optionName}</span>
                                    </label>
                                </div>`;
                    } else {
                            // Checkbox - có thể chọn nhiều
                            groupHtml += `
                                <div class="mb-2 option-item-checkbox" style="padding-left: 1.5rem; border-left: 2px solid ${borderColor};">
                                    <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" />
                                    <label class="form-check-label small" for="${uniqueId}">
                                        <span class="fw-semibold">${o.optionName}</span>
                                    </label>
                                </div>`;
                        }
                    });
                    
                    groupDiv.innerHTML = groupHtml;
                    optionsContainer.appendChild(groupDiv);
                    
                    // Xử lý radio buttons - khi chọn radio, enable/disable hidden input
                    if (groupType === 'radio') {
                        groupDiv.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radio => {
                            radio.addEventListener('change', function() {
                                // Disable tất cả hidden inputs trong nhóm
                                groupDiv.querySelectorAll('input[type="hidden"][name="OptionIds"]').forEach(hidden => {
                                    hidden.disabled = true;
                                });
                                // Enable hidden input của radio được chọn
                                const hiddenInput = groupDiv.querySelector(`input[type="hidden"][value="${this.value}"]`);
                                if (hiddenInput) {
                                    hiddenInput.disabled = false;
                                }
                            });
                        });
                    }
                });

                // Render các options không có nhóm - hiển thị sau các nhóm
                if (ungroupedOptions.length > 0 && sortedGroupIds.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'mb-2 mt-3';
                    separator.style.cssText = 'border-top: 2px solid #dee2e6; padding-top: 0.75rem;';
                    separator.innerHTML = '<small class="text-muted"><i class="bi bi-three-dots me-1"></i>Options độc lập</small>';
                    optionsContainer.appendChild(separator);
                }
                
                ungroupedOptions.forEach(o => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mb-2';
                    optionDiv.dataset.tagId = tagId;
                    
                    const typeLabel = getTypeLabel(o.type);
                    const uniqueId = `option_${tagId}_${o.optionId}`;
                    const optionType = o.type?.toLowerCase() || 'checkbox';
                    
                    if (optionType === 'textarea') {
                        // Textarea - cho phép nhập văn bản nhiều dòng
                        // Cần checkbox để chọn option này, không tự động chọn
                        const textareaCheckboxId = `textarea_checkbox_${uniqueId}`;
                        optionDiv.innerHTML = `
                            <div class="mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input form-check-input-sm" type="checkbox" id="${textareaCheckboxId}" />
                                    <label class="form-check-label small fw-semibold" for="${textareaCheckboxId}">
                                        ${o.optionName}
                                    </label>
                </div>
                                <textarea class="form-control form-control-sm" id="${uniqueId}" name="OptionValues[${o.optionId}]" rows="2" placeholder="${o.optionName}..." disabled></textarea>
                                <input type="hidden" name="OptionIds" value="${o.optionId}" disabled />
                            </div>`;
            
                        // Xử lý checkbox: enable/disable textarea và hidden input
            setTimeout(() => {
                            const checkbox = document.getElementById(textareaCheckboxId);
                            const textarea = document.getElementById(uniqueId);
                            const hiddenInput = optionDiv.querySelector('input[type="hidden"][name="OptionIds"]');
                            
                            if (checkbox && textarea && hiddenInput) {
                                checkbox.addEventListener('change', function() {
                                    if (this.checked) {
                                        textarea.disabled = false;
                                        hiddenInput.disabled = false;
                                    } else {
                                        textarea.disabled = true;
                                        textarea.value = ''; // Xóa giá trị khi bỏ chọn
                                        hiddenInput.disabled = true;
                                    }
                                });
                            }
                        }, 100);
                    } else if (optionType === 'checkbox') {
                        // Checkbox - có thể chọn nhiều
                        optionDiv.innerHTML = `
                            <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" />
                            <label class="form-check-label small" for="${uniqueId}">
                                <span class="fw-semibold">${o.optionName}</span>
                            </label>`;
                    } else {
                        // Radio hoặc loại khác - xử lý như checkbox
                        optionDiv.innerHTML = `
                            <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" />
                            <label class="form-check-label small" for="${uniqueId}">
                                <span class="fw-semibold">${o.optionName}</span>
                            </label>`;
                    }
                    optionsContainer.appendChild(optionDiv);
                });
            } catch (error) {
                console.error('Error loading options:', error);
                loadingDiv.innerHTML = `<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi tải tùy chọn cho "${tagName}".</div>`;
            }
        }

        // Function để cập nhật tên dịch vụ từ tag đã chọn
        function updateServiceTitleFromTags() {
            const titleInput = document.getElementById('titleInput');
            if (!titleInput) return;

            if (selectedTag) {
                // Lấy tên của tag đã chọn
                titleInput.value = selectedTag.name;
            } else {
                // Nếu không có tag nào được chọn, để trống
                titleInput.value = '';
            }
        }

        // Image preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('imageInput');
            const galleryContainer = document.getElementById('imageGalleryContainer');
            let selectedFiles = [];

            if (imageInput && galleryContainer) {
                function addPreviewToGallery() {
                    selectedFiles.forEach((file, index) => {
                        if (!file.type.startsWith('image/')) {
                            return;
                        }

                        // Check if preview already exists
                        const existingPreview = galleryContainer.querySelector(`[data-preview-index="${index}"]`);
                        if (existingPreview) {
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageWrapper = document.createElement('div');
                            imageWrapper.className = 'removable-image';
                            imageWrapper.dataset.previewIndex = index;
                            imageWrapper.innerHTML = `
                                <img src="${e.target.result}" alt="Preview ${index + 1}" />
                                <button type="button" class="btn btn-sm btn-danger remove-image-btn remove-preview-btn" data-index="${index}" title="Xóa ảnh" aria-label="Xóa ảnh">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            `;
                            galleryContainer.appendChild(imageWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                imageInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    // Merge với files hiện có (nếu có)
                    selectedFiles = [...selectedFiles, ...newFiles];
                    addPreviewToGallery();
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                });

                // Remove preview image
                galleryContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-preview-btn');
                    if (!removeBtn) return;

                    const wrapper = removeBtn.closest('[data-preview-index]');
                    if (!wrapper) return;

                    const index = parseInt(removeBtn.dataset.index);
                    
                    wrapper.remove();
                    
                    // Remove file from array
                    selectedFiles.splice(index, 1);
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                    
                    // Re-render all previews with correct indices
                    galleryContainer.querySelectorAll('[data-preview-index]').forEach(el => el.remove());
                    addPreviewToGallery();
                });
            }
        });

    </script>
}


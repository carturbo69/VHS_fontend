@model VHS_frontend.Areas.Provider.Models.Service.ServiceProviderCreateDTO
@{
    ViewData["Title"] = "Tạo Dịch vụ mới";
    Layout = "~/Areas/Provider/Views/_ProviderLayout.cshtml";
    var categories = ViewBag.Categories as List<VHS_frontend.Areas.Provider.Models.Service.CategoryDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.CategoryDTO>();
    var options = ViewBag.Options as List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO> ?? new List<VHS_frontend.Areas.Provider.Models.Service.OptionDTO>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/service-management.css" asp-append-version="true" />
}

<div class="service-management-container">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 create-page-header">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    Tạo Dịch vụ mới
                </h4>
                <a asp-action="Index" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>
                    Quay lại
                </a>
            </div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Form Card -->
    <div class="card shadow-sm form-card">
        <div class="card-header form-card-header">
            <h6 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>
                Thông tin Dịch vụ
            </h6>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post" enctype="multipart/form-data" id="createServiceForm" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="ProviderId" />
                <input type="hidden" id="currentProviderId" value="@ViewBag.ProviderId" />

                <script>
                    // Validation functions - must be defined before form fields
                    // Hàm lấy giới hạn min/max dựa trên đơn vị (theo luật lao động)
                    function getUnitLimits(unitType) {
                        const limits = {
                            'Hour': { min: 1, max: 8, message: 'Giờ làm việc tối đa 8 giờ/ngày theo luật lao động.' },
                            'Day': { min: 1, max: 7, message: 'Số ngày tối đa 7 ngày/tuần theo luật lao động.' },
                            'Visit': { min: 1, max: 10, message: 'Số lần tối đa 10 lần.' },
                            'Apartment': { min: 1, max: 10, message: 'Số căn tối đa 10 căn.' },
                            'Room': { min: 1, max: 50, message: 'Số phòng tối đa 50 phòng.' },
                            'SquareMeter': { min: 1, max: 1000, message: 'Diện tích tối đa 1000 m².' },
                            'Person': { min: 1, max: 100, message: 'Số người tối đa 100 người.' },
                            'Package': { min: 1, max: 10, message: 'Số gói tối đa 10 gói.' },
                            'Event': { min: 1, max: 5, message: 'Số sự kiện tối đa 5 sự kiện.' }
                        };
                        return limits[unitType] || { min: 1, max: 100, message: 'Số lượng tối đa 100.' };
                    }

                    // Cập nhật min/max và placeholder cho BaseUnit khi đơn vị thay đổi
                    function updateBaseUnitLimits() {
                        const unitTypeSelect = document.getElementById('unitTypeSelect');
                        const baseUnitField = document.getElementById('BaseUnit');
                        const baseUnitError = document.getElementById('baseUnitError');
                        
                        if (!unitTypeSelect || !baseUnitField) return;
                        
                        const unitType = unitTypeSelect.value;
                        if (!unitType) {
                            baseUnitField.min = 1;
                            baseUnitField.max = 100;
                            baseUnitField.placeholder = '1';
                            baseUnitError.textContent = 'Vui lòng nhập số lượng tối thiểu (từ 1 trở lên).';
                            return;
                        }
                        
                        const limits = getUnitLimits(unitType);
                        baseUnitField.min = limits.min;
                        baseUnitField.max = limits.max;
                        baseUnitField.placeholder = limits.min.toString();
                        baseUnitError.textContent = `Số lượng phải từ ${limits.min} đến ${limits.max}. ${limits.message}`;
                        
                        // Validate lại giá trị hiện tại
                        if (baseUnitField.value) {
                            validateBaseUnitWithUnitType(baseUnitField);
                        }
                    }

                    // Validate BaseUnit với giới hạn theo đơn vị
                    function validateBaseUnitWithUnitType(field) {
                        const unitTypeSelect = document.getElementById('unitTypeSelect');
                        const baseUnitError = document.getElementById('baseUnitError');
                        
                        if (!unitTypeSelect || !unitTypeSelect.value) {
                            field.setCustomValidity('Vui lòng chọn đơn vị trước.');
                            return;
                        }
                        
                        const unitType = unitTypeSelect.value;
                        const limits = getUnitLimits(unitType);
                        const value = parseFloat(field.value);
                        
                        if (!field.value || field.value === '' || field.value === null || field.value === undefined) {
                            field.setCustomValidity('Vui lòng nhập số lượng tối thiểu.');
                            field.classList.add('is-invalid');
                            baseUnitError.textContent = 'Vui lòng nhập số lượng tối thiểu.';
                        } else if (isNaN(value)) {
                            field.setCustomValidity('Vui lòng nhập số hợp lệ.');
                            field.classList.add('is-invalid');
                            baseUnitError.textContent = 'Vui lòng nhập số hợp lệ.';
                        } else if (value < limits.min) {
                            field.setCustomValidity(`Số lượng tối thiểu phải từ ${limits.min} trở lên.`);
                            field.classList.add('is-invalid');
                            baseUnitError.textContent = `Số lượng tối thiểu phải từ ${limits.min} trở lên.`;
                        } else if (value > limits.max) {
                            field.setCustomValidity(limits.message);
                            field.classList.add('is-invalid');
                            baseUnitError.textContent = limits.message;
                        } else {
                            field.setCustomValidity('');
                            field.classList.remove('is-invalid');
                        }
                    }

                    function validateBaseUnit(field) {
                        validateBaseUnitWithUnitType(field);
                    }
                </script>

                <div class="row g-3">
                    <!-- Category Selection -->
                    <div class="col-md-6">
                        <label asp-for="CategoryId" class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <div class="form-input-wrapper">
                            <select asp-for="CategoryId" class="form-select" id="categorySelect" required>
                                <option value="">-- Chọn danh mục --</option>
                                @foreach (var category in categories)
                                {
                                    <option value="@category.CategoryId">@category.Name</option>
                                }
                            </select>
                            <div class="invalid-feedback">Vui lòng chọn danh mục.</div>
                        </div>
                    </div>

                    <!-- Tag Selection -->
                    <div class="col-md-6">
                        <label class="form-label">Tag <span class="text-danger">*</span></label>
                        <!-- Selected Tag Display (hiển thị trong khung giống category) -->
                        <div id="selectedTagDisplay" class="d-none">
                            <div class="input-group">
                                <input type="text" class="form-control" id="selectedTagName" readonly />
                                <button type="button" class="btn btn-outline-secondary" id="removeSelectedTagBtn" title="Xóa tag">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-input-wrapper">
                            <select class="form-select" id="tagSelect" required>
                                <option value="">-- Chọn danh mục trước --</option>
                            </select>
                            <div class="invalid-feedback">Vui lòng chọn tag.</div>
                        </div>
                        <small class="form-text text-muted small">Chọn tag để xem các tùy chọn</small>
                        <input type="hidden" name="TagIds" id="selectedTagId" />
                    </div>
                </div>

                <!-- Title - Hidden, tự động lấy từ tag -->
                <input type="hidden" asp-for="Title" id="titleInput" />

                <!-- Options Section (Options hiển thị ở dưới) -->
                <div class="mt-3" id="selectedOptionsSection" style="display: none;">
                    <label class="form-label fw-bold section-label">
                        <i class="bi bi-list-check me-2"></i>
                        Tùy chọn
                    </label>
                    <div id="selectedOptionsContainer" class="p-3 border rounded">
                        <!-- Tất cả options của các tags đã chọn sẽ hiển thị ở đây -->
                    </div>
                </div>

                <!-- Description -->
                <div class="mt-3">
                    <label asp-for="Description" class="form-label">Mô tả <span class="text-danger">*</span></label>
                    <div class="form-input-wrapper">
                        <textarea asp-for="Description" name="Description" id="Description" class="form-control" rows="5" placeholder="Ví dụ: Dịch vụ dọn dẹp nhà cửa chuyên nghiệp bao gồm:
- Quét dọn, lau chùi toàn bộ phòng khách, phòng ngủ, nhà bếp, nhà vệ sinh
- Thời gian: 2-3 giờ/ lần, có thể đặt lịch linh hoạt theo yêu cầu
- Địa điểm: Tại nhà khách hàng
- Cam kết: Đảm bảo sạch sẽ, gọn gàng, an toàn cho sức khỏe,..." 
                              data-val="true" 
                              data-val-required="Vui lòng nhập mô tả dịch vụ."
                              required
                              oninvalid="this.setCustomValidity('Vui lòng nhập mô tả dịch vụ.')"
                              oninput="this.setCustomValidity('')"></textarea>
                        <div class="invalid-feedback">Vui lòng nhập mô tả dịch vụ.</div>
                    </div>
                    <small class="form-text text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Gợi ý:</strong> Mô tả chi tiết về quy trình, thời gian, địa điểm, yêu cầu đặc biệt. Mô tả càng rõ ràng sẽ giúp khách hàng hiểu và tin tưởng dịch vụ của bạn hơn.
                    </small>
                </div>

                <div class="row g-3 mt-0">
                    <!-- Price -->
                    <div class="col-md-4">
                        <label asp-for="Price" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                        <div class="form-input-wrapper">
                            <input asp-for="Price" type="number" class="form-control" id="Price" min="20000" max="100000000" step="1000" placeholder="20000" required />
                            <div class="invalid-feedback">Giá phải từ 20.000 đến 100.000.000 VNĐ.</div>
                        </div>
                    </div>

                    <!-- Unit Type -->
                    <div class="col-md-4">
                        <label asp-for="UnitType" class="form-label">
                            <i class="bi bi-rulers me-1"></i>Đơn vị <span class="text-danger">*</span>
                        </label>
                        <div class="form-input-wrapper">
                            <select asp-for="UnitType" class="form-select" id="unitTypeSelect" required>
                                <option value="">-- Chọn đơn vị --</option>
                                <option value="Hour">Giờ</option>
                                <option value="Day">Ngày</option>
                                <option value="Visit">Lần</option>
                                <option value="Apartment">Căn</option>
                                <option value="Room">Phòng</option>
                                <option value="SquareMeter">Mét vuông (m²)</option>
                                <option value="Person">Người</option>
                                <option value="Package">Gói</option>
                                <option value="Event">Sự kiện</option>
                            </select>
                            <div class="invalid-feedback">Vui lòng chọn đơn vị.</div>
                        </div>
                    </div>

                    <!-- Base Unit -->
                    <div class="col-md-4">
                        <label asp-for="BaseUnit" class="form-label">
                            <i class="bi bi-123 me-1"></i>Số lượng tối thiểu <span class="text-danger">*</span>
                        </label>
                        <div class="form-input-wrapper">
                            <input asp-for="BaseUnit" name="BaseUnit" id="BaseUnit" type="number" class="form-control" min="1" max="100" step="1" placeholder="1" 
                                   data-val="true" 
                                   data-val-required="Vui lòng nhập số lượng tối thiểu."
                                   data-val-min="Số lượng tối thiểu phải từ 1 trở lên."
                                   data-val-min-min="1"
                                   required
                                   oninvalid="validateBaseUnit(this)"
                               oninput="validateBaseUnitWithUnitType(this); this.classList.remove('is-invalid');" />
                            <div class="invalid-feedback" id="baseUnitError">Vui lòng nhập số lượng tối thiểu (từ 1 trở lên).</div>
                        </div>
                    </div>
                </div>

                <!-- Image (Gộp avatar + ảnh mô tả) -->
                <div class="mt-3">
                    <label class="form-label">Hình ảnh dịch vụ <span class="text-danger">*</span></label>
                    <div id="imageGalleryContainer" class="image-inline-gallery mb-2">
                        <!-- Preview images will be added here -->
                    </div>
                    <div class="form-input-wrapper">
                        <input name="Images" type="file" id="imageInput" class="form-control" accept="image/*" multiple required />
                        <div class="invalid-feedback">Vui lòng chọn ít nhất 1 hình ảnh cho dịch vụ.</div>
                    </div>
                    <small class="form-text text-muted small">Ảnh đầu tiên làm ảnh đại diện. Giữ Ctrl/Shift để chọn nhiều ảnh.</small>
                </div>


                <div class="d-flex justify-content-center gap-2 mt-4 pt-3 border-top">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        Hủy
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>
                        Tạo dịch vụ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Tag UI removed -->


@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script>
        // Override jQuery Validation messages to Vietnamese IMMEDIATELY after jQuery Validation loads
        // This MUST happen before unobtrusive validation is loaded
        if (typeof jQuery !== 'undefined' && jQuery.validator) {
            jQuery.extend(jQuery.validator.messages, {
                required: "Trường này là bắt buộc.",
                remote: "Vui lòng sửa trường này.",
                email: "Vui lòng nhập địa chỉ email hợp lệ.",
                url: "Vui lòng nhập URL hợp lệ.",
                date: "Vui lòng nhập ngày hợp lệ.",
                dateISO: "Vui lòng nhập ngày hợp lệ (ISO).",
                number: "Vui lòng nhập số hợp lệ.",
                digits: "Vui lòng chỉ nhập chữ số.",
                equalTo: "Vui lòng nhập cùng một giá trị.",
                maxlength: jQuery.validator.format("Vui lòng nhập không quá {0} ký tự."),
                minlength: jQuery.validator.format("Vui lòng nhập ít nhất {0} ký tự."),
                rangelength: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1} ký tự."),
                range: jQuery.validator.format("Vui lòng nhập giá trị từ {0} đến {1}."),
                max: jQuery.validator.format("Vui lòng nhập giá trị nhỏ hơn hoặc bằng {0}."),
                min: jQuery.validator.format("Vui lòng nhập giá trị lớn hơn hoặc bằng {0}."),
                step: jQuery.validator.format("Vui lòng nhập bội số của {0}.")
            });
        }
    </script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        // Override unobtrusive validation messages AFTER unobtrusive is loaded
        jQuery(document).ready(function($) {
            // Override default messages for specific fields using data attributes
            // This will override the messages that unobtrusive validation uses
            
            // Set custom messages using data-val-* attributes or by modifying the validator
            const form = $('#createServiceForm');
            if (form.length && form.data('validator')) {
                const validator = form.data('validator');
                if (validator && validator.settings) {
                    // Override messages in validator settings
                    if (!validator.settings.messages) {
                        validator.settings.messages = {};
                    }
                    
                    validator.settings.messages.Description = {
                        required: "Vui lòng nhập mô tả dịch vụ."
                    };
                    
                    validator.settings.messages.BaseUnit = {
                        required: "Vui lòng nhập số lượng tối thiểu.",
                        min: "Số lượng tối thiểu phải từ 1 trở lên."
                    };
                    
                    validator.settings.messages.Price = {
                        required: "Vui lòng nhập giá dịch vụ.",
                        min: "Giá phải từ 20.000 đến 100.000.000 VNĐ.",
                        max: "Giá phải từ 20.000 đến 100.000.000 VNĐ."
                    };
                    
                    validator.settings.messages.CategoryId = {
                        required: "Vui lòng chọn danh mục."
                    };
                    
                    validator.settings.messages.Title = {
                        required: "Tên dịch vụ không được để trống."
                    };
                    
                    validator.settings.messages.UnitType = {
                        required: "Đơn vị không được để trống."
                    };
                }
            }

            // Alternative: Modify the rules and messages after unobtrusive parses
            if ($.validator && $.validator.unobtrusive) {
                // Override the adapters to use Vietnamese messages
                const adapters = $.validator.unobtrusive.adapters;
                
                // Find all input elements and update their validation messages
                form.find('input, textarea, select').each(function() {
                    const $element = $(this);
                    const name = $element.attr('name');
                    
                    if (name) {
                        // Get existing rules
                        const rules = $element.rules();
                        if (rules) {
                            // Update messages based on field name
                            let customMessages = {};
                            
                            if (name === 'Description') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng nhập mô tả dịch vụ.";
                                }
                            } else if (name === 'BaseUnit') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng nhập số lượng tối thiểu.";
                                }
                                if (rules.min) {
                                    customMessages.min = "Số lượng tối thiểu phải từ 1 trở lên.";
                                }
                            } else if (name === 'Price') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng nhập giá dịch vụ.";
                                }
                                if (rules.min !== undefined) {
                                    customMessages.min = "Giá phải từ 20.000 đến 100.000.000 VNĐ.";
                                }
                                if (rules.max !== undefined) {
                                    customMessages.max = "Giá phải từ 20.000 đến 100.000.000 VNĐ.";
                                }
                            } else if (name === 'CategoryId') {
                                if (rules.required) {
                                    customMessages.required = "Vui lòng chọn danh mục.";
                                }
                            } else if (name === 'Title') {
                                if (rules.required) {
                                    customMessages.required = "Tên dịch vụ không được để trống.";
                                }
                            } else if (name === 'UnitType') {
                                if (rules.required) {
                                    customMessages.required = "Đơn vị không được để trống.";
                                }
                            }
                            
                            // Apply custom messages
                            if (Object.keys(customMessages).length > 0) {
                                $element.rules('add', {
                                    messages: customMessages
                                });
                            }
                        }
                    }
                });
            }
        });

        let currentCategoryId = null;

        // Additional validation override for BaseUnit to handle edge cases
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced validation for Description
            const descriptionField = document.getElementById('Description');
            if (descriptionField) {
                descriptionField.addEventListener('blur', function() {
                    if (!this.value || !this.value.trim()) {
                        this.setCustomValidity('Vui lòng nhập mô tả dịch vụ.');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }

            // Enhanced validation for Price - từ 20,000 đến 100 triệu
            const priceField = document.getElementById('Price');
            if (priceField) {
                function validatePrice() {
                    const value = parseFloat(priceField.value);
                    if (!priceField.value || priceField.value.trim() === '') {
                        priceField.setCustomValidity('Vui lòng nhập giá dịch vụ.');
                        priceField.classList.add('is-invalid');
                    } else if (isNaN(value)) {
                        priceField.setCustomValidity('Giá phải là số hợp lệ.');
                        priceField.classList.add('is-invalid');
                    } else if (value < 20000) {
                        priceField.setCustomValidity('Giá phải từ 20.000 đến 100.000.000 VNĐ.');
                        priceField.classList.add('is-invalid');
                    } else if (value > 100000000) {
                        priceField.setCustomValidity('Giá phải từ 20.000 đến 100.000.000 VNĐ.');
                        priceField.classList.add('is-invalid');
                    } else {
                        priceField.setCustomValidity('');
                        priceField.classList.remove('is-invalid');
                    }
                }

                priceField.addEventListener('input', validatePrice);
                priceField.addEventListener('blur', validatePrice);
                priceField.addEventListener('change', validatePrice);
            }
        });

        // Function to convert UnitType from English to Vietnamese
        function getUnitTypeVietnamese(unitType) {
            const unitMap = {
                'Hour': 'Giờ',
                'Day': 'Ngày',
                'Visit': 'Lần',
                'Apartment': 'Căn',
                'Room': 'Phòng',
                'SquareMeter': 'Mét vuông',
                'Person': 'Người',
                'Package': 'Gói',
                'Event': 'Sự kiện'
            };
            return unitMap[unitType] || unitType;
        }

        let availableTags = [];
        let selectedTag = null; // Chỉ lưu 1 tag đã chọn: {tagId, name}

        // Category selection handler
        document.getElementById('categorySelect').addEventListener('change', async function () {
            currentCategoryId = this.value;
            await loadTagsToDropdown();
            
            // Reset tag đã chọn khi đổi category
            if (selectedTag) {
                removeSelectedTag();
            }
        });

        // Load tags vào dropdown
        async function loadTagsToDropdown() {
            const tagSelect = document.getElementById('tagSelect');
            
            if (!currentCategoryId) {
                tagSelect.innerHTML = '<option value="">-- Chọn danh mục trước --</option>';
                tagSelect.disabled = true;
                return;
            }

            // Lấy providerId từ hidden input
            const providerIdInput = document.getElementById('currentProviderId');
            const providerId = providerIdInput ? providerIdInput.value : null;

            tagSelect.disabled = false;
            tagSelect.innerHTML = '<option value="">-- Đang tải tags... --</option>';

            try {
                // ✅ Đảm bảo API được gọi với categoryId (providerId sẽ được lấy từ session trong controller)
                const url = `/Provider/ServiceManagement/GetTagsByCategory?categoryId=${currentCategoryId}`;
                console.log(`[Create] Loading tags for categoryId=${currentCategoryId}, providerId from session`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const tags = await response.json();
                console.log(`[Create] Received ${tags?.length || 0} tags from API`);

                availableTags = tags || [];

                if (availableTags.length > 0) {
                    let html = '<option value="">-- Chọn tag --</option>';
                    availableTags.forEach(function (tag) {
                        // Hiển thị tất cả tags (vì chỉ chọn 1, không cần ẩn tag đã chọn)
                        html += `<option value="${tag.tagId}" data-tag-name="${tag.name}">${tag.name}</option>`;
                    });
                    tagSelect.innerHTML = html;
                    console.log(`[Create] Displayed ${availableTags.length} tags in dropdown`);
                } else {
                    tagSelect.innerHTML = '<option value="">-- Không có tags --</option>';
                    console.log(`[Create] No tags available for this category`);
                }
            } catch (error) {
                console.error('[Create] Error loading tags:', error);
                tagSelect.innerHTML = '<option value="">-- Lỗi khi tải tags --</option>';
            }
        }

        // Handle tag selection từ dropdown
        document.getElementById('tagSelect').addEventListener('change', async function() {
            const tagId = this.value;
            if (!tagId) {
                // Nếu chọn "-- Chọn tag --", xóa tag đã chọn
                if (selectedTag) {
                    removeSelectedTag();
                }
                return;
            }

            const selectedOption = this.options[this.selectedIndex];
            const tagName = selectedOption.getAttribute('data-tag-name');

            // Nếu đã có tag được chọn, xóa tag cũ trước
            if (selectedTag) {
                removeSelectedTag();
            }

            // Chọn tag mới
            await setSelectedTag(tagId, tagName);

            // Reset dropdown về "-- Chọn tag --"
            this.value = '';
        });

        // Handle remove tag button
        document.getElementById('removeSelectedTagBtn').addEventListener('click', function() {
            removeSelectedTag();
            document.getElementById('tagSelect').value = '';
        });

        // Set tag đã chọn
        async function setSelectedTag(tagId, tagName) {
            selectedTag = { tagId, name: tagName };

            // Hiển thị tag đã chọn trong khung input (giống category)
            const selectedTagDisplay = document.getElementById('selectedTagDisplay');
            const selectedTagName = document.getElementById('selectedTagName');
            const selectedTagIdInput = document.getElementById('selectedTagId');
            const tagSelect = document.getElementById('tagSelect');
            
            selectedTagName.value = tagName;
            selectedTagIdInput.value = tagId;
            selectedTagDisplay.classList.remove('d-none');
            tagSelect.classList.add('d-none');

            // Clear validation error for tag
            tagSelect.classList.remove('is-invalid');

            // Load options cho tag này
            const selectedOptionsContainer = document.getElementById('selectedOptionsContainer');
            await loadOptionsForTag(tagId, tagName, selectedOptionsContainer);

            // Hiển thị section options
            document.getElementById('selectedOptionsSection').style.display = 'block';

            // Cập nhật tên dịch vụ
            updateServiceTitleFromTags();
        }

        // Xóa tag đã chọn
        function removeSelectedTag() {
            if (!selectedTag) return;

            // Ẩn hiển thị tag đã chọn và hiển thị lại dropdown
            const selectedTagDisplay = document.getElementById('selectedTagDisplay');
            const selectedTagIdInput = document.getElementById('selectedTagId');
            const tagSelect = document.getElementById('tagSelect');
            
            selectedTagDisplay.classList.add('d-none');
            tagSelect.classList.remove('d-none');
            selectedTagIdInput.value = '';

            // Xóa tất cả options
            const selectedOptionsContainer = document.getElementById('selectedOptionsContainer');
            selectedOptionsContainer.innerHTML = '';

            // Ẩn section options
            document.getElementById('selectedOptionsSection').style.display = 'none';

            // Xóa tag khỏi biến
            selectedTag = null;

            // Cập nhật tên dịch vụ
            updateServiceTitleFromTags();
        }

        // Function to get Vietnamese label for option type
        function getTypeLabel(type) {
            const typeMap = {
                'checkbox': 'Chọn nhiều',
                'radio': 'Chọn một',
                'textarea': 'Nhập văn bản'
            };
            return typeMap[type?.toLowerCase()] || type || 'Chưa xác định';
        }

        // Routes để lấy options theo tag
        const optionsByTagUrl = '@Url.Action("GetOptions", "Category", new { area = "Admin" })';

        // Load options cho một tag (thêm vào container chung)
        async function loadOptionsForTag(tagId, tagName, optionsContainer) {
            // Xóa tất cả options cũ trước khi load mới
            optionsContainer.innerHTML = '';
            
            // Tạo loading indicator cho tag này
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-muted small mb-2';
            loadingDiv.id = `loading-${tagId}`;
            loadingDiv.dataset.tagId = tagId;
            loadingDiv.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>Đang tải tùy chọn cho "${tagName}"...`;
            optionsContainer.appendChild(loadingDiv);
            
            try {
                const res = await fetch(`${optionsByTagUrl}?tagId=${tagId}`);
                if (!res.ok) {
                    loadingDiv.innerHTML = `<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi tải tùy chọn cho "${tagName}".</div>`;
                    return;
                }

                const options = await res.json();
                
                // Xóa loading indicator
                loadingDiv.remove();
                
                if (!options || options.length === 0) {
                    const noOptionsDiv = document.createElement('div');
                    noOptionsDiv.className = 'text-muted small mb-2';
                    noOptionsDiv.dataset.tagId = tagId;
                    noOptionsDiv.innerHTML = `<i class="bi bi-inbox me-1"></i>Tag "${tagName}" chưa có tùy chọn nào.`;
                    optionsContainer.appendChild(noOptionsDiv);
                            return;
                        }
                        
                // Nhóm options theo Family
                const groupedOptions = {};
                const ungroupedOptions = [];

                options.forEach(o => {
                    if (o.family) {
                        if (!groupedOptions[o.family]) {
                            groupedOptions[o.family] = [];
                        }
                        groupedOptions[o.family].push(o);
                    } else {
                        ungroupedOptions.push(o);
                    }
                });

                // Sắp xếp các nhóm theo type (radio, checkbox)
                const groupOrder = ['radio', 'checkbox'];
                const sortedGroupIds = Object.keys(groupedOptions).sort((a, b) => {
                    const typeA = groupedOptions[a][0]?.type?.toLowerCase() || '';
                    const typeB = groupedOptions[b][0]?.type?.toLowerCase() || '';
                    const indexA = groupOrder.indexOf(typeA);
                    const indexB = groupOrder.indexOf(typeB);
                    if (indexA === -1 && indexB === -1) return 0;
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                // Render các nhóm (Family) - Sắp xếp theo thứ tự
                sortedGroupIds.forEach(familyId => {
                    const groupOptions = groupedOptions[familyId];
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'option-group mb-3';
                    groupDiv.dataset.tagId = tagId;
                    
                    // Kiểm tra type của nhóm
                    const groupType = groupOptions[0]?.type?.toLowerCase() || 'checkbox';
                    const typeLabel = getTypeLabel(groupType);
                    
                    // Màu sắc theo loại nhóm
                    let borderColor = '#ffc107'; // default (yellow)
                    let bgColor = '#fffbf0'; // default
                    let textColor = '#856404'; // default
                    let groupClass = 'option-group-yellow';
                    if (groupType === 'radio') {
                        borderColor = '#0d6efd'; // blue
                        bgColor = '#e7f3ff';
                        textColor = '#084298';
                        groupClass = 'option-group-radio';
                    } else if (groupType === 'checkbox') {
                        borderColor = '#6f42c1'; // purple
                        bgColor = '#f3e8ff';
                        textColor = '#5a189a';
                        groupClass = 'option-group-checkbox';
                    }
                    
                    // Thêm class để CSS có thể override cho dark mode
                    groupDiv.className = `option-group mb-3 ${groupClass}`;
                    groupDiv.style.cssText = `padding: 0.75rem; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 0.5rem;`;
                    
                    let groupHtml = `
                        <div class="group-header mb-2" style="font-weight: 600; color: ${textColor}; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-diagram-3" style="color: ${borderColor};"></i>
                            <span>Nhóm: ${typeLabel} (${groupOptions.length} tùy chọn)</span>
                            </div>`;
                    
                    const radioGroupName = `optionFamily_${tagId}_${familyId}`;
                    
                    groupOptions.forEach(o => {
                        const optionTypeLabel = getTypeLabel(o.type);
                        const uniqueId = `option_${tagId}_${o.optionId}`;
                        
                        if (groupType === 'radio') {
                            // Radio button - chỉ chọn 1 trong nhóm
                            groupHtml += `
                                <div class="mb-2 option-item-radio" style="padding-left: 1.5rem; border-left: 2px solid ${borderColor};">
                                    <input class="form-check-input form-check-input-sm" type="radio" name="${radioGroupName}" value="${o.optionId}" id="${uniqueId}" />
                                    <input type="hidden" name="OptionIds" value="${o.optionId}" disabled />
                                    <label class="form-check-label small" for="${uniqueId}">
                                        <span class="fw-semibold">${o.optionName}</span>
                                    </label>
                                </div>`;
                    } else {
                            // Checkbox - có thể chọn nhiều
                            groupHtml += `
                                <div class="mb-2 option-item-checkbox" style="padding-left: 1.5rem; border-left: 2px solid ${borderColor};">
                                    <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" />
                                    <label class="form-check-label small" for="${uniqueId}">
                                        <span class="fw-semibold">${o.optionName}</span>
                                    </label>
                                </div>`;
                        }
                    });
                    
                    groupDiv.innerHTML = groupHtml;
                    optionsContainer.appendChild(groupDiv);
                    
                    // Xử lý radio buttons - khi chọn radio, enable/disable hidden input
                    if (groupType === 'radio') {
                        groupDiv.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`).forEach(radio => {
                            radio.addEventListener('change', function() {
                                // Disable tất cả hidden inputs trong nhóm
                                groupDiv.querySelectorAll('input[type="hidden"][name="OptionIds"]').forEach(hidden => {
                                    hidden.disabled = true;
                                });
                                // Enable hidden input của radio được chọn
                                const hiddenInput = groupDiv.querySelector(`input[type="hidden"][value="${this.value}"]`);
                                if (hiddenInput) {
                                    hiddenInput.disabled = false;
                                }
                            });
                        });
                    }
                });

                // Render các options không có nhóm - hiển thị sau các nhóm
                if (ungroupedOptions.length > 0 && sortedGroupIds.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'mb-2 mt-3';
                    separator.style.cssText = 'border-top: 2px solid #dee2e6; padding-top: 0.75rem;';
                    separator.innerHTML = '<small class="text-muted"><i class="bi bi-three-dots me-1"></i>Options độc lập</small>';
                    optionsContainer.appendChild(separator);
                }
                
                ungroupedOptions.forEach(o => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mb-2';
                    optionDiv.dataset.tagId = tagId;
                    
                    const typeLabel = getTypeLabel(o.type);
                    const uniqueId = `option_${tagId}_${o.optionId}`;
                    const optionType = o.type?.toLowerCase() || 'checkbox';
                    
                    if (optionType === 'textarea') {
                        // Textarea - cho phép nhập văn bản nhiều dòng
                        // Cần checkbox để chọn option này, không tự động chọn
                        const textareaCheckboxId = `textarea_checkbox_${uniqueId}`;
                        optionDiv.innerHTML = `
                            <div class="mb-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input form-check-input-sm" type="checkbox" id="${textareaCheckboxId}" />
                                    <label class="form-check-label small fw-semibold" for="${textareaCheckboxId}">
                                        ${o.optionName}
                                    </label>
                </div>
                                <textarea class="form-control form-control-sm" id="${uniqueId}" name="OptionValues[${o.optionId}]" rows="2" placeholder="${o.optionName}..." disabled></textarea>
                                <input type="hidden" name="OptionIds" value="${o.optionId}" disabled />
                            </div>`;
            
                        // Xử lý checkbox: enable/disable textarea và hidden input
            setTimeout(() => {
                            const checkbox = document.getElementById(textareaCheckboxId);
                            const textarea = document.getElementById(uniqueId);
                            const hiddenInput = optionDiv.querySelector('input[type="hidden"][name="OptionIds"]');
                            
                            if (checkbox && textarea && hiddenInput) {
                                checkbox.addEventListener('change', function() {
                                    if (this.checked) {
                                        textarea.disabled = false;
                                        hiddenInput.disabled = false;
                                    } else {
                                        textarea.disabled = true;
                                        textarea.value = ''; // Xóa giá trị khi bỏ chọn
                                        hiddenInput.disabled = true;
                                    }
                                });
                            }
                        }, 100);
                    } else if (optionType === 'checkbox') {
                        // Checkbox - có thể chọn nhiều
                        optionDiv.innerHTML = `
                            <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" />
                            <label class="form-check-label small" for="${uniqueId}">
                                <span class="fw-semibold">${o.optionName}</span>
                            </label>`;
                    } else {
                        // Radio hoặc loại khác - xử lý như checkbox
                        optionDiv.innerHTML = `
                            <input class="form-check-input form-check-input-sm" type="checkbox" name="OptionIds" value="${o.optionId}" id="${uniqueId}" />
                            <label class="form-check-label small" for="${uniqueId}">
                                <span class="fw-semibold">${o.optionName}</span>
                            </label>`;
                    }
                    optionsContainer.appendChild(optionDiv);
                });
            } catch (error) {
                console.error('Error loading options:', error);
                loadingDiv.innerHTML = `<div class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>Lỗi khi tải tùy chọn cho "${tagName}".</div>`;
            }
        }

        // Function để cập nhật tên dịch vụ từ tag đã chọn
        function updateServiceTitleFromTags() {
            const titleInput = document.getElementById('titleInput');
            if (!titleInput) return;

            if (selectedTag) {
                // Lấy tên của tag đã chọn
                titleInput.value = selectedTag.name;
            } else {
                // Nếu không có tag nào được chọn, để trống
                titleInput.value = '';
            }
        }

        // Image preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('imageInput');
            const galleryContainer = document.getElementById('imageGalleryContainer');
            let selectedFiles = [];

            if (imageInput && galleryContainer) {
                function addPreviewToGallery() {
                    selectedFiles.forEach((file, index) => {
                        if (!file.type.startsWith('image/')) {
                            return;
                        }

                        // Check if preview already exists
                        const existingPreview = galleryContainer.querySelector(`[data-preview-index="${index}"]`);
                        if (existingPreview) {
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageWrapper = document.createElement('div');
                            imageWrapper.className = 'removable-image';
                            imageWrapper.dataset.previewIndex = index;
                            imageWrapper.innerHTML = `
                                <img src="${e.target.result}" alt="Preview ${index + 1}" />
                                <button type="button" class="btn btn-sm btn-danger remove-image-btn remove-preview-btn" data-index="${index}" title="Xóa ảnh" aria-label="Xóa ảnh">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            `;
                            galleryContainer.appendChild(imageWrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                imageInput.addEventListener('change', function(e) {
                    const newFiles = Array.from(e.target.files);
                    // Merge với files hiện có (nếu có)
                    selectedFiles = [...selectedFiles, ...newFiles];
                    addPreviewToGallery();
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                    
                    // Clear error khi có ảnh
                    if (selectedFiles.length > 0) {
                        imageInput.classList.remove('is-invalid');
                    }
                });

                // Remove preview image
                galleryContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-preview-btn');
                    if (!removeBtn) return;

                    const wrapper = removeBtn.closest('[data-preview-index]');
                    if (!wrapper) return;

                    const index = parseInt(removeBtn.dataset.index);
                    
                    wrapper.remove();
                    
                    // Remove file from array
                    selectedFiles.splice(index, 1);
                    
                    // Update input files
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    imageInput.files = dt.files;
                    
                    // Re-render all previews with correct indices
                    galleryContainer.querySelectorAll('[data-preview-index]').forEach(el => el.remove());
                    addPreviewToGallery();
                    
                    // Validate lại sau khi xóa ảnh
                    if (selectedFiles.length === 0) {
                        imageInput.classList.add('is-invalid');
                    } else {
                        imageInput.classList.remove('is-invalid');
                    }
                });
            }
        });

        // Real-time validation - clear errors when user inputs
        document.addEventListener('DOMContentLoaded', function() {
            // Category validation
            const categorySelect = document.getElementById('categorySelect');
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    if (this.value) {
                        this.classList.remove('is-invalid');
                    }
                });
            }
            
            // Tag validation
            const tagSelect = document.getElementById('tagSelect');
            if (tagSelect) {
                tagSelect.addEventListener('change', function() {
                    const selectedTagId = document.getElementById('selectedTagId');
                    if (selectedTagId && selectedTagId.value) {
                        this.classList.remove('is-invalid');
                    }
                });
            }
            
            // Description validation
            const descriptionField = document.getElementById('Description');
            if (descriptionField) {
                descriptionField.addEventListener('input', function() {
                    if (this.value && this.value.trim()) {
                        this.classList.remove('is-invalid');
                    }
                });
            }
            
            // Price validation
            const priceField = document.getElementById('Price');
            if (priceField) {
                priceField.addEventListener('input', function() {
                    const price = parseFloat(this.value);
                    if (this.value && !isNaN(price) && price >= 20000 && price <= 100000000) {
                        this.classList.remove('is-invalid');
                    }
                });
            }
            
            // UnitType validation - cập nhật giới hạn BaseUnit khi đơn vị thay đổi
            const unitTypeSelect = document.getElementById('unitTypeSelect');
            if (unitTypeSelect) {
                unitTypeSelect.addEventListener('change', function() {
                    if (this.value) {
                        this.classList.remove('is-invalid');
                        // Cập nhật giới hạn cho BaseUnit
                        updateBaseUnitLimits();
                    }
                });
            }
            
            // BaseUnit validation với giới hạn theo đơn vị
            const baseUnitField = document.getElementById('BaseUnit');
            if (baseUnitField) {
                baseUnitField.addEventListener('input', function() {
                    validateBaseUnitWithUnitType(this);
                });
                
                baseUnitField.addEventListener('blur', function() {
                    validateBaseUnitWithUnitType(this);
                });
            }
            
            // Khởi tạo giới hạn khi trang load
            updateBaseUnitLimits();
        });

        // Form submit validation - đảm bảo tất cả trường đều được điền
        document.getElementById('createServiceForm').addEventListener('submit', function(e) {
            let isValid = true;
            
            // Clear all errors first
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Validate Category
            const categorySelect = document.getElementById('categorySelect');
            if (!categorySelect || !categorySelect.value) {
                if (categorySelect) categorySelect.classList.add('is-invalid');
                isValid = false;
            }
            
            // Validate Tag
            const selectedTagId = document.getElementById('selectedTagId');
            if (!selectedTagId || !selectedTagId.value) {
                const tagSelect = document.getElementById('tagSelect');
                if (tagSelect) {
                    tagSelect.classList.add('is-invalid');
                }
                isValid = false;
            }
            
            // Validate Description
            const descriptionField = document.getElementById('Description');
            if (!descriptionField || !descriptionField.value || !descriptionField.value.trim()) {
                if (descriptionField) descriptionField.classList.add('is-invalid');
                isValid = false;
            }
            
            // Validate Price
            const priceField = document.getElementById('Price');
            if (!priceField || !priceField.value) {
                if (priceField) priceField.classList.add('is-invalid');
                isValid = false;
            } else {
                const price = parseFloat(priceField.value);
                if (isNaN(price) || price < 20000 || price > 100000000) {
                    priceField.classList.add('is-invalid');
                    isValid = false;
                }
            }
            
            // Validate UnitType
            const unitTypeSelect = document.getElementById('unitTypeSelect');
            if (!unitTypeSelect || !unitTypeSelect.value) {
                if (unitTypeSelect) unitTypeSelect.classList.add('is-invalid');
                isValid = false;
            }
            
            // Validate BaseUnit với giới hạn theo đơn vị
            const baseUnitField = document.getElementById('BaseUnit');
            if (baseUnitField) {
                if (unitTypeSelect && unitTypeSelect.value) {
                    const unitType = unitTypeSelect.value;
                    const limits = getUnitLimits(unitType);
                    const value = parseFloat(baseUnitField.value);
                    
                    if (!baseUnitField.value || isNaN(value) || value < limits.min || value > limits.max) {
                        validateBaseUnitWithUnitType(baseUnitField);
                        isValid = false;
                    }
                } else if (!baseUnitField.value || parseFloat(baseUnitField.value) < 1) {
                    baseUnitField.classList.add('is-invalid');
                    isValid = false;
                }
            }
            
            // Validate Images
            const imageInput = document.getElementById('imageInput');
            const galleryContainer = document.getElementById('imageGalleryContainer');
            const hasImages = imageInput && imageInput.files && imageInput.files.length > 0;
            const hasPreviewImages = galleryContainer && galleryContainer.querySelectorAll('.removable-image').length > 0;
            
            if (!hasImages && !hasPreviewImages) {
                if (imageInput) imageInput.classList.add('is-invalid');
                isValid = false;
            }
            
            // Chỉ chặn submit nếu không hợp lệ
            if (!isValid) {
                e.preventDefault();
                e.stopPropagation();
                
                // Focus vào trường lỗi đầu tiên
                const firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    setTimeout(() => {
                        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        if (firstInvalid.focus) {
                            firstInvalid.focus();
                        }
                    }, 100);
                }
                
                return false;
            }
            
            // Nếu hợp lệ, cho phép form submit bình thường
            // Không cần làm gì thêm, form sẽ submit tự động
        });

    </script>
}


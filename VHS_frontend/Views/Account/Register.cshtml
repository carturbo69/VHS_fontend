@model VHS_frontend.Models.Account.RegisterDTO
@{
    ViewData["Title"] = "Đăng ký";
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
    // Khai báo biến để dùng trong cả HTML và Script
    var requestMethod = ViewContext.HttpContext.Request.Method;
    var otpEmailValue = Context.Session.GetString("PendingActivationEmail") ?? "";
    var otpEmailJs = otpEmailValue;
    if (!string.IsNullOrEmpty(otpEmailJs))
    {
        otpEmailJs = otpEmailJs.Replace("\\", "\\\\").Replace("'", "\\'").Replace("\"", "\\\"").Replace("\r", "").Replace("\n", "\\n");
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/auth-polish.css" />
    <link rel="stylesheet" href="~/css/otp-modal.css" asp-append-version="true" />
    <style>
        /* Đảm bảo validation messages hiển thị đúng font tiếng Việt */
        .text-danger,
        span[data-valmsg-for],
        span.field-validation-error,
        .validation-summary,
        .validation-summary-errors,
        [asp-validation-summary].text-danger,
        .field-error,
        .invalid-feedback {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Noto Sans Vietnamese", sans-serif !important;
            font-weight: 500 !important;
            line-height: 1.5 !important;
            unicode-bidi: embed;
            direction: ltr;
        }
    </style>
}

<section class="auth-wrap">
    <div class="container-xl">
        <div class="auth-grid">
            <!-- Panel trái -->
            <aside class="auth-side auth-side-register" aria-hidden="true">
                <div class="auth-side-inner">
                    <img src="~/images/vhs_logo.png" alt="VHS Logo" class="auth-logo" />
                    <h2 class="auth-heading">
                        Đăng ký ngay – nhận ưu đãi <span class="text-primary">độc quyền</span>
                    </h2>
                    <p class="auth-sub">
                         Chỉ vài bước đăng ký đơn giản, bạn đã có thể sử dụng đầy đủ dịch vụ của VHS 
                         để quản lý cuộc sống tiện nghi, hiện đại hơn mỗi ngày.
                    </p>
                    <ul class="auth-usp">
                         <li>Gợi ý dịch vụ thông minh phù hợp với nhu cầu và sở thích của bạn</li>
                         <li>Đặt dịch vụ nhanh chóng trong vài phút với thao tác đơn giản</li>
                         <li>Thanh toán an toàn & bảo mật tuyệt đối với nhiều phương thức linh hoạt</li>
                         <li>Nhận thông báo ưu đãi mới sớm nhất và độc quyền dành cho thành viên</li>
                    </ul>
                    <p class="auth-sub" style="margin-top: 24px;">
                         Tham gia cộng đồng <strong>hàng nghìn người dùng</strong> đang tin tưởng và hài lòng với VHS! 
                         Bắt đầu hành trình sống thông minh ngay hôm nay.
                    </p>
                </div>
            </aside>

            <!-- Panel phải -->
            <div class="auth-card" role="form">
                @if (TempData["ShowOTPModal"] != null && (bool)TempData["ShowOTPModal"] && !string.IsNullOrEmpty(otpEmailValue))
                {
                    <input type="hidden" id="hiddenOtpEmail" value="@otpEmailValue" />
                }
                <h1 class="auth-title">Đăng ký</h1>
                <p class="auth-desc">
                    Đã có tài khoản?
                    <a asp-controller="Account" asp-action="Login" class="link">Đăng nhập</a>
                </p>

                <form asp-controller="Account" asp-action="Register" method="post" class="form" novalidate data-reset-on-reload="true" onsubmit="this.setAttribute('data-submitted', 'true');">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="field">
                        <label class="label" for="Username">Tên đăng nhập</label>
                        <input asp-for="Username" class="input" placeholder="Chọn tên đăng nhập của bạn" autocomplete="username" id="Username" />
                        <span asp-validation-for="Username" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label class="label" for="Email">Địa chỉ Email</label>
                        <input asp-for="Email" class="input" type="email" placeholder="yourname@example.com" autocomplete="email" id="Email" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label class="label" for="Password">Mật khẩu</label>
                        <div class="input-pass">
                            <input asp-for="Password" class="input" type="password" id="Password" placeholder="Tối thiểu 6 ký tự" autocomplete="new-password" />
                            <button type="button" class="pass-toggle" aria-label="Hiện/ẩn mật khẩu" onclick="togglePass('Password', this)">
                                 <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                     <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                     <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>

                    <div class="field">
                        <label class="label" for="ConfirmPassword">Xác nhận mật khẩu</label>
                        <div class="input-pass">
                            <input asp-for="ConfirmPassword" class="input" type="password" id="ConfirmPassword" placeholder="Nhập lại mật khẩu" autocomplete="new-password" />
                            <button type="button" class="pass-toggle" aria-label="Hiện/ẩn mật khẩu" onclick="togglePass('ConfirmPassword', this)">
                                 <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                     <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                     <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>

                    <div class="form-row terms-row">
                        <label class="check">
                            <input id="agreeTermsReg" type="checkbox" required />
                            Tôi đồng ý với
                        </label>
                        <button type="button" id="btnTerms" class="link link-btn">Điều khoản</button>
                    </div>
                    <div id="termsError" class="text-danger" style="display: none; margin-top: 8px; font-size: 0.875rem; font-weight: 500; width: 100%;">
                        Vui lòng đồng ý với Điều khoản và Chính sách bảo mật để tiếp tục đăng ký.
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-full btn-glow">Tạo tài khoản</button>

                    <div class="or"><span>hoặc</span></div>

                    <div class="socials">
                        <div id="g_id_onload"
                            data-client_id="1011562344003-vjmoi74tpfbsetd8vo68202vm9l8rkrd.apps.googleusercontent.com"
                            data-callback="handleGoogleResponse" data-auto_prompt="false" data-ux_mode="popup">
                        </div>

                        <div style="display: flex; justify-content: center;">
                            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"
                                data-text="continue_with" data-shape="rectangular" data-logo_alignment="left">
                            </div>
                        </div>
                    </div>
                </form>

                <p class="terms">
                    Thông tin của bạn được bảo vệ theo
                    <button type="button" id="btnPrivacy" class="link link-btn">Chính sách bảo mật</button>.
                </p>

                <!-- Success message khi kích hoạt thành công -->
                <div id="activationSuccessMessage" style="display: none; margin-top: 20px; padding: 20px; border-radius: 12px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px solid #0284c7; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.15);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg style="width: 24px; height: 24px; fill: white;" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0; color: #0f172a; font-size: 18px; font-weight: 700;">Tài khoản đã được kích hoạt thành công!</h4>
                            <p style="margin: 0; color: #475569; font-size: 14px; line-height: 1.5; font-weight: 500;">
                                Bạn có thể đăng nhập ngay bây giờ để sử dụng dịch vụ của chúng tôi.
                            </p>
                            <a asp-controller="Account" asp-action="Login" style="display: inline-block; margin-top: 12px; padding: 10px 24px; background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(2, 132, 199, 0.3);">
                                Đăng nhập ngay →
                            </a>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</section>

<!-- Global Modals placed outside card to overlay viewport -->
<!-- Modal: Điều khoản -->
<div id="termsModal" class="modal-overlay" hidden>
    <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-head">
            <h3 class="modal-title">Chính sách và Điều khoản chung</h3>
            <button type="button" class="btn-close" aria-label="Đóng" onclick="closeModal('termsModal')">×</button>
        </div>
        <div class="modal-body">
            <h6>1. Giới thiệu</h6>
            <p>Chào mừng bạn đến với <strong>Viet Home Service (VHS)</strong> - Nền tảng kết nối dịch vụ gia đình uy tín và chuyên nghiệp. Bằng việc đăng ký và sử dụng tài khoản, bạn đồng ý tuân thủ đầy đủ các điều khoản và điều kiện được nêu trong tài liệu này. Vui lòng đọc kỹ trước khi tiếp tục.</p>
            
            <h6>2. Quyền và Nghĩa vụ của Người dùng</h6>
            <p>Khi sử dụng dịch vụ VHS, bạn có quyền và nghĩa vụ sau:</p>
            <ul>
                <li><strong>Cung cấp thông tin chính xác:</strong> Bạn cam kết cung cấp thông tin cá nhân chính xác, đầy đủ và cập nhật. Thông tin sai lệch có thể dẫn đến việc tạm ngưng hoặc chấm dứt tài khoản.</li>
                <li><strong>Bảo mật tài khoản:</strong> Bạn chịu trách nhiệm bảo mật thông tin đăng nhập, mật khẩu và mọi hoạt động diễn ra trên tài khoản của mình.</li>
                <li><strong>Tuân thủ pháp luật:</strong> Không sử dụng dịch vụ cho mục đích bất hợp pháp, không lạm dụng hệ thống, không vi phạm quyền sở hữu trí tuệ hoặc quyền riêng tư của người khác.</li>
                <li><strong>Sử dụng hợp lý:</strong> Không thực hiện các hành vi gây cản trở, phá hoại hoặc làm gián đoạn hoạt động của hệ thống.</li>
            </ul>
            
            <h6>3. Chính sách Hủy và Hoàn tiền</h6>
            <p>Chúng tôi cam kết minh bạch về chính sách hủy và hoàn tiền:</p>
            <ul>
                <li><strong>Hủy dịch vụ:</strong> Bạn có thể hủy đơn đặt dịch vụ trước khi nhà cung cấp bắt đầu thực hiện. Phí hủy (nếu có) sẽ được thông báo rõ ràng tại thời điểm đặt dịch vụ.</li>
                <li><strong>Hoàn tiền:</strong> Hoàn tiền 100% nếu hủy trong vòng 24 giờ sau khi đặt dịch vụ. Sau 24 giờ, hoàn tiền theo chính sách cụ thể của từng loại dịch vụ.</li>
                <li><strong>Trường hợp đặc biệt:</strong> Trong trường hợp dịch vụ không được thực hiện đúng cam kết, VHS sẽ hỗ trợ giải quyết và hoàn tiền phù hợp.</li>
            </ul>
            
            <h6>4. Phí dịch vụ và Thanh toán</h6>
            <ul>
                <li><strong>Minh bạch về giá:</strong> Tất cả các khoản phí dịch vụ, phí xử lý (nếu có) sẽ được hiển thị rõ ràng trước khi bạn xác nhận thanh toán.</li>
                <li><strong>Phương thức thanh toán:</strong> Chấp nhận thanh toán qua thẻ ngân hàng, ví điện tử, hoặc các phương thức khác được hỗ trợ trên nền tảng.</li>
                <li><strong>Bảo mật thanh toán:</strong> Tất cả giao dịch thanh toán được xử lý qua các cổng thanh toán bảo mật, tuân thủ các tiêu chuẩn quốc tế về bảo mật.</li>
            </ul>
            
            <h6>5. Chấm dứt tài khoản</h6>
            <p>VHS bảo lưu quyền tạm ngưng hoặc chấm dứt tài khoản của bạn trong các trường hợp sau:</p>
            <ul>
                <li>Vi phạm các điều khoản sử dụng hoặc có hành vi gian lận.</li>
                <li>Không cung cấp thông tin chính xác hoặc cố ý cung cấp thông tin sai lệch.</li>
                <li>Lạm dụng hệ thống, spam, hoặc gây ảnh hưởng đến trải nghiệm người dùng khác.</li>
                <li>Vi phạm pháp luật Việt Nam hoặc quy định của nền tảng.</li>
            </ul>
            
            <h6>6. Thay đổi Điều khoản</h6>
            <p>VHS có quyền cập nhật, thay đổi các điều khoản này khi cần thiết. Khi có thay đổi quan trọng, chúng tôi sẽ thông báo đến bạn qua email hoặc thông báo trên nền tảng <strong>tối thiểu 7 ngày</strong> trước khi thay đổi có hiệu lực. Việc tiếp tục sử dụng dịch vụ sau khi thay đổi có hiệu lực được xem là bạn đồng ý với các điều khoản mới.</p>
            
            <h6>7. Liên hệ và Giải quyết Tranh chấp</h6>
            <p>Nếu bạn có bất kỳ câu hỏi hoặc khiếu nại nào về các điều khoản này, vui lòng liên hệ với đội ngũ hỗ trợ của VHS qua email hoặc hotline. Mọi tranh chấp sẽ được giải quyết thông qua thương lượng, hòa giải. Nếu không thể giải quyết, sẽ được đưa ra Tòa án có thẩm quyền tại Việt Nam.</p>
        </div>
        <div class="modal-foot">
            <button type="button" class="btn" onclick="closeModal('termsModal')">Đã hiểu</button>
        </div>
    </div>
</div>

<!-- Modal: Xác thực OTP -->
<div id="otpModal" class="modal-overlay" hidden>
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width: 480px;">
        <div class="modal-head">
            <div style="text-align: center; margin-bottom: 8px;">
                <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px; fill: white;" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
            </div>
            <h3 class="modal-title" style="text-align: center; margin-bottom: 8px;">Xác thực tài khoản</h3>
            <button type="button" class="btn-close" aria-label="Đóng" onclick="closeModal('otpModal')">×</button>
        </div>
        <div class="modal-body" style="padding: 24px;">
            <p style="text-align: center; color: #475569; margin-bottom: 24px; line-height: 1.6; font-weight: 500;">
                Chúng tôi đã gửi mã OTP 6 số đến email của bạn.<br>
                <strong id="otpEmailDisplay" style="color: #0f172a;"></strong>
            </p>
            
            <div class="field" style="margin-bottom: 20px;">
                <label class="label" style="text-align: center; margin-bottom: 12px; font-weight: 600;">Nhập mã OTP</label>
                <div id="otpInputs" style="display: flex; gap: 8px; justify-content: center; margin-bottom: 8px;">
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                </div>
                <input type="hidden" id="otpCode" />
                <input type="hidden" id="otpEmail" />
                <span id="otpError" class="text-danger" style="display: none; text-align: center; font-size: 14px; margin-top: 8px;"></span>
                <div id="otpSuccess" class="text-success" style="display: none; text-align: center; font-size: 14px; margin-top: 8px;"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <p style="font-size: 14px; color: #475569; margin-bottom: 8px; font-weight: 500;">
                    Không nhận được mã?
                </p>
                <div id="otpTimer" style="font-size: 14px; color: #0284c7; font-weight: 600; margin-bottom: 12px;">
                    Mã OTP còn hiệu lực trong: <span id="otpCountdown" style="color: #0284c7;">02:00</span>
                </div>
                <button type="button" class="btn btn-ghost" onclick="resendOTP()" id="btnResendOTP" disabled style="font-size: 14px; opacity: 0.5;">
                    <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    <span id="btnResendText">Gửi lại mã OTP</span>
                </button>
            </div>
        </div>
        <div class="modal-foot" style="padding: 20px 24px; border-top: 1px solid #e9ecef; display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closeModal('otpModal')" style="flex: 0 0 auto;">Đóng</button>
            <button type="button" class="btn btn-primary" onclick="activateAccount()" id="btnActivate" disabled style="flex: 0 0 auto; min-width: 120px; opacity: 0.6;">
                <span id="btnActivateText">Kích hoạt</span>
                <span id="btnActivateLoader" style="display: none;">Đang xử lý...</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal: Chính sách bảo mật -->
<div id="privacyModal" class="modal-overlay" hidden>
    <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-head">
            <h3 class="modal-title">Chính sách bảo mật thông tin</h3>
            <button type="button" class="btn-close" aria-label="Đóng" onclick="closeModal('privacyModal')">×</button>
        </div>
        <div class="modal-body">
            <h6>1. Thu thập thông tin</h6>
            <p>VHS thu thập các loại thông tin sau để cung cấp và cải thiện dịch vụ:</p>
            <ul>
                <li><strong>Thông tin cá nhân:</strong> Họ tên, email, số điện thoại, địa chỉ, ngày sinh (nếu có).</li>
                <li><strong>Thông tin đăng nhập:</strong> Tên đăng nhập, mật khẩu (được mã hóa), và thông tin xác thực khác.</li>
                <li><strong>Thông tin giao dịch:</strong> Lịch sử đặt dịch vụ, thanh toán, đánh giá và phản hồi.</li>
                <li><strong>Thông tin kỹ thuật:</strong> Địa chỉ IP, loại trình duyệt, thiết bị sử dụng, và dữ liệu sử dụng nền tảng (cookies, logs).</li>
            </ul>
            
            <h6>2. Mục đích sử dụng thông tin</h6>
            <p>Chúng tôi sử dụng thông tin của bạn cho các mục đích:</p>
            <ul>
                <li>Cung cấp, duy trì và cải thiện dịch vụ VHS.</li>
                <li>Xử lý giao dịch, thanh toán và quản lý tài khoản của bạn.</li>
                <li>Gửi thông báo quan trọng về dịch vụ, cập nhật điều khoản, hoặc thay đổi chính sách.</li>
                <li>Cá nhân hóa trải nghiệm, gợi ý dịch vụ phù hợp với nhu cầu của bạn.</li>
                <li>Phòng chống gian lận, đảm bảo an ninh và an toàn của nền tảng.</li>
                <li>Tuân thủ các yêu cầu pháp lý và quy định hiện hành.</li>
            </ul>
            
            <h6>3. Lưu trữ và bảo vệ thông tin</h6>
            <p>Chúng tôi cam kết bảo vệ thông tin của bạn bằng các biện pháp:</p>
            <ul>
                <li><strong>Mã hóa dữ liệu:</strong> Sử dụng mã hóa SSL/TLS khi truyền dữ liệu và mã hóa dữ liệu nhạy cảm khi lưu trữ.</li>
                <li><strong>Kiểm soát truy cập:</strong> Chỉ nhân viên được ủy quyền mới có quyền truy cập thông tin, với quy trình xác thực nghiêm ngặt.</li>
                <li><strong>Bảo mật hạ tầng:</strong> Hệ thống được bảo vệ bởi tường lửa, hệ thống phát hiện xâm nhập, và các biện pháp bảo mật tiên tiến.</li>
                <li><strong>Giám sát và kiểm tra:</strong> Thường xuyên kiểm tra, cập nhật hệ thống bảo mật và ứng phó nhanh chóng với các mối đe dọa.</li>
                <li><strong>Thời gian lưu trữ:</strong> Thông tin được lưu trữ trong thời gian cần thiết để cung cấp dịch vụ hoặc theo yêu cầu pháp luật.</li>
            </ul>
            
            <h6>4. Chia sẻ thông tin với bên thứ ba</h6>
            <p>VHS chỉ chia sẻ thông tin của bạn trong các trường hợp sau:</p>
            <ul>
                <li><strong>Nhà cung cấp dịch vụ:</strong> Chia sẻ thông tin cần thiết (tên, số điện thoại, địa chỉ) với nhà cung cấp dịch vụ để họ có thể thực hiện công việc.</li>
                <li><strong>Đối tác thanh toán:</strong> Chia sẻ thông tin thanh toán với các đối tác xử lý thanh toán được ủy quyền, tuân thủ tiêu chuẩn PCI-DSS.</li>
                <li><strong>Yêu cầu pháp luật:</strong> Tiết lộ thông tin khi được yêu cầu bởi cơ quan nhà nước có thẩm quyền hoặc theo quy định pháp luật.</li>
                <li><strong>Bảo vệ quyền lợi:</strong> Chia sẻ khi cần thiết để bảo vệ quyền, tài sản hoặc an toàn của VHS, người dùng hoặc người khác.</li>
            </ul>
            <p><strong>Lưu ý:</strong> Chúng tôi không bán, cho thuê hoặc chia sẻ thông tin cá nhân của bạn cho bên thứ ba vì mục đích marketing mà không có sự đồng ý của bạn.</p>
            
            <h6>5. Quyền của bạn</h6>
            <p>Theo quy định pháp luật về bảo vệ dữ liệu cá nhân, bạn có các quyền sau:</p>
            <ul>
                <li><strong>Quyền truy cập:</strong> Yêu cầu xem thông tin cá nhân mà chúng tôi đang lưu trữ về bạn.</li>
                <li><strong>Quyền chỉnh sửa:</strong> Yêu cầu sửa đổi thông tin cá nhân không chính xác hoặc không đầy đủ.</li>
                <li><strong>Quyền xóa:</strong> Yêu cầu xóa thông tin cá nhân của bạn (trừ trường hợp pháp luật yêu cầu lưu trữ).</li>
                <li><strong>Quyền rút lại đồng ý:</strong> Rút lại sự đồng ý xử lý dữ liệu cá nhân bất cứ lúc nào.</li>
                <li><strong>Quyền phản đối:</strong> Phản đối việc xử lý dữ liệu cá nhân của bạn cho mục đích marketing.</li>
                <li><strong>Quyền khiếu nại:</strong> Khiếu nại với cơ quan có thẩm quyền nếu bạn cho rằng việc xử lý dữ liệu của bạn vi phạm quy định.</li>
            </ul>
            <p>Để thực hiện các quyền trên, vui lòng liên hệ với đội ngũ hỗ trợ của VHS qua email hoặc hotline.</p>
            
            <h6>6. Cookies và Công nghệ theo dõi</h6>
            <p>VHS sử dụng cookies và công nghệ tương tự để:</p>
            <ul>
                <li>Ghi nhớ tùy chọn của bạn và cải thiện trải nghiệm sử dụng.</li>
                <li>Phân tích cách bạn sử dụng nền tảng để tối ưu hóa dịch vụ.</li>
                <li>Cung cấp quảng cáo phù hợp (nếu có).</li>
            </ul>
            <p>Bạn có thể quản lý hoặc xóa cookies thông qua cài đặt trình duyệt của mình. Tuy nhiên, việc tắt cookies có thể ảnh hưởng đến một số chức năng của nền tảng.</p>
            
            <h6>7. Liên hệ về Bảo mật</h6>
            <p>Nếu bạn có bất kỳ câu hỏi, lo ngại hoặc yêu cầu nào liên quan đến chính sách bảo mật này hoặc cách chúng tôi xử lý thông tin cá nhân của bạn, vui lòng liên hệ:</p>
            <ul>
                <li><strong>Email:</strong> support@vhs.vn</li>
                <li><strong>Hotline:</strong> 1900-xxxx (thời gian hỗ trợ: 8:00 - 22:00 hàng ngày)</li>
            </ul>
            <p>Chúng tôi cam kết phản hồi mọi yêu cầu của bạn trong vòng <strong>7 ngày làm việc</strong>.</p>
            
            <p><em><strong>Cập nhật lần cuối:</strong> Chính sách này có thể được cập nhật định kỳ. Phiên bản mới nhất luôn được hiển thị trên nền tảng với ngày cập nhật rõ ràng.</em></p>
        </div>
        <div class="modal-foot">
            <button type="button" class="btn" onclick="closeModal('privacyModal')">Đã hiểu</button>
        </div>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Hàm xóa account chưa kích hoạt - định nghĩa sớm để dùng ở nhiều nơi
        async function deleteUnactivatedAccount(email) {
          // Nếu không có email, lấy từ sessionStorage
          let emailToDelete = email;
          if (!emailToDelete || !emailToDelete.trim()) {
            emailToDelete = sessionStorage.getItem('pendingActivationEmail');
          }
          
          if (!emailToDelete || !emailToDelete.trim()) {
            console.warn('[Delete Account] No email provided and not found in sessionStorage');
            return;
          }
          
          emailToDelete = emailToDelete.trim();
          console.log('[Delete Account] Attempting to delete account for email:', emailToDelete);
          
          try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
            const url = '@Url.Action("DeleteUnactivatedAccount", "Account")';
            
            console.log('[Delete Account] Calling API:', url);
            
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': token
              },
              body: JSON.stringify({ email: emailToDelete })
            });
            
            console.log('[Delete Account] Response status:', response.status);
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error('[Delete Account] API error:', response.status, errorText);
              return;
            }
            
            const result = await response.json();
            if (result?.success) {
              console.log('[Delete Account] ✅ Account deleted successfully:', emailToDelete);
              // Xóa email khỏi sessionStorage sau khi xóa thành công
              sessionStorage.removeItem('pendingActivationEmail');
            } else {
              console.warn('[Delete Account] ⚠️ Failed to delete:', result?.message || 'Unknown error');
            }
          } catch (error) {
            console.error('[Delete Account] ❌ Exception:', error);
          }
        }

        (function () {
            function navigationIsReload() {
                if (typeof performance === 'undefined') return false;
                if (typeof performance.getEntriesByType === 'function') {
                    const entries = performance.getEntriesByType('navigation');
                    if (entries && entries.length > 0) {
                        return entries[0].type === 'reload';
                    }
                }
                if (performance.navigation) {
                    return performance.navigation.type === 1;
                }
                return false;
            }

            function resetOtpModalState() {
                const otpModal = document.getElementById('otpModal');
                if (otpModal) {
                    // Lấy email từ sessionStorage (đã lưu khi mở modal)
                    const emailFromStorage = sessionStorage.getItem('pendingActivationEmail');
                    
                    if (emailFromStorage && emailFromStorage.trim()) {
                      console.log('[Reset OTP Modal] Found email in sessionStorage:', emailFromStorage);
                      deleteUnactivatedAccount(emailFromStorage);
                    } else {
                      // Fallback: lấy từ nhiều nguồn
                      let emailToDelete = null;
                      
                      // Ưu tiên lấy từ hiddenOtpEmail (từ server, không bị reset)
                      const hiddenEmail = document.getElementById('hiddenOtpEmail')?.value;
                      if (hiddenEmail && hiddenEmail.trim()) {
                        emailToDelete = hiddenEmail.trim();
                      } else {
                        // Fallback: lấy từ otpEmail input
                        const otpEmail = document.getElementById('otpEmail')?.value;
                        if (otpEmail && otpEmail.trim()) {
                          emailToDelete = otpEmail.trim();
                        } else {
                          // Fallback cuối: lấy từ otpEmailDisplay
                          const otpEmailDisplay = document.getElementById('otpEmailDisplay')?.textContent;
                          if (otpEmailDisplay && otpEmailDisplay.trim()) {
                            emailToDelete = otpEmailDisplay.trim();
                          }
                        }
                      }
                      
                      if (emailToDelete) {
                        console.log('[Reset OTP Modal] Deleting account for email (from fallback):', emailToDelete);
                        deleteUnactivatedAccount(emailToDelete);
                      }
                    }
                    
                    otpModal.classList.remove('show');
                    otpModal.setAttribute('hidden', '');
                }

                const otpDigits = document.querySelectorAll('#otpModal .otp-digit');
                otpDigits.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                    input.disabled = false;
                    input.style.opacity = '';
                    input.style.cursor = '';
                });

                const otpCode = document.getElementById('otpCode');
                if (otpCode) otpCode.value = '';

                const otpEmailEl = document.getElementById('otpEmail');
                if (otpEmailEl) otpEmailEl.value = '';

                const otpError = document.getElementById('otpError');
                if (otpError) {
                    otpError.textContent = '';
                    otpError.style.display = 'none';
                }

                const otpSuccess = document.getElementById('otpSuccess');
                if (otpSuccess) {
                    otpSuccess.innerHTML = '';
                    otpSuccess.style.display = 'none';
                }

                const otpInputsWrap = document.getElementById('otpInputs');
                if (otpInputsWrap) otpInputsWrap.style.display = '';

                const btnActivate = document.getElementById('btnActivate');
                if (btnActivate) {
                    btnActivate.disabled = true;
                    btnActivate.style.opacity = '0.6';
                    btnActivate.classList.remove('btn-primary');
                    btnActivate.style.display = '';
                }

                const btnResend = document.getElementById('btnResendOTP');
                if (btnResend) {
                    btnResend.disabled = true;
                    btnResend.style.opacity = '0.5';
                    btnResend.style.display = '';
                }

                const otpTimer = document.getElementById('otpTimer');
                if (otpTimer) {
                    otpTimer.innerHTML = 'Mã OTP còn hiệu lực trong: <span id="otpCountdown" style="color: #0284c7;">02:00</span>';
                }

                sessionStorage.removeItem('otpModalShown');
                document.body.style.overflow = '';
            }

            function clearValidationMessages(form) {
                const summary = form.querySelector('.validation-summary');
                if (summary) {
                    summary.innerHTML = '';
                    summary.style.display = 'none';
                    summary.classList.remove('validation-summary-errors');
                }

                form.querySelectorAll('[data-valmsg-for], .field-error').forEach(msg => {
                    msg.textContent = '';
                    if (msg.style) msg.style.display = 'none';
                    msg.classList.remove('field-validation-error', 'text-danger');
                });
            }

            function resetForms() {
                const forms = document.querySelectorAll('form[data-reset-on-reload="true"]');
                if (!forms.length) return;

                forms.forEach(form => {
                    form.reset();

                    form.querySelectorAll('input, textarea, select').forEach(field => {
                        if (field.type === 'hidden' || field.getAttribute('data-preserve') === 'true') {
                            return;
                        }

                        if (field.type === 'checkbox' || field.type === 'radio') {
                            field.checked = field.defaultChecked;
                        } else {
                            field.value = '';
                        }

                        field.classList.remove('is-invalid', 'is-valid');
                    });

                    clearValidationMessages(form);
                });

                // Ẩn thông báo lỗi terms khi reload
                const termsError = document.getElementById('termsError');
                if (termsError) {
                    termsError.style.display = 'none';
                }

                const authCard = document.querySelector('.auth-card');
                if (authCard) authCard.classList.remove('has-error');

                // Chỉ reset OTP modal nếu không có TempData ShowOTPModal
                // (Nếu có TempData, modal cần được hiển thị)
                const hasOtpModalToShow = document.getElementById('hiddenOtpEmail') !== null;
                if (!hasOtpModalToShow) {
                    resetOtpModalState();
                }
            }

            function handleResetIfNeeded() {
                // Kiểm tra xem có lỗi validation từ POST không
                const hasValidationErrors = document.querySelector('.validation-summary-errors')?.textContent.trim().length > 0 ||
                                           Array.from(document.querySelectorAll('.field span.text-danger:not(#otpError):not(#otpSuccess)')).some(el => el.textContent.trim().length > 0);
                
                // Kiểm tra xem có cần hiển thị OTP modal không
                const hasOtpModalToShow = document.getElementById('hiddenOtpEmail') !== null;
                
                // Nếu không có lỗi validation và không có OTP modal cần hiển thị, clear form
                // (Nếu có OTP modal, giữ lại form để user có thể nhập OTP)
                if (!hasValidationErrors && !hasOtpModalToShow) {
                    resetForms();
                } else if (!hasValidationErrors && hasOtpModalToShow) {
                    // Chỉ clear form fields, không reset OTP modal
                    const forms = document.querySelectorAll('form[data-reset-on-reload="true"]');
                    forms.forEach(form => {
                        form.reset();
                        form.querySelectorAll('input, textarea, select').forEach(field => {
                            if (field.type === 'hidden' || field.getAttribute('data-preserve') === 'true' || field.id === 'hiddenOtpEmail') {
                                return;
                            }
                            if (field.type === 'checkbox' || field.type === 'radio') {
                                field.checked = field.defaultChecked;
                            } else {
                                field.value = '';
                            }
                            field.classList.remove('is-invalid', 'is-valid');
                        });
                        clearValidationMessages(form);
                    });
                }
            }

            // Thay đổi URL thành GET request để tránh thông báo "Resubmit the form?" khi reload
            if (window.history && window.history.replaceState) {
                // Chỉ thay đổi nếu đang ở POST request (có thể detect bằng cách kiểm tra form data)
                const url = new URL(window.location.href);
                if (url.searchParams.has('submitted') || document.querySelector('form[method="post"]')?.hasAttribute('data-submitted')) {
                    url.searchParams.delete('submitted');
                    window.history.replaceState({}, '', url.toString());
                }
            }

            document.addEventListener('DOMContentLoaded', handleResetIfNeeded);
            
            // Clear form khi reload để tránh thông báo "Resubmit the form?"
            window.addEventListener('beforeunload', function() {
                // Đánh dấu form đã được submit để clear khi reload
                const form = document.querySelector('form[method="post"]');
                if (form) {
                    form.setAttribute('data-submitted', 'true');
                }
            });
            
            window.addEventListener('pageshow', function (event) {
                // Clear form khi back/forward hoặc reload từ cache
                if (event.persisted || event.type === 'pageshow') {
                    // Luôn clear form khi reload để tránh thông báo "Resubmit the form?"
                    const hasOtpModalToShow = document.getElementById('hiddenOtpEmail') !== null;
                    
                    if (!hasOtpModalToShow) {
                        // Clear form hoàn toàn nếu không có OTP modal
                        resetForms();
                    } else {
                        // Chỉ clear form fields, không reset OTP modal
                        const forms = document.querySelectorAll('form[data-reset-on-reload="true"]');
                        forms.forEach(form => {
                            form.reset();
                            form.removeAttribute('data-submitted');
                            form.querySelectorAll('input, textarea, select').forEach(field => {
                                if (field.type === 'hidden' || field.getAttribute('data-preserve') === 'true' || field.id === 'hiddenOtpEmail') {
                                    return;
                                }
                                if (field.type === 'checkbox' || field.type === 'radio') {
                                    field.checked = field.defaultChecked;
                                } else {
                                    field.value = '';
                                }
                                field.classList.remove('is-invalid', 'is-valid');
                            });
                            clearValidationMessages(form);
                        });
                    }
                    
                    // Thay đổi URL để tránh resubmit warning
                    if (window.history && window.history.replaceState) {
                        const url = new URL(window.location.href);
                        url.searchParams.delete('submitted');
                        window.history.replaceState({}, '', url.toString());
                    }
                }
            });
            
            // Clear form ngay khi page load nếu là GET request (reload)
            (function() {
                const isPostRequest = '@requestMethod' === 'POST';
                if (!isPostRequest) {
                    // Nếu là GET request, clear form ngay lập tức
                    setTimeout(function() {
                        const hasOtpModalToShow = document.getElementById('hiddenOtpEmail') !== null;
                        if (!hasOtpModalToShow) {
                            resetForms();
                        }
                    }, 100);
                }
            })();
        })();

        // Smooth page transition khi chuyển trang
        (function() {
            // Thêm fade out khi click vào link đăng ký/đăng nhập
            const authLinks = document.querySelectorAll('.link[href*="Register"], .link[href*="Login"]');
            authLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href && !href.startsWith('#')) {
                        e.preventDefault();
                        const authWrap = document.querySelector('.auth-wrap');
                        if (authWrap) {
                            authWrap.style.opacity = '0';
                            authWrap.style.transform = 'translateY(-10px)';
                            authWrap.style.transition = 'opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), transform 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                            
                            setTimeout(() => {
                                window.location.href = href;
                            }, 220);
                        } else {
                            window.location.href = href;
                        }
                    }
                });
            });
        })();

        (function () {
          // Kiểm tra method request từ server
          const isPostRequest = '@requestMethod' === 'POST';
          
          // Xử lý khi DOM sẵn sàng
          function handlePageLoad() {
            // Kiểm tra xem có validation errors thực sự không
            const validationSummary = document.querySelector('.validation-summary-errors');
            const hasSummaryErrors = validationSummary && validationSummary.textContent.trim().length > 0;
            
            // Kiểm tra field errors
            const fieldErrors = document.querySelectorAll('.field span.text-danger:not(#otpError):not(#otpSuccess)');
            let hasFieldErrors = false;
            fieldErrors.forEach(function(error) {
              if (error.textContent.trim().length > 0) {
                hasFieldErrors = true;
              }
            });
            
            const hasAnyErrors = hasSummaryErrors || hasFieldErrors;
            
            // Nếu là GET request (reload) hoặc không có lỗi thực sự, xóa validation messages
            if (!isPostRequest || !hasAnyErrors) {
              // Xóa validation summary
              if (validationSummary) {
                validationSummary.innerHTML = '';
                validationSummary.style.display = 'none';
              }
              
              // Xóa tất cả field validation messages
              fieldErrors.forEach(function(error) {
                error.textContent = '';
                error.style.display = 'none';
                error.className = error.className.replace('field-validation-error', '').replace('text-danger', '').trim();
              });
              
              // Xóa các validation messages khác
              const allValidationSpans = document.querySelectorAll('span[data-valmsg-for], span.field-validation-error');
              allValidationSpans.forEach(function(span) {
                if (span.id !== 'otpError' && span.id !== 'otpSuccess') {
                  span.textContent = '';
                  span.style.display = 'none';
                }
              });
              
              // Ẩn thông báo lỗi terms
              const termsError = document.getElementById('termsError');
              if (termsError) {
                termsError.style.display = 'none';
              }
              
              // Nếu là GET request (reload), clear form và validation messages
              if (!isPostRequest) {
                resetForms();
              }
            } else {
              // Có lỗi từ POST request - giữ lại và thêm animation
              if (hasSummaryErrors) {
                document.querySelector('.auth-card')?.classList.add('has-error');
                setTimeout(()=>document.querySelector('.auth-card')?.classList.remove('has-error'), 400);
              }
            }
            
            // Focus vào input đầu tiên nếu không có lỗi
            if (!hasAnyErrors) {
              const u = document.getElementById('Username');
              if (u) { 
                try { 
                  u.focus(); 
                } catch(_){} 
              }
            }
          }
          
          // Chạy khi DOM sẵn sàng
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', handlePageLoad);
          } else {
            handlePageLoad();
          }
        })();

        function togglePass(id, btn) {
          const input = document.getElementById(id);
          if (!input) return;
          const willShow = input.type === "password";
          input.type = willShow ? "text" : "password";
          btn.classList.toggle("on", willShow);
          const svg = btn.querySelector('svg');
          if (!svg) return;
          if (willShow) {
             svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
          } else {
             svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
          }
        }

        // Hiển thị modal OTP nếu có TempData
        @if (TempData["ShowOTPModal"] != null && (bool)TempData["ShowOTPModal"])
        {
            <text>
            console.log('[OTP Modal] TempData ShowOTPModal = true');
            
            // Lấy email từ hidden input (tránh lỗi Razor parser)
            const hiddenEmailInput = document.getElementById('hiddenOtpEmail');
            const pendingEmail = hiddenEmailInput ? hiddenEmailInput.value : '';
            console.log('[OTP Modal] Email from session:', pendingEmail || '(empty)');
            
            // Function để mở OTP modal
            function openOTPModal() {
              try {
                console.log('[OTP Modal] Attempting to open modal...');
                
                // Xóa sessionStorage cũ
                sessionStorage.removeItem('otpModalShown');
                
                const otpModal = document.getElementById('otpModal');
                const otpEmailInput = document.getElementById('otpEmail');
                const otpEmailDisplay = document.getElementById('otpEmailDisplay');
                
                if (!otpModal) {
                  console.error('[OTP Modal] Modal element #otpModal not found in DOM');
                  return false;
                }
                
                console.log('[OTP Modal] Modal element found');
                
                // Kiểm tra email
                if (!pendingEmail || pendingEmail.trim() === '') {
                  console.error('[OTP Modal] Email is empty, cannot show modal');
                  return false;
                }
                
                // Set email values
                if (otpEmailInput) {
                  otpEmailInput.value = pendingEmail;
                  console.log('[OTP Modal] Email input set:', pendingEmail);
                }
                if (otpEmailDisplay) {
                  otpEmailDisplay.textContent = pendingEmail;
                }
                
                // Lưu email vào sessionStorage để dùng khi xóa account
                sessionStorage.setItem('pendingActivationEmail', pendingEmail);
                console.log('[OTP Modal] Email saved to sessionStorage:', pendingEmail);
                
                // Mở modal bằng cách thủ công (không phụ thuộc vào hàm openModal)
                otpModal.removeAttribute('hidden');
                otpModal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('[OTP Modal] Modal opened manually');
                
                // Thêm event listeners cho modal (click outside, ESC key)
                function setupModalListeners() {
                  // Click outside để đóng modal
                  function handleBackgroundClick(e) {
                    if (e.target === otpModal) {
                      if (typeof closeModal === 'function') {
                        closeModal('otpModal');
                      } else {
                        otpModal.setAttribute('hidden', '');
                        otpModal.classList.remove('show');
                        document.body.style.overflow = '';
                      }
                    }
                  }
                  
                  // ESC key để đóng modal
                  function handleEscKey(e) {
                    if (e.key === 'Escape' && otpModal.classList.contains('show')) {
                      if (typeof closeModal === 'function') {
                        closeModal('otpModal');
                      } else {
                        otpModal.setAttribute('hidden', '');
                        otpModal.classList.remove('show');
                        document.body.style.overflow = '';
                      }
                    }
                  }
                  
                  otpModal.addEventListener('click', handleBackgroundClick);
                  document.addEventListener('keydown', handleEscKey);
                  
                  // Lưu handlers để có thể remove sau
                  otpModal._backgroundClickHandler = handleBackgroundClick;
                  otpModal._escKeyHandler = handleEscKey;
                }
                
                setupModalListeners();
                
                // Đợi một chút rồi bắt đầu timer và focus
                setTimeout(function() {
                  // Bắt đầu countdown timer
                  if (typeof startOTPTimer === 'function') {
                    startOTPTimer(120);
                  } else {
                    console.warn('[OTP Modal] startOTPTimer function not found');
                  }
                  
                  // Focus vào ô OTP đầu tiên
                  setTimeout(() => {
                    const firstOtpInput = document.querySelector('.otp-digit');
                    if (firstOtpInput) {
                      firstOtpInput.focus();
                    }
                  }, 300);
                }, 100);
                
                return true;
              } catch (error) {
                console.error('[OTP Modal] Error opening modal:', error);
                return false;
              }
            }
            
            // Thử mở modal khi DOM sẵn sàng
            function initOTPModal() {
              let attempts = 0;
              const maxAttempts = 50; // Tối đa 5 giây (50 * 100ms)
              
              function tryOpen() {
                attempts++;
                if (openOTPModal()) {
                  console.log('[OTP Modal] Modal opened successfully after', attempts, 'attempts');
                  return;
                }
                
                // Sử dụng cách so sánh khác để tránh lỗi Razor parser với ký tự <
                if (attempts >= maxAttempts) {
                  console.error('[OTP Modal] Failed to open modal after', maxAttempts, 'attempts');
                  return;
                }
                
                setTimeout(tryOpen, 100);
              }
              
              // Bắt đầu thử mở modal
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                  setTimeout(tryOpen, 100);
                });
              } else {
                // DOM đã sẵn sàng
                setTimeout(tryOpen, 100);
              }
            }
            
            // Khởi tạo
            initOTPModal();
            </text>
        } else {
            <text>
            console.log('[OTP Modal] TempData ShowOTPModal = false or null');
            </text>
        }

        // Wire buttons after DOM ready
        document.addEventListener('DOMContentLoaded', function(){
          try {
            document.getElementById('btnTerms')?.addEventListener('click', function(e){ e.preventDefault(); openModal('termsModal'); });
            document.getElementById('btnPrivacy')?.addEventListener('click', function(e){ e.preventDefault(); openModal('privacyModal'); });
            
            // Validate terms checkbox on submit
            const form = document.querySelector('form[method="post"]');
            const agree = document.getElementById('agreeTermsReg');
            const termsError = document.getElementById('termsError');
            form?.addEventListener('submit', function(e){
              if (!agree || !agree.checked) {
                e.preventDefault();
                // Hiển thị thông báo lỗi inline thay vì alert
                if (termsError) {
                  termsError.style.display = 'block';
                  // Scroll đến thông báo lỗi
                  termsError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                agree?.focus();
                return false;
              } else {
                // Ẩn thông báo lỗi nếu checkbox đã được chọn
                if (termsError) {
                  termsError.style.display = 'none';
                }
              }
              // Xóa sessionStorage khi submit form để đảm bảo modal có thể mở sau khi submit thành công
              sessionStorage.removeItem('otpModalShown');
            });
            
            // Ẩn thông báo lỗi khi user click vào checkbox
            agree?.addEventListener('change', function() {
              if (this.checked && termsError) {
                termsError.style.display = 'none';
              }
            });

            // Xử lý input OTP - tự động chuyển sang ô tiếp theo
            const otpInputs = document.querySelectorAll('.otp-digit');
            otpInputs.forEach((input, index) => {
              input.addEventListener('input', function(e) {
                const value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
                
                if (value && index < otpInputs.length - 1) {
                  otpInputs[index + 1].focus();
                }
                
                updateOTPCode();
              });
              
              input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                  otpInputs[index - 1].focus();
                }
              });
              
              input.addEventListener('paste', function(e) {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
                
                digits.split('').forEach((digit, i) => {
                  if (otpInputs[i]) {
                    otpInputs[i].value = digit;
                    otpInputs[i].classList.add('filled');
                  }
                });
                
                if (digits.length === 6) {
                  otpInputs[5].focus();
                } else if (digits.length > 0) {
                  otpInputs[digits.length].focus();
                }
                
                updateOTPCode();
              });
            });
            
            function updateOTPCode() {
              const code = Array.from(otpInputs).map(input => input.value).join('');
              document.getElementById('otpCode').value = code;
              
              // Update button state
              const btnActivate = document.getElementById('btnActivate');
              if (code.length === 6) {
                btnActivate.disabled = false;
                btnActivate.style.opacity = '1';
                btnActivate.classList.add('btn-primary');
                // Update filled state
                otpInputs.forEach(input => {
                  if (input.value) {
                    input.classList.add('filled');
                  }
                });
              } else {
                btnActivate.disabled = true;
                btnActivate.style.opacity = '0.6';
                btnActivate.classList.remove('btn-primary');
                otpInputs.forEach(input => {
                  if (!input.value) {
                    input.classList.remove('filled');
                  }
                });
              }
            }
            
            // Initialize button state
            updateOTPCode();
          } catch(_){}
        });

        async function activateAccount() {
          const email = document.getElementById('otpEmail').value;
          const otp = document.getElementById('otpCode').value.trim();
          const errorEl = document.getElementById('otpError');
          const successEl = document.getElementById('otpSuccess');
          const btnActivate = document.getElementById('btnActivate');
          const btnActivateText = document.getElementById('btnActivateText');
          const btnActivateLoader = document.getElementById('btnActivateLoader');
          
          if (!otp || otp.length !== 6) {
            errorEl.textContent = 'Vui lòng nhập đầy đủ mã OTP 6 số.';
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
            return;
          }

          errorEl.style.display = 'none';
          successEl.style.display = 'none';
          
          // Disable button và hiển thị loading
          btnActivate.disabled = true;
          btnActivateText.style.display = 'none';
          btnActivateLoader.style.display = 'inline';
          
          try {
            const response = await fetch('@Url.Action("ActivateAccount", "Account")', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
              },
              body: JSON.stringify({ email: email, otp: otp })
            });

            let result;
            try {
              result = await response.json();
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              errorEl.textContent = 'Lỗi xử lý phản hồi từ server.';
              errorEl.style.display = 'block';
              btnActivate.disabled = false;
              btnActivateText.style.display = 'inline';
              btnActivateLoader.style.display = 'none';
              return;
            }
            
            console.log('Activate account result:', result);
            console.log('Response status:', response.status);
            console.log('Result success:', result?.success);
            
            // Kiểm tra success - có thể là success hoặc Success
            const isSuccess = response.ok && result && (result.success === true || result.Success === true);
            
            if (isSuccess) {
              // Ẩn error message nếu có
              errorEl.style.display = 'none';
              
              // Xóa email khỏi sessionStorage vì đã kích hoạt thành công
              sessionStorage.removeItem('pendingActivationEmail');
              
              // Hiển thị success message trong modal với style rõ ràng
              successEl.innerHTML = '<div style="display: flex; align-items: center; gap: 8px; color: #0284c7; font-weight: 600;"><svg style="width: 20px; height: 20px; fill: #0284c7;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>Tài khoản đã được kích hoạt thành công!</div>';
              successEl.style.display = 'block';
              successEl.style.padding = '12px';
              successEl.style.background = '#e0f2fe';
              successEl.style.borderRadius = '8px';
              successEl.style.border = '1px solid #0284c7';
              
              // Ẩn OTP inputs và các button
              document.getElementById('otpInputs').style.display = 'none';
              document.getElementById('btnActivate').style.display = 'none';
              document.getElementById('btnResendOTP').style.display = 'none';
              
              // Re-enable button để hiển thị đúng (nếu cần)
              btnActivate.disabled = false;
              btnActivateText.style.display = 'inline';
              btnActivateLoader.style.display = 'none';
              
              // Hiển thị thông báo thành công 0.8 giây rồi chuyển trang ngay
              setTimeout(() => {
                closeModal('otpModal');
                sessionStorage.removeItem('otpModalShown');
                // Redirect đến trang login ngay lập tức
                window.location.href = '@Url.Action("Login", "Account")?activated=true';
              }, 800);
            } else {
              const parseMaybeJson = (value) => {
                if (!value || typeof value !== 'string') return null;
                try {
                  const parsed = JSON.parse(value);
                  return parsed && typeof parsed === 'object' ? parsed : null;
                } catch (_) {
                  return null;
                }
              };

              const extractMessage = (payload) => {
                if (!payload) return null;

                if (typeof payload === 'string') {
                  const parsed = parseMaybeJson(payload);
                  if (parsed) return extractMessage(parsed) ?? null;
                  return payload;
                }

                if (typeof payload === 'object') {
                  const rawMessage = payload.message ?? payload.Message ?? null;
                  if (typeof rawMessage === 'string') {
                    const nested = parseMaybeJson(rawMessage);
                    return nested ? extractMessage(nested) ?? null : rawMessage;
                  }

                  if (rawMessage) {
                    return extractMessage(rawMessage);
                  }
                }

                return null;
              };

              const message = extractMessage(result) || 'OTP không hợp lệ hoặc đã hết hạn.';

              errorEl.textContent = message;
              errorEl.style.display = 'block';
              
              // Xóa account chưa kích hoạt khi OTP sai
              // Lấy email từ nhiều nguồn để đảm bảo
              let emailToDelete = email;
              if (!emailToDelete || !emailToDelete.trim()) {
                const hiddenEmail = document.getElementById('hiddenOtpEmail')?.value;
                if (hiddenEmail && hiddenEmail.trim()) {
                  emailToDelete = hiddenEmail.trim();
                } else {
                  const otpEmailDisplay = document.getElementById('otpEmailDisplay')?.textContent;
                  if (otpEmailDisplay && otpEmailDisplay.trim()) {
                    emailToDelete = otpEmailDisplay.trim();
                  }
                }
              }
              
              if (emailToDelete && emailToDelete.trim()) {
                console.log('[OTP Wrong] Deleting account for email:', emailToDelete);
                deleteUnactivatedAccount(emailToDelete);
              }
              
              // Clear OTP inputs
              document.querySelectorAll('.otp-digit').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
              });
              document.getElementById('otpCode').value = '';
              document.querySelector('.otp-digit')?.focus();
              
              // Re-enable button
              btnActivate.disabled = false;
              btnActivateText.style.display = 'inline';
              btnActivateLoader.style.display = 'none';
            }
          } catch (error) {
            errorEl.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
            errorEl.style.display = 'block';
            console.error('Activate account error:', error);
            
            // Re-enable button
            btnActivate.disabled = false;
            btnActivateText.style.display = 'inline';
            btnActivateLoader.style.display = 'none';
          }
        }

        // Biến để lưu timer interval
        let otpTimerInterval = null;
        let otpTimeLeft = 0;

        function startOTPTimer(seconds) {
          otpTimeLeft = seconds;
          const countdownEl = document.getElementById('otpCountdown');
          const timerEl = document.getElementById('otpTimer');
          const btnResend = document.getElementById('btnResendOTP');
          const otpInputs = document.querySelectorAll('.otp-digit');
          
          // Clear timer cũ nếu có
          if (otpTimerInterval) {
            clearInterval(otpTimerInterval);
          }
          
          // Enable button ban đầu
          btnResend.disabled = true;
          btnResend.style.opacity = '0.5';
          
          // Update countdown ngay lập tức
          updateCountdownDisplay();
          
          // Start timer
          otpTimerInterval = setInterval(() => {
            otpTimeLeft--;
            updateCountdownDisplay();
            
            if (otpTimeLeft <= 0) {
              clearInterval(otpTimerInterval);
              otpTimerInterval = null;
              
              // Hết thời gian - disable inputs và enable resend button
              countdownEl.textContent = '00:00';
              timerEl.innerHTML = '<span style="color: #dc3545; font-weight: 600;">Mã OTP đã hết hạn. Vui lòng gửi lại mã mới.</span>';
              
              // Disable OTP inputs
              otpInputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.5';
                input.style.cursor = 'not-allowed';
              });
              
              // Enable resend button
              btnResend.disabled = false;
              btnResend.style.opacity = '1';
              
              // Xóa account chưa kích hoạt khi OTP hết hạn
              const emailFromStorage = sessionStorage.getItem('pendingActivationEmail');
              if (emailFromStorage && emailFromStorage.trim()) {
                console.log('[OTP Expired] Deleting account for email from sessionStorage:', emailFromStorage);
                deleteUnactivatedAccount(emailFromStorage);
              } else {
                // Fallback
                let emailToDelete = null;
                const hiddenEmail = document.getElementById('hiddenOtpEmail')?.value;
                if (hiddenEmail && hiddenEmail.trim()) {
                  emailToDelete = hiddenEmail.trim();
                } else {
                  const otpEmail = document.getElementById('otpEmail')?.value;
                  if (otpEmail && otpEmail.trim()) {
                    emailToDelete = otpEmail.trim();
                  }
                }
                if (emailToDelete) {
                  console.log('[OTP Expired] Deleting account for email (from fallback):', emailToDelete);
                  deleteUnactivatedAccount(emailToDelete);
                }
              }
            }
          }, 1000);
        }
        
        function updateCountdownDisplay() {
          const countdownEl = document.getElementById('otpCountdown');
          const minutes = Math.floor(otpTimeLeft / 60);
          const seconds = otpTimeLeft % 60;
          countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          
          // Đổi màu khi sắp hết thời gian (dưới 30 giây)
          if (otpTimeLeft <= 30) {
            countdownEl.style.color = '#dc3545';
          } else {
            countdownEl.style.color = '#0284c7';
          }
        }

        async function resendOTP() {
          const email = document.getElementById('otpEmail').value;
          const errorEl = document.getElementById('otpError');
          const successEl = document.getElementById('otpSuccess');
          const btnResend = document.getElementById('btnResendOTP');
          const btnResendText = document.getElementById('btnResendText');
          const timerEl = document.getElementById('otpTimer');
          const otpInputs = document.querySelectorAll('.otp-digit');
          
          if (!email) {
            errorEl.textContent = 'Email không hợp lệ.';
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
            return;
          }

          errorEl.style.display = 'none';
          successEl.style.display = 'none';
          
          // Disable button
          const originalText = btnResendText.textContent;
          btnResend.disabled = true;
          btnResend.style.opacity = '0.5';
          btnResendText.textContent = 'Đang gửi...';
          
          try {
            const response = await fetch('@Url.Action("ResendOTP", "Account")', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
              },
              body: JSON.stringify({ email: email })
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
              successEl.textContent = '✓ Mã OTP mới đã được gửi đến email của bạn.';
              successEl.style.display = 'block';
              
              // Clear OTP inputs
              otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
                input.disabled = false;
                input.style.opacity = '1';
                input.style.cursor = 'text';
              });
              document.getElementById('otpCode').value = '';
              document.querySelector('.otp-digit')?.focus();
              
              // Reset timer và UI
              timerEl.innerHTML = 'Mã OTP còn hiệu lực trong: <span id="otpCountdown" style="color: #0284c7;">02:00</span>';
              // Gọi startOTPTimer sau một chút để đảm bảo element đã được tạo lại
              setTimeout(() => {
                startOTPTimer(120); // Reset về 2 phút
              }, 50);
              
              // Re-enable button sau 2 giây
              setTimeout(() => {
                btnResend.disabled = true; // Vẫn disabled cho đến khi hết thời gian
                btnResend.style.opacity = '0.5';
                btnResendText.textContent = originalText;
              }, 2000);
            } else {
              errorEl.textContent = result.message || 'Không thể gửi lại OTP.';
              errorEl.style.display = 'block';
              
              btnResend.disabled = false;
              btnResend.style.opacity = '1';
              btnResendText.textContent = originalText;
            }
          } catch (error) {
            errorEl.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
            errorEl.style.display = 'block';
            console.error('Resend OTP error:', error);
            
            btnResend.disabled = false;
            btnResend.style.opacity = '1';
            btnResendText.textContent = originalText;
          }
        }

        function openModal(id){
          const el = document.getElementById(id);
          if (!el) return;
          try {
            el.removeAttribute('hidden');
            el.classList.add('show');
          } catch(err) { console.error('Open modal error', err); }
          document.body.style.overflow = 'hidden';
          el.addEventListener('click', function onBg(e){ if (e.target === el) { el.removeEventListener('click', onBg); closeModal(id); } });

          // Close on ESC
          el._escHandler = function(e){ if (e.key === 'Escape') { closeModal(id); } };
          document.addEventListener('keydown', el._escHandler);

          // Close when clicking any button or link inside modal-card (footer buttons, etc.)
          const card = el.querySelector('.modal-card');
          if (card) {
            el._insideClickHandler = function(e){
              if (e.target.closest('.modal-foot .btn') || e.target.closest('.btn-close') || e.target.closest('a')) {
                e.preventDefault();
                closeModal(id);
              }
            };
            card.addEventListener('click', el._insideClickHandler);
          }
        }

        function closeModal(id){
          const el = document.getElementById(id);
          if (!el) return;
          
          // Nếu đóng OTP modal, xóa account chưa kích hoạt và clear timer
          if (id === 'otpModal') {
            // Lấy email từ sessionStorage (đã lưu khi mở modal)
            const emailFromStorage = sessionStorage.getItem('pendingActivationEmail');
            
            if (emailFromStorage && emailFromStorage.trim()) {
              console.log('[Close Modal] Found email in sessionStorage:', emailFromStorage);
              deleteUnactivatedAccount(emailFromStorage);
            } else {
              // Fallback: lấy từ nhiều nguồn
              let emailToDelete = null;
              
              // Ưu tiên lấy từ hiddenOtpEmail (từ server, không bị reset)
              const hiddenEmail = document.getElementById('hiddenOtpEmail')?.value;
              if (hiddenEmail && hiddenEmail.trim()) {
                emailToDelete = hiddenEmail.trim();
              } else {
                // Fallback: lấy từ otpEmail input
                const otpEmail = document.getElementById('otpEmail')?.value;
                if (otpEmail && otpEmail.trim()) {
                  emailToDelete = otpEmail.trim();
                } else {
                  // Fallback cuối: lấy từ otpEmailDisplay
                  const otpEmailDisplay = document.getElementById('otpEmailDisplay')?.textContent;
                  if (otpEmailDisplay && otpEmailDisplay.trim()) {
                    emailToDelete = otpEmailDisplay.trim();
                  }
                }
              }
              
              if (emailToDelete) {
                console.log('[Close Modal] Deleting account for email (from fallback):', emailToDelete);
                deleteUnactivatedAccount(emailToDelete);
              } else {
                console.warn('[Close Modal] No email found to delete account');
              }
            }
            
            if (otpTimerInterval) {
              clearInterval(otpTimerInterval);
              otpTimerInterval = null;
            }
            
            // Xóa session storage
            sessionStorage.removeItem('otpModalShown');
          }
          
          try { el.classList.remove('show'); } catch(_){}
          document.body.style.overflow = '';
          // wait for transition end then hide
          setTimeout(()=>{ try { el.setAttribute('hidden',''); } catch(_){} }, 180);

          // Cleanup listeners
          if (el._escHandler) { document.removeEventListener('keydown', el._escHandler); el._escHandler = null; }
          const card = el.querySelector('.modal-card');
          if (card && el._insideClickHandler) { card.removeEventListener('click', el._insideClickHandler); el._insideClickHandler = null; }
        }
    </script>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        function handleGoogleResponse(response) {
            console.log("Google token received:", response.credential ? "Token exists" : "Token is null");
            
            if (!response.credential) {
                alert("Không nhận được token từ Google. Vui lòng thử lại.");
                return;
            }

            fetch('/Account/GoogleLogin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: response.credential })
            })
                .then(async res => {
                    console.log("Response status:", res.status);
                    const contentType = res.headers.get("content-type");
                    
                    if (!contentType || !contentType.includes("application/json")) {
                        const text = await res.text();
                        console.error("Non-JSON response:", text);
                        throw new Error("Phản hồi từ server không hợp lệ");
                    }
                    
                    return res.json();
                })
                .then(data => {
                    console.log("Response data:", data);
                    if (data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        alert(data.message || "Đăng nhập Google thất bại");
                    }
                })
                .catch(err => {
                    console.error("Google login error:", err);
                    alert("Có lỗi khi đăng nhập Google: " + (err.message || "Vui lòng thử lại sau"));
                });
        }
    </script>
}

@model VHS_frontend.Models.Account.ForgotPasswordDTO
@{
    ViewData["Title"] = "Quên mật khẩu";
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/auth-polish.css" />
    <link rel="stylesheet" href="~/css/otp-modal.css" asp-append-version="true" />
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #otpModal .modal-card {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        #otpModal.show .modal-card {
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
}

<section class="auth-wrap">
    <div class="container-xl">
        <div class="auth-grid">
            <!-- Panel trái -->
            <aside class="auth-side auth-side-forgot" aria-hidden="true">
                <div class="auth-side-inner">
                    <img src="~/images/vhs_logo.png" alt="VHS Logo" class="auth-logo" />
                    <h2 class="auth-heading">
                        Quên mật khẩu? <span class="text-primary">Không sao cả!</span>
                    </h2>
                    <p class="auth-sub">
                        Đừng lo lắng! Chỉ cần nhập email đã đăng ký, chúng tôi sẽ gửi mã OTP 6 số để xác thực và đặt lại mật khẩu ngay cho bạn qua email.
                    </p>
                    <ul class="auth-usp">
                        <li>Nhanh chóng, chỉ mất vài giây</li>
                        <li>Mã OTP 6 số dễ nhập</li>
                        <li>An toàn và bảo mật tuyệt đối</li>
                    </ul>
                    <div class="auth-info-box">
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="flex-shrink: 0; margin-right: 8px;">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        <p class="auth-sub" style="margin: 0;">
                            Mã OTP sẽ <strong>hết hạn sau 2 phút</strong>. Vui lòng nhập mã ngay sau khi nhận được.
                        </p>
                    </div>
                </div>
            </aside>

            <!-- Panel phải -->
            <div class="auth-card" role="form">
                <div class="auth-card-header">
                    <h1 class="auth-title">Khôi phục mật khẩu</h1>
                    <p class="auth-desc">Nhập địa chỉ email của bạn để nhận mã OTP xác thực</p>
                </div>

                <form asp-controller="Account" asp-action="ForgotPassword" method="post" class="form" novalidate>
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="text-danger validation-summary"></div>

                    <div class="field">
                        <label class="label" for="Email">
                            <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 8px; opacity: 0.7;">
                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.47L8 9.606l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                            </svg>
                            Địa chỉ Email
                        </label>
                        <input asp-for="Email" class="input" type="email" placeholder="yourname@example.com" autocomplete="email" id="Email" />
                        <span asp-validation-for="Email" class="text-danger field-error"></span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-full btn-glow">
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 8px;">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm-1.138-1.138L13.424 1.86l-4.338-2.761L5.498 8.932Z"/>
                        </svg>
                        Gửi mã OTP
                    </button>

                    <p class="terms" style="margin-top: 20px; text-align: center;">
                        Nhớ lại mật khẩu?
                        <a asp-controller="Account" asp-action="Login" class="link">Quay lại đăng nhập</a>
                    </p>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Modal: Xác thực OTP -->
<div id="otpModal" class="modal-overlay" hidden>
    <div class="modal-card" role="dialog" aria-modal="true" style="max-width: 480px;">
        <div class="modal-head">
            <div style="text-align: center; margin-bottom: 8px;">
                <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px; fill: white;" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
            </div>
            <h3 class="modal-title" style="text-align: center; margin-bottom: 8px;">Xác thực OTP</h3>
            <button type="button" class="btn-close" aria-label="Đóng" onclick="closeModal('otpModal')">×</button>
        </div>
        <div class="modal-body" style="padding: 24px;">
            <p style="text-align: center; color: #666; margin-bottom: 24px; line-height: 1.6;">
                Chúng tôi đã gửi mã OTP 6 số đến email của bạn.<br>
                <strong id="otpEmailDisplay" style="color: #333;"></strong>
            </p>
            
            <div class="field" style="margin-bottom: 20px;">
                <label class="label" style="text-align: center; margin-bottom: 12px; font-weight: 600;">Nhập mã OTP</label>
                <div id="otpInputs" style="display: flex; gap: 8px; justify-content: center; margin-bottom: 8px;">
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                    <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off" />
                </div>
                <input type="hidden" id="otpCode" />
                <input type="hidden" id="otpEmail" />
                <span id="otpError" class="text-danger" style="display: none; text-align: center; font-size: 14px; margin-top: 8px;"></span>
                <div id="otpSuccess" class="text-success" style="display: none; text-align: center; font-size: 14px; margin-top: 8px;"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <p style="font-size: 14px; color: #666; margin-bottom: 8px;">
                    Không nhận được mã?
                </p>
                <div id="otpTimer" style="font-size: 14px; color: #0284c7; font-weight: 600; margin-bottom: 12px;">
                    Mã OTP còn hiệu lực trong: <span id="otpCountdown" style="color: #0ea5e9;">02:00</span>
                </div>
                <button type="button" class="btn btn-ghost" onclick="resendOTP()" id="btnResendOTP" disabled style="font-size: 14px; opacity: 0.5;">
                    <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    <span id="btnResendText">Gửi lại mã OTP</span>
                </button>
            </div>
        </div>
        <div class="modal-foot" style="padding: 20px 24px; border-top: 1px solid #e9ecef; display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closeModal('otpModal')" style="flex: 0 0 auto;">Đóng</button>
            <button type="button" class="btn btn-primary" onclick="verifyForgotPasswordOTP()" id="btnVerify" disabled style="flex: 0 0 auto; min-width: 120px; opacity: 0.6;">
                <span id="btnVerifyText">Xác thực</span>
                <span id="btnVerifyLoader" style="display: none;">Đang xử lý...</span>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
          const email = document.getElementById('Email');
          if (email) { try { email.focus(); } catch(_){} }

          const sum = document.querySelector('.validation-summary-errors');
          if (sum) {
            document.querySelector('.auth-card')?.classList.add('has-error');
            setTimeout(()=>document.querySelector('.auth-card')?.classList.remove('has-error'), 400);
          }
        })();

        // Biến để lưu timer interval
        let otpTimerInterval = null;
        let otpTimeLeft = 0;

        // Hàm gắn event listeners cho OTP inputs
        function setupOTPInputs() {
          const otpInputs = Array.from(document.querySelectorAll('.otp-digit'));
          if (otpInputs.length === 0) return;
          
          // Kiểm tra xem đã gắn listeners chưa
          if (otpInputs[0].hasAttribute('data-otp-listener')) {
            return; // Đã gắn rồi, không gắn lại
          }
          
          otpInputs.forEach((input, index) => {
            // Đánh dấu đã gắn listener
            input.setAttribute('data-otp-listener', 'true');
            
            input.addEventListener('input', function(e) {
              const value = e.target.value.replace(/[^0-9]/g, '');
              e.target.value = value;
              
              // Lấy lại danh sách inputs
              const currentInputs = Array.from(document.querySelectorAll('.otp-digit'));
              if (value && index < currentInputs.length - 1) {
                currentInputs[index + 1].focus();
              }
              
              updateOTPCode();
            });
            
            input.addEventListener('keydown', function(e) {
              const currentInputs = Array.from(document.querySelectorAll('.otp-digit'));
              if (e.key === 'Backspace' && !e.target.value && index > 0) {
                currentInputs[index - 1].focus();
              }
            });
            
            input.addEventListener('paste', function(e) {
              e.preventDefault();
              const paste = (e.clipboardData || window.clipboardData).getData('text');
              const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
              const currentInputs = Array.from(document.querySelectorAll('.otp-digit'));
              
              digits.split('').forEach((digit, i) => {
                if (currentInputs[i]) {
                  currentInputs[i].value = digit;
                  currentInputs[i].classList.add('filled');
                }
              });
              
              if (digits.length === 6) {
                currentInputs[5].focus();
              } else if (digits.length > 0) {
                currentInputs[digits.length].focus();
              }
              
              updateOTPCode();
            });
          });
        }
        
        function updateOTPCode() {
          const otpInputs = document.querySelectorAll('.otp-digit');
          const code = Array.from(otpInputs).map(input => input.value).join('');
          const otpCodeEl = document.getElementById('otpCode');
          if (otpCodeEl) {
            otpCodeEl.value = code;
          }
          
          // Update button state
          const btnVerify = document.getElementById('btnVerify');
          if (btnVerify) {
            if (code.length === 6) {
              btnVerify.disabled = false;
              btnVerify.style.opacity = '1';
              btnVerify.classList.add('btn-primary');
              otpInputs.forEach(input => {
                if (input.value) {
                  input.classList.add('filled');
                }
              });
            } else {
              btnVerify.disabled = true;
              btnVerify.style.opacity = '0.6';
              btnVerify.classList.remove('btn-primary');
              otpInputs.forEach(input => {
                if (!input.value) {
                  input.classList.remove('filled');
                }
              });
            }
          }
        }

        function startOTPTimer(seconds) {
          otpTimeLeft = seconds;
          const countdownEl = document.getElementById('otpCountdown');
          const timerEl = document.getElementById('otpTimer');
          const btnResend = document.getElementById('btnResendOTP');
          const otpInputs = document.querySelectorAll('.otp-digit');
          
          if (otpTimerInterval) {
            clearInterval(otpTimerInterval);
          }
          
          if (btnResend) {
            btnResend.disabled = true;
            btnResend.style.opacity = '0.5';
          }
          
          updateCountdownDisplay();
          
          otpTimerInterval = setInterval(() => {
            otpTimeLeft--;
            updateCountdownDisplay();
            
            if (otpTimeLeft <= 0) {
              clearInterval(otpTimerInterval);
              otpTimerInterval = null;
              
              if (countdownEl) {
                countdownEl.textContent = '00:00';
              }
              if (timerEl) {
                timerEl.innerHTML = '<span style="color: #dc3545; font-weight: 600;">Mã OTP đã hết hạn. Vui lòng gửi lại mã mới.</span>';
              }
              
              otpInputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.5';
                input.style.cursor = 'not-allowed';
              });
              
              if (btnResend) {
                btnResend.disabled = false;
                btnResend.style.opacity = '1';
              }
            }
          }, 1000);
        }
        
        function updateCountdownDisplay() {
          const countdownEl = document.getElementById('otpCountdown');
          if (!countdownEl) return;
          
          const minutes = Math.floor(otpTimeLeft / 60);
          const seconds = otpTimeLeft % 60;
          countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          
          if (otpTimeLeft <= 30) {
            countdownEl.style.color = '#dc3545';
          } else {
            countdownEl.style.color = '#0ea5e9';
          }
        }

        function openModal(id){
          const el = document.getElementById(id);
          if (!el) return;
          try {
            el.removeAttribute('hidden');
            el.classList.add('show');
          } catch(err) { console.error('Open modal error', err); }
          document.body.style.overflow = 'hidden';
          el.addEventListener('click', function onBg(e){ if (e.target === el) { el.removeEventListener('click', onBg); closeModal(id); } });

          el._escHandler = function(e){ if (e.key === 'Escape') { closeModal(id); } };
          document.addEventListener('keydown', el._escHandler);

          const card = el.querySelector('.modal-card');
          if (card) {
            el._insideClickHandler = function(e){
              if (e.target.closest('.modal-foot .btn') || e.target.closest('.btn-close') || e.target.closest('a')) {
                e.preventDefault();
                closeModal(id);
              }
            };
            card.addEventListener('click', el._insideClickHandler);
          }
          
          // Nếu là OTP modal, setup inputs và timer
          if (id === 'otpModal') {
            setTimeout(() => {
              setupOTPInputs();
              updateOTPCode();
              const firstInput = document.querySelector('.otp-digit');
              if (firstInput) {
                firstInput.focus();
              }
            }, 100);
          }
        }

        function closeModal(id){
          const el = document.getElementById(id);
          if (!el) return;
          
          if (id === 'otpModal' && otpTimerInterval) {
            clearInterval(otpTimerInterval);
            otpTimerInterval = null;
          }
          
          try { el.classList.remove('show'); } catch(_){}
          document.body.style.overflow = '';
          setTimeout(()=>{ try { el.setAttribute('hidden',''); } catch(_){} }, 180);

          if (el._escHandler) { document.removeEventListener('keydown', el._escHandler); el._escHandler = null; }
          const card = el.querySelector('.modal-card');
          if (card && el._insideClickHandler) { card.removeEventListener('click', el._insideClickHandler); el._insideClickHandler = null; }
        }

        // Hiển thị modal OTP nếu có TempData
        @if (TempData["ShowOTPModal"] != null && (bool)TempData["ShowOTPModal"])
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
              const urlParams = new URLSearchParams(window.location.search);
              const isFromSubmit = sessionStorage.getItem('forgotPasswordOTPModalShown') !== 'true';
              
              if (isFromSubmit) {
                sessionStorage.setItem('forgotPasswordOTPModalShown', 'true');
                const email = '@(Context.Session.GetString("PendingResetEmail") ?? "")';
                if (email) {
                  const otpEmailEl = document.getElementById('otpEmail');
                  const otpEmailDisplayEl = document.getElementById('otpEmailDisplay');
                  if (otpEmailEl) otpEmailEl.value = email;
                  if (otpEmailDisplayEl) otpEmailDisplayEl.textContent = email;
                  
                  openModal('otpModal');
                  
                  // Bắt đầu countdown timer (2 phút = 120 giây)
                  setTimeout(() => {
                    startOTPTimer(120);
                  }, 200);
                }
              } else {
                sessionStorage.removeItem('forgotPasswordOTPModalShown');
              }
            });
            </text>
        }

        async function verifyForgotPasswordOTP() {
          const email = document.getElementById('otpEmail').value;
          const otp = document.getElementById('otpCode').value.trim();
          const errorEl = document.getElementById('otpError');
          const successEl = document.getElementById('otpSuccess');
          const btnVerify = document.getElementById('btnVerify');
          const btnVerifyText = document.getElementById('btnVerifyText');
          const btnVerifyLoader = document.getElementById('btnVerifyLoader');
          
          if (!otp || otp.length !== 6) {
            errorEl.textContent = 'Vui lòng nhập đầy đủ mã OTP 6 số.';
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
            return;
          }

          errorEl.style.display = 'none';
          successEl.style.display = 'none';
          
          // Disable button và hiển thị loading
          btnVerify.disabled = true;
          btnVerifyText.style.display = 'none';
          btnVerifyLoader.style.display = 'inline';
          
          try {
            const response = await fetch('@Url.Action("VerifyForgotPasswordOTP", "Account")', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
              },
              body: JSON.stringify({ email: email, otp: otp })
            });

            let result;
            try {
              result = await response.json();
            } catch (e) {
              console.error('Failed to parse JSON:', e);
              errorEl.textContent = 'Lỗi xử lý phản hồi từ server.';
              errorEl.style.display = 'block';
              btnVerify.disabled = false;
              btnVerifyText.style.display = 'inline';
              btnVerifyLoader.style.display = 'none';
              return;
            }
            
            const isSuccess = response.ok && result && result.success === true;
            
            if (isSuccess) {
              errorEl.style.display = 'none';
              
              // Hiển thị success message với animation
              successEl.innerHTML = '<div style="display: flex; align-items: center; gap: 8px; color: #0284c7; font-weight: 600;"><svg style="width: 20px; height: 20px; fill: #0284c7;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>OTP đã được xác thực thành công!</div>';
              successEl.style.display = 'block';
              successEl.style.padding = '12px';
              successEl.style.background = '#e0f2fe';
              successEl.style.borderRadius = '8px';
              successEl.style.border = '1px solid #0284c7';
              successEl.style.opacity = '0';
              successEl.style.transform = 'translateY(-10px)';
              successEl.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
              
              // Animate success message in
              setTimeout(() => {
                successEl.style.opacity = '1';
                successEl.style.transform = 'translateY(0)';
              }, 10);
              
              // Ẩn OTP inputs và các button với animation
              const otpInputs = document.getElementById('otpInputs');
              const btnVerifyEl = document.getElementById('btnVerify');
              const btnResendEl = document.getElementById('btnResendOTP');
              const timerEl = document.getElementById('otpTimer');
              
              if (otpInputs) {
                otpInputs.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                otpInputs.style.opacity = '0';
                otpInputs.style.transform = 'translateY(-10px)';
              }
              
              if (btnVerifyEl) {
                btnVerifyEl.style.transition = 'opacity 0.3s ease-out';
                btnVerifyEl.style.opacity = '0';
              }
              
              if (btnResendEl) {
                btnResendEl.style.transition = 'opacity 0.3s ease-out';
                btnResendEl.style.opacity = '0';
              }
              
              if (timerEl) {
                timerEl.style.transition = 'opacity 0.3s ease-out';
                timerEl.style.opacity = '0';
              }
              
              btnVerify.disabled = false;
              btnVerifyText.style.display = 'inline';
              btnVerifyLoader.style.display = 'none';
              
              // Fade out modal và redirect mượt mà
              setTimeout(() => {
                const modal = document.getElementById('otpModal');
                const modalCard = modal?.querySelector('.modal-card');
                
                if (modalCard) {
                  modalCard.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                  modalCard.style.opacity = '0';
                  modalCard.style.transform = 'scale(0.95) translateY(-20px)';
                }
                
                if (modal) {
                  modal.style.transition = 'background-color 0.4s ease-out';
                  modal.style.backgroundColor = 'rgba(0, 0, 0, 0)';
                }
                
                // Fade out toàn bộ page
                const authWrap = document.querySelector('.auth-wrap');
                if (authWrap) {
                  authWrap.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                  authWrap.style.opacity = '0';
                  authWrap.style.transform = 'translateY(-20px)';
                }
                
                // Redirect sau khi animation hoàn tất
                setTimeout(() => {
                  closeModal('otpModal');
                  sessionStorage.removeItem('forgotPasswordOTPModalShown');
                  
                  // Redirect với smooth transition
                  const resetUrl = '@Url.Action("ResetPassword", "Account")?email=' + encodeURIComponent(email) + '&token=' + encodeURIComponent(result.token || '');
                  
                  // Thêm loading overlay nếu cần
                  const loadingOverlay = document.createElement('div');
                  loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(14, 165, 233, 0.95) 0%, rgba(2, 132, 199, 0.95) 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease-out;';
                  loadingOverlay.innerHTML = '<div style="text-align: center; color: white;"><div style="width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; margin: 0 auto 16px; animation: spin 0.8s linear infinite;"></div><p style="font-size: 16px; font-weight: 600;">Đang chuyển trang...</p></div>';
                  document.body.appendChild(loadingOverlay);
                  
                  setTimeout(() => {
                    loadingOverlay.style.opacity = '1';
                  }, 10);
                  
                  setTimeout(() => {
                    window.location.href = resetUrl;
                  }, 300);
                }, 400);
              }, 600);
            } else {
              errorEl.textContent = result.message || 'OTP không hợp lệ hoặc đã hết hạn.';
              errorEl.style.display = 'block';
              
              // Clear OTP inputs
              document.querySelectorAll('.otp-digit').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
              });
              document.getElementById('otpCode').value = '';
              document.querySelector('.otp-digit')?.focus();
              
              btnVerify.disabled = false;
              btnVerifyText.style.display = 'inline';
              btnVerifyLoader.style.display = 'none';
            }
          } catch (error) {
            errorEl.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
            errorEl.style.display = 'block';
            console.error('Verify OTP error:', error);
            
            btnVerify.disabled = false;
            btnVerifyText.style.display = 'inline';
            btnVerifyLoader.style.display = 'none';
          }
        }


        async function resendOTP() {
          const email = document.getElementById('otpEmail').value;
          const errorEl = document.getElementById('otpError');
          const successEl = document.getElementById('otpSuccess');
          const btnResend = document.getElementById('btnResendOTP');
          const btnResendText = document.getElementById('btnResendText');
          const timerEl = document.getElementById('otpTimer');
          const otpInputs = document.querySelectorAll('.otp-digit');
          
          if (!email) {
            errorEl.textContent = 'Email không hợp lệ.';
            errorEl.style.display = 'block';
            successEl.style.display = 'none';
            return;
          }

          errorEl.style.display = 'none';
          successEl.style.display = 'none';
          
          const originalText = btnResendText.textContent;
          btnResend.disabled = true;
          btnResend.style.opacity = '0.5';
          btnResendText.textContent = 'Đang gửi...';
          
          try {
            const response = await fetch('@Url.Action("ResendForgotPasswordOTP", "Account")', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
              },
              body: JSON.stringify({ email: email })
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
              successEl.textContent = '✓ Mã OTP mới đã được gửi đến email của bạn.';
              successEl.style.display = 'block';
              
              otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
                input.disabled = false;
                input.style.opacity = '1';
                input.style.cursor = 'text';
              });
              document.getElementById('otpCode').value = '';
              document.querySelector('.otp-digit')?.focus();
              
              timerEl.innerHTML = 'Mã OTP còn hiệu lực trong: <span id="otpCountdown" style="color: #0ea5e9;">02:00</span>';
              setTimeout(() => {
                startOTPTimer(120);
              }, 50);
              
              setTimeout(() => {
                btnResend.disabled = true;
                btnResend.style.opacity = '0.5';
                btnResendText.textContent = originalText;
              }, 2000);
            } else {
              errorEl.textContent = result.message || 'Không thể gửi lại OTP.';
              errorEl.style.display = 'block';
              
              btnResend.disabled = false;
              btnResend.style.opacity = '1';
              btnResendText.textContent = originalText;
            }
          } catch (error) {
            errorEl.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
            errorEl.style.display = 'block';
            console.error('Resend OTP error:', error);
            
            btnResend.disabled = false;
            btnResend.style.opacity = '1';
            btnResendText.textContent = originalText;
          }
        }

    </script>
}

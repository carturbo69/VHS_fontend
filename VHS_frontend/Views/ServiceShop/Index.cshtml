@model VHS_frontend.Models.ServiceShop.ServiceShopViewModel
@{
    ViewData["Title"] = "Shop Dịch Vụ Vệ Sinh";
}

@{
    // DEBUG: Kiểm tra dữ liệu Model
    System.Diagnostics.Debug.WriteLine($"=== ServiceShop View DEBUG ===");
    System.Diagnostics.Debug.WriteLine($"Model is null: {Model == null}");
    if (Model != null)
    {
        System.Diagnostics.Debug.WriteLine($"ProviderId: {Model.ProviderId}");
        System.Diagnostics.Debug.WriteLine($"ShopInfo.Name: '{Model.ShopInfo?.Name ?? "NULL"}'");
        System.Diagnostics.Debug.WriteLine($"ShopInfo.Logo: '{Model.ShopInfo?.Logo ?? "NULL"}'");
        System.Diagnostics.Debug.WriteLine($"ShopInfo.TotalServices: {Model.ShopInfo?.TotalServices ?? 0}");
        System.Diagnostics.Debug.WriteLine($"Services count: {Model.Services?.Count ?? 0}");
        System.Diagnostics.Debug.WriteLine($"BestsellingServices count: {Model.BestsellingServices?.Count ?? 0}");
    }

    // Helper functions để xử lý ảnh giống Services/Index.cshtml và Details.cshtml
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            // Thử parse JSON array trước
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        // Nếu không phải JSON, thử split bằng dấu phẩy
        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        
        // Nếu không có dấu phẩy, trả về nguyên chuỗi
        return images;
    }

    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    string FallbackByUnit(string? unit)
    {
        if (string.IsNullOrWhiteSpace(unit)) return Url.Content("~/images/VeSinh.jpg");
        
        var unitLower = unit.Trim().ToLower();
        
        // Kiểm tra các pattern khác nhau của UnitType
        if (unitLower.Contains("nội trợ") || unitLower == "nội trợ")
            return Url.Content("~/images/NoiTro.jpg");
        
        if (unitLower.Contains("sự kiện") || unitLower.Contains("sukien") || unitLower == "sự kiện nhỏ tại nhà")
            return Url.Content("~/images/SuKienNho.jpg");
        
        // Mặc định
        return Url.Content("~/images/VeSinh.jpg");
    }

    // Helper để lấy ảnh cho service (giống Services/Index.cshtml)
    // Backend đã tự động thêm domain prefix, nên chỉ cần dùng trực tiếp
    string GetServiceImage(VHS_frontend.Models.ServiceItem service)
    {
        // Ưu tiên ImageUrl trước (giống service.Images trong Services/Index.cshtml)
        if (!string.IsNullOrWhiteSpace(service.ImageUrl))
        {
            var img = FirstImageOrDefault(service.ImageUrl);
            if (!string.IsNullOrWhiteSpace(img))
            {
                return img; // Backend đã thêm domain prefix rồi, dùng trực tiếp
            }
        }

        // Sau đó thử Image
        if (!string.IsNullOrWhiteSpace(service.Image))
        {
            var img = FirstImageOrDefault(service.Image);
            if (!string.IsNullOrWhiteSpace(img))
            {
                return img; // Backend đã thêm domain prefix rồi, dùng trực tiếp
            }
        }

        // Cuối cùng fallback theo Unit
        return FallbackByUnit(service.Unit);
    }
}

<link rel="stylesheet" href="~/css/service-shop.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div class="service-shop-container">
    <!-- Shop Profile Section -->
    <div class="shop-profile-section">
        <div class="shop-info">
            <div class="shop-logo">
                <img src="@Model.ShopInfo.Logo" alt="Shop Logo" class="logo-img" onerror="this.src='/images/VeSinh.jpg'">
            </div>
            <div class="shop-details">
                <h2 class="shop-name">@Model.ShopInfo.Name</h2>
                <p class="shop-status">
                    <span class="status-dot @(Model.ShopInfo.Status == "Online" ? "online" : "offline")"></span>
                    @Model.ShopInfo.Status @Model.ShopInfo.LastOnline
                </p>
                <div class="shop-actions">
                    @* <button class="btn-follow @(Model.ShopInfo.IsFollowed ? "followed" : "")"> *@
                    @*     <i class="fas fa-plus"></i> @(Model.ShopInfo.IsFollowed ? "Đang Theo" : "Theo Dõi") *@
                    @* </button> *@
                    <a class="btn-chat"
                       asp-area="Customer"
                       asp-controller="ChatCustomer"
                       asp-action="WithProvider"
                       asp-route-providerId="@Model.ProviderId">
                        <i class="fas fa-comments"></i> Chat
                    </a>
                </div>
            </div>
        </div>
        <div class="shop-stats">
            <div class="stat-item">
                <span class="stat-label">Dịch Vụ:</span>
                <span class="stat-value">@Model.ShopInfo.TotalServices</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Đánh Giá:</span>
                <span class="stat-value">
                    @if (Model.ShopInfo.Rating > 0 && Model.ShopInfo.TotalRatings > 0)
                    {
                        @Model.ShopInfo.Rating.ToString("0.0") @($"({Model.ShopInfo.TotalRatings.ToString("N0")} đánh giá)")
                    }
                    else
                    {
                        <text>Chưa có đánh giá</text>
                    }
                </span>
            </div>
            @if (Model.ShopInfo.Followers > 0)
            {
                <div class="stat-item">
                    <span class="stat-label">Người Theo Dõi:</span>
                    <span class="stat-value">@Model.ShopInfo.Followers.ToString("N0")</span>
                </div>
            }
            <div class="stat-item">
                <span class="stat-label">Tỉ Lệ Phản Hồi:</span>
                <span class="stat-value">@Model.ShopInfo.ResponseRate.ToString("0.0")%</span>
            </div>
            @if (!string.IsNullOrEmpty(Model.ShopInfo.JoinDate) && Model.ShopInfo.JoinDate != "—")
            {
                <div class="stat-item">
                    <span class="stat-label">Tham Gia:</span>
                    <span class="stat-value">@Model.ShopInfo.JoinDate</span>
                </div>
            }
        </div>
    </div>


    <!-- Bestselling Services Section -->
    @if (Model.BestsellingServices.Any())
    {
        <div class="bestselling-section">
            <div class="section-header">
                <h3 class="section-title">DỊCH VỤ NỔI BẬT</h3>
            </div>
        <div class="bestselling-carousel">
            @for (int i = 0; i < Model.BestsellingServices.Count; i++)
            {
                var service = Model.BestsellingServices[i];
                <a asp-controller="Services" asp-action="Details" asp-route-id="@service.ServiceId" style="text-decoration: none; color: inherit;">
                    <div class="bestselling-item">
                        <div class="product-tags-wrapper">
                            @if (service.Tags != null && service.Tags.Any())
                            {
                                @foreach (var tag in service.Tags.Take(3))
                                {
                                    <div class="product-tag product-tag-sub">@tag</div>
                                }
                            }
                        </div>
                        <div class="product-image">
                            <img src="@GetServiceImage(service)" alt="@service.Name" data-fallback="@fallbackImg">
                        </div>
                        <div class="product-info">
                            <h4 class="product-name">@service.Name</h4>
                            @if (service.ServiceOptions != null && service.ServiceOptions.Any())
                            {
                                <div class="product-options">
                                    @foreach (var opt in service.ServiceOptions.Take(3))
                                    {
                                        var isTextarea = opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text";
                                        <div class="product-option-item @(isTextarea ? "option-item-textarea" : "")">
                                            <span class="option-icon">✓</span>
                                            <div class="option-content">
                                                <span class="option-name">@opt.OptionName</span>
                                                @if (!string.IsNullOrWhiteSpace(opt.Value) && isTextarea)
                                                {
                                                    <div class="option-value">@opt.Value</div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    @if (service.ServiceOptions.Count > 3)
                                    {
                                        <div class="product-option-more">+@(service.ServiceOptions.Count - 3) khác</div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="product-no-options">Chưa có tùy chọn</div>
                            }
                            <div class="product-price">@service.Price.ToString("N0")₫</div>
                            <div class="product-rating">
                                @if (service.Rating > 0)
                                {
                                    <span class="rating">⭐ @service.Rating.ToString("0.0")</span>
                                    @if (service.RatingCount > 0)
                                    {
                                        <span class="sales">(@service.RatingCount đánh giá)</span>
                                    }
                                }
                                else
                                {
                                    <span class="sales">Chưa có đánh giá</span>
                                }
                            </div>
                        </div>
                    </div>
                </a>
            }
        </div>
        </div>
    }

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Left Sidebar -->
        <div class="left-sidebar categories-sidebar">
            <h4 class="sidebar-title">Danh Mục</h4>
            <div class="category-items">
                <a href="#" data-category-id="" data-tag-id="" class="category-link @(Model.SelectedCategoryId == null && Model.SelectedTagId == null ? "active" : "")">
                    Tất cả (@Model.ShopInfo.TotalServices)
                </a>
                @foreach (var category in Model.AllCategories.OrderBy(c => c.Name))
                {
                    @if (category.ServiceCount > 0)
                    {
                        <div class="category-group">
                            <a href="#" data-category-id="@category.Id" data-tag-id="" class="category-link @(Model.SelectedCategoryId == category.Id && Model.SelectedTagId == null ? "active" : "")">
                                @category.Name (@category.ServiceCount)
                            </a>
                            @if (category.Tags != null && category.Tags.Any())
                            {
                                <div class="category-tags">
                                    @foreach (var tag in category.Tags)
                                    {
                                        <a href="#" data-category-id="@category.Id" data-tag-id="@tag.TagId" class="tag-link @(Model.SelectedTagId == tag.TagId ? "active" : "")">
                                            @tag.Name (@tag.ServiceCount)
                                        </a>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Main Product Area -->
        <div class="main-product-area">
            <!-- Sort and Pagination Bar -->
            <div class="sort-pagination-bar">
                <div class="sort-options">
                    <span class="sort-label">Sắp xếp theo:</span>
                    <a href="#" data-sort="popular" class="sort-option @(Model.SortBy == "popular" ? "active" : "")">Phổ Biến</a>
                    <!-- <a href="#" data-sort="newest" class="sort-option @(Model.SortBy == "newest" ? "active" : "")">Mới Nhất</a> -->
                    <a href="#" data-sort="bestselling" class="sort-option @(Model.SortBy == "bestselling" ? "active" : "")">Đặt Nhiều Nhất</a>
                    <div class="price-sort-dropdown">
                        <a href="#" class="sort-option @(Model.SortBy == "price-asc" || Model.SortBy == "price-desc" || Model.SortBy == "price" ? "active" : "")">
                            Giá 
                            <i class="fas fa-chevron-down"></i>
                            @if (Model.SortBy == "price-asc" || Model.SortBy == "price")
                            {
                                <span class="sort-indicator">↑</span>
                            }
                            else if (Model.SortBy == "price-desc")
                            {
                                <span class="sort-indicator">↓</span>
                            }
                        </a>
                        <div class="price-dropdown-menu">
                            <a href="#" data-sort="price-asc" class="price-option @(Model.SortBy == "price-asc" || Model.SortBy == "price" ? "active" : "")">Thấp → Cao</a>
                            <a href="#" data-sort="price-desc" class="price-option @(Model.SortBy == "price-desc" ? "active" : "")">Cao → Thấp</a>
                        </div>
                    </div>
                </div>
                <div class="pagination-info" id="pagination-info">
                    <span>Trang @Model.CurrentPage/@Model.TotalPages</span>
                    @if (Model.CurrentPage > 1)
                    {
                        <a href="#" data-page="@(Model.CurrentPage - 1)" class="page-btn prev-btn"><i class="fas fa-chevron-left"></i></a>
                    }
                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="#" data-page="@(Model.CurrentPage + 1)" class="page-btn next-btn"><i class="fas fa-chevron-right"></i></a>
                    }
                </div>
            </div>

            <!-- Product Grid -->
            <div class="product-grid" id="product-grid">
                @if (!Model.Services.Any())
                {
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Chưa có dịch vụ nào trong danh mục này</p>
                    </div>
                }
                else
                {
                    @foreach (var service in Model.Services)
                    {
                        <a asp-controller="Services" asp-action="Details" asp-route-id="@service.ServiceId" class="product-card-link">
                            <div class="product-card">
                                <div class="product-tags-wrapper">
                                    @if (service.Tags != null && service.Tags.Any())
                                    {
                                        @foreach (var tag in service.Tags.Take(3))
                                        {
                                            <div class="product-tag product-tag-sub">@tag</div>
                                        }
                                    }
                                </div>
                                <div class="product-image">
                                    <img src="@GetServiceImage(service)" alt="@service.Name" data-fallback="@fallbackImg">
                                </div>
                                <div class="product-info">
                                    <h4 class="product-name">@service.Name</h4>
                                    @if (service.ServiceOptions != null && service.ServiceOptions.Any())
                                    {
                                        <div class="product-options">
                                            @foreach (var opt in service.ServiceOptions.Take(3))
                                            {
                                                var isTextarea = opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text";
                                                <div class="product-option-item @(isTextarea ? "option-item-textarea" : "")">
                                                    <span class="option-icon">✓</span>
                                                    <div class="option-content">
                                                        <span class="option-name">@opt.OptionName</span>
                                                        @if (!string.IsNullOrWhiteSpace(opt.Value) && isTextarea)
                                                        {
                                                            <div class="option-value">@opt.Value</div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            @if (service.ServiceOptions.Count > 3)
                                            {
                                                <div class="product-option-more">+@(service.ServiceOptions.Count - 3) khác</div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="product-no-options">Chưa có tùy chọn</div>
                                    }
                                    <div class="product-price">@service.Price.ToString("N0")₫</div>
                                    <div class="product-rating">
                                        @if (service.Rating > 0)
                                        {
                                            <span class="rating">⭐ @service.Rating.ToString("0.0")</span>
                                            @if (service.RatingCount > 0)
                                            {
                                                <span class="sales">(@service.RatingCount đánh giá)</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="sales">Chưa có đánh giá</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </a>
                    }
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Tự động thay ảnh lỗi bằng fallback, tránh lặp vô hạn khi fallback hỏng.
        (function () {
          function applyFallback(img) {
            if (!img || img.dataset.fallbackApplied === '1') return;
            const fb = img.getAttribute('data-fallback');
            if (!fb) return;
            img.dataset.fallbackApplied = '1';
            img.src = fb;
          }

          // Gắn listener cho tất cả ảnh có data-fallback
          function wireImages(root = document) {
            root.querySelectorAll('img[data-fallback]').forEach(function (img) {
              // Nếu ảnh đã load lỗi trước khi gắn listener, xử lý ngay
              if (img.complete && img.naturalWidth === 0) applyFallback(img);

              // Bắt lỗi khi load thất bại
              img.addEventListener('error', function () {
                applyFallback(img);
              }, { once: true });
            });
          }

          wireImages(document);
        })();

        const providerId = '@Model.ProviderId';
        let currentCategoryId = '@(Model.SelectedCategoryId?.ToString() ?? "")';
        let currentTagId = '@(Model.SelectedTagId?.ToString() ?? "")';
        let currentSortBy = '@Model.SortBy';
        let currentPage = @Model.CurrentPage;

        // Handle follow button
        document.querySelectorAll('.btn-follow').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                this.classList.toggle('followed');
                const text = this.classList.contains('followed') ? 'Đang Theo' : 'Theo Dõi';
                this.innerHTML = `<i class="fas fa-${this.classList.contains('followed') ? 'check' : 'plus'}"></i> ${text}`;
            });
        });

        // Price dropdown - show on hover
        const priceDropdown = document.querySelector('.price-sort-dropdown');
        const priceMenu = priceDropdown?.querySelector('.price-dropdown-menu');

        if (priceDropdown && priceMenu) {
            priceDropdown.addEventListener('mouseenter', function() {
                priceMenu.classList.add('show');
            });

            priceDropdown.addEventListener('mouseleave', function() {
                priceMenu.classList.remove('show');
            });
        }

        // Load data via AJAX
        function loadData(categoryId, tagId, sortBy, page) {
            currentCategoryId = categoryId || '';
            currentTagId = tagId || '';
            currentSortBy = sortBy || 'popular';
            currentPage = page || 1;

            // Update URL without reload
            const params = new URLSearchParams({
                providerId: providerId,
                sortBy: sortBy || 'popular',
                page: (page || 1).toString()
            });
            if (categoryId) params.append('categoryId', categoryId);
            if (tagId) params.append('tagId', tagId);
            
            const url = `/ServiceShop?${params.toString()}`;
            
            // Update browser URL without reload
            window.history.pushState({}, '', url);
            
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update product grid
                    const newGrid = doc.querySelector('#product-grid');
                    if (newGrid) {
                        document.querySelector('#product-grid').innerHTML = newGrid.innerHTML;
                    }
                    
                    // Update pagination info
                    const newPagination = doc.querySelector('#pagination-info');
                    if (newPagination) {
                        // Extract page number from pagination
                        const pageText = newPagination.textContent;
                        const pageMatch = pageText.match(/Trang (\d+)\/(\d+)/);
                        if (pageMatch) {
                            document.querySelector('#pagination-info span').textContent = pageText.match(/Trang \d+\/\d+/)[0];
                        }
                        
                        // Update pagination buttons
                        const paginationContainer = document.querySelector('#pagination-info');
                        const oldButtons = paginationContainer.querySelectorAll('.page-btn');
                        oldButtons.forEach(btn => btn.remove());
                        
                        const newButtons = newPagination.querySelectorAll('.page-btn');
                        newButtons.forEach(btn => {
                            const newBtn = btn.cloneNode(true);
                            paginationContainer.appendChild(newBtn);
                        });
                        
                        attachPageListeners();
                    }

                    // Update active states
                    updateActiveStates();
                    
                    // Không scroll lên đầu, giữ nguyên vị trí
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    // Fallback to full page reload if AJAX fails
                    window.location.href = url;
                });
        }

        // Update active states
        function updateActiveStates() {
            // Update category/tag links
            document.querySelectorAll('.category-link, .tag-link').forEach(link => {
                const linkCategoryId = link.getAttribute('data-category-id') || '';
                const linkTagId = link.getAttribute('data-tag-id') || '';
                
                link.classList.remove('active');
                if (linkCategoryId === currentCategoryId && linkTagId === currentTagId) {
                    link.classList.add('active');
                }
            });

            // Update sort options
            document.querySelectorAll('.sort-option, .price-option').forEach(link => {
                const sort = link.getAttribute('data-sort');
                link.classList.remove('active');
                if (sort === currentSortBy || 
                    (sort === 'price-asc' && currentSortBy === 'price')) {
                    link.classList.add('active');
                }
            });

            // Update price dropdown indicator
            const priceToggle = document.querySelector('.price-sort-dropdown .sort-option');
            if (priceToggle) {
                let indicator = priceToggle.querySelector('.sort-indicator');
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'sort-indicator';
                    priceToggle.appendChild(indicator);
                }
                
                if (currentSortBy === 'price-asc' || currentSortBy === 'price') {
                    indicator.textContent = '↑';
                } else if (currentSortBy === 'price-desc') {
                    indicator.textContent = '↓';
                } else {
                    indicator.textContent = '';
                }
            }
        }

        // Attach event listeners
        function attachListeners() {
            // Category and tag links
            document.querySelectorAll('.category-link, .tag-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const categoryId = this.getAttribute('data-category-id') || '';
                    const tagId = this.getAttribute('data-tag-id') || '';
                    loadData(categoryId, tagId, currentSortBy, 1);
                });
            });

            // Sort options
            document.querySelectorAll('.sort-option, .price-option').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sort = this.getAttribute('data-sort');
                    if (sort) {
                        if (priceMenu) priceMenu.classList.remove('show');
                        loadData(currentCategoryId, currentTagId, sort, 1);
                    }
                });
            });
        }

        // Page navigation
        function attachPageListeners() {
            document.querySelectorAll('.page-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page')) || 1;
                    loadData(currentCategoryId, currentTagId, currentSortBy, page);
                });
            });
        }

        // Initialize
        attachListeners();
        attachPageListeners();
    </script>
}

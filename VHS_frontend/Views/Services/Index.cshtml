@model List<VHS_frontend.Models.ServiceDTOs.ListServiceHomePageDTOs>

@{
    ViewData["Title"] = "Dịch vụ";
    string search = ViewBag.Search as string ?? "";
    string category = ViewBag.Category as string ?? "";
    string tag = ViewBag.Tag as string ?? "";
    string sort = ViewBag.Sort as string ?? "";
    string filter = ViewBag.Filter as string ?? "";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int startPage = Math.Max(1, currentPage - 2);
    int endPage = Math.Min(totalPages, currentPage + 2);

    string PriceToDisplay(decimal p) => $"{p:n0}đ";
    var fallbackImg = Url.Content("~/images/VeSinh.jpg");
    
    var tags = ViewBag.Tags as List<VHS_frontend.Models.ServiceShop.TagDTO> ?? new List<VHS_frontend.Models.ServiceShop.TagDTO>();
    
    // Helper function để xử lý URL ảnh (thêm domain prefix nếu cần)
    string ToUrl(string? p) => string.IsNullOrEmpty(p) ? string.Empty : (p.StartsWith("http") ? p : $"http://localhost:5154{p}");
}

@functions {
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        return images;
    }

    // Hàm chuyển đổi UnitType sang tiếng Việt
    string GetUnitTypeVietnamese(string? unitType)
    {
        if (string.IsNullOrEmpty(unitType)) return unitType ?? "";
        return unitType switch
        {
            "Hour" => "Giờ",
            "Day" => "Ngày",
            "Visit" => "Lần",
            "Apartment" => "Căn",
            "Room" => "Phòng",
            "SquareMeter" => "Mét vuông (m²)",
            "Person" => "Người",
            "Package" => "Gói",
            "Event" => "Sự kiện",
            _ => unitType
        };
    }
}

<section class="services-hero-section">
    <div class="services-hero-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    
    <div class="services-container">
        <!-- Hero Header - Revolutionary Design -->
        <div class="services-hero-header">
            <!-- Floating Particles Background -->
            <div class="hero-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            
            <!-- Animated Badge -->
            <div class="hero-badge-wrapper">
                <span class="hero-badge">
                    <span class="badge-glow"></span>
                    <svg class="badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="badge-text">Dịch vụ uy tín • Chất lượng hàng đầu</span>
                </span>
            </div>
            
            <!-- 3D Title Effect -->
            <h1 class="hero-title">
                <span class="title-line">Khám phá</span>
                <span class="title-line grad-text-3d">dịch vụ chất lượng cao</span>
                <span class="title-line">cho ngôi nhà thông minh của bạn</span>
            </h1>
            
            <!-- Animated Description -->
            <p class="hero-description">
                <span class="desc-highlight">Tìm kiếm và đặt dịch vụ phù hợp với nhu cầu của bạn một cách nhanh chóng và tiện lợi.</span><br/>
                <span class="hero-features">
                    <span class="feature-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Minh bạch về giá
                    </span>
                    <span class="feature-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Đặt dịch vụ nhanh chóng
                    </span>
                    <span class="feature-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Đáng tin cậy & uy tín
                    </span>
                </span>
            </p>
        </div>

        <!-- Advanced Filter -->
        <form method="get" asp-action="Index" class="services-filter-card" id="filterForm">
            <input type="hidden" name="tag" id="tagHiddenInput" value="@tag" />
            <div class="filter-header">
                <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M22 3H2L10 12.46V19L14 21V12.46L22 3Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>Tìm kiếm dịch vụ</h3>
            </div>
            
            <div class="filter-grid">
                <div class="filter-input-group">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="11" cy="11" r="8" stroke-width="2"/>
                            <path d="M21 21L16.65 16.65" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Tìm kiếm
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="search" value="@search" 
                               placeholder="Nhập tên dịch vụ hoặc từ khóa..." 
                               class="filter-input" />
                    </div>
                </div>

                <div class="filter-input-group">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 2V6M12 18V22M4.93 4.93L7.76 7.76M16.24 16.24L19.07 19.07M2 12H6M18 12H22M4.93 19.07L7.76 16.24M16.24 7.76L19.07 4.93" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Sắp xếp
                    </label>
                    <div class="select-wrapper">
                        <select name="sort" class="filter-select">
                            <option value="">Mặc định</option>
                            <option value="price-500" selected="@(sort == "price-500")">Dưới 500K</option>
                            <option value="price-500-1000" selected="@(sort == "price-500-1000")">500K - 1M</option>
                            <option value="price-1000-5000" selected="@(sort == "price-1000-5000")">1M - 5M</option>
                            <option value="price-5000" selected="@(sort == "price-5000")">Trên 5M</option>
                        </select>
                        <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>

                <div class="filter-input-group">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M3 4H21V6H3V4ZM3 10H21V12H3V10ZM3 16H21V18H3V16Z" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Bộ lọc
                    </label>
                    <div class="select-wrapper">
                        <select name="filter" class="filter-select">
                            <option value="">Mặc định</option>
                            <option value="price-asc" selected="@(filter == "price-asc")">Giá từ thấp đến cao</option>
                            <option value="price-desc" selected="@(filter == "price-desc")">Giá từ cao đến thấp</option>
                            <option value="stars" selected="@(filter == "stars")">⭐ Đánh giá cao nhất</option>
                        </select>
                        <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>

                <button type="submit" class="filter-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span>Tìm kiếm</span>
                    <div class="btn-shine"></div>
                </button>

                <div class="filter-input-group category-chips-group" style="grid-column: 1 / -1;">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M4 4H20V6H4V4ZM7 9H17V11H7V9ZM10 14H14V16H10V14Z" fill="currentColor"/>
                        </svg>
                        Danh mục
                    </label>
                    <div class="category-chips-container">
                        <input type="hidden" name="category" id="categorySelect" value="@category" />
                        <div class="category-chip-wrapper">
                            <button type="button" class="category-chip @(string.IsNullOrEmpty(category) ? "active" : "")" data-category-id="">
                                <span>Tất cả</span>
                </button>
                        </div>
                        @if (ViewBag.Categories is IEnumerable<VHS_frontend.Areas.Admin.Models.Category.CategoryDTO> categories)
                        {
                            foreach (var cat in categories)
                            {
                                var isSelected = category == cat.CategoryId.ToString();
                                var categoryTags = tags.Where(t => t.CategoryId == cat.CategoryId).ToList();
                                <div class="category-chip-wrapper">
                                    <button type="button" class="category-chip @(isSelected ? "active" : "")" data-category-id="@cat.CategoryId">
                                        <span>@cat.Name</span>
                                    </button>
                                    <div class="category-tag-dropdown @(isSelected && categoryTags.Any() ? "show" : "")" data-category-id="@cat.CategoryId" style="display: @(isSelected && categoryTags.Any() ? "block" : "none");">
                                        <div class="category-tags-list">
                                            @foreach (var tagItem in categoryTags)
                                            {
                                                var isTagSelected = tag == tagItem.TagId.ToString();
                                                <button type="button" class="category-tag-item @(isTagSelected ? "active" : "")" data-tag-id="@tagItem.TagId">
                                                    @tagItem.Name
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </form>

        <!-- Services Grid -->
        <div id="servicesResults">
        @if (Model == null || !Model.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21L16.65 16.65"/>
                        <path d="M11 8v6M8 11h6" stroke-width="2"/>
                    </svg>
                </div>
                <h3>Không tìm thấy dịch vụ phù hợp</h3>
                <p>Vui lòng thử điều chỉnh bộ lọc hoặc từ khóa tìm kiếm để khám phá thêm nhiều dịch vụ hấp dẫn khác</p>
            </div>
        }
        else
        {
            <div class="services-grid">
                @foreach (var service in Model)
                {
                    var imgRaw = FirstImageOrDefault(service.Images) ?? fallbackImg;
                    var img = ToUrl(imgRaw);
                    var priceDisplay = PriceToDisplay(service.Price);
                    var avg = service.AverageRating;

                        <a asp-area="" asp-controller="Services" asp-action="Details" asp-route-id="@service.ServiceId" class="service-card">

                            @* Provider name ở đầu card, trước ảnh *@
                            @if (!string.IsNullOrWhiteSpace(service.ProviderName))
                            {
                                <div class="provider-section provider-section-top">
                                    <svg class="provider-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="7" r="4" stroke-width="2"/>
                                    </svg>
                                    <span class="provider-name">@service.ProviderName</span>
                                </div>
                            }

                        <div class="card-image-container">
                            <div class="image-wrapper">
                                <img src="@img"
                                     alt="@service.Title"
                                     class="card-image"
                                     loading="lazy"
                                     onerror="this.onerror=null;this.src='@fallbackImg';" />
                                <div class="image-overlay"></div>
                            </div>
                            
                            @if (!string.IsNullOrWhiteSpace(service.CategoryName))
                            {
                                <div class="card-category-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M20.59 13.41L13.42 20.58C13.2343 20.766 13.0137 20.9135 12.7709 21.0141C12.5281 21.1148 12.2678 21.1666 12.005 21.1666C11.7422 21.1666 11.4819 21.1148 11.2391 21.0141C10.9963 20.9135 10.7757 20.766 10.59 20.58L2 12V2H12L20.59 10.59C20.9625 10.9647 21.1716 11.4716 21.1716 12C21.1716 12.5284 20.9625 13.0353 20.59 13.41Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="7" cy="7" r="1.5" fill="currentColor"/>
                                    </svg>
                                    <span>@service.CategoryName</span>
                                </div>
                            }
                            
                            @if (avg >= 4.5)
                            {
                                <div class="trending-badge">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M13 10V3L4 14H11L11 21L20 10L13 10Z"/>
                                    </svg>
                                    <span>HOT</span>
                                </div>
                            }
                        </div>

                        <div class="card-content">
                            <h3 class="card-title">@service.Title</h3>

                            @* Hiển thị tất cả tùy chọn: textarea ở cuối, các loại khác ở trên *@
                            @if (service.ServiceOptions != null && service.ServiceOptions.Any())
                            {
                                // Tách options thành 2 nhóm: không phải textarea và textarea
                                var regularOptions = service.ServiceOptions
                                    .Where(o => o.Type?.ToLower() != "textarea" && o.Type?.ToLower() != "text")
                                    .ToList();
                                var textareaOptions = service.ServiceOptions
                                    .Where(o => o.Type?.ToLower() == "textarea" || o.Type?.ToLower() == "text")
                                    .ToList();
                                
                                <div class="card-options">
                                    @* Hiển thị options thường trước *@
                                    @foreach (var opt in regularOptions)
                                    {
                                        <div class="card-option-item">
                                            <span class="option-icon">✓</span>
                                            <div class="option-content">
                                                @if (!string.IsNullOrWhiteSpace(opt.Value))
                                                {
                                                    <span class="option-name">@opt.OptionName<span class="text-muted"> (@opt.Value)</span></span>
                                                }
                                                else
                                                {
                                                    <span class="option-name">@opt.OptionName</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                    
                                    @* Hiển thị textarea options ở cuối *@
                                    @foreach (var opt in textareaOptions)
                                    {
                                        <div class="card-option-item option-item-textarea">
                                            <span class="option-icon">✓</span>
                                            <div class="option-content">
                                                @if (!string.IsNullOrWhiteSpace(opt.Value))
                                                {
                                                    @* Xử lý giá trị: split theo xuống dòng hoặc dấu gạch ngang *@
                                                    var valueLines = new List<string>();
                                                    
                                                    @* Kiểm tra xem có ký tự xuống dòng không *@
                                                    if (opt.Value.Contains('\n') || opt.Value.Contains('\r'))
                                                    {
                                                        @* Nếu có xuống dòng, split theo \n và \r *@
                                                        valueLines = opt.Value
                                                            .Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries)
                                                            .Select(v => v.Trim())
                                                            .Where(v => !string.IsNullOrWhiteSpace(v))
                                                            .ToList();
                                                    }
                                                    else
                                                    {
                                                        @* Nếu không có xuống dòng nhưng có dấu gạch ngang, split theo dấu gạch ngang *@
                                                        valueLines = opt.Value
                                                            .Split(new[] { " - ", " – ", "-", "–" }, StringSplitOptions.RemoveEmptyEntries)
                                                            .Select(v => v.Trim())
                                                            .Where(v => !string.IsNullOrWhiteSpace(v))
                                                            .ToList();
                                                    }
                                                    
                                                    @* Nếu có nhiều dòng, hiển thị OptionName trước, sau đó hiển thị các dòng Value *@
                                                    if (valueLines.Count > 1)
                                                    {
                                                        <span class="option-name">@opt.OptionName</span>
                                                        <div class="option-value">
                                                            @foreach (var line in valueLines)
                                                            {
                                                                <div>@line</div>
                                                            }
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        @* Nếu chỉ có một dòng, hiển thị OptionName (Value) *@
                                                        <span class="option-name">@opt.OptionName<span class="text-muted"> (@opt.Value)</span></span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="option-name">@opt.OptionName</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="card-no-options">Chưa có tùy chọn</div>
                            }

                            @* Meta info riêng biệt *@
                            @if (service.BaseUnit.HasValue && !string.IsNullOrWhiteSpace(service.UnitType))
                            {
                                <div class="card-meta-info">
                                    <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                        <path d="M12 6V12L16 14" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    <span>@service.BaseUnit @GetUnitTypeVietnamese(service.UnitType)</span>
                                </div>
                            }
                            else if (!string.IsNullOrWhiteSpace(service.UnitType))
                            {
                                <div class="card-meta-info">
                                    <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                        <path d="M12 6V12L16 14" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    <span>@GetUnitTypeVietnamese(service.UnitType)</span>
                                </div>
                            }

                            <div class="card-footer">
                                <div class="price-section">
                                    <span class="price-label">Giá chỉ</span>
                                    <span class="price-value">@priceDisplay</span>
                                </div>

                                <div class="rating-section">
                                    <div class="stars-row">
                                        @{
                                            for (int s = 1; s <= 5; s++)
                                            {
                                                var fill = Math.Max(0, Math.Min(1, avg - (s - 1)));
                                                var pct = (int)Math.Round(fill * 100);

                                                if (pct >= 100)
                                                {
                                                    <svg class="star filled" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                                    </svg>
                                                }
                                                else if (pct <= 0)
                                                {
                                                    <svg class="star" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                                    </svg>
                                                }
                                                else
                                                {
                                                    <svg class="star partial" viewBox="0 0 24 24">
                                                        <defs>
                                                            <linearGradient id="grad-@s-@service.ServiceId">
                                                                <stop offset="@pct%" stop-color="#fbbf24"/>
                                                                <stop offset="@pct%" stop-color="#e5e7eb"/>
                                                            </linearGradient>
                                                        </defs>
                                                        <path fill="url(#grad-@s-@service.ServiceId)" d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                                    </svg>
                                                }
                                            }
                                        }
                                    </div>
                                    <span class="rating-text">@avg.ToString("0.#") <span class="reviews-count">(@service.TotalReviews)</span></span>
                                </div>
                            </div>
                        </div>
                    </a>
                }
            </div>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <nav class="pagination-nav">
                    <div class="pagination-wrapper">
                        @if (currentPage > 1)
                        {
                            <a asp-action="Index" asp-route-page="1" asp-route-search="@search" asp-route-category="@category" asp-route-tag="@tag" asp-route-sort="@sort" class="page-btn page-first">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M18 17L13 12L18 7M11 17L6 12L11 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                            <a asp-action="Index" asp-route-page="@(currentPage - 1)" asp-route-search="@search" asp-route-category="@category" asp-route-tag="@tag" asp-route-sort="@sort" class="page-btn page-prev">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M15 18L9 12L15 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                        }

                        <div class="page-numbers">
                            @for (int i = startPage; i <= endPage; i++)
                            {
                                if (i == currentPage)
                                {
                                    <span class="page-number active">@i</span>
                                }
                                else
                                {
                                    <a asp-action="Index" asp-route-page="@i" asp-route-search="@search" asp-route-category="@category" asp-route-tag="@tag" asp-route-sort="@sort" class="page-number">@i</a>
                                }
                            }
                        </div>

                        @if (currentPage < totalPages)
                        {
                            <a asp-action="Index" asp-route-page="@(currentPage + 1)" asp-route-search="@search" asp-route-category="@category" asp-route-tag="@tag" asp-route-sort="@sort" class="page-btn page-next">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M9 18L15 12L9 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                            <a asp-action="Index" asp-route-page="@totalPages" asp-route-search="@search" asp-route-category="@category" asp-route-tag="@tag" asp-route-sort="@sort" class="page-btn page-last">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M6 17L11 12L6 7M13 17L18 12L13 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                        }
                    </div>
                    <div class="pagination-info">
                        Trang <strong>@currentPage</strong> / <strong>@totalPages</strong>
                    </div>
                </nav>
            }
        }
        </div>
    </div>
</section>

<link rel="stylesheet" href="~/css/services.css" asp-append-version="true" />

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const servicesResults = document.getElementById('servicesResults');
    const categorySelect = document.getElementById('categorySelect');
    const tagSelect = document.getElementById('tagSelect');
    const tagFilterGroup = document.getElementById('tagFilterGroup');
    const tagHiddenInput = document.getElementById('tagHiddenInput');
    
    // Handle tag button clicks
    document.addEventListener('click', function(e) {
        const tagButton = e.target.closest('.category-tag-item');
        if (!tagButton) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const tagId = tagButton.getAttribute('data-tag-id') || '';
        
        // Lấy categoryId từ dropdown chứa tag này
        const dropdown = tagButton.closest('.category-tag-dropdown');
        const categoryId = dropdown ? dropdown.getAttribute('data-category-id') : '';
        
        // Remove active class from all tag buttons trong tất cả dropdowns
        document.querySelectorAll('.category-tag-item').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked tag button
        tagButton.classList.add('active');
        
        // Update hidden input cho tag
        if (tagHiddenInput) {
            tagHiddenInput.value = tagId;
        }
        
        // Set category tương ứng nếu có
        if (categoryId && categorySelect) {
            categorySelect.value = categoryId;
            
            // Update active state của category chip
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            const categoryChip = document.querySelector(`.category-chip[data-category-id="${categoryId}"]`);
            if (categoryChip) {
                categoryChip.classList.add('active');
            }
        }
        
        // Auto-load services when tag is selected
        loadServices(1);
    });
    
    // Initialize tag dropdown for selected category on page load
    const currentTag = '@tag';
    if (categorySelect && categorySelect.value) {
        const selectedCategoryId = categorySelect.value;
        const selectedChip = document.querySelector(`.category-chip[data-category-id="${selectedCategoryId}"]`);
        if (selectedChip) {
            const categoryWrapper = selectedChip.closest('.category-chip-wrapper');
            const tagDropdown = categoryWrapper ? categoryWrapper.querySelector('.category-tag-dropdown') : null;
            const tagsList = tagDropdown ? tagDropdown.querySelector('.category-tags-list') : null;
            
            if (tagDropdown && tagsList && tagsList.children.length > 0) {
                // If tags are already loaded, just show the dropdown and set selected tag
                if (currentTag && currentTag !== '') {
                    tagsList.querySelectorAll('.category-tag-item').forEach(btn => {
                        if (btn.getAttribute('data-tag-id') === currentTag) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }
                tagDropdown.style.display = 'block';
                void tagDropdown.offsetHeight;
                tagDropdown.classList.add('show');
            } else if (selectedCategoryId) {
                // Load tags from API
                fetch(`/Services/GetTagsByCategory?categoryId=${selectedCategoryId}`)
                    .then(response => response.json())
                    .then(tags => {
                        if (tags && tags.length > 0 && tagsList) {
                            // Clear existing tags
                            tagsList.innerHTML = '';
                            
                            tags.forEach(tag => {
                                const tagButton = document.createElement('button');
                                tagButton.type = 'button';
                                tagButton.className = 'category-tag-item';
                                const tagId = (tag.tagId || tag.TagId).toString();
                                tagButton.setAttribute('data-tag-id', tagId);
                                tagButton.textContent = tag.name || tag.Name;
                                
                                // Check if this tag is selected
                                if (currentTag && currentTag === tagId) {
                                    tagButton.classList.add('active');
                                }
                                
                                tagsList.appendChild(tagButton);
                            });
                            
                            if (tagDropdown) {
                                tagDropdown.style.display = 'block';
                                void tagDropdown.offsetHeight;
                                tagDropdown.classList.add('show');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading tags on page load:', error);
                    });
            }
        }
    }
    
    // Hàm để đảm bảo tất cả provider section trong cùng hàng có cùng chiều cao
    function equalizeProviderHeights() {
        try {
            const providerSections = document.querySelectorAll('.provider-section-top');
            if (providerSections.length === 0) return;
            
            // Reset height để tính toán lại
            providerSections.forEach(section => {
                if (section && section.style) {
                    section.style.height = 'auto';
                }
            });
            
            // Đợi một chút để DOM render xong
            requestAnimationFrame(() => {
                try {
                    // Nhóm các section theo hàng dựa trên vị trí top
                    const rows = new Map();
                    providerSections.forEach(section => {
                        if (!section) return;
                        try {
                            const rect = section.getBoundingClientRect();
                            if (!rect) return;
                            const top = Math.round(rect.top);
                            
                            if (!rows.has(top)) {
                                rows.set(top, []);
                            }
                            rows.get(top).push(section);
                        } catch (e) {
                            console.warn('Error processing section:', e);
                        }
                    });
                    
                    // Đặt chiều cao bằng nhau cho mỗi hàng
                    rows.forEach(sections => {
                        if (!sections || sections.length === 0) return;
                        
                        let maxHeight = 0;
                        sections.forEach(section => {
                            if (!section) return;
                            try {
                                const rect = section.getBoundingClientRect();
                                if (rect && rect.height > maxHeight) {
                                    maxHeight = rect.height;
                                }
                            } catch (e) {
                                console.warn('Error calculating height:', e);
                            }
                        });
                        
                        // Áp dụng chiều cao cho tất cả section trong hàng
                        if (maxHeight > 0) {
                            sections.forEach(section => {
                                if (section && section.style) {
                                    section.style.height = maxHeight + 'px';
                                }
                            });
                        }
                    });
                } catch (e) {
                    console.error('Error in equalizeProviderHeights:', e);
                }
            });
        } catch (e) {
            console.error('Error in equalizeProviderHeights:', e);
        }
    }
    
    // Gọi hàm khi DOM ready và sau khi load services
    equalizeProviderHeights();
    
    // Gọi lại khi window resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(equalizeProviderHeights, 100);
    });
    
    // Handle category chip hover to show dropdown - mượt mà hơn
    let hoverTimeouts = new Map();
    
    document.querySelectorAll('.category-chip-wrapper').forEach(wrapper => {
        const categoryChip = wrapper.querySelector('.category-chip');
        const tagDropdown = wrapper.querySelector('.category-tag-dropdown');
        const tagsList = tagDropdown ? tagDropdown.querySelector('.category-tags-list') : null;
        const categoryId = categoryChip ? categoryChip.getAttribute('data-category-id') : '';
            
        // Hover vào category chip hoặc dropdown - hiển thị ngay lập tức
        wrapper.addEventListener('mouseenter', function() {
            // Clear timeout đóng nếu có
            if (hoverTimeouts.has(wrapper)) {
                clearTimeout(hoverTimeouts.get(wrapper));
                hoverTimeouts.delete(wrapper);
            }
            
            // Nếu là "Tất cả", không hiển thị dropdown
            if (!categoryId || !tagDropdown) {
                return;
            }
            
            // Nếu dropdown đã có tags, hiển thị ngay
            if (tagsList && tagsList.children.length > 0) {
                tagDropdown.style.display = 'block';
                // Force reflow để animation hoạt động
                requestAnimationFrame(() => {
                    tagDropdown.classList.add('show');
                });
                return;
            }
            
            // Load tags từ API nếu chưa có
            fetch(`/Services/GetTagsByCategory?categoryId=${categoryId}`)
                .then(response => response.json())
                .then(tags => {
                    if (tags && tags.length > 0 && tagsList) {
                        // Clear existing tags
                        tagsList.innerHTML = '';
                        
                        // Add tags as buttons
                        tags.forEach(tag => {
                            const tagButton = document.createElement('button');
                            tagButton.type = 'button';
                            tagButton.className = 'category-tag-item';
                            tagButton.setAttribute('data-tag-id', tag.tagId || tag.TagId);
                            tagButton.textContent = tag.name || tag.Name;
                            
                            // Check if this tag is selected
                            const currentTag = '@tag';
                            if (currentTag && currentTag === (tag.tagId || tag.TagId).toString()) {
                                tagButton.classList.add('active');
                            }
                            
                            tagsList.appendChild(tagButton);
                        });
                        
                        // Show dropdown với animation mượt
                        tagDropdown.style.display = 'block';
                        requestAnimationFrame(() => {
                            tagDropdown.classList.add('show');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading tags:', error);
                });
        });
        
        // Hover ra ngoài category wrapper - đóng mượt mà
        wrapper.addEventListener('mouseleave', function() {
            if (!tagDropdown) return;
            
            // Đóng với animation mượt
            tagDropdown.classList.remove('show');
            
            // Đợi animation xong rồi mới ẩn hoàn toàn
            const timeout = setTimeout(() => {
                tagDropdown.style.display = 'none';
                hoverTimeouts.delete(wrapper);
            }, 200); // Đợi 200ms cho animation fade-out hoàn thành
            
            hoverTimeouts.set(wrapper, timeout);
        });
    });
    
    // Handle category chip clicks để chọn category và load services
    document.addEventListener('click', function(e) {
        const categoryChip = e.target.closest('.category-chip');
        if (!categoryChip) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        // Remove active class from all chips
        document.querySelectorAll('.category-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        
        // Add active class to clicked chip
        categoryChip.classList.add('active');
        
        // Update hidden input
        const categoryId = categoryChip.getAttribute('data-category-id') || '';
        if (categorySelect) {
            categorySelect.value = categoryId;
        }
        
        // Reset tag khi chọn category mới
        if (tagHiddenInput) {
            tagHiddenInput.value = '';
        }
        
        // Load services với category đã chọn
        loadServices(1);
    });
    
    // Handle form submission
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loadServices(1);
        });
        
        // Auto-submit on select change - DISABLED
        // const selects = filterForm.querySelectorAll('select');
        // selects.forEach(select => {
        //     select.addEventListener('change', function() {
        //         loadServices(1);
        //     });
        // });
    }
    
    // Handle pagination clicks
    document.addEventListener('click', function(e) {
        const paginationLink = e.target.closest('.page-btn, .page-number');
        if (paginationLink && paginationLink.tagName === 'A') {
            e.preventDefault();
            const url = new URL(paginationLink.href);
            const page = url.searchParams.get('page') || 1;
            loadServices(page);
        }
    });
    
    function loadServices(page) {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        params.set('page', page);
        
        // Lấy tag value từ hidden input (đã được set khi click tag button)
        const tagValue = tagHiddenInput ? tagHiddenInput.value.trim() : '';
        
        // Đảm bảo tag được thêm vào params
        if (tagValue) {
            params.set('tag', tagValue);
        } else {
            params.delete('tag');
        }
        
        // Đảm bảo category được thêm vào params
        const categoryValue = categorySelect ? categorySelect.value.trim() : '';
        if (categoryValue) {
            params.set('category', categoryValue);
        } else {
            params.delete('category');
        }
        
        // Show loading state
        servicesResults.classList.add('loading');
        
        // Add loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="loading-spinner">
                <svg class="spinner-icon" viewBox="0 0 50 50">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="3"></circle>
                </svg>
                <span>Đang tải...</span>
            </div>
        `;
        servicesResults.appendChild(loadingDiv);
        
        fetch(`/Services/Index?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Kiểm tra lỗi parse
                const parseError = doc.querySelector('parsererror');
                if (parseError) {
                    throw new Error('Failed to parse HTML response');
                }
                
                const newResults = doc.getElementById('servicesResults');
                
                if (newResults && servicesResults) {
                    servicesResults.innerHTML = newResults.innerHTML;
                    servicesResults.classList.remove('loading');
                    
                    // Đảm bảo provider sections có cùng chiều cao sau khi load
                    // Tăng delay để đảm bảo images đã load xong
                    setTimeout(() => {
                        try {
                            equalizeProviderHeights();
                        } catch (e) {
                            console.warn('Error equalizing heights after load:', e);
                        }
                    }, 200);
                    
                    // Update URL without reload
                    try {
                        const newUrl = `/Services/Index?${params.toString()}`;
                        window.history.pushState({}, '', newUrl);
                    } catch (e) {
                        console.warn('Error updating URL:', e);
                    }
                    
                    // Smooth scroll to results only if not from form submit (from pagination)
                    if (page > 1) {
                        try {
                            servicesResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } catch (e) {
                            console.warn('Error scrolling:', e);
                        }
                    }
                } else {
                    throw new Error('Could not find servicesResults in response');
                }
            } catch (e) {
                console.error('Error processing response:', e);
                throw e;
            }
        })
        .catch(error => {
            console.error('Error loading services:', error);
            try {
                const loadingOverlay = servicesResults?.querySelector('.loading-overlay');
                if (loadingOverlay) loadingOverlay.remove();
                if (servicesResults) {
                    servicesResults.classList.remove('loading');
                    
                    // Hiển thị thông báo lỗi cho user
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-danger mt-3';
                    errorMsg.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Có lỗi xảy ra khi tải dịch vụ. Vui lòng thử lại.';
                    servicesResults.appendChild(errorMsg);
                    
                    // Tự động ẩn sau 5 giây
                    setTimeout(() => {
                        if (errorMsg.parentNode) {
                            errorMsg.remove();
                        }
                    }, 5000);
                }
            } catch (e) {
                console.error('Error handling error state:', e);
            }
        });
    }
});
</script>

@model List<VHS_frontend.Models.ServiceDTOs.ListServiceHomePageDTOs>

@{
    ViewData["Title"] = "Dịch vụ";
    string search = ViewBag.Search as string ?? "";
    string category = ViewBag.Category as string ?? "";
    string sort = ViewBag.Sort as string ?? "";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int startPage = Math.Max(1, currentPage - 2);
    int endPage = Math.Min(totalPages, currentPage + 2);

    string PriceToDisplay(decimal p) => $"{p:n0}đ";
    var fallbackImg = Url.Content("~/images/VeSinh.jpg");
}

@functions {
    string? FirstImageOrDefault(string? images)
    {
        if (string.IsNullOrWhiteSpace(images)) return null;

        try
        {
            var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(images);
            if (arr != null && arr.Count > 0) return arr[0];
        }
        catch { /* ignore JSON parse error */ }

        if (images.Contains(','))
        {
            var first = images.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                              .FirstOrDefault();
            if (!string.IsNullOrWhiteSpace(first)) return first;
        }
        return images;
    }

    // Hàm chuyển đổi UnitType sang tiếng Việt
    string GetUnitTypeVietnamese(string? unitType)
    {
        if (string.IsNullOrEmpty(unitType)) return unitType ?? "";
        return unitType switch
        {
            "Hour" => "Giờ",
            "Day" => "Ngày",
            "Visit" => "Lần",
            "Apartment" => "Căn",
            "Room" => "Phòng",
            "SquareMeter" => "Mét vuông (m²)",
            "Person" => "Người",
            "Package" => "Gói",
            "Event" => "Sự kiện",
            _ => unitType
        };
    }
}

<section class="services-hero-section">
    <div class="services-hero-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    
    <div class="services-container">
        <!-- Hero Header - Revolutionary Design -->
        <div class="services-hero-header">
            <!-- Floating Particles Background -->
            <div class="hero-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            
            <!-- Animated Badge -->
            <div class="hero-badge-wrapper">
                <span class="hero-badge">
                    <span class="badge-glow"></span>
                    <svg class="badge-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="badge-text">Dịch vụ uy tín • Chất lượng hàng đầu</span>
                </span>
            </div>
            
            <!-- 3D Title Effect -->
            <h1 class="hero-title">
                <span class="title-line">Khám phá</span>
                <span class="title-line grad-text-3d">dịch vụ chất lượng cao</span>
                <span class="title-line">cho ngôi nhà thông minh của bạn</span>
            </h1>
            
            <!-- Animated Description -->
            <p class="hero-description">
                <span class="desc-highlight">Tìm kiếm và đặt dịch vụ phù hợp với nhu cầu của bạn một cách nhanh chóng và tiện lợi.</span><br/>
                <span class="hero-features">
                    <span class="feature-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Minh bạch về giá
                    </span>
                    <span class="feature-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Đặt dịch vụ nhanh chóng
                    </span>
                    <span class="feature-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Đáng tin cậy & uy tín
                    </span>
                </span>
            </p>
        </div>

        <!-- Advanced Filter -->
        <form method="get" asp-action="Index" class="services-filter-card" id="filterForm">
            <div class="filter-header">
                <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M22 3H2L10 12.46V19L14 21V12.46L22 3Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>Tìm kiếm dịch vụ</h3>
            </div>
            
            <div class="filter-grid">
                <div class="filter-input-group">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="11" cy="11" r="8" stroke-width="2"/>
                            <path d="M21 21L16.65 16.65" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Tìm kiếm
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="search" value="@search" 
                               placeholder="Nhập tên dịch vụ hoặc từ khóa..." 
                               class="filter-input" />
                    </div>
                </div>

                <div class="filter-input-group">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M4 4H20V6H4V4ZM7 9H17V11H7V9ZM10 14H14V16H10V14Z" fill="currentColor"/>
                        </svg>
                        Danh mục
                    </label>
                    <div class="select-wrapper">
                        <select name="category" class="filter-select">
                            <option value="">Tất cả danh mục</option>
                            @if (ViewBag.Categories is IEnumerable<VHS_frontend.Areas.Admin.Models.Category.CategoryDTO> categories)
                            {
                                foreach (var cat in categories)
                                {
                                    <option value="@cat.CategoryId" selected="@(category == cat.CategoryId.ToString())">
                                        @cat.Name
                                    </option>
                                }
                            }
                        </select>
                        <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>

                <div class="filter-input-group">
                    <label class="filter-label">
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 2V6M12 18V22M4.93 4.93L7.76 7.76M16.24 16.24L19.07 19.07M2 12H6M18 12H22M4.93 19.07L7.76 16.24M16.24 7.76L19.07 4.93" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Sắp xếp
                    </label>
                    <div class="select-wrapper">
                        <select name="sort" class="filter-select">
                            <option value="">Mặc định</option>
                            <option value="price-500" selected="@(sort == "price-500")">Dưới 500K</option>
                            <option value="price-500-1000" selected="@(sort == "price-500-1000")">500K - 1M</option>
                            <option value="price-1000-5000" selected="@(sort == "price-1000-5000")">1M - 5M</option>
                            <option value="price-5000" selected="@(sort == "price-5000")">Trên 5M</option>
                            <option value="stars" selected="@(sort == "stars")">⭐ Đánh giá cao nhất</option>
                        </select>
                        <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M6 9L12 15L18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>

                <button type="submit" class="filter-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span>Tìm kiếm</span>
                    <div class="btn-shine"></div>
                </button>
            </div>
        </form>

        <!-- Services Grid -->
        <div id="servicesResults">
        @if (Model == null || !Model.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21L16.65 16.65"/>
                        <path d="M11 8v6M8 11h6" stroke-width="2"/>
                    </svg>
                </div>
                <h3>Không tìm thấy dịch vụ phù hợp</h3>
                <p>Vui lòng thử điều chỉnh bộ lọc hoặc từ khóa tìm kiếm để khám phá thêm nhiều dịch vụ hấp dẫn khác</p>
            </div>
        }
        else
        {
            <div class="services-grid">
                @foreach (var service in Model)
                {
                    var img = FirstImageOrDefault(service.Images) ?? fallbackImg;
                    var priceDisplay = PriceToDisplay(service.Price);
                    var avg = service.AverageRating;

                        <a asp-area="" asp-controller="Services" asp-action="Details" asp-route-id="@service.ServiceId" class="service-card">

                        <div class="card-image-container">
                            <div class="image-wrapper">
                                <img src="@img"
                                     alt="@service.Title"
                                     class="card-image"
                                     loading="lazy"
                                     onerror="this.onerror=null;this.src='@fallbackImg';" />
                                <div class="image-overlay"></div>
                            </div>
                            
                            @if (!string.IsNullOrWhiteSpace(service.CategoryName))
                            {
                                <div class="card-category-badge">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M20.59 13.41L13.42 20.58C13.2343 20.766 13.0137 20.9135 12.7709 21.0141C12.5281 21.1148 12.2678 21.1666 12.005 21.1666C11.7422 21.1666 11.4819 21.1148 11.2391 21.0141C10.9963 20.9135 10.7757 20.766 10.59 20.58L2 12V2H12L20.59 10.59C20.9625 10.9647 21.1716 11.4716 21.1716 12C21.1716 12.5284 20.9625 13.0353 20.59 13.41Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="7" cy="7" r="1.5" fill="currentColor"/>
                                    </svg>
                                    <span>@service.CategoryName</span>
                                </div>
                            }
                            
                            @if (avg >= 4.5)
                            {
                                <div class="trending-badge">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M13 10V3L4 14H11L11 21L20 10L13 10Z"/>
                                    </svg>
                                    <span>HOT</span>
                                </div>
                            }
                        </div>

                        <div class="card-content">
                            <h3 class="card-title">@service.Title</h3>

                            @* Hiển thị tùy chọn giống ServiceShop *@
                            @if (service.ServiceOptions != null && service.ServiceOptions.Any())
                            {
                                <div class="card-options">
                                    @foreach (var opt in service.ServiceOptions.Take(3))
                                    {
                                        var isTextarea = opt.Type?.ToLower() == "textarea" || opt.Type?.ToLower() == "text";
                                        <div class="card-option-item @(isTextarea ? "option-item-textarea" : "")">
                                            <span class="option-icon">✓</span>
                                            <div class="option-content">
                                                <span class="option-name">@opt.OptionName</span>
                                                @if (!string.IsNullOrWhiteSpace(opt.Value) && isTextarea)
                                                {
                                                    <div class="option-value">@opt.Value</div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    @if (service.ServiceOptions.Count > 3)
                                    {
                                        <div class="card-option-more">+@(service.ServiceOptions.Count - 3) khác</div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="card-no-options">Chưa có tùy chọn</div>
                            }

                            @* Meta info riêng biệt *@
                            // @if (service.BaseUnit.HasValue && !string.IsNullOrWhiteSpace(service.UnitType))
                            // {
                            //     <div class="card-meta-info">
                            //         <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            //             <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            //             <path d="M12 6V12L16 14" stroke-width="2" stroke-linecap="round"/>
                            //         </svg>
                            //         <span>@service.BaseUnit @GetUnitTypeVietnamese(service.UnitType)</span>
                            //     </div>
                            // }
                            // else if (!string.IsNullOrWhiteSpace(service.UnitType))
                            // {
                            //     <div class="card-meta-info">
                            //         <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            //             <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            //             <path d="M12 6V12L16 14" stroke-width="2" stroke-linecap="round"/>
                            //         </svg>
                            //         <span>@GetUnitTypeVietnamese(service.UnitType)</span>
                            //     </div>
                            // } 

                            <div class="card-footer">
                                <div class="price-section">
                                    <span class="price-label">Giá chỉ</span>
                                    <span class="price-value">@priceDisplay</span>
                                </div>

                                <div class="rating-section">
                                    <div class="stars-row">
                                        @{
                                            for (int s = 1; s <= 5; s++)
                                            {
                                                var fill = Math.Max(0, Math.Min(1, avg - (s - 1)));
                                                var pct = (int)Math.Round(fill * 100);

                                                if (pct >= 100)
                                                {
                                                    <svg class="star filled" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                                    </svg>
                                                }
                                                else if (pct <= 0)
                                                {
                                                    <svg class="star" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                                    </svg>
                                                }
                                                else
                                                {
                                                    <svg class="star partial" viewBox="0 0 24 24">
                                                        <defs>
                                                            <linearGradient id="grad-@s-@service.ServiceId">
                                                                <stop offset="@pct%" stop-color="#fbbf24"/>
                                                                <stop offset="@pct%" stop-color="#e5e7eb"/>
                                                            </linearGradient>
                                                        </defs>
                                                        <path fill="url(#grad-@s-@service.ServiceId)" d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                                    </svg>
                                                }
                                            }
                                        }
                                    </div>
                                    <span class="rating-text">@avg.ToString("0.#") <span class="reviews-count">(@service.TotalReviews)</span></span>
                                </div>
                                
                                @if (!string.IsNullOrWhiteSpace(service.ProviderName))
                                {
                                    <div class="provider-section">
                                        <svg class="provider-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke-width="2" stroke-linecap="round"/>
                                            <circle cx="12" cy="7" r="4" stroke-width="2"/>
                                        </svg>
                                        <span class="provider-name">@service.ProviderName</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </a>
                }
            </div>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <nav class="pagination-nav">
                    <div class="pagination-wrapper">
                        @if (currentPage > 1)
                        {
                            <a asp-action="Index" asp-route-page="1" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-btn page-first">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M18 17L13 12L18 7M11 17L6 12L11 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                            <a asp-action="Index" asp-route-page="@(currentPage - 1)" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-btn page-prev">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M15 18L9 12L15 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                        }

                        <div class="page-numbers">
                            @for (int i = startPage; i <= endPage; i++)
                            {
                                if (i == currentPage)
                                {
                                    <span class="page-number active">@i</span>
                                }
                                else
                                {
                                    <a asp-action="Index" asp-route-page="@i" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-number">@i</a>
                                }
                            }
                        </div>

                        @if (currentPage < totalPages)
                        {
                            <a asp-action="Index" asp-route-page="@(currentPage + 1)" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-btn page-next">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M9 18L15 12L9 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                            <a asp-action="Index" asp-route-page="@totalPages" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-btn page-last">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M6 17L11 12L6 7M13 17L18 12L13 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                        }
                    </div>
                    <div class="pagination-info">
                        Trang <strong>@currentPage</strong> / <strong>@totalPages</strong>
                    </div>
                </nav>
            }
        }
        </div>
    </div>
</section>

<link rel="stylesheet" href="~/css/services.css" asp-append-version="true" />

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const servicesResults = document.getElementById('servicesResults');
    
    // Handle form submission
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loadServices(1);
        });
        
        // Auto-submit on select change - DISABLED
        // const selects = filterForm.querySelectorAll('select');
        // selects.forEach(select => {
        //     select.addEventListener('change', function() {
        //         loadServices(1);
        //     });
        // });
    }
    
    // Handle pagination clicks
    document.addEventListener('click', function(e) {
        const paginationLink = e.target.closest('.page-btn, .page-number');
        if (paginationLink && paginationLink.tagName === 'A') {
            e.preventDefault();
            const url = new URL(paginationLink.href);
            const page = url.searchParams.get('page') || 1;
            loadServices(page);
        }
    });
    
    function loadServices(page) {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        params.set('page', page);
        
        // Show loading state
        servicesResults.classList.add('loading');
        
        // Add loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="loading-spinner">
                <svg class="spinner-icon" viewBox="0 0 50 50">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="3"></circle>
                </svg>
                <span>Đang tải...</span>
            </div>
        `;
        servicesResults.appendChild(loadingDiv);
        
        fetch(`/Services/Index?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newResults = doc.getElementById('servicesResults');
            
            if (newResults) {
                servicesResults.innerHTML = newResults.innerHTML;
                servicesResults.classList.remove('loading');
                
                // Update URL without reload
                const newUrl = `/Services/Index?${params.toString()}`;
                window.history.pushState({}, '', newUrl);
                
                // Smooth scroll to results only if not from form submit (from pagination)
                if (page > 1) {
                    servicesResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        })
        .catch(error => {
            console.error('Error loading services:', error);
            const loadingOverlay = servicesResults.querySelector('.loading-overlay');
            if (loadingOverlay) loadingOverlay.remove();
            servicesResults.classList.remove('loading');
        });
    }
});
</script>

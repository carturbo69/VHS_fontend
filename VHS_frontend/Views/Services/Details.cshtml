@using VHS_frontend.Areas.Customer.Models.ReviewDTOs
@using VHS_frontend.Areas.Customer.Models.ReviewDTOs
@using VHS_frontend.Models.ServiceDTOs
@model ServiceDetailDTOs

@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Helpers
    Func<string?, string[]> SplitImgs = s =>
        string.IsNullOrWhiteSpace(s)
            ? Array.Empty<string>()
            : s.Split(',', StringSplitOptions.RemoveEmptyEntries)
               .Select(x => x.Trim())
               .Where(x => !string.IsNullOrWhiteSpace(x))
               .ToArray();

    var fallbackImg = Url.Content("~/images/VeSinh.jpg");

    string FallbackByUnit(string? unit) =>
        (unit ?? "").Trim() switch
        {
            "Nội trợ" => Url.Content("~/images/NoiTro.jpg"),
            "Sự kiện nhỏ tại nhà" => Url.Content("~/images/SuKienNho.jpg"),
            _ => Url.Content("~/images/VeSinh.jpg")
        };

    // Hàm chuyển đổi UnitType sang tiếng Việt
    string GetUnitTypeVietnamese(string? unitType)
    {
        if (string.IsNullOrEmpty(unitType)) return unitType ?? "";
        return unitType switch
        {
            "Hour" => "Giờ",
            "Day" => "Ngày",
            "Visit" => "Lần",
            "Apartment" => "Căn",
            "Room" => "Phòng",
            "SquareMeter" => "Mét vuông (m²)",
            "Person" => "Người",
            "Package" => "Gói",
            "Event" => "Sự kiện",
            _ => unitType
        };
    }

    // Ảnh chính
    var imgs = SplitImgs(Model.Images);
    string fallbackMain = FallbackByUnit(Model.UnitType);
    string mainSrc = imgs.Length > 0 ? Url.Content(imgs[0]) : fallbackMain;

}

<link rel="stylesheet" href="~/css/service-detail.css" asp-append-version="true" />

<section class="service-detail">
    <div class="container-xl">
        <!-- Breadcrumb -->
        <nav class="breadcrumb" aria-label="breadcrumb">
            <a asp-controller="Home" asp-action="Index">Trang chủ</a> /
            <a asp-controller="Services" asp-action="Index">Dịch vụ</a> /
            <span class="current">@Model.Title</span>
        </nav>

        <div class="detail-grid">
            <!-- LEFT: GALLERY -->
            <div class="gallery-column">
                <div class="gallery">
                    <div class="gallery-main">
                        <img id="mainImage" src="@mainSrc" alt="@Model.Title" data-fallback="@fallbackImg" />
                    </div>

                    <div class="thumbs" id="thumbs">
                        @if (imgs.Any())
                        {
                            foreach (var img in imgs)
                            {
                                var src = string.IsNullOrWhiteSpace(img) ? fallbackMain : Url.Content(img);
                                <button type="button" class="thumb" data-src="@src" title="Xem ảnh">
                                    <img src="@src" alt="@Model.Title" data-fallback="@fallbackImg" />
                                </button>
                            }
                        }
                        else
                        {
                            var thumb = fallbackMain;
                            for (int i = 0; i < 5; i++)
                            {
                                <button type="button" class="thumb" data-src="@thumb" title="Xem ảnh">
                                    <img src="@thumb" alt="@Model.Title" />
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- RIGHT: INFO -->
            <div class="info-column">
                <div class="info">
                    <h1 class="title">@Model.Title</h1>

                    <div class="price">
                        @string.Format("{0:#,0}đ", Model.Price)
                        @if (!string.IsNullOrWhiteSpace(Model.UnitType))
                        {
                            <text>/ @GetUnitTypeVietnamese(Model.UnitType)</text>
                        }
                    </div>

                    <div class="rating-row">
                        <span class="stars">
                            @{
                                var avg = Model.AverageRating;
                                for (int s = 1; s <= 5; s++)
                                {
                                    var fill = Math.Max(0, Math.Min(1, avg - (s - 1)));
                                    var pct = (int)Math.Round(fill * 100);
                                    if (pct >= 100)
                                    {
                                        <span class="star filled">★</span>
                                        ;
                                    }
                                    else if (pct <= 0)
                                    {

                                        <span class="star">★</span>
                                        ;
                                    }
                                    else
                                    {

                                        <span class="star frac" style="--p:@pct%;">★</span>
                                        ;
                                    }
                                }
                            }
                        </span>
                        <span class="rating-text">@Model.AverageRating.ToString("0.#") / 5 (@Model.TotalReviews đánh giá)</span>
                    </div>

                    <ul class="brief">
                        <li><strong>Danh mục:</strong> @Model.CategoryName</li>
                        <!-- @if (Model.Tags != null && Model.Tags.Any())
                        {
                            <li>
                                <strong>Tags:</strong>
                                <div class="service-tags">
                                    @foreach (var tag in Model.Tags)
                                    {
                                        <span class="tag-badge">@tag.Name</span>
                                    }
                                </div>
                            </li>
                        } -->
                        <li>
                            <strong>Loại:</strong>
                            @if (Model.BaseUnit.HasValue)
                            {
                                @($"{Model.BaseUnit} {GetUnitTypeVietnamese(Model.UnitType)}")
                            }
                            else
                            {
                                @GetUnitTypeVietnamese(Model.UnitType)
                            }
                        </li>
                    </ul>

                    <!-- CHỈ CÒN 1 KHỐI TÙY CHỌN BÊN TRONG FORM -->
                    <form asp-area="Customer"
                          asp-controller="Cart"
                          asp-action="AddToCart"
                          method="post"
                          id="cartForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="serviceId" value="@Model.ServiceId" />

                        @if (Model.ServiceOptions?.Any() == true)
                        {
                            <section class="svc-options">
                                <h3 class="addons-title">
                                    <span class="title-icon">✨</span>
                                    Tùy chọn đã bao gồm
                                </h3>
                                <div class="addons-list">
                                    @* Hiển thị danh sách options phẳng (không có nhóm) cho Customer *@
                                    @foreach (var o in Model.ServiceOptions)
                                    {
                                        <div class="addon-item">
                                            <div class="option-body">
                                                <div class="option-head">
                                                    <div class="addon-name">
                                                        <span class="addon-icon">✓</span>
                                                        <span class="fw-semibold">@o.OptionName</span>
                                                    </div>
                                                </div>
                                                @if (!string.IsNullOrWhiteSpace(o.Value))
                                                {
                                                    <div class="addon-desc">
                                                        @if (o.Type?.ToLower() == "textarea" || o.Type?.ToLower() == "text")
                                                        {
                                                            <div class="addon-value-text">@o.Value</div>
                                                        }
                                                        else
                                                        {
                                                            <span class="addon-value">@o.Value</span>
                                                        }
                                                    </div>
                                                }
                                                else if (o.Type?.ToLower() == "textarea" || o.Type?.ToLower() == "text")
                                                {
                                                    <div class="addon-desc addon-empty">
                                                        <i class="bi bi-info-circle me-1"></i>Chưa có giá trị
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                                
                                @* Tự động thêm tất cả options vào form *@
                                @foreach (var o in Model.ServiceOptions)
                                {
                                    <input type="hidden" name="optionIds" value="@o.OptionId" />
                                }
                                
                                @* Hidden input để lưu OptionValues dưới dạng JSON *@
                                <input type="hidden" name="optionValuesJson" id="optionValuesJson" value="" />
                            </section>
                        }

                        <div class="actions">
                            <button type="submit" class="btn btn-cart" onclick="prepareOptionValues()">Thêm vào giỏ hàng</button>
                            <button type="submit"
                                    class="btn btn-buy"
                                    formaction="@(Url.Action("StartDirect","BookingService", new { area="Customer" }))"
                                    formmethod="post">
                                Đặt ngay
                            </button>
                        </div>
                    </form>

                    <div class="safety">
                        <div class="safety-item">
                            <span class="safety-icon">🛡️</span>
                            <span class="safety-text">Bảo hành theo chính sách</span>
                        </div>
                        <div class="safety-item">
                            <span class="safety-icon">📅</span>
                            <span class="safety-text">Lịch hẹn linh hoạt</span>
                        </div>
                        <div class="safety-item">
                            <span class="safety-icon">💳</span>
                            <span class="safety-text">Thanh toán an toàn</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- PROVIDER / SHOP CARD -->
        @{
            var p = Model.Provider ?? new ProviderSummaryDTOs();
            var providerImgs = SplitImgs(p.Images);
            var providerLogo = providerImgs.FirstOrDefault() ?? Url.Content("~/images/VeSinh.jpg");
            // QUAN TRỌNG: Ưu tiên dùng Model.ProviderId (từ service) thay vì Model.Provider.ProviderId
            var providerIdToUse = Model.ProviderId != Guid.Empty ? Model.ProviderId : p.ProviderId;
        }
        <section class="provider-section">
            <div class="provider-card provider--split">
                <!-- LEFT -->
                <div class="provider-left">
                    <img class="provider-logo" src="@providerLogo" alt="Logo nhà cung cấp" data-fallback="@fallbackImg" />
                    <div class="provider-meta">
                        <h3 class="provider-name">@(!string.IsNullOrWhiteSpace(p.ProviderName) ? p.ProviderName : "Đối tác VHS")</h3>
                        <div class="provider-online">Online gần đây</div>
                        <div class="provider-actions">
                           

                            @if (providerIdToUse != Guid.Empty)
                            {
                                <a asp-controller="ServiceShop" asp-action="Index" asp-route-providerId="@providerIdToUse" class="btn btn-ghost">🏬 Xem shop</a>
                            }
                            else
                            {
                                <button class="btn btn-ghost" disabled title="Thiếu ProviderId">🏬 Xem shop</button>
                            }

                   
                            <a class="btn btn-outline"
                               asp-area="Customer"
                               asp-controller="ChatCustomer"
                               asp-action="WithProvider"
                               asp-route-providerId="@providerIdToUse">
                                💬 Chat ngay
                            </a>

                        
                        </div>
                    </div>
                </div>

                <div class="provider-divider" role="presentation"></div>

                <!-- RIGHT -->
                <div class="provider-right">
                    <div class="stat-pair">
                        <span class="label">Đánh giá dịch vụ</span>
                        <span class="value">@Model.TotalReviews.ToString("n0")</span>
                    </div>
                    <div class="stat-pair">
                        <span class="label">Tỉ lệ phản hồi</span>
                        <span class="value">100%</span>
                    </div>
                    <div class="stat-pair">
                        <span class="label">Tham gia</span>
                        <span class="value">@((p.JoinedAt?.ToString("MM/yyyy")) ?? "—")</span>
                    </div>

                    <div class="stat-pair">
                        <span class="label">Dịch vụ</span>
                        <span class="value">@p.TotalServices.ToString("n0")</span>
                    </div>
                    <div class="stat-pair">
                        <span class="label">Đánh giá trung bình</span>
                        <span class="value">@p.AverageRatingAllServices.ToString("0.#")/5</span>
                    </div>
                </div>
            </div>
        </section>


        @* ===== KHUNG BỐ CỤC HỢP NHẤT: Trái = DESC + REVIEWS (xếp dọc), Phải = Top 4 (sticky, render 1 lần) ===== *@
        <section class="svc-detail-grid">
            <!-- CỘT TRÁI: DESC + REVIEWS xếp dọc -->
            <div class="svc-left-col">

                <!-- === SERVICE DESCRIPTION (block riêng) ======================== -->
                <section class="desc-section" id="desc">
                    <article class="desc-card" id="descCard">
                        <div class="desc-header">Mô tả dịch vụ</div>
                        <div class="desc-content description-text" id="descContent">
                            @Html.Raw(Model.Description)
                        </div>
                        <button type="button" class="btn-toggle" id="descToggle" hidden>Xem thêm</button>
                    </article>
                </section>

                @{
                    // ==== REVIEWS / FILTER =====
                    var httpReq = ViewContext?.HttpContext?.Request;
                    string qPage = httpReq?.Query["rpage"];
                    string qStar = httpReq?.Query["rstar"];
                    string qMedia = httpReq?.Query["rmedia"];

                    int rpage = 1; int tmp;
                    if (int.TryParse(qPage, out tmp)) rpage = Math.Max(1, tmp);

                    int rstar = 0; // 0 = tất cả, 1..5
                    int.TryParse(qStar, out rstar);
                    bool onlyMedia = !string.IsNullOrWhiteSpace(qMedia) &&
                    (qMedia == "1" || qMedia.Equals("true", StringComparison.OrdinalIgnoreCase));

                    const int rPageSize = 5;

                    Func<int?, int> Bucket = s =>
                    {
                        var v = s ?? 0;
                        if (v < 1) v = 1; else if (v > 5) v = 5;
                        return v;
                    };

                    Func<List<string>, bool> HasMedia = imgs =>
                    imgs != null && imgs.Any(x => !string.IsNullOrWhiteSpace(x));

                    var allReviews = Model.Reviews ?? new List<ReadReviewDTOs>();
                    int n1 = allReviews.Count(x => Bucket(x.Rating) == 1);
                    int n2 = allReviews.Count(x => Bucket(x.Rating) == 2);
                    int n3 = allReviews.Count(x => Bucket(x.Rating) == 3);
                    int n4 = allReviews.Count(x => Bucket(x.Rating) == 4);
                    int n5 = allReviews.Count(x => Bucket(x.Rating) == 5);
                    int nPic = allReviews.Count(x => HasMedia(x.Images));

                    IEnumerable<ReadReviewDTOs> filtered = allReviews;
                    if (onlyMedia)
                        filtered = filtered.Where(x => HasMedia(x.Images));
                    else if (rstar >= 1 && rstar <= 5)
                        filtered = filtered.Where(x => Bucket(x.Rating) == rstar);

                    int rTotal = filtered.Count();
                    int rTotalPages = Math.Max(1, (int)Math.Ceiling(rTotal / (double)rPageSize));
                    if (rpage > rTotalPages) rpage = rTotalPages;

                    var pageReviews = filtered
                    .OrderByDescending(x => x.CreatedAt ?? DateTime.MinValue)
                    .Skip((rpage - 1) * rPageSize)
                    .Take(rPageSize)
                    .ToList();

                    Func<int, string> K = n => n >= 1000 ? (n / 1000.0).ToString("0.#") + "k" : n.ToString();
                }

                <section class="reviews-section" id="reviews">
                    <div class="reviews-card">
                        <h3 class="reviews-title">Đánh giá dịch vụ</h3>

                        <div class="reviews-header">
                            <div class="reviews-score">
                                <div class="score-number">
                                    <span>@Model.AverageRating.ToString("0.#")</span>
                                    <small>trên 5</small>
                                </div>
                                <div class="score-stars">
                                    <span class="stars">
                                        @{
                                            var avgScore = Model.AverageRating;
                                            for (int i = 1; i <= 5; i++)
                                            {
                                                var fill = Math.Max(0, Math.Min(1, avgScore - (i - 1)));
                                                var pct = (int)Math.Round(fill * 100);
                                                if (pct >= 100)
                                                {
                                                    <span class="star filled">★</span>
                                                    ;
                                                }
                                                else if (pct <= 0)
                                                {

                                                    <span class="star">★</span>
                                                    ;
                                                }
                                                else
                                                {

                                                    <span class="star frac" style="--p:@pct%;">★</span>
                                                    ;
                                                }
                                            }
                                        }
                                    </span>
                                    <div class="score-count">@rTotal đánh giá</div>
                                </div>
                            </div>

                            <div class="reviews-filters">
                                <a class="rv-chip @(rstar==0 && !onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId"
                                   asp-fragment="reviews">Tất cả</a>

                                <a class="rv-chip @(rstar==5 && !onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId" asp-route-rstar="5"
                                   asp-fragment="reviews">5 sao (@K(n5))</a>

                                <a class="rv-chip @(rstar==4 && !onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId" asp-route-rstar="4"
                                   asp-fragment="reviews">4 sao (@K(n4))</a>

                                <a class="rv-chip @(rstar==3 && !onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId" asp-route-rstar="3"
                                   asp-fragment="reviews">3 sao (@K(n3))</a>

                                <a class="rv-chip @(rstar==2 && !onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId" asp-route-rstar="2"
                                   asp-fragment="reviews">2 sao (@K(n2))</a>

                                <a class="rv-chip @(rstar==1 && !onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId" asp-route-rstar="1"
                                   asp-fragment="reviews">1 sao (@K(n1))</a>

                                <a class="rv-chip @(onlyMedia ? "active" : "")"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.ServiceId"
                                   asp-route-rmedia="1"
                                   asp-fragment="reviews">Có hình ảnh / video (@K(nPic))</a>
                            </div>
                        </div>

                        <!-- List -->
                        <div class="reviews-list">
                            @if (!pageReviews.Any())
                            {
                                <div class="reviews-empty">Chưa có đánh giá.</div>
                            }
                            else
                            {
                                foreach (var rv in pageReviews)
                                {
                                    var photos = (rv.Images ?? new List<string>())
                                    .Where(x => !string.IsNullOrWhiteSpace(x))
                                    .Select(x => Url.Content(x))
                                    .ToArray();
                                    var fullStars = Math.Max(1, Math.Min(5, rv.Rating ?? 0));

                                    <article class="review-item">
                                        @{
                                            // Avatar từ backend đã có full URL, nếu không có thì dùng fallback
                                            var userAvatar = !string.IsNullOrWhiteSpace(rv.Avatar) 
                                                ? rv.Avatar 
                                                : fallbackImg;
                                        }
                                        <img class="rv-avatar" src="@userAvatar" alt="@(!string.IsNullOrWhiteSpace(rv.FullName) ? rv.FullName : "Người dùng")" data-fallback="@fallbackImg" />
                                        <div class="rv-body">
                                            <div class="rv-head">
                                                <strong class="rv-user">@(!string.IsNullOrWhiteSpace(rv.FullName) ? rv.FullName : "Người dùng ẩn danh")</strong>
                                                <span class="rv-stars">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        if (i <= fullStars)
                                                        {
                                                            <span class="star filled">★</span>
                                                            ;
                                                        }
                                                        else
                                                        {

                                                            <span class="star">★</span>
                                                            ;
                                                        }
                                                    }
                                                </span>
                                            </div>

                                            <div class="rv-meta">
                                                @(rv.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "")
                                            </div>

                                            @if (!string.IsNullOrWhiteSpace(rv.Comment))
                                            {
                                                <p class="rv-content">@rv.Comment</p>
                                            }

                                            @if (photos.Any())
                                            {
                                                <div class="rv-photos">
                                                    @foreach (var photo in photos)
                                                    {
                                                        <img src="@photo" alt="Hình đánh giá" data-fallback="@fallbackImg" />
                                                    }
                                                </div>
                                            }

                                            @if (!string.IsNullOrWhiteSpace(rv.Reply))
                                            {
                                                <div class="rv-reply">
                                                    <div class="rv-reply-head">
                                                        <span class="rv-reply-icon">↩</span>
                                                        <strong>Phản hồi</strong>
                                                        <small class="rv-reply-meta">Từ nhà cung cấp</small>
                                                    </div>
                                                    <div class="rv-reply-content">
                                                        @rv.Reply
                                                    </div>
                                                </div>
                                            }

                                        </div>
                                    </article>
                                }
                            }
                        </div>

                        <!-- Pagination -->
                        @if (rTotal > rPageSize)
                        {
                            <div class="rv-pagination">
                                @if (rpage > 1)
                                {
                                    <a class="rv-page"
                                       asp-controller="Services" asp-action="Details"
                                       asp-route-id="@Model.ServiceId"
                                       asp-route-rpage="@(rpage - 1)"
                                       asp-route-rstar="@(onlyMedia ? null : (rstar==0 ? null : rstar))"
                                       asp-route-rmedia="@(onlyMedia ? "1" : null)"
                                       asp-fragment="reviews">‹</a>
                                }
                                @for (int pageIndex = 1; pageIndex <= rTotalPages; pageIndex++)
                                {
                                    if (pageIndex == rpage)
                                    {
                                        <span class="rv-page active">@pageIndex</span>
                                    }
                                    else
                                    {
                                        <a class="rv-page"
                                           asp-controller="Services" asp-action="Details"
                                           asp-route-id="@Model.ServiceId"
                                           asp-route-rpage="@pageIndex"
                                           asp-route-rstar="@(onlyMedia ? null : (rstar==0 ? null : rstar))"
                                           asp-route-rmedia="@(onlyMedia ? "1" : null)"
                                           asp-fragment="reviews">@pageIndex</a>
                                    }
                                }
                                @if (rpage < rTotalPages)
                                {
                                    <a class="rv-page"
                                       asp-controller="Services" asp-action="Details"
                                       asp-route-id="@Model.ServiceId"
                                       asp-route-rpage="@(rpage + 1)"
                                       asp-route-rstar="@(onlyMedia ? null : (rstar==0 ? null : rstar))"
                                       asp-route-rmedia="@(onlyMedia ? "1" : null)"
                                       asp-fragment="reviews">›</a>
                                }
                            </div>
                        }
                    </div>

                    <!-- Lightbox -->
                    <div id="rvLightbox" class="rv-lightbox" aria-hidden="true">
                        <div class="rv-lb-inner">
                            <img id="rvLightboxImg" alt="Xem ảnh đánh giá" draggable="false" />
                            <button type="button" class="rv-lb-close" aria-label="Đóng">×</button>
                        </div>
                    </div>
                </section>


            </div>

            @using VHS_frontend.Models.ServiceDTOs
            @using System.Linq

            <!-- CỘT PHẢI: TOP 4 DỊCH VỤ NỔI BẬT (render 1 lần) -->
            <div class="svc-right-col">
                <div role="complementary" class="top-right" aria-label="Top dịch vụ nổi bật">
                    <h4 class="top-title">Top dịch vụ nổi bật</h4>

                    @{
                        // Lấy từ ViewBag (dữ liệu thật)
                        var topRight = ViewBag.TopRight as IEnumerable<ListServiceHomePageDTOs>
                        ?? Enumerable.Empty<ListServiceHomePageDTOs>();
                    }

                    @if (!topRight.Any())
                    {
                        <div class="top-empty">Chưa có dịch vụ nổi bật.</div>
                    }
                    else
                    {
                        <div class="top-list">
                            @foreach (var s in topRight)
                            {
                                // Images trong DTO là chuỗi (có thể rỗng / nhiều ảnh, ngăn cách bởi dấu phẩy)
                                var firstImg = (s.Images ?? "")
                                .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .FirstOrDefault()?.Trim();

                                var imgRight = string.IsNullOrWhiteSpace(firstImg)
                                ? (s.UnitType == "Nội trợ" ? Url.Content("~/images/NoiTro.jpg")
                                : s.UnitType == "Sự kiện nhỏ tại nhà" ? Url.Content("~/images/SuKienNho.jpg")
                                : Url.Content("~/images/VeSinh.jpg"))
                                : Url.Content(firstImg);

                                // Hiển thị giá
                                var priceDisplay = s.Price > 0 ? string.Format("{0:#,0}đ / {1}", s.Price, GetUnitTypeVietnamese(s.UnitType)) : null;

                                <article class="top-card">
                                    @* Dùng query-string sid để không va chạm Details(int id) *@
                                    <a asp-controller="Services" asp-action="Details" asp-route-id="@s.ServiceId" class="top-thumb">
                                        <img src="@imgRight" alt="@s.Title" loading="lazy" data-fallback="@fallbackImg" />
                                    </a>
                                    <div class="top-info">
                                        <a asp-controller="Services" asp-action="Details" asp-route-id="@s.ServiceId" class="top-name">
                                            @s.Title
                                        </a>

                                        <div class="top-stars">
                                            @{
                                                double ratingRight = s.AverageRating; // 0..5 có phần lẻ
                                                for (int i = 1; i <= 5; i++)
                                                {
                                                    var fill = Math.Max(0, Math.Min(1, ratingRight - (i - 1)));
                                                    var pct = (int)Math.Round(fill * 100);
                                                    if (pct >= 100)
                                                    {
                                                        @:<span class="star filled">★</span>
                                                    }
                                                    else if (pct <= 0)
                                                    {
                                                        @:<span class="star">★</span>
                                                    }
                                                    else
                                                    {
                                                        @:<span class="star frac" style="--p:@pct%;">★</span>
                                                    }
                                                }
                                            }
                                            <span class="top-rating-text">
                                                @s.AverageRating.ToString("0.#") / 5 (@s.TotalReviews đánh giá)
                                            </span>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(priceDisplay))
                                        {
                                            <div class="top-price">@priceDisplay</div>
                                        }
                                    </div>
                                </article>
                            }
                        </div>
                    }
                </div>
            </div>



            <!--  =========== RELATED SERVICES (dữ liệu thật)  ======================= -->
            @{
                var list = ViewBag.RelatedServices as IEnumerable<ListServiceHomePageDTOs>
                ?? Enumerable.Empty<ListServiceHomePageDTOs>();
                const int step = 20;
                var idx = 0;
            }
            @if (list.Any())
            {
                <div class="related">
                    <h3 class="related-title">Dịch vụ liên quan</h3>

                    <div class="related-grid" id="relatedGrid">
                        @foreach (var s in list)
                        {
                            // Lấy ảnh đầu tiên từ chuỗi Images (nếu có), fallback theo "loại"
                            var firstImg = (s.Images ?? "")
                            .Split(',', StringSplitOptions.RemoveEmptyEntries)
                            .FirstOrDefault()?.Trim();

                            // Không có Category trong DTO -> fallback theo UnitType (nếu bạn dùng UnitType làm nhóm)
                            var fallbackByUnit = s.UnitType;
                            var relImg = string.IsNullOrWhiteSpace(firstImg)
                            ? (fallbackByUnit == "Nội trợ" ? Url.Content("~/images/NoiTro.jpg")
                            : fallbackByUnit == "Sự kiện nhỏ tại nhà" ? Url.Content("~/images/SuKienNho.jpg")
                            : Url.Content("~/images/VeSinh.jpg"))
                            : Url.Content(firstImg);

                            var hide = idx >= step;

                            // Giá hiển thị: Price + UnitType
                            var priceDisplay = s.Price > 0
                            ? string.Format("{0:#,0}đ / {1}", s.Price, GetUnitTypeVietnamese(s.UnitType))
                            : null;

                            <article class="related-card@(hide ? " is-hidden" : "")" data-index="@idx">
                                @* Dùng query-string sid (Guid) để điều hướng, tránh xung đột với Details(int id) *@
                                <a asp-controller="Services" asp-action="Details" asp-route-id="@s.ServiceId" class="rel-img-wrap">
                                    <img src="@relImg" alt="@s.Title" data-fallback="@fallbackImg" />
                                </a>
                                <div class="rel-body">
                                    <a asp-controller="Services" asp-action="Details" asp-route-id="@s.ServiceId" class="rel-name">
                                        @s.Title
                                    </a>

                                    <div class="rel-stars">
                                        @{
                                            var ravg = s.AverageRating; // 0..5 có phần lẻ
                                            for (int i = 1; i <= 5; i++)
                                            {
                                                var fill = Math.Max(0, Math.Min(1, ravg - (i - 1)));
                                                var pct = (int)Math.Round(fill * 100);
                                                if (pct >= 100)
                                                {
                                                    <span class="star filled">★</span>
                                                }
                                                else if (pct <= 0)
                                                {
                                                    <span class="star">★</span>
                                                }
                                                else
                                                {
                                                    <span class="star frac" style="--p:@pct%;">★</span>
                                                }
                                            }
                                        }
                                        <span class="rel-rating-text">
                                            @s.AverageRating.ToString("0.#") / 5 (@s.TotalReviews đánh giá)
                                        </span>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(priceDisplay))
                                    {
                                        <div class="rel-price">@priceDisplay</div>
                                    }
                                </div>
                            </article>
                            idx++;
                        }
                    </div>

                    <div class="related-more" id="relatedMore" style="@(list.Count() > step ? "" : "display:none")">
                        <button type="button" class="btn btn-more" id="btnRelatedMore"
                                data-step="@step" aria-controls="relatedGrid">
                            Xem thêm
                        </button>
                    </div>
                </div>
            }
    </div>
</section>

@section Scripts {
    <script>
        // Đổi ảnh lớn + đánh dấu thumb đang chọn
        document.getElementById('thumbs')?.addEventListener('click', function (e) {
          const btn = e.target.closest('.thumb');
          if (!btn) return;
          const src = btn.getAttribute('data-src');
          if (src) document.getElementById('mainImage')?.setAttribute('src', src);

          // highlight thumbnail đang chọn
          this.querySelectorAll('.thumb.is-active').forEach(x => x.classList.remove('is-active'));
          btn.classList.add('is-active');
        });
        // Đánh dấu sẵn thumb đầu tiên
        document.querySelector('#thumbs .thumb')?.classList.add('is-active');

        // ===== Toggle MÔ TẢ: tự hiện nút nếu content dài =====
        (function () {
          const card = document.getElementById('descCard');
          const content = document.getElementById('descContent');
          const btn = document.getElementById('descToggle');
          if (!card || !content || !btn) return;

          const MAX_H = 380;
          const check = () => {
            btn.hidden = !(content.scrollHeight > MAX_H);
            card.classList.toggle('is-collapsed', content.scrollHeight > MAX_H);
            btn.textContent = card.classList.contains('is-collapsed') ? 'Xem thêm' : 'Thu gọn';
          };
          check();
          btn.addEventListener('click', () => {
            card.classList.toggle('is-collapsed');
            btn.textContent = card.classList.contains('is-collapsed') ? 'Xem thêm' : 'Thu gọn';
          });
          content.querySelectorAll('img').forEach(img => img.addEventListener('load', check));
        })();

               // ===== Tính tiền add-on + đồng bộ hidden (giữ nguyên UI, thêm cập nhật qty ẩn) =====
        (function(){
          const money = n => n.toLocaleString('vi-VN') + 'đ';
          const baseEl = document.getElementById('basePrice');
          if(!baseEl) return;

          const addOnEl = document.getElementById('addOnPrice');
          const totalEl = document.getElementById('grandTotal');
          const base = Number(baseEl.dataset.base || 0);

          function calc(){
            let extra = 0;

            // Checkbox add-on
            document.querySelectorAll('.addon-check').forEach(w => {
              const price = Number(w.getAttribute('data-price') || 0);
              const checked = w.querySelector('.addon-input')?.checked;
              const hiddenQty = w.previousElementSibling; // chính là input hidden addonQty ngay trước .addon-check
              if (checked) {
                extra += price;
                if(hiddenQty && hiddenQty.classList.contains('addonQty-hidden')) hiddenQty.value = 1;
              } else {
                if(hiddenQty && hiddenQty.classList.contains('addonQty-hidden')) hiddenQty.value = 0;
              }
            });

            // Quantity add-on
            document.querySelectorAll('.addon-qty').forEach(w => {
              const price = Number(w.getAttribute('data-price') || 0);
              const qtyInput = w.querySelector('.qty-input');
              const qty = Number((qtyInput?.value || '0').replace(/\D/g,''));
              extra += price * qty;

              // hiddenQty của block qty nằm TRƯỚC .addon-qty (vì mình render các hidden trước wrapper)
              const hiddenQty = w.previousElementSibling; // addonQty-hidden
              if(hiddenQty && hiddenQty.classList.contains('addonQty-hidden')) hiddenQty.value = qty;
            });

            if(addOnEl) addOnEl.textContent = money(extra);
            if(totalEl) totalEl.textContent = money(base + extra);
          }

          // Events cho qty
          document.querySelectorAll('.addon-qty').forEach(w => {
            const input = w.querySelector('.qty-input');
            if(!input) return;
            const max = Number(w.getAttribute('data-max') || 99);
            const btns = w.querySelectorAll('.qty-btn');
            const minus = btns[0], plus = btns[1];

            minus?.addEventListener('click', ()=>{
              const cur = Number((input.value||'0').replace(/\D/g,'')) || 0;
              input.value = String(Math.max(0, cur - 1));
              calc();
            });
            plus?.addEventListener('click', ()=>{
              const cur = Number((input.value||'0').replace(/\D/g,'')) || 0;
              input.value = String(Math.min(max, cur + 1));
              calc();
            });

            input.addEventListener('input', ()=>{
              let v = (input.value||'0').replace(/\D/g,'');
              if (v === '') v = '0';
              v = String(Math.min(max, Number(v)));
              input.value = v;
              calc();
            });
          });

          // Events cho checkbox
          document.querySelectorAll('.addon-check .addon-input').forEach(chk => {
            chk.addEventListener('change', calc);
          });

          // Khởi tạo
          calc();
        })();

        // ===== Lightbox ảnh review =====
        (function () {
          const lb     = document.getElementById('rvLightbox');
          const lbImg  = document.getElementById('rvLightboxImg');
          const btnX   = document.querySelector('.rv-lb-close');

          function openLB(src){
            if(!lb || !lbImg) return;
            lbImg.src = src;
            lb.classList.add('open');
            lb.setAttribute('aria-hidden','false');
          }
          function closeLB(){
            if(!lb) return;
            lb.classList.remove('open');
            lb.setAttribute('aria-hidden','true');
            if(lbImg) lbImg.src = '';
          }

          // bấm ảnh để mở
          document.addEventListener('click', function(e){
            const img = e.target.closest('.rv-photos img');
            if(img){ e.preventDefault(); openLB(img.src); }
          });

          // đóng khi bấm nền, ×, ảnh, hoặc ESC
          lb?.addEventListener('click', (e)=>{ if(e.target === lb) closeLB(); });
          btnX?.addEventListener('click', closeLB);
          lbImg?.addEventListener('click', closeLB);
          window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLB(); });
        })();

        // ===== Tự động thêm tất cả options vào form khi submit =====
        // Tất cả options đã được thêm vào form qua hidden inputs ở trên
        // Không cần xử lý thêm gì vì options đã tự động đi chung gói tiền

        // ===== Related: nút "Xem thêm" =====
        (function(){
          const grid = document.getElementById('relatedGrid');
          const moreWrap = document.getElementById('relatedMore');
          const btn = document.getElementById('btnRelatedMore');
          const remainEl = document.getElementById('relatedRemain');
          if(!grid || !btn) return;

          const STEP = parseInt(btn.getAttribute('data-step') || btn.getAttribute('data-chunk') || '20', 10);

          // Phòng khi item bị inline display:none ở phiên bản cũ
          grid.querySelectorAll('.related-card.is-hidden').forEach(el => {
            el.style.removeProperty('display');
          });

          btn.addEventListener('click', function(){
            const hidden = grid.querySelectorAll('.related-card.is-hidden');
            const take = Math.min(STEP, hidden.length);
            for(let i=0;i<take;i++){
              hidden[i].classList.remove('is-hidden');
              hidden[i].style.removeProperty('display');
            }
            const remain = grid.querySelectorAll('.related-card.is-hidden').length;
            if(remainEl) remainEl.textContent = remain;
            if(remain === 0 && moreWrap){ moreWrap.style.display = 'none'; }
          });
        })();

              // Tự động thay ảnh lỗi bằng fallback, tránh lặp vô hạn khi fallback hỏng.
        (function () {
          function applyFallback(img) {
            if (!img || img.dataset.fallbackApplied === '1') return;
            const fb = img.getAttribute('data-fallback');
            if (!fb) return;
            img.dataset.fallbackApplied = '1';
            img.src = fb;
          }

          // Gắn listener cho tất cả ảnh có data-fallback
          function wireImages(root = document) {
            root.querySelectorAll('img[data-fallback]').forEach(function (img) {
              // Nếu ảnh đã load lỗi trước khi gắn listener, xử lý ngay
              if (img.complete && img.naturalWidth === 0) applyFallback(img);

              // Bắt lỗi khi load thất bại
              img.addEventListener('error', function () {
                applyFallback(img);
              }, { once: true });
            });
          }

          wireImages(document);
        })();

        // Function để chuẩn bị OptionValues trước khi submit form
        function prepareOptionValues() {
            const optionValues = {};
            @if (Model.ServiceOptions?.Any() == true)
            {
                foreach (var o in Model.ServiceOptions)
                {
                    if (!string.IsNullOrWhiteSpace(o.Value))
                    {
                        <text>
                        optionValues['@o.OptionId.ToString()'] = @Html.Raw(Json.Serialize(o.Value));
                        </text>
                    }
                }
            }
            
            // Set giá trị vào hidden input
            const jsonInput = document.getElementById('optionValuesJson');
            if (jsonInput) {
                jsonInput.value = JSON.stringify(optionValues);
            }
        }

        // Gắn event listener cho form submit
        document.addEventListener('DOMContentLoaded', function() {
            const cartForm = document.getElementById('cartForm');
            if (cartForm) {
                cartForm.addEventListener('submit', function(e) {
                    prepareOptionValues();
                });
            }
        });
    </script>
}
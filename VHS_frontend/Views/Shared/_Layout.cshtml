<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>@ViewData["Title"] - Viet Home Service</title>
    @Html.AntiForgeryToken()

    <!-- Font đẹp: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- CSS chung - ORDER MATTERS! notification.css trước, header.css sau để override -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <!-- <link rel="stylesheet" href="~/css/about.css" asp-append-version="true" /> -->
    <link rel="stylesheet" href="~/css/footer.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/notification.css" asp-append-version="true" />
    <!-- <link rel="stylesheet" href="~/css/service-shop.css" asp-append-version="true" /> -->
    <link rel="stylesheet" href="~/css/header.css" asp-append-version="true" /> <!-- MUST BE LAST to override everything -->


    @* THÊM DÒNG NÀY để các view bơm CSS riêng *@
    @RenderSection("Styles", required: false)

    <!-- CSS riêng cho trang Login/Register -->
    @if (ViewData["Title"]?.ToString() == "Đăng nhập" || ViewData["Title"]?.ToString() == "Đăng ký")
    {
        <link rel="stylesheet" href="~/css/auth.css" asp-append-version="true" />
    }
</head>
<body class="min-h-screen bg-background text-foreground font-sans antialiased">
    @await Html.PartialAsync("_Header")

    <main id="main">
        @RenderBody()
    </main>

    @if (ViewData["HideFooter"] == null || !(bool)ViewData["HideFooter"])
    {
        @await Html.PartialAsync("_Footer")
    }

    <script>
        // Theme toggle
        (function () {
          const KEY = "vhs-theme";
          const root = document.documentElement;
          const saved = localStorage.getItem(KEY);
          const apply = t => t==="dark" ? root.classList.add("dark") : root.classList.remove("dark");
          if (saved==="light"||saved==="dark") apply(saved);
          else apply(matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
          window.__toggleTheme = function(){
            const next = root.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem(KEY, next); apply(next);
          };
        })();

        // Smooth scroll cho anchor
        document.addEventListener("click", (e) => {
          const a = e.target.closest('a[href^="#"]');
          if (!a) return;
          const id = a.getAttribute("href");
          const el = document.querySelector(id);
          if (el) { e.preventDefault(); el.scrollIntoView({ behavior: "smooth", block: "start" }); }
        });

        // Header scroll effect - chỉ thêm shadow
        const header = document.querySelector('.site-header');
        if (header) {
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Thêm shadow khi scroll xuống
                if (scrollTop > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            }, { passive: true });
        }
    </script>

    <!-- Notification System -->
    <script>
        // Biến lưu trữ thông báo từ API
        let notifications = [];

        // Hover để hiển thị dropdown
        const btn = document.getElementById('notificationBtn');
        const menu = document.getElementById('notificationMenu');
        let hoverTimeout;

        if (btn && menu) {
            // Hover để hiển thị dropdown
            btn.addEventListener('mouseenter', async () => {
                clearTimeout(hoverTimeout);
                await loadNotifications();
                menu.style.display = 'block';
            });

            // Mouse leave button - delay ẩn dropdown
            btn.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    menu.style.display = 'none';
                }, 100);
            });

            // Hover vào dropdown để giữ mở
            menu.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimeout);
                menu.style.display = 'block';
            });

            // Mouse leave khỏi dropdown để ẩn
            menu.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    menu.style.display = 'none';
                }, 100);
            });

            // Click vào chuông sẽ chuyển trang (không prevent default)
            // Link sẽ hoạt động bình thường
        }

        // Đếm và hiển thị badge
        function loadUnreadCount() {
            const unreadCount = notifications.filter(n => !n.isRead).length;
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Helper to format Vietnam time - COPY Y TRANG THÔNG BÁO
        // C# backend: ToVietnamTime(notification.CreatedAt).ToString("dd/MM/yyyy HH:mm")
        // JS: formatVietnamTime(n.createdAt) → "dd/MM/yyyy HH:mm"
        function formatVietnamTime(dateString) {
            if (!dateString) return '';
            
            try {
                // API trả về UTC time (ví dụ: "2025-10-26T12:34:16.2974194")
                // Cần convert sang VN time (UTC+7)
                const date = new Date(dateString);
                
                // LUÔN LUÔN convert sang VN timezone
                const formatter = new Intl.DateTimeFormat('en-GB', {
                    timeZone: 'Asia/Ho_Chi_Minh',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                const parts = formatter.formatToParts(date);
                const day = parts.find(p => p.type === 'day')?.value || '00';
                const month = parts.find(p => p.type === 'month')?.value || '00';
                const year = parts.find(p => p.type === 'year')?.value || '0000';
                const hour = parts.find(p => p.type === 'hour')?.value || '00';
                const minute = parts.find(p => p.type === 'minute')?.value || '00';
                
                // Format: "dd/MM/yyyy HH:mm" (giống trang thông báo)
                return `${day}/${month}/${year} ${hour}:${minute}`;
            } catch (error) {
                console.error('Error formatting time:', error, dateString);
                return '';
            }
        }

        // Load danh sách thông báo từ API
        async function loadNotifications() {
            try {
                const response = await fetch('/Customer/Notification/Unread');
                const data = await response.json();
                
                if (data.success && data.data) {
                    notifications = data.data;
                } else {
                    notifications = [];
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                notifications = [];
            }
            
            menu.innerHTML = '';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'dropdown-header';
            header.innerHTML = '<h3>Thông báo</h3>';
            menu.appendChild(header);
            
            const unreadNotifications = notifications.filter(n => !n.isRead);
            
            if (unreadNotifications.length === 0) {
                const empty = document.createElement('li');
                empty.className = 'text-center text-muted py-2';
                empty.innerHTML = '<i class="bi bi-bell-slash me-2"></i>Không có thông báo nào';
                menu.appendChild(empty);
                return;
            }
            
            unreadNotifications.forEach(n => {
                const li = document.createElement('li');
                li.style.cursor = 'pointer';
                li.onclick = () => markAsReadFromDropdown(n.notificationId);
                
                // DEBUG: Log raw time từ API
                console.log('🕐 Raw createdAt từ API:', n.createdAt);
                
                // Format time giống y trang thông báo
                const formattedTime = formatVietnamTime(n.createdAt);
                
                // DEBUG: Log formatted time
                console.log('🕐 Formatted time:', formattedTime);
                
                li.innerHTML = `
                    <div class="d-block text-decoration-none">
                        <div class="small text-muted">${formattedTime}</div>
                        <div>${n.content}</div>
                        <div><strong>Loại:</strong> ${getNotificationTypeVN(n.notificationType)}</div>
                    </div>`;
                menu.appendChild(li);
            });
            
            // View all notifications button
            const all = document.createElement('li');
            all.innerHTML = `<a href="/Customer/Notification/Index" class="d-block text-center text-decoration-none">
                <i class="bi bi-arrow-right me-2"></i>Xem tất cả thông báo
            </a>`;
            menu.appendChild(all);
        }

        // Helper function để convert NotificationType sang tiếng Việt
        function getNotificationTypeVN(type) {
            if (!type) return 'Khác';
            
            const types = {
                'PAYMENT_SUCCESS': 'Thanh toán thành công',
                'NEW_BOOKING': 'Đơn hàng mới',
                'BOOKING_CONFIRMED': 'Xác nhận đơn hàng',
                'BOOKING_CANCELLED': 'Hủy đơn hàng',
                'BOOKING_COMPLETED': 'Hoàn thành đơn hàng',
                'THANH TOÁN THÀNH CÔNG': 'Thanh toán thành công',
                'ĐƠN HÀNG MỚI': 'Đơn hàng mới',
                'Payment': 'Thanh toán',
                'Booking': 'Đặt lịch',
                'System': 'Hệ thống',
                'payment_success': 'Thanh toán thành công',
                'new_booking': 'Đơn hàng mới'
            };
            
            return types[type] || type;
        }

        // Mark notification as read from dropdown
        async function markAsReadFromDropdown(notificationId) {
            try {
                // Lấy CSRF token
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (!tokenInput) {
                    console.error('CSRF token not found');
                    // Vẫn chuyển trang để xem thông báo
                    window.location.href = '/Customer/Notification/Index';
                    return;
                }
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', tokenInput.value);
                
                const response = await fetch(`/Customer/Notification/MarkRead/${notificationId}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('Marked as read successfully');
                    // Reload notifications và chuyển trang
                    await loadNotifications();
                    loadUnreadCount();
                    // Đợi một chút để cập nhật xong rồi mới chuyển trang
                    setTimeout(() => {
                        window.location.href = '/Customer/Notification/Index';
                    }, 200);
                } else {
                    console.error('Failed to mark as read:', result.message || response.status);
                    // Vẫn chuyển trang ngay cả khi lỗi
                    window.location.href = '/Customer/Notification/Index';
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                // Vẫn chuyển trang ngay cả khi lỗi
                window.location.href = '/Customer/Notification/Index';
            }
        }

        // FORCE RELOAD - Version timestamp để browser load code mới
        console.log('=== NOTIFICATION SCRIPT LOADED v2025-10-26-19:20-FIXED ===');
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Load thông báo khi trang load
            await loadNotifications();
            loadUnreadCount();
            
            // Cập nhật thông báo mỗi 30 giây
            setInterval(async () => {
                await loadNotifications();
                loadUnreadCount();
            }, 30000);
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>

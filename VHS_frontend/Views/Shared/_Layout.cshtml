<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>@ViewData["Title"] - Viet Home Service</title>

    <!-- Font đẹp: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- CSS chung -->
    <link rel="stylesheet" href="~/css/header.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/about.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/footer.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/notification.css" asp-append-version="true" />
    <!-- <link rel="stylesheet" href="~/css/service-shop.css" asp-append-version="true" /> -->


    @* THÊM DÒNG NÀY để các view bơm CSS riêng *@
    @RenderSection("Styles", required: false)

    <!-- CSS riêng cho trang Login/Register -->
    @if (ViewData["Title"]?.ToString() == "Đăng nhập" || ViewData["Title"]?.ToString() == "Đăng ký")
    {
        <link rel="stylesheet" href="~/css/auth.css" asp-append-version="true" />
    }
</head>
<body class="min-h-screen bg-background text-foreground font-sans antialiased">
    @await Html.PartialAsync("_Header")

    <main id="main">
        @RenderBody()
    </main>

    @await Html.PartialAsync("_Footer")

    <script>
        // Theme toggle
        (function () {
          const KEY = "vhs-theme";
          const root = document.documentElement;
          const saved = localStorage.getItem(KEY);
          const apply = t => t==="dark" ? root.classList.add("dark") : root.classList.remove("dark");
          if (saved==="light"||saved==="dark") apply(saved);
          else apply(matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
          window.__toggleTheme = function(){
            const next = root.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem(KEY, next); apply(next);
          };
        })();

        // Smooth scroll cho anchor
        document.addEventListener("click", (e) => {
          const a = e.target.closest('a[href^="#"]');
          if (!a) return;
          const id = a.getAttribute("href");
          const el = document.querySelector(id);
          if (el) { e.preventDefault(); el.scrollIntoView({ behavior: "smooth", block: "start" }); }
        });
    </script>

    <!-- Notification System -->
    <script>
        // Mock data cho testing
        let mockNotifications = [
            {
                notificationId: '1',
                content: 'Đơn hàng #12345 đã được xác nhận',
                bookingStatus: 'Confirmed',
                createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 giờ trước
                isRead: false
            },
            {
                notificationId: '2',
                content: 'Dịch vụ vệ sinh nhà đã hoàn thành',
                bookingStatus: 'Completed',
                createdAt: new Date(Date.now() - 5 * 60 * 60 * 1000), // 5 giờ trước
                isRead: false
            },
            {
                notificationId: '3',
                content: 'Thanh toán thành công cho đơn hàng #12346',
                bookingStatus: 'Paid',
                createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 ngày trước
                isRead: true
            },
            {
                notificationId: '4',
                content: 'Đánh giá dịch vụ từ khách hàng',
                bookingStatus: 'Review',
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2 ngày trước
                isRead: false
            }
        ];

        // Hover để hiển thị dropdown
        const btn = document.getElementById('notificationBtn');
        const menu = document.getElementById('notificationMenu');
        let hoverTimeout;

        if (btn && menu) {
            // Hover để hiển thị dropdown
            btn.addEventListener('mouseenter', async () => {
                clearTimeout(hoverTimeout);
                await loadNotifications();
                menu.style.display = 'block';
            });

            // Mouse leave button - delay ẩn dropdown
            btn.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    menu.style.display = 'none';
                }, 100);
            });

            // Hover vào dropdown để giữ mở
            menu.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimeout);
                menu.style.display = 'block';
            });

            // Mouse leave khỏi dropdown để ẩn
            menu.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    menu.style.display = 'none';
                }, 100);
            });

            // Click vào chuông sẽ chuyển trang (không prevent default)
            // Link sẽ hoạt động bình thường
        }

        // Đếm và hiển thị badge
        function loadUnreadCount() {
            const unreadCount = mockNotifications.filter(n => !n.isRead).length;
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Load danh sách thông báo
        function loadNotifications() {
            menu.innerHTML = '';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'dropdown-header';
            header.innerHTML = '<h3>Thông báo</h3>';
            menu.appendChild(header);
            
            const unreadNotifications = mockNotifications.filter(n => !n.isRead);
            
            if (unreadNotifications.length === 0) {
                const empty = document.createElement('li');
                empty.className = 'text-center text-muted py-2';
                empty.innerHTML = '<i class="bi bi-bell-slash me-2"></i>Không có thông báo nào';
                menu.appendChild(empty);
                return;
            }
            
            unreadNotifications.forEach(n => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="d-block text-decoration-none">
                        <div class="small text-muted">${n.createdAt.toLocaleString()}</div>
                        <div>${n.content}</div>
                        <div><strong>Booking Status:</strong> ${n.bookingStatus}</div>
                    </div>`;
                menu.appendChild(li);
            });
            
            // View all notifications button
            const all = document.createElement('li');
            all.innerHTML = `<a href="/Customer/Notification/Index" class="d-block text-center text-decoration-none">
                <i class="bi bi-arrow-right me-2"></i>Xem tất cả thông báo
            </a>`;
            menu.appendChild(all);
        }

        // Không có chức năng mark as read trong dropdown
        // Chỉ có thể clear thông báo qua trang thông báo

        document.addEventListener('DOMContentLoaded', () => {
            loadUnreadCount();
            // Không cần setInterval vì dùng mock data
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>

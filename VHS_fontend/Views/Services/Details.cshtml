@model VHS_fontend.Controllers.ServiceDetailViewModel
@{
    ViewData["Title"] = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Ảnh chính fallback theo Category (không tạo helper mới)
    string fallbackMain = Url.Content(
        Model.Category == "Nội trợ" ? "~/images/NoiTro.jpg"
        : Model.Category == "Sự kiện nhỏ tại nhà" ? "~/images/SuKienNho.jpg"
        : "~/images/VeSinh.jpg"
    );

    string mainSrc = (Model.Images != null && Model.Images.FirstOrDefault() != null)
        ? Url.Content(Model.Images.First())
        : fallbackMain;
}

<link rel="stylesheet" href="~/css/service-detail.css" asp-append-version="true" />

<section class="service-detail">
    <div class="container-xl">
        <!-- Breadcrumb -->
        <nav class="breadcrumb" aria-label="breadcrumb">
            <a asp-controller="Home" asp-action="Index">Trang chủ</a> /
            <a asp-controller="Services" asp-action="Index">Dịch vụ</a> /
            <span class="current">@Model.Name</span>
        </nav>

        <div class="detail-grid">
            <!-- GALLERY -->
            <div>
                <div class="gallery">
                    <div class="gallery-main">
                        <img id="mainImage" src="@mainSrc" alt="@Model.Name" />
                    </div>

                    <div class="thumbs" id="thumbs">
                        @if (Model.Images != null && Model.Images.Any())
                        {
                            foreach (var img in Model.Images)
                            {
                                var src = string.IsNullOrWhiteSpace(img)
                                ? (Model.Category == "Nội trợ" ? Url.Content("~/images/NoiTro.jpg")
                                : Model.Category == "Sự kiện nhỏ tại nhà" ? Url.Content("~/images/SuKienNho.jpg")
                                : Url.Content("~/images/VeSinh.jpg"))
                                : Url.Content(img);

                                <button type="button" class="thumb" data-src="@src" title="Xem ảnh">
                                    <img src="@src" alt="@Model.Name" />
                                </button>
                            }
                        }
                        else
                        {
                            // Không có Images -> hiển thị 3 thumbnail fallback theo Category
                            var thumb = Model.Category == "Nội trợ" ? Url.Content("~/images/NoiTro.jpg")
                            : Model.Category == "Sự kiện nhỏ tại nhà" ? Url.Content("~/images/SuKienNho.jpg")
                            : Url.Content("~/images/VeSinh.jpg");
                            for (int i = 0; i < 3; i++)
                            {
                                <button type="button" class="thumb" data-src="@thumb" title="Xem ảnh">
                                    <img src="@thumb" alt="@Model.Name" />
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- INFO -->
            <div class="info">
                <h1 class="title">@Model.Name</h1>

                <span class="stars">
                    @{
                        var avg = Model.Stars; // giữ số thực
                    }
                    @for (int s = 1; s <= 5; s++)
                    {
                        var fill = Math.Max(0, Math.Min(1, avg - (s - 1))); // 0..1
                        var pct = (int)Math.Round(fill * 100);               // 0..100

                        if (pct >= 100)
                        {
                            <span class="star filled">★</span>
                            ;
                        }
                        else if (pct <= 0)
                        {
                            <span class="star">★</span>
                            ;
                        }
                        else
                        {
                            <span class="star frac" style="--p:@pct%;">★</span>
                            ;
                        }
                    }
                </span>
                <span class="rating-text">@Model.Stars.ToString("0.#") / 5 (@Model.TotalReviews đánh giá)</span>


                <div class="price">@Model.PriceDisplay</div>

                <ul class="brief">
                    <li><strong>Loại:</strong> @Model.Category</li>
                    <li><strong>Thời gian:</strong> @Model.Duration</li>
                </ul>

                <p class="desc">@Model.Description</p>

                <!-- ADD-ONS -->
                @if (Model.AddOns?.Any() == true)
                {
                    <div class="addons">
                        <h3 class="addons-title">Tuỳ chọn thêm</h3>

                        <div class="addons-list">
                            @foreach (var a in Model.AddOns)
                            {
                                if (string.Equals(a.Type, "check", StringComparison.OrdinalIgnoreCase))
                                {
                                    <label class="addon-item addon-check" data-price="@a.Price">
                                        <input type="checkbox" class="addon-input" />
                                        <span class="addon-name">@a.Name</span>
                                        <span class="addon-price">+ @string.Format("{0:n0}", a.Price)đ</span>
                                    </label>
                                }
                                else
                                {
                                    <div class="addon-item addon-qty" data-price="@a.Price" data-max="@a.MaxQty">
                                        <div class="addon-name">@a.Name</div>
                                        <div class="qty-control">
                                            <button type="button" class="qty-btn" aria-label="Giảm">−</button>
                                            <input type="text" class="qty-input" value="0" inputmode="numeric" />
                                            <button type="button" class="qty-btn" aria-label="Tăng">+</button>
                                        </div>
                                        <div class="addon-price">+ @string.Format("{0:n0}", a.Price)đ</div>
                                    </div>
                                }
                            }
                        </div>

                        <div class="addons-summary">
                            <div class="row">
                                <span>Giá dịch vụ</span>
                                <strong id="basePrice" data-base="@Model.PriceValue">@Model.PriceDisplay</strong>
                            </div>
                            <div class="row">
                                <span>Phụ thu add-on</span>
                                <strong id="addOnPrice">0đ</strong>
                            </div>
                            <div class="row total">
                                <span>Tổng tạm tính</span>
                                <strong id="grandTotal">@Model.PriceDisplay</strong>
                            </div>
                        </div>
                    </div>
                }

                <!-- ACTIONS -->
                <div class="actions">
                    <button type="button" class="btn btn-cart">
                        <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                            <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 .001 3.999A2 2 0 0 0 17 18zM7.2 14h9.45a2 2 0 0 0 1.94-1.52l1.2-5.23A1 1 0 0 0 18.8 6H6.3l-.3-1.2A1 1 0 0 0 5 4H2v2h2.2l2.2 8.8z" />
                        </svg>
                        Thêm vào giỏ hàng
                    </button>
                    <button type="button" class="btn btn-buy">Mua ngay</button>
                </div>

                <div class="safety">
                    <span>✓ Bảo hành theo chính sách</span>
                    <span>✓ Lịch hẹn linh hoạt</span>
                    <span>✓ Thanh toán an toàn</span>
                </div>
            </div>
        </div>

        <!-- PROVIDER / SHOP CARD -->
        <section class="provider-section">
            <div class="provider-card provider--split">
                <!-- LEFT -->
                <div class="provider-left">
                    <img class="provider-logo"
                         src="@Url.Content((ViewBag.VendorLogo as string) ?? "~/images/VeSinh.jpg")"
                         alt="Logo nhà cung cấp" />
                    <div class="provider-meta">
                        <h3 class="provider-name">@((ViewBag.VendorName as string) ?? "Đối tác VHS")</h3>
                        <div class="provider-online">@((ViewBag.VendorOnline as string) ?? "Online vài phút trước")</div>
                        <div class="provider-actions">
                            <a href="@((ViewBag.VendorChatUrl as string) ?? "#")" class="btn btn-outline">💬 Chat ngay</a>
                            <a href="@((ViewBag.VendorShopUrl as string) ?? "#")" class="btn btn-ghost">🏬 Xem shop</a>
                        </div>
                    </div>
                </div>

                <div class="provider-divider" role="presentation"></div>

                <!-- RIGHT (2 hàng × 3 cột) -->
                <div class="provider-right">
                    <div class="stat-pair">
                        <span class="label">Đánh giá</span>
                        <span class="value">@((ViewBag.VendorRatingCount as string) ?? Model.TotalReviews.ToString("n0"))</span>
                    </div>
                    <div class="stat-pair">
                        <span class="label">Tỉ lệ phản hồi</span>
                        <span class="value">@((ViewBag.VendorResponseRate as string) ?? "100%")</span>
                    </div>
                    <div class="stat-pair">
                        <span class="label">Tham gia</span>
                        <span class="value">@((ViewBag.VendorJoined as string) ?? "7 năm trước")</span>
                    </div>

                    <div class="stat-pair">
                        <span class="label">Dịch vụ</span>
                        <span class="value">@((ViewBag.VendorServiceCount as string) ?? "233")</span>
                    </div>
                    <div class="stat-pair">
                        <span class="label">Thời gian phản hồi</span>
                        <span class="value">@((ViewBag.VendorResponseTime as string) ?? "trong vài phút")</span>
                    </div>

                    @* Followers: để trống hoặc set null để ẩn *@
                    @{
                        var followers = ViewBag.VendorFollowers as string; // null => không render
                    }
                    @if (!string.IsNullOrWhiteSpace(followers))
                    {
                        <div class="stat-pair">
                            <span class="label">Người theo dõi</span>
                            <span class="value">@followers</span>
                        </div>
                    }
                </div>
            </div>
        </section>

        <!-- ===== REVIEWS / ĐÁNH GIÁ DỊCH VỤ (filterable) ======================= -->
        @{
            var httpReq = ViewContext?.HttpContext?.Request;
            string qPage = httpReq?.Query["rpage"];
            string qStar = httpReq?.Query["rstar"];
            string qMedia = httpReq?.Query["rmedia"];

            int rpage = 1; int tmp;
            if (int.TryParse(qPage, out tmp)) rpage = Math.Max(1, tmp);

            int rstar = 0; // 0 = tất cả, 1..5 = lọc theo sao nguyên
            int.TryParse(qStar, out rstar);
            bool onlyMedia = !string.IsNullOrWhiteSpace(qMedia) &&
            (qMedia == "1" || qMedia.Equals("true", StringComparison.OrdinalIgnoreCase));

            const int rPageSize = 5;
            var allReviews = Model.Reviews ?? new List<VHS_fontend.Controllers.ReviewItem>();

            // ⭐ Chuẩn hoá sao về bucket 1..5 (để đếm & lọc khớp UI)
            Func<double, int> Bucket = s =>
            {
                var i = (int)Math.Round(s, MidpointRounding.AwayFromZero);
                if (i < 1) i = 1; else if (i > 5) i = 5;
                return i;
            };

            // Đếm theo bucket
            int n1 = allReviews.Count(x => Bucket(x.Stars) == 1);
            int n2 = allReviews.Count(x => Bucket(x.Stars) == 2);
            int n3 = allReviews.Count(x => Bucket(x.Stars) == 3);
            int n4 = allReviews.Count(x => Bucket(x.Stars) == 4);
            int n5 = allReviews.Count(x => Bucket(x.Stars) == 5);

            // Đếm có media (loại chuỗi rỗng)
            int nPic = allReviews.Count(x => x.Photos != null &&
            x.Photos.Any(p => !string.IsNullOrWhiteSpace(p)));

            // Lọc theo sao (nếu chọn chip)
            IEnumerable<VHS_fontend.Controllers.ReviewItem> filtered = allReviews;
            // Chỉ 1 chế độ: media OR stars
            if (onlyMedia)
            {
                filtered = filtered.Where(x => x.Photos != null &&
                x.Photos.Any(p => !string.IsNullOrWhiteSpace(p)));
            }
            else if (rstar >= 1 && rstar <= 5)
            {
                filtered = filtered.Where(x => Bucket(x.Stars) == rstar);
            }

            int rTotal = filtered.Count();
            int rTotalPages = Math.Max(1, (int)Math.Ceiling(rTotal / (double)rPageSize));
            if (rpage > rTotalPages) rpage = rTotalPages;

            var pageReviews = filtered.Skip((rpage - 1) * rPageSize).Take(rPageSize).ToList();

            // Format số: 1.2k
            Func<int, string> K = n => n >= 1000 ? (n / 1000.0).ToString("0.#") + "k" : n.ToString();
        }
        <section class="reviews-section" id="reviews">
            <div class="reviews-card">
                <h3 class="reviews-title">Đánh giá dịch vụ</h3>

                <!-- Summary + Filters -->
                <div class="reviews-header">
                    <div class="reviews-score">
                        <div class="score-number">
                            <span>@Model.Stars.ToString("0.#")</span>
                            <small>trên 5</small>
                        </div>
                        <div class="score-stars">
                            <span class="stars">
                                @{
                                    var avgScore = Model.Stars;
                                    for (int i = 1; i <= 5; i++)
                                    {
                                        var fill = Math.Max(0, Math.Min(1, avgScore - (i - 1)));
                                        var pct = (int)Math.Round(fill * 100);
                                        if (pct >= 100)
                                        {
                                            <span class="star filled">★</span>
                                            ;
                                        }
                                        else if (pct <= 0)
                                        {
                                            <span class="star">★</span>
                                            ;
                                        }
                                        else
                                        {
                                            <span class="star frac" style="--p:@pct%;">★</span>
                                            ;
                                        }
                                    }
                                }
                            </span>
                            <div class="score-count">@rTotal đánh giá</div>
                        </div>
                    </div>

                    <div class="reviews-filters">
                        <!-- Tất cả -->
                        <a class="rv-chip @(rstar==0 && !onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id"
                           asp-fragment="reviews"
                           aria-pressed="@(rstar==0 && !onlyMedia)">Tất cả</a>

                        <!-- Các sao: KHÔNG mang theo rmedia => bấm là thoát media -->
                        <a class="rv-chip @(rstar==5 && !onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id" asp-route-rstar="5"
                           asp-fragment="reviews"
                           aria-pressed="@(rstar==5 && !onlyMedia)">5 sao (@K(n5))</a>

                        <a class="rv-chip @(rstar==4 && !onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id" asp-route-rstar="4"
                           asp-fragment="reviews"
                           aria-pressed="@(rstar==4 && !onlyMedia)">4 sao (@K(n4))</a>

                        <a class="rv-chip @(rstar==3 && !onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id" asp-route-rstar="3"
                           asp-fragment="reviews"
                           aria-pressed="@(rstar==3 && !onlyMedia)">3 sao (@K(n3))</a>

                        <a class="rv-chip @(rstar==2 && !onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id" asp-route-rstar="2"
                           asp-fragment="reviews"
                           aria-pressed="@(rstar==2 && !onlyMedia)">2 sao (@K(n2))</a>

                        <a class="rv-chip @(rstar==1 && !onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id" asp-route-rstar="1"
                           asp-fragment="reviews"
                           aria-pressed="@(rstar==1 && !onlyMedia)">1 sao (@K(n1))</a>

                        <!-- Media: ĐỘC LẬP, chỉ set rmedia=1, KHÔNG truyền rstar -->
                        <a class="rv-chip @(onlyMedia ? "active" : "")"
                           asp-controller="Services" asp-action="Details"
                           asp-route-id="@Model.Id"
                           asp-route-rmedia="1"
                           asp-fragment="reviews"
                           aria-pressed="@(onlyMedia)">Có hình ảnh / video (@K(nPic))</a>
                    </div>
                </div>

                <!-- List -->
                <div class="reviews-list">
                    @if (!pageReviews.Any())
                    {
                        <div class="reviews-empty">Chưa có đánh giá.</div>
                    }
                    else
                    {
                        foreach (var rv in pageReviews)
                        {
                            <article class="review-item">
                                <img class="rv-avatar"
                                     src="@Url.Content(rv.AvatarUrl ?? "~/images/VeSinh.jpg")"
                                     alt="@rv.User" />
                                <div class="rv-body">
                                    <div class="rv-head">
                                        <strong class="rv-user">@rv.User</strong>
                                        <span class="rv-stars">
                                            @{
                                                // Sao review: integer 1..5 (không lẻ)
                                                var fullStars = Math.Max(0, Math.Min(5,
                                                (int)Math.Round(rv.Stars, MidpointRounding.AwayFromZero)));
                                                for (int i = 1; i <= 5; i++)
                                                {
                                                    if (i <= fullStars)
                                                    {
                                                        <span class="star filled">★</span>
                                                        ;
                                                    }
                                                    else
                                                    {
                                                        <span class="star">★</span>
                                                        ;
                                                    }
                                                }
                                            }
                                        </span>
                                    </div>

                                    <div class="rv-meta">
                                        @rv.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                        @if (!string.IsNullOrWhiteSpace(rv.Variant))
                                        {
                                            <text> | Phân loại: @rv.Variant</text>
                                        }
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(rv.Content))
                                    {
                                        <p class="rv-content">@rv.Content</p>
                                    }

                                    @if (rv.Photos?.Any() == true)
                                    {
                                        <div class="rv-photos">
                                            @foreach (var p in rv.Photos)
                                            {
                                                <img src="@Url.Content(p)" alt="Hình đánh giá" />
                                            }
                                        </div>
                                    }

                                    <!-- BỎ LIKE: xoá rv-actions -->
                                </div>
                            </article>
                        }
                    }
                </div>

                <!-- Pagination (giữ filter hiện tại) -->
                @if (rTotal > rPageSize)
                {
                    <div class="rv-pagination">
                        @if (rpage > 1)
                        {
                            <a class="rv-page"
                               asp-controller="Services" asp-action="Details"
                               asp-route-id="@Model.Id"
                               asp-route-rpage="@(rpage - 1)"
                               asp-route-rstar="@(onlyMedia ? null : (rstar==0 ? null : rstar))"
                               asp-route-rmedia="@(onlyMedia ? "1" : null)"
                               asp-fragment="reviews">‹</a>
                        }
                        @for (int p = 1; p <= rTotalPages; p++)
                        {
                            if (p == rpage)
                            {
                                <span class="rv-page active">@p</span>
                            }
                            else
                            {
                                <a class="rv-page"
                                   asp-controller="Services" asp-action="Details"
                                   asp-route-id="@Model.Id"
                                   asp-route-rpage="@p"
                                   asp-route-rstar="@(onlyMedia ? null : (rstar==0 ? null : rstar))"
                                   asp-route-rmedia="@(onlyMedia ? "1" : null)"
                                   asp-fragment="reviews">@p</a>
                            }
                        }
                        @if (rpage < rTotalPages)
                        {
                            <a class="rv-page"
                               asp-controller="Services" asp-action="Details"
                               asp-route-id="@Model.Id"
                               asp-route-rpage="@(rpage + 1)"
                               asp-route-rstar="@(onlyMedia ? null : (rstar==0 ? null : rstar))"
                               asp-route-rmedia="@(onlyMedia ? "1" : null)"
                               asp-fragment="reviews">›</a>
                        }
                    </div>
                }
            </div>
        </section>

        <!-- Lightbox ảnh review -->
        <div id="rvLightbox" class="rv-lightbox" aria-hidden="true">
            <div class="rv-lb-inner">
                <img id="rvLightboxImg" alt="Xem ảnh đánh giá" draggable="false" />
                <button type="button" class="rv-lb-close" aria-label="Đóng">×</button>
            </div>
        </div>

        <!-- ===== /REVIEWS ======================================================== -->


        <!-- RELATED -->
        @if (Model.Related?.Any() == true)
        {
            <div class="related">
                <h3 class="related-title">Dịch vụ liên quan</h3>
                <div class="related-grid">
                    @foreach (var s in Model.Related)
                    {
                        // Fallback ảnh theo Category nếu ImageUrl trống
                        var relImg = string.IsNullOrWhiteSpace(s.ImageUrl)
                        ? (s.Category == "Nội trợ" ? Url.Content("~/images/NoiTro.jpg")
                        : s.Category == "Sự kiện nhỏ tại nhà" ? Url.Content("~/images/SuKienNho.jpg")
                        : Url.Content("~/images/VeSinh.jpg"))
                        : Url.Content(s.ImageUrl);

                        <article class="related-card">
                            <a asp-controller="Services" asp-action="Details" asp-route-id="@s.Id" class="rel-img-wrap">
                                <img src="@relImg" alt="@s.Name" />
                            </a>
                            <div class="rel-body">
                                <a asp-controller="Services" asp-action="Details" asp-route-id="@s.Id" class="rel-name">@s.Name</a>
                                <div class="rel-stars">
                                    @{
                                        var ravg = s.Stars;
                                    }
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var fill = Math.Max(0, Math.Min(1, ravg - (i - 1)));
                                        var pct = (int)Math.Round(fill * 100);

                                        if (pct >= 100)
                                        {
                                            <span class="star filled">★</span>
                                            ;
                                        }
                                        else if (pct <= 0)
                                        {
                                            <span class="star">★</span>
                                            ;
                                        }
                                        else
                                        {
                                            <span class="star frac" style="--p:@pct%;">★</span>
                                            ;
                                        }
                                    }
                                    <span class="rel-rating-text">@ravg.ToString("0.#") / 5 (@s.TotalReviews đánh giá)</span>

                                </div>

                                <div class="rel-price">@s.PriceDisplay</div>
                            </div>
                        </article>
                    }
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        // Đổi ảnh lớn khi bấm thumbnail
        document.getElementById('thumbs')?.addEventListener('click', function(e){
          const btn = e.target.closest('.thumb');
          if(!btn) return;
          const src = btn.getAttribute('data-src');
          if(src){
            const img = document.getElementById('mainImage');
            if(img) img.setAttribute('src', src);
          }
        });

        // Tính tiền add-on
        (function(){
          const money = n => n.toLocaleString('vi-VN') + 'đ';
          const baseEl = document.getElementById('basePrice');
          if(!baseEl) return;

          const addOnEl = document.getElementById('addOnPrice');
          const totalEl = document.getElementById('grandTotal');
          const base = Number(baseEl.dataset.base || 0);

          function calc(){
            let extra = 0;

            document.querySelectorAll('.addon-check').forEach(w => {
              const price = Number(w.getAttribute('data-price') || 0);
              const checked = w.querySelector('.addon-input')?.checked;
              if (checked) extra += price;
            });

            document.querySelectorAll('.addon-qty').forEach(w => {
              const price = Number(w.getAttribute('data-price') || 0);
              const qty = Number((w.querySelector('.qty-input')?.value || '0').replace(/\D/g,''));
              extra += price * qty;
            });

            if(addOnEl) addOnEl.textContent = money(extra);
            if(totalEl) totalEl.textContent = money(base + extra);
          }

          document.querySelectorAll('.addon-qty').forEach(w => {
            const input = w.querySelector('.qty-input');
            if(!input) return;
            const max = Number(w.getAttribute('data-max') || 99);
            const minus = w.querySelectorAll('.qty-btn')[0];
            const plus  = w.querySelectorAll('.qty-btn')[1];

            minus?.addEventListener('click', ()=>{ input.value = String(Math.max(0, Number(input.value || 0) - 1)); calc(); });
            plus?.addEventListener('click',  ()=>{ input.value = String(Math.min(max, Number(input.value || 0) + 1)); calc(); });

            input.addEventListener('input', ()=>{
              let v = input.value.replace(/\D/g,'');
              if(v === '') v = '0';
              v = String(Math.min(max, Number(v)));
              input.value = v; calc();
            });
          });

          document.querySelectorAll('.addon-check .addon-input')
            .forEach(chk => chk.addEventListener('change', calc));

          calc();
        })();

		// Lightbox ảnh review
                    (function () {
          const lb     = document.getElementById('rvLightbox');
          const lbImg  = document.getElementById('rvLightboxImg');
          const btnX   = document.querySelector('.rv-lb-close');

          function openLB(src){
            if(!lb || !lbImg) return;
            lbImg.src = src;
            lb.classList.add('open');
            lb.setAttribute('aria-hidden','false');
          }
          function closeLB(){
            if(!lb) return;
            lb.classList.remove('open');
            lb.setAttribute('aria-hidden','true');
            if(lbImg) lbImg.src = '';
          }

          /* Event delegation: bấm bất kỳ ảnh trong .rv-photos để mở */
          document.addEventListener('click', function(e){
            const img = e.target.closest('.rv-photos img');
            if(img){ e.preventDefault(); openLB(img.src); }
          });

          /* Đóng khi bấm nền, nút ×, ảnh, hoặc ESC */
          lb?.addEventListener('click', (e)=>{ if(e.target === lb) closeLB(); });
          btnX?.addEventListener('click', closeLB);
          lbImg?.addEventListener('click', closeLB);         // click ảnh để đóng
          window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLB(); });
        })();
    </script>
}

@model List<VHS_fontend.Controllers.ServiceViewModel>

@{
    ViewData["Title"] = "Dịch vụ";

    string search = ViewBag.Search as string ?? "";
    string category = ViewBag.Category as string ?? "";
    string sort = ViewBag.Sort as string ?? "";

    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int startPage = Math.Max(1, currentPage - 2);
    int endPage = Math.Min(totalPages, currentPage + 2);
}

<section class="services-section">
    <div class="container-xl">
        <h1 class="page-title">Danh sách dịch vụ</h1>
        <p class="page-subtitle">Chọn dịch vụ phù hợp cho nhu cầu của bạn</p>

        <!-- Filter -->
        <form method="get" asp-action="Index" class="filter-form">
            <input type="text" name="search" value="@search" placeholder="🔍 Tìm dịch vụ..." class="input" />

            <select name="category" class="input">
                <option value="">-- Tất cả loại --</option>
                <option value="Vệ sinh" selected="@(category == "Vệ sinh")">Vệ sinh</option>
                <option value="Sửa chữa" selected="@(category == "Sửa chữa")">Sửa chữa</option>
                <option value="Giúp việc" selected="@(category == "Giúp việc")">Giúp việc</option>
            </select>

            <select name="sort" class="input">
                <option value="">-- Khoảng giá / đánh giá --</option>
                <option value="price-500" selected="@(sort == "price-500")">Dưới 500.000đ</option>
                <option value="price-500-1000" selected="@(sort == "price-500-1000")">500.000đ - 1.000.000đ</option>
                <option value="price-1000-5000" selected="@(sort == "price-1000-5000")">1.000.000đ - 5.000.000đ</option>
                <option value="price-5000" selected="@(sort == "price-5000")">Trên 5.000.000đ</option>
                <option value="stars" selected="@(sort == "stars")">Đánh giá cao</option>
            </select>

            <button type="submit" class="btn btn-primary">Lọc</button>
        </form>

        @if (Model == null || !Model.Any())
        {
            <div class="no-result">Không tìm thấy dịch vụ nào phù hợp.</div>
        }
        else
        {
            <div class="services-grid @(Model.Count == 1 ? "services-grid--single" : "")">
                @foreach (var service in Model)
                {
                    <div class="service-card">
                        <img src="@Url.Content(service.ImageUrl ?? "~/images/VeSinh.jpg")"
                             alt="@service.Name"
                             class="service-img" />
                        <div class="service-body">
                            <h2 class="service-title">@service.Name</h2>
                            <p class="service-desc">@service.Description</p>
                            <p><strong>Thời gian:</strong> @service.Duration</p>
                            <p><strong>Giá:</strong> @service.PriceDisplay</p>

                            <!-- Sao + tổng số đánh giá (làm tròn 0.5) -->
                            <div class="stars">
                                @{
                                    // Làm tròn về bội số 0.5
                                    var avg = Math.Round(service.Stars * 2, MidpointRounding.AwayFromZero) / 2.0;
                                    int fullStars = (int)Math.Floor(avg);      // số sao đầy
                                    bool halfStar = (avg - fullStars) == 0.5;  // có nửa sao không
                                }
                                @for (int s = 1; s <= 5; s++)
                                {
                                    if (s <= fullStars)
                                    {
                                        <span class="star filled">★</span>
                                    }
                                    else if (halfStar && s == fullStars + 1)
                                    {
                                        <span class="star half">★</span>
                                    }
                                    else
                                    {
                                        <span class="star">★</span>
                                    }
                                }
                                <span class="rating-text">@avg / 5 (@service.TotalReviews đánh giá)</span>
                            </div>

                            <div class="service-actions">
                                <a href="#" class="btn btn-primary">Thêm vào giỏ hàng</a>
                                <a asp-controller="Services" asp-action="Details" asp-route-id="@service.Id" class="btn btn-ghost">Chi tiết</a>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            <div class="pagination">
                @if (currentPage > 1)
                {
                    <a asp-action="Index" asp-route-page="1" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-link">«</a>
                    <a asp-action="Index" asp-route-page="@(currentPage - 1)" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-link">‹</a>
                }

                @for (int i = startPage; i <= endPage; i++)
                {
                    if (i == currentPage)
                    {
                        <span class="page-link active">@i</span>
                    }
                    else
                    {
                        <a asp-action="Index" asp-route-page="@i" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-link">@i</a>
                    }
                }

                @if (currentPage < totalPages)
                {
                    <a asp-action="Index" asp-route-page="@(currentPage + 1)" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-link">›</a>
                    <a asp-action="Index" asp-route-page="@totalPages" asp-route-search="@search" asp-route-category="@category" asp-route-sort="@sort" class="page-link">»</a>
                }
            </div>
        }
    </div>
</section>

<link rel="stylesheet" href="~/css/services.css" asp-append-version="true" />
